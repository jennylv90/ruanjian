define("app/window/frame",["../main","jquery/jquery","jquery-localize-master/dist/jquery.localize","bootstrape/js/bootstrap","../document/File","exoskeleton-master/exoskeleton","../editor/UndoManager","../document/StringUtils","../document/Node","../editor/polyfill","./FileHelper","../editor/EditHelper","./FileInfoPanel","../editor/KeyMaster","../editor/Editor","../document/MarkParser","../editor/Inline","../editor/Emoji","../document/Node2Mark","../document/Node2HTML","../document/NodeOperation","../editor/Diagram","codemirror/lib/codemirror","rangy/rangy-core","../editor/Fences","autoComplete","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint","../editor/MathBlock","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","../editor/MathInline","rangy/rangy-classapplier","../editor/Brush","../editor/Stylize","../editor/Selection","../editor/TableEdit","../editor/ImageEdit","../editor/UserOp","../editor/ConvertUtils","../editor/DocMenu","../editor/SearchPanel","../editor/Word","../document/Export","../document/Node2Native","../editor/SourceView","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","../editor/QuickOpenPanel","./Library","../window/FileInfoPanel","../window/FileHelper","../window/ClientCommand","./PDFBridge","./PandocBridge","../window/ContextMenu","../window/PandocBridge","../window/MegaMenu","list.js-master/dist/list","list.js-master/dist/list.fuzzysearch.min","./ClientCommand"],function(a,b,c){"use strict";function d(){var a=v.getCurrentWindow();v.app,[document.querySelector("#w-traffic-lights")];$("#w-min").on("click",function(){a.minimize()}),$("#w-close").on("click",function(){a.close()}),$("#w-restore").on("click",function(){a.unmaximize(),a.setFullScreen(!1)});var b=null;$("#w-max").on("mouseup",function(c){1===c.which&&($("#w-traffic-lights").addClass("on-win-fullsize"),b&&clearTimeout(b),$("#w-max-group").removeClass("w-show-more"),a.maximize())}).on("mousedown",function(){b=setTimeout(function(){$("#w-max-group").addClass("w-show-more")},300)}).on("mouseenter",function(){this.classList.add("hover")}).on("mouseleave",function(){this.classList.remove("hover")}),$("#w-full").on("mouseup",function(c){1===c.which&&($("#w-traffic-lights").addClass("on-win-fullsize"),this.classList.remove("mouse-hover"),b&&clearTimeout(b),$("#w-max-group").removeClass("w-show-more"),a.setFullScreen(!0))}).on("mouseenter",function(){this.classList.add("hover")}).on("mouseleave",function(){this.classList.remove("hover")}),$("#w-pin").on("mouseup",function(a){1===a.which&&r.pinWindow()}).on("mouseenter",function(){this.classList.add("hover")}).on("mouseleave",function(){this.classList.remove("hover")}),$("#w-unpin").on("click",function(){r.unpinWindow()}),$("#top-titlebar").on("mouseleave",function(){b&&clearTimeout(b),$("#w-max-group").removeClass("w-show-more")}),document.body.classList.contains("native-window")&&$("body").on("mousemove",function(b){b.pageY<11&&a.setMenuBarVisibility(!0)});var c=null,d=function(b,c){if(!a.isFocused())return void(document.body.classList.contains("mouse-entered")&&document.body.classList.remove("mouse-entered"));var d=a.getBounds(),e=v.screen.getDisplayMatching(d).scaleFactor,f={top:d.y*e,bottom:(d.y+d.height)*e,left:d.x*e,right:(d.x+d.width)*e};b>f.left&&b<f.right&&c>f.top&&c<f.bottom?document.body.classList.contains("mouse-entered")||document.body.classList.add("mouse-entered"):document.body.classList.contains("mouse-entered")&&document.body.classList.remove("mouse-entered")};window.mouseMonitor=function(a,b){c&&clearTimeout(c),c=setTimeout(function(){d(a,b)},100)},a.on("maximize",function(){$("#w-traffic-lights").addClass("on-win-fullsize"),document.body.classList.remove("mouse-entered")}),a.on("enter-full-screen",function(){$("#w-traffic-lights").addClass("on-win-fullsize"),document.body.classList.remove("mouse-entered"),document.body.classList.add("typora-fullscreen")}),a.on("unmaximize",function(){$("#w-traffic-lights").removeClass("on-win-fullsize"),document.body.classList.remove("mouse-entered")}),a.on("leave-full-screen",function(){$("#w-traffic-lights").removeClass("on-win-fullsize"),document.body.classList.remove("mouse-entered"),document.body.classList.remove("typora-fullscreen")}),a.webContents.on("devtools-opened",function(){console.log("devtools-opened"),o.buildDocumentSnap(),o.lock()}),a.webContents.on("devtools-closed",function(){o.unlock(),window.onWindowFocus(!0)}),window.onbeforeunload=function(b){function c(){if(v.app.getDocumentController().removeWindow(a.id),t.slientQuit(),"win32"==process.platform){var b=v.screen;b.removeListener("display-added",g),b.removeListener("display-removed",g),b.removeListener("display-metrics-changed",g)}var c=a.getSize();v.app.setting.put("lastWidth",c[0],!0),v.app.setting.put("lastHeight",c[1],!0),v.app.setting.save(),o.editor.library.end(),p.watchFileChange(null)}return o.autoSaveWorker(!0),a.focus(),q.tryLeaveDocument(function(b){b||(c(),releasePrintWin_(),releaseCaptureWin_(),o.fileHasModified=!1,o.updateChangeCount(o.ChangeType.NSChangeAutosaved),a.destroy())}),!1};var e=reqnode("electron").ipcRenderer;window.onerror=function(a,b,c,d,f){e.send("errorInWindow",f?f.stack:b+":"+c+"\n"+a)}}function e(){-1!=window.navigator.userAgent.indexOf("Windows NT")?(document.body.classList.add("os-windows"),-1!=window.navigator.userAgent.indexOf("Windows NT 6.1")?document.body.classList.add("os-windows-7"):-1!=window.navigator.userAgent.indexOf("Windows NT 6.2")?document.body.classList.add("os-windows-8"):-1!=window.navigator.userAgent.indexOf("Windows NT 6.3")?(document.body.classList.add("os-windows-8"),document.body.classList.add("os-windows-8.1")):-1!=window.navigator.userAgent.indexOf("Windows NT 10")&&document.body.classList.add("os-windows-10")):process&&"linux"==process.platform?document.body.classList.add("os-linux"):process&&"darwin"==process.platform&&document.body.classList.add("os-mac")}function f(){(-1!=window.navigator.userAgent.indexOf("Windows NT 6.2")||-1!=window.navigator.userAgent.indexOf("Windows NT 6.3"))&&document.body.classList.add("paint-border")}function g(){try{if("win32"!==process.platform)return;var a=v.app,b=v.getCurrentWindow(),c=reqnode("electron").webFrame,d=reqnode("wmi-client"),e=v.screen,f=new d({host:"localhost",namespace:"\\\\root\\WMI"}),g=e.getDisplayMatching(b.getBounds()),h=e.getAllDisplays().findIndex(function(a,b){return g.bounds.x==a.bounds.x&&g.bounds.y==a.bounds.y}),i=g.scaleFactor;if(-1==h&&(h=0),i>1)return c.setZoomFactor(1),void a.setting.put("zoomFactor",1);f.query("SELECT MaxHorizontalImageSize,MaxVerticalImageSize FROM WmiMonitorBasicDisplayParams",function(b,d){var e=1,f=Math.max(g.size.width,g.size.height),i=Math.max(d[h].MaxHorizontalImageSize,d[h].MaxVerticalImageSize);e=f/i/43.885714285714286,e=Math.round(100*e)/100,e=16==g.size.width&&9==g.size.height?1:1.0765>e?1:1.25,c.setZoomFactor(e),a.setting.put("zoomFactor",e)})}catch(j){console.error(j)}}function h(){document.body.classList.remove("native-window"),document.body.classList.add("show-footer")}function i(){var a=v.app;if(a.setting.get("framelessWindow")===!0?(document.body.classList.remove("native-window"),document.body.classList.add("unibody-window")):(document.body.classList.add("native-window"),document.body.classList.remove("unibody-window")),a.setting.get("showStatusBar")!==!1&&document.body.classList.add("show-footer"),e(),f(),!a.setting.get("customZoom")&&"win32"==process.platform){g();var b=v.screen;b.on("display-added",g),b.on("display-removed",g),b.on("display-metrics-changed",g)}}function j(){$("html, body, #top-titlebar").click(function(){$("#main-menu").removeClass("open")})}function k(){$("#outline-btn").click(function(){document.body.classList.contains("pin-outline")?(v&&v.app.setting.put("show_outline","false"),document.body.classList.remove("pin-outline")):o.editor.docMenu.showOutline(!0),o.isNode&&r.refreshViewMenu()}),$("#toggle-sourceview-btn").click(function(){o.toggleSourceMode()}),$("#toggle-focus-mode-btn").click(function(){o.editor.toggleFocusMode()}),$("#toggle-typewriter-mode-btn").click(function(){o.editor.toggleTypeWriterMode()}),l()}function l(){$("#footer-word-count").on("click",function(){if(document.body.classList.contains("show-word-count"))document.body.classList.remove("show-word-count");else{document.body.classList.add("show-word-count"),o.sync(),o.editor.brush.updateWordCount();var a=o.editor.getMarkdown(),b=Math.round(($("#footer-word-count-td").text()-0)/270);$("#footer-read-time-count-td").text(b||"≤ 1"),$("#footer-line-count-td").text((a.match(/\n/g)||[]).length+1),$("#footer-char-count-td").text(a.length)}}),$("#footer-word-count-info-close").on("click",function(){$("#footer-word-count").trigger("click")})}function m(){if(o.isWin){var a=v.app,b=[{type:"recent"},{type:"tasks",items:[{type:"task",program:process.execPath,arguments:"",iconPath:process.execPath,iconIndex:0,title:"New Document",description:"Create a new window"}]}];a.setAppUserModelId("abnerworks.Typora");var c=a.setJumpList(b);console.debug("bindJumplist "+c)}}var n=a("../main"),o=(a("../editor/KeyMaster"),a("../document/File")),p=(a("../document/Node"),a("../window/FileInfoPanel")),q=(a("../editor/EditHelper"),a("../window/FileHelper")),r=a("../window/ClientCommand"),s=a("../window/ContextMenu"),t=a("../window/PandocBridge"),u=a("../window/MegaMenu"),v=window.reqnode?reqnode("electron").remote:null;o.resetZoom=function(){"win32"==process.platform?g():(reqnode("electron").webFrame.setZoomFactor(1),v.app.setting.put("zoomFactor",1))},$(document).ready(function(){reqnode?i():h(),n.init(),o.isNodeHtml&&(o.contextMenu=new s(o.editor.sessionStr),o.megaMenu=new u(o.editor.sessionStr)),reqnode&&(d(),m()),j(),p.prepareInfoPanel(),k()})}),define("app/main",["jquery/jquery","jquery-localize-master/dist/jquery.localize","bootstrape/js/bootstrap","app/document/File","exoskeleton-master/exoskeleton","app/editor/UndoManager","app/document/StringUtils","app/document/Node","app/editor/polyfill","app/window/FileHelper","app/editor/EditHelper","app/window/FileInfoPanel","app/editor/KeyMaster","app/editor/Editor","app/document/MarkParser","app/editor/Inline","app/editor/Emoji","app/document/Node2Mark","app/document/Node2HTML","app/document/NodeOperation","app/editor/Diagram","codemirror/lib/codemirror","rangy/rangy-core","app/editor/Fences","autoComplete","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint","app/editor/MathBlock","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","app/editor/MathInline","rangy/rangy-classapplier","app/editor/Brush","app/editor/Stylize","app/editor/Selection","app/editor/TableEdit","app/editor/ImageEdit","app/editor/UserOp","app/editor/ConvertUtils","app/editor/DocMenu","app/editor/SearchPanel","app/editor/Word","app/document/Export","app/document/Node2Native","app/editor/SourceView","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","app/editor/QuickOpenPanel","app/window/Library"],function(a,b,c){function d(a){window.getMarkdown=function(){return a.getMarkdown()}}window.jQuery||(window.$=a("jquery/jquery"),window.jQuery=window.$,$.fn.textExcludeSVG=function(a){var b=this.clone().find("svg, .MathJax_Preview").remove().end();return a&&b.find(".md-inline-math script").html(function(){return this.innerHTML.replace(/\u200b/g,"")}),b.text()},$.fn.textWithoutNbps=function(){return this.text().replace(/\u00A0/g," ").replace()}),a("jquery-localize-master/dist/jquery.localize.js"),a("bootstrape/js/bootstrap.js");var e=a("app/document/File"),f=a("app/editor/Editor");setTimeout(function(){$("[data-localize]").localize("app",{pathPrefix:"pathPrefix"})},20),window.File=e,b.init=function(){var a=new f("#write",e);d(a),window.editor=a}}),define("jquery/jquery",[],function(a,b,c){!function(a,b){"object"==typeof c&&"object"==typeof c.exports?c.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){function c(a){var b=a.length,c=_.type(a);return"function"===c||_.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}function d(a,b,c){if(_.isFunction(b))return _.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return _.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(ha.test(b))return _.filter(b,a,c);b=_.filter(b,a)}return _.grep(a,function(a){return U.call(b,a)>=0!==c})}function e(a,b){for(;(a=a[b])&&1!==a.nodeType;);return a}function f(a){var b=oa[a]={};return _.each(a.match(na)||[],function(a,c){b[c]=!0}),b}function g(){Z.removeEventListener("DOMContentLoaded",g,!1),a.removeEventListener("load",g,!1),_.ready()}function h(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=_.expando+Math.random()}function i(a,b,c){var d;if(void 0===c&&1===a.nodeType)if(d="data-"+b.replace(ua,"-$1").toLowerCase(),c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:ta.test(c)?_.parseJSON(c):c}catch(e){}sa.set(a,b,c)}else c=void 0;return c}function j(){return!0}function k(){return!1}function l(){try{return Z.activeElement}catch(a){}}function m(a,b){return _.nodeName(a,"table")&&_.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function n(a){return a.type=(null!==a.getAttribute("type"))+"/"+a.type,a}function o(a){var b=Ka.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function p(a,b){for(var c=0,d=a.length;d>c;c++)ra.set(a[c],"globalEval",!b||ra.get(b[c],"globalEval"))}function q(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(ra.hasData(a)&&(f=ra.access(a),g=ra.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;d>c;c++)_.event.add(b,e,j[e][c])}sa.hasData(a)&&(h=sa.access(a),i=_.extend({},h),sa.set(b,i))}}function r(a,b){var c=a.getElementsByTagName?a.getElementsByTagName(b||"*"):a.querySelectorAll?a.querySelectorAll(b||"*"):[];return void 0===b||b&&_.nodeName(a,b)?_.merge([a],c):c}function s(a,b){var c=b.nodeName.toLowerCase();"input"===c&&ya.test(a.type)?b.checked=a.checked:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}function t(b,c){var d,e=_(c.createElement(b)).appendTo(c.body),f=a.getDefaultComputedStyle&&(d=a.getDefaultComputedStyle(e[0]))?d.display:_.css(e[0],"display");return e.detach(),f}function u(a){var b=Z,c=Oa[a];return c||(c=t(a,b),"none"!==c&&c||(Na=(Na||_("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=Na[0].contentDocument,b.write(),b.close(),c=t(a,b),Na.detach()),Oa[a]=c),c}function v(a,b,c){var d,e,f,g,h=a.style;return c=c||Ra(a),c&&(g=c.getPropertyValue(b)||c[b]),c&&(""!==g||_.contains(a.ownerDocument,a)||(g=_.style(a,b)),Qa.test(g)&&Pa.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0!==g?g+"":g}function w(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}function x(a,b){if(b in a)return b;for(var c=b[0].toUpperCase()+b.slice(1),d=b,e=Xa.length;e--;)if(b=Xa[e]+c,b in a)return b;return d}function y(a,b,c){var d=Ta.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function z(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=_.css(a,c+wa[f],!0,e)),d?("content"===c&&(g-=_.css(a,"padding"+wa[f],!0,e)),"margin"!==c&&(g-=_.css(a,"border"+wa[f]+"Width",!0,e))):(g+=_.css(a,"padding"+wa[f],!0,e),"padding"!==c&&(g+=_.css(a,"border"+wa[f]+"Width",!0,e)));return g}function A(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=Ra(a),g="border-box"===_.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=v(a,b,f),(0>e||null==e)&&(e=a.style[b]),Qa.test(e))return e;d=g&&(Y.boxSizingReliable()||e===a.style[b]),e=parseFloat(e)||0}return e+z(a,b,c||(g?"border":"content"),d,f)+"px"}function B(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=ra.get(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&xa(d)&&(f[g]=ra.access(d,"olddisplay",u(d.nodeName)))):(e=xa(d),"none"===c&&e||ra.set(d,"olddisplay",e?c:_.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}function C(a,b,c,d,e){return new C.prototype.init(a,b,c,d,e)}function D(){return setTimeout(function(){Ya=void 0}),Ya=_.now()}function E(a,b){var c,d=0,e={height:a};for(b=b?1:0;4>d;d+=2-b)c=wa[d],e["margin"+c]=e["padding"+c]=a;return b&&(e.opacity=e.width=a),e}function F(a,b,c){for(var d,e=(cb[b]||[]).concat(cb["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function G(a,b,c){var d,e,f,g,h,i,j,k,l=this,m={},n=a.style,o=a.nodeType&&xa(a),p=ra.get(a,"fxshow");c.queue||(h=_._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,l.always(function(){l.always(function(){h.unqueued--,_.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[n.overflow,n.overflowX,n.overflowY],j=_.css(a,"display"),k="none"===j?ra.get(a,"olddisplay")||u(a.nodeName):j,"inline"===k&&"none"===_.css(a,"float")&&(n.display="inline-block")),c.overflow&&(n.overflow="hidden",l.always(function(){n.overflow=c.overflow[0],n.overflowX=c.overflow[1],n.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],$a.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(o?"hide":"show")){if("show"!==e||!p||void 0===p[d])continue;o=!0}m[d]=p&&p[d]||_.style(a,d)}else j=void 0;if(_.isEmptyObject(m))"inline"===("none"===j?u(a.nodeName):j)&&(n.display=j);else{p?"hidden"in p&&(o=p.hidden):p=ra.access(a,"fxshow",{}),f&&(p.hidden=!o),o?_(a).show():l.done(function(){_(a).hide()}),l.done(function(){var b;ra.remove(a,"fxshow");for(b in m)_.style(a,b,m[b])});for(d in m)g=F(o?p[d]:0,d,l),d in p||(p[d]=g.start,o&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function H(a,b){var c,d,e,f,g;for(c in a)if(d=_.camelCase(c),e=b[d],f=a[c],_.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=_.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function I(a,b,c){var d,e,f=0,g=bb.length,h=_.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=Ya||D(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:_.extend({},b),opts:_.extend(!0,{specialEasing:{}},c),originalProperties:b,originalOptions:c,startTime:Ya||D(),duration:c.duration,tweens:[],createTween:function(b,c){var d=_.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?h.resolveWith(a,[j,b]):h.rejectWith(a,[j,b]),this}}),k=j.props;for(H(k,j.opts.specialEasing);g>f;f++)if(d=bb[f].call(j,a,k,j.opts))return d;return _.map(k,F,j),_.isFunction(j.opts.start)&&j.opts.start.call(a,j),_.fx.timer(_.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}function J(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(na)||[];if(_.isFunction(c))for(;d=f[e++];)"+"===d[0]?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function K(a,b,c,d){function e(h){var i;return f[h]=!0,_.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||g||f[j]?g?!(i=j):void 0:(b.dataTypes.unshift(j),e(j),!1)}),i}var f={},g=a===vb;return e(b.dataTypes[0])||!f["*"]&&e("*")}function L(a,b){var c,d,e=_.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&_.extend(!0,a,d),a}function M(a,b,c){for(var d,e,f,g,h=a.contents,i=a.dataTypes;"*"===i[0];)i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader("Content-Type"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+" "+i[0]]){f=e;break}g||(g=e)}f=f||g}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function N(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];for(f=k.shift();f;)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}function O(a,b,c,d){var e;if(_.isArray(b))_.each(b,function(b,e){c||zb.test(a)?d(a,e):O(a+"["+("object"==typeof e?b:"")+"]",e,c,d)});else if(c||"object"!==_.type(b))d(a,b);else for(e in b)O(a+"["+e+"]",b[e],c,d)}function P(a){return _.isWindow(a)?a:9===a.nodeType&&a.defaultView}var Q=[],R=Q.slice,S=Q.concat,T=Q.push,U=Q.indexOf,V={},W=V.toString,X=V.hasOwnProperty,Y={},Z=a.document,$="2.1.1",_=function(a,b){return new _.fn.init(a,b)},aa=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,ba=/^-ms-/,ca=/-([\da-z])/gi,da=function(a,b){return b.toUpperCase()};_.fn=_.prototype={jquery:$,constructor:_,selector:"",length:0,toArray:function(){return R.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:R.call(this)},pushStack:function(a){var b=_.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a,b){return _.each(this,a,b)},map:function(a){return this.pushStack(_.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(R.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:T,sort:Q.sort,splice:Q.splice},_.extend=_.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||_.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(_.isPlainObject(d)||(e=_.isArray(d)))?(e?(e=!1,f=c&&_.isArray(c)?c:[]):f=c&&_.isPlainObject(c)?c:{},g[b]=_.extend(j,f,d)):void 0!==d&&(g[b]=d));return g},_.extend({expando:"jQuery"+($+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===_.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){return!_.isArray(a)&&a-parseFloat(a)>=0},isPlainObject:function(a){return"object"!==_.type(a)||a.nodeType||_.isWindow(a)?!1:a.constructor&&!X.call(a.constructor.prototype,"isPrototypeOf")?!1:!0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?V[W.call(a)]||"object":typeof a},globalEval:function(a){var b,c=eval;a=_.trim(a),a&&(1===a.indexOf("use strict")?(b=Z.createElement("script"),b.text=a,Z.head.appendChild(b).parentNode.removeChild(b)):c(a))},camelCase:function(a){return a.replace(ba,"ms-").replace(ca,da)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b,d){var e,f=0,g=a.length,h=c(a);if(d){if(h)for(;g>f&&(e=b.apply(a[f],d),e!==!1);f++);else for(f in a)if(e=b.apply(a[f],d),e===!1)break}else if(h)for(;g>f&&(e=b.call(a[f],f,a[f]),e!==!1);f++);else for(f in a)if(e=b.call(a[f],f,a[f]),e===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(aa,"")},makeArray:function(a,b){var d=b||[];return null!=a&&(c(Object(a))?_.merge(d,"string"==typeof a?[a]:a):T.call(d,a)),d},inArray:function(a,b,c){return null==b?-1:U.call(b,a,c)},merge:function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;d++)a[e++]=b[d];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,d){var e,f=0,g=a.length,h=c(a),i=[];if(h)for(;g>f;f++)e=b(a[f],f,d),null!=e&&i.push(e);else for(f in a)e=b(a[f],f,d),null!=e&&i.push(e);return S.apply([],i)},guid:1,proxy:function(a,b){var c,d,e;return"string"==typeof b&&(c=a[b],b=a,a=c),_.isFunction(a)?(d=R.call(arguments,2),e=function(){return a.apply(b||this,d.concat(R.call(arguments)))},e.guid=a.guid=a.guid||_.guid++,e):void 0},now:Date.now,support:Y}),_.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){V["[object "+b+"]"]=b.toLowerCase()});var ea=function(a){function b(a,b,c,d){var e,f,g,h,i,j,l,n,o,p;if((b?b.ownerDocument||b:O)!==G&&F(b),b=b||G,c=c||[],!a||"string"!=typeof a)return c;if(1!==(h=b.nodeType)&&9!==h)return[];if(I&&!d){if(e=sa.exec(a))if(g=e[1]){if(9===h){if(f=b.getElementById(g),!f||!f.parentNode)return c;if(f.id===g)return c.push(f),c}else if(b.ownerDocument&&(f=b.ownerDocument.getElementById(g))&&M(b,f)&&f.id===g)return c.push(f),c}else{if(e[2])return _.apply(c,b.getElementsByTagName(a)),c;if((g=e[3])&&v.getElementsByClassName&&b.getElementsByClassName)return _.apply(c,b.getElementsByClassName(g)),c}if(v.qsa&&(!J||!J.test(a))){if(n=l=N,o=b,p=9===h&&a,1===h&&"object"!==b.nodeName.toLowerCase()){for(j=z(a),(l=b.getAttribute("id"))?n=l.replace(ua,"\\$&"):b.setAttribute("id",n),n="[id='"+n+"'] ",i=j.length;i--;)j[i]=n+m(j[i]);o=ta.test(a)&&k(b.parentNode)||b,p=j.join(",")}if(p)try{return _.apply(c,o.querySelectorAll(p)),c}catch(q){}finally{l||b.removeAttribute("id")}}}return B(a.replace(ia,"$1"),b,c,d)}function c(){function a(c,d){return b.push(c+" ")>w.cacheLength&&delete a[b.shift()],a[c+" "]=d}var b=[];return a}function d(a){return a[N]=!0,a}function e(a){var b=G.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function f(a,b){for(var c=a.split("|"),d=a.length;d--;)w.attrHandle[c[d]]=b}function g(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||W)-(~a.sourceIndex||W);if(d)return d;if(c)for(;c=c.nextSibling;)if(c===b)return-1;return a?1:-1}function h(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function i(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function j(a){return d(function(b){return b=+b,d(function(c,d){for(var e,f=a([],c.length,b),g=f.length;g--;)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function k(a){return a&&typeof a.getElementsByTagName!==V&&a}function l(){}function m(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function n(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=Q++;return b.first?function(b,c,f){for(;b=b[d];)if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j=[P,f];if(g){for(;b=b[d];)if((1===b.nodeType||e)&&a(b,c,g))return!0}else for(;b=b[d];)if(1===b.nodeType||e){if(i=b[N]||(b[N]={}),(h=i[d])&&h[0]===P&&h[1]===f)return j[2]=h[2];if(i[d]=j,j[2]=a(b,c,g))return!0}}}function o(a){return a.length>1?function(b,c,d){for(var e=a.length;e--;)if(!a[e](b,c,d))return!1;return!0}:a[0]}function p(a,c,d){for(var e=0,f=c.length;f>e;e++)b(a,c[e],d);return d}function q(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function r(a,b,c,e,f,g){return e&&!e[N]&&(e=r(e)),f&&!f[N]&&(f=r(f,g)),d(function(d,g,h,i){var j,k,l,m=[],n=[],o=g.length,r=d||p(b||"*",h.nodeType?[h]:h,[]),s=!a||!d&&b?r:q(r,m,a,h,i),t=c?f||(d?a:o||e)?[]:g:s;if(c&&c(s,t,h,i),e)for(j=q(t,n),e(j,[],h,i),k=j.length;k--;)(l=j[k])&&(t[n[k]]=!(s[n[k]]=l));if(d){if(f||a){if(f){for(j=[],k=t.length;k--;)(l=t[k])&&j.push(s[k]=l);f(null,t=[],j,i)}for(k=t.length;k--;)(l=t[k])&&(j=f?ba.call(d,l):m[k])>-1&&(d[j]=!(g[j]=l))}}else t=q(t===g?t.splice(o,t.length):t),f?f(null,g,t,i):_.apply(g,t)})}function s(a){for(var b,c,d,e=a.length,f=w.relative[a[0].type],g=f||w.relative[" "],h=f?1:0,i=n(function(a){return a===b},g,!0),j=n(function(a){return ba.call(b,a)>-1},g,!0),k=[function(a,c,d){return!f&&(d||c!==C)||((b=c).nodeType?i(a,c,d):j(a,c,d))}];e>h;h++)if(c=w.relative[a[h].type])k=[n(o(k),c)];else{if(c=w.filter[a[h].type].apply(null,a[h].matches),c[N]){for(d=++h;e>d&&!w.relative[a[d].type];d++);return r(h>1&&o(k),h>1&&m(a.slice(0,h-1).concat({value:" "===a[h-2].type?"*":""})).replace(ia,"$1"),c,d>h&&s(a.slice(h,d)),e>d&&s(a=a.slice(d)),e>d&&m(a))}k.push(c)}return o(k)}function t(a,c){var e=c.length>0,f=a.length>0,g=function(d,g,h,i,j){var k,l,m,n=0,o="0",p=d&&[],r=[],s=C,t=d||f&&w.find.TAG("*",j),u=P+=null==s?1:Math.random()||.1,v=t.length;for(j&&(C=g!==G&&g);o!==v&&null!=(k=t[o]);o++){if(f&&k){for(l=0;m=a[l++];)if(m(k,g,h)){i.push(k);break}j&&(P=u)}e&&((k=!m&&k)&&n--,d&&p.push(k))}if(n+=o,e&&o!==n){for(l=0;m=c[l++];)m(p,r,g,h);if(d){if(n>0)for(;o--;)p[o]||r[o]||(r[o]=Z.call(i));r=q(r)}_.apply(i,r),j&&!d&&r.length>0&&n+c.length>1&&b.uniqueSort(i)}return j&&(P=u,C=s),p};return e?d(g):g}var u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N="sizzle"+-new Date,O=a.document,P=0,Q=0,R=c(),S=c(),T=c(),U=function(a,b){return a===b&&(E=!0),0},V="undefined",W=1<<31,X={}.hasOwnProperty,Y=[],Z=Y.pop,$=Y.push,_=Y.push,aa=Y.slice,ba=Y.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},ca="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",da="[\\x20\\t\\r\\n\\f]",ea="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",fa=ea.replace("w","w#"),ga="\\["+da+"*("+ea+")(?:"+da+"*([*^$|!~]?=)"+da+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+fa+"))|)"+da+"*\\]",ha=":("+ea+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+ga+")*)|.*)\\)|)",ia=new RegExp("^"+da+"+|((?:^|[^\\\\])(?:\\\\.)*)"+da+"+$","g"),ja=new RegExp("^"+da+"*,"+da+"*"),ka=new RegExp("^"+da+"*([>+~]|"+da+")"+da+"*"),la=new RegExp("="+da+"*([^\\]'\"]*?)"+da+"*\\]","g"),ma=new RegExp(ha),na=new RegExp("^"+fa+"$"),oa={ID:new RegExp("^#("+ea+")"),CLASS:new RegExp("^\\.("+ea+")"),TAG:new RegExp("^("+ea.replace("w","w*")+")"),ATTR:new RegExp("^"+ga),PSEUDO:new RegExp("^"+ha),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+da+"*(even|odd|(([+-]|)(\\d*)n|)"+da+"*(?:([+-]|)"+da+"*(\\d+)|))"+da+"*\\)|)","i"),bool:new RegExp("^(?:"+ca+")$","i"),needsContext:new RegExp("^"+da+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+da+"*((?:-\\d)?\\d*)"+da+"*\\)|)(?=[^-]|$)","i")},pa=/^(?:input|select|textarea|button)$/i,qa=/^h\d$/i,ra=/^[^{]+\{\s*\[native \w/,sa=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ta=/[+~]/,ua=/'|\\/g,va=new RegExp("\\\\([\\da-f]{1,6}"+da+"?|("+da+")|.)","ig"),wa=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)};try{_.apply(Y=aa.call(O.childNodes),O.childNodes),Y[O.childNodes.length].nodeType}catch(xa){_={apply:Y.length?function(a,b){$.apply(a,aa.call(b))}:function(a,b){for(var c=a.length,d=0;a[c++]=b[d++];);a.length=c-1}}}v=b.support={},y=b.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},F=b.setDocument=function(a){var b,c=a?a.ownerDocument||a:O,d=c.defaultView;return c!==G&&9===c.nodeType&&c.documentElement?(G=c,H=c.documentElement,I=!y(c),d&&d!==d.top&&(d.addEventListener?d.addEventListener("unload",function(){F()},!1):d.attachEvent&&d.attachEvent("onunload",function(){
F()})),v.attributes=e(function(a){return a.className="i",!a.getAttribute("className")}),v.getElementsByTagName=e(function(a){return a.appendChild(c.createComment("")),!a.getElementsByTagName("*").length}),v.getElementsByClassName=ra.test(c.getElementsByClassName)&&e(function(a){return a.innerHTML="<div class='a'></div><div class='a i'></div>",a.firstChild.className="i",2===a.getElementsByClassName("i").length}),v.getById=e(function(a){return H.appendChild(a).id=N,!c.getElementsByName||!c.getElementsByName(N).length}),v.getById?(w.find.ID=function(a,b){if(typeof b.getElementById!==V&&I){var c=b.getElementById(a);return c&&c.parentNode?[c]:[]}},w.filter.ID=function(a){var b=a.replace(va,wa);return function(a){return a.getAttribute("id")===b}}):(delete w.find.ID,w.filter.ID=function(a){var b=a.replace(va,wa);return function(a){var c=typeof a.getAttributeNode!==V&&a.getAttributeNode("id");return c&&c.value===b}}),w.find.TAG=v.getElementsByTagName?function(a,b){return typeof b.getElementsByTagName!==V?b.getElementsByTagName(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){for(;c=f[e++];)1===c.nodeType&&d.push(c);return d}return f},w.find.CLASS=v.getElementsByClassName&&function(a,b){return typeof b.getElementsByClassName!==V&&I?b.getElementsByClassName(a):void 0},K=[],J=[],(v.qsa=ra.test(c.querySelectorAll))&&(e(function(a){a.innerHTML="<select msallowclip=''><option selected=''></option></select>",a.querySelectorAll("[msallowclip^='']").length&&J.push("[*^$]="+da+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||J.push("\\["+da+"*(?:value|"+ca+")"),a.querySelectorAll(":checked").length||J.push(":checked")}),e(function(a){var b=c.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&J.push("name"+da+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||J.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),J.push(",.*:")})),(v.matchesSelector=ra.test(L=H.matches||H.webkitMatchesSelector||H.mozMatchesSelector||H.oMatchesSelector||H.msMatchesSelector))&&e(function(a){v.disconnectedMatch=L.call(a,"div"),L.call(a,"[s!='']:x"),K.push("!=",ha)}),J=J.length&&new RegExp(J.join("|")),K=K.length&&new RegExp(K.join("|")),b=ra.test(H.compareDocumentPosition),M=b||ra.test(H.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)for(;b=b.parentNode;)if(b===a)return!0;return!1},U=b?function(a,b){if(a===b)return E=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!v.sortDetached&&b.compareDocumentPosition(a)===d?a===c||a.ownerDocument===O&&M(O,a)?-1:b===c||b.ownerDocument===O&&M(O,b)?1:D?ba.call(D,a)-ba.call(D,b):0:4&d?-1:1)}:function(a,b){if(a===b)return E=!0,0;var d,e=0,f=a.parentNode,h=b.parentNode,i=[a],j=[b];if(!f||!h)return a===c?-1:b===c?1:f?-1:h?1:D?ba.call(D,a)-ba.call(D,b):0;if(f===h)return g(a,b);for(d=a;d=d.parentNode;)i.unshift(d);for(d=b;d=d.parentNode;)j.unshift(d);for(;i[e]===j[e];)e++;return e?g(i[e],j[e]):i[e]===O?-1:j[e]===O?1:0},c):G},b.matches=function(a,c){return b(a,null,null,c)},b.matchesSelector=function(a,c){if((a.ownerDocument||a)!==G&&F(a),c=c.replace(la,"='$1']"),!(!v.matchesSelector||!I||K&&K.test(c)||J&&J.test(c)))try{var d=L.call(a,c);if(d||v.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return b(c,G,null,[a]).length>0},b.contains=function(a,b){return(a.ownerDocument||a)!==G&&F(a),M(a,b)},b.attr=function(a,b){(a.ownerDocument||a)!==G&&F(a);var c=w.attrHandle[b.toLowerCase()],d=c&&X.call(w.attrHandle,b.toLowerCase())?c(a,b,!I):void 0;return void 0!==d?d:v.attributes||!I?a.getAttribute(b):(d=a.getAttributeNode(b))&&d.specified?d.value:null},b.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},b.uniqueSort=function(a){var b,c=[],d=0,e=0;if(E=!v.detectDuplicates,D=!v.sortStable&&a.slice(0),a.sort(U),E){for(;b=a[e++];)b===a[e]&&(d=c.push(e));for(;d--;)a.splice(c[d],1)}return D=null,a},x=b.getText=function(a){var b,c="",d=0,e=a.nodeType;if(e){if(1===e||9===e||11===e){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=x(a)}else if(3===e||4===e)return a.nodeValue}else for(;b=a[d++];)c+=x(b);return c},w=b.selectors={cacheLength:50,createPseudo:d,match:oa,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(va,wa),a[3]=(a[3]||a[4]||a[5]||"").replace(va,wa),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||b.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&b.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return oa.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||"":c&&ma.test(c)&&(b=z(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(va,wa).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=R[a+" "];return b||(b=new RegExp("(^|"+da+")"+a+"("+da+"|$)"))&&R(a,function(a){return b.test("string"==typeof a.className&&a.className||typeof a.getAttribute!==V&&a.getAttribute("class")||"")})},ATTR:function(a,c,d){return function(e){var f=b.attr(e,a);return null==f?"!="===c:c?(f+="","="===c?f===d:"!="===c?f!==d:"^="===c?d&&0===f.indexOf(d):"*="===c?d&&f.indexOf(d)>-1:"$="===c?d&&f.slice(-d.length)===d:"~="===c?(" "+f+" ").indexOf(d)>-1:"|="===c?f===d||f.slice(0,d.length+1)===d+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h;if(q){if(f){for(;p;){for(l=b;l=l[p];)if(h?l.nodeName.toLowerCase()===r:1===l.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){for(k=q[N]||(q[N]={}),j=k[a]||[],n=j[0]===P&&j[1],m=j[0]===P&&j[2],l=n&&q.childNodes[n];l=++n&&l&&l[p]||(m=n=0)||o.pop();)if(1===l.nodeType&&++m&&l===b){k[a]=[P,n,m];break}}else if(s&&(j=(b[N]||(b[N]={}))[a])&&j[0]===P)m=j[1];else for(;(l=++n&&l&&l[p]||(m=n=0)||o.pop())&&((h?l.nodeName.toLowerCase()!==r:1!==l.nodeType)||!++m||(s&&((l[N]||(l[N]={}))[a]=[P,m]),l!==b)););return m-=e,m===d||m%d===0&&m/d>=0}}},PSEUDO:function(a,c){var e,f=w.pseudos[a]||w.setFilters[a.toLowerCase()]||b.error("unsupported pseudo: "+a);return f[N]?f(c):f.length>1?(e=[a,a,"",c],w.setFilters.hasOwnProperty(a.toLowerCase())?d(function(a,b){for(var d,e=f(a,c),g=e.length;g--;)d=ba.call(a,e[g]),a[d]=!(b[d]=e[g])}):function(a){return f(a,0,e)}):f}},pseudos:{not:d(function(a){var b=[],c=[],e=A(a.replace(ia,"$1"));return e[N]?d(function(a,b,c,d){for(var f,g=e(a,null,d,[]),h=a.length;h--;)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,d,f){return b[0]=a,e(b,null,f,c),!c.pop()}}),has:d(function(a){return function(c){return b(a,c).length>0}}),contains:d(function(a){return function(b){return(b.textContent||b.innerText||x(b)).indexOf(a)>-1}}),lang:d(function(a){return na.test(a||"")||b.error("unsupported lang: "+a),a=a.replace(va,wa).toLowerCase(),function(b){var c;do if(c=I?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===H},focus:function(a){return a===G.activeElement&&(!G.hasFocus||G.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!w.pseudos.empty(a)},header:function(a){return qa.test(a.nodeName)},input:function(a){return pa.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:j(function(){return[0]}),last:j(function(a,b){return[b-1]}),eq:j(function(a,b,c){return[0>c?c+b:c]}),even:j(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:j(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:j(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:j(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},w.pseudos.nth=w.pseudos.eq;for(u in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})w.pseudos[u]=h(u);for(u in{submit:!0,reset:!0})w.pseudos[u]=i(u);return l.prototype=w.filters=w.pseudos,w.setFilters=new l,z=b.tokenize=function(a,c){var d,e,f,g,h,i,j,k=S[a+" "];if(k)return c?0:k.slice(0);for(h=a,i=[],j=w.preFilter;h;){(!d||(e=ja.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),d=!1,(e=ka.exec(h))&&(d=e.shift(),f.push({value:d,type:e[0].replace(ia," ")}),h=h.slice(d.length));for(g in w.filter)!(e=oa[g].exec(h))||j[g]&&!(e=j[g](e))||(d=e.shift(),f.push({value:d,type:g,matches:e}),h=h.slice(d.length));if(!d)break}return c?h.length:h?b.error(a):S(a,i).slice(0)},A=b.compile=function(a,b){var c,d=[],e=[],f=T[a+" "];if(!f){for(b||(b=z(a)),c=b.length;c--;)f=s(b[c]),f[N]?d.push(f):e.push(f);f=T(a,t(e,d)),f.selector=a}return f},B=b.select=function(a,b,c,d){var e,f,g,h,i,j="function"==typeof a&&a,l=!d&&z(a=j.selector||a);if(c=c||[],1===l.length){if(f=l[0]=l[0].slice(0),f.length>2&&"ID"===(g=f[0]).type&&v.getById&&9===b.nodeType&&I&&w.relative[f[1].type]){if(b=(w.find.ID(g.matches[0].replace(va,wa),b)||[])[0],!b)return c;j&&(b=b.parentNode),a=a.slice(f.shift().value.length)}for(e=oa.needsContext.test(a)?0:f.length;e--&&(g=f[e],!w.relative[h=g.type]);)if((i=w.find[h])&&(d=i(g.matches[0].replace(va,wa),ta.test(f[0].type)&&k(b.parentNode)||b))){if(f.splice(e,1),a=d.length&&m(f),!a)return _.apply(c,d),c;break}}return(j||A(a,l))(d,b,!I,c,ta.test(a)&&k(b.parentNode)||b),c},v.sortStable=N.split("").sort(U).join("")===N,v.detectDuplicates=!!E,F(),v.sortDetached=e(function(a){return 1&a.compareDocumentPosition(G.createElement("div"))}),e(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||f("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),v.attributes&&e(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||f("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),e(function(a){return null==a.getAttribute("disabled")})||f(ca,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),b}(a);_.find=ea,_.expr=ea.selectors,_.expr[":"]=_.expr.pseudos,_.unique=ea.uniqueSort,_.text=ea.getText,_.isXMLDoc=ea.isXML,_.contains=ea.contains;var fa=_.expr.match.needsContext,ga=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,ha=/^.[^:#\[\.,]*$/;_.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?_.find.matchesSelector(d,a)?[d]:[]:_.find.matches(a,_.grep(b,function(a){return 1===a.nodeType}))},_.fn.extend({find:function(a){var b,c=this.length,d=[],e=this;if("string"!=typeof a)return this.pushStack(_(a).filter(function(){for(b=0;c>b;b++)if(_.contains(e[b],this))return!0}));for(b=0;c>b;b++)_.find(a,e[b],d);return d=this.pushStack(c>1?_.unique(d):d),d.selector=this.selector?this.selector+" "+a:a,d},filter:function(a){return this.pushStack(d(this,a||[],!1))},not:function(a){return this.pushStack(d(this,a||[],!0))},is:function(a){return!!d(this,"string"==typeof a&&fa.test(a)?_(a):a||[],!1).length}});var ia,ja=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,ka=_.fn.init=function(a,b){var c,d;if(!a)return this;if("string"==typeof a){if(c="<"===a[0]&&">"===a[a.length-1]&&a.length>=3?[null,a,null]:ja.exec(a),!c||!c[1]&&b)return!b||b.jquery?(b||ia).find(a):this.constructor(b).find(a);if(c[1]){if(b=b instanceof _?b[0]:b,_.merge(this,_.parseHTML(c[1],b&&b.nodeType?b.ownerDocument||b:Z,!0)),ga.test(c[1])&&_.isPlainObject(b))for(c in b)_.isFunction(this[c])?this[c](b[c]):this.attr(c,b[c]);return this}return d=Z.getElementById(c[2]),d&&d.parentNode&&(this.length=1,this[0]=d),this.context=Z,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):_.isFunction(a)?"undefined"!=typeof ia.ready?ia.ready(a):a(_):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),_.makeArray(a,this))};ka.prototype=_.fn,ia=_(Z);var la=/^(?:parents|prev(?:Until|All))/,ma={children:!0,contents:!0,next:!0,prev:!0};_.extend({dir:function(a,b,c){for(var d=[],e=void 0!==c;(a=a[b])&&9!==a.nodeType;)if(1===a.nodeType){if(e&&_(a).is(c))break;d.push(a)}return d},sibling:function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c}}),_.fn.extend({has:function(a){var b=_(a,this),c=b.length;return this.filter(function(){for(var a=0;c>a;a++)if(_.contains(this,b[a]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=fa.test(a)||"string"!=typeof a?_(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&_.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?_.unique(f):f)},index:function(a){return a?"string"==typeof a?U.call(_(a),this[0]):U.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(_.unique(_.merge(this.get(),_(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}}),_.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return _.dir(a,"parentNode")},parentsUntil:function(a,b,c){return _.dir(a,"parentNode",c)},next:function(a){return e(a,"nextSibling")},prev:function(a){return e(a,"previousSibling")},nextAll:function(a){return _.dir(a,"nextSibling")},prevAll:function(a){return _.dir(a,"previousSibling")},nextUntil:function(a,b,c){return _.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return _.dir(a,"previousSibling",c)},siblings:function(a){return _.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return _.sibling(a.firstChild)},contents:function(a){return a.contentDocument||_.merge([],a.childNodes)}},function(a,b){_.fn[a]=function(c,d){var e=_.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=_.filter(d,e)),this.length>1&&(ma[a]||_.unique(e),la.test(a)&&e.reverse()),this.pushStack(e)}});var na=/\S+/g,oa={};_.Callbacks=function(a){a="string"==typeof a?oa[a]||f(a):_.extend({},a);var b,c,d,e,g,h,i=[],j=!a.once&&[],k=function(f){for(b=a.memory&&f,c=!0,h=e||0,e=0,g=i.length,d=!0;i&&g>h;h++)if(i[h].apply(f[0],f[1])===!1&&a.stopOnFalse){b=!1;break}d=!1,i&&(j?j.length&&k(j.shift()):b?i=[]:l.disable())},l={add:function(){if(i){var c=i.length;!function f(b){_.each(b,function(b,c){var d=_.type(c);"function"===d?a.unique&&l.has(c)||i.push(c):c&&c.length&&"string"!==d&&f(c)})}(arguments),d?g=i.length:b&&(e=c,k(b))}return this},remove:function(){return i&&_.each(arguments,function(a,b){for(var c;(c=_.inArray(b,i,c))>-1;)i.splice(c,1),d&&(g>=c&&g--,h>=c&&h--)}),this},has:function(a){return a?_.inArray(a,i)>-1:!(!i||!i.length)},empty:function(){return i=[],g=0,this},disable:function(){return i=j=b=void 0,this},disabled:function(){return!i},lock:function(){return j=void 0,b||l.disable(),this},locked:function(){return!j},fireWith:function(a,b){return!i||c&&!j||(b=b||[],b=[a,b.slice?b.slice():b],d?j.push(b):k(b)),this},fire:function(){return l.fireWith(this,arguments),this},fired:function(){return!!c}};return l},_.extend({Deferred:function(a){var b=[["resolve","done",_.Callbacks("once memory"),"resolved"],["reject","fail",_.Callbacks("once memory"),"rejected"],["notify","progress",_.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return _.Deferred(function(c){_.each(b,function(b,f){var g=_.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&_.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?_.extend(a,d):d}},e={};return d.pipe=d.then,_.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b,c,d,e=0,f=R.call(arguments),g=f.length,h=1!==g||a&&_.isFunction(a.promise)?g:0,i=1===h?a:_.Deferred(),j=function(a,c,d){return function(e){c[a]=this,d[a]=arguments.length>1?R.call(arguments):e,d===b?i.notifyWith(c,d):--h||i.resolveWith(c,d)}};if(g>1)for(b=new Array(g),c=new Array(g),d=new Array(g);g>e;e++)f[e]&&_.isFunction(f[e].promise)?f[e].promise().done(j(e,d,f)).fail(i.reject).progress(j(e,c,b)):--h;return h||i.resolveWith(d,f),i.promise()}});var pa;_.fn.ready=function(a){return _.ready.promise().done(a),this},_.extend({isReady:!1,readyWait:1,holdReady:function(a){a?_.readyWait++:_.ready(!0)},ready:function(a){(a===!0?--_.readyWait:_.isReady)||(_.isReady=!0,a!==!0&&--_.readyWait>0||(pa.resolveWith(Z,[_]),_.fn.triggerHandler&&(_(Z).triggerHandler("ready"),_(Z).off("ready"))))}}),_.ready.promise=function(b){return pa||(pa=_.Deferred(),"complete"===Z.readyState?setTimeout(_.ready):(Z.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1))),pa.promise(b)},_.ready.promise();var qa=_.access=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===_.type(c)){e=!0;for(h in c)_.access(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,_.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(_(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f};_.acceptData=function(a){return 1===a.nodeType||9===a.nodeType||!+a.nodeType},h.uid=1,h.accepts=_.acceptData,h.prototype={key:function(a){if(!h.accepts(a))return 0;var b={},c=a[this.expando];if(!c){c=h.uid++;try{b[this.expando]={value:c},Object.defineProperties(a,b)}catch(d){b[this.expando]=c,_.extend(a,b)}}return this.cache[c]||(this.cache[c]={}),c},set:function(a,b,c){var d,e=this.key(a),f=this.cache[e];if("string"==typeof b)f[b]=c;else if(_.isEmptyObject(f))_.extend(this.cache[e],b);else for(d in b)f[d]=b[d];return f},get:function(a,b){var c=this.cache[this.key(a)];return void 0===b?c:c[b]},access:function(a,b,c){var d;return void 0===b||b&&"string"==typeof b&&void 0===c?(d=this.get(a,b),void 0!==d?d:this.get(a,_.camelCase(b))):(this.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d,e,f=this.key(a),g=this.cache[f];if(void 0===b)this.cache[f]={};else{_.isArray(b)?d=b.concat(b.map(_.camelCase)):(e=_.camelCase(b),b in g?d=[b,e]:(d=e,d=d in g?[d]:d.match(na)||[])),c=d.length;for(;c--;)delete g[d[c]]}},hasData:function(a){return!_.isEmptyObject(this.cache[a[this.expando]]||{})},discard:function(a){a[this.expando]&&delete this.cache[a[this.expando]]}};var ra=new h,sa=new h,ta=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,ua=/([A-Z])/g;_.extend({hasData:function(a){return sa.hasData(a)||ra.hasData(a)},data:function(a,b,c){return sa.access(a,b,c)},removeData:function(a,b){sa.remove(a,b)},_data:function(a,b,c){return ra.access(a,b,c)},_removeData:function(a,b){ra.remove(a,b)}}),_.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=sa.get(f),1===f.nodeType&&!ra.get(f,"hasDataAttrs"))){for(c=g.length;c--;)g[c]&&(d=g[c].name,0===d.indexOf("data-")&&(d=_.camelCase(d.slice(5)),i(f,d,e[d])));ra.set(f,"hasDataAttrs",!0)}return e}return"object"==typeof a?this.each(function(){sa.set(this,a)}):qa(this,function(b){var c,d=_.camelCase(a);if(f&&void 0===b){if(c=sa.get(f,a),void 0!==c)return c;if(c=sa.get(f,d),void 0!==c)return c;if(c=i(f,d,void 0),void 0!==c)return c}else this.each(function(){var c=sa.get(this,d);sa.set(this,d,b),-1!==a.indexOf("-")&&void 0!==c&&sa.set(this,a,b)})},null,b,arguments.length>1,null,!0)},removeData:function(a){return this.each(function(){sa.remove(this,a)})}}),_.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=ra.get(a,b),c&&(!d||_.isArray(c)?d=ra.access(a,b,_.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=_.queue(a,b),d=c.length,e=c.shift(),f=_._queueHooks(a,b),g=function(){_.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return ra.get(a,c)||ra.access(a,c,{empty:_.Callbacks("once memory").add(function(){ra.remove(a,[b+"queue",c])})})}}),_.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?_.queue(this[0],a):void 0===b?this:this.each(function(){var c=_.queue(this,a,b);_._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&_.dequeue(this,a)})},dequeue:function(a){return this.each(function(){_.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=_.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};for("string"!=typeof a&&(b=a,a=void 0),a=a||"fx";g--;)c=ra.get(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var va=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,wa=["Top","Right","Bottom","Left"],xa=function(a,b){return a=b||a,"none"===_.css(a,"display")||!_.contains(a.ownerDocument,a)},ya=/^(?:checkbox|radio)$/i;!function(){var a=Z.createDocumentFragment(),b=a.appendChild(Z.createElement("div")),c=Z.createElement("input");c.setAttribute("type","radio"),c.setAttribute("checked","checked"),c.setAttribute("name","t"),b.appendChild(c),Y.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML="<textarea>x</textarea>",Y.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var za="undefined";Y.focusinBubbles="onfocusin"in a;var Aa=/^key/,Ba=/^(?:mouse|pointer|contextmenu)|click/,Ca=/^(?:focusinfocus|focusoutblur)$/,Da=/^([^.]*)(?:\.(.+)|)$/;_.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=ra.get(a);if(q)for(c.handler&&(f=c,c=f.handler,e=f.selector),c.guid||(c.guid=_.guid++),(i=q.events)||(i=q.events={}),(g=q.handle)||(g=q.handle=function(b){return typeof _!==za&&_.event.triggered!==b.type?_.event.dispatch.apply(a,arguments):void 0}),b=(b||"").match(na)||[""],j=b.length;j--;)h=Da.exec(b[j])||[],n=p=h[1],o=(h[2]||"").split(".").sort(),n&&(l=_.event.special[n]||{},n=(e?l.delegateType:l.bindType)||n,l=_.event.special[n]||{},k=_.extend({type:n,origType:p,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&_.expr.match.needsContext.test(e),namespace:o.join(".")},f),(m=i[n])||(m=i[n]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,o,g)!==!1||a.addEventListener&&a.addEventListener(n,g,!1)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),_.event.global[n]=!0)},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=ra.hasData(a)&&ra.get(a);if(q&&(i=q.events)){for(b=(b||"").match(na)||[""],j=b.length;j--;)if(h=Da.exec(b[j])||[],n=p=h[1],o=(h[2]||"").split(".").sort(),n){for(l=_.event.special[n]||{},n=(d?l.delegateType:l.bindType)||n,m=i[n]||[],h=h[2]&&new RegExp("(^|\\.)"+o.join("\\.(?:.*\\.|)")+"(\\.|$)"),g=f=m.length;f--;)k=m[f],!e&&p!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&("**"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,o,q.handle)!==!1||_.removeEvent(a,n,q.handle),delete i[n])}else for(n in i)_.event.remove(a,n+b[j],c,d,!0);_.isEmptyObject(i)&&(delete q.handle,ra.remove(a,"events"))}},trigger:function(b,c,d,e){var f,g,h,i,j,k,l,m=[d||Z],n=X.call(b,"type")?b.type:b,o=X.call(b,"namespace")?b.namespace.split("."):[];if(g=h=d=d||Z,3!==d.nodeType&&8!==d.nodeType&&!Ca.test(n+_.event.triggered)&&(n.indexOf(".")>=0&&(o=n.split("."),n=o.shift(),o.sort()),j=n.indexOf(":")<0&&"on"+n,b=b[_.expando]?b:new _.Event(n,"object"==typeof b&&b),b.isTrigger=e?2:3,b.namespace=o.join("."),b.namespace_re=b.namespace?new RegExp("(^|\\.)"+o.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=d),c=null==c?[b]:_.makeArray(c,[b]),l=_.event.special[n]||{},e||!l.trigger||l.trigger.apply(d,c)!==!1)){if(!e&&!l.noBubble&&!_.isWindow(d)){for(i=l.delegateType||n,Ca.test(i+n)||(g=g.parentNode);g;g=g.parentNode)m.push(g),h=g;h===(d.ownerDocument||Z)&&m.push(h.defaultView||h.parentWindow||a)}for(f=0;(g=m[f++])&&!b.isPropagationStopped();)b.type=f>1?i:l.bindType||n,k=(ra.get(g,"events")||{})[b.type]&&ra.get(g,"handle"),k&&k.apply(g,c),k=j&&g[j],k&&k.apply&&_.acceptData(g)&&(b.result=k.apply(g,c),b.result===!1&&b.preventDefault());return b.type=n,e||b.isDefaultPrevented()||l._default&&l._default.apply(m.pop(),c)!==!1||!_.acceptData(d)||j&&_.isFunction(d[n])&&!_.isWindow(d)&&(h=d[j],h&&(d[j]=null),_.event.triggered=n,d[n](),_.event.triggered=void 0,h&&(d[j]=h)),b.result}},dispatch:function(a){a=_.event.fix(a);var b,c,d,e,f,g=[],h=R.call(arguments),i=(ra.get(this,"events")||{})[a.type]||[],j=_.event.special[a.type]||{};if(h[0]=a,a.delegateTarget=this,!j.preDispatch||j.preDispatch.call(this,a)!==!1){for(g=_.event.handlers.call(this,a,i),b=0;(e=g[b++])&&!a.isPropagationStopped();)for(a.currentTarget=e.elem,c=0;(f=e.handlers[c++])&&!a.isImmediatePropagationStopped();)(!a.namespace_re||a.namespace_re.test(f.namespace))&&(a.handleObj=f,a.data=f.data,d=((_.event.special[f.origType]||{}).handle||f.handler).apply(e.elem,h),void 0!==d&&(a.result=d)===!1&&(a.preventDefault(),a.stopPropagation()));return j.postDispatch&&j.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(!a.button||"click"!==a.type))for(;i!==this;i=i.parentNode||this)if(i.disabled!==!0||"click"!==a.type){for(d=[],c=0;h>c;c++)f=b[c],e=f.selector+" ",void 0===d[e]&&(d[e]=f.needsContext?_(e,this).index(i)>=0:_.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,d,e,f=b.button;return null==a.pageX&&null!=b.clientX&&(c=a.target.ownerDocument||Z,d=c.documentElement,e=c.body,a.pageX=b.clientX+(d&&d.scrollLeft||e&&e.scrollLeft||0)-(d&&d.clientLeft||e&&e.clientLeft||0),a.pageY=b.clientY+(d&&d.scrollTop||e&&e.scrollTop||0)-(d&&d.clientTop||e&&e.clientTop||0)),a.which||void 0===f||(a.which=1&f?1:2&f?3:4&f?2:0),a}},fix:function(a){if(a[_.expando])return a;var b,c,d,e=a.type,f=a,g=this.fixHooks[e];for(g||(this.fixHooks[e]=g=Ba.test(e)?this.mouseHooks:Aa.test(e)?this.keyHooks:{}),d=g.props?this.props.concat(g.props):this.props,a=new _.Event(f),b=d.length;b--;)c=d[b],a[c]=f[c];return a.target||(a.target=Z),3===a.target.nodeType&&(a.target=a.target.parentNode),g.filter?g.filter(a,f):a},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==l()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===l()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&_.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(a){return _.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){var e=_.extend(new _.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?_.event.trigger(e,null,b):_.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},_.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)},_.Event=function(a,b){return this instanceof _.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?j:k):this.type=a,b&&_.extend(this,b),this.timeStamp=a&&a.timeStamp||_.now(),void(this[_.expando]=!0)):new _.Event(a,b)},_.Event.prototype={isDefaultPrevented:k,isPropagationStopped:k,isImmediatePropagationStopped:k,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=j,a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=j,a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=j,a&&a.stopImmediatePropagation&&a.stopImmediatePropagation(),this.stopPropagation()}},_.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,b){_.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!_.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),Y.focusinBubbles||_.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){_.event.simulate(b,a.target,_.event.fix(a),!0)};_.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=ra.access(d,b);e||d.addEventListener(a,c,!0),ra.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=ra.access(d,b)-1;e?ra.access(d,b,e):(d.removeEventListener(a,c,!0),ra.remove(d,b))}}}),_.fn.extend({on:function(a,b,c,d,e){var f,g;if("object"==typeof a){"string"!=typeof b&&(c=c||b,b=void 0);for(g in a)this.on(g,b,c,a[g],e);return this}if(null==c&&null==d?(d=b,c=b=void 0):null==d&&("string"==typeof b?(d=c,c=void 0):(d=c,c=b,b=void 0)),d===!1)d=k;else if(!d)return this;return 1===e&&(f=d,d=function(a){return _().off(a),f.apply(this,arguments)},d.guid=f.guid||(f.guid=_.guid++)),this.each(function(){_.event.add(this,a,d,c,b)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,_(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=k),this.each(function(){_.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){_.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?_.event.trigger(a,b,c,!0):void 0}});var Ea=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,Fa=/<([\w:]+)/,Ga=/<|&#?\w+;/,Ha=/<(?:script|style|link)/i,Ia=/checked\s*(?:[^=]|=\s*.checked.)/i,Ja=/^$|\/(?:java|ecma)script/i,Ka=/^true\/(.*)/,La=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,Ma={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],
col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};Ma.optgroup=Ma.option,Ma.tbody=Ma.tfoot=Ma.colgroup=Ma.caption=Ma.thead,Ma.th=Ma.td,_.extend({clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=_.contains(a.ownerDocument,a);if(!(Y.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||_.isXMLDoc(a)))for(g=r(h),f=r(a),d=0,e=f.length;e>d;d++)s(f[d],g[d]);if(b)if(c)for(f=f||r(a),g=g||r(h),d=0,e=f.length;e>d;d++)q(f[d],g[d]);else q(a,h);return g=r(h,"script"),g.length>0&&p(g,!i&&r(a,"script")),h},buildFragment:function(a,b,c,d){for(var e,f,g,h,i,j,k=b.createDocumentFragment(),l=[],m=0,n=a.length;n>m;m++)if(e=a[m],e||0===e)if("object"===_.type(e))_.merge(l,e.nodeType?[e]:e);else if(Ga.test(e)){for(f=f||k.appendChild(b.createElement("div")),g=(Fa.exec(e)||["",""])[1].toLowerCase(),h=Ma[g]||Ma._default,f.innerHTML=h[1]+e.replace(Ea,"<$1></$2>")+h[2],j=h[0];j--;)f=f.lastChild;_.merge(l,f.childNodes),f=k.firstChild,f.textContent=""}else l.push(b.createTextNode(e));for(k.textContent="",m=0;e=l[m++];)if((!d||-1===_.inArray(e,d))&&(i=_.contains(e.ownerDocument,e),f=r(k.appendChild(e),"script"),i&&p(f),c))for(j=0;e=f[j++];)Ja.test(e.type||"")&&c.push(e);return k},cleanData:function(a){for(var b,c,d,e,f=_.event.special,g=0;void 0!==(c=a[g]);g++){if(_.acceptData(c)&&(e=c[ra.expando],e&&(b=ra.cache[e]))){if(b.events)for(d in b.events)f[d]?_.event.remove(c,d):_.removeEvent(c,d,b.handle);ra.cache[e]&&delete ra.cache[e]}delete sa.cache[c[sa.expando]]}}}),_.fn.extend({text:function(a){return qa(this,function(a){return void 0===a?_.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=a)})},null,a,arguments.length)},append:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=m(this,a);b.appendChild(a)}})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=m(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},remove:function(a,b){for(var c,d=a?_.filter(a,this):this,e=0;null!=(c=d[e]);e++)b||1!==c.nodeType||_.cleanData(r(c)),c.parentNode&&(b&&_.contains(c.ownerDocument,c)&&p(r(c,"script")),c.parentNode.removeChild(c));return this},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(_.cleanData(r(a,!1)),a.textContent="");return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return _.clone(this,a,b)})},html:function(a){return qa(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if("string"==typeof a&&!Ha.test(a)&&!Ma[(Fa.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(Ea,"<$1></$2>");try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(_.cleanData(r(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=arguments[0];return this.domManip(arguments,function(b){a=this.parentNode,_.cleanData(r(this)),a&&a.replaceChild(b,this)}),a&&(a.length||a.nodeType)?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,b){a=S.apply([],a);var c,d,e,f,g,h,i=0,j=this.length,k=this,l=j-1,m=a[0],p=_.isFunction(m);if(p||j>1&&"string"==typeof m&&!Y.checkClone&&Ia.test(m))return this.each(function(c){var d=k.eq(c);p&&(a[0]=m.call(this,c,d.html())),d.domManip(a,b)});if(j&&(c=_.buildFragment(a,this[0].ownerDocument,!1,this),d=c.firstChild,1===c.childNodes.length&&(c=d),d)){for(e=_.map(r(c,"script"),n),f=e.length;j>i;i++)g=c,i!==l&&(g=_.clone(g,!0,!0),f&&_.merge(e,r(g,"script"))),b.call(this[i],g,i);if(f)for(h=e[e.length-1].ownerDocument,_.map(e,o),i=0;f>i;i++)g=e[i],Ja.test(g.type||"")&&!ra.access(g,"globalEval")&&_.contains(h,g)&&(g.src?_._evalUrl&&_._evalUrl(g.src):_.globalEval(g.textContent.replace(La,"")))}return this}}),_.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){_.fn[a]=function(a){for(var c,d=[],e=_(a),f=e.length-1,g=0;f>=g;g++)c=g===f?this:this.clone(!0),_(e[g])[b](c),T.apply(d,c.get());return this.pushStack(d)}});var Na,Oa={},Pa=/^margin/,Qa=new RegExp("^("+va+")(?!px)[a-z%]+$","i"),Ra=function(a){return a.ownerDocument.defaultView.getComputedStyle(a,null)};!function(){function b(){g.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",g.innerHTML="",e.appendChild(f);var b=a.getComputedStyle(g,null);c="1%"!==b.top,d="4px"===b.width,e.removeChild(f)}var c,d,e=Z.documentElement,f=Z.createElement("div"),g=Z.createElement("div");g.style&&(g.style.backgroundClip="content-box",g.cloneNode(!0).style.backgroundClip="",Y.clearCloneStyle="content-box"===g.style.backgroundClip,f.style.cssText="border:0;width:0;height:0;top:0;left:-9999px;margin-top:1px;position:absolute",f.appendChild(g),a.getComputedStyle&&_.extend(Y,{pixelPosition:function(){return b(),c},boxSizingReliable:function(){return null==d&&b(),d},reliableMarginRight:function(){var b,c=g.appendChild(Z.createElement("div"));return c.style.cssText=g.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",c.style.marginRight=c.style.width="0",g.style.width="1px",e.appendChild(f),b=!parseFloat(a.getComputedStyle(c,null).marginRight),e.removeChild(f),b}}))}(),_.swap=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e};var Sa=/^(none|table(?!-c[ea]).+)/,Ta=new RegExp("^("+va+")(.*)$","i"),Ua=new RegExp("^([+-])=("+va+")","i"),Va={position:"absolute",visibility:"hidden",display:"block"},Wa={letterSpacing:"0",fontWeight:"400"},Xa=["Webkit","O","Moz","ms"];_.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=v(a,"opacity");return""===c?"1":c}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=_.camelCase(b),i=a.style;return b=_.cssProps[h]||(_.cssProps[h]=x(i,h)),g=_.cssHooks[b]||_.cssHooks[h],void 0===c?g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b]:(f=typeof c,"string"===f&&(e=Ua.exec(c))&&(c=(e[1]+1)*e[2]+parseFloat(_.css(a,b)),f="number"),void(null!=c&&c===c&&("number"!==f||_.cssNumber[h]||(c+="px"),Y.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),g&&"set"in g&&void 0===(c=g.set(a,c,d))||(i[b]=c))))}},css:function(a,b,c,d){var e,f,g,h=_.camelCase(b);return b=_.cssProps[h]||(_.cssProps[h]=x(a.style,h)),g=_.cssHooks[b]||_.cssHooks[h],g&&"get"in g&&(e=g.get(a,!0,c)),void 0===e&&(e=v(a,b,d)),"normal"===e&&b in Wa&&(e=Wa[b]),""===c||c?(f=parseFloat(e),c===!0||_.isNumeric(f)?f||0:e):e}}),_.each(["height","width"],function(a,b){_.cssHooks[b]={get:function(a,c,d){return c?Sa.test(_.css(a,"display"))&&0===a.offsetWidth?_.swap(a,Va,function(){return A(a,b,d)}):A(a,b,d):void 0},set:function(a,c,d){var e=d&&Ra(a);return y(a,c,d?z(a,b,d,"border-box"===_.css(a,"boxSizing",!1,e),e):0)}}}),_.cssHooks.marginRight=w(Y.reliableMarginRight,function(a,b){return b?_.swap(a,{display:"inline-block"},v,[a,"marginRight"]):void 0}),_.each({margin:"",padding:"",border:"Width"},function(a,b){_.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+wa[d]+b]=f[d]||f[d-2]||f[0];return e}},Pa.test(a)||(_.cssHooks[a+b].set=y)}),_.fn.extend({css:function(a,b){return qa(this,function(a,b,c){var d,e,f={},g=0;if(_.isArray(b)){for(d=Ra(a),e=b.length;e>g;g++)f[b[g]]=_.css(a,b[g],!1,d);return f}return void 0!==c?_.style(a,b,c):_.css(a,b)},a,b,arguments.length>1)},show:function(){return B(this,!0)},hide:function(){return B(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){xa(this)?_(this).show():_(this).hide()})}}),_.Tween=C,C.prototype={constructor:C,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||"swing",this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(_.cssNumber[c]?"":"px")},cur:function(){var a=C.propHooks[this.prop];return a&&a.get?a.get(this):C.propHooks._default.get(this)},run:function(a){var b,c=C.propHooks[this.prop];return this.pos=b=this.options.duration?_.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):C.propHooks._default.set(this),this}},C.prototype.init.prototype=C.prototype,C.propHooks={_default:{get:function(a){var b;return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(b=_.css(a.elem,a.prop,""),b&&"auto"!==b?b:0):a.elem[a.prop]},set:function(a){_.fx.step[a.prop]?_.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[_.cssProps[a.prop]]||_.cssHooks[a.prop])?_.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},C.propHooks.scrollTop=C.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},_.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},_.fx=C.prototype.init,_.fx.step={};var Ya,Za,$a=/^(?:toggle|show|hide)$/,_a=new RegExp("^(?:([+-])=|)("+va+")([a-z%]*)$","i"),ab=/queueHooks$/,bb=[G],cb={"*":[function(a,b){var c=this.createTween(a,b),d=c.cur(),e=_a.exec(b),f=e&&e[3]||(_.cssNumber[a]?"":"px"),g=(_.cssNumber[a]||"px"!==f&&+d)&&_a.exec(_.css(c.elem,a)),h=1,i=20;if(g&&g[3]!==f){f=f||g[3],e=e||[],g=+d||1;do h=h||".5",g/=h,_.style(c.elem,a,g+f);while(h!==(h=c.cur()/d)&&1!==h&&--i)}return e&&(g=c.start=+g||+d||0,c.unit=f,c.end=e[1]?g+(e[1]+1)*e[2]:+e[2]),c}]};_.Animation=_.extend(I,{tweener:function(a,b){_.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");for(var c,d=0,e=a.length;e>d;d++)c=a[d],cb[c]=cb[c]||[],cb[c].unshift(b)},prefilter:function(a,b){b?bb.unshift(a):bb.push(a)}}),_.speed=function(a,b,c){var d=a&&"object"==typeof a?_.extend({},a):{complete:c||!c&&b||_.isFunction(a)&&a,duration:a,easing:c&&b||b&&!_.isFunction(b)&&b};return d.duration=_.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in _.fx.speeds?_.fx.speeds[d.duration]:_.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){_.isFunction(d.old)&&d.old.call(this),d.queue&&_.dequeue(this,d.queue)},d},_.fn.extend({fadeTo:function(a,b,c,d){return this.filter(xa).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=_.isEmptyObject(a),f=_.speed(b,c,d),g=function(){var b=I(this,_.extend({},a),f);(e||ra.get(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=_.timers,g=ra.get(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&ab.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&_.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=ra.get(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=_.timers,g=d?d.length:0;for(c.finish=!0,_.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),_.each(["toggle","show","hide"],function(a,b){var c=_.fn[b];_.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(E(b,!0),a,d,e)}}),_.each({slideDown:E("show"),slideUp:E("hide"),slideToggle:E("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){_.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),_.timers=[],_.fx.tick=function(){var a,b=0,c=_.timers;for(Ya=_.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||_.fx.stop(),Ya=void 0},_.fx.timer=function(a){_.timers.push(a),a()?_.fx.start():_.timers.pop()},_.fx.interval=13,_.fx.start=function(){Za||(Za=setInterval(_.fx.tick,_.fx.interval))},_.fx.stop=function(){clearInterval(Za),Za=null},_.fx.speeds={slow:600,fast:200,_default:400},_.fn.delay=function(a,b){return a=_.fx?_.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},function(){var a=Z.createElement("input"),b=Z.createElement("select"),c=b.appendChild(Z.createElement("option"));a.type="checkbox",Y.checkOn=""!==a.value,Y.optSelected=c.selected,b.disabled=!0,Y.optDisabled=!c.disabled,a=Z.createElement("input"),a.value="t",a.type="radio",Y.radioValue="t"===a.value}();var db,eb,fb=_.expr.attrHandle;_.fn.extend({attr:function(a,b){return qa(this,_.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){_.removeAttr(this,a)})}}),_.extend({attr:function(a,b,c){var d,e,f=a.nodeType;return a&&3!==f&&8!==f&&2!==f?typeof a.getAttribute===za?_.prop(a,b,c):(1===f&&_.isXMLDoc(a)||(b=b.toLowerCase(),d=_.attrHooks[b]||(_.expr.match.bool.test(b)?eb:db)),void 0===c?d&&"get"in d&&null!==(e=d.get(a,b))?e:(e=_.find.attr(a,b),null==e?void 0:e):null!==c?d&&"set"in d&&void 0!==(e=d.set(a,c,b))?e:(a.setAttribute(b,c+""),c):void _.removeAttr(a,b)):void 0},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(na);if(f&&1===a.nodeType)for(;c=f[e++];)d=_.propFix[c]||c,_.expr.match.bool.test(c)&&(a[d]=!1),a.removeAttribute(c)},attrHooks:{type:{set:function(a,b){if(!Y.radioValue&&"radio"===b&&_.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}}}),eb={set:function(a,b,c){return b===!1?_.removeAttr(a,c):a.setAttribute(c,c),c}},_.each(_.expr.match.bool.source.match(/\w+/g),function(a,b){var c=fb[b]||_.find.attr;fb[b]=function(a,b,d){var e,f;return d||(f=fb[b],fb[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,fb[b]=f),e}});var gb=/^(?:input|select|textarea|button)$/i;_.fn.extend({prop:function(a,b){return qa(this,_.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[_.propFix[a]||a]})}}),_.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(a,b,c){var d,e,f,g=a.nodeType;return a&&3!==g&&8!==g&&2!==g?(f=1!==g||!_.isXMLDoc(a),f&&(b=_.propFix[b]||b,e=_.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]):void 0},propHooks:{tabIndex:{get:function(a){return a.hasAttribute("tabindex")||gb.test(a.nodeName)||a.href?a.tabIndex:-1}}}}),Y.optSelected||(_.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null}}),_.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){_.propFix[this.toLowerCase()]=this});var hb=/[\t\r\n\f]/g;_.fn.extend({addClass:function(a){var b,c,d,e,f,g,h="string"==typeof a&&a,i=0,j=this.length;if(_.isFunction(a))return this.each(function(b){_(this).addClass(a.call(this,b,this.className))});if(h)for(b=(a||"").match(na)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(hb," "):" ")){for(f=0;e=b[f++];)d.indexOf(" "+e+" ")<0&&(d+=e+" ");g=_.trim(d),c.className!==g&&(c.className=g)}return this},removeClass:function(a){var b,c,d,e,f,g,h=0===arguments.length||"string"==typeof a&&a,i=0,j=this.length;if(_.isFunction(a))return this.each(function(b){_(this).removeClass(a.call(this,b,this.className))});if(h)for(b=(a||"").match(na)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(hb," "):"")){for(f=0;e=b[f++];)for(;d.indexOf(" "+e+" ")>=0;)d=d.replace(" "+e+" "," ");g=a?_.trim(d):"",c.className!==g&&(c.className=g)}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):this.each(_.isFunction(a)?function(c){_(this).toggleClass(a.call(this,c,this.className,b),b)}:function(){if("string"===c)for(var b,d=0,e=_(this),f=a.match(na)||[];b=f[d++];)e.hasClass(b)?e.removeClass(b):e.addClass(b);else(c===za||"boolean"===c)&&(this.className&&ra.set(this,"__className__",this.className),this.className=this.className||a===!1?"":ra.get(this,"__className__")||"")})},hasClass:function(a){for(var b=" "+a+" ",c=0,d=this.length;d>c;c++)if(1===this[c].nodeType&&(" "+this[c].className+" ").replace(hb," ").indexOf(b)>=0)return!0;return!1}});var ib=/\r/g;_.fn.extend({val:function(a){var b,c,d,e=this[0];return arguments.length?(d=_.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,_(this).val()):a,null==e?e="":"number"==typeof e?e+="":_.isArray(e)&&(e=_.map(e,function(a){return null==a?"":a+""})),b=_.valHooks[this.type]||_.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))})):e?(b=_.valHooks[e.type]||_.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(ib,""):null==c?"":c)):void 0}}),_.extend({valHooks:{option:{get:function(a){var b=_.find.attr(a,"value");return null!=b?b:_.trim(_.text(a))}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],!(!c.selected&&i!==e||(Y.optDisabled?c.disabled:null!==c.getAttribute("disabled"))||c.parentNode.disabled&&_.nodeName(c.parentNode,"optgroup"))){if(b=_(c).val(),f)return b;g.push(b)}return g},set:function(a,b){for(var c,d,e=a.options,f=_.makeArray(b),g=e.length;g--;)d=e[g],(d.selected=_.inArray(d.value,f)>=0)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),_.each(["radio","checkbox"],function(){_.valHooks[this]={set:function(a,b){return _.isArray(b)?a.checked=_.inArray(_(a).val(),b)>=0:void 0}},Y.checkOn||(_.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})}),_.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){_.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),_.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var jb=_.now(),kb=/\?/;_.parseJSON=function(a){return JSON.parse(a+"")},_.parseXML=function(a){var b,c;if(!a||"string"!=typeof a)return null;try{c=new DOMParser,b=c.parseFromString(a,"text/xml")}catch(d){b=void 0}return(!b||b.getElementsByTagName("parsererror").length)&&_.error("Invalid XML: "+a),b};var lb,mb,nb=/#.*$/,ob=/([?&])_=[^&]*/,pb=/^(.*?):[ \t]*([^\r\n]*)$/gm,qb=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,rb=/^(?:GET|HEAD)$/,sb=/^\/\//,tb=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,ub={},vb={},wb="*/".concat("*");try{mb=location.href}catch(xb){mb=Z.createElement("a"),mb.href="",mb=mb.href}lb=tb.exec(mb.toLowerCase())||[],_.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:mb,type:"GET",isLocal:qb.test(lb[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":wb,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":_.parseJSON,"text xml":_.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?L(L(a,_.ajaxSettings),b):L(_.ajaxSettings,a)},ajaxPrefilter:J(ub),ajaxTransport:J(vb),ajax:function(a,b){function c(a,b,c,g){var i,k,r,s,u,w=b;2!==t&&(t=2,h&&clearTimeout(h),d=void 0,f=g||"",v.readyState=a>0?4:0,i=a>=200&&300>a||304===a,c&&(s=M(l,v,c)),s=N(l,s,v,i),i?(l.ifModified&&(u=v.getResponseHeader("Last-Modified"),u&&(_.lastModified[e]=u),u=v.getResponseHeader("etag"),u&&(_.etag[e]=u)),204===a||"HEAD"===l.type?w="nocontent":304===a?w="notmodified":(w=s.state,k=s.data,r=s.error,i=!r)):(r=w,(a||!w)&&(w="error",0>a&&(a=0))),v.status=a,v.statusText=(b||w)+"",i?o.resolveWith(m,[k,w,v]):o.rejectWith(m,[v,w,r]),v.statusCode(q),q=void 0,j&&n.trigger(i?"ajaxSuccess":"ajaxError",[v,l,i?k:r]),p.fireWith(m,[v,w]),j&&(n.trigger("ajaxComplete",[v,l]),--_.active||_.event.trigger("ajaxStop")))}"object"==typeof a&&(b=a,a=void 0),b=b||{};var d,e,f,g,h,i,j,k,l=_.ajaxSetup({},b),m=l.context||l,n=l.context&&(m.nodeType||m.jquery)?_(m):_.event,o=_.Deferred(),p=_.Callbacks("once memory"),q=l.statusCode||{},r={},s={},t=0,u="canceled",v={readyState:0,getResponseHeader:function(a){var b;if(2===t){if(!g)for(g={};b=pb.exec(f);)g[b[1].toLowerCase()]=b[2];b=g[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===t?f:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return t||(a=s[c]=s[c]||a,r[a]=b),this},overrideMimeType:function(a){return t||(l.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>t)for(b in a)q[b]=[q[b],a[b]];else v.always(a[v.status]);return this},abort:function(a){var b=a||u;return d&&d.abort(b),c(0,b),this}};if(o.promise(v).complete=p.add,v.success=v.done,v.error=v.fail,l.url=((a||l.url||mb)+"").replace(nb,"").replace(sb,lb[1]+"//"),l.type=b.method||b.type||l.method||l.type,l.dataTypes=_.trim(l.dataType||"*").toLowerCase().match(na)||[""],null==l.crossDomain&&(i=tb.exec(l.url.toLowerCase()),l.crossDomain=!(!i||i[1]===lb[1]&&i[2]===lb[2]&&(i[3]||("http:"===i[1]?"80":"443"))===(lb[3]||("http:"===lb[1]?"80":"443")))),l.data&&l.processData&&"string"!=typeof l.data&&(l.data=_.param(l.data,l.traditional)),K(ub,l,b,v),2===t)return v;j=l.global,j&&0===_.active++&&_.event.trigger("ajaxStart"),l.type=l.type.toUpperCase(),l.hasContent=!rb.test(l.type),e=l.url,l.hasContent||(l.data&&(e=l.url+=(kb.test(e)?"&":"?")+l.data,delete l.data),l.cache===!1&&(l.url=ob.test(e)?e.replace(ob,"$1_="+jb++):e+(kb.test(e)?"&":"?")+"_="+jb++)),l.ifModified&&(_.lastModified[e]&&v.setRequestHeader("If-Modified-Since",_.lastModified[e]),_.etag[e]&&v.setRequestHeader("If-None-Match",_.etag[e])),(l.data&&l.hasContent&&l.contentType!==!1||b.contentType)&&v.setRequestHeader("Content-Type",l.contentType),v.setRequestHeader("Accept",l.dataTypes[0]&&l.accepts[l.dataTypes[0]]?l.accepts[l.dataTypes[0]]+("*"!==l.dataTypes[0]?", "+wb+"; q=0.01":""):l.accepts["*"]);for(k in l.headers)v.setRequestHeader(k,l.headers[k]);if(l.beforeSend&&(l.beforeSend.call(m,v,l)===!1||2===t))return v.abort();u="abort";for(k in{success:1,error:1,complete:1})v[k](l[k]);if(d=K(vb,l,b,v)){v.readyState=1,j&&n.trigger("ajaxSend",[v,l]),l.async&&l.timeout>0&&(h=setTimeout(function(){v.abort("timeout")},l.timeout));try{t=1,d.send(r,c)}catch(w){if(!(2>t))throw w;c(-1,w)}}else c(-1,"No Transport");return v},getJSON:function(a,b,c){return _.get(a,b,c,"json")},getScript:function(a,b){return _.get(a,void 0,b,"script")}}),_.each(["get","post"],function(a,b){_[b]=function(a,c,d,e){return _.isFunction(c)&&(e=e||d,d=c,c=void 0),_.ajax({url:a,type:b,dataType:e,data:c,success:d})}}),_.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){_.fn[b]=function(a){return this.on(b,a)}}),_._evalUrl=function(a){return _.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},_.fn.extend({wrapAll:function(a){var b;return _.isFunction(a)?this.each(function(b){_(this).wrapAll(a.call(this,b))}):(this[0]&&(b=_(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){for(var a=this;a.firstElementChild;)a=a.firstElementChild;return a}).append(this)),this)},wrapInner:function(a){return this.each(_.isFunction(a)?function(b){_(this).wrapInner(a.call(this,b))}:function(){var b=_(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=_.isFunction(a);return this.each(function(c){_(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){_.nodeName(this,"body")||_(this).replaceWith(this.childNodes)}).end()}}),_.expr.filters.hidden=function(a){return a.offsetWidth<=0&&a.offsetHeight<=0},_.expr.filters.visible=function(a){return!_.expr.filters.hidden(a)};var yb=/%20/g,zb=/\[\]$/,Ab=/\r?\n/g,Bb=/^(?:submit|button|image|reset|file)$/i,Cb=/^(?:input|select|textarea|keygen)/i;_.param=function(a,b){var c,d=[],e=function(a,b){b=_.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=_.ajaxSettings&&_.ajaxSettings.traditional),_.isArray(a)||a.jquery&&!_.isPlainObject(a))_.each(a,function(){e(this.name,this.value)});else for(c in a)O(c,a[c],b,e);return d.join("&").replace(yb,"+")},_.fn.extend({serialize:function(){return _.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=_.prop(this,"elements");return a?_.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!_(this).is(":disabled")&&Cb.test(this.nodeName)&&!Bb.test(a)&&(this.checked||!ya.test(a))}).map(function(a,b){var c=_(this).val();return null==c?null:_.isArray(c)?_.map(c,function(a){return{name:b.name,value:a.replace(Ab,"\r\n")}}):{name:b.name,value:c.replace(Ab,"\r\n")}}).get()}}),_.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(a){}};var Db=0,Eb={},Fb={0:200,1223:204},Gb=_.ajaxSettings.xhr();a.ActiveXObject&&_(a).on("unload",function(){for(var a in Eb)Eb[a]()}),Y.cors=!!Gb&&"withCredentials"in Gb,Y.ajax=Gb=!!Gb,_.ajaxTransport(function(a){var b;return Y.cors||Gb&&!a.crossDomain?{send:function(c,d){var e,f=a.xhr(),g=++Db;if(f.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(e in a.xhrFields)f[e]=a.xhrFields[e];a.mimeType&&f.overrideMimeType&&f.overrideMimeType(a.mimeType),a.crossDomain||c["X-Requested-With"]||(c["X-Requested-With"]="XMLHttpRequest");for(e in c)f.setRequestHeader(e,c[e]);b=function(a){return function(){b&&(delete Eb[g],b=f.onload=f.onerror=null,"abort"===a?f.abort():"error"===a?d(f.status,f.statusText):d(Fb[f.status]||f.status,f.statusText,"string"==typeof f.responseText?{text:f.responseText}:void 0,f.getAllResponseHeaders()))}},f.onload=b(),f.onerror=b("error"),b=Eb[g]=b("abort");try{f.send(a.hasContent&&a.data||null)}catch(h){if(b)throw h}},abort:function(){b&&b()}}:void 0}),_.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return _.globalEval(a),a}}}),_.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET")}),_.ajaxTransport("script",function(a){if(a.crossDomain){var b,c;return{send:function(d,e){b=_("<script>").prop({async:!0,charset:a.scriptCharset,src:a.url}).on("load error",c=function(a){b.remove(),c=null,a&&e("error"===a.type?404:200,a.type)}),Z.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Hb=[],Ib=/(=)\?(?=&|$)|\?\?/;_.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=Hb.pop()||_.expando+"_"+jb++;return this[a]=!0,a}}),_.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Ib.test(b.url)?"url":"string"==typeof b.data&&!(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&Ib.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=_.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Ib,"$1"+e):b.jsonp!==!1&&(b.url+=(kb.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||_.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Hb.push(e)),g&&_.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),_.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||Z;var d=ga.exec(a),e=!c&&[];return d?[b.createElement(d[1])]:(d=_.buildFragment([a],b,e),e&&e.length&&_(e).remove(),_.merge([],d.childNodes))};var Jb=_.fn.load;_.fn.load=function(a,b,c){if("string"!=typeof a&&Jb)return Jb.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>=0&&(d=_.trim(a.slice(h)),a=a.slice(0,h)),_.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&_.ajax({url:a,type:e,dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?_("<div>").append(_.parseHTML(a)).find(d):a)}).complete(c&&function(a,b){g.each(c,f||[a.responseText,b,a])}),this},_.expr.filters.animated=function(a){return _.grep(_.timers,function(b){return a===b.elem}).length};var Kb=a.document.documentElement;_.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=_.css(a,"position"),l=_(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=_.css(a,"top"),i=_.css(a,"left"),j=("absolute"===k||"fixed"===k)&&(f+i).indexOf("auto")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),_.isFunction(b)&&(b=b.call(a,c,h)),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},_.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){_.offset.setOffset(this,a,b)});var b,c,d=this[0],e={top:0,left:0},f=d&&d.ownerDocument;return f?(b=f.documentElement,_.contains(b,d)?(typeof d.getBoundingClientRect!==za&&(e=d.getBoundingClientRect()),c=P(f),{top:e.top+c.pageYOffset-b.clientTop,left:e.left+c.pageXOffset-b.clientLeft}):e):void 0},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return"fixed"===_.css(c,"position")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),_.nodeName(a[0],"html")||(d=a.offset()),d.top+=_.css(a[0],"borderTopWidth",!0),d.left+=_.css(a[0],"borderLeftWidth",!0)),{top:b.top-d.top-_.css(c,"marginTop",!0),left:b.left-d.left-_.css(c,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var a=this.offsetParent||Kb;a&&!_.nodeName(a,"html")&&"static"===_.css(a,"position");)a=a.offsetParent;return a||Kb})}}),_.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(b,c){var d="pageYOffset"===c;_.fn[b]=function(e){return qa(this,function(b,e,f){var g=P(b);return void 0===f?g?g[c]:b[e]:void(g?g.scrollTo(d?a.pageXOffset:f,d?f:a.pageYOffset):b[e]=f)},b,e,arguments.length,null)}}),_.each(["top","left"],function(a,b){_.cssHooks[b]=w(Y.pixelPosition,function(a,c){return c?(c=v(a,b),Qa.test(c)?_(a).position()[b]+"px":c):void 0})}),_.each({Height:"height",Width:"width"},function(a,b){_.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){_.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return qa(this,function(b,c,d){var e;return _.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?_.css(b,c,g):_.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),_.fn.size=function(){return this.length},_.fn.andSelf=_.fn.addBack,"function"==typeof define&&define.amd&&define("jquery/jquery",[],function(){return _});var Lb=a.jQuery,Mb=a.$;return _.noConflict=function(b){return a.$===_&&(a.$=Mb),
b&&a.jQuery===_&&(a.jQuery=Lb),_},typeof b===za&&(a.jQuery=a.$=_),_})}),define("jquery-localize-master/dist/jquery.localize.js",[],function(a,b,c){var d=a("jquery/jquery");!function(a){var b;return b=function(a){return a=a.replace(/_/,"-").toLowerCase(),a.length>3&&(a=a.substring(0,3)+a.substring(3).toUpperCase()),a},a.defaultLanguage=b(navigator.language||navigator.userLanguage),a.localize=function(c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;return null==d&&(d={}),u=this,g={},f=d.fileExtension||"json",j=function(a,b,c){var e;switch(null==c&&(c=1),c){case 1:return g={},d.loadBase?(e=a+("."+f),h(e,a,b,c)):j(a,b,2);case 2:if(b.length>=2)return e=""+a+"-"+b.substring(0,2)+"."+f,h(e,a,b,c);break;case 3:if(b.length>=5)return e=""+a+"-"+b.substring(0,5)+"."+f,h(e,a,b,c)}},h=function(b,c,e,f){var h,i,k;return null!=d.pathPrefix&&(b=""+d.pathPrefix+"/"+b),k=function(b){return a.extend(g,b),p(g),j(c,e,f+1)},i=function(){return d.fallback&&d.fallback!==e?j(c,d.fallback):void 0},h={url:b,dataType:"json",async:!1,timeout:null!=d.timeout?d.timeout:500,success:k,error:i},"file:"===window.location.protocol&&(h.error=function(b){return b.responseText&&k(a.parseJSON(b.responseText))}),a.ajax(h)},p=function(a){return null!=d.callback?d.callback(a,e):e(a)},e=function(b){return a.localize.data[c]=b,u.each(function(){var c,d,e;return c=a(this),d=c.data("localize"),d||(d=c.attr("rel").match(/localize\[(.*?)\]/)[1]),e=t(d,b),null!=e?k(c,d,e):void 0})},k=function(b,c,d){return b.is("input")?n(b,c,d):b.is("img")?m(b,c,d):b.is("optgroup")?o(b,c,d):a.isPlainObject(d)||b.html(d),a.isPlainObject(d)?l(b,d):void 0},n=function(b,c,d){var e;return e=a.isPlainObject(d)?d.value:d,b.is("[placeholder]")?b.attr("placeholder",e):b.val(e)},l=function(a,b){return r(a,"title",b),s(a,"text",b)},o=function(a,b,c){return a.attr("label",c)},m=function(a,b,c){return r(a,"alt",c),r(a,"src",c)},t=function(a,b){var c,d,e,f;for(c=a.split(/\./),d=b,e=0,f=c.length;f>e;e++)a=c[e],d=null!=d?d[a]:null;return d},r=function(a,b,c){return c=t(b,c),null!=c?a.attr(b,c):void 0},s=function(a,b,c){return c=t(b,c),null!=c?a.text(c):void 0},q=function(a){var b;return"string"==typeof a?"^"+a+"$":null!=a.length?function(){var c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(q(b));return e}().join("|"):a},i=b(d.language?d.language:a.defaultLanguage),d.skipLanguage&&i.match(q(d.skipLanguage))||j(c,i,1),u},a.fn.localize=a.localize,a.localize.data={}}(d)}),define("bootstrape/js/bootstrap",[],function(a,b,c){"use strict";if(window.jQuery||(window.$=a("$"),window.jQuery=window.$),"undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");+function(a){function b(b){return this.each(function(){var c=a(this),e=c.data("bs.alert");e||c.data("bs.alert",e=new d(this)),"string"==typeof b&&e[b].call(c)})}var c='[data-dismiss="alert"]',d=function(b){a(b).on("click",c,this.close)};d.VERSION="3.2.0",d.prototype.close=function(b){function c(){f.detach().trigger("closed.bs.alert").remove()}var d=a(this),e=d.attr("data-target");e||(e=d.attr("href"),e=e&&e.replace(/.*(?=#[^\s]*$)/,""));var f=a(e);b&&b.preventDefault(),f.length||(f=d.hasClass("alert")?d:d.parent()),f.trigger(b=a.Event("close.bs.alert")),b.isDefaultPrevented()||(f.removeClass("in"),a.support.transition&&f.hasClass("fade")?f.one("bsTransitionEnd",c).emulateTransitionEnd(150):c())};var e=a.fn.alert;a.fn.alert=b,a.fn.alert.Constructor=d,a.fn.alert.noConflict=function(){return a.fn.alert=e,this},a(document).on("click.bs.alert.data-api",c,d.prototype.close)}(jQuery),+function(a){function b(b){return this.each(function(){var d=a(this),e=d.data("bs.button"),f="object"==typeof b&&b;e||d.data("bs.button",e=new c(this,f)),"toggle"==b?e.toggle():b&&e.setState(b)})}var c=function(b,d){this.$element=a(b),this.options=a.extend({},c.DEFAULTS,d),this.isLoading=!1};c.VERSION="3.2.0",c.DEFAULTS={loadingText:"loading..."},c.prototype.setState=function(b){var c="disabled",d=this.$element,e=d.is("input")?"val":"html",f=d.data();b+="Text",null==f.resetText&&d.data("resetText",d[e]()),d[e](null==f[b]?this.options[b]:f[b]),setTimeout(a.proxy(function(){"loadingText"==b?(this.isLoading=!0,d.addClass(c).attr(c,c)):this.isLoading&&(this.isLoading=!1,d.removeClass(c).removeAttr(c))},this),0)},c.prototype.toggle=function(){var a=!0,b=this.$element.closest('[data-toggle="buttons"]');if(b.length){var c=this.$element.find("input");"radio"==c.prop("type")&&(c.prop("checked")&&this.$element.hasClass("active")?a=!1:b.find(".active").removeClass("active")),a&&c.prop("checked",!this.$element.hasClass("active")).trigger("change")}a&&this.$element.toggleClass("active")};var d=a.fn.button;a.fn.button=b,a.fn.button.Constructor=c,a.fn.button.noConflict=function(){return a.fn.button=d,this},a(document).on("click.bs.button.data-api",'[data-toggle^="button"]',function(c){var d=a(c.target);d.hasClass("btn")||(d=d.closest(".btn")),b.call(d,"toggle"),c.preventDefault()})}(jQuery),+function(a){function b(b){return this.each(function(){var d=a(this),e=d.data("bs.carousel"),f=a.extend({},c.DEFAULTS,d.data(),"object"==typeof b&&b),g="string"==typeof b?b:f.slide;e||d.data("bs.carousel",e=new c(this,f)),"number"==typeof b?e.to(b):g?e[g]():f.interval&&e.pause().cycle()})}var c=function(b,c){this.$element=a(b).on("keydown.bs.carousel",a.proxy(this.keydown,this)),this.$indicators=this.$element.find(".carousel-indicators"),this.options=c,this.paused=this.sliding=this.interval=this.$active=this.$items=null,"hover"==this.options.pause&&this.$element.on("mouseenter.bs.carousel",a.proxy(this.pause,this)).on("mouseleave.bs.carousel",a.proxy(this.cycle,this))};c.VERSION="3.2.0",c.DEFAULTS={interval:5e3,pause:"hover",wrap:!0},c.prototype.keydown=function(a){switch(a.which){case 37:this.prev();break;case 39:this.next();break;default:return}a.preventDefault()},c.prototype.cycle=function(b){return b||(this.paused=!1),this.interval&&clearInterval(this.interval),this.options.interval&&!this.paused&&(this.interval=setInterval(a.proxy(this.next,this),this.options.interval)),this},c.prototype.getItemIndex=function(a){return this.$items=a.parent().children(".item"),this.$items.index(a||this.$active)},c.prototype.to=function(b){var c=this,d=this.getItemIndex(this.$active=this.$element.find(".item.active"));return b>this.$items.length-1||0>b?void 0:this.sliding?this.$element.one("slid.bs.carousel",function(){c.to(b)}):d==b?this.pause().cycle():this.slide(b>d?"next":"prev",a(this.$items[b]))},c.prototype.pause=function(b){return b||(this.paused=!0),this.$element.find(".next, .prev").length&&a.support.transition&&(this.$element.trigger(a.support.transition.end),this.cycle(!0)),this.interval=clearInterval(this.interval),this},c.prototype.next=function(){return this.sliding?void 0:this.slide("next")},c.prototype.prev=function(){return this.sliding?void 0:this.slide("prev")},c.prototype.slide=function(b,c){var d=this.$element.find(".item.active"),e=c||d[b](),f=this.interval,g="next"==b?"left":"right",h="next"==b?"first":"last",i=this;if(!e.length){if(!this.options.wrap)return;e=this.$element.find(".item")[h]()}if(e.hasClass("active"))return this.sliding=!1;var j=e[0],k=a.Event("slide.bs.carousel",{relatedTarget:j,direction:g});if(this.$element.trigger(k),!k.isDefaultPrevented()){if(this.sliding=!0,f&&this.pause(),this.$indicators.length){this.$indicators.find(".active").removeClass("active");var l=a(this.$indicators.children()[this.getItemIndex(e)]);l&&l.addClass("active")}var m=a.Event("slid.bs.carousel",{relatedTarget:j,direction:g});return a.support.transition&&this.$element.hasClass("slide")?(e.addClass(b),e[0].offsetWidth,d.addClass(g),e.addClass(g),d.one("bsTransitionEnd",function(){e.removeClass([b,g].join(" ")).addClass("active"),d.removeClass(["active",g].join(" ")),i.sliding=!1,setTimeout(function(){i.$element.trigger(m)},0)}).emulateTransitionEnd(1e3*d.css("transition-duration").slice(0,-1))):(d.removeClass("active"),e.addClass("active"),this.sliding=!1,this.$element.trigger(m)),f&&this.cycle(),this}};var d=a.fn.carousel;a.fn.carousel=b,a.fn.carousel.Constructor=c,a.fn.carousel.noConflict=function(){return a.fn.carousel=d,this},a(document).on("click.bs.carousel.data-api","[data-slide], [data-slide-to]",function(c){var d,e=a(this),f=a(e.attr("data-target")||(d=e.attr("href"))&&d.replace(/.*(?=#[^\s]+$)/,""));if(f.hasClass("carousel")){var g=a.extend({},f.data(),e.data()),h=e.attr("data-slide-to");h&&(g.interval=!1),b.call(f,g),h&&f.data("bs.carousel").to(h),c.preventDefault()}}),a(window).on("load",function(){a('[data-ride="carousel"]').each(function(){var c=a(this);b.call(c,c.data())})})}(jQuery),+function(a){function b(b){b&&3===b.which||(a(e).remove(),a(f).each(function(){var d=c(a(this)),e={relatedTarget:this};d.hasClass("open")&&(d.trigger(b=a.Event("hide.bs.dropdown",e)),b.isDefaultPrevented()||d.removeClass("open").trigger("hidden.bs.dropdown",e))}))}function c(b){var c=b.attr("data-target");c||(c=b.attr("href"),c=c&&/#[A-Za-z]/.test(c)&&c.replace(/.*(?=#[^\s]*$)/,""));var d=c&&a(c);return d&&d.length?d:b.parent()}function d(b){return this.each(function(){var c=a(this),d=c.data("bs.dropdown");d||c.data("bs.dropdown",d=new g(this)),"string"==typeof b&&d[b].call(c)})}var e=".dropdown-backdrop",f='[data-toggle="dropdown"]',g=function(b){a(b).on("click.bs.dropdown",this.toggle)};g.VERSION="3.2.0",g.prototype.toggle=function(d){var e=a(this);if(!e.is(".disabled, :disabled")){var f=c(e),g=f.hasClass("open");if(b(),!g){"ontouchstart"in document.documentElement&&!f.closest(".navbar-nav").length&&a('<div class="dropdown-backdrop"/>').insertAfter(a(this)).on("click",b);var h={relatedTarget:this};if(f.trigger(d=a.Event("show.bs.dropdown",h)),d.isDefaultPrevented())return;e.trigger("focus"),f.toggleClass("open").trigger("shown.bs.dropdown",h)}return!1}},g.prototype.keydown=function(b){if(/(38|40|27)/.test(b.keyCode)){var d=a(this);if(b.preventDefault(),b.stopPropagation(),!d.is(".disabled, :disabled")){var e=c(d),g=e.hasClass("open");if(!g||g&&27==b.keyCode)return 27==b.which&&e.find(f).trigger("focus"),d.trigger("click");var h=" li:not(.divider):visible a",i=e.find('[role="menu"]'+h+', [role="listbox"]'+h);if(i.length){var j=i.index(i.filter(":focus"));38==b.keyCode&&j>0&&j--,40==b.keyCode&&j<i.length-1&&j++,~j||(j=0),i.eq(j).trigger("focus")}}}};var h=a.fn.dropdown;a.fn.dropdown=d,a.fn.dropdown.Constructor=g,a.fn.dropdown.noConflict=function(){return a.fn.dropdown=h,this},a(document).on("click.bs.dropdown.data-api",b).on("click.bs.dropdown.data-api",".dropdown form",function(a){a.stopPropagation()}).on("click.bs.dropdown.data-api",f,g.prototype.toggle).on("keydown.bs.dropdown.data-api",f+', [role="menu"], [role="listbox"]',g.prototype.keydown)}(jQuery),+function(a){function b(b,d){return this.each(function(){var e=a(this),f=e.data("bs.modal"),g=a.extend({},c.DEFAULTS,e.data(),"object"==typeof b&&b);f||e.data("bs.modal",f=new c(this,g)),"string"==typeof b?f[b](d):g.show&&f.show(d)})}var c=function(b,c){this.options=c,this.$body=a(document.body),this.$element=a(b),this.$backdrop=this.isShown=null,this.scrollbarWidth=0,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,a.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};c.VERSION="3.2.0",c.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},c.prototype.toggle=function(a){return this.isShown?this.hide():this.show(a)},c.prototype.show=function(b){var c=this,d=a.Event("show.bs.modal",{relatedTarget:b});this.$element.trigger(d),this.isShown||d.isDefaultPrevented()||(this.isShown=!0,this.checkScrollbar(),this.$body.addClass("modal-open"),this.setScrollbar(),this.escape(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',a.proxy(this.hide,this)),this.backdrop(function(){var d=a.support.transition&&c.$element.hasClass("fade");c.$element.parent().length||c.$element.appendTo(c.$body),c.$element.show().scrollTop(0),d&&c.$element[0].offsetWidth,c.$element.addClass("in").attr("aria-hidden",!1),c.enforceFocus();var e=a.Event("shown.bs.modal",{relatedTarget:b});d?c.$element.find(".modal-dialog").one("bsTransitionEnd",function(){c.$element.trigger("focus").trigger(e)}).emulateTransitionEnd(300):c.$element.trigger("focus").trigger(e)}))},c.prototype.hide=function(b){b&&b.preventDefault(),b=a.Event("hide.bs.modal"),this.$element.trigger(b),this.isShown&&!b.isDefaultPrevented()&&(this.isShown=!1,this.$body.removeClass("modal-open"),this.resetScrollbar(),this.escape(),a(document).off("focusin.bs.modal"),this.$element.removeClass("in").attr("aria-hidden",!0).off("click.dismiss.bs.modal"),a.support.transition&&this.$element.hasClass("fade")?this.$element.one("bsTransitionEnd",a.proxy(this.hideModal,this)).emulateTransitionEnd(300):this.hideModal())},c.prototype.enforceFocus=function(){a(document).off("focusin.bs.modal").on("focusin.bs.modal",a.proxy(function(a){this.$element[0]===a.target||this.$element.has(a.target).length||this.$element.trigger("focus")},this))},c.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.bs.modal",a.proxy(function(a){27==a.which&&this.hide()},this)):this.isShown||this.$element.off("keyup.dismiss.bs.modal")},c.prototype.hideModal=function(){var a=this;this.$element.hide(),this.backdrop(function(){a.$element.trigger("hidden.bs.modal")})},c.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},c.prototype.backdrop=function(b){var c=this,d=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var e=a.support.transition&&d;if(this.$backdrop=a('<div class="modal-backdrop '+d+'" />').appendTo(this.$body),this.$element.on("click.dismiss.bs.modal",a.proxy(function(a){a.target===a.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus.call(this.$element[0]):this.hide.call(this))},this)),e&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!b)return;e?this.$backdrop.one("bsTransitionEnd",b).emulateTransitionEnd(150):b()}else if(!this.isShown&&this.$backdrop){this.$backdrop.removeClass("in");var f=function(){c.removeBackdrop(),b&&b()};a.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one("bsTransitionEnd",f).emulateTransitionEnd(150):f()}else b&&b()},c.prototype.checkScrollbar=function(){document.body.clientWidth>=window.innerWidth||(this.scrollbarWidth=this.scrollbarWidth||this.measureScrollbar())},c.prototype.setScrollbar=function(){var a=parseInt(this.$body.css("padding-right")||0,10);this.scrollbarWidth&&this.$body.css("padding-right",a+this.scrollbarWidth)},c.prototype.resetScrollbar=function(){this.$body.css("padding-right","")},c.prototype.measureScrollbar=function(){var a=document.createElement("div");a.className="modal-scrollbar-measure",this.$body.append(a);var b=a.offsetWidth-a.clientWidth;return this.$body[0].removeChild(a),b};var d=a.fn.modal;a.fn.modal=b,a.fn.modal.Constructor=c,a.fn.modal.noConflict=function(){return a.fn.modal=d,this},a(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(c){var d=a(this),e=d.attr("href"),f=a(d.attr("data-target")||e&&e.replace(/.*(?=#[^\s]+$)/,"")),g=f.data("bs.modal")?"toggle":a.extend({remote:!/#/.test(e)&&e},f.data(),d.data());d.is("a")&&c.preventDefault(),f.one("show.bs.modal",function(a){a.isDefaultPrevented()||f.one("hidden.bs.modal",function(){d.is(":visible")&&d.trigger("focus")})}),b.call(f,g,this)})}(jQuery),+function(a){function b(b){return this.each(function(){var d=a(this),e=d.data("bs.tooltip"),f="object"==typeof b&&b;(e||"destroy"!=b)&&(e||d.data("bs.tooltip",e=new c(this,f)),"string"==typeof b&&e[b]())})}var c=function(a,b){this.type=this.options=this.enabled=this.timeout=this.hoverState=this.$element=null,this.init("tooltip",a,b)};c.VERSION="3.2.0",c.DEFAULTS={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:!1,container:!1,viewport:{selector:"body",padding:0}},c.prototype.init=function(b,c,d){this.enabled=!0,this.type=b,this.$element=a(c),this.options=this.getOptions(d),this.$viewport=this.options.viewport&&a(this.options.viewport.selector||this.options.viewport);for(var e=this.options.trigger.split(" "),f=e.length;f--;){var g=e[f];if("click"==g)this.$element.on("click."+this.type,this.options.selector,a.proxy(this.toggle,this));else if("manual"!=g){var h="hover"==g?"mouseenter":"focusin",i="hover"==g?"mouseleave":"focusout";this.$element.on(h+"."+this.type,this.options.selector,a.proxy(this.enter,this)),this.$element.on(i+"."+this.type,this.options.selector,a.proxy(this.leave,this))}}this.options.selector?this._options=a.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},c.prototype.getDefaults=function(){return c.DEFAULTS},c.prototype.getOptions=function(b){return b=a.extend({},this.getDefaults(),this.$element.data(),b),b.delay&&"number"==typeof b.delay&&(b.delay={show:b.delay,hide:b.delay}),b},c.prototype.getDelegateOptions=function(){var b={},c=this.getDefaults();return this._options&&a.each(this._options,function(a,d){c[a]!=d&&(b[a]=d)}),b},c.prototype.enter=function(b){var c=b instanceof this.constructor?b:a(b.currentTarget).data("bs."+this.type);return c||(c=new this.constructor(b.currentTarget,this.getDelegateOptions()),a(b.currentTarget).data("bs."+this.type,c)),clearTimeout(c.timeout),c.hoverState="in",c.options.delay&&c.options.delay.show?void(c.timeout=setTimeout(function(){"in"==c.hoverState&&c.show()},c.options.delay.show)):c.show()},c.prototype.leave=function(b){var c=b instanceof this.constructor?b:a(b.currentTarget).data("bs."+this.type);return c||(c=new this.constructor(b.currentTarget,this.getDelegateOptions()),a(b.currentTarget).data("bs."+this.type,c)),clearTimeout(c.timeout),c.hoverState="out",c.options.delay&&c.options.delay.hide?void(c.timeout=setTimeout(function(){"out"==c.hoverState&&c.hide()},c.options.delay.hide)):c.hide()},c.prototype.show=function(){var b=a.Event("show.bs."+this.type);if(this.hasContent()&&this.enabled){this.$element.trigger(b);var c=a.contains(document.documentElement,this.$element[0]);if(b.isDefaultPrevented()||!c)return;var d=this,e=this.tip(),f=this.getUID(this.type);this.setContent(),e.attr("id",f),this.$element.attr("aria-describedby",f),this.options.animation&&e.addClass("fade");var g="function"==typeof this.options.placement?this.options.placement.call(this,e[0],this.$element[0]):this.options.placement,h=/\s?auto?\s?/i,i=h.test(g);i&&(g=g.replace(h,"")||"top"),e.detach().css({top:0,left:0,display:"block"}).addClass(g).data("bs."+this.type,this),this.options.container?e.appendTo(this.options.container):e.insertAfter(this.$element);var j=this.getPosition(),k=e[0].offsetWidth,l=e[0].offsetHeight;if(i){var m=g,n=this.$element.parent(),o=this.getPosition(n);g="bottom"==g&&j.top+j.height+l-o.scroll>o.height?"top":"top"==g&&j.top-o.scroll-l<0?"bottom":"right"==g&&j.right+k>o.width?"left":"left"==g&&j.left-k<o.left?"right":g,e.removeClass(m).addClass(g)}var p=this.getCalculatedOffset(g,j,k,l);this.applyPlacement(p,g);var q=function(){d.$element.trigger("shown.bs."+d.type),d.hoverState=null};a.support.transition&&this.$tip.hasClass("fade")?e.one("bsTransitionEnd",q).emulateTransitionEnd(150):q()}},c.prototype.applyPlacement=function(b,c){var d=this.tip(),e=d[0].offsetWidth,f=d[0].offsetHeight,g=parseInt(d.css("margin-top"),10),h=parseInt(d.css("margin-left"),10);isNaN(g)&&(g=0),isNaN(h)&&(h=0),b.top=b.top+g,b.left=b.left+h,a.offset.setOffset(d[0],a.extend({using:function(a){d.css({top:Math.round(a.top),left:Math.round(a.left)})}},b),0),d.addClass("in");var i=d[0].offsetWidth,j=d[0].offsetHeight;"top"==c&&j!=f&&(b.top=b.top+f-j);var k=this.getViewportAdjustedDelta(c,b,i,j);k.left?b.left+=k.left:b.top+=k.top;var l=k.left?2*k.left-e+i:2*k.top-f+j,m=k.left?"left":"top",n=k.left?"offsetWidth":"offsetHeight";d.offset(b),this.replaceArrow(l,d[0][n],m)},c.prototype.replaceArrow=function(a,b,c){this.arrow().css(c,a?50*(1-a/b)+"%":"")},c.prototype.setContent=function(){var a=this.tip(),b=this.getTitle();a.find(".tooltip-inner")[this.options.html?"html":"text"](b),a.removeClass("fade in top bottom left right")},c.prototype.hide=function(){function b(){"in"!=c.hoverState&&d.detach(),c.$element.trigger("hidden.bs."+c.type)}var c=this,d=this.tip(),e=a.Event("hide.bs."+this.type);return this.$element.removeAttr("aria-describedby"),this.$element.trigger(e),e.isDefaultPrevented()?void 0:(d.removeClass("in"),a.support.transition&&this.$tip.hasClass("fade")?d.one("bsTransitionEnd",b).emulateTransitionEnd(150):b(),this.hoverState=null,this)},c.prototype.fixTitle=function(){var a=this.$element;(a.attr("title")||"string"!=typeof a.attr("data-original-title"))&&a.attr("data-original-title",a.attr("title")||"").attr("title","")},c.prototype.hasContent=function(){return this.getTitle()},c.prototype.getPosition=function(b){b=b||this.$element;var c=b[0],d="BODY"==c.tagName;return a.extend({},"function"==typeof c.getBoundingClientRect?c.getBoundingClientRect():null,{scroll:d?document.documentElement.scrollTop||document.body.scrollTop:b.scrollTop(),width:d?a(window).width():b.outerWidth(),height:d?a(window).height():b.outerHeight()},d?{top:0,left:0}:b.offset())},c.prototype.getCalculatedOffset=function(a,b,c,d){return"bottom"==a?{top:b.top+b.height,left:b.left+b.width/2-c/2}:"top"==a?{top:b.top-d,left:b.left+b.width/2-c/2}:"left"==a?{top:b.top+b.height/2-d/2,left:b.left-c}:{top:b.top+b.height/2-d/2,left:b.left+b.width}},c.prototype.getViewportAdjustedDelta=function(a,b,c,d){var e={top:0,left:0};if(!this.$viewport)return e;var f=this.options.viewport&&this.options.viewport.padding||0,g=this.getPosition(this.$viewport);if(/right|left/.test(a)){var h=b.top-f-g.scroll,i=b.top+f-g.scroll+d;h<g.top?e.top=g.top-h:i>g.top+g.height&&(e.top=g.top+g.height-i)}else{var j=b.left-f,k=b.left+f+c;j<g.left?e.left=g.left-j:k>g.width&&(e.left=g.left+g.width-k)}return e},c.prototype.getTitle=function(){var a,b=this.$element,c=this.options;return a=b.attr("data-original-title")||("function"==typeof c.title?c.title.call(b[0]):c.title)},c.prototype.getUID=function(a){do a+=~~(1e6*Math.random());while(document.getElementById(a));return a},c.prototype.tip=function(){return this.$tip=this.$tip||a(this.options.template)},c.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")},c.prototype.validate=function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},c.prototype.enable=function(){this.enabled=!0},c.prototype.disable=function(){this.enabled=!1},c.prototype.toggleEnabled=function(){this.enabled=!this.enabled},c.prototype.toggle=function(b){var c=this;b&&(c=a(b.currentTarget).data("bs."+this.type),c||(c=new this.constructor(b.currentTarget,this.getDelegateOptions()),a(b.currentTarget).data("bs."+this.type,c))),c.tip().hasClass("in")?c.leave(c):c.enter(c)},c.prototype.destroy=function(){clearTimeout(this.timeout),this.hide().$element.off("."+this.type).removeData("bs."+this.type)};var d=a.fn.tooltip;a.fn.tooltip=b,a.fn.tooltip.Constructor=c,a.fn.tooltip.noConflict=function(){return a.fn.tooltip=d,this}}(jQuery),+function(a){function b(b){return this.each(function(){var d=a(this),e=d.data("bs.popover"),f="object"==typeof b&&b;(e||"destroy"!=b)&&(e||d.data("bs.popover",e=new c(this,f)),"string"==typeof b&&e[b]())})}var c=function(a,b){this.init("popover",a,b)};if(!a.fn.tooltip)throw new Error("Popover requires tooltip.js");c.VERSION="3.2.0",c.DEFAULTS=a.extend({},a.fn.tooltip.Constructor.DEFAULTS,{placement:"right",trigger:"click",content:"",template:'<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}),c.prototype=a.extend({},a.fn.tooltip.Constructor.prototype),c.prototype.constructor=c,c.prototype.getDefaults=function(){return c.DEFAULTS},c.prototype.setContent=function(){var a=this.tip(),b=this.getTitle(),c=this.getContent();a.find(".popover-title")[this.options.html?"html":"text"](b),a.find(".popover-content").empty()[this.options.html?"string"==typeof c?"html":"append":"text"](c),a.removeClass("fade top bottom left right in"),a.find(".popover-title").html()||a.find(".popover-title").hide()},c.prototype.hasContent=function(){return this.getTitle()||this.getContent()},c.prototype.getContent=function(){var a=this.$element,b=this.options;return a.attr("data-content")||("function"==typeof b.content?b.content.call(a[0]):b.content)},c.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".arrow")},c.prototype.tip=function(){return this.$tip||(this.$tip=a(this.options.template)),this.$tip};var d=a.fn.popover;a.fn.popover=b,a.fn.popover.Constructor=c,a.fn.popover.noConflict=function(){return a.fn.popover=d,this}}(jQuery),+function(a){function b(b){return this.each(function(){var d=a(this),e=d.data("bs.tab");e||d.data("bs.tab",e=new c(this)),"string"==typeof b&&e[b]()})}var c=function(b){this.element=a(b)};c.VERSION="3.2.0",c.prototype.show=function(){var b=this.element,c=b.closest("ul:not(.dropdown-menu)"),d=b.data("target");if(d||(d=b.attr("href"),d=d&&d.replace(/.*(?=#[^\s]*$)/,"")),!b.parent("li").hasClass("active")){var e=c.find(".active:last a")[0],f=a.Event("show.bs.tab",{relatedTarget:e});if(b.trigger(f),!f.isDefaultPrevented()){var g=a(d);this.activate(b.closest("li"),c),this.activate(g,g.parent(),function(){b.trigger({type:"shown.bs.tab",relatedTarget:e})})}}},c.prototype.activate=function(b,c,d){function e(){f.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),b.addClass("active"),g?(b[0].offsetWidth,b.addClass("in")):b.removeClass("fade"),b.parent(".dropdown-menu")&&b.closest("li.dropdown").addClass("active"),d&&d()}var f=c.find("> .active"),g=d&&a.support.transition&&f.hasClass("fade");g?f.one("bsTransitionEnd",e).emulateTransitionEnd(150):e(),f.removeClass("in")};var d=a.fn.tab;a.fn.tab=b,a.fn.tab.Constructor=c,a.fn.tab.noConflict=function(){return a.fn.tab=d,this},a(document).on("click.bs.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(c){c.preventDefault(),b.call(a(this),"show")})}(jQuery),+function(a){function b(b){return this.each(function(){var d=a(this),e=d.data("bs.affix"),f="object"==typeof b&&b;e||d.data("bs.affix",e=new c(this,f)),"string"==typeof b&&e[b]()})}var c=function(b,d){this.options=a.extend({},c.DEFAULTS,d),this.$target=a(this.options.target).on("scroll.bs.affix.data-api",a.proxy(this.checkPosition,this)).on("click.bs.affix.data-api",a.proxy(this.checkPositionWithEventLoop,this)),this.$element=a(b),this.affixed=this.unpin=this.pinnedOffset=null,this.checkPosition()};c.VERSION="3.2.0",c.RESET="affix affix-top affix-bottom",c.DEFAULTS={offset:0,target:window},c.prototype.getPinnedOffset=function(){if(this.pinnedOffset)return this.pinnedOffset;this.$element.removeClass(c.RESET).addClass("affix");var a=this.$target.scrollTop(),b=this.$element.offset();return this.pinnedOffset=b.top-a},c.prototype.checkPositionWithEventLoop=function(){setTimeout(a.proxy(this.checkPosition,this),1)},c.prototype.checkPosition=function(){if(this.$element.is(":visible")){var b=a(document).height(),d=this.$target.scrollTop(),e=this.$element.offset(),f=this.options.offset,g=f.top,h=f.bottom;"object"!=typeof f&&(h=g=f),"function"==typeof g&&(g=f.top(this.$element)),"function"==typeof h&&(h=f.bottom(this.$element));var i=null!=this.unpin&&d+this.unpin<=e.top?!1:null!=h&&e.top+this.$element.height()>=b-h?"bottom":null!=g&&g>=d?"top":!1;if(this.affixed!==i){null!=this.unpin&&this.$element.css("top","");var j="affix"+(i?"-"+i:""),k=a.Event(j+".bs.affix");this.$element.trigger(k),k.isDefaultPrevented()||(this.affixed=i,this.unpin="bottom"==i?this.getPinnedOffset():null,this.$element.removeClass(c.RESET).addClass(j).trigger(a.Event(j.replace("affix","affixed"))),"bottom"==i&&this.$element.offset({top:b-this.$element.height()-h}))}}};var d=a.fn.affix;a.fn.affix=b,a.fn.affix.Constructor=c,a.fn.affix.noConflict=function(){return a.fn.affix=d,this},a(window).on("load",function(){a('[data-spy="affix"]').each(function(){var c=a(this),d=c.data();d.offset=d.offset||{},d.offsetBottom&&(d.offset.bottom=d.offsetBottom),d.offsetTop&&(d.offset.top=d.offsetTop),b.call(c,d)})})}(jQuery),+function(a){function b(b){return this.each(function(){var d=a(this),e=d.data("bs.collapse"),f=a.extend({},c.DEFAULTS,d.data(),"object"==typeof b&&b);!e&&f.toggle&&"show"==b&&(b=!b),e||d.data("bs.collapse",e=new c(this,f)),"string"==typeof b&&e[b]()})}var c=function(b,d){this.$element=a(b),this.options=a.extend({},c.DEFAULTS,d),this.transitioning=null,this.options.parent&&(this.$parent=a(this.options.parent)),this.options.toggle&&this.toggle()};c.VERSION="3.2.0",c.DEFAULTS={toggle:!0},c.prototype.dimension=function(){var a=this.$element.hasClass("width");return a?"width":"height"},c.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var c=a.Event("show.bs.collapse");if(this.$element.trigger(c),!c.isDefaultPrevented()){var d=this.$parent&&this.$parent.find("> .panel > .in");if(d&&d.length){var e=d.data("bs.collapse");if(e&&e.transitioning)return;b.call(d,"hide"),e||d.data("bs.collapse",null)}var f=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[f](0),this.transitioning=1;var g=function(){this.$element.removeClass("collapsing").addClass("collapse in")[f](""),this.transitioning=0,this.$element.trigger("shown.bs.collapse")};if(!a.support.transition)return g.call(this);var h=a.camelCase(["scroll",f].join("-"));this.$element.one("bsTransitionEnd",a.proxy(g,this)).emulateTransitionEnd(350)[f](this.$element[0][h])}}},c.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var b=a.Event("hide.bs.collapse");if(this.$element.trigger(b),!b.isDefaultPrevented()){var c=this.dimension();this.$element[c](this.$element[c]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse").removeClass("in"),this.transitioning=1;var d=function(){this.transitioning=0,this.$element.trigger("hidden.bs.collapse").removeClass("collapsing").addClass("collapse")};return a.support.transition?void this.$element[c](0).one("bsTransitionEnd",a.proxy(d,this)).emulateTransitionEnd(350):d.call(this)}}},c.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()};var d=a.fn.collapse;a.fn.collapse=b,a.fn.collapse.Constructor=c,a.fn.collapse.noConflict=function(){return a.fn.collapse=d,this},a(document).on("click.bs.collapse.data-api",'[data-toggle="collapse"]',function(c){var d,e=a(this),f=e.attr("data-target")||c.preventDefault()||(d=e.attr("href"))&&d.replace(/.*(?=#[^\s]+$)/,""),g=a(f),h=g.data("bs.collapse"),i=h?"toggle":e.data(),j=e.attr("data-parent"),k=j&&a(j);h&&h.transitioning||(k&&k.find('[data-toggle="collapse"][data-parent="'+j+'"]').not(e).addClass("collapsed"),e[g.hasClass("in")?"addClass":"removeClass"]("collapsed")),b.call(g,i)})}(jQuery),+function(a){function b(c,d){var e=a.proxy(this.process,this);this.$body=a("body"),this.$scrollElement=a(a(c).is("body")?window:c),this.options=a.extend({},b.DEFAULTS,d),this.selector=(this.options.target||"")+" .nav li > a",this.offsets=[],this.targets=[],this.activeTarget=null,this.scrollHeight=0,this.$scrollElement.on("scroll.bs.scrollspy",e),this.refresh(),this.process()}function c(c){return this.each(function(){var d=a(this),e=d.data("bs.scrollspy"),f="object"==typeof c&&c;e||d.data("bs.scrollspy",e=new b(this,f)),"string"==typeof c&&e[c]()})}b.VERSION="3.2.0",b.DEFAULTS={offset:10},b.prototype.getScrollHeight=function(){return this.$scrollElement[0].scrollHeight||Math.max(this.$body[0].scrollHeight,document.documentElement.scrollHeight)},b.prototype.refresh=function(){var b="offset",c=0;a.isWindow(this.$scrollElement[0])||(b="position",c=this.$scrollElement.scrollTop()),this.offsets=[],this.targets=[],this.scrollHeight=this.getScrollHeight();var d=this;this.$body.find(this.selector).map(function(){var d=a(this),e=d.data("target")||d.attr("href"),f=/^#./.test(e)&&a(e);
return f&&f.length&&f.is(":visible")&&[[f[b]().top+c,e]]||null}).sort(function(a,b){return a[0]-b[0]}).each(function(){d.offsets.push(this[0]),d.targets.push(this[1])})},b.prototype.process=function(){var a,b=this.$scrollElement.scrollTop()+this.options.offset,c=this.getScrollHeight(),d=this.options.offset+c-this.$scrollElement.height(),e=this.offsets,f=this.targets,g=this.activeTarget;if(this.scrollHeight!=c&&this.refresh(),b>=d)return g!=(a=f[f.length-1])&&this.activate(a);if(g&&b<=e[0])return g!=(a=f[0])&&this.activate(a);for(a=e.length;a--;)g!=f[a]&&b>=e[a]&&(!e[a+1]||b<=e[a+1])&&this.activate(f[a])},b.prototype.activate=function(b){this.activeTarget=b,a(this.selector).parentsUntil(this.options.target,".active").removeClass("active");var c=this.selector+'[data-target="'+b+'"],'+this.selector+'[href="'+b+'"]',d=a(c).parents("li").addClass("active");d.parent(".dropdown-menu").length&&(d=d.closest("li.dropdown").addClass("active")),d.trigger("activate.bs.scrollspy")};var d=a.fn.scrollspy;a.fn.scrollspy=c,a.fn.scrollspy.Constructor=b,a.fn.scrollspy.noConflict=function(){return a.fn.scrollspy=d,this},a(window).on("load.bs.scrollspy.data-api",function(){a('[data-spy="scroll"]').each(function(){var b=a(this);c.call(b,b.data())})})}(jQuery),+function(a){function b(){var a=document.createElement("bootstrap"),b={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var c in b)if(void 0!==a.style[c])return{end:b[c]};return!1}a.fn.emulateTransitionEnd=function(b){var c=!1,d=this;a(this).one("bsTransitionEnd",function(){c=!0});var e=function(){c||a(d).trigger(a.support.transition.end)};return setTimeout(e,b),this},a(function(){a.support.transition=b(),a.support.transition&&(a.event.special.bsTransitionEnd={bindType:a.support.transition.end,delegateType:a.support.transition.end,handle:function(b){return a(b.target).is(this)?b.handleObj.handler.apply(this,arguments):void 0}})})}($)}),define("app/document/File",["exoskeleton-master/exoskeleton","jquery/jquery","app/editor/UndoManager","app/document/StringUtils","app/document/Node","app/document/Node","app/editor/polyfill","app/window/FileHelper","app/editor/EditHelper","app/window/FileInfoPanel","app/editor/KeyMaster"],function(a,b,c){"use strict";function d(a){t.editor.stylize.putBookmark(null,t.editor.stylize.buildBookmark());var b=t.editor.styleBookmark.style,c=(t.editor.stylize.CONST.NormalBlockMap[b.block[0]],t.editor.stylize.CONST.NoInline.indexOf(b.block[0])>-1);b.block[0]==j.def_footnote&&(c=c||t.editor.stylize.isAtFootnoteDefSpan()),c=c||!b.inline.indexOf(j.inline_math),["Strong","Emphasis","Underline","Code","Strike","Hyperlink","Image","Clear Format","Inline Math","Highlight","Subscript","Superscript","Comment"].map(function(b){var d=a.getItem(b);d&&(d.setEnabled(!t.isLocked&&!c),d.setState(!1))});var d;(d=a.getItem("Inline Math"))&&d.setHidden(!t.option.enableInlineMath),(d=a.getItem("Highlight"))&&d.setHidden(!t.option.enableHighlight),(d=a.getItem("Subscript"))&&d.setHidden(!t.option.enableSubscript),(d=a.getItem("Superscript"))&&d.setHidden(!t.option.enableSuperscript);var e=["image","strong","em","link"];(t.editor.styleBookmark.style.inline||[]).map(function(b){var c=a.getItem(t.editor.stylize.CONST.StyleToNameMap[b]);c&&c.setState(!0),t.isMac&&o.touchBar&&(e.remove(b),o.touchBar.setStateForInline(!0,t.editor.stylize.CONST.StyleToNameMap[b]))}),t.isMac&&o.touchBar&&(o.touchBar.setInlineEnabled(!c),c||e.map(function(a){o.touchBar.setStateForInline(!1,t.editor.stylize.CONST.StyleToNameMap[a])}))}function e(a){function b(){try{return t.editor.getMarkElem(window.getSelection().getRangeAt(0).startContainer).attr("mdtype")==h.TYPE.meta_block}catch(a){}return!1}function c(a){return a[0]==j.line?j.paragraph:a[0]==j.table_cell?j.table:a[0]}t.editor.stylize.putBookmark(null,t.editor.stylize.buildBookmark());var d=t.editor.styleBookmark.style,e=t.editor.stylize.CONST.NormalBlockMap[d.block[0]];["Heading 1","Heading 2","Heading 3","Heading 4","Heading 5","Heading 6","Paragraph","Decrease Heading Level","Increase Heading Level","Link Reference","Footnotes","YAML Front Matter","Table","Horizontal Line","Code Fences","Quote","Ordered List","Unordered List","Task List","Math Block","Table of Contents"].map(function(b){var c=a.getItem(b);try{c&&(c.setEnabled(!t.isLocked&&d.block.length>0&&void 0!=e),c.setState(!1))}catch(f){console.error(f),console.error(b)}}),b()?a.getItem("Paragraph").setEnabled(!0):["Paragraph","Quote","Ordered List","Unordered List","Task List"].map(function(b){a.getItem(b).setEnabled(!0)});var f=null,g=!1;(t.editor.styleBookmark.style.block||[]).map(function(b){var c=a.getItem(t.editor.stylize.CONST.StyleToNameMap[b]);c&&c.setState(!0),!f&&i.isType(b,"ol","ul","tasklist")&&(f=b),b==j.blockquote&&(g=!0)}),t.isMac&&o.touchBar&&($("#md-searchpanel").is(":visible")?o.touchBar.showFindReplaceTouchBar():document.body.classList.contains("modal-open")?$("#table-insert-dialog:visible").length?o.touchBar.showInsertTableTouchBar():o.touchBar.showDialogTouchBar():o.touchBar.setBlockStyle({blockStyle:t.editor.stylize.CONST.StyleToNameMap[c(d.block)]||"",listType:f,underQuote:g,fallbackOnly:!e}))}function f(a){a&&(a.getItem("Source Code Mode").setState(t.editor.sourceView.inSourceMode),a.getItem("Source Code Mode").setEnabled(!t.isLocked),a.getItem("Always On Top").setState(t.isMac?o.window.isAlwaysOnTop():n.getCurrentWindow().isAlwaysOnTop()),a.getItem("Focus Mode").setState(t.isFocusMode),a.getItem("Focus Mode").setEnabled(!0),a.getItem("Typewriter Mode").setState(t.isTypeWriterMode),a.getItem("Typewriter Mode").setEnabled(!0))}var g=(a("exoskeleton-master/exoskeleton"),a("app/editor/UndoManager")),h=a("app/document/Node"),i=h.Node,j=h.TYPE,k=(a("app/editor/polyfill"),a("app/window/FileHelper")),l=a("app/window/FileInfoPanel"),m=k.ChangeCounter,n=(k.ChangeType,window.reqnode?reqnode("electron").remote:null),o=n?n.app:window.app,p={indentSize:2,autoToggleEmojiAutoComplete:!0,enableInlineMath:!1,autoNumberingForMath:!1,enableHighlight:!1,enableSubscript:!1,enableSuperscript:!1,enableDiagram:!1,copyMarkdownByDefault:!1,showLineNumbersForFence:!1,showOutlinePanelByDefault:!1,useRelativePathForImg:!1,noSpellCheck:!1,autoCorrectMisspell:!1,noPairingMatch:!1,autoPairExtendSymbol:!1,noPreWrap:!1,autoSave:!1,scrollWithCursor:!1,expandSimpleBlock:!1,printPDFByPhantom:!1,allowImageMove:!0,allowImageUpload:!0,headingStyle:0,ulStyle:0,strictMarkdown:!1,preferCRLF:!1,showFileTree:!1},q=null,r=200,s=function(){q&&clearTimeout(q),q=setTimeout(function(){e(t.isNode?n.Menu.getApplicationMenu().getItem("Paragraph").submenu:o.menu.getItem("Paragraph").submenu()),d(t.isNode?n.Menu.getApplicationMenu().getItem("Format").submenu:o.menu.getItem("Format").submenu())},r)},t={option:p,readOption:function(){function a(a){return t.isMac?o.setting.getBool(a):t.isNode?o.setting.get(a):void 0}function b(a){return t.isMac?o.setting.getInteger(a):t.isNode?o.setting.get(a):void 0}function c(a,b){return void 0===a?b:a}return t.isMac||t.isNode?(t.option.autoToggleEmojiAutoComplete=c(a("trigger_emoji_autocomplete"),!0),t.option.enableInlineMath=c(a("enable_inline_math"),!0),t.option.enableHighlight=a("enable_highlight")||!1,t.option.enableSubscript=a("enable_subscript")||!1,t.option.enableSuperscript=a("enable_superscript")||!1,t.option.enableDiagram=c(a("enable_diagram"),!0),t.option.copyMarkdownByDefault=a("copy_markdown_by_default")||!1,t.option.showLineNumbersForFence=a("show_line_numbers_for_fence")||!1,t.option.noPairingMatch=a("no_pairing_match")||!1,t.option.autoPairExtendSymbol=a("match_pari_markdown")||!1,t.option.expandSimpleBlock=a("auto_expand_block")||!1,t.option.headingStyle=b("heading_style")||0,t.option.ulStyle=b("ul_style")||0,t.option.scrollWithCursor=!a("no_mid_caret"),t.option.autoNumberingForMath=a("auto_numbering_for_math"),t.option.useRelativePathForImg=a("use_relative_path_for_img")||!1,t.option.allowImageUpload=a("allow_image_upload")||!1,t.option.allowImageMove=a("allow_image_move")||!1,t.option.preferCRLF=a("line_ending_crlf")||!1,t.isMac?(t.option.indentSize=o.setting.getInteger("indentSize")||2,t.option.showOutlinePanelByDefault=o.setting.getBool("show_outline_panel_by_default")||!1):t.isNode&&(o.setting.get("useCustomFontSize")&&(document.body.parentElement.style.fontSize=o.setting.get("customFontSize")+"px"),t.option.indentSize=o.setting.get("indentSize")||2,t.option.enableAutoSave=o.setting.get("enableAutoSave")||!1,t.option.noSpellCheck=o.setting.get("no_spell_check")||!1,t.option.autoCorrectMisspell=o.setting.get("auto_correct_misspell")||!1),t.option.showLineNumbersForFence&&$("#write").addClass("show-fences-line-number"),t.setCanCollapsePinnedOutline(a("can_collapse_outline_panel")),void(t.option.passiveEvents=t.isNodeHtml)):void(window._options&&(t.option=$.extend(t.option,window._options)))},bindMenu:function(){if(t.isMac){var a=o.menu.getItem("Edit").submenu();a.getItem("Undo").setCallback(function(){t.isLocked||(editor.undo.completeSnap(!0),t.editor.undo.undo(),t.freshMenu())}),a.getItem("Redo").setCallback(function(){t.isLocked||(editor.undo.completeSnap(!0),t.editor.undo.redo(),t.freshMenu())}),a.getItem("Select All").setEnabled(!0),a.getItem("Select Line/Sentence").setCallback(function(){t.editor.selection.selectLine()}),a.getItem("Select Line/Sentence").setEnabled(!0),a.getItem("Select Styled Scope").setCallback(function(){t.editor.selection.selectPhrase()}),a.getItem("Select Styled Scope").setEnabled(!0),a.getItem("Select Word").setCallback(function(){t.editor.selection.selectWord()}),a.getItem("Select Word").setEnabled(!0),t.isMac&&a.getItem("Image Tools").submenu().setMenuWillOpen(function(){t.refreshImageCopyStatus(!1)});var b=o.menu.getItem("Paragraph").submenu();b.getItem("Heading 1").setCallback(function(){t.editor.stylize.changeBlock("header1")}),b.getItem("Heading 2").setCallback(function(){t.editor.stylize.changeBlock("header2")}),b.getItem("Heading 3").setCallback(function(){t.editor.stylize.changeBlock("header3")}),b.getItem("Heading 4").setCallback(function(){t.editor.stylize.changeBlock("header4")}),b.getItem("Heading 5").setCallback(function(){t.editor.stylize.changeBlock("header5")}),b.getItem("Heading 6").setCallback(function(){t.editor.stylize.changeBlock("header6")}),b.getItem("Paragraph").setCallback(function(){t.editor.stylize.changeBlock(j.paragraph)}),b.getItem("Footnotes").setCallback(function(){t.editor.stylize.insertBlock(j.def_footnote)}),b.getItem("Link Reference").setCallback(function(){t.editor.stylize.insertBlock(j.def_link)}),b.getItem("YAML Front Matter").setCallback(function(){t.editor.stylize.insertMetaBlock()}),b.getItem("Horizontal Line").setCallback(function(){t.editor.stylize.insertBlock(j.hr)}),b.getItem("Table").setCallback(function(){t.editor.tableEdit.insertTable()}),b.getItem("Code Fences").setCallback(function(){t.editor.stylize.insertBlock(j.fences)}),b.getItem("Quote").setCallback(function(){t.editor.stylize.toggleIndent(j.blockquote)}),b.getItem("Ordered List").setCallback(function(){t.editor.stylize.toggleIndent("ol")}),b.getItem("Unordered List").setCallback(function(){t.editor.stylize.toggleIndent("ul")}),b.getItem("Task List").setCallback(function(){t.editor.stylize.toggleIndent("tasklist")}),b.getItem("Math Block").setCallback(function(){t.editor.stylize.insertBlock(j.math_block)}),b.getItem("Table of Contents").setCallback(function(){t.editor.stylize.insertBlock(j.toc)}),b.getItem("List Indentation").submenu().getItem("Indent").setCallback(function(){t.editor.UserOp.moreIndent(t.editor)}),b.getItem("List Indentation").submenu().getItem("Outdent").setCallback(function(){t.editor.UserOp.lessIndent(t.editor)}),b.getItem("List Indentation").submenu().getItem("Indent").setEnabled(!0),b.getItem("List Indentation").submenu().getItem("Outdent").setEnabled(!0);var c,g=o.menu.getItem("Format").submenu();g.getItem("Strong").setCallback(function(){t.editor.stylize.toggleStyle(j.strong)}),g.getItem("Emphasis").setCallback(function(){t.editor.stylize.toggleStyle(j.em)}),g.getItem("Underline").setCallback(function(){t.editor.stylize.toggleStyle(j.underline)}),g.getItem("Code").setCallback(function(){t.editor.stylize.toggleStyle(j.code)}),g.getItem("Strike").setCallback(function(){t.editor.stylize.toggleStyle(j.del)}),(c=g.getItem("Inline Math"))&&(c.setHidden(!t.option.enableInlineMath),c.setCallback(function(){t.editor.stylize.toggleStyle(j.inline_math)})),(c=g.getItem("Highlight"))&&(c.setHidden(!t.option.enableHighlight),c.setCallback(function(){t.editor.stylize.toggleStyle(j.highlight)})),(c=g.getItem("Subscript"))&&(c.setHidden(!t.option.enableSubscript),c.setCallback(function(){t.editor.stylize.toggleStyle(j.subscript)})),(c=g.getItem("Superscript"))&&(c.setHidden(!t.option.enableSuperscript),c.setCallback(function(){t.editor.stylize.toggleStyle(j.superscript)})),(c=g.getItem("Comment"))&&c.setCallback(function(){t.editor.stylize.toggleStyle(j.comment)}),g.getItem("Hyperlink").setCallback(function(){t.editor.stylize.toggleStyle(j.link)}),g.getItem("Image").setCallback(function(){t.editor.stylize.toggleStyle(j.image)}),g.getItem("Clear Format").setCallback(function(){t.editor.stylize.clearStyle()}),b.setMenuWillOpen(function(){e(b);var a=b.getItem("Heading 6");a.setHidden(!a.getState())}),b.setMenuDidClose(function(){b.getItem("Heading 6").setHidden(!1)}),g.setMenuWillOpen(function(){d(g)}),e(b),d(g),t.freshMenu(),$(t.editor.sessionStr).on("cursorChange",function(){s()});var h=o.menu.getItem("View").submenu();h.setMenuWillOpen(function(){f(h),o.controller.adjustTabMenuItem()})}else if(t.isNode){var c,i=n.Menu.getApplicationMenu(),b=i.getItem("Paragraph").submenu,g=i.getItem("Format").submenu;(c=g.getItem("Inline Math"))&&c.setHidden(!t.option.enableInlineMath),(c=g.getItem("Highlight"))&&c.setHidden(!t.option.enableHighlight),(c=g.getItem("Subscript"))&&c.setHidden(!t.option.enableSubscript),(c=g.getItem("Superscript"))&&c.setHidden(!t.option.enableSuperscript),$(t.editor.sessionStr).on("cursorChange",function(){s()})}},freshMenu:function(a){function b(){function b(a,b){c.getItem(a).setEnabled(b),t.isNode&&c.getItem(a).submenu.items.forEach(function(a){a.setEnabled(b)})}if(f(e),d&&(d.getItem("Copy As HTML Code").setEnabled(!g),t.isMac?(d.getItem("Image Tools").submenu().getItem("Insert Local Images...").setEnabled(!t.isLocked),d.getItem("Image Tools").submenu().getItem("Upload Local Images via iPic").setEnabled(!t.isLocked&&!g)):d.getItem("Image Tools").submenu.getItem("Insert Local Images...").setEnabled(!t.isLocked),t.refreshImageCopyStatus(!1,t.isLocked||g)),b("Paragraph",!g),b("Format",!g),g){var h=t.editor.sourceView.cm.doc.historySize();d.getItem("Undo").setEnabled(!t.isLocked&&h.undo>0),d.getItem("Redo").setEnabled(!t.isLocked&&h.redo>0),t.isNode?window.ClientCommand.refreshViewMenu():e.getItem("Toggle Outline Panel").setEnabled(!1)}else d.getItem("Undo").setEnabled(!t.isLocked&&t.editor.undo.hasUndo()),d.getItem("Redo").setEnabled(!t.isLocked&&t.editor.undo.hasRedo()),t.isNode?window.ClientCommand.refreshViewMenu():(e.getItem("Toggle Outline Panel").setEnabled(!0),e.getItem("Always On Top").setEnabled(!0)),!t.isLocked&&$(t.editor.sessionStr).trigger("cursorChange");if(a&&t.isNode){var i=n.Menu.getApplicationMenu().getItem("File").submenu,j=i.getItem("Open File Location"),k=i.getItem("Reopen with Encoding");j.visible=!!t.filePath,k.visible=!!t.filePath}}var c,d=null,e=null,g=t.editor.sourceView.inSourceMode;if(t.isMac)c=o.menu,d=c.getItem("Edit").submenu(),e=c.getItem("View").submenu();else{if(!t.isNode)return;c=n.Menu.getApplicationMenu(),d=c.getItem("Edit").submenu,e=c.getItem("View").submenu}if(t.isNode)try{b()}catch(h){ipc.send("errorInWindow"," (caught) "+(h?h.stack:h.message))}else b()},setEditor:function(a){t.isLocked=t.isMac&&o.document.isLocked(),t.editor=a,t.isMac||(t.changeCounter=new m)},getFilePathUseNode:function(){if(t.isNode)var a=n.getCurrentWindow(),b=n.app,c=b.getDocumentController().getDocumentFromWindowId(a.id).path;return c},getContent:function(a,b){if(console.log("getContent"),t.useCRLF=t.option.preferCRLF,t.isMac)return(o.document.content||"").replace(/\r/gi,"");if(t.isNode){var c,d=a;try{if(d=a||t.getFilePathUseNode()){console.log("path: "+d);var e=reqnode("jschardet"),f=t.fs.readFileSync(d),g=b||(reqnode("is-utf8")(f)?"utf8":e.detect(f).encoding)||"utf8",h=reqnode("iconv-lite");return"ascii"==g.toLowerCase()&&(g="utf8"),h.encodingExists(g)||(g=g.replace(/-/g,"_")),g=h.encodingExists(g)?g:"utf8",console.debug("use encode: "+g),c=h.decode(f,g),t.useCRLF=c.indexOf("\r\n")>-1?!0:c.indexOf("\n")>-1?!1:t.option.preferCRLF,l.setFileTitle(d,g),c}l.setFileTitle()}catch(i){return console.trace(i),n.dialog.showErrorBox("Failed to load file",i.stack||""),l.setFileTitle(""),d&&o.getDocumentController().getDocument(d).switchToUntitled(),""}}return""},setContent:function(a){console.log("setContent"),t.isMac&&(o.document.content=a)},sync:function(a){if(t.isActiveWindow())if(t.editor.sourceView.inSourceMode){var b=t.editor.sourceView.cm.getValue();t.setContent(b),t.isMac&&a&&o.document.isDocumentEdited()&&t.editor.sourceView.onSave()}else{t.editor.undo.completeSnap(!0),t.editor.store(null,!0);try{$(".md-focus").closest(".unholdable").length||t.editor.autoRemoveUnholdable()}catch(c){console.error(c.stack)}t.setContent(t.editor.getMarkdown())}},isActiveWindow:function(){if(t.isMac)return o.controller.isActiveWindow();if(t.isNode){var a=n.getCurrentWindow();return a.id===(t.getCurrentDocByNode().activeWindow||{}).id}return!0},shouldTriggerSyncChange:function(){if(t.isMac)return o.controller.shouldTriggerSyncChange();if(t.isNode){var a=t.getCurrentDocByNode();return t.isActiveWindow()&&a.windows.size>1}},getCurrentDocByNode:function(){return o.getDocumentController().getDocumentFromWindowId(n.getCurrentWindow().id)},saveUseNode:function(a,b){if(t.isActiveWindow()){t.sync();var c=t.getFilePathUseNode();if(t.isNode){var d,e=reqnode("iconv-lite"),f=t.fileEncode||"utf8";try{d=e.encode(t.editor.getMarkdown(),f)}catch(g){console.log("swith to utf8 encode"),d=e.encode(t.editor.getMarkdown(),"utf8"),t.fileEncode="utf8"}c&&!b?(t.fs.writeFile(c,d,function(b){t.resumeFileChangeTimestamp=new Date,b&&(alert("save file failed for\n"+b.stack),console.error(b.stack)),t.getCurrentDocByNode().setLastSync(t.resumeFileChangeTimestamp-0),a&&a(b)}),t.updateChangeCount(t.ChangeType.NSChangeAutosaved),console.log("saved")):k.showSaveDialog(a||void 0)}}},updateChangeCount:function(a){if(t.editor.sourceView&&t.editor.sourceView.inSourceMode)return void(t.isMac?a==t.ChangeType.NSChangeAutosaved?(t.editor.sourceView.cm.save(),o.document.updateChangeCount(a)):a==t.ChangeType.NSChangeCleared?o.document.updateChangeCount(a):o.document.isDocumentEdited()||o.document.updateChangeCount(t.ChangeType.NSChangeDone):(t.changeCounter.updateChangeCount(a),a===t.ChangeType.NSChangeAutosaved&&l.setLastModified(new Date)));if(t.needsUpdateSnap(),t.isMac)o.document.updateChangeCount(a),o.menu.getItem("Edit").submenu().getItem("Undo").setEnabled(t.editor.undo.hasUndo()),o.menu.getItem("Edit").submenu().getItem("Redo").setEnabled(t.editor.undo.hasRedo());else if(t.changeCounter.updateChangeCount(a),a===t.ChangeType.NSChangeAutosaved?(v=!1,l.setLastModified(new Date)):v=!0,t.isNode){var b=n.Menu.getApplicationMenu().getItem("Edit").submenu;b.getItem("Undo").setEnabled(t.editor.undo.hasUndo()),b.getItem("Redo").setEnabled(t.editor.undo.hasRedo()),releasePrintWin_(),releaseCaptureWin_()}},onSwitchDocumentTarget:function(a){t.editor.brush.clearAndPause(),t.fileHasModified=!1,t.editor.focusCid=null;var b=t.editor.sourceView.inSourceMode;a&&a.nodeMap&&a.undoRedo?t.restoreEditStateFromData(a):(t.changeCounter.reset(),t.editor.undo.reset(),t.editor.nodeMap.reset(),t.editor.reset(b?"":t.getContent())),b&&t.editor.sourceView.setValue(t.getContent(),!0),$("content").scrollTop(0),!(a&&a.nodeMap)&&t.editor.undo.reset(),window.getSelection().removeAllRanges(),t.editor.brush.restart(),t.isMac&&t.editor.library.markOpenedFile(k.getCurrentFilePath()),t.freshMenu(),t.editor.brush.updateWordCount(),t.editor.refresh()},getDocumentSnap:function(){if(!t.option.showFileTree)return null;if(t.isMac)return o.document.snap;if(t.isNode){var a=t.getCurrentDocByNode();if(a)return a.snap}},restoreEditStateFromData:function(a,b,c){if(a&&a.undoRedo&&a.nodeMap&&a.timeStamp!=(t.isMac?o.controller.contentSnapRestoredTime:t.contentSnapRestoredTime)){console.debug("do restoreEditStateFromData");var d=null,e=t.editor,f=e.sourceView&&e.sourceView.inSourceMode,g=!1;if(t.editor.focusCid=null,e.nodeMap.restoreFromJson(JSON.parse(a.nodeMap)),e.undo.restoreFromJson(JSON.parse(a.undoRedo)),t.useCRLF=a.useCRLF,t.isNode&&(g=!t.getCurrentDocByNode().isSnapValid(),console.debug("stillNeedReloadFromDisk = "+g)),f)b&&(d=e.sourceView.cm.getScrollInfo().top),t.reloadContent(a.srcContent,!0,!1,!1,!0),a.srcHist&&(e.sourceView.cm.doc.clearHistory(),e.sourceView.cm.doc.setHistory(JSON.parse(a.srcHist))),a.fromSourceMode||t.reloadContent(a.content,!1,!1,!1,c||!o.document.isDocumentEdited()),b&&e.sourceView.cm.scrollTo(0,d);else if(b&&(d=$("content").scrollTop()),a.fromSourceMode?t.reloadContent(a.srcContent,!1,!1,!1,!0,c):g||($(e.sessionStr).html(h.NodeCollectionUtils.toHTML(e.nodeMap.blocks)),c||(e.focusCid=void 0,e.refresh())),b&&"object"==typeof b){try{e.undo.exeCommand(b)}catch(i){}$("content").scrollTop(d)}if(t.isMac&&(o.controller.contentSnapRestoredTime=a.timeStamp),t.isNode){if(t._needsUpdateSnap=!1,t.contentSnapRestoredTime=a.timeStamp,t.changeCounter.reset(a.changeCounter),g)return t.reloadContent(t.getContent(),!1,!1,!0,!1,c),t.updateChangeCount(t.ChangeType.NSChangeAutosaved),void(t.fileHasModified=!1);l.setFileTitle(t.filePath,a.fileEncode)}c||(t.freshMenu(),t.editor.brush.updateWordCount(),t.editor.refresh())}},needsUpdateSnap:function(){t.isMac?o.document.needsUpdateSnap():t._needsUpdateSnap=!0},backupDocumentSnap:function(){t.isMac&&o.document.backupDocumentSnap(),t.isNode&&t.buildDocumentSnap()},buildDocumentSnap:function(){function a(){var a={nodeMap:JSON.stringify(t.editor.nodeMap.storeToJson()),undoRedo:JSON.stringify(t.editor.undo.storeToJson()),timeStamp:new Date-0};return t.editor.sourceView.inSourceMode&&(a.fromSourceMode=!0,a.srcHist=JSON.stringify(t.editor.sourceView.cm.doc.getHistory())),t.isNode&&(a.fileEncode=t.fileEncode,a.changeCounter=t.changeCounter.clone(),a.useCRLF=t.useCRLF,t.contentSnapRestoredTime=a.timeStamp),t.isMac&&(o.controller.contentSnapRestoredTime=a.timeStamp),a}if(t.option.showFileTree&&(t.sync(),t.isMac&&o.document.buildDocumentSnap(a()),t.isNode)){var b;if(!t._needsUpdateSnap||!t.filePath)return;t._needsUpdateSnap=!1,b=t.getCurrentDocByNode(),b&&b.addSnap(a())}},presentedItemChanged:function(){function a(a){var b;a?(t.isMac?b=o.document.getDataFromFile(!0):t.isNode&&(b=t.getContent(t.filePath,t.fileEncode)),t.reloadContent(b,!1,!1,!0),t.updateChangeCount(t.ChangeType.NSChangeAutosaved),t.editor.sourceView.inSourceMode&&t.editor.sourceView.setValue(b),setTimeout(function(){t.setContent(b)},0)):t.updateChangeCount(t.ChangeType.NSChangeReadOtherContents)}t.isActiveWindow()&&(console.log("presentedItemChanged"),t.isNode?(t.filePath||(t.filePath=t.getFilePathUseNode(),t.fileName=k.getFileNameFromPath(path)),t.filePath&&t.fs.stat(t.filePath,function(b,c){if(c)if((t.resumeFileChangeTimestamp-0||0)+2e3<c.mtime-0){var d=t.changeCounter.isDocumentEdited()?confirm(document.getElementById("reload_confirm").innerHTML.trim()):!0;a(d)}else console.debug("presentedItemChanged ignored")})):t.isMac&&(!o.document.isDocumentEdited()||confirm("File content is changed by external applications. Reload content ?"))&&o.document.refreshContentFromDisk())},reloadWithEncoding:function(a){if(t.isNode&&t.filePath){var b=t.getContent(t.filePath,a);t.reloadContent(b),t.updateChangeCount(t.ChangeType.NSChangeCleared)}},reloadContent:function(a,b,c,d,e,f){var i,j=g.makeEmptyCommand(),k=t.editor.sourceView&&t.editor.sourceView.inSourceMode;if(k||f||(t.editor.store(),t.editor.undo.completeSnap(!0),j.undo.push(t.editor.selection.buildUndo())),t.editor.focusCid=null,j.undo.push(g.buildAllDoc(t.editor.nodeMap,d)),k&&d||(t.editor.nodeMap.reset(),i=h.Node.parseFrom(a,t.editor.nodeMap,{skips:{old_code:!1}}),i[1].map(function(a){a.set("attachTo",t.editor.nodeMap)}),j.redo.push(g.buildAllDoc(t.editor.nodeMap,d)),k?(t.editor.sourceView.renderedHTML=i[0],t.editor.undo.register(j,e)):$(t.editor.sessionStr).html(i[0])),k){var l=t.editor.sourceView.cm.getCursor();t.editor.sourceView.setValue(a,!0,d||e?"fromDisk":"begin");var m=t.editor.sourceView.cm.getInputField();return m.setSelectionRange&&m.setSelectionRange(0,0),void t.editor.sourceView.cm.setCursor(l)}if(d){var n=t.editor.undo.lastRegisteredOperationCommand(),o=n&&n.undo.last();o&&"reload"==o.type&&o.reloadFromDisk&&(j.undo=[o],t.editor.undo.removeLastRegisteredOperationCommand())}t.editor.undo.register(j,e),f||(b?(t.editor.undo.reset(),t.updateChangeCount(t.ChangeType.NSChangeAutosaved)):window.getSelection().removeAllRanges(),setTimeout(function(){t.editor.refresh()},c?500:0))},copy:function(){t.editor.UserOp.copyHandler(t.editor)},"delete":function(){"TEXTAREA"!=document.activeElement.tagName&&"INPUT"!=document.activeElement.tagName&&t.editor.UserOp.backspaceHandler(t.editor,null,"Backspace")},deleteActive:function(){var a=t.editor.getMarkElem(),b=t.editor.findNodeByElem(a),c=t.editor.UserOp.backToParagraph(editor,b,!0);t.editor.undo.register(c)},cut:function(){return t.isLocked?!1:(t.editor.refocus(void 0,!0),t.editor.snapSelection=editor.selection.buildUndo(),t.editor.UserOp.copyHandler(editor,null),void t.editor.UserOp.backspaceHandler(editor,null,"delSelection"))},pasteAsPlainText:function(){$(t.editor.sessionStr).trigger("pasteAsPlainText")},lock:function(){t.isLocked=!0,t.freshLock()},unlock:function(){t.isLocked=!1,t.freshLock()},toggleSourceMode:function(){t.editor.sourceView.inSourceMode?(t.editor.sourceView.hide(),t.outlineStatus_&&t.editor.docMenu.showOutline(!0)):(t.editor.docMenu.hideOutline(!0),t.editor.sourceView.show()),t.freshMenu()},isFocusedOnWriteDiv:function(){return $(document.activeElement).closest("#write").length>0},getExtraContext:function(a){function b(){try{if(i.isType(document.activeElement.tagName,"INPUT","TEXTAREA"))return"";var a=editor.selection.getRangy(),b=editor.getMarkElem(),c=$(".md-expand"),d=b.attr("mdtype"),e=/^file:\/\//;if(/^table/g.exec(d)&&!t.isLocked)return"table|seperator|insertParagraphBefore|insertParagraphAfter";if(i.isType(d,j.math_block))return"copyMathBlock|delete|seperator|insertParagraphBefore|insertParagraphAfter";if(i.isType(d,j.fences))return"delete-fences|insertParagraphBefore|insertParagraphAfter";if(b.attr("tabindex"))return"copy|delete|seperator|insertParagraphBefore|insertParagraphAfter";if(a&&$(a.commonAncestorContainer).closest(".md-inline-math").length)return"copyMathInline";if(i.isType(c.hasClass("md-img-loaded")&&c.attr("md-inline"),j.image)&&e.exec(c.find("img").attr("src")))return"revealInFinder";if(i.isType(c.hasClass("md-img-loaded")&&c.attr("md-inline"),j.refimg)&&e.exec(c.find("img").attr("src")))return"revealInFinder"}catch(f){}return""}if(!a)return"default";if(document.querySelector("#write").contains(a))return b();if(t.editor.sourceView.inSourceMode&&document.querySelector("#typora-source").contains(a))return"sourceMode";var c=t.editor.getJQueryElem(a),d=c.closest(".file-library-node"),e="_recent"==(t.editor.library.root||{}).path;return d.attr("data-path")==(t.editor.library.root||{}).path?"folder-root":d.length?("true"==d.attr("data-is-directory")?"folder":"file")+(e?"-recent":""):"default"},getCurBlockType:function(){try{if(document.activeElement.hasAttribute&&document.activeElement.hasAttribute("tabindex"))return $(document.activeElement).closest("[mdtype]").attr("mdtype")||"";if(rangy.getSelection().rangeCount){var a=t.editor.selection.getRangy();return $(a.commonAncestorContainer).closest("[mdtype]").attr("mdtype")||""}}catch(b){}return""},freshLock:function(a){void 0!==a&&(t.isLocked=a),$("input, selector").prop("readOnly",t.isLocked||!1),$(".CodeMirror").each(function(){this.CodeMirror&&(this.CodeMirror.options.readOnly=t.isLocked||!1)}),t.isLocked?(t.editor.tableEdit.unfocusAll(),$("[contenteditable=true]").attr("locked","true").attr("contenteditable","false"),$(t.editor.sessionStr).blur(),$(".md-expand").removeClass("md-expand")):$("[locked='true']").attr("locked","false").attr("contenteditable","true"),$("#md-searchpanel input").prop("readOnly",!1),t.freshMenu(),t.editor.sourceView.inSourceMode&&t.editor.sourceView.cm.focus(),setTimeout(function(){t.isMac&&o.touchBar&&o.touchBar.freshLock()},100)},setTheme:function(a){function b(){function a(a){var b=Number(a).toString(16).toUpperCase();return 1==b.length?"0"+b:b}function b(b,c,d){return"#"+a(b)+a(c)+a(d)}var c=window.getComputedStyle(document.body).backgroundColor.match(/\d+/gi);c.length&&(t.isMac?o.window.setBackgroundColor(c[0],c[1],c[2],c[3]||256):o.setting.put("backgroundColor",b(c[0],c[1],c[2])),t.colorBrightness=(299*c[0]+587*c[1]+114*c[2])/256e3)}var c=!0;t.colorBrightness=1;var d=function(){setTimeout(b,100),t.editor.refresh(!0),t.isFocusMode&&t.editor.updateFocusMode(!1),t.isTypeWriterMode&&(t.editor.toggleTypeWriterMode(!1),t.editor.toggleTypeWriterMode(!0))};if(t.isMac){var e=document.getElementById("theme_css"),f=e.getAttribute("href"),g=o.setting.get("currentThemeFolder")||e.href.replace(/\/([a-z-]+)\.css$/i,"");if(a=a||o.setting.get("theme")||"github",a=a.replace(/\s*([A-Z])/g,"-$1").replace(/^-/,"").toLowerCase(),o.setting.getBool("allow_custom_fontsize")){var h=(o.setting.getDouble("custom_fontsize")||16)+"";document.body.parentElement.style.fontSize=h+"px"}f!=a&&$.get(g+"/"+a+".css",function(){e.setAttribute("href",g+"/"+a+".css")}).then(function(){setTimeout(d,20)}),c&&(document.querySelector("#base_user_css").setAttribute("href",g+"/base.user.css"),document.querySelector("#theme_user_css").setAttribute("href",g+"/"+a+".user.css"))}else if(t.isNode){var i=o.setting.getCurrentTheme(),j=o.getPath("userData"),k=t.isWin?"\\":"/";$("#theme_css").attr("href",[j,"themes",i].join(k)),setTimeout(d,20),c&&(document.querySelector("#base_user_css").setAttribute("href",[j,"themes","base.user.css"].join(k)),document.querySelector("#theme_user_css").setAttribute("href",[j,"themes",i.replace(/\.css$/,".user.css")].join(k)))}},getFileName:function(a){if(t.isMac){var b=o.document.currentFilePath(),c=o.document.currentFolderPath(),d=void 0;return b&&c&&(d=b.replace(c,"").replace(/^\//g,"")),d||(a?t.getSuggestedFileName():void 0)}return t.fileName||(a?t.getSuggestedFileName():void 0)},getSuggestedFileName:function(a){if(a){var b=t.getFileName();if(b)return b.replace(/\.[^.]+$/,"")}var c,d,e=(t.editor.nodeMap.blocks,""),f="";try{d=t.editor.docMenu.getMetaNode(),d&&(f=t.editor.docMenu.getValueInMeta("date",d)||"",f=(/\d+-\d+-\d+/g.exec(f)||/\d+\/\d+\/\d+/g.exec(f)||[""])[0],e=t.editor.docMenu.getValueInMeta("title",d)||"",e=e.replace(/(^\s*("|'))|(("|')\s*)/gi,"").replace(/\s+(.)/gi,"-$1").toLocaleString(),e=data?[f,e].join("-"):e),(0==e.trim().length||"-"==e)&&(c=$($("#write h1, #write h2, #write h3")[0]),t.editor.sourceView.inSourceMode?(e=t.editor.getMarkdown(),e=e.substr(0,e.indexOf("\n"))||e,e.length>140&&(e=e.substr(0,e.indexOf("."))||e),e.length>140&&(e=e.substr(0,140))):c.length?e=t.editor.UserOp.getDisplayText(c).replace(/\r?\n/gi,""):(c=$($("[cid]:not(.md-meta-block)")[0]),e=c.length?t.editor.UserOp.getDisplayText(c):"",e=e.substr(0,e.indexOf("\n"))||e,e.length>140&&(e=e.substr(0,e.indexOf("."))||e),e.length>140&&(e=e.substr(0,140))),e.replace(/\u00A0|\n/g," "))}catch(g){}return 0==e.trim().length&&(e="Untitled"),e},setCanCollapsePinnedOutline:function(a){a?document.body.classList.remove("no-collapse-outline"):document.body.classList.add("no-collapse-outline")},refreshImageCopyStatus:function(a,b){function c(){var a,c,e,f,g=d.imgEdit.getTagetImageStorageFolder();if(t.isNode)a=n.Menu.getApplicationMenu().getItem("Edit").submenu.getItem("Image Tools"),
c=a.submenu.getItem("Use Image Root Path"),f=a.submenu.getItem("When Insert Local Image").submenu.getItem("Copy Image File to Folder..."),f.setState(!!g);else if(t.isMac){a=o.menu.getItem("Edit").submenu().getItem("Image Tools");var h=a.submenu().getItem("When Insert Local Image").submenu();c=a.submenu().getItem("Use Image Root Path"),e=h.getItem("Upload Image via iPic"),f=h.getItem("Copy Image File to Folder..."),f.setState(!!g&&"ipic"!==g.toLowerCase()),e.setState(g&&"ipic"==g.toLowerCase())}c.setState(!!t.editor.docMenu.getLocalRootUrl()),void 0!==b&&(f.setEnabled(!b),c.setEnabled(!b),e&&e.setEnabled(!b))}var d=t.editor;a?(u&&clearTimeout(u),u=setTimeout(c,500)):c()}},u=null,v=!1,w=function(a){t.editor.brush.timerID&&t.isActiveWindow()&&(v&&(v=!1,l.saveToRecover(t.editor.getMarkdown())),a!==!0&&t.option.enableAutoSave&&t.fileHasModified&&t.changeCounter.isDocumentEdited()&&t.filePath&&t.saveUseNode())};if(t.ChangeType=k.ChangeType,t.isMac=void 0!==window.app,t.isNode=void 0!==window.reqnode,t.isNodeHtml=window.isOnWindowHtml,t.isWin=t.isNode&&"win32"==process.platform,t.isLinux=t.isNode&&"linux"==process.platform,t.FileInfoPanel=l,t.autoSaveWorker=w,t.isNode){t.fs=reqnode("fs");var x=o.setting.config||{},y=Number.parseFloat(x.autoSaveTimer||5);(!y||Number.isNaN(y))&&(y=5),setInterval(w,60*y*1e3)}c.exports=t}),define("exoskeleton-master/exoskeleton",["jquery/jquery"],function(a,b){"use strict";var c,d,e=window,f=a("jquery/jquery"),g=e.Backbone,h=e.Exoskeleton,i=b.utils=c=c||{};b.$=f;var j=[],k=(j.push,j.slice),l={}.toString;b.noConflict=function(){return e.Backbone=g,e.Exoskeleton=h,this},b.extend=function(a,b){var d,e=this;d=a&&c.has(a,"constructor")?a.constructor:function(){return e.apply(this,arguments)},c.extend(d,e,b);var f=function(){this.constructor=d};return f.prototype=e.prototype,d.prototype=new f,a&&c.extend(d.prototype,a),d.__super__=e.prototype,d};var m=function(){throw new Error('A "url" property or function must be specified')},n=function(a,b){var c=b.error;b.error=function(d){c&&c(a,d,b),a.trigger("error",a,d,b)}},o=function(a){return"function"==typeof c[a]};i.result=function(a,b){var c=a?a[b]:void 0;return"function"==typeof c?a[b]():c},i.defaults=function(a){return k.call(arguments,1).forEach(function(b){for(var c in b)void 0===a[c]&&(a[c]=b[c])}),a},i.extend=function(a){return k.call(arguments,1).forEach(function(b){for(var c in b)a[c]=b[c]}),a},i.clone=function(a){return!a instanceof Object?a:Array.isArray(a)?a.slice():i.extend({},a)};var p={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};i.escape=function(a){return null==a?"":String(a).replace(/[&<>"']/g,function(a){return p[a]})},i.sortBy=function(a,b,c){var d="function"==typeof b?b:function(a){return a[b]};return a.map(function(a,b,e){return{value:a,index:b,criteria:d.call(c,a,b,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index-b.index}).map(function(a){return a.value})};var q=0;i.uniqueId=function(a){var b=++q+"";return a?a+b:b},i.has=function(a,b){return Object.hasOwnProperty.call(a,b)};var r=function(a,b,d,e){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;var f=l.call(a);if(f!=l.call(b))return!1;switch(f){case"[object String]":return a==String(b);case"[object Number]":return a!==+a?b!==+b:0===a?1/a===1/b:a===+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var g=d.length;g--;)if(d[g]==a)return e[g]==b;var h=a.constructor,i=b.constructor;if(h!==i&&!("function"==typeof h&&h instanceof h&&"function"==typeof i&&i instanceof i))return!1;d.push(a),e.push(b);var j=0,k=!0;if("[object Array]"===f){if(j=a.length,k=j===b.length)for(;j--&&(k=r(a[j],b[j],d,e)););}else{for(var m in a)if(c.has(a,m)&&(j++,!(k=c.has(b,m)&&r(a[m],b[m],d,e))))break;if(k){for(m in b)if(c.has(b,m)&&!j--)break;k=!j}}return d.pop(),e.pop(),k};i.isEqual=function(a,b){return r(a,b,[],[])};var s=b.Events={on:function(a,b,c){if(!u(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!u(this,"once",a,[b,c])||!b)return this;var d,e=this,f=function(){d||(d=!0,e.off(a,f),b.apply(this,arguments))};return f._callback=b,this.on(a,f,c)},off:function(a,b,c){var d,e,f,g,h,i,j,k;if(!this._events||!u(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events=void 0,this;for(g=a?[a]:Object.keys(this._events),h=0,i=g.length;i>h;h++)if(a=g[h],f=this._events[a]){if(this._events[a]=d=[],b||c)for(j=0,k=f.length;k>j;j++)e=f[j],(b&&b!==e.callback&&b!==e.callback._callback||c&&c!==e.context)&&d.push(e);d.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=k.call(arguments,1);if(!u(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&v(c,b),d&&v(d,arguments),this},stopListening:function(a,b,c){var d=this._listeningTo;if(!d)return this;var e=!b&&!c;c||"object"!=typeof b||(c=this),a&&((d={})[a._listenId]=a);for(var f in d)a=d[f],a.off(b,c,this),(e||!Object.keys(a._events).length)&&delete this._listeningTo[f];return this}},t=/\s+/,u=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(t.test(c)){for(var f=c.split(t),g=0,h=f.length;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},v=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b);return}},w={listenTo:"on",listenToOnce:"once"};Object.keys(w).forEach(function(a){var b=w[a];s[a]=function(a,d,e){var f=this._listeningTo||(this._listeningTo={}),g=a._listenId||(a._listenId=c.uniqueId("l"));return f[g]=a,e||"object"!=typeof d||(e=this),a[b](d,e,this),this}}),s.bind=s.on,s.unbind=s.off,c.extend(b,s);var x=b.Model=function(a,b){var d=a||{};b||(b={}),this.cid=c.uniqueId("c"),this.attributes=Object.create(null),b.collection&&(this.collection=b.collection),b.parse&&(d=this.parse(d,b)||{}),d=c.defaults({},d,c.result(this,"defaults")),this.set(d,b),this.changed=Object.create(null),this.initialize.apply(this,arguments)};if(c.extend(x.prototype,s,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(a){return c.extend({},this.attributes)},sync:function(){return b.sync.apply(this,arguments)},get:function(a){return this.attributes[a]},escape:function(a){return c.escape(this.get(a))},has:function(a){return null!=this.get(a)},set:function(a,b,d){var e,f,g,h,i,j,k,l;if(null==a)return this;if("object"==typeof a?(f=a,d=b):(f={})[a]=b,d||(d={}),!this._validate(f,d))return!1;g=d.unset,i=d.broadcast,h=[],j=this._changing,this._changing=!0,j||(this._previousAttributes=c.extend(Object.create(null),this.attributes),this.changed={}),l=this.attributes,k=this._previousAttributes,this.idAttribute in f&&(this.id=f[this.idAttribute]);for(e in f)b=f[e],c.isEqual(l[e],b)||h.push(e),c.isEqual(k[e],b)?delete this.changed[e]:this.changed[e]=b,g?delete l[e]:l[e]=b;if(i){h.length&&(this._pending=d);for(var m=0,n=h.length;n>m;m++)this.trigger("change:"+h[m],this,l[h[m]],d)}if(j)return this;if(i)for(;this._pending;)d=this._pending,this._pending=!1,this.trigger("change",this,d);return this._pending=!1,this._changing=!1,this},unset:function(a,b){return this.set(a,void 0,c.extend({},b,{unset:!0}))},clear:function(a){var b={};for(var d in this.attributes)b[d]=void 0;return this.set(b,c.extend({},a,{unset:!0}))},hasChanged:function(a){return null==a?!!Object.keys(this.changed).length:c.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?c.extend(Object.create(null),this.changed):!1;var b,d=!1,e=this._changing?this._previousAttributes:this.attributes;for(var f in a)c.isEqual(e[f],b=a[f])||((d||(d={}))[f]=b);return d},previous:function(a){return null!=a&&this._previousAttributes?this._previousAttributes[a]:null},previousAttributes:function(){return c.extend(Object.create(null),this._previousAttributes)},fetch:function(a){a=a?c.extend({},a):{},void 0===a.parse&&(a.parse=!0);var b=this,d=a.success;return a.success=function(c){return b.set(b.parse(c,a),a)?(d&&d(b,c,a),void b.trigger("sync",b,c,a)):!1},n(this,a),this.sync("read",this,a)},save:function(a,b,d){var e,f,g,h=this.attributes;if(null==a||"object"==typeof a?(e=a,d=b):(e={})[a]=b,d=c.extend({validate:!0},d),e&&!d.wait){if(!this.set(e,d))return!1}else if(!this._validate(e,d))return!1;e&&d.wait&&(this.attributes=c.extend(Object.create(null),h,e)),void 0===d.parse&&(d.parse=!0);var i=this,j=d.success;return d.success=function(a){i.attributes=h;var b=i.parse(a,d);return d.wait&&(b=c.extend(e||{},b)),b&&"object"==typeof b&&!i.set(b,d)?!1:(j&&j(i,a,d),void i.trigger("sync",i,a,d))},n(this,d),f=this.isNew()?"create":d.patch?"patch":"update","patch"===f&&(d.attrs=e),g=this.sync(f,this,d),e&&d.wait&&(this.attributes=h),g},destroy:function(a){a=a?c.extend({},a):{};var b=this,d=a.success,e=function(){b.trigger("destroy",b,b.collection,a)};if(a.success=function(c){(a.wait||b.isNew())&&e(),d&&d(b,c,a),b.isNew()||b.trigger("sync",b,c,a)},this.isNew())return a.success(),!1;n(this,a);var f=this.sync("delete",this,a);return a.wait||e(),f},url:function(){var a=c.result(this,"urlRoot")||c.result(this.collection,"url")||m();return this.isNew()?a:a.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(a,b){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(a){return this._validate({},c.extend(a||{},{validate:!0}))},_validate:function(a,b){if(!b.validate||!this.validate)return!0;a=c.extend(Object.create(null),this.attributes,a);var d=this.validationError=this.validate(a,b)||null;return d?(this.trigger("invalid",this,d,c.extend(b,{validationError:d})),!1):!0}}),c.keys){var y=["keys","values","pairs","invert","pick","omit"];y.filter(o).forEach(function(a){x.prototype[a]=function(){var b=k.call(arguments);return b.unshift(this.attributes),c[a].apply(c,b)}})}var z=b.Collection=function(a,b){b||(b={}),b.model&&(this.model=b.model),void 0!==b.comparator&&(this.comparator=b.comparator),this._reset(),this.initialize.apply(this,arguments),a&&this.reset(a,c.extend({broadcast:!0},b))},A={add:!0,remove:!0,merge:!0},B={add:!0,remove:!1};if(c.extend(z.prototype,s,{model:"undefined"==typeof x?null:x,initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},sync:function(){return b.sync.apply(this,arguments)},add:function(a,b){return this.set(a,c.extend({merge:!1},b,B))},remove:function(a,b){var c=!Array.isArray(a);a=c?[a]:a.slice(),b||(b={});var d,e,f,g;for(d=0,e=a.length;e>d;d++)g=a[d]=this.get(a[d]),g&&(delete this._byId[g.id],delete this._byId[g.cid],f=this.indexOf(g),this.models.splice(f,1),this.length--,b.broadcast&&(b.index=f,g.trigger("remove",g,this,b)),this._removeReference(g,b));return c?a[0]:a},set:function(a,b){b=c.defaults({},b,A),b.parse&&(a=this.parse(a,b));var d=!Array.isArray(a);a=d?a?[a]:[]:a.slice();var e,f,g,h,i,j,k,l=b.at,m=this.model,n=this.comparator&&null==l&&b.sort!==!1,o="string"==typeof this.comparator?this.comparator:null,p=[],q=[],r={},s=b.add,t=b.merge,u=b.remove,v=!n&&s&&u?[]:!1;for(e=0,f=a.length;f>e;e++){if(i=a[e]||{},g=i instanceof x?h=i:i[m.prototype.idAttribute||"id"],j=this.get(g))u&&(r[j.cid]=!0),t&&(i=i===h?h.attributes:i,b.parse&&(i=j.parse(i,b)),j.set(i,b),n&&!k&&j.hasChanged(o)&&(k=!0)),a[e]=j;else if(s){if(h=a[e]=this._prepareModel(i,b),!h)continue;p.push(h),this._addReference(h,b)}h=j||h,!v||!h.isNew()&&r[h.id]||v.push(h),r[h.id]=!0}if(u){for(e=0,f=this.length;f>e;++e)r[(h=this.models[e]).cid]||q.push(h);q.length&&this.remove(q,b)}if(p.length||v&&v.length)if(n&&(k=!0),this.length+=p.length,null!=l)for(e=0,f=p.length;f>e;e++)this.models.splice(l+e,0,p[e]);else{v&&(this.models.length=0);var w=v||p;for(e=0,f=w.length;f>e;e++)this.models.push(w[e])}if(k&&this.sort({broadcast:!1}),b.broadcast){for(e=0,f=p.length;f>e;e++)(h=p[e]).trigger("add",h,this,b);(k||v&&v.length)&&this.trigger("sort",this,b)}return d?a[0]:a},reset:function(a,b){b||(b={});for(var d=0,e=this.models.length;e>d;d++)this._removeReference(this.models[d],b);return b.previousModels=this.models,this._reset(),a=this.add(a,c.extend({broadcast:!1},b)),b.broadcast&&this.trigger("reset",this,b),a},push:function(a,b){return this.add(a,c.extend({at:this.length},b))},pop:function(a){var b=this.at(this.length-1);return this.remove(b,a),b},unshift:function(a,b){return this.add(a,c.extend({at:0},b))},shift:function(a){var b=this.at(0);return this.remove(b,a),b},slice:function(){return k.apply(this.models,arguments)},get:function(a){return null==a?void 0:this._byId[a]||this._byId[a.id]||this._byId[a.cid]},at:function(a){return this.models[a]},where:function(a,b){return a&&Object.keys(a).length?this[b?"find":"filter"](function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0}):b?void 0:[]},findWhere:function(a){return this.where(a,!0)},sort:function(a){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return a||(a={}),"string"==typeof this.comparator||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(this.comparator.bind(this)),a.broadcast&&this.trigger("sort",this,a),this},pluck:function(a){return this.models.map(function(b){return b.get(a)})},fetch:function(a){a=a?c.extend({},a):{},void 0===a.parse&&(a.parse=!0);var b=a.success,d=this;return a.success=function(c){var e=a.reset?"reset":"set";d[e](c,a),b&&b(d,c,a),d.trigger("sync",d,c,a)},n(this,a),this.sync("read",this,a)},create:function(a,b){if(b=b?c.extend({},b):{},!(a=this._prepareModel(a,b)))return!1;b.wait||this.add(a,b);var d=this,e=b.success;return b.success=function(a,c){b.wait&&d.add(a,b),e&&e(a,c,b)},a.save(null,b),a},parse:function(a,b){return a},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId=Object.create(null)},_prepareModel:function(a,b){if(a instanceof x)return a;b=c.extend({},b),b.collection=this;var d=new this.model(a,b);return d.validationError?(this.trigger("invalid",this,d.validationError,b),!1):d},_addReference:function(a,b){this._byId[a.cid]=a,null!=a.id&&(this._byId[a.id]=a),a.collection||(a.collection=this),a.on("all",this._onModelEvent,this)},_removeReference:function(a,b){this===a.collection&&delete a.collection,a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){("add"!==a&&"remove"!==a||c===this)&&("destroy"===a&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],null!=b.id&&(this._byId[b.id]=b)),this.trigger.apply(this,arguments))},toArray:function(){return this.models||[]}}),o("each")){var C=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain"];C.filter(o).forEach(function(a){z.prototype[a]=function(){var b=k.call(arguments);return b.unshift(this.models),c[a].apply(c,b)}});var D=["groupBy","countBy","sortBy"];D.filter(o).forEach(function(a){z.prototype[a]=function(b,d){var e="function"==typeof b?b:function(a){return a.get(b)};return c[a](this.models,e,d)}})}else["forEach","map","filter","some","every","reduce","reduceRight","indexOf","lastIndexOf"].forEach(function(a){z.prototype[a]=function(b,c){return this.models[a](b,c)}}),z.prototype.find=function(a,b){var c;return this.some(function(d,e,f){return a.call(b,d,e,f)?(c=d,!0):void 0}),c},["sortBy"].forEach(function(a){z.prototype[a]=function(b,d){var e="function"==typeof b?b:function(a){return a.get(b)};return c[a](this.models,e,d)}});return["Model","Collection","Router","View","History"].forEach(function(a){var c=b[a];c&&(c.extend=b.extend)}),c.extend(b,s),d&&(b.history=new d),b}),define("app/editor/UndoManager",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node"],function(a,b,c){"use strict";var d=a("exoskeleton-master/exoskeleton"),e=(a("app/document/StringUtils"),a("app/document/Node")),f=e.Node,g=e.TYPE,h={ADD:1,REPLACE:2,DELETE:-1,DELETE_ACCROSS_BLOCK:-2,HAS_UNDO_TO_PREPEND:-9},i=d.Model.extend({commandStack:void 0,index:void 0,undoManagerContext:!1,stackSize:void 0,UndoManager:i,initialize:function(a){this.commandStack=[],this.set({index:-1,stackSize:100}),this.editor=a,this.UndoManager=i,this.clearSnap()},reset:function(){this.commandStack=[],this.set({index:-1,stackSize:200}),this.clearSnap()},restoreFromJson:function(a){this.set("index",a.index),this.commandStack=JSON.parse(a.commandStackJson)},storeToJson:function(){return{index:this.get("index"),commandStackJson:JSON.stringify(this.commandStack)}},callCommand:function(a,b){var c,d;try{if(b)for(var e=a.undo.length-1;e>-1;e--)d=this.exeCommand(a.undo[e],a.redo),c||(c=void 0===c?d:!!d);else for(var e=0;e<a.redo.length;e++)d=this.exeCommand(a.redo[e],a.undo),c||(c=void 0===c?d:!!d)}catch(f){console.error(f.stack)}return c}});i.prototype.register=function(a,b,c){!this.undoManagerContext&&a&&("sync"!==c&&(this.commandStack.splice(this.get("index")+1,this.commandStack.length-this.get("index")),this.commandStack.length>this.get("stackSize")&&this.commandStack.splice(0,this.commandStack.length-this.get("stackSize")),this.commandStack.push(a),this.set({index:this.commandStack.length-1})),b||("sync"!==c&&"restore"!==c&&File.updateChangeCount(File.ChangeType.NSChangeDone),"undo"!==c&&this.editor.syncChange(a.redo)))},i.prototype.lastRegisteredOperationCommand=function(){return this.commandStack.length==this.get("index")+1?this.commandStack[this.get("index")]:null},i.prototype.removeLastRegisteredOperationCommand=function(){this.commandStack.length==this.get("index")+1&&(this.commandStack.pop(),this.set({index:this.get("index")-1}))},i.prototype.undo=function(a){if(this.editor.sourceView.inSourceMode)return this.editor.sourceView.cm.undo(),a&&a.preventDefault();if(this.completeSnap(!0),"INPUT"==document.activeElement.tagName&&a&&"checkbox"!=document.activeElement.getAttribute("type")){var b=document.activeElement,c=b.value,d=this;return setTimeout(function(){c==b.value&&d.undo()},50),!0}a&&a.preventDefault();var e=this.commandStack[this.get("index")];if(e){this.editor.brush.pause();var f=this.callCommand(e,!0);this.set({index:this.get("index")-1}),File.updateChangeCount(File.ChangeType.NSChangeUndone),f&&this.editor.refresh(),this.editor.brush.resume(!0),void 0===f?this.undo():(this.editor.refocus(void 0,null,null,!0),this.editor.syncChange(e.undo.clone().reverse()))}},i.prototype.redo=function(a){if(this.editor.sourceView.inSourceMode)return this.editor.sourceView.cm.redo(),a&&a.preventDefault();if("INPUT"==document.activeElement.tagName&&a&&"checkbox"!=document.activeElement.getAttribute("type")){var b=document.activeElement,c=b.value,d=this;return setTimeout(function(){c==b.value&&d.redo()},50),!0}if(a&&a.preventDefault(),!this.snapFlag){var e=this.commandStack[this.get("index")+1];if(e){this.editor.brush.pause();var f=this.callCommand(e,!1);this.set({index:this.get("index")+1}),File.updateChangeCount(File.ChangeType.NSChangeRedone),f&&this.editor.refresh(),this.editor.brush.resume(!0),void 0===f?this.redo():(this.editor.refocus(void 0,null,null,!0),this.editor.syncChange(e.redo))}}},i.prototype.hasUndo=function(){return!(!this.snapFlag&&-1===this.get("index"))},i.prototype.hasRedo=function(){return!(this.snapFlag||!(this.get("index")<this.commandStack.length-1))},i.prototype.exeCommand=function(a,b,c){function d(b,c){c=c||[],b=b||k.nodeMap,a.json.map(function(a){c.push(f.readFromJson(a,b,!0))}),a.json.map(function(a){var b=k.getNode(a.id);b.set("before",k.getNode(a.relation.before_id)),b.set("after",k.getNode(a.relation.after_id)),b.set("parent",k.getNode(a.relation.parent_id))})}var h,i,j,k=this.editor,l=!1,m=k.sourceView.inSourceMode;if(a){switch(a.type){case"reload":if(m)return;k.nodeMap.reset(k),d(),k.brush.queue=[],l=!0,$(k.sessionStr).html(e.NodeCollectionUtils.toHTML(k.nodeMap.blocks)),k.focusCid=null,window.getSelection().removeAllRanges(),File.fileEncode=a.encode;break;case"replace":if(m)return;if(j=k.getNode(a.id),!j)return console.error(a.id+" not found in  replace");j.get("type")==j.TYPE.fences&&k.fences.beforeDeleteFences(j,b),j.get("type")==j.TYPE.math_block&&k.mathBlock.beforeDeleteFences(j,b),a.id!=a.json.id?(k.getNode(a.id).remove(),j=f.readFromJson(a.json,k.nodeMap)):j.readFromJson(a.json,k.nodeMap),k.findElemById(a.id).replaceWith(k.MarkParser.renderHtmlWithBlockMeta(j,k.brush)),$(k.sessionStr).attr("contenteditable",!0),l=!0,k.brush.restart(),k.brush.addToQueue(j.id,!0);break;case"insert":if(m)return;var n=k.nodeMap,o=new Array,p=[];if(d(n,o),a.after&&(p=k.findElemById(a.after),p.before(e.NodeCollectionUtils.toHTML(o))),!p.length&&a.before&&(p=k.findElemById(a.before),p.after(e.NodeCollectionUtils.toHTML(o))),!p.length){var q=o[0].get("parent");q?k.findElemById(q.id).replaceWith(q.toHTML()):0===$(k.sessionStr).children().length&&$(k.sessionStr).html(e.NodeCollectionUtils.toHTML(o))}l=!0;break;case"remove":if(m)return;a.idArray.map(function(a){var c=k.getNode(a);f.isType(c,g.fences)&&k.fences.beforeDeleteFences(c,b),f.isType(c,g.math_block)&&k.mathBlock.beforeDeleteFences(c,b),h=k.findElemById(a);var d=h.parent("li");d.length&&d.css("margin","0.1px"),k.findElemById(a).remove(),d.length&&d.css("margin",""),c&&c.remove()}),l=!0;break;case"text":if(m)return;h=k.findElemById(a.id),k.getNode(a.id).set("text",a.text),a.html&&h.html(a.html),l=!1,("def-footnote"==h.attr("mdtype")||"def-link"==h.attr("mdtype"))&&(l=!0),k.brush.addToQueue(a.id,!0);break;case"cursor":if(m||c)return;try{if(void 0==a.end&&(a.end=a.start),void 0==a.startId&&void 0==a.id&&(a.id=a.cid),a.focus)return setTimeout(function(){k.findElemById(a.id).children("[tabindex]").andSelf("[tabindex]").focus()},100),k.findElemById(a.id).children("[tabindex]").andSelf("[tabindex]").focus(),!1;if(a.id||a.startId==a.endId){if(a.id=a.id||a.startId,h=k.findElemById(a.id),h.attr("mdtype")==g.fences||h.attr("mdtype")==g.math_block){var r;h.attr("mdtype")==g.fences?(k.fences.refreshEditor(),r=k.fences.getCm(a.id),r.focus()):r=k.mathBlock.startEditing(h,!0),a.pos?(r.setCursor(a.pos),a.selections&&r.setSelections(a.selections)):a.start>-1?(r.setCursor(r.posFromIndex(a.start)),a.end>-1&&r.setSelection(r.posFromIndex(a.start),r.posFromIndex(a.end))):k.selection.jumpIntoElemEnd(h)}else if(h.length&&void 0!==a.end){var s=h.text().length;a.start>s&&(a.start=s),a.end>s&&(a.end=s),k.selection.restoreSelection(h[0],{start:a.start,end:a.end})}else window.getSelection().removeAllRanges();b||k.refocus(a.id)}else if(a.startId)try{var t=k.selection.restoreEdge(k.findElemById(a.startId),a.start);t=k.selection.restoreEdge(k.findElemById(a.endId),a.end,!0,t),k.selection.setRange(t)}catch(u){console.log(u.stack)}File.isTypeWriterMode&&k.selection.scrollAdjust(),l=!1}catch(u){throw console.log(u.stack),u}break;case"fences":if(m)return;j=k.getNode(a.id),f.isType(j,j.TYPE.math_block)?(k.mathBlock.startEditing(a.id),i=k.mathBlock.currentCm):i=k.fences.getCm(a.id),i.focus(),"undo"==a.cmd&&i.undo(),"redo"==a.cmd&&i.redo(),l=!1;break;case"fences-pos":if(m||c)return;j=k.getNode(a.id),f.isType(j,j.TYPE.math_block)?(k.mathBlock.startEditing(a.id),i=k.mathBlock.currentCm):(k.fences.refreshEditor(),i=k.fences.getCm(a.id)),i.focus(),i.setCursor(a.pos),l=!1;break;case"attr":if(m)return;a.value=a.value||!1,j=this.editor.getNode(a.id),j.attr(a.key,a.value,this.editor,!0),k.brush.addToQueue(a.id,!0);break;case"wrap":if(m)return;var v={};v.type="insert",v.json=[a.json],a.json.children.map(function(c,d){var e=k.getNode(c.id);0===d?v.before=e.get("before")?e.get("before").id:null:d===a.json.children.length-1&&(v.after=e.get("after")?e.get("after").id:null),e&&(e.get("type")==e.TYPE.fences&&(l=!0,k.fences.beforeDeleteFences(e,b)),e.get("type")==e.TYPE.math_block&&(l=!0,k.mathBlock.beforeDeleteFences(e,b)),e.remove(),k.findElemById(c.id).remove())}),this.exeCommand(v,b);break;case"unwrap":if(m)return;j=k.getNode(a.id);var w=j.unwrap();!a.skipHTML&&k.findElemById(a.id).replaceWith(e.NodeCollectionUtils.toHTML(w)),l=!0;break;case"scroll":if(m||c)return;k.selection.scrollAdjust(a.id?k.findElemById(a.id):void 0,a.marginTop);break;case"sync":if(!c)return;if(a.html)k.findElemById(a.id).html(a.html).find(".md-expand, .md-focus").removeClass("md-expand md-focus");else if(a.cmChanges)i=k.fences.getCm(a.id),a.cmChanges.forEach(function(a){i.replaceRange(a.text,a.from,a.to)});else{if(void 0!==a.tex)return j=k.getNode(a.id),j.set("text",a.tex),k.findElemById(a.id).replaceWith(j.toHTML()),!0;if(a.srcChanges)m&&a.srcChanges.forEach(function(a){k.sourceView.cm.replaceRange(a.text,a.from,a.to)});else if(void 0!==a.content){if(m&&!a.fromSourceMode){var x=k.sourceView.cm.getScrollInfo().top;k.sourceView.cm.setValue(a.content,"sync"),k.sourceView.cm.scrollTo(0,x)}!m&&a.fromSourceMode&&(k.nodeMap.reset(),k.reset(a.content))}}default:return}return l}},i.prototype.clearSnap=function(){this.snapNode={},this.snapFlag=0,this.snapDate=0,this.snapSelection=null},i.prototype.completeSnap=function(a,b){if(a&&!this.snapFlag||!this.snapNode||!this.snapNode.id)return this.snapFlag=0;var c=null;return this.snapFlag==h.HAS_UNDO_TO_PREPEND?(c=j,b||this.register(c,!1),j=null,this.clearSnap(),c):(c=i.makeEmptyCommand(),f.isType(this.snapNode.content.type,g.fences,g.math_block)?void 0:(this.snapSelection&&c.undo.push(this.snapSelection),c.undo.push({type:"replace",id:this.snapNode.id,json:this.snapNode}),this.buildSnap(this.snapNode.id,0),c.redo.push({type:"replace",id:this.snapNode.id,json:this.snapNode}),this.snapSelection&&c.redo.push(this.snapSelection),b||this.register(c,!0),c))},i.prototype.buildSnap=function(a,b,c){this.snapSelection=this.editor.selection.buildUndo();var d=this.editor.getNode(a);return d?(void 0!==c&&null!==c?d.set("text",c):this.editor.store(a,!0),this.snapNode=d.storeToJson(),this.snapFlag=b||0,void(this.snapDate=(new Date).getTime())):this.clearSnap()};var j,k=null;i.prototype.noStashedUndo=function(){return this.snapFlag!==h.HAS_UNDO_TO_PREPEND},i.prototype.stashUndo=function(a){j?i.append(j,a):j=a,this.snapFlag=h.HAS_UNDO_TO_PREPEND},i.prototype.snap=function(a,b,c,d){var e=this;this.snapFlag==h.HAS_UNDO_TO_PREPEND&&(this.completeSnap(),File.updateChangeCount(File.ChangeType.NSChangeDone)),!a&&this.snapNode&&(a=this.snapNode.id),a||this.clearSnap(),this.snapFlag?(this.snapNode.id!=a?(this.completeSnap(),this.buildSnap(a,b,c),File.updateChangeCount(File.ChangeType.NSChangeDone)):b!=this.snapFlag||this.snapFlag==h.REPLACE?(this.completeSnap(),File.updateChangeCount(File.ChangeType.NSChangeDone)):b&&this.snapDate&&(new Date).getTime()-this.snapDate>1e3&&(this.completeSnap(),File.updateChangeCount(File.ChangeType.NSChangeDone)),this.snapFlag=b):b&&(this.buildSnap(a,b,c),File.updateChangeCount(File.ChangeType.NSChangeDone)),b&&!d&&(k&&clearTimeout(k),b==h.DELETE_ACCROSS_BLOCK?(this.editor.selection.scrollAdjust(),k=null):k=setTimeout(function(){e.editor.findElemById(a).trigger("inline-input"),k=null},50))},i.prototype.buildReplaceUndo=function(a){return i.buildReplaceUndo(a)},i.buildReplaceUndo=function(a,b){if(!a)throw new Error("empty node");return{type:"replace",id:b?b:a.id,json:a.storeToJson()}},i.addUndoForInsert=function(a,b,c,d){b&&(a.redo.push({type:"insert",after:d?d.id:b.get("after")?b.get("after").id:null,before:c?c.id:b.get("before")?b.get("before").id:null,json:[b.storeToJson()]}),a.undo.push({type:"remove",idArray:[b.id]}))},i.addUndoForWrap=function(a,b,c){b&&(a.redo.push({type:"wrap",json:b.storeToJson(),skipHTML:c}),a.undo.push({type:"unwrap",id:b.id,skipHTML:c}))},i.addUndoForUnwrap=function(a,b){b&&(a.undo.push({type:"wrap",json:b.storeToJson()}),a.redo.push({type:"unwrap",id:b.id}))},i.buildAllDoc=function(a,b){var c=a.blocks.at(0),d=[];for(c=c.getLastBrother(!0);c;)d.push(c.storeToJson()),c=c.get("after");return{type:"reload",json:d,reloadFromDisk:b,encode:File.fileEncode}},i.addUndoForInsertArray=function(a,b,c,d){b&&0!=b.length&&(a.redo.push({type:"insert",after:d?d.id:b[b.length-1].get("after")?b[b.length-1].get("after").id:null,before:c?c.id:b[0].get("before")?b[0].get("before").id:null,json:b.reduce(function(a,b){return a.push(b.storeToJson()),a},[])}),a.undo.push({type:"remove",idArray:b.reduce(function(a,b){return a.push(b.id),a},[])}))},i.addUndoForRemoveArray=function(a,b,c,d){b&&0!=b.length&&(a.undo.push({type:"insert",after:d?d.id:b[b.length-1].get("after")?b[b.length-1].get("after").id:null,before:c?c.id:b[0].get("before")?b[0].get("before").id:null,json:b.reduce(function(a,b){return a.push(b.storeToJson()),a},[])}),a.redo.push({type:"remove",idArray:b.reduce(function(a,b){return a.push(b.id),a},[])}))},i.addUndoForRemove=function(a,b,c,d){a.undo.push({type:"insert",after:d?d.id:b.get("after")?b.get("after").id:null,before:c?c.id:b.get("before")?b.get("before").id:null,json:[b.storeToJson()]}),a.redo.push({type:"remove",idArray:[b.id]})},i.makeEmptyCommand=function(a){var b={undo:[],redo:[]};return a&&b.undo.push(a),b},i.isEmptyCommand=function(a){return!(a&&a.undo&&a.redo&&(a.undo.length||a.redo.length))},i.append=function(a,b){return b&&(a.undo=a.undo.concat(b.undo),a.redo=a.redo.concat(b.redo)),a},f.storeToJson=function(a){var b={};return b.content={},b.relation={},b.children=new Array,f.property.map(function(c){var d=a.get(c);void 0!==d&&null!==d&&(d instanceof Array?b.content[c]=$.merge([],d):typeof d==Object?b.content[c]=$.extend({},d):b.content[c]=d)}),b.relation.before_id=a.get("before")?a.get("before").id:null,b.relation.after_id=a.get("after")?a.get("after").id:null,b.relation.parent_id=a.get("parent")?a.get("parent").id:null,b.is_top=a.get("attachTo")?!0:!1,a.get("children").toArray().map(function(a){var c=f.storeToJson(a);b.children.push(c)}),b.id=a.id,b},f.readFromJson=function(a,b,c){function d(a){var c=b.allNodes.get(a);return c&&!c.attributes&&(console.assert(null,"node deleted"),c.attributes={}),c}var e=d(a.id)||new f({id:a.id});return e.set("in",b),a.is_top&&e.set("attachTo",b),f.property.map(function(a){e.attributes[a]=void 0}),e.set(a.content),e.clearChildren(!0),a.relation.parent_id||e.set("attachTo",b),a.children.map(function(a){f.readFromJson(a,b,!0)}),a.children.map(function(a){var c=b.allNodes.get(a.id);c.set("before",b.allNodes.get(a.relation.before_id)),c.set("after",b.allNodes.get(a.relation.after_id)),c.set("parent",e)}),c||(e.set("before",b.allNodes.get(a.relation.before_id)),e.set("after",b.allNodes.get(a.relation.after_id)),e.set("parent",b.allNodes.get(a.relation.parent_id))),e},f.prototype.storeToJson=function(){return f.storeToJson(this)},f.prototype.readFromJson=function(a,b){this.clearChildren();var c=f.readFromJson(a,b||this.get("in"));this.replaceWith(c)},i.SnapFlag=h,c.exports=i}),define("app/document/StringUtils",[],function(a,b,c){"use strict";var d=/^[\s\u200b]+$/,e=function(a){return null==a||void 0==a||""===a||"​"===a},f=function(a){return!e(a)},g=function(a){return null==a||void 0==a||""===a||d.exec(a)},h=function(a,b,c){return null==a||void 0==a||""==a?"":"string"!=typeof a&&"number"!=typeof a?a:(a=(a+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),b&&(a=l(a)),a)},i=function(a,b,c){var a=h(a,b,c);return File.option.noPreWrap&&(a=a.replace(/(^ )|( $)/g," ").replace(/  /g,"  ")),a},j=function(a){return null==a||void 0==a||""==a?"":(a+"").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'");
},k=function(a){return a.replace(/(^ *)((#+)|(\+ +)|(\- +)|(\* +)|(\d+\. +)|(```|~~~)|(>)|(-+\s*$))/,"$1\\$2")},l=function(a){return a.replace(/[[\]~`*\\$<]/g,"\\$&").replace(/(\b_)|(_(?=\s))/g,"\\$&")},m=function(a,b,c){return a=a||"",b<a.length?a.substring(0,b)+c+a.substring(b):a+c},n=/(([\w-_]+:\/\/)|(www\.)|\w*\/)[\w-.\/?%&=:@]*/i,o=/(([\w-_]+:\/\/)|(www\.)|\w*\/)?[\w-.\/?%&=:@]+(\.jpe?g|png|gif|webm|svg)/i,p=function(a){return!!n.exec(a)},q=function(a){return!!o.exec(a)},r=function(a,b,c){return a.replace(new RegExp("\\b"+b+"\\b","gi"),c)},s=function(a,b){return a.split(new RegExp("\\b"+b+"\\b","gi"))},t=function(a){if(a&&a.length){for(var b=0,c=a.length-1;0===a[b].trim().length&&c>b;)b++;for(;c>b&&0===a[c].trim().length;)c--;return a.slice(b,c+1)}return a},u=function(a,b){var c=a.getHours()+"",d=a.getMinutes()+"",e=a.getSeconds()+"";return(c.length<2?"0":"")+c+":"+(d.length<2?"0":"")+d+(b?(e.length<2?"0":"")+e:"")},v=function(a){return a.getFullYear()+"/"+(a.getMonth()+1)+"/"+a.getDate()+"  "+u(a)},w=function(a){return a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()},x=function(a){return a.replace(/(?:^|_|-)(\w)/g,function(a,b,c){return 0==c?b.toLowerCase():b.toUpperCase()})},y=function(a,b,c){if(!a)return b;var d;if(File.isNode)return d=reqnode("path").relative(a,b),""==d&&(d="./"),d;a=a.replace(/\\\\/g,"/").replace(/^\.\//,""),b=b.replace(/\\\\/g,"/");var e,f=b.split(/\//g),g=a.split(/\//g),h=f.pop(),i="";for(""==g.last()&&g.pop(),""==g[0]&&g.shift(),""==f[0]&&f.shift(),e=f.join("/");0!==e.indexOf(g.join("/"));)g.pop(),i+="../";var j=f.slice(g.length);return j.length&&(i+=j.join("/")+"/"),d=i+h,c&&!d.match(/^\.\.\//)&&(d="./"+d),d},z=function(a,b){if(!a)return b;b=b||"";var c=a.split("/"),d=b.split("/");c.pop();for(var e=0;e<d.length;e++)"."!=d[e]&&(".."==d[e]?c.pop():c.push(d[e]));return c.join("/")},A=function(a,b){if(!b)return"";var c=b.replace(/^[\\\/]{2}/,"http://");return a=a||"",c.match(/^[^:]+:\/\//)?c:c.match(/^[\\\/]/)?a.replace(/(^[^:]+:\/\/[^\/]+)\/.*/,"$1"+b):z(a,c)},B=function(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},C=function(a,b){return a.trim().length?a:b};String.prototype.replaceExact=function(a,b){return r(this,a,b)},String.prototype.repeat=function(a){return(!$.isNumeric(a)||0>a)&&(console.error("String.prototype.repeat only accepts non-nagitive number"),a=0),new Array(a-0+1).join(this)},String.prototype.startsWith=String.prototype.startsWith||function(a){return this.match("^"+a)===a},String.prototype.endsWith=String.prototype.endsWith||function(a){return this.match(a+"$")===a},String.prototype.format=function(){var a=/\{\d+\}/g,b=arguments;return this.replace(a,function(a){return b[a.match(/\d+/)]})},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};for(var D=[{base:"A",letters:"AⒶＡÀÁÂẦẤẪẨÃĀĂẰẮẴẲȦǠÄǞẢÅǺǍȀȂẠẬẶḀĄȺⱯ"},{base:"AA",letters:"Ꜳ"},{base:"AE",letters:"ÆǼǢ"},{base:"AO",letters:"Ꜵ"},{base:"AU",letters:"Ꜷ"},{base:"AV",letters:"ꜸꜺ"},{base:"AY",letters:"Ꜽ"},{base:"B",letters:"BⒷＢḂḄḆɃƂƁ"},{base:"C",letters:"CⒸＣĆĈĊČÇḈƇȻꜾ"},{base:"D",letters:"DⒹＤḊĎḌḐḒḎĐƋƊƉꝹ"},{base:"DZ",letters:"ǱǄ"},{base:"Dz",letters:"ǲǅ"},{base:"E",letters:"EⒺＥÈÉÊỀẾỄỂẼĒḔḖĔĖËẺĚȄȆẸỆȨḜĘḘḚƐƎ"},{base:"F",letters:"FⒻＦḞƑꝻ"},{base:"G",letters:"GⒼＧǴĜḠĞĠǦĢǤƓꞠꝽꝾ"},{base:"H",letters:"HⒽＨĤḢḦȞḤḨḪĦⱧⱵꞍ"},{base:"I",letters:"IⒾＩÌÍÎĨĪĬİÏḮỈǏȈȊỊĮḬƗ"},{base:"J",letters:"JⒿＪĴɈ"},{base:"K",letters:"KⓀＫḰǨḲĶḴƘⱩꝀꝂꝄꞢ"},{base:"L",letters:"LⓁＬĿĹĽḶḸĻḼḺŁȽⱢⱠꝈꝆꞀ"},{base:"LJ",letters:"Ǉ"},{base:"Lj",letters:"ǈ"},{base:"M",letters:"MⓂＭḾṀṂⱮƜ"},{base:"N",letters:"NⓃＮǸŃÑṄŇṆŅṊṈȠƝꞐꞤ"},{base:"NJ",letters:"Ǌ"},{base:"Nj",letters:"ǋ"},{base:"O",letters:"OⓄＯÒÓÔỒỐỖỔÕṌȬṎŌṐṒŎȮȰÖȪỎŐǑȌȎƠỜỚỠỞỢỌỘǪǬØǾƆƟꝊꝌ"},{base:"OI",letters:"Ƣ"},{base:"OO",letters:"Ꝏ"},{base:"OU",letters:"Ȣ"},{base:"OE",letters:"Œ"},{base:"oe",letters:"œ"},{base:"P",letters:"PⓅＰṔṖƤⱣꝐꝒꝔ"},{base:"Q",letters:"QⓆＱꝖꝘɊ"},{base:"R",letters:"RⓇＲŔṘŘȐȒṚṜŖṞɌⱤꝚꞦꞂ"},{base:"S",letters:"SⓈＳẞŚṤŜṠŠṦṢṨȘŞⱾꞨꞄ"},{base:"T",letters:"TⓉＴṪŤṬȚŢṰṮŦƬƮȾꞆ"},{base:"TZ",letters:"Ꜩ"},{base:"U",letters:"UⓊＵÙÚÛŨṸŪṺŬÜǛǗǕǙỦŮŰǓȔȖƯỪỨỮỬỰỤṲŲṶṴɄ"},{base:"V",letters:"VⓋＶṼṾƲꝞɅ"},{base:"VY",letters:"Ꝡ"},{base:"W",letters:"WⓌＷẀẂŴẆẄẈⱲ"},{base:"X",letters:"XⓍＸẊẌ"},{base:"Y",letters:"YⓎＹỲÝŶỸȲẎŸỶỴƳɎỾ"},{base:"Z",letters:"ZⓏＺŹẐŻŽẒẔƵȤⱿⱫꝢ"},{base:"a",letters:"aⓐａẚàáâầấẫẩãāăằắẵẳȧǡäǟảåǻǎȁȃạậặḁąⱥɐ"},{base:"aa",letters:"ꜳ"},{base:"ae",letters:"æǽǣ"},{base:"ao",letters:"ꜵ"},{base:"au",letters:"ꜷ"},{base:"av",letters:"ꜹꜻ"},{base:"ay",letters:"ꜽ"},{base:"b",letters:"bⓑｂḃḅḇƀƃɓ"},{base:"c",letters:"cⓒｃćĉċčçḉƈȼꜿↄ"},{base:"d",letters:"dⓓｄḋďḍḑḓḏđƌɖɗꝺ"},{base:"dz",letters:"ǳǆ"},{base:"e",letters:"eⓔｅèéêềếễểẽēḕḗĕėëẻěȅȇẹệȩḝęḙḛɇɛǝ"},{base:"f",letters:"fⓕｆḟƒꝼ"},{base:"g",letters:"gⓖｇǵĝḡğġǧģǥɠꞡᵹꝿ"},{base:"h",letters:"hⓗｈĥḣḧȟḥḩḫẖħⱨⱶɥ"},{base:"hv",letters:"ƕ"},{base:"i",letters:"iⓘｉìíîĩīĭïḯỉǐȉȋịįḭɨı"},{base:"j",letters:"jⓙｊĵǰɉ"},{base:"k",letters:"kⓚｋḱǩḳķḵƙⱪꝁꝃꝅꞣ"},{base:"l",letters:"lⓛｌŀĺľḷḹļḽḻſłƚɫⱡꝉꞁꝇ"},{base:"lj",letters:"ǉ"},{base:"m",letters:"mⓜｍḿṁṃɱɯ"},{base:"n",letters:"nⓝｎǹńñṅňṇņṋṉƞɲŉꞑꞥ"},{base:"nj",letters:"ǌ"},{base:"o",letters:"oⓞｏòóôồốỗổõṍȭṏōṑṓŏȯȱöȫỏőǒȍȏơờớỡởợọộǫǭøǿɔꝋꝍɵ"},{base:"oi",letters:"ƣ"},{base:"ou",letters:"ȣ"},{base:"oo",letters:"ꝏ"},{base:"p",letters:"pⓟｐṕṗƥᵽꝑꝓꝕ"},{base:"q",letters:"qⓠｑɋꝗꝙ"},{base:"r",letters:"rⓡｒŕṙřȑȓṛṝŗṟɍɽꝛꞧꞃ"},{base:"s",letters:"sⓢｓßśṥŝṡšṧṣṩșşȿꞩꞅẛ"},{base:"t",letters:"tⓣｔṫẗťṭțţṱṯŧƭʈⱦꞇ"},{base:"tz",letters:"ꜩ"},{base:"u",letters:"uⓤｕùúûũṹūṻŭüǜǘǖǚủůűǔȕȗưừứữửựụṳųṷṵʉ"},{base:"v",letters:"vⓥｖṽṿʋꝟʌ"},{base:"vy",letters:"ꝡ"},{base:"w",letters:"wⓦｗẁẃŵẇẅẘẉⱳ"},{base:"x",letters:"xⓧｘẋẍ"},{base:"y",letters:"yⓨｙỳýŷỹȳẏÿỷẙỵƴɏỿ"},{base:"z",letters:"zⓩｚźẑżžẓẕƶȥɀⱬꝣ"}],E={},F=0;F<D.length;F++)for(var G=D[F].letters,H=0;H<G.length;H++)E[G[H]]=D[F].base;var I=function(a){return(a||"").replace(/[^\u0000-\u007E]/g,function(a){return E[a]||a})},J={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"'":"\\'","\\":"\\\\"},K=function(a){return a.replace(/["'\\\b\t\n\f\r]/g,function(a){return J[a]}).replace(/\u200b/g,"")},L=function(a){return File.isMac?a.split("/").slice(0,-1).join("/"):reqnode("path").join(a,"..")},M={"&newline;":null,"&tab;":"	","&copy;":"©","&amp;":"&","&gt":">","&lt":"<","&num;":"#"},N=document.createElement("textarea"),O=function(a){a=a.toLowerCase();var b=M[a];return b||(N.innerHTML=a,b=N.value,b!=a?M[a]=b:b=null),b};b.decodeHtmlEntity=O,b.formateDateTime=v,b.formateTimeOnly=u,b.formateDateOnly=w,b.insert=m,b.escape=i,b.escapeForPreWrap=h,b.unescape=j,b.escapeHead=k,b.escapeMark=l,b.escapeRegExp=B,b.isNullOrEmpty=e,b.isNotNullOrEmpty=f,b.isNullOrBlank=g,b.replaceExact=r,b.splitExact=s,b.trimArr=t,b.isURL=p,b.isImg=q,b.camelize=x,b.getRelativePath=y,b.getAbsolutePath=z,b.getAbsoluteURL=A,b.useOrDefault=C,b.removeDiacritics=I,b.escapeInQuote=K,b.pathByDeleteLastComponent=L}),define("app/document/Node",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils"],function(a,b,c){"use strict";var d=a("exoskeleton-master/exoskeleton"),e=a("app/document/StringUtils"),f={paragraph:"paragraph",heading:"heading",blockquote:"blockquote",fences:"fences",hr:"hr",def_link:"def_link",def_footnote:"def_footnote",table:"table",raw_edit:"raw_edit",meta_block:"meta_block",math_block:"math_block",list:"list",toc:"toc"},g={list_item:"list_item",table_row:"table_row",table_cell:"table_cell",line:"line"},h={plain:"plain",strong:"strong",em:"em",code:"code",underline:"underline",escape:"escape",autolink:"autolink",reflink:"reflink",refimg:"refimg",link:"link",url:"url",tag:"tag",comment:"comment",atag:"atag",imgtag:"imgtag",del:"del",todo:"todo",image:"image",footnote:"footnote",attr:"attr",emoji:"emoji",inline_math:"inline_math",subscript:"subscript",superscript:"superscript",linebreak:"linebreak",highlight:"highlight",html_entity:"html_entity"},i={};d.utils.extend(i,f,g,h);var j=0,k=function(){return"n"+j++},l=d.Model.extend({initialize:function(){var a=this.get("id")||k();this.get("id")||this.set("id",a),l.pool[a]&&console.warn("Duplicate Model"),l.pool[a]=this,this.TYPE=i,this.set("text",this.get("text")||""),this.set("broadcast",!1),this.set("children",new m)},isBlock:function(a){return l.isBlock(this.get("type"),a)},isTopBlock:function(){return this.get("attachTo")&&!this.get("parent")},isVirtualBlock:function(){return l.isVirtualBlock(this.get("type"))},getClosetBlock:function(a){return this.isBlock(a)?this:this.get("parent").getClosetBlock(a)},getTopBlock:function(){return this.isTopBlock()?this:this.get("parent").getTopBlock()},isInline:function(){return!this.isBlock(!0)},getLastChild:function(){try{var a=this.get("children").at(this.get("children").length-1);return a.getLastBrother(!1)}catch(b){return null}},getFirstChild:function(){try{var a=this.get("children").at(0);return a.getLastBrother(!0)}catch(b){return null}},escapedMark:function(a){return a.replace(/\*/g,"*").replace(/_/g,"_").replace(/`/g,"`")},isLoose:function(a){function b(a){for(var b=a.getFirstChild(),c=0,d=0;b;){if(l.isType(b,i.paragraph))c++;else{if(!l.isType(b,i.list))return!0;if(l.isType(b.get("after"),i.paragraph)||b.isLoose())return!0;d++}b=b.get("after")}return!(1>=c&&1>=d)}for(var c=this.getFirstChild(),d=c,e=!1;d;){if(b(d)){e=!0;break}d=d.get("after")}if(a)for(d=c;d;)d.set("tight",!e),d=d.get("after");return e},safeGetStrAttr:function(a,b){if("href-title"==a)return this.safeGetStrAttr("href")+" "+this.safeGetStrAttr("title");var c=this.get(a)?this.get(a):"";return b?e.escape(c):c},replaceWith:function(a){a.id!=this.id&&(a.get("after")&&a.get("after").set("before",a.get("before")),a.get("before")&&a.get("before").set("after",a.get("after")),a.set("parent",this.get("parent")),a.set("before",this.get("before")),a.set("after",this.get("after")),this.remove())},giveChildrenTo:function(a,b,c,d){if(0!=this.get("children").length){var e=b||this.getFirstChild();for(d&&(b=b||e,c=c||this.getLastChild(),b.get("before")&&b.get("before").set("after",c.get("after")),b.set("before",null),b.set("in",this.get("in")),c.set("after",null),c.set("in",this.get("in")));e;)e.set("parent",a),e=e.get("after")}},append:function(a,b){return a?(a.detach(),this.get("children").length?b?this.getFirstChild().insert(a,!0):this.getLastChild().insert(a):(a.set("in",this.get("in")),a.set("parent",this)),a):void 0},appendTillEnd:function(a){if(a){var b=null,c=this.getLastChild();do b=a.get("after"),a.detach(),c?c.insert(a):(a.set("parent",this),a.set("in",this.get("in"))),c=a,a=b;while(b)}},insertTillEnd:function(a){if(a){var b=null,c=this;do b=a.get("after"),a.detach(),c.insert(a),c=a,a=b;while(b)}},insert:function(a,b){if(a){if(a instanceof Array)return console.warning("deprecate, use insertArray"),this.insertArray(a,b);var c=b?"before":"after";return this.get(c)!==a&&(a.detach(),a.set(c,this.get(c)),this.set(c,a)),a.set("in",this.get("in")),a.set("parent",this.get("parent")),a.set("attachTo",this.get("attachTo")),a}},insertArray:function(a,b,c){if(a&&a.length){var d=b?"before":"after",e=c?a[0]:a[0].getLastBrother(!0),f=c?a.last():a.last().getLastBrother(!1);"before"===d?(e.set("before",this.get("before")),f.set("after",this)):(f.set("after",this.get("after")),e.set("before",this));for(var g=0;g<a.length;g++)a[g].set("in",this.get("in")),a[g].set("parent",this.get("parent")),a[g].set("attachTo",this.get("attachTo")),c&&g>0&&a[g].set("before",a[g-1]);return e}},clearChildren:function(){this.get("in");this.get("children").forEach(function(a){a["delete"]()})},canContainBlock:function(a){return l.canContainBlock(this.get("type"),a)},canNotDirectEdit:function(){return l.isType(this,i.hr,i.math_block,i.list,i.list_item,i.toc)},getText:function(a,b){var c=[],d=this.get("children");return b=b||"",this.canContainBlock(!0)||d&&d.length>0?(d.forEach(function(b){c.push(b.getText(a))}),c=c.join(b),this.unset("text")):(c=this.get("text")||"",a&&l.isType(this,i.heading,i.paragraph,i.line)&&(c=e.escapeHead(c))),c},getNthChild:function(a){try{for(var b=this.get("children").at(0).getLastBrother(!0),c=0;b&&a>c;)c++,b=b.get("after");return b}catch(d){}return null},getVeryFirst:function(a,b){return 0==this.get("children").length||b&&l.isType(this,i.paragraph)?this:(a?this.getLastChild():this.getFirstChild()).getVeryFirst(a,b)},getLastBrother:function(a,b,c){var d=a?"before":"after",e=this.get("in").blocks;if(this.isTopBlock()){if(b)return null;if(!c&&e.length)return e.at(a?0:e.length-1).getLastBrother(a,!1,!0)}return this.get(d)?this.attributes[d].getLastBrother(a,b,!0):this},getVeryFirstBrotherIncludeTopBlock:function(a){return this.getVeryFirstBrother(a,!0)},getVeryFirstBrother:function(a,b){var c=a?"before":"after";return!b&&this.isTopBlock()?null:!this.get(c)&&this.get("parent")?this.get("parent").getVeryFirstBrother(a,b):this.get(c)?this.get(c).getVeryFirst(a):null},getClosetParagraphLevel:function(){return l.isType(this.get("parent"),i.paragraph)?this.get("parent"):this},contains:function(a){return a?this.id==a.id?!0:this.contains(a.get("parent")):!1},closest:function(){for(var a=this.get("type"),b=0;b<arguments.length;b++)if(a==arguments[b])return this;var c=this.get("parent");return c?l.prototype.closest.apply(c,arguments):null},isStyled:function(){var a=this.get("type");return a==i.strong||a==i.em||a==i.code},isSeperated:function(){var a=this.get("type");return this.canNotDirectEdit()||a==i.code||a==i.escape},isDeleted:function(){return void 0==this.attributes},"delete":function(a){this.set("parent",null),this.set("after",null),this.set("before",null),this.set("in",null),a?this.get("children").toArray().map(function(a){a.attributes.parent=null}):this.clearChildren(),l.pool[this.cid]=void 0,this.attributes=void 0},remove:function(a){var b=this.get("before"),c=this.get("after");this["delete"](a),b&&b.set("after",c),c&&c.set("before",b)},detach:function(){var a=this.get("before"),b=this.get("after");a&&a.set("after",b),b&&b.set("before",a),this.set("parent",null),this.set("attachTo",null)},clearEmptyChar:function(){var a=this.attributes.text;a&&(a=a.replace(/\u200B/g,""),this.get("type")==i.line&&/\u200b +/.exec(this.attributes.text)&&(a="​"+a),this.attributes.text=a)},get:function(a){if(!this.attributes)return console.error("attributes for node has been deleted"),null;var b=this.attributes[a];switch(a){case"text":return b=b||"",l.isType(this,i.math_block)&&(b=b.replace(/^(\w*)\$\$(\w*)$/m,"$1\\$$$$$2")),b;default:return b}},set:function(a,b){var c,d,e=this.get("in"),f=function(){var c=this.get("in")||e,f="type"===a&&d===i.heading||this.get("type")==i.heading&&l.isType(a,"depth","text","parent","before","after");c&&d!=b&&f&&c.toc&&c.toc.refresh(),this.get("type")===i.def_link&&d!=b&&("ref"===a?(File.editor.imgEdit.willUpdateImgRef(d),File.editor.imgEdit.willUpdateImgRef(b)):"text"===a&&File.editor.imgEdit.willUpdateImgRef(this.get("ref")))},g=function(){var c=this.get("in")||e;"type"===a&&c&&(d===i.def_footnote&&c.foot_list.remove(this),d===i.def_link&&c.link_list.remove(this),b===i.def_footnote&&c.foot_list.push(this),b===i.def_link&&c.link_list.push(this))},h=function(){this.get("in")||e;(this.get("type")==i.meta_block&&"text"==a||"type"==a&&(d==i.meta_block||b==i.meta_block))&&File.isNode&&File.refreshImageCopyStatus(!0)};if("string"==typeof a){switch(d=this.get(a),a){case"parent":d&&d.attributes&&d.get("children").remove(this),b&&b.get("children").add(this);break;case"before":d&&d.attributes&&(d.attributes.after=null),b&&(b&&b.attributes.after&&b.attributes.after.attributes&&(b.attributes.after.attributes.before=null),b.attributes.after=this);break;case"after":d&&d.attributes&&(d.attributes.before=null),b&&(b&&b.attributes.before&&b.attributes.before.attributes&&(b.attributes.before.attributes.after=null),b.attributes.before=this);break;case"attachTo":d&&d.blocks.remove(this),b&&b.blocks.add(this);break;case"in":var j=this.get("attachTo");d&&(d.foot_list.remove(this),d.link_list.remove(this),d.blocks.remove(this),d.allNodes.remove(this)),b&&(this.get("type")!=i.def_footnote||b.foot_list.get(this.id)?this.get("type")!=i.def_link||b.link_list.get(this.id)||b.link_list.push(this):b.foot_list.push(this),b.allNodes.add(this),j&&this.set("attachTo",j));break;case"id":b&&(this.id=b,this.cid=b);break;case"ref":b=b?b.replace(/\u200b/gi,"").replace(/\\?\]/gi,"\\]"):b;break;case"href":b=b&&this.get("type")===i.def_link?b.replace(/\[|\]|"]/gi,""):b;break;case"title":break;case"type":b!=d&&(this.attributes.tail=void 0,this.attributes.ahead=void 0,this.attributes.pattern=void 0,this.attributes.subindent=void 0,this.attributes.markindent=void 0,this.attributes.mathLabel=void 0,this.attributes.mathEqLabel=void 0)}this.attributes[a]=b,f.call(this),g.call(this),h.call(this)}else{this.id||a.id||(a.id=k()),a.id&&this.set("id",a.id),a["in"]&&this.set("in",a["in"]),a.attachTo&&this.set("attachTo",a.attachTo),a.type&&this.set("type",a.type);for(c in a)-1==["in","attachTo","type"].indexOf(c)&&l.prototype.set.call(this,c,a[c])}return this}});l.property=["text","type","depth","lang","pattern","ahead","tail","header","align","style","href","title","ref","checked","history","alt","attr","isStart","meta","prespace","subindent","markindent","start"],l.isBlock=function(a,b){return f[a]||b&&g[a]},l.isVirtualBlock=function(a){return g[a]},l.canContainBlock=function(a,b){return a==i.blockquote||a==i.list||a==i.list_item||b&&(a==i.table_row||a==i.table)},l.noChangeLine=function(a){for(var b=a;b;){if(l.isType(a,i.table_cell,i.def_footnote,i.def_link))return!0;b=b.get("parent")}return!1},l.isType=function(a){if(null===a||void 0===a||a===!1)return void 0;var b="string"==typeof a?a:a.attributes.type;if(arguments[1]instanceof Array)return l.isType.apply(null,[b].concat(arguments[1]));for(var c=1;c<arguments.length;c++)if(b==arguments[c])return!0;return arguments.length>1?!1:void 0};var m=function(){this.reset(),Object.defineProperty(this,"length",{get:function(){return this._set.length}})};m.prototype.get=function(a){return this._map.get(a)},m.prototype.add=function(a){a.cid&&this._map.set(a.cid,a),this._set.push(a)},m.prototype.remove=function(a){this._set.remove(a),a.cid&&this._map["delete"](a.cid)},m.prototype.at=function(a){return this._set[a]},m.prototype.first=function(){return this._set[0]},m.prototype.sortedFirst=function(){for(var a=this.first();a&&a.get("before");)a=a.get("before");return a},m.prototype.toArray=function(){return this._set.clone()},m.prototype.reset=function(){this._set=[],this._map=new Map},m.prototype.forEach=function(a,b){this._set.clone().forEach(a,b)},m.prototype.map=function(a,b){return this._set.clone().map(a,b)},m.prototype.sortedForEach=function(a,b){for(var c=this.sortedFirst();c;)a.call(b,c),c=c.get("after")},m.prototype.update=function(a){a.cid&&this._map.set(a.cid,a)},l.pool={};var n={toHTML:function(a){var b=[];if(a.length){var c=a instanceof Array,d=c?a[0]:a.at(0);if(!c)for(;d.get("before");)d=d.get("before");do b.push(d.toHTML()),d=d.get("after");while(d&&(!c||a.indexOf(d)>-1))}return b.join("")}},o=function(){this.blocks=new m,this.allNodes=new m,this.foot_list=[],this.link_list=[]};o.prototype.storeToJson=function(){return{blocks:this.blocks.map(function(a){return a.storeToJson()}),nid:j}},o.prototype.restoreFromJson=function(a){this.reset();var b=a.blocks.map(function(a){return l.readFromJson(a,this,!0)},this);b.map(function(b,c){b.set("before",this.allNodes.get(a.blocks[c].relation.before_id)),b.set("after",this.allNodes.get(a.blocks[c].relation.after_id))},this),j=a.nid-0},o.prototype.get=function(a){switch(a){case"allNodes":return this.allNodes;case"blocks":return this.blocks}},o.prototype.reset=function(a){this.blocks.forEach(function(a){a["delete"]()}),this.blocks.reset(),!a&&this.allNodes.length&&console.warn("nodeMap not clean"),this.allNodes.reset(),this.foot_list instanceof Array?(this.foot_list=[],this.link_list=[]):(this.foot_list.reset(),this.link_list.reset()),l.pool={}},o.prototype.getFirst=function(){return this.blocks.sortedFirst()},o.prototype.getLast=function(){if(this.blocks.length>0){var a=this.blocks.at(this.blocks.length-1);return a=a.getLastBrother(!1)}return null},l.backToParagraphBeforeDelete=[i.heading,i.def_footnote,i.def_link,i.meta_block,i.fences],l.ListType={ol:"ol",ul:"ul",task:"tasklist"},b.Node=l,b.NodeMap=o,b.NodeCollection=m,b.NodeCollectionUtils=n,b.TYPE=i,l.TYPE=i}),define("app/editor/polyfill",["jquery/jquery"],function(a,b,c){"use strict";var d=a("jquery/jquery");if(window.app&&(window.open=function(a,b){app.window.openLink(a)}),"performance"in window==0&&(window.performance=window.performance||{offset:Date.now(),now:function(){return Date.now()-this.offset}}),Number.isNaN||(Number.isNaN=window.isNaN),Number.parseInt||(Number.parseInt=window.parseInt),!window.Set){var e=function(){this.set=[]};e.prototype.add=function(a){-1==!this.has(a)&&this.set.push(a)},e.prototype["delete"]=function(a){this.has(a)&&this.set.splice(this.set.indexOf(a))},e.prototype.has=function(a){return this.set.indexOf(a)>-1},window.Set=e}if(!window.Map){var f=function(){this.map={}};f.prototype.get=function(a){return this.map[a]},f.prototype["delete"]=function(a){this.map[a]=void 0},f.prototype.set=function(a,b){this.map[a]=b},window.Map=f}[].fill||(Array.prototype.fill=function(a){for(var b=Object(this),c=parseInt(b.length),d=arguments[1],e=parseInt(d)||0,f=0>e?Math.max(c+e,0):Math.min(e,c),g=arguments[2],h=void 0===g?c:parseInt(g)||0,i=0>h?Math.max(c+h,0):Math.min(h,c);i>f;f++)b[f]=a;return b}),Array.prototype.remove=function(a){var b=this.indexOf(a);return~b?this.splice(b,1):void 0},Array.prototype.repeat=function(a,b){for(;b;)this[--b]=a;return this},Array.prototype.last=function(){return this.length?this[this.length-1]:void 0},Array.prototype.lastDef=function(){for(var a=this.length-1;a>=0;a--)if(void 0!=this[a])return this[a];return void 0},Array.prototype.clone=function(){return this.slice(0)},d.fn.visibleText=function(){if(0===this.length)return"";if(1===this.length&&(3===this[0].nodeType||0===this[0].childElementCount))return this.text();var a="";return d.each(this.contents(),function(b,c){3===c.nodeType?a+=c.textContent:1===c.nodeType&&(c.offsetHeight||c.offsetWidth)&&(a+=d(c).visibleText())}),a},window.console&&(console.stack=function(a){var b=(new Error).stack;console.log(a),console.log(b)}),"undefined"==typeof NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),"undefined"==typeof HTMLCollection.prototype.forEach&&(HTMLCollection.prototype.forEach=Array.prototype.forEach)}),define("app/window/FileHelper",["app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton"],function(a,b,c){"use strict";var d=a("app/document/StringUtils"),e=a("app/editor/EditHelper"),f=window.reqnode?reqnode("electron").remote:null,g={NSChangeDone:0,NSChangeUndone:1,NSChangeCleared:2,NSChangeReadOtherContents:3,NSChangeAutosaved:4,NSChangeRedone:5},h=function(){this.doneStack=[],this.undoneStack=[],this.curState=[g.NSChangeAutosaved,new Date-0],this.lastSaved=this.curState[1]};h.prototype.isDocumentEdited=function(){return!this.curState},h.prototype.clone=function(){return{doneStack:this.doneStack.clone(),undoneStack:this.undoneStack.clone(),curState:this.curState,lastSaved:this.lastSaved}},h.prototype.reset=function(a){this.doneStack=a?a.doneStack:[],this.undoneStack=a?a.undoneStack:[],this.curState=a?a.curState:[g.NSChangeAutosaved,new Date-0],this.lastSaved=a?a.lastSaved:this.curState[1]},h.prototype.isDiscardableUntitled=function(){return!(File.fileHasModified||File.changeCounter.isDocumentEdited()||File.filePath)},h.prototype.updateChangeCount=function(a){var b,c=this.curState;switch(File.fileHasModified=File.filePath||!0,a){case g.NSChangeDone:this.curState&&this.curState[0]===g.NSChangeAutosaved&&(this.doneStack.push(this.curState),this.curState=null),this.doneStack.push([a]),this.doneStack.length>200&&this.doneStack.splice(0,this.doneStack.length-200),this.undoneStack=[];break;case g.NSChangeUndone:for(this.curState&&this.curState[0]===g.NSChangeAutosaved&&(this.undoneStack.push(this.curState),this.curState=null),this.doneStack.pop(),this.undoneStack.push([a]);(b=this.doneStack.last())&&b&&b[0]===g.NSChangeAutosaved;)this.doneStack.pop(),this.lastSaved===b[1]&&(this.curState=b);break;case g.NSChangeRedone:for(this.curState&&this.curState[0]===g.NSChangeAutosaved&&(this.doneStack.push(this.curState),this.curState=null),this.undoneStack.pop(),this.doneStack.push([a]);(b=this.undoneStack.last())&&b&&b[0]===g.NSChangeAutosaved;)this.undoneStack.pop(),this.lastSaved===b[1]&&(this.curState=b);break;case g.NSChangeCleared:File.resumeFileChangeTimestamp=new Date,this.doneStack=[],this.undoneStack=[],this.curState=[g.NSChangeAutosaved,new Date-0],this.lastSaved=this.curState[1];break;case g.NSChangeAutosaved:if(File.resumeFileChangeTimestamp=new Date,this.curState)return;this.curState=[g.NSChangeAutosaved,new Date-0],this.lastSaved=this.curState[1];break;case g.NSChangeReadOtherContents:File.resumeFileChangeTimestamp=new Date;for(var d=[],e=[],f=0;f<this.doneStack.length;f++)this.doneStack[f][0]!==g.NSChangeAutosaved&&d.push(this.doneStack[f]);for(var f=0;f<this.undoneStack.length;f++)this.undoneStack[f][0]!==g.NSChangeAutosaved&&e.push(this.undoneStack[f]);this.doneStack=d,this.undoneStack=e,this.curState=null}c!==this.curState&&File.isNodeHtml&&i()};var i=function(){if(File.changeCounter)if(File.changeCounter.curState){if((File.filePath||File.fileName)&&File.isNode){var a=f.getCurrentWindow();a.setTitle(a.getTitle().replace(/•? - Typora$/," - Typora"))}document.querySelector("#title-text").classList.remove("title-modified"),document.querySelector("#m-saved").parentElement.classList.add("saved")}else{if(document.querySelector("#title-text").classList.add("title-modified"),(File.filePath||File.fileName)&&File.isNode){var a=f.getCurrentWindow();a.setTitle(a.getTitle().replace(/•? - Typora$/,"• - Typora"))}document.querySelector("#m-saved").parentElement.classList.remove("saved")}};b.showExportDialog=function(a,b,c,g,h){var i=f.getCurrentWindow(),j=f.app,k=File.getFilePathUseNode(),l=f.dialog;k?(a=a||"md",k=k.replace(/\.[^\/\\.]+$/,"")+"."+a):k=j.getPath("userDesktop")+"/"+File.getSuggestedFileName(!0)+"."+a;var m=$.isFunction(b)?b:function(a){var f=g||function(b){b&&(e.getDialog("Error","failed to export file to <em>"+d.escape(a)+"</em>",!0,"error-dialog").modal({backdrop:"static"}),console.error(b))},h=b;a&&File.fs.writeFile(a,h,c,f)};l.showSaveDialog(i,{properties:["saveFile"],title:"Save...",defaultPath:k,filters:h?[{name:a.toUpperCase(),extensions:[a]}]:[]},m)},b.showSaveDialog=function(a,b){var c=f.getCurrentWindow(),d=f.app,e=File.getFilePathUseNode(),g=f.dialog;e||(e=d.getPath("documents")+"/"+(j(e)||File.getSuggestedFileName())+".md"),g.showSaveDialog(c,{properties:["saveFile"],title:j(e)||File.getSuggestedFileName(),defaultPath:e,filters:[{name:"Markdown",extensions:["md","markdown"]},{name:"Plain Text File",extensions:["txt","text",""]},{name:"All Files",extensions:[]}]},function(e){return e?(d.setPath("documents",reqnode("path").dirname(e)),File.fs.writeFileSync(e,File.editor.getMarkdown(),"utf8"),File.resumeFileChangeTimestamp=new Date,d.getDocumentController().getDocument(e)||(d.getDocumentController().getDocumentFromWindowId(c.id).rename(e),File.FileInfoPanel.setFileTitle(e),File.updateChangeCount(File.ChangeType.NSChangeAutosaved)),console.log("saved"),void(a&&a())):void(b&&b())})};var j=function(a){return a=a&&a.replace(/\\/g,"/"),a&&a.substring(a.lastIndexOf("/")+1)},k=function(a){return a=(a||"").replace(/\\/g,"/"),a=a&&a.substring(0,a.lastIndexOf("/")+1),File.isNode&&"win32"==process.platform?a.replace(/\//g,"\\"):a},l=function(){return File.isMac?app.document.currentFolderPath():File.isNode?k(File.filePath||""):""},m=function(){return File.isMac?app.document.currentFilePath():File.isNode?File.filePath||"":""},n=null,o=function(){return n||(n=reqnode("path").resolve(f.app.getPath("userData"),"draftsRecover"),reqnode("fs-extra").ensureDirSync(n)),n},p=function(a){return File.isNode?reqnode("path").normalize(a):app.path.normalize(a)},q=function(a){if(File.fileHasModified&&File.changeCounter.isDocumentEdited()){var b=e.getDialog("Save",document.getElementById("save_on_exit_confirm").innerHTML.trim(),!0,"three-way-dialog");b.modal({backdrop:!1,keyboard:!1}),b.off("click","#three-way-dialog-yes-btn").off("click","#three-way-dialog-yes-btn").on("click","#three-way-dialog-yes-btn",function(){b.modal("hide"),File.buildDocumentSnap(),File.saveUseNode(a)}).on("click","#three-way-dialog-no-btn",function(){b.modal("hide"),File.buildDocumentSnap(),File.getCurrentDocByNode().setLastSync(-1),a()})}else a()};b.getFileNameFromPath=j,b.normalizePath=p,b.getFileFolderPath=k,b.getCurrentFilePath=m,b.getCurrentFileFolderPath=l,b.getUnsavedDraftsPath=o,b.ChangeType=g,b.ChangeCounter=h,b.tryLeaveDocument=q,b.refreshTitlebarText=i}),define("app/editor/EditHelper",["jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/document/StringUtils"],function(a,b,c){"use strict";function d(a){if(!a)return"";var b=g(a,!0),c=document.createElement("img"),d=a.getBoundingClientRect();return c.width=d.width,c.height=d.height,c.setAttribute("src","data:image/svg+xml;base64,"+btoa(b)),c.outerHTML}function e(a,b){var c,d=a.getAttribute("width")||"",g=a.getAttribute("height")||"",h=f(b.children||[]),i=/^[\d.]+$/;c=window.getComputedStyle(a).cssText.replace(/;\s*-webkit-[^;]+;/g,""),i.test(d)&&(c=c.replace("; width: auto;","; width: "+d+"px;")),i.test(g)&&(c=c.replace("; height: auto;","; height: "+g+"px;")),b.style.cssText=c,h.length&&f(a.children||[]).forEach(function(a,b){e(a,h[b])})}function f(a){for(var b=[],c=a.length,d=0;c>d;d++)b.push(a[d]);return b}function g(a,b,c){var d=a.cloneNode(!0),f=a.getBoundingClientRect();b&&e(a,d),d.setAttribute("height",f.bottom-f.top);var g=h(d.outerHTML);return c?g:"data:image/svg+xml;charset=utf-8,"+g}function h(a){return a.replace(/xmlns:NS\d+/gi,"xmlns:xlink").replace(/NS\d+:href/gi,"xlink:href").replace(/NS\d+:space/gi,"xml:space").replace(/NS\d+:/gi,"")}function i(a,b){var c=a[0].outerHTML,d=new RegExp("<"+a[0].tagName,"i"),e=c.replace(d,"<"+b);d=new RegExp("</"+a[0].tagName+">$","i"),e=e.replace(d,"</"+b+">");var f=o(e);return a.replaceWith(f),f}function j(a,b){return b.getClosetBlock(!0)}function k(a,b,c,d,e){d=d||"quick-dialog";var f=o("#"+d);return f.find("#"+d+"-title").text(a),c?f.find("#"+d+"-message").html(b):f.find("#"+d+"-message").text(b),f.find(".btn-primary").text(e||"OK").off("click"),f}function l(a){var b=File.editor;if(s)return!(s=!1);if(a.target&&("CONTENT"==a.target.tagName||"HTML"==a.target.tagName)){var c=a.clientX,d=a.clientY,e=document.querySelector(b.sessionStr),f=o(e).offset(),g=document.createEvent("MouseEvents"),h=f.left,i=f.left+e.clientWidth,j=f.top,k=f.top+e.clientHeight;if(c>=h&&i>=c||d>=j&&k>=d)return;s=!0,c=c<f.left?f.left+1:f.left+e.clientWidth-1,d=d<f.top?f.top+1:f.top+e.clientHeight-1,a.stopPropagation(),g=document.createEvent("MouseEvents"),e=document.elementFromPoint(c,d),g.initMouseEvent("click",!0,!0,e.ownerDocument.defaultView,1,a.screenX+(c-a.clientX),a.screenY+(d-a.clientY),c,d,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button),e.dispatchEvent(g)}}function m(a){if(0===a.trim().length)return 0;var b=0,c=["d",a.replace(/[\u303F-\uFAFF]/gi,function(a){return b++," "}).replace(/(^|\s+)[!-\/:-@\[-`{-~]+(\s+|$)/gm," "),"d"].join(" ").split(/[\s!-,\.\\:-@\[-`{-~]+/g).length;return b+c-2}function n(a){if(a.match(/^#/)){var b=(a.substr(1)||"").toLowerCase().trim().replace(/-/g," ");return o("#write").find("h1, h2, h3, h4, h5, h6").filter(function(){var a=o(this).text().toLowerCase().trim().replace(/-/g," ");return a==b||a==decodeURI(b)})}}var o=a("jquery/jquery"),p=a("app/document/Node"),q=(p.Node,a("app/document/StringUtils"),a("exoskeleton-master/exoskeleton"),function(a,b){var c="<p>"+a+"<span class='btn close-btn btn-xs'><span class='glyphicon glyphicon-remove'></span></span></p>";o("#md-notification").html(c).show().delay(5e3).fadeOut()}),r=function(a,b,c){var d,e=a.offset(),f=o(editor.sessionStr).offset().left+10,g=o(editor.sessionStr).width(),h=a.find(".md-arrow"),b=b||".code-tooltip.md-hover-tip";
return b.jquery?(d=b,h=d.find(".md-arrow")):d=a.find(b),a.length?(d.css("max-width",g-60),e.top+=a.height()*(c?1:1.5)+(c?0:4),e.left+=(a.width()-d.width())/2,e.left+d.width()>window.innerWidth-10?e.left=window.innerWidth-10-d.width():e.left<f&&(e.left=f),d.css("position","absolute").offset(e),!c&&h.offset(function(b,c){var d={};return d.left=a.offset().left+a.width()/2,d.top=c.top,d}),d):(console.error("cannot fixPopoverPosition on empty $parent"),d.hide())},s=!1;b.getDialog=k,b.replaceTag=i,b.getEditParent=j,b.fixPopoverPosition=r,b.showNotification=q,b.resetClick=l,b.getWordCount=m,b.SVG2HtmlImg=d,b.svg2DataURL=g,b.processExportedSVG=h,b.findAnchorElem=n}),define("app/window/FileInfoPanel",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/window/FileHelper","app/editor/EditHelper","app/document/Node","app/editor/KeyMaster"],function(a,b,c){"use strict";function d(a){var b,c=new Date,d=(c-a)/1e3,e="";return 30>d?b="just now":60>d?b="less than one minute ago":3600>d?b=Math.floor(d/60).toString()+" minutes ago":18e3>d?(d/3600>=2&&(e="s"),b=Math.floor(d/3600)+" hour"+e+" ago"):86400>d&&c.getDay()==a.getDay()?b=Math.floor(d/3600)+" hours ago":172800>d&&c.getDay()==(a.getDay()+1)%7?b="yesterday":2592e3>d?b=Math.floor(d/86400)+" days ago":31104e3>d?(e=d/2592e3>=2?"s":"",b=Math.floor(d/2592e3)+" month"+e+" ago"):(e=d/31104e3>=2?"s":"",b=Math.floor(d/31104e3)+" year"+e+" ago"),b}function e(a){if(reqnode){var b=reqnode("fs");reqnode("path"),r.getCurrentWindow();if(s&&(s.close(),s.removeAllListeners()),a){File.resumeFileChangeTimestamp=new Date;try{s=b.watch(a,{persistent:!1}),s.on("change",function(a,b){console.debug("file "+a+"d, filename: "+b),"change"==a?File.presentedItemChanged():u()})}catch(c){console.log(c)}}}}function f(){$("#file-info-filename-input-area").hide(),$("#file-info-filename").show()}function g(a){var b=r.getCurrentWindow(),c=r.app;c.getDocumentController().getDocumentFromWindowId(b.id).rename(a),a&&x(a),File.resumeFileChangeTimestamp=new Date}function h(a){var b,c=l.getFileFolderPath(File.filePath)+a;return File.fs.existsSync(c)?(b=m.getDialog("Error -- File Exists","File or directory with name <i>"+k.escape(a)+"</i> already exist, please choose another file name",!0).modal({backdrop:!1,keyboard:!1}),void b.find(".btn-primary").one("click",function(){$("#quick-dialog").hide()})):(b=m.getDialog("Confrim","Rename file from <i>"+k.escape(File.fileName)+"</i> to <i>"+k.escape(a)+"</i> ?",!0),b.modal({backdrop:!1,keyboard:!1}),void b.find(".btn-primary").one("click",function(){return b.modal("hide"),File.fs.existsSync(c)?(r.dialog.showErrorBox("File Exists","File or directory with the given name already exists, please give a different name"),void g(c)):void File.fs.rename(File.filePath,c,function(a){a?($("#quick-dialog").hide(),console.log("renamed failed: "+a.message),r.dialog.showErrorBox("Rename Filed","Renaming operation failed due to "+a.message)):(m.showNotification("<i class='fa fa-check'></i> Rename Success ","success"),g(c))})}))}function i(){var a=$("#file-info-filename").hide(),b=$("#file-info-filename-input-area").show(),c=b.children("input"),d=b.children("#file-info-filename-input-ext"),e=a.text(),f=e.substring(0,e.lastIndexOf(".")),g=e.substring(e.lastIndexOf("."));c.val(f).focus(),d.text(g)}var j,k=a("app/document/StringUtils"),l=(a("exoskeleton-master/exoskeleton"),a("app/window/FileHelper")),m=a("app/editor/EditHelper"),n=a("app/editor/KeyMaster"),o=n.map,p=null,q=null,r=window.reqnode?reqnode("electron").remote:null,s=null,t=function(a){var b=new Date;return j=k.formateDateOnly(new Date)+" "+(a||"untitled").replace(/\.[^.]*$/,"")+" "+k.formateTimeOnly(b,!0).replace(/:/g,"")+".md"},u=function(){g(),File.filePath=void 0,File.updateChangeCount(File.ChangeType.NSChangeReadOtherContents),e(null)},v=function(a){window.debugMode&&console.warn(a)},w=function(a){if(j&&a){var b=reqnode("fs"),c=reqnode("path"),d=l.getUnsavedDraftsPath(),e=c.resolve(d,j);b.exists(e,function(){b.rename(e,c.resolve(d,t(a)),v)})}},x=function(a,b,c){var d=$("#title-text"),f=r.app,g=r.getCurrentWindow(),h=(reqnode("path"),r.Menu.getApplicationMenu().getItem("File").submenu),i=h.getItem("Open File Location"),k=h.getItem("Reopen with Encoding");if(File.fileEncode=void 0,a){i.visible=!0,k.visible=!0,$("#file-info-content").removeClass("file-info-untitled");var c=l.getFileNameFromPath(a);File.filePath=a,File.fileName=c,File.fileEncode=b,f.getDocumentController().hasDuplicateName(c)?(d.text(a),g.setTitle(a+" - Typora")):(d.text(c),g.setTitle(c+" - Typora")),$("#file-info-filename").show().text(c).attr("data-disabled","false"),$("#file-info-file-path").show().find(".file-info-field-value").text(a.substring(0,a.length-c.length)),z(a),e(a),w(c),File.editor.library&&File.editor.library.markOpenedFile(a)}else $("#file-info-content").addClass("file-info-untitled"),c?(File.fileName=c,d.text(c),g.setTitle(c+"• - Typora")):(d.text("Untitled"),g.setTitle("Untitled - Typora")),j||t(),i.visible=!1,k.visible=!1;l.refreshTitlebarText()},y=function(){function a(a){$(".info-panel-tab.active").removeClass("active"),"file"==a?(File.editor.library["switch"]("files",!0),File.option.showFileTree||B()):File.editor.library["switch"]("outline"),File.isNode&&ClientCommand.refreshViewMenu()}File.option.showFileTree?(document.querySelector("#file-library").style.display="",document.querySelector("#file-info-content").style.display="none"):(document.querySelector("#file-library").style.display="none",document.querySelector("#file-info-content").style.display=""),q||(q=setInterval(function(){A()},3e4)),$("#file-info-save-btn").click(function(){File.saveUseNode()}),$("#info-panel-tab-file").click(function(){a("file")}),$("#info-panel-tab-outline").click(function(){a("outline")}).trigger("click"),$("#file-info-filename").click(function(){"false"==this.getAttribute("data-disabled")&&i()}),$("#file-info-file-path .file-info-field-value").click(function(){$("#outline-dropmenu").removeClass("open"),r.shell.showItemInFolder(File.filePath)});var b=$("#file-info-filename-input"),c=$("#file-info-filename-input-ext");b.blur(function(){setTimeout(function(){var a=$("#file-info-filename-input:visible");if(a.length)f();else{var d=(b.val()+c.text()).trim();f(),d!=File.fileName&&h(d)}},50)}).keydown(function(a){var b=o[a.which||a.keyCode];"Esc"==b?f():"Enter"==b&&(f(),$("#file-info-filename-input").trigger("blur"))}).keypress(function(a){var b=String.fromCharCode(a.keyCode);return'\\/:*?"<>|'.indexOf(b)>-1?!1:void 0}),c.click(function(){b.val(b.val()+c.text()).focus(),c.text("")})},z=function(a){a=a||File.filePath,File.fs&&a&&File.fs.stat(File.filePath,function(a,b){b&&A(b.mtime)})},A=function(a){if(a=a||p){p=a;var b=k.formateDateTime(a);$("#file-info-last-modified .file-info-field-value").text(b),$("#file-info-last-saved-sub").text("Saved "+d(a))}},B=function(a){var b=File.editor.writingArea.innerText;void 0===a&&(a=m.getWordCount(b)),$("#file-info-field-read-value-word").text(a),$("#file-info-field-read-value-ch").text(b.length),$("#file-info-field-read-value-minutes").text(Math.floor(a/250)+1)},C=function(a){a.length&&-1==(File.filePath||"").indexOf(l.getUnsavedDraftsPath())&&reqnode("fs").writeFile(l.getUnsavedDraftsPath()+"/"+(j||t()),a,"utf8",function(a){a?v(a):w(File.fileName||File.getSuggestedFileName())})};b.watchFileChange=e,b.onPresentationMoved=u,b.setFileTitle=x,b.saveToRecover=C,b.prepareInfoPanel=y,b.setLastModified=A,b.updateContentAnalyze=B}),define("app/editor/KeyMaster",[],function(a,b,c){"use strict";function d(a,b){for(var c=a.length;c--;)if(a[c]===b)return c;return-1}function e(a,b){if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}function f(a){for(u in w)w[u]=a[C[u]]}function g(a){var b,c,e,g,h,i;if(b=a.keyCode,-1==d(B,b)&&B.push(b),(93==b||224==b)&&(b=91),b in w){w[b]=!0;for(e in y)y[e]==b&&(j[e]=!0)}else if(f(a),j.filter.call(this,a)&&b in v)for(i=p(),g=0;g<v[b].length;g++)if(c=v[b][g],c.scope==i||"all"==c.scope){h=c.mods.length>0;for(e in w)(!w[e]&&d(c.mods,+e)>-1||w[e]&&-1==d(c.mods,+e))&&(h=!1);(0!=c.mods.length||w[16]||w[18]||w[17]||w[91])&&!h||c.method(a,c)===!1&&(a.preventDefault?a.preventDefault():a.returnValue=!1,a.stopPropagation&&a.stopPropagation(),a.cancelBubble&&(a.cancelBubble=!0))}}function h(a){var b,c=a.keyCode,e=d(B,c);if(e>=0&&B.splice(e,1),(93==c||224==c)&&(c=91),c in w){w[c]=!1;for(b in y)y[b]==c&&(j[b]=!1)}}function i(){for(u in w)w[u]=!1;for(u in y)j[u]=!1}function j(a,b,c){var d,e;d=r(a),void 0===c&&(c=b,b="all");for(var f=0;f<d.length;f++)e=[],a=d[f].split("+"),a.length>1&&(e=s(a),a=[a[a.length-1]]),a=a[0],a=A(a),a in v||(v[a]=[]),v[a].push({shortcut:d[f],scope:b,method:c,key:d[f],mods:e})}function k(a,b){var c,d,f,g,h,i=[];for(c=r(a),g=0;g<c.length;g++){if(d=c[g].split("+"),d.length>1&&(i=s(d),a=d[d.length-1]),a=A(a),void 0===b&&(b=p()),!v[a])return;for(f in v[a])h=v[a][f],h.scope===b&&e(h.mods,i)&&(v[a][f]={})}}function l(a){return"string"==typeof a&&(a=A(a)),-1!=d(B,a)}function m(){return B.slice(0)}function n(a){var b=(a.target||a.srcElement).tagName;return!("SELECT"==b)}function o(a){x=a||"all"}function p(){return x||"all"}function q(a){var b,c,d;for(b in v)for(c=v[b],d=0;d<c.length;)c[d].scope===a?c.splice(d,1):d++}function r(a){var b;return a=a.replace(/\s/g,""),b=a.split(","),""==b[b.length-1]&&(b[b.length-2]+=","),b}function s(a){for(var b=a.slice(0,a.length-1),c=0;c<b.length;c++)b[c]=y[b[c]];return b}function t(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,function(){c(window.event)})}var u,v={},w={16:!1,18:!1,17:!1,91:!1},x="all",y={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,command:91},z={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},A=function(a){return z[a]||a.toUpperCase().charCodeAt(0)},B=[];for(u=1;20>u;u++)z["f"+u]=111+u;var C={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey"};for(u in y)j[u]=!1;t(document,"keydown",function(a){g(a)}),t(document,"keyup",h),t(window,"focus",i);var D=j;c.exports=D,D.setScope=o,D.getScope=p,D.deleteScope=q,D.filter=n,D.isPressed=l,D.getPressedKeyCodes=m,D.unbind=k,"undefined"!=typeof c&&(c.exports=D);var E={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",91:"Command",107:"=",109:"-",127:"Delete",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"};D.map=E,D.functionKey=["Command","Ctrl","Shift","Alt","Home","End","PageUp","PageDown","CapsLock","Esc","PrintScrn","Insert","Pause"],D.handleCtrlDown=function(a){$(a.sessionStr+" a").attr("contenteditable",!0)},D.isCommand=function(a){return String.fromCharCode(a.which).length>0&&(a.ctrlKey||a.metaKey)},D.handleCtrlUp=function(a){$(a.sessionStr+" a").attr("contenteditable",!1)}}),define("app/editor/Editor",["app/editor/polyfill","jquery/jquery","app/document/StringUtils","exoskeleton-master/exoskeleton","app/document/Node","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/UndoManager","app/editor/Emoji","app/document/Node2Mark","app/document/Node2HTML","app/document/NodeOperation","app/editor/Diagram","codemirror/lib/codemirror","app/editor/KeyMaster","rangy/rangy-core","app/editor/Fences","autoComplete","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint","app/editor/MathBlock","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","app/editor/MathInline","rangy/rangy-classapplier","app/editor/Brush","app/editor/Stylize","app/editor/Selection","app/editor/EditHelper","app/editor/TableEdit","app/editor/polyfill","app/editor/ImageEdit","app/editor/UserOp","app/editor/TableEdit","app/editor/ConvertUtils","app/window/FileHelper","app/editor/Selection","app/editor/UndoManager","app/editor/KeyMaster","app/editor/UserOp","app/window/FileInfoPanel","app/document/File","app/editor/DocMenu","app/editor/Stylize","app/editor/SearchPanel","app/editor/Emoji","app/editor/Word","app/document/Export","app/document/Node2Native","app/editor/SourceView","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","app/editor/QuickOpenPanel","app/window/Library"],function(a,b,c){"use strict";var d=(a("app/editor/polyfill"),a("jquery/jquery")),e=a("app/document/StringUtils"),f=a("exoskeleton-master/exoskeleton"),g=a("app/document/Node"),h=g.Node,i=g.TYPE,j=a("app/document/MarkParser"),k=(a("app/document/Node2Mark"),a("app/document/Node2HTML"),a("app/document/NodeOperation"),a("app/editor/Fences")),l=a("app/editor/MathBlock"),m=a("app/editor/MathInline"),n=a("app/editor/Brush"),o=a("app/editor/Selection"),p=o.rangy,q=a("app/editor/EditHelper"),r=a("app/editor/TableEdit"),s=a("app/editor/ImageEdit"),t=a("app/editor/UndoManager"),u=t.SnapFlag,v=a("app/editor/KeyMaster"),w=v.map,x=a("app/editor/UserOp"),y=a("app/window/FileInfoPanel"),z=a("app/document/File"),A=a("app/editor/DocMenu"),B=a("app/editor/Stylize"),C=a("app/editor/SearchPanel"),D=a("app/editor/Emoji"),E=a("app/editor/Word"),F=a("app/document/Export"),G=a("app/editor/SourceView"),H=a("app/window/FileHelper"),I=a("app/editor/QuickOpenPanel"),J=a("app/window/Library"),K=window.reqnode?reqnode("electron").remote:null;!function(){var a=d.fn.replaceWith;d.fn.oldReplaceWith=a,d.fn.replaceWith=function(b){var c=this.parent().closest("li");a.apply(this,arguments),c.length&&(c.css("margin","0.1px"),c.css("margin",""))}}();var L,M,N,O=180,P=0,Q=null,R=f.Model.extend({constructor:function(a,b){console.time("putHTML"),this.sessionStr=a,this.EditHelper=q,this.MarkParser=j,b.setTheme(),b.setEditor(this),this.nodeMap=new g.NodeMap,this.writingArea=document.querySelector(this.sessionStr),b.readOption();var c=void 0,e=b.getDocumentSnap();this.imgEdit=new s(this),this.docMenu=new A(this),this.undo=new t(this),b.option.showFileTree&&(e||{}).nodeMap?(b.isNode&&y.setFileTitle(b.getFilePathUseNode(),e.fileEncode),b.restoreEditStateFromData(e,!1,!0)):(c=b.getContent(),this.reset(c)),console.timeEnd("putHTML"),this._bindGlobal(),this._bindKeyEvents(),this._bindMouseEvents(),this.focusCid=null,this.selection=new o(this),this.keypressMsg="",this.mathInline=new m(this),this.brush=new n(this),this.tableEdit=new r(this),this.fences=new k(this),this.mathBlock=new l(this),this.stylize=new B(this),setTimeout(function(){this.refresh(),this.selection.unlockScroll()}.bind(this),500),this.brush.run(),this.UserOp=x,this.searchPanel=new C(this),this.writingArea.setAttribute("contenteditable","true"),this.writingArea.focus(),this.sourceView=new G(this),void 0!=c&&c.trim().length?(this.selection.lockScroll(),this.selection.jumpIntoElemEnd(d("[cid]").last())):(document.querySelector(this.sessionStr+">*:first-child").classList.add("md-focus"),this.selection.jumpTop()),this.emoji=new D(this),this.word=new E(this),this["export"]=new F(this),(b.isMac||b.isNode)&&setTimeout(b.bindMenu,200),b.freshLock(),this.quickOpenPanel=new I(this),this.quickOpenPanel.init(),this.library=new J(this),this.library.init(),this.docMenu.restoreOutlineState()},reset:function(a){var b=new g.Node({type:g.TYPE.raw_edit,"in":this.nodeMap,attachTo:this.nodeMap,text:a});this.writingArea.innerHTML=b.parseFrom({skips:{old_code:!1}})[0]},resizeDef:function(a){var b=this;if(!(b.nodeMap.foot_list.models.length+b.nodeMap.link_list.models.length>30)){var c=b.nodeMap.foot_list.models.reduce(function(a,c){var d=b.findElemById(c.id),e=d.find(".md-def-f").css("width","").width()+d.find(".md-def-name").width();return a>e?a:e},0);c=b.nodeMap.link_list.models.reduce(function(a,c){var d=b.findElemById(c.id),e=d.find(".md-def-f").css("width","").width()+d.find(".md-def-name").width();return a>e?a:e},c),this.maxDefLength=c,b.nodeMap.link_list.models.map(function(a){var d=b.findElemById(a.id),e=d.find(".md-def-name").width();b.findElemById(a.id).find(".md-def-f").css("width",c-e)}),b.nodeMap.foot_list.models.map(function(a){var d=b.findElemById(a.id),e=d.find(".md-def-name").width();b.findElemById(a.id).find(".md-def-f").css("width",c-e)})}},refresh:function(a){if(this.sourceView&&this.sourceView.inSourceMode)return void(a&&this.sourceView.cm.refresh());if(this.brush){var b=this;L&&clearTimeout(L),L=setTimeout(function(){b.resizeDef(),b.writingArea.setAttribute("contenteditable","true")},30),d(b.writingArea).find(".md-mathjax-panel").length||(b.mathBlock.currentCm=void 0),b.nodeMap.toc.refresh(!0),b.fences.modeLoaded&&b.fences.refreshEditor(void 0,a),b.diagrams.modeLoaded&&b.diagrams.refreshDiagram(a),b.mathBlock.renderAll(),b.mathInline.renderAll(),b.brush&&b.stylize&&(b.brush.expand(),b.brush.updateWordCount(),z.isNode&&z.refreshImageCopyStatus(!0)),d("#typora-table-row-tracker, #typora-table-col-tracker").hide(),b.selection.scrollAdjust()}},getJQueryElem:function(a){return a?d(a.nodeType==a.ELEMENT_NODE?a:a.parentNode):d()},getMarkElem:function(a){if(!a&&document.activeElement.nodeType==window.Node.ELEMENT_NODE&&(document.activeElement.hasAttribute("tabindex")||h.isType(document.activeElement.tagName,"TEXTAREA","INPUT")))return d(document.activeElement).closest("[cid]");if(a=a||window.getSelection().anchorNode||document.activeElement,!a)return[];var b=d(a.nodeType==a.ELEMENT_NODE?a:a.parentNode);return!b.length||"TH"!==b[0].tagName&&"TD"!==b[0].tagName||(b=b.children(".td-span")),e.isNullOrEmpty(b.attr("cid"))&&(b=b.closest("[cid]")),b},autoRemoveUnholdable:function(a){var b=this.focusCid&&this.findElemById(this.focusCid).closest(".unholdable");if(b&&b.length)try{var c=this.findNodeByElem(b).getClosetParagraphLevel(),a=a||t.makeEmptyCommand(this.selection.buildUndo());b.text().length||b.children(".md-line").length>1?b.removeClass("unholdable"):(this.undo.UndoManager.addUndoForRemove(a,c),a.redo.push(this.selection.buildUndo()),c.remove(),b.remove(),this.undo.register(a),this.focusCid=null)}catch(d){console.warn(d.stack)}},store:function(a,b){if((!this.sourceView||!this.sourceView.inSourceMode)&&(a=a?a:this.focusCid)){var c=a.id?a:this.nodeMap.get("allNodes").get(a);if(c){var d=this.findElemById(c.id);if(!(d.length>0))return void(this.focusCid=null);var e=d.textExcludeSVG(!0);return h.isType(c,c.TYPE.meta_block)?(e=e.replace(/\n$/,""),c.set("text",e)):h.isType(c,c.TYPE.math_block)?this.mathBlock.syncToNode(c):h.isType(c,c.TYPE.def_footnote,c.TYPE.def_link)?(h.reverseAttrFromElem(c,d),!b&&this.resizeDef()):c&&!d[0].querySelector("[cid]")?c.get("type")==c.TYPE.fences&&d.find(".CodeMirror-code").length?this.fences.syncToNode(c):(c.set("text",e),c.clearChildren()):b&&c.get("children").map(function(a){d[0].querySelector("[cid='"+a.cid+"']")?this.store(a):a.remove()},this),h.isType(c,c.TYPE.meta_block)&&!b&&this.imgEdit.updateLocalRootUrl(),c}}},cleanTooltip:function(){d(this.sessionStr).find(".md-tooltip-hide").hide(),W(),this.mathBlock.stopEditing()},refocus:function(a,b,c){function e(){var a=i.findElemById(i.focusCid).trigger("blur").trigger("losefocus");a.find(".md-tooltip-hide").hide(),W()}if(!this.sourceView||!this.sourceView.inSourceMode){var f,g,h=a?this.findElemById(a):this.getMarkElem(),i=this,j=this.nodeMap.allNodes.get(this.focusCid),k=i.findElemById(this.focusCid);if(i.docMenu.autoHideOutline(),a=void 0===a?h.attr("cid"):a,b&&a&&i.store(a),this.focusCid!=a||!h.hasClass("md-focus")){if(this.focusCid!=a&&e(),d(document.activeElement).trigger("focus"),h.addClass("md-focus").trigger("refocus"),this.focusCid==a)return;if(this.undo.noStashedUndo()&&(g=this.undo.completeSnap(!0,!0),this.store(this.focusCid),this.lastCursor&&this.lastCursor.startId==this.lastCursor.endId&&(this.lastCursor.id=this.lastCursor.startId),g&&this.lastCursor&&this.focusCid==this.lastCursor.id&&(g.redo.push(this.lastCursor),i.undo.register(g,!0),g=null)),z.option.expandSimpleBlock&&(this.focusCid=x.simpleExpand(this,a))?("block"==document.querySelector("#md-searchpanel").style.display&&this.searchPanel.closePanel(),a=this.focusCid):this.focusCid=a,z.isLocked)return;this.focusCid&&j&&!(d.contains(k,h)||d.contains(h,k)||h.length&&h.is(k))&&(j.clearEmptyChar(),f=this.simpleParse(j),f&&(f[0].undo[0]=i.lastCursor,setTimeout(function(){f[0].redo.push(i.selection.buildUndo()),i.findElemById(f[2]).replaceWith(f[1]),g&&(t.append(g,f[0]),f[0]=g),i.undo.noStashedUndo()?i.undo.register(f[0],!0):i.undo.stashUndo(f[0]),i.refresh(),i.undo.exeCommand(f[0].redo.last())},50))),!f&&g&&this.undo.register(g,!0),this.docMenu.highlightVisibleHeader(),this.focusCid&&this.brush.focusContainer(h)}return i.isIME=0,c||setTimeout(this.brush.expand.bind(this.brush),30),a}},_bindGlobal:function(){function a(){v("command+z, ctrl+z",function(a){return z.isLocked?!1:void l.undo.undo(a)}),v("command+y, ctrl+y",function(a){return z.isLocked?!1:void l.undo.redo(a)}),v("command+l, ctrl+l",function(a){a.preventDefault(),l.selection.selectLine()}),v("command+d, ctrl+d",function(a){a.preventDefault(),l.selection.selectWord()}),v("command+e, ctrl+e",function(a){a.preventDefault(),l.selection.selectPhrase()}),v("command+b, ctrl+b",function(a){return z.isLocked?!1:(a.preventDefault(),void l.stylize.toggleStyle(g.TYPE.strong))}),v("command+i, ctrl+i",function(a){return z.isLocked?!1:(a.preventDefault(),void l.stylize.toggleStyle(g.TYPE.em))}),v("command+u, ctrl+u",function(a){return z.isLocked?!1:(a.preventDefault(),void l.stylize.toggleStyle(g.TYPE.underline))}),v("command+a, ctrl+a",function(a){z.editor.sourceView.inSourceMode||!d(document.activeElement).closest("#write").length||(a.preventDefault(),z.editor.selection.selectAll(),z.editor.brush.expand())})}function b(){v("ctrl+b",function(a){return z.isLocked?!1:(a.preventDefault(),void l.stylize.toggleStyle(g.TYPE.strong))}),v("ctrl+i",function(a){return z.isLocked?!1:(a.preventDefault(),void l.stylize.toggleStyle(g.TYPE.em))}),v("ctrl+u",function(a){return z.isLocked?!1:(a.preventDefault(),void l.stylize.toggleStyle(g.TYPE.underline))}),v("ctrl+a",function(a){a.preventDefault(),z.isNode&&ClientCommand.selectAll()})}function c(){v("shift+command+l, shift+ctrl+l",function(a){return z.isLocked?!1:(a.preventDefault(),void x.deleteLine(l))}),v("shift+command+e, shift+ctrl+e",function(a){return z.isLocked?!1:(a.preventDefault(),l.selection.selectPhrase(),void x.backspaceHandler(l,null,"delSelection"))}),v("shift+command+d, shift+ctrl+d",function(a){return z.isLocked?!1:(a.preventDefault(),l.selection.selectWord(),void x.backspaceHandler(l,null,"delSelection"))}),v("command+=, ctrl+]",function(a){var b=l.getMarkElem(),c=b.attr("mdtype");h.isType(c,i.heading,i.line)&&l.stylize.changeHeadingLevel(l.findNodeByElem(b),!0),a.preventDefault(),a.stopPropagation()}),v("command+-, ctrl+[",function(a){var b=l.getMarkElem(),c=b.attr("mdtype");h.isType(c,i.heading,i.line)&&l.stylize.changeHeadingLevel(l.findNodeByElem(b),!1),a.preventDefault(),a.stopPropagation()}),z.isMac?(v("ctrl+k",function(a){var b=l.selection.getRangy();if(b&&!h.isType(document.activeElement.tagName,"INPUT","TEXTAREA")){if(b.collapsed){var c=l.getMarkElem();b.setEnd(c[0],c[0].childNodes.length),l.selection.setRange(b)}b.toString().length?x.backspaceHandler(l,a,"delSelection"):x.backspaceHandler(l,a,!0),a.preventDefault(),a.stopPropagation()}}),v("ctrl+h",function(a){var b=l.selection.getRangy();b&&!h.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&x.backspaceHandler(l,a,"Backspace")}),v("ctrl+d",function(a){var b=l.selection.getRangy();b&&!h.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&x.backspaceHandler(l,a,"Delete")}),v("ctrl+tab",function(a){z.isMac&&app.window.selectNextTab()}),v("ctrl+shift+tab",function(a){z.isMac&&app.window.selectPreviousTab()}),v("command+y",function(a){return z.isLocked?!1:(l.undo.completeSnap(!0),z.editor.undo.redo(a),void z.freshMenu())})):z.isNode?(v("ctrl+home",function(a){z.editor.selection.jumpTop()}),v("ctrl+end",function(a){z.editor.selection.jumpBottom()}),v("ctrl+z, command+z",function(a){return ClientCommand.undo(),!1}),v("ctrl+y, command+y, command+shift+z, ctrl+shift+z",function(a){return ClientCommand.redo(),!1}),b()):a()}function f(a){if(window.app){if(app.document.isLocked())return}else if(z.isLocked)return!1;l.sourceView.inSourceMode||l.imgEdit.doInsertFromURL(a)}function j(){d(".md-table-edit").length&&l.tableEdit.resizeTableEdit(d(".md-table-edit")),d(".typora-table-tracker").hide()}var k,l=this;c(),d(document).on("dragenter",function(a){}).on("dragover",function(a){}).on("drop",function(a){function b(){if(ClientCommand.validatePandocInstall())if(z.fileHasModified)if(z.changeCounter.isDiscardableUntitled())window.getSelection().removeAllRanges(),ClientCommand.doImport(e.escapeInQuote(d[0].path));else{var a=K.app.openFile();a.webContents.once("did-finish-load",function(){a.webContents.executeJavaScript('setTimeout(function(){window.getSelection().removeAllRanges();ClientCommand.doImport("'+e.escapeInQuote(d[0].path)+'")}, 200)')})}else ClientCommand.doImport(d[0].path)}var c=a.originalEvent.dataTransfer.getData("text/html"),d=a.originalEvent.dataTransfer.files;if(c){if(z.isLocked)return!1;x.pasteHandler(l,c)}else if(d&&d.length&&z.isNodeHtml)for(var g=0;g<d.length;g++){var h,i=d[g];if(h=i.path.match(/(?:^|\.)([^.]+)$/)){if(h=h[1],~["latex","ltx","tex","wiki","dokuwiki","docx","rst","rest","org","textile","opml"].indexOf(h))return b(),!1;if(~["txt","text","md","mmd","markdown","mdown",""].indexOf(h))return K.app.openFile(d[0].path),!1}if(z.isLocked)return!1;g>0&&l.UserOp.insertParagraph(!1,l),f(i.path)}a.stopPropagation(),a.preventDefault()}).on("dragfile",function(a){try{if(window.app&&app.document.isLocked())return!1;if(z.isLocked&&!z.isMac)return!1;var b,c=a.originalEvent.data.urls;c.map(function(a,c){return(b=a.match(/(?:^|\.)([^.]+)$/))&&(b=b[1],~["txt","text","latex","ltx","tex","wiki","dokuwiki","docx","rst","rest","org","textile","opml","md","mmd","markdown","mdown","multimarkdown",""].indexOf(b))?void app.app.openInTypora(a):(c>0&&l.UserOp.insertParagraph(!1,l),void f(a))})}catch(a){}}).on("paste",this.sessionStr,function(a){if(z.isLocked)return!1;if(!l.sourceView.inSourceMode)return x.pasteHandler(l,a.originalEvent,z._PasteContentFlag)}).on("pasteAsPlainText",this.sessionStr,function(a){if(z.isLocked)return!1;if(!l.sourceView.inSourceMode)return x.pasteHandler(l,a.originalEvent,!0)}).on("copy",this.sessionStr,function(a){console.log("on copy"),h.isType(document.activeElement.tagName,"INPUT","TEXTAREA")||(l.refocus(void 0,!0),x.copyHandler(l,a.originalEvent))}).on("cut",this.sessionStr,function(a){return z.isLocked?!1:h.isType(document.activeElement.tagName,"INPUT","TEXTAREA")?!0:z.isNode?(z._CopyContentFlag="cut_before",K.getCurrentWindow().webContents.copy(),!1):(l.refocus(void 0,!0),l.snapSelection=l.selection.buildUndo(),x.copyHandler(l,a.originalEvent),x.backspaceHandler(l,a,"delSelection"),void 0)}).on("contextmenu",function(a){var b=d(a.target);if(!b.closest(".CodeMirror").length)if("IMG"===a.target.tagName&&0==b.closest(".md-image.md-expand").length){var c=d(a.target).closest(".md-image").addClass("md-expand"),e=p.createRange(),f=c.children(".md-meta")[0].length;e.moveToBookmark({containerNode:c.children(".md-meta")[0],start:f-1,end:f-1}),l.selection.setRange(e)}else l.brush.expand()}).on("inline-input",function(a){l.selection.scrollAdjust()}).on("click","#md-notification .undo-btn",function(){l.undo.undo(),d("#md-notification").fadeOut()}).on("click","#md-notification .ok-btn",function(){d("#md-notification").fadeOut()}).on("click",q.resetClick),d(window).on("resize",function(){clearTimeout(k),k=setTimeout(j,300)}),d(l.sessionStr).on("change","[type='checkbox']",function(){var a=this.parentElement.getAttribute("cid"),b=this.checked;b?this.setAttribute("checked","checked"):this.removeAttribute("checked"),l.getNode(a).attr("checked",b,l,!1)}),document.addEventListener("selectionchange",function(a){var b;z.isNodeHtml&&(b=l.selection.getRangy(),d("svg.in-text-selection").attr("class",""),b&&b.getNodes([1],function(a){"svg"===a.tagName&&a.classList.add("in-text-selection")})),z.isFocusMode&&Y.call(l)},!1)},_bindKeyEvents:function(){function a(a){a?d("a, .md-def-url, .md-url").css("cursor","pointer"):d("a, .md-def-url, .md-url").css("cursor","")}var b=this,c=!1,e=!1,f=!1;b.isIME=0,d("body").on("keydown",function(a){if(b.docMenu.autoHideOutline(),document.body.classList.remove("show-word-count"),document.activeElement==document.body){var c=a.keyCode||a.which;d(b.sessionStr).focus(),("Delete"==w[c]||"Backspace"==w[c]||"Enter"==w[c])&&a.preventDefault()}return z.isNodeHtml&&z.contextMenu.handleKeyEvent(a)?!1:void 0}),d(b.sessionStr).on("keydown",function(e){b.keypressMsg=null;var g=e.keyCode||e.which,i="TEXTAREA"==e.target.tagName||"INPUT"==e.target.tagName;if(229!=g){if(z.isNodeHtml&&z.contextMenu.handleKeyEvent(e))return!1;if(d(".dropdown-menu.open:not(#outline-dropmenu), .dropdown-menu.show").removeClass("open").removeClass("show"),("Ctrl"==w[g]||"Command"==w[g])&&a(!0),h.isType(w[g],"Right","Left","Up","Down")){var j;if(d(".context-menu:visible").length&&b.contextmenu.handleArrowKey(w[g]),"INPUT"==e.target.tagName&&e.target.classList.contains("mode")&&!e.ctrlKey&&!e.metaKey){if("Left"==w[g]&&0==e.target.selectionStart&&0==e.target.selectionEnd)return b.selection.moveUpOrDown(!0,e,!0),!1;if("Right"==w[g]&&e.target.selectionStart==e.target.selectionEnd&&e.target.selectionEnd==e.target.value.length)return b.selection.moveUpOrDown(!1,e,!0),!1}if(i&&h.isType(w[g],"Right","Left"))return;if(e.ctrlKey||e.metaKey){if(z.isMac&&e.metaKey&&("Up"==w[g]||"Down"==w[g]))return"Up"==w[g]?b.selection.jumpTop(e.shiftKey):b.selection.jumpBottom(e.shiftKey),!1;if(e.target.classList&&e.target.classList.contains("md-def-name")&&"Right"===w[g])return b.selection.jumpIntoElemEnd(d(e.target).closest("[mdtype]")),!1;if(j=b.selection.getRangy())if(z.isNodeHtml&&e.ctrlKey&&("Left"==w[g]||"Right"==w[g]),"Left"==w[g]){var k=d(j.startContainer).closest("[mdtype]");k.find("[md-inline]").first().addClass("md-expand")}else if("Right"==w[g]){var k=d(j.endContainer).closest("[mdtype]");k.find("[md-inline]").last().addClass("md-expand")}}if(z.isMac&&e.metaKey){var l={};d.extend(l,e),l.type="keyup",setTimeout(function(){d(e.target).trigger(l)},10)}e.shiftKey&&d(".md-focus .md-math-after-sym").text("​"),"Right"==w[g]||"Left"==w[g]?(b.lastCursor=b.selection.buildUndo(),b.brush.isAutoCompleteShown()&&b.brush.triggerAutoComplete(),!e.shiftKey&&b.selection.moveLeftOrRight("Left"==w[g],e)):("Up"==w[g]||"Down"==w[g])&&(b.lastCursor=b.selection.buildUndo(),b.brush.isAutoCompleteShown()?e.shiftKey?b.brush.hideAutoComplete():b.brush.changeAutoCompleteSelection("Up"==w[g],e):!e.shiftKey&&b.selection.moveUpOrDown("Up"==w[g],e))}else if(z.isLocked)return!0;if(!i){if("Esc"==w[g]){if(d("#table-insert-dialog:visible").modal("hide").length)return void d(z.editor.sessionStr).trigger("cursorChange");b.brush.triggerAutoComplete(!0),e.preventDefault()}else if("Tab"==w[g]){if(e.metaKey||e.ctrlKey||e.altKey)return;e.preventDefault();var m=e.shiftKey?x.lessIndent(b):x.moreIndent(b);if(!m){var n=b.getMarkElem();n.hasClass("md-def-link");if(n.closest(".md-table").length)b.tableEdit.moveToNextCell(!0,e.shiftKey);else if(n.hasClass("md-def-link")||n.hasClass("md-def-footnote")){var o=b.getJQueryElem(window.getSelection().anchorNode).closest("span[contenteditable]");e.shiftKey?b.selection.selectAllElem(d(o.prevAll("span[contenteditable='true']")[0])):b.selection.selectAllElem(d(o.nextAll("span[contenteditable='true']")[0]))}else e.shiftKey||(b.selection.prepNode("	",e),x.insertInlineText(b,null,"	",b.selection.getOffset(n),null,!0),
b.refocus(),b.brush.addToQueue(b.focusCid))}}else if("Backspace"==w[g]||"Delete"==w[g])if(z.isNodeHtml){var p=!0;f?e.preventDefault():(f=!0,e.ctrlKey&&(b.selection.getRangy()||{}).collapsed?x.backspaceHandler(b,e,w[g]):p=x.backspaceHandler(b,e,w[g],!1,!0),null===p?(f=!1,b.undo.snap(b.focusCid||b.getMarkElem().attr("cid"),u.DELETE),b.brush.addToQueue(b.focusCid)):(e.preventDefault(),setTimeout(function(){f=!1},20)))}else{if(e.metaKey){var n=b.getMarkElem(window.getSelection().commonAncestorContainer);n.hasClass("md-expand");n.addClass("md-expand"),window.getSelection().modify("extend","backward","lineboundary")}x.backspaceHandler(b,e,w[g])}else if("Enter"==w[g]){if(d(".auto-suggest-container:visible .active").length)return b.brush.applyAutocompleteByKey(),void e.preventDefault();U.call(b,e.metaKey||e.ctrlKey,e.shiftKey),e.preventDefault()}c&&g==this.lastKey&&[224,17,91,93].indexOf(g)>-1&&this.lastKeyTime&&performance.now()-this.lastKeyTime<300?(e.preventDefault(),b.refocus(void 0,!0),this.lastKey=0):(this.lastKey=e.keyCode,this.lastKeyTime=performance.now()),c=!1}}}).on("keypress",function(a){var c=a.keyCode||a.which;if(z.isLocked&&a.charCode>0)return a.ctrlKey||a.metaKey;var d=b.findNodeByElem(b.getMarkElem());if("TEXTAREA"!=a.target.tagName&&"INPUT"!=a.target.tagName&&!v.isCommand(a)){if(!d||d.canNotDirectEdit())return a.preventDefault();if("Enter"==w[c])a.preventDefault();else if(a.charCode>0&&window.getSelection().rangeCount){b.lastKeyPressOn=new Date,b.selection.prepNode(String.fromCharCode(a.charCode),a);var e=b.getMarkElem().attr("cid");e!=b.focusCid&&b.refocus(e),b.brush.addToQueue(b.focusCid)}}}).on("keyup",function(f){c=!0;var g=f.keyCode||f.which;("CTRL"==w[g]||"Command"==w[g])&&a(!1),"TEXTAREA"!=f.target.tagName&&"INPUT"!=f.target.tagName&&("Right"==w[g]||"Left"==w[g]||"Up"==w[g]||"Down"==w[g]?(e=f.shiftKey,!e&&!b.isIME&&b.refocus()):e&&"Shift"==w[g]?(e=!1,!b.isIME&&b.refocus()):"Enter"==w[g]&&!function(){var a=d("#write .md-focus");2==a.length&&a.get(0).getAttribute("cid")===a.get(1).getAttribute("cid")?(d(a.get(1)).remove(),b.selection.jumpIntoElemEnd(d(a.get(0))),U.call(b,f.metaKey||f.ctrlKey,f.shiftKey)):a.next("div:not('[mdtype]')").remove().length&&U.call(b,f.metaKey||f.ctrlKey,f.shiftKey)}())}).on("compositionend",function(a){if(console.log("compositionend"),"TEXTAREA"!=event.target.tagName&&"INPUT"!=event.target.tagName){var c=b.getMarkElem();b.focusCid=b.getMarkElem().attr("cid"),b.brush.addToQueue(b.focusCid),b.isIME=0,setTimeout(function(){c.trigger("inline-input"),b.writingArea.setAttribute("contenteditable","true"),b.brush.brushQueue()},0)}}).on("compositionstart",function(a){"TEXTAREA"!=event.target.tagName&&"INPUT"!=event.target.tagName&&(b.isIME=1,b.selection.prepNode("",a,void 0,!0),z.isMac&&(b.writingArea.setAttribute("contenteditable","false"),d(".md-focus").attr("contenteditable","true")))}).on("input",function(a){h.isType(a.target.tagName,"INPUT","TEXTAREA")||b.focusCid&&b.syncChange([{type:"sync",id:b.focusCid,html:b.findElemById(b.focusCid).html()}])})},tryOpenLink:function(a,b){if(b&&(a=M),a.length){var c=a.attr("href"),e=d("#need_def_link").html();if(this.undo.completeSnap(!0),a[0].hasAttribute("data-ref")){var f=a.data("ref");if(c=this.nodeMap.link_list.getHrefByRef(f,!0),void 0===c)return q.showNotification(e.format(f,f),"warning"),!z.isLocked&&this.docMenu.addEmptyDef(f,g.TYPE.def_link),!1;if(""===c)return q.showNotification(e.format(f,f),"warning"),!1}c&&this.tryOpenUrl_(c)}},tryOpenUrl_:function(a){if(a.match(/^#/)){var b=q.findAnchorElem(a);this.selection.jumpIntoElemBegin(b),this.selection.scrollAdjust(b,10)}else{if(!a.match(/:\/\//)){if(a=a.replace(/([#?][^.]+)$/,""),z.isMac&&window.app.path.openURL(decodeURI(a),(H.getCurrentFileFolderPath()||"")+"/"))return;if(z.isNode){var c=reqnode("fs"),d=reqnode("path"),e=d.resolve(H.getCurrentFileFolderPath()+"/",decodeURI(a));if(c.statSync(e))return void K.shell.openItem(e)}a="http://"+a}window.open(a)}},_bindMouseEvents:function(){var a=this,b=!1;d(this.sessionStr).on("mouseover",".footnotes, .md-table, .task-list-item, .md-inline-math",function(a){1==a.which&&d(this).attr("contenteditable",!0).find(".md-math-after-sym").text("​")}).on("mouseenter",'[mdtype="heading"], [mdtype="paragraph"]',function(a){1==a.which&&d(this).find(".md-math-after-sym").text("​")}).on("mouseup",function(c){function e(){if(j=d(a.writingArea).find(".unholdable"),!j.length||j.find("[cid='"+a.focusCid+"']").andSelf("[cid='"+a.focusCid+"']").length);else if(j.text().length||j.children(".md-line").length>1)j.removeClass("unholdable");else{var b=t.makeEmptyCommand(a.selection.buildUndo()),c=a.findNodeByElem(j).getClosetParagraphLevel();a.undo.UndoManager.addUndoForRemove(b,c),b.redo.push(a.selection.buildUndo()),c.remove(),j.remove(),a.undo.register(b)}}function f(){z.isTypeWriterMode&&z.option.scrollWithCursor?a.selection.typeWriterScroll(null,null,function(){a.refocus(k)}):a.refocus(k)}d(".footnotes, .md-table, .task-list-item").attr("contenteditable",!1);var g=a.selection.getRangy();if(g&&!g.collapse&&h.isType(g.commonAncestorContainer.tagName,"LI","UL","QUOTEBLOCK","ARTICLE")&&a.refocus(null),!h.isType(document.activeElement.tagName,"INPUT","TEXTAREA")){var j=a.getMarkElem(c.target),k=j.length&&!j.find("[cid]").length?j.attr("cid"):void 0;if(j.closest(".md-fences:not(.CodeMirror)").length&&a.fences.focus(j.attr("cid")),!j.length&&c.target==document.querySelector(a.sessionStr)&&!b)try{var l=a.nodeMap.getLast(),m=a.findElemById(l.cid),n=c.pageY-m.offset().top-m.height();if(n>0){if(h.isType(l,i.paragraph,i.heading))a.selection.jumpIntoElemEnd(a.findElemById(l.getVeryFirst(!0).cid)),j=m;else{var o=t.makeEmptyCommand(a.selection.buildUndo()),p=a.selection.addUnholdable(l,o),q=a.findElemById(p.cid);a.undo.register(o),a.selection.jumpIntoElemBegin(q),j=q}a.refocus(),c.stopPropagation()}}catch(r){}try{clearTimeout(Q),window.getSelection().toString().length?(P=0,f()):1===P?P=0:(Q=setTimeout(function(){P=0,f()},O),P++),e()}catch(r){console.warn(r.stack)}z.isLocked||a.writingArea.setAttribute("contenteditable","true")}}).on("mousedown",function(c){b=!1;var e=document.body.classList;e.remove("show-word-count"),z.isNode&&e.contains("typora-fullscreen")&&e.contains("native-window")&&K.getCurrentWindow().setMenuBarVisibility(!1);var f=d(c.target);return d(".dropdown-menu.open:not(#outline-dropmenu), .dropdown-menu.show").removeClass("open").removeClass("show"),f.closest("a").length&&!f.closest("img").length&&(c.metaKey||c.ctrlKey)?(c.stopPropagation(),c.preventDefault(),!1):(f.closest(".md-fences:not(.CodeMirror)").length||z.isMac||3!==c.which||d(c.target).closest("[md-inline]").addClass("md-expand"),void(a.lastCursor=a.selection.buildUndo()))}).on("click","[md-inline='link']>.md-content, .md-def-url",function(b){return b.ctrlKey||b.metaKey?(a.tryOpenUrl_(d(this).text()),!1):void 0}).on("contextmenu",function(a){document.activeElement.hasAttribute&&document.activeElement.hasAttribute("tabindex")&&document.activeElement.hasAttribute("mdtype")&&window.getSelection().removeAllRanges(),M=d(a.target).closest("a")}).on("mousemove",function(a){b=!0}).on("click",function(b){if(3==(b.originalEvent||b).detail)return a.selection.selectLine(),!1;var c=a.getMarkElem(b.target);if(a.docMenu.autoHideOutline(),a.brush.isAutoCompleteShown()&&a.brush.triggerAutoComplete(),"block"==document.querySelector("#md-searchpanel").style.display&&a.searchPanel.closePanel(),"INPUT"!==b.target.tagName||"checkbox"!==b.target.getAttribute("type")){if("TEXTAREA"===b.target.tagName||"INPUT"===b.target.tagName||b.target.classList&&b.target.classList.contains("code-tooltip"))return b.preventDefault(),void d(b.target).trigger("focus");if(c.hasClass("md-fences")&&a.fences.clickEventHandled.call(a.fences,b,c.attr("cid")))return!1;if(d(b.target).closest("a").length){if(b.stopPropagation(),b.preventDefault(),b.metaKey||b.ctrlKey||z.isLocked)return a.tryOpenLink(d(b.target).closest("a")),!1;var e=d(b.target).closest(".md-image"),f=e.closest('[md-inline="link"]');(f.length?f:e).addClass("md-expand")}var i=a.findNodeByElem(c);h.isType(i,g.TYPE.paragraph,g.TYPE.heading)&&d(".md-tooltip-remove").remove();var j=a.selection.getRangy();return j&&j.commonAncestorContainer==a.writingArea&&!j.collapsed?(b.stopPropagation(),!1):void 0}}).on("dblclick",function(b){return z.isMac&&!/\S\s+\S/.exec(window.getSelection().toString())?(a.selection.selectWord(!1,!0),!1):void 0});document.querySelector("content").addEventListener("wheel",function(b){Math.abs(b.deltaY)<4||z.isFocusMode&&z.isTypeWriterMode&&setTimeout(Z.bind(a),100)},z.option.passiveEvents?{passive:!0}:!1),d("content").on("scroll",function(b){return z.preventScroll?!1:(1==b.buttons&&z.isFocusMode&&z.isTypeWriterMode&&setTimeout(Z.bind(a),100),void d(".auto-suggest-container, .autoComplt-list").hide())}).on("click",function(b){function c(a,c){var d=document.createEvent("MouseEvents");d.initMouseEvent("mousedown",!0,!0,a.ownerDocument.defaultView,1,b.screenX,b.screenY+c,b.clientX,b.clientY+c,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button),a.dispatchEvent(d)}function e(c,d){d?a.selection.jumpIntoElemEnd(c):a.selection.jumpIntoElemBegin(c),b.preventDefault(),b.stopPropagation()}if(b.target==this||b.target==a.writingArea){if(a.selection.getRangy())return;for(var f,g=window.innerHeight,h=document.querySelector("#write > *").getBoundingClientRect(),i=b.pageX>h.right-2,j=b.pageX<h.left+2,k=Math.min(h.right-2,Math.max(b.pageX,h.left+2)),l=b.pageY;g>l;l+=20)if(f=d(document.elementFromPoint(k,l)),!f.find("[mdtype]").length&&f.closest("[mdtype]").andSelf("[mdtype]").length)return z.isNodeHtml?e(f,i):c(f[0],l-b.pageY),void a.refocus(f.attr("cid"));for(var l=b.pageY;l>0;l-=20)if(f=d(document.elementFromPoint(k,l)),!f.find("[mdtype]").length&&f.closest("[mdtype]").andSelf("[mdtype]").length)return z.isNodeHtml?e(f,!j):c(f[0],l-b.pageY),void a.refocus(f.attr("cid"))}})},simpleParse:function(a){var b=a.get("type")==i.line;if(a.get("type")==i.raw_edit||b&&/(^[`~>#|\-+*1-9=\[])|\n\s*\S/g.test(a.safeGetStrAttr("text"))){this.brush.pause();var c,d,e=this.undo.UndoManager.makeEmptyCommand(),f=a.getClosetParagraphLevel();return e.undo.push(this.selection.buildUndo()),e.undo.push(t.buildReplaceUndo(f)),c=a.parseFrom(),b=b&&1===c[1].length,b&&h.isType(a,i.line)?(this.brush.restart(),null):(b?(c=a.separateBlockFromLine(),d="",e.redo.push(t.buildReplaceUndo(c[1])),c[0]&&(d+=c[0].toHTML(),t.addUndoForInsert(e,c[0])),d+=c[1].toHTML(),c[2]&&(d+=c[2].toHTML(),t.addUndoForInsert(e,c[2]))):(e.redo.push(this.undo.buildReplaceUndo(c[1][0])),t.addUndoForInsertArray(e,c[1].slice(1)),d=c[0]),this.brush.restart(),[e,d,f.cid])}},findElemById:function(a){return a?d("[cid='"+a+"']"):d()},findNodeByElem:function(a){return a.length?this.nodeMap.get("allNodes").get(a.attr("cid")):null},beforeInsertTextFromCandidate:function(a){var b=!1,c={preventDefault:function(){b=!0}};return this.selection.prepNode(a,c),!b},replaceText:function(a,b,c,e,f){function g(){this.undo.snap(n,u.REPLACE,void 0,!0),p=a.length-q.toString().length,q.deleteContents(),q.insertNode(document.createTextNode(a)),o.start+=p,o.end+=p,r.moveToBookmark(o),this.selection.setRange(r),this.brush.addToQueue(n)}function i(a){this.selection.deRange(a);var b=d(a.startContainer).closest(".md-meta"),c=d(a.endContainer).closest(".md-meta");a.collapsed||!b.length&&!c.length||s>3||b[0]!=c[0]&&(b.length&&a.setStartAfter(b[0]),c.length&&a.setEndBefore(c[0]),s++,i.call(this,a))}if(this.sourceView.inSourceMode||this.isIME||!this.writingArea.contains(document.activeElement)||h.isType(document.activeElement.tagName,"INPUT","TEXTAREA"))return!0;var j,k,l,m,n,o,p,q=this.selection.rangy.createRange(),r=this.selection.getRangy(),s=0;if(q.setStart(b,c),q.setEnd(e,f),a.match(/\n/))return x.pasteHandler(this,a,!0),!1;if(!r.collapsed)return!0;if(l=this.getJQueryElem(q.commonAncestorContainer),m=l.closest("[cid]"),n=m.attr("cid"),!n)return!1;if(o=r.getBookmark(m[0]),q.collapsed){var t;return 1==a.length&&(t=this.UserOp.hanldePair(this,a,this.getNode(n),o,void 0,q))?(this.undo.register(t),!1):!0}return l.closest("code, script").length?!1:q.commonAncestorContainer==r.commonAncestorContainer&&r.startOffset-q.endOffset>=0&&r.startOffset-q.endOffset<=2||r.equals(q)?(g.call(this),!1):(k=this.selection.rangy.createRange(),k.setEnd(r.startContainer,r.startOffset),k.setStart(q.endContainer,q.endOffset),j=k.toString(),j.length&&j.replace(/[*_\s\]]/g,"").length<2&&(i.call(this,q),g.call(this)),!1)},getMarkdown:function(a){if(this.sourceView.inSourceMode)return this.sourceView.cm.getValue();var b=this.nodeMap.toMark();return a?b.replace(/\n+$/,""):b},getNode:function(a,b){return b&&(a=a||this.focusCid,!a&&(a=this.refocus())),this.nodeMap.get("allNodes").get(a)},restoreLastCursor:function(a,b){a&&a.preventDefault(),this.lastCursor&&this.undo.exeCommand(this.lastCursor,b?[]:void 0)},toggleFocusMode:function(){z.isFocusMode?(z.isFocusMode=!1,Z.call(this)):(z.isFocusMode=!0,Y.call(this)),z.isNode?window.ClientCommand.refreshViewMenu():z.isMac&&app.menu.getItem("View").submenu().getItem("Focus Mode").setState(z.isFocusMode)},updateFocusMode:function(a){a?Y.call(this):Z.call(this)},toggleTypeWriterMode:function(a){if(void 0===a&&(a=!z.isTypeWriterMode),z.isTypeWriterMode!=a){z.isTypeWriterMode=a;var b=this;if(a){document.body.classList.add("on-typewriter-mode");var c=document.querySelector("content").clientHeight,e=(d("content"),(c-b.defaultTextHeight)/2);document.querySelector("#write-style").innerHTML="#write { \npadding-top: $1px;\npadding-bottom: 0;\n}\n#write:after {\nheight: $2px;\n}".replace(/\$1/g,e-b.defaultTextHeight).replace(/\$2/g,e+b.defaultTextHeight),b.selection.typeWriterScroll(null,null)}else document.querySelector("#write-style").innerHTML=0,document.body.classList.remove("on-typewriter-mode"),b.selection.scrollAdjust();z.isNode?window.ClientCommand.refreshViewMenu():z.isMac&&app.menu.getItem("View").submenu().getItem("Typewriter Mode").setState(z.isTypeWriterMode)}},syncFullContent:function(){z.isMac&&app.controller.syncFullContent(z.editor.sourceView.inSourceMode)},applyFullContent:function(a){z.isMac&&!app.controller.isActiveWindow()&&(this.undo.exeCommand({type:"sync",content:app.document.content,fromSourceMode:a},void 0,!0),this.refresh())},syncChange:function(a){function b(a,b){return a.map(function(a){return a?"fences"==a.type?null:a:null},b)}if(z.isMac)app.controller.shouldTriggerSyncChange()&&(T(),app.document.syncChange(JSON.stringify(b(a,this))));else if(z.isNode){var c=z.getCurrentDocByNode();z.shouldTriggerSyncChange()&&c.syncChange(JSON.stringify(b(a,this)))}},applyChange:function(a){if(a&&!z.isActiveWindow()){var b=JSON.parse(a),c=!1;b.forEach(function(a){c=this.undo.exeCommand(a,void 0,!0)||c},this),c&&this.refresh()}}}),S=function(){editor.syncFullContent(),N=null},T=function(){N&&clearTimeout(N),N=setTimeout(S,500)};R.prototype.scheduleFullContentSync=T;var U=function(a,b){function c(c){if(e.attr("mdtype")==g.TYPE.meta_block)try{var d=c.selection.getRangy();return!a&&!b&&d.collapsed&&d.endContainer.textContent.replace(/\n$/,"").length<=d.endOffset&&d.endContainer.textContent.match(/\n{2,}$/g)?!1:!0}catch(f){return!0}return!1}function d(a){var b=a.getNode(m);return h.isType(b,i.def_link,i.def_footnote)&&h.isEmptyBlock(b)?!0:void 0}this.brush.pause(),this.brush.hideAutoComplete(),this.undo.completeSnap(!0);var e=this.getMarkElem();if(this.brush.brushNode(e.attr("cid")),e=this.getMarkElem(),h.isType(e.attr("mdtype"),g.TYPE.fences,g.TYPE.footnote))return!0;var f,j=(window.getSelection(),e.closest(".md-table").length),k=j,l=this,m=e.attr("cid"),n=this.store(m);z.isTypeWriterMode&&this.selection.lockScroll();var o;if(c(this))o=t.makeEmptyCommand(),o.undo.push(this.selection.buildUndo()),x.insertInlineText(this,null,"\n",this.selection.getOffset(e),o,!0),this.undo.register(o),this.brush.addToQueue(m);else if(d(this))this.undo.completeSnap(!0),o=this.UserOp.backToParagraph(l,this.getNode(m),!0,!1),this.undo.register(o);else if(j)this.tableEdit.moveToNextCell(!0);else if(!k){var o=this.selection.prepNode("​",null,!0);if(o)this.undo.register(o);else if(n&&(this.undo.completeSnap(!0),f=n.breakOn(a,this,b))){var p=this.findElemById(f.oldCid),q=p.parent("ol");l.findNodeByElem(q);p.replaceWith(f.newHtml),h.isType(this.getNode(f.nextFocus),g.TYPE.math_block)?(f.command.redo.push({type:"fences-pos",id:f.nextFocus,pos:{line:0,ch:0}}),setTimeout(function(){l.mathBlock.startEditing(f.nextFocus)},0)):(this.selection.jumpIntoElemBegin(this.findElemById(f.nextFocus)),f.command.redo.push(this.selection.buildUndo())),this.focusCid=this.refocus(f.nextFocus),this.findElemById(f.nextFocus).addClass("md-focus"),this.undo.register(f.command),this.refresh()}}return!(f&&f.nextFocus)&&this.refocus(),this.brush.resume(),!0};R.prototype.pressReturn=U;var V,W=function(){d(".md-tooltip-remove").remove(),d(".md-focus").removeClass("md-focus"),d(".md-focus-container").removeClass("md-focus-container"),document.body.classList.remove("show-word-count")},X=!1,Y=function(){V&&(clearTimeout(V),V=null),X||(X=!0,document.body.classList.add("on-focus-mode"))},Z=function(){X&&(X=!1,document.body.classList.remove("on-focus-mode"))};c.exports=R}),define("app/document/MarkParser",["app/document/StringUtils","app/document/Node","exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/editor/Inline","app/document/Node","app/editor/EditHelper","app/editor/UndoManager","app/editor/Emoji"],function(a,b,c){"use strict";function d(a,b){var c,d,f="",g="",h=[],i=0;if(!b){if(d=U.exec(a),!d)return null;a=d[1]}return c=a.replace(/\\\\/g,fa.ESCAPE_ESCAPE).replace(/\\\|/g,fa.ESCAPE_VLINE).replace(/(^|[^\\])((`+)([\s\S]*?[^`])\3(?!`))/g,function(a,b,c){return h.push(c),i++,[b,f,i-1,g].join("")}).replace(/\\\ /g,fa.ESCAPE_SPACE).split(X),b&&c.length<=1?null:(i=0,c.map(function(a){return e(a.replace(/\uE022/g,"\\ ").replace(/\uE07A[^\uE07B]+\uE07B/g,function(){return i++,h[i-1]}))}))}function e(a){return a?a.replace(new RegExp(fa.ESCAPE_ESCAPE,"g"),"\\\\").replace(new RegExp(fa.ESCAPE_VLINE,"g"),"\\|"):a}function f(a,b){function c(a){return r.isType(this.cur,s.paragraph)&&1==this.cur._lines.length&&this.cur._lines[0].match(C)?(f.call(this,this.cur),this.cur=null,a.set("ahead",1),!0):void 0}function e(a){var b=this.lines[this.ln+1];return void 0!==b&&b.match(C)?(this.ln++,a.set("tail",1),!0):void(void 0!==b&&a.set("tail",0))}function f(a){this.blocks.remove(a),a.remove()}function g(a,b){a=a||this.cur;var c=a;this.oldNode&&!this.blocks.length?(r.isType(a,s.paragraph)&&r.isType(this.oldNode,s.line)?(a.set("type",s.line),a.set("text",a.getText())):a.giveChildrenTo(this.oldNode),this.oldNode.copyContentFrom(a),a._lines&&(this.oldNode._lines=a._lines),a.remove(),this.blocks.push(r.isType(this.oldNode,s.line)?this.oldNode.get("parent"):this.oldNode),c=this.oldNode):(this.parent?this.parent.append(a):this.blocks.length?this.blocks.last().insert(a):(console.error("parse error"),a.set("parent",this.parent),a.set("in",this.nodeMap),a.set("attachTo",this.nodeMap)),this.blocks.push(a)),this.cur=b?c:null}function h(a,b){if(this.cur){if(r.isType(this.cur,s.paragraph)&&!this.cur._lines.length)return void(this.cur=null);o.onClose&&o.onClose.call(this,b),b||void 0!=this.cur.get("tail")||this.cur.set("tail",0),g.call(this,this.cur,a)}}function i(a,b,d){var e=new r({type:s.list,style:a,"in":this.nodeMap,pattern:b});a==r.ListType.ol?e.set("start",d):e._mark=d,c.call(this,e),h.call(this),this.cur=e}function j(b){var c,e=b?W:V;if(c=d(a,b)){var c,f,g,h=this.ln+1,i=this.lines.length,j=this.lines[h],k=[];if(i>h&&this.lines[h].match(e))for(h++;i>h&&(g=this.lines[h],f=null,f=d(g,b));h++)k.push(f);if(k.length)return j=b?j.split(X):j.replace(/^ *\||\| *$/g,"").split(X),l.call(this,c,j,k,h-1),!0}return!1}function k(a){n=new r({type:s.toc,"in":this.nodeMap,pattern:a}),c.call(this,n),e.call(this,n),h.call(this,!0),g.call(this,n)}function l(a,b,d,f){function i(a,b){var c,d=new r({type:s.table_row,parent:a,"in":a.get("in"),header:!j,before:j});for(m=0;l>m;m++){var e=new r({type:s.table_cell,parent:d,"in":d.get("in"),before:c,text:(b[m]||"").trim()});c=e}return d}var j,k=new r({type:s.table,"in":this.nodeMap}),l=a.length;b=b||new Array(a.length),d=d||[[]];for(var m=0;l>m;m++)b[m]=b[m]||"",b[m].match(/^ *-+: *$/)?b[m]="right":b[m].match(/^ *:-+: *$/)?b[m]="center":b[m].match(/^ *:-+ *$/)?b[m]="left":b[m]=null;k.set("align",b),j=i.call(this,k,a),d.forEach(function(a){j=i.call(this,k,a)},this),c.call(this,k),h.call(this),f&&(this.ln=f),e.call(this,k),g.call(this,k),this.cur=null}var m,n,o;if(this.cur){o=ba[this.cur.get("type")];var q=!b&&o.shouldClose.call(this,a);if(q>0||b){if(h.call(this,!1,b),2==q)return}else if(!q)return void(o.onContinue&&o.onContinue.call(this,a))}if(!b){if(!this.skips.old_code&&(m=K.exec(a)))return void(r.isType(this.cur,s.code)&&o?o.onContinue&&o.onContinue.call(this,a):(n=new r({type:s.code,pattern:m[1],"in":this.nodeMap}),c.call(this,n),n._lines=[m[2]],h.call(this),this.cur=n));if((m=F.exec(a))&&r.isType(this.cur,s.paragraph)&&!p.isNullOrBlank(this.cur._lines.last()))return n=new r({type:s.heading,depth:"="==m[1]?1:2,text:this.cur._lines.pop(),pattern:"{0}\n"+a,"in":this.nodeMap}),c.call(this,n),h.call(this),e.call(this,n),void g.call(this,n);if(a.match(G)){if(m=D.exec(a))return n=new r({type:s.blockquote,"in":this.nodeMap,pattern:m[1]}),c.call(this,n),n._lines=[m[2]],n._indent=m[1].replace(/[ \u00A0]*>/,"").length,h.call(this),void(this.cur=n);if(m=E.exec(a))return n=new r({type:s.heading,depth:m[2].length,text:m[3],pattern:(this.skips.enableStartMatch?m[1].replace(/#$/,"# "):m[1])+"{0}"+m[4],"in":this.nodeMap}),c.call(this,n),e.call(this,n),h.call(this),void g.call(this,n);if(m=w.tasklist.exec(a))return i.call(this,r.ListType.task,m[2],m[3]),o=ba[s.list],void o.onContinue.call(this,a,m[0].replace(/\t/,"  ").replace(/^\s+$/,"").length,m[1].length);if(m=w.ul.exec(a))return P.exec(this.lines[this.ln+1]||"")?(k.call(this,a+"\n"+this.lines[this.ln+1]),void this.ln++):(i.call(this,r.ListType.ul,m[2],m[3]),o=ba[s.list],void o.onContinue.call(this,a,m[0].replace(/\t/,"  ").replace(/^\s+$/,"").length,m[1].length));if(m=w.ol.exec(a))return i.call(this,r.ListType.ol,m[0].replace(/\d+/,"{0}"),m[0].match(/\d+/)[0].replace(/^1$/,"")),o=ba[s.list],void o.onContinue.call(this,a,m[0].replace(/\t/,"  ").replace(/^\s+$/,"").length,m[1].length);if(this.skips.enableMetaBlock&&0==this.ln&&a.match(S)){var t=this.ln+1,u=this.lines.length,v=this.skips.enableStartMatch||!1;if(!v)for(;u>t;t++)if(this.lines[t].match(S)){v=t>this.ln+1;break}if(v)return n=new r({type:s.meta_block,"in":this.nodeMap,text:this.lines.slice(this.ln+1,t).join("\n")}),c.call(this,n),this.ln=t,e.call(this,n),h.call(this,!0),void g.call(this,n)}if((m=a.match(J))&&!this.skips.math_block){var t=this.ln+1,u=this.lines.length,v=this.skips.enableStartMatch||!1;if(!v)for(;u>t;t++)if(this.lines[t].match(J)){v=!0;break}if(v)return n=new r({type:s.math_block,"in":this.nodeMap,text:this.lines.slice(this.ln+1,t).join("\n")}),c.call(this,n),this.ln=t,e.call(this,n),h.call(this,!0),void g.call(this,n)}if(m=H.exec(a))return n=new r({type:s.fences,lang:m[3],pattern:m[1]+"{0}","in":this.nodeMap}),n._mark=m[2],n._lines=[],c.call(this,n),h.call(this),void(this.cur=n);if(m=M.exec(a))return n=new r({type:s.hr,pattern:m[1],"in":this.nodeMap}),c.call(this,n),e.call(this,n),h.call(this,!0),void g.call(this,n);if(a.match(N))return void k.call(this);if(a.match(O))return void k.call(this,a);if(j.call(this,!1))return;if(this.skips.enableStartMatch&&(m=T.exec(a))){var x=d(a,!1);if(x&&x.length>1)return void l.call(this,x)}if(m=R.exec(a))return n=new r({type:s.def_footnote,ref:m[1],text:m[2],"in":this.nodeMap}),c.call(this,n),e.call(this,n),h.call(this,!0),void g.call(this,n);if(m=Q.exec(a))return n=new r({type:s.def_link,ref:m[1],href:m[3],title:m[7],"in":this.nodeMap,pattern:"[;]:"+m[2]+";"+m[4]+(m[5]?";"+m[6]:"")}),c.call(this,n),e.call(this,n),h.call(this,!0),void g.call(this,n)}else if(j.call(this,!0))return;this.cur||(this.cur=new r({type:s.paragraph,"in":this.nodeMap}),this.cur._lines=[]),r.isType(this.cur,s.paragraph)?this.cur._lines.push(a):o&&o.onContinue&&o.onContinue.call(this,a)}}function g(a,b,c){this.options=a||l({},ka.defaults),this.options.decorate=b||t.decorate,this.options.context=c||this,this.rules=ea.normal,this.options.gfm?this.options.breaks?this.rules=ea.breaks:this.rules=ea.gfm:this.options.pedantic&&(this.rules=ea.pedantic),File.option.enableHighlight&&(this.rules.escape2=/^[\uE013\uE014\uE015\uE018\uE020]/)}function h(a,b){var c=/([a-z])_([a-z])/gi;return a=a.replace(c,"$1"+fa.UNDER_CHAR+"$2").replace(/\\[\*_=\]\\]/gi,function(a){return ia[a]||a}),b&&a.length<2e4&&(a=a.replace(/((?:(https?:\/\/[\w-+.\/?%&=:#\uE006]+)|((mailto:\/{0,2})?[a-z0-9][a-z0-9\-_+\.\uE006]*(@)[a-z0-9][a-z0-9\-_\uE006]*\.(com|co|net|org|edu|io|tv|fm|me|info|cc|ca|de|cn|ru)(\.[a-z0-9][a-z0-9\-_\uE006]+)?)|(www\.[a-z0-9][a-z0-9\-_\uE006]*(\.[a-z0-9\-_\uE006]+)+(\/[\w-.\/?%&=:#\uE006]*)?)))/gi,fa.URL_START+"$1"+fa.URL_END)),a}function i(a){return a.replace(/[\uE006-\uE020]/g,function(a){return ga[a]?"\\"+ga[a]:ha[a]||""})}function j(a,b){return a=a.source,b=b||"",function c(d,e){return d?(e=e.source||e,e=e.replace(/(^|[^\[])\^/g,"$1"),a=a.replace(d,e),c):new RegExp(a,b)}}function k(){}function l(a){for(var b,c,d=1;d<arguments.length;d++){b=arguments[d];for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&(a[c]=b[c])}return a}function m(a,b,c,d,e){function f(a,b,c){return new r({type:c||s.paragraph,text:a,parent:b,"in":b.get("in")})}function g(c,d,e){q+=c.length,a=a.substring(q),e.cid==b.editor.focusCid&&b.editor.store(),b.editor.undo.completeSnap(!0),d.undo.push(u.buildReplaceUndo(e.getClosetParagraphLevel()))}function h(c,d,e,f){var g,h="";return f=f||m(a,b,c,!1,d),r.isType(e,s.list,s.blockquote)&&r.isType(e.get("parent"),s.paragraph)?(g=e.separateBlockFromLine(),e=g[1],d.redo.push(u.buildReplaceUndo(e)),g[0]&&u.addUndoForInsert(d,g[0]),g[2]&&u.addUndoForInsert(d,g[2]),h=(g[0]&&g[0].toHTML()||"")+e.toHTML(f.html)+(g[2]&&g[2].toHTML()||"")):(d.redo.push(u.buildReplaceUndo(e)),h=e.toHTML(f.html)),{html:h,offset:q+f.offset,focus:f.focus,blockChanged:!0,command:d,splits:g}}function i(b){return g(a.match(/^ *>[ \u00A0]?/)[0],b,c),c.set("type",s.blockquote),c.set("text",""),t=f(a,c),b.redo.push(u.buildReplaceUndo(c)),h(t,b,c)}function j(d,e,i){var j,k,l,n=File.option.indentSize;if(g(d,e,c),c.set("type",s.list),c.set("text",""),c.set("style",i),k=f("",c,s.list_item),k.set("checked",null!=/x|X/g.exec(d)),t=f(a,k,s.paragraph),i==r.ListType.ul&&c.set("pattern",d.trim()+" ".repeat(n-1)),i==r.ListType.ol){var o=d.match(/\d+/)[0].replace(/^1$/,"");""!=o?c.set("start",o):c.unset("start")}l=m(a,b,t,!1),l.html=k.toHTML(l.html),j=h(null,e,c,l),c=j.splits&&j.splits[1]||c;var p=c.get("before"),q=c.get("after");return j.splits&&!j.splits[0]&&r.isType(p,s.list)&&p.get("style")==c.get("style")&&(j.replaceCid=p.cid,j.toRemove=[c.cid],e.undo.push(u.buildReplaceUndo(p)),u.addUndoForRemove(e,c),p.appendTillEnd(c.getFirstChild()),p.getFirstChild().unset("tail"),p.getFirstChild().getLastChild().unset("tail"),c.remove(),r.isType(q,s.list)&&q.get("style")==q.get("style")&&(j.toRemove.push(q.cid),u.addUndoForRemove(e,q),p.appendTillEnd(q.getFirstChild()),p.getFirstChild().unset("tail"),p.getFirstChild().getLastChild().unset("tail"),q.remove()),e.redo.push(u.buildReplaceUndo(p)),j.html=p.toHTML(),j.splits[2]&&(j.html+=j.splits[2].toHTML())),j}function k(d,e){var f,i,j=c.get("parent"),k=j.get("parent"),l=k.get("parent");return g(d,e,l),l.set("style",r.ListType.task),k.set("checked",null!=/x|X/g.exec(d)),c.set("text",a),t=c,i=m(a,b,t,!0,e),i.html=k.toHTML(),f=h(null,e,l,i),f.replaceCid=l.cid,f}function l(a,b){var c=a.get("parent"),d=c&&c.get("parent");return r.isType(a,s.line)&&!a.get("before")&&c&&r.isType(c,s.paragraph)&&!c.get("before")&&d&&r.isType(d,s.list_item)&&!d.get("before")&&!d.get("after")&&d.get("parent").get("style")==r.ListType.ul&&/(^ *\[(x|X)\]( |\t)+)|((^ *\[ \]) +)/g.exec(b)}function n(b){return t=f(a,c,s.line),h(t,b,c)}var p,q=0,t=c,v=[];if(e=e||!d&&u.makeEmptyCommand(),!d){if(/^ *>[^\n]+/.exec(a))return i(e);if(p=/^( *)[*+-][ \t\u00A0]+(\[(x|X)\]|\[ \]) +/.exec(a))return j(p[0],e,r.ListType.task);if(p=/^( *)[*+-][ \t\u00A0]+/.exec(a))return j(p[0],e,r.ListType.ul);if(p=/^( *)\d+\.[ \t\u00A0]+/.exec(a))return j(p[0],e,r.ListType.ol);if(p=l(c,a))return k(p[0],e);if(r.isType(c,s.paragraph))return n(e)}var w=[],x={innerHtml:o(a,b.inline,r.isType(c,s.heading),c,v,w),offset:0,focus:c.cid,blockChanged:!1,command:e,cursorDiff:v,mdlike:w[0]};return x.html=c&&c.toHTML(x.innerHtml,w[0]),x}function n(a,b){if(r.isType(a,s.line)){var c=[],d=o(a.safeGetStrAttr("text"),b.inline,!1,a,[],c);return a.toHTML(d,c[0])}if(a.get("children").length){for(var e=a.getFirstChild(),f=[];e;)f.push(n(e,b)),e=e.get("after");return a.toHTML(f.join(""))}return a.toHTML()}function o(a,b,c,d,e,f){for(var g=[],h="";a;){if(!c){if(g=/^ *>[^\n]+/.exec(a)){a=a.substring(g[0].length),h+=b.options.decorate({type:s.blockquote,pattern:g[0].match(/^( *> ?)+/gm)[0],inner:o(g[0].replace(/^( *> ?)+/gm,""),b,!0,null,e)});continue}if(g=/^( *#{1,6} *)([^\n]+? *)(#* *)(\n{1,2}|$)/.exec(a)){a=a.substring(g[0].length);var i=g[1].length;h+=b.options.decorate({type:s.heading,meta_before:g[0].substring(0,i),meta_after:g[3],inner:b.output(g[2],null,null,null,{attr:!1},e)}),f&&f.push("h"+g[0].match(/#/g).length);continue}if(g=H.exec(a)){a=a.substring(g[0].length),h+=b.options.decorate({type:s.fences,lang:g[3],pattern:g[1]});continue}if(g=R.exec(a)){a=a.substring(g[0].length),h+=b.options.decorate({type:s.def_footnote,ref:g[1],inner:b.output(g[2]||"",null,null,null,null,e)});continue}if(g=/^\s*\[([^\]]+)\]:\s+([^\n]*)/.exec(a)){a=a.substring(g[0].length),h+=b.options.decorate({type:s.def_link,ref:g[1],inner:b.output(g[2]||"",null,null,null,null,e)});continue}}if(g=/(^[^\n]+(\n){0,1})/g.exec(a))a=a.substring(g[0].length),h+=b.options.decorate({type:s.paragraph,inner:b.output(g[0],null,null,null,{attr:!r.isType(d,s.heading)},e)});else if(g=/^\s*\n\s*/.exec(a))a=a.substring(g[0].length),h+=g[0];else if(a.length){console.log(a);break}}return h}var p=a("app/document/StringUtils"),q=a("app/document/Node"),r=q.Node,s=q.TYPE,t=a("app/editor/Inline"),u=a("app/editor/UndoManager"),v=a("app/editor/Emoji"),w={ul:/^(\s*)(([-+*])\s+)/,ol:/^(\s*)\d+\.\s+/,tasklist:/^(\s*)(([-+*])\s*)\[((x|X)| )\]\s+/},x=/^(\s*)([-+*>\[]|\d+\.)\s+/,y=/^(\s*)[^\s]/,z={ul:/^(\s*)([-+*])\s+/,ol:/^(\s*)(\d+\.)\s+/,tasklist:/^(\s*)([-+*]\s*\[((x|X)| )\])\s+/},A=/\r\n|\r|\n|\u2424/,B=/^[ \u00A0]{0,3}$/,C=/^[\s\u00A0]*$/,D=/(^\s{0,3}> *)(.*)$/,E=/(^\s*(#{1,6})\s*)([^\n]+?)(\s*#*\s*)$/,F=/^ *(=|-){2,}[\s\u00A0]*$/,G=/^\s*[-+*_<\[\{|#0-9`~=>$]/,H=/^( *(`{3,}|~{3,})[ \t\u00A0]*)([^\n`]+)? *$/,I=/^\s*(`{3,}|~{3,})\s*$/,J=/^\s*\${2}\s*$/,K=/^( {4}|\t)(\s*\S.*)$/,L=/^( {4}|\t)/,M=/^( *[-*_]{3,}) *$/,N=/^\s*\[toc\]\s*$/i,O=/^\s*\{:toc\}\s*$/i,P=/^\s?\{:\s*toc(\s*|(\s+.*))\}/,Q=/^\s*\[([^\]]+)\]:(\s*<?)([^\s>]+)(>?)((\s+)["'(]([^\n]*)["')])?\s*$/,R=/^\s*\[\^([^\]]+)\]:\s*([^\n]*)$/,S=/^-{3}$/,T=/^ *\|([^\|]+\|.+)\|\s*$/,U=/^\s*\|(.+)\|\s*$/,V=/^ *\|(\s*[-:]+\s*\|[-| :]*)$/,W=/^ *([-:]+\s*\|[-| :]*)$/,X=/ *\| */,Y="\n",Z={},$={},_={},aa="  ",ba={paragraph:{shouldClose:function(a){return a.match(B)?(this.cur.set("tail",1),2):-1},onClose:function(a){this.cur._lines.length>1&&this.cur._lines[0].match(C)&&(this.cur.set("ahead",1),this.cur._lines.shift()),!this.cur._lines.length&&this.cur._lines.push(""),this.cur._lines.forEach(function(a){this.cur.append(new r({type:s.line,text:a}))},this),this.cur._lines=void 0,this.cur.set("text","")},onContinue:function(a){this.cur._lines.push(a)}},blockquote:{shouldClose:function(a){return a.trim().length?a.match(D)?0:-1:(this.cur.set("tail",1),2)},onClose:function(a){new da(this.cur._lines,this.cur,null,null,this.skips),this.cur._lines=void 0,this.cur.unset("text")},onContinue:function(a){Z[this.cur._indent]||(Z[this.cur._indent]=new RegExp("^[  ]{0,3}> {0,"+(this.cur._indent||0)+"}")),
this.cur._lines.push(a.replace(Z[this.cur._indent],""))}},list:{shouldClose:function(a){var b,c=this.cur.getLastChild();if($[c._indent]||($[c._indent]=new RegExp("^ {"+c._indent+",}|\\t")),a.match($[c._indent]))return 0;if(a.match(C))return this.cur.set("tail",(this.cur.get("tail")||0)+1),this.cur.get("tail")>1?2:0;if(b=w[this.cur.get("style")].exec(a))return this.cur.get("style")!=r.ListType.ol?b[3]==this.cur._mark?0:1:0;var d=this.lines[this.ln-1];return d.match(C)?1:-1},onClose:function(){for(var a=this.cur.getLastChild(),b=this.cur.get("tail")||0;b>0;)!a._lines.last().trim().length&&a._lines.pop(),b--;new da(a._lines,a,null,null,this.skips),a._lines=void 0,a._indent=void 0,a._indentDecided=void 0,a.unset("text"),this.cur._mark=void 0,this.cur.unset("text")},onContinue:function(a,b,c){function d(a){function b(a){if(!a||0==a.length)return"";for(var b=a.length-1;b>=0;b--)if(a[b].trim().length>0)return a[b];return""}return!!x.exec(b(a))}var e,f=this.cur.getLastChild(),g=b,b=File.option.strictMarkdown?b-c:2,h=this.cur.get("style"),i=0;if(c=c||(f?f.get("prespace"):0)||0,a.match(C)||this.cur.unset("tail"),!f)return h==r.ListType.ol&&(i=/^\s*(\d+)\.\s+/.exec(a)[1].length-1),f=new r({type:s.list_item,prespace:c,markindent:g-i-c}),this.cur.append(f),f._indent=b+c,f._numLength=i,f._lines=[a.replace(w[h],"")],void(h==r.ListType.task&&f.set("checked",!!w.tasklist.exec(a)[5]));f._numLength=f._numLength||0,$[f._indent]||($[f._indent]=new RegExp("^ {"+f._indent+",}|\\t"));var j=a.match($[f._indent]),k=0;if(_[f._indent]||(_[f._indent]=new RegExp("^ {2,"+f._indent+"}|\\t")),k=(a.match(_[f._indent])||[""])[0].length,a=j?a.replace(_[f._indent],""):a,!j&&(e=z[h].exec(a)))return c=e[1].length,b=e[0].replace(/\t/g,aa).length,g=b,b=File.option.strictMarkdown?b-c:2,f._lines.length>1&&f._lines.last().match(C)?(f._lines.pop(),f.set("tail",1)):f.set("tail",0),this.cur.unset("tail"),new da(f._lines,f,null,null,this.skips),f._lines=void 0,f._indent=void 0,f.unset("text"),h==r.ListType.ol&&(i=/^\s*(\d+)\.\s+/.exec(a)[1].length-1),f=new r({type:s.list_item,prespace:c,markindent:g-i-c}),f._numLength=i,h==r.ListType.task&&f.set("checked",!!e[3].trim().length),this.cur.append(f),f._indent=b+c,void(f._lines=[a.substring(e[0].length)]);if(!f._indentDecided){if(e=y.exec(a),e&&f._indent&&f._indent-c<4)if(e[1].length){var l=e[1].length,m=l+f._indent;m>c+f.get("markindent")&&d(f._lines)?l=f.get("markindent")-f._indent:m>=c+f.get("markindent")+4&&(l=l+f._indent-4-f.get("markindent")),f._indent+=l,this.cur.set("subindent",f._indent-f._numLength),f.set("subindent",f._indent-f._numLength),a=a.substring(l)}else f.set("subindent",Math.max(2,k-f._numLength));f._indentDecided=!!e}return void f._lines.push(a)}},fences:{shouldClose:function(a){var b;return(b=I.exec(a))&&this.cur._mark==b[1]?2:0},onContinue:function(a){this.cur._lines.push(a)},onClose:function(){this.cur.set("text",this.cur._lines.join("\n")),this.cur._mark=void 0,this.cur._lines=void 0;var a=this.lines[this.ln+1];void 0!==a&&a.match(C)&&(this.cur.set("tail",1),this.ln++)}},code:{shouldClose:function(a){return a.match(K)?0:this.cur._lines.length>1&&!this.cur._lines.last().match(C)&&a.match(C)?0:1},onClose:function(){this.cur._lines.length>1&&(this.cur._lines.last().match(C)?(this.cur.set("tail",1),this.cur._lines.pop(),this.cur._lines.length>1&&this.cur._lines.last().match(C)&&(this.cur._lines.pop(),this.ln--)):this.cur.set("tail",0)),this.cur.set("text",this.cur._lines.join("\n")),this.cur.attributes.type=s.fences,this.cur._lines=void 0},onContinue:function(a){this.cur._lines.push(a.replace(L,""))}}},ca=function(a,b,c,d,e){a.parent=b,a.cur=null,a.skips=e,a.ln=0,a.blocks=[],a.oldNode=d,a.nodeMap=b||d,a.nodeMap=a.nodeMap?a.nodeMap.get("in"):c,aa=" ".repeat(File.option.indentSize)},da=function(a,b,c,d,e){var g=a;"string"==typeof a&&(g=a.split(A),1==g.length&&r.isType(d,s.line)&&(e.enableStartMatch=!0),a.charCodeAt(a.length-1)===Y&&(h-=1));var h=g.length;for(this.lines=g,ca(this,b,c,d,e),this.skips.enableMetaBlock=this.skips.enableMetaBlock&&!b;this.ln<=h;this.ln++)f.call(this,g[this.ln],this.ln==h);return this};r.parseFrom=function(a,b,c,d){c=c||{};var e=new r({type:s.raw_edit,"in":b,attachTo:c.noTop?null:b,text:a});return e.parseFrom(c,void 0,d)},r.prototype.parseFrom=function(a,b,c){function d(a){if(r.isType(a,s.list_item)&&!a.get("children").length){var b=new r({type:s.paragraph,text:a.get("text"),parent:a,"in":a.get("in")});return a.set("text",""),b}return null}if(a=a||{},r.isType(this.get("parent"),s.table_row))return this.set("type",s.table_cell),this.set("text",this.safeGetStrAttr("text").replace(/\n|\r/gi,"").replace(/([^\\])\|/gi,"$1|")),!c&&this.toHTML();if(!r.isType(this,s.line,s.raw_edit,s.list_item))return[!c&&this.toHTML(),[this]];var e=d(this)||this,f=a.skips||{};if(b=b||e.get("text"),this.get("type")===s.line&&(b=b.replace(/\r?\n/,"")),f.enableMetaBlock=this.get("attachTo")&&!this.get("before"),f.old_code=f.old_code===!1?!1:!0,this.isBlock(!0)){var g=this.get("before"),h=this.get("after"),i=new da(b,null,e.get("in"),e,f).blocks;return i.length<=1?[!c&&this.toHTML(),[this]]:(i[0].set("before",g),i.last().set("after",h),[!c&&q.NodeCollectionUtils.toHTML(i),i])}};var ea={escape:/^\\([\\`*{}\[\]()#+\-.!_>$|<~])/,escape2:/^[\uE013\uE014\uE018\uE020]/,autolink:/^<((([^ >]+(@|:\/)[^ >]+))|(\s*www\.[^ >]+))>/,url:/^\uE016([^\uE017]+)\uE017/i,comment:/^<!--[\s\S]*?-->/,tag:/^<\/?\w+(?:"[^"]*"|'[^']*'|[^'">])*?>/,underline:/^<u>([^\r]*?\S)<\/u>/,atag:/^(<a\s.+?>)(.*?)(<\/\s*a>)/,imgtag:/^<img(\s+.+)*\s+src=("([^"]+)"|'([^']+)').*?(\/?\s*>.*?(<\/img>)?)/,link:/^\[((?:\[[^\]]*\]|[^\[\]])*)\]\(<?((?:\([^)]*\)|[^()])*?)>?[ \t]*((['"])(.*?)\4[ \t]*)?\)/,image:/^\!\[((?:\[[^\]]*\]|[^\[\]])*)\]\(<?((?:\([^)]*\)|[^()])*?)>?[ \t]*((['"])(.*?)\4[ \t]*)?\)({([^{}\(\)]*)})?/,reflink:/^(!?)\[(inside)\]\s*\[([^\]]*)\]/,strong:/^(\*\*|__)(?=\S)([^\r]*?\S?[*_]?)\1/,em1:/^(\_)(?=\S)([^\r]*?[^\s_])\1(?!\1)/,em2:/^(\*)(?=\S)([^\r]*?[^\s*])\1(?!\1)/,highlight:/^(\=\=)(?=\S)([^\r]*?\S)\1/,code:/^(`+)([\s\S]*?[^`])\1(?!`)/,del:/^~~(?=\S)([\s\S]*?\S)~~/,text:/(\s|\S)+?[^\u200B\uE010-\uE020\uE006\\<!\[_*`&{\$\:~\^\=]*/,footnote:/^\[\^([^\]]+)\]/,attr:/^{( *([#.][-\w_\uE006]+ *|[-\w_\uE006]+=[-\w_"'\uE006]+ *)+)}/,html:/(comment|closed|closing)/,entity:/^&[a-z]+;/i,emoji:/^(\u200B*):([+\-\w\uE006]+):(\u200B*)/,inline_math:/^\$.*(?:[^\\])\$/,subscript:/^~(([^\s]|(\\\s))+?)~/,superscript:/^\^(([^\s]|(\\\s))+?)\^/,linebreak:/  $/};ea._inside=/(?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*/,ea._href=/\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*/,ea._tag="(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:/|@)\\b",ea.html=j(ea.html)("comment",/<!--[\s\S]*?-->/)("closed",/<(tag)[\s\S]+?<\/\1>/)("closing",/<tag(?:"[^"]*"|'[^']*'|[^'">])*?>/)(/tag/g,ea._tag)(),ea.link=j(ea.link)("inside",ea._inside)("href",ea._href)(),ea.reflink=j(ea.reflink)("inside",ea._inside)(),ea.normal=l({},ea),ea.pedantic=l({},ea.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/}),ea.gfm=ea.normal,ea.breaks=l({},ea.gfm,{text:j(ea.gfm.text)("{2,}","*")()}),g.rules=ea;var fa={UNDER_CHAR:"",MATH_CHAR:"",DEF_FOOT_PERFIX_CHAR:"",ESCAPE_SATR:"",ESCAPE_UNDERLINE:"",ESCAPE_EQUAL:"",URL_START:"",URL_END:"",ESCAPE_END_SQUARE_BRACKET:"",NOT_USED:"",ESCAPE_ESCAPE:"",ESCAPE_VLINE:"",ESCAPE_SPACE:""},ga={"":"[^","":"*","":"_","":"=","":"]","":"\\"},ha={"":"_","":"","":""},ia={"\\\\":fa.ESCAPE_ESCAPE,"\\*":fa.ESCAPE_SATR,"\\=":fa.ESCAPE_EQUAL,"\\_":fa.ESCAPE_UNDERLINE,"\\]":fa.ESCAPE_END_SQUARE_BRACKET};g.skipLink={autolink:1,url:1,link:1,reflink:1},g.prototype.output=function(a,b,c,d,e,f){function j(a,b){var c=a.last();c&&c.type===s.plain?c.text+=b:a.push({type:s.plain,text:b})}function k(a){return M="",a.map(function(a){M+=b(a,x)}),M}b=b||this.options.decorate,e=l(e||{},this.options.skipOp),e.attr=e.attr===!1?!1:!0,File.option.enableInlineMath||(e.inline_math=!0),File.option.enableSubscript||(e.subscript=!0),File.option.enableSuperscript||(e.superscript=!0),File.option.enableHighlight||(e.highlight=!0),f=f||[];var m,n,o,q,r,t=0,u={},w=[],x=this.options;for(d||(a=h(a,!e.url));a;)if(o=this.rules.escape2.exec(a))t+=o[0].length,a=a.substring(o[0].length),w.push({type:s.escape,text:ga[o[0]]});else if(o=this.rules.escape.exec(a))t+=o[0].length,a=a.substring(o[0].length),w.push({type:s.escape,text:o[1]});else if(e.autolink||!(o=this.rules.autolink.exec(a)))if(e.url||!(o=this.rules.url.exec(a)))if(o=this.rules.comment.exec(a))t+=o[0].length,a=a.substring(o[0].length),m=o[0],w.push({type:e.comment?s.tag:s.comment,text:m});else if(o=this.rules.tag.exec(a)){var y;if(!e.underline&&(y=this.rules.underline.exec(a))){t+=y[0].length,a=a.substring(y[0].length),w.push({type:s.underline,inner:this.output(y[1],b,null,!0),text:y[1]});continue}if(!e.atag&&(y=this.rules.atag.exec(a))&&y[2].trim().length){t+=y[0].length,a=a.substring(y[0].length),w.push({type:s.atag,inner:this.output(y[2],b,null,!0),left:y[1],right:y[3],href:(y[1].match(/\s+href=['"]([^'"]+)/)||[])[1]||""});continue}if(!e.imgtag&&(y=this.rules.imgtag.exec(a))&&(y[3]||y[4]).trim().length){t+=y[0].length,a=a.substring(y[0].length);var z=(/\sstyle=(['"])(.+?)\1/.exec(y[0])||[])[2]||"",A=(/(^|[^\w-])width\s*:\s*(.+?)(\s*;|$)/.exec(z)||[])[2],B=(/(^|[^\w-])height*:\s*(.+?)(\s*;|$)/.exec(z)||[])[2],C=(/(^|[^\w-])zoom*:\s*(.+?)(\s*;|$)/.exec(z)||[])[2];A||(A=(/\swidth=(['"])(.+?)\1/.exec(y[0])||[])[2]),B||(B=(/\sheight=(['"])(.+?)\1/.exec(y[0])||[])[2]),w.push({type:s.imgtag,text:y[0],href:i(y[3]||y[4]),width:A,height:B,zoom:C});continue}t+=o[0].length,a=a.substring(o[0].length),m=o[0],w.push({type:s.tag,text:i(m)})}else if(!(o=this.rules.link.exec(a))||e.link)if(!(o=this.rules.image.exec(a))||e.image)if(!e.footnote&&t&&(o=this.rules.footnote.exec(a))){t+=o[0].length,a=a.substring(o[0].length);var D=(o[2]||o[1]).replace(/\s+/g," ");w.push({type:s.footnote,inner:this.output(o[1],b,null,!0,g.skipLink),text:i(o[1])})}else if(!(o=this.rules.reflink.exec(a))||e.reflink&&!o[1])if(e.attr||!(o=this.rules.attr.exec(a)))if(o=this.rules.strong.exec(a))t+=o[0].length,a=a.substring(o[0].length),w.push({type:s.strong,pattern:o[1],inner:this.output(o[2],b,null,!0)});else if((o=this.rules.em1.exec(a))||(o=this.rules.em2.exec(a)))t+=o[0].length,a=a.substring(o[0].length),w.push({type:s.em,pattern:o[1],inner:this.output(o[2],b,null,!0)});else if(o=this.rules.code.exec(a))t+=o[0].length,a=a.substring(o[0].length),w.push({type:s.code,pattern:o[1],text:o[2]});else if(o=this.rules.del.exec(a))t+=o[0].length,a=a.substring(o[0].length),w.push({type:s.del,pattern:"~~",inner:this.output(o[1],b,null,!0)});else if((o=this.rules.emoji.exec(a))&&v.data[o[2]=o[2].replace(/\uE006/g,"_")])a=a.substring(o[0].length),w.push({type:s.emoji,text:o[2],inner:v.data[o[2]]}),!o[1].length&&(f[t]=1),t+=o[0].length,!o[3].length&&(f[t]=1);else{if(!e.subscript&&(o=this.rules.subscript.exec(a))){a=a.substring(o[0].length),o=o[1].split(/\\\s/g);var E=[];o[0]&&E.push({type:s.plain,text:o[0]});for(var F=1;F<o.length;F++)E.push({type:s.escape,text:" "}),o[F]&&E.push({type:s.plain,text:o[F]});w.push({type:s.subscript,inner:k(E)})}if(!e.superscript&&(o=this.rules.superscript.exec(a))){a=a.substring(o[0].length),o=o[1].split(/\\\s/g);var E=[];o[0]&&E.push({type:s.plain,text:o[0]});for(var F=1;F<o.length;F++)E.push({type:s.escape,text:" "}),o[F]&&E.push({type:s.plain,text:o[F]});w.push({type:s.superscript,inner:k(E)})}if(e.inline_math||!(o=this.rules.inline_math.exec(a)))if(e.highlight||!(o=this.rules.highlight.exec(a))){if((o=this.rules.entity.exec(a))&&(t+=o[0].length,a=a.substring(o[0].length),p.decodeHtmlEntity(o[0])?w.push({type:s.html_entity,inner:o[0],text:o[0]}):j(w,o[0]||"")),o=this.rules.text.exec(a))t+=o[0].length,a=a.substring(o[0].length),!a&&this.rules.linebreak.exec(o[0]||"")?(j(w,o[0].replace(this.rules.linebreak,"")),w.push({type:s.linebreak,text:"  "})):j(w,o[0]||"");else if(a)throw new Error("Infinite loop on byte: "+a.charCodeAt(0))}else t+=o[0].length,a=a.substring(o[0].length),w.push({type:s.highlight,inner:this.output(o[2],b,null,!0),text:o[2]});else{var G=/^\$\$/,H=null,I=0,J="",K=null,L=/\$/,r="$";for(G.exec(o[0])?(H=/{|}|\$\$/g,r="$$"):(H=/{|}|\$/g,r="$"),H.exec(o[0]);K=H.exec(o[0]);){if(L.exec(K[0])&&0>=I&&"\\"!=o[0].substring(K.index-1,K.index)){J=o[0].substring(0,K.index+K[0].length);break}"{"===K[0]?"\\"===K.input[K.index-1]&&"\\"!==!K.input[K.index-2]||I++:"}"===K[0]&&("\\"===K.input[K.index-1]&&"\\"!==!K.input[K.index-2]||I--)}if(J.length-2*r.length>0&&/[^\s$]/.exec(J)){t+=J.length,a=a.substring(J.length),w.push({type:"inline_math",text:i(J),pattern:r});continue}t+=o[0].length,a=a.substring(o[0].length),j(w,o[0]||"")}}else t+=o[0].length,a=a.substring(o[0].length),w.push({type:s.attr,text:o[0]});else{t+=o[0].length,a=a.substring(o[0].length);var D=(o[3]||"").replace(/\s+/g," ");w.push({type:o[1]?"refimg":"reflink",ref:i(D),inner:this.output(o[2],b,null,!0,g.skipLink),text:i(o[2]),markdown:o[0],onlychild:!a&&!w.length})}else t+=o[0].length,a=a.substring(o[0].length),w.push({type:"image",href:i(o[2]),title:o[5],markdown:o[0],alt:o[1],onlychild:!a&&!w.length});else t+=o[0].length,a=a.substring(o[0].length),w.push({type:"link",href:i(o[2]),title:o[5],markdown:o[0],inner:o[1]?this.output(o[1],b,null,!0,g.skipLink):"",meta:i(o[0].substring(o[1].length+2))});else a=a.substring(o[0].length),t+=o[1].length,m=o[1],n=m,null===/^\w+:\/\//.exec(m)&&/@/.exec(m)&&(n="mailto:"+n),w.push({type:s.url,href:i(n),text:m});else t+=o[0].length,a=a.substring(o[0].length),q="",m=o[1],n="@"===o[4]?":"===o[1].charAt(6)?m:"mailto:"+o[1]:m,w.push({type:s.autolink,href:i(n),text:m});var M=k(w);return d||(M=i(M,u)),M},g.prototype.mangle=function(a){for(var b,c="",d=a.length,e=0;d>e;e++)b=a.charCodeAt(e),Math.random()>.5&&(b="x"+b.toString(16)),c+="&#"+b+";";return c},k.exec=k;var ja,ka={};ka.options=ka.setOptions=function(a){return l(ka.defaults,a),ka},ka.defaults={gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,smartLists:!1,silent:!1,highlight:null,langPrefix:"lang-",smartypants:!1,headerPrefix:""},ka.parseInline=function(a,b){return ja||(ja=new g),ja.output(a,null,null,null,b)},ka.InlineLexer=g,ka.quickParse=m,ka.reDefLink=Q,ka.reDefFootnote=R,ka.renderHtmlWithBlockMeta=n,ka.splitTableCell=d,c.exports=ka}),define("app/editor/Inline",["app/document/StringUtils","app/document/Node","exoskeleton-master/exoskeleton","jquery/jquery","app/editor/EditHelper"],function(a,b,c){"use strict";function d(a,b,c,d,g,h){var l,n,o,p,q=File.editor,b=f.escape(b),r="",s="";if(a==i.refimg){if(n=c,l=q.nodeMap.link_list.getHrefByRef(n)||"",r=" data-ref='"+j(n)+"' ",!l)return"<span md-inline='refimg' class='md-image md-no-ref' "+r+"><span class='md-meta md-before md-content' contenteditable='true' data-hint='Please define image reference by \n["+j(n)+"]: http://example.png' >"+b+"</span></span>"}else l=c;d&&(s+=" width='"+d+"'"),g&&(s+=" height='"+g+"'"),h&&(s+="style='zoom:"+h+"' ");var t=" data-src='"+k(l)+"' ",u=q.imgEdit.getRealSrc(l),v=/^data:/.exec(u),w=/^file:\/\//i.exec(u||""),x=u;return w&&(u+="?lastModify="+imgLastModified),v&&(t=" "),u=k(u),o=v||loadedImgCache.indexOf(x)>-1?"<span md-inline='"+a+"'"+t+" contenteditable='false' class='md-image md-img-loaded' "+r+"><span class='md-meta md-before md-content' contenteditable='true'>"+b+"</span><img src='"+u+"' "+s+"></span>":failImgCache.indexOf(x)>-1?"<span md-inline='"+a+"'"+t+" contenteditable='false' class='md-image md-img-error' "+r+"><span class='md-meta md-content md-before' contenteditable='true'>"+b+"</span><img src='' "+s+"></span>":"<span md-inline='"+a+"'"+t+" contenteditable='false' class='md-image' data-src='"+u+"' "+r+"><span class='md-meta md-before md-content' contenteditable='true'>"+b+"</span><img src='"+u+"' "+m+" "+s+" /></span>",a==i.image&&-1==failImgCache.indexOf(u)&&(window.uploadImageQueue.has(l)?(p=$(o),e(p,l,!1),o=p[0].outerHTML):window.moveImageQueue.has(l)&&(p=$(o),e(p,l,!0),o=p[0].outerHTML)),o}function e(a,b,c){var d=c?"md-on-moving":"md-on-uploading";a.addClass(d),a.append($("#typora-uploading-image-templ").html().replace(/\s*\n\s*/g,"")),a.attr("data-origin-path",b)}var f=a("app/document/StringUtils"),g=a("app/document/Node"),h=a("app/editor/EditHelper"),i=(g.Node,g.TYPE);window.failImgCache=[],window.loadedImgCache=[],window.removeLastModifyQuery=function(a){return(a||"").replace(/\?lastModify=(.+)$/,"")};var j=function(a){return f.escapeForPreWrap(a)},k=function(a){var b;try{b=decodeURI(a)}catch(c){b=a}return encodeURI(b.replace(/\\/g,"/")).replace(/'/,"%27").replace('"',"%22")},l=function(a,b){var c,d,e,g,l,m;switch(a.type){case i.strong:return"<strong>"+a.inner+"</strong>";case i.em:return"<em>"+a.inner+"</em>";case i.plain:return f.escape(a.text);case i.code:return"<code>"+f.escape(a.text.trim(),!1,!0)+"</code>";case i.del:return"<del>"+a.inner+"</del>";case i.autolink:return"<a href='"+k(a.href)+"' target='_blank' >"+a.text+"</a>";case i.url:return"<a href='"+k(a.href)+"' target='_blank' >"+a.text+"</a>";case i.tag:return/^<img/.test(a.text)&&b.forPrint&&(d=/(\ssrc=)(['"])([^"']*)(\2)/.exec(a.text))?(d=File.editor.imgEdit.getRealSrc(d[3]).replace(/^file:\/\/\/?/i,"file:///").replace(/\\/g,"/"),a.text.replace(/(\ssrc=)(['"])([^"']*)(\2)/,"$1$2"+d+"$4")):a.text;case i.link:return"#"==(a.href||"").trim()[0]&&(m=h.findAnchorElem(a.href),m.length&&(a.href="#header-"+m.attr("cid"))),"<a href='"+k(a.href)+"'"+(a.title?" title='"+j(a.title)+"'":"")+">"+a.inner+"</a>";case i.image:return d=b.forPrint?File.editor.imgEdit.getRealSrc(a.href):a.href,b.forPrint&&File.isNode&&File.option.printPDFByPhantom&&(d=d.replace(/^file:\/\/\/?/i,"file:///").replace(/\\/g,"/")),c="<img src='"+k(d)+"' alt='"+j(a.alt)+"' />",!b.noStyle&&a.onlyChild&&(c="<span class='md-image'>"+c+"</span>"),c;case i.footnote:if(l=b.nodeMap.foot_list.getNodeByRef(a.text)){var n=b.footnoteList.indexOf(a.text)+1;0==n&&(b.footnoteList.push(a.text),n=b.footnoteList.length);var o=b.appendFootnote(l,n);return c="<sup><a href='#dfref-footnote-"+o+"' name='ref-footnote-"+o+"'>"+n+"</a></sup>"}return"[^"+f.escape(a.text)+"]";case i.escape:return a.text;case i.refimg:return e=b.nodeMap.link_list.getNodeByRef(a.ref||a.text),g=e?j(e.get("title")):void 0,d=e?k(e.get("href")):void 0,void 0!==d?(b.forPrint&&File.isNode&&File.option.printPDFByPhantom&&(d=d.replace(/^file:\/\/\/?/i,"file:///").replace(/\\/g,"/")),c="<img alt='"+a.text+"' src='"+d+"'"+(g?" title='"+g+"'":"")+"></img>",b.noStyle||(c="<span class='md-image'>"+c+"</span>"),c):"!["+a.inner+"]["+f.escape(a.ref)+"]";case i.reflink:return e=b.nodeMap.link_list.getNodeByRef(a.ref||a.text),d=e?j(e.get("href")):void 0,g=e?j(e.get("title")):void 0,void 0!==d?"<a href='"+d+"' target='_blank'"+(g?" title='"+g+"'":"")+">"+a.inner+"</a>":"["+a.inner+"]["+f.escape(a.ref)+"]";case i.attr:return"";case i.emoji:return a.inner;case i.inline_math:return b.noStyle?a.text:h.processExportedSVG(svgCache[a.text.replace(/\u200B/g,"")]||f.escapeForPreWrap(a.text));case i.subscript:return"<sub>"+a.inner+"</sub>";case i.superscript:return"<sup>"+a.inner+"</sup>";case i.underline:return"<u>"+a.inner+"</u>";case i.linebreak:return"<br/>";case i.highlight:return"<mark>"+a.inner+"</mark>";default:return a.inner||""}};b.onErrorEvaluate="var src = window.removeLastModifyQuery(this.getAttribute('src'));if(!src.trim()) return;if (failImgCache.length > 5000) {failImgCache = [];}if(failImgCache.indexOf(src) == -1 && src.trim().length){failImgCache.push(src);}$(this).closest('.md-image').addClass('md-img-error').removeClass('md-img-loaded');",b.onLoadEvaluate="var src = window.removeLastModifyQuery(this.getAttribute('src'));if(!src.trim()) return;if(loadedImgCache.indexOf(src) == -1 && src.trim().length){loadedImgCache.push(src);}$(this).closest('.md-image').addClass('md-img-loaded').removeClass('md-img-error');";var m='onerror=" '+b.onErrorEvaluate+' " onload ="'+b.onLoadEvaluate+'"',n=function(a,b){switch(a.type){case i.heading:return"<span class='md-blockmeta'>"+a.meta_before+"</span><span class='md-header-span'>"+a.inner+"</span><span class='md-blockmeta'>"+a.meta_after+"</span>";case i.paragraph:return a.inner;case i.blockquote:return"<span class='md-blockmeta'>"+a.pattern+"</span>"+a.inner;case i.fences:return"<span class='md-blockmeta'>"+a.pattern+"</span><span class='md-lang'>"+f.escape(a.lang)+"</span>";case i.def_footnote:return"<span class='md-blockmeta'>[^</span>"+a.ref+"<span class='md-blockmeta'>]: </span><span class='md-def-content'>"+a.inner+"</span>";case i.def_link:return"<span class='md-blockmeta'>[</span>"+a.ref+"<span class='md-blockmeta'>]: </span><span class='md-def-content'>"+a.inner+"</span>";case i.strong:return"<span md-inline='strong' class='"+(a.inner?"":"md-empty")+"'><span class='md-meta md-before'>"+a.pattern+"</span><strong>"+a.inner+"</strong><span class='md-meta md-after'>"+a.pattern+"</span></span>";case i.em:return"<span md-inline='em' class='"+(a.inner?"":"md-empty")+"'><span class='md-meta md-before'>"+a.pattern+"</span><em>"+a.inner+"</em><span class='md-meta md-after'>"+a.pattern+"</span></span>";case i.highlight:return"<span md-inline='highlight'><span class='md-meta md-before'>==</span><mark>"+a.inner+"</mark><span class='md-meta md-after'>==</span></span>";case i.plain:return"<span md-inline='plain'>"+f.escape(a.text.replace(/\r?\n/gi,""))+"</span>";case i.code:var c=a.text.match(/^\s+/)||"";a.text=a.text.replace(/^\s+/,"");var e=a.text.match(/\s+$/)||"";return"<span md-inline='code' spellcheck='false'><span class='md-meta md-before'>"+a.pattern+c+"</span><code>"+f.escapeForPreWrap(a.text.trim(),!1,!0)+"</code><span class='md-meta md-after'>"+e+a.pattern+"</span></span>";case i.del:return"<span md-inline='del'><span class='md-meta md-before'>"+a.pattern+"</span><del>"+a.inner+"</del><span class='md-meta md-after'>"+a.pattern+"</span></span>";case i.autolink:return"<span md-inline='autolink'><span class='md-meta md-before'>&lt;</span><a href='"+k(a.href)+"'>"+f.escape(a.text)+"</a><span class='md-meta md-after'>&gt;</span></span>";case i.url:return"<span md-inline='url' spellcheck='false'><a href='"+k(a.href)+"'>"+f.escape(a.text)+"</a></span>";case i.comment:return"<span md-inline='comment' class='md-comment' spellcheck='false'>"+f.escapeForPreWrap(a.text,!1,!0)+"</span>";case i.tag:return"<span md-inline='tag' class='md-tag' spellcheck='false'>"+f.escapeForPreWrap(a.text,!1,!0)+"</span>";case i.atag:return"<span md-inline='atag' class='md-atag'><span class='md-meta md-before'>"+f.escapeForPreWrap(a.left,!1,!0)+"</span><a href='"+k(a.href)+"'>"+a.inner+"</a><span class='md-meta md-after'>"+f.escapeForPreWrap(a.right,!1,!0)+"</span></span>";case i.link:var g=a.meta.replace(/^\((<?(?:\([^)]*\)|[^()])*?>?)([ \t]*)((['"])(.*?)\4)?([ \t]*)\)/,function(b,c,d,e,g,h,i){return"(</span><span class='md-content md-url'>"+f.escape(a.href)+"</span><span class='md-meta'>"+f.escape(d)+"</span><span class='md-content md-link-title'>"+f.escape(e)+"</span><span class='md-meta md-after'>"+f.escape(i)+")</span>"});return"<span md-inline='link' class='"+(a.inner?"":"md-empty-link")+"'><span class='md-meta md-before'>[</span><a spellcheck='false' href='"+k(a.href)+"' >"+a.inner+"</a><span class='md-meta md-before'>]"+g+"</span>";case i.imgtag:return d(a.type,a.text,a.href,a.width,a.height,a.zoom);case i.refimg:return d(a.type,a.markdown,a.ref||a.text);case i.image:return d(a.type,a.markdown,a.href);case i.footnote:return"<sup md-inline='footnote' class='md-footnote'><span class='md-meta md-before'>[^</span><span class='md-text'>"+a.inner+"</span><span class='md-meta md-after'>]</span></sup>";case i.escape:return"<span md-inline='escape'><span class='md-meta md-before'>\\</span>"+f.escape(a.text)+"</span>";case i.reflink:return"<span md-inline='reflink'><span class='md-meta md-before'>[</span><a data-ref='"+f.escapeForPreWrap(a.ref||a.text)+"' >"+a.inner+"</a><span class='md-meta md-after'>]</span><span class='md-meta md-before'>[</span><span class='md-content'>"+a.ref+"</span><span class='md-meta md-after'>]</span></span>";case i.attr:return"<span md-inline='attr' class='md-attr'>"+f.escape(a.text)+"</span>";case i.emoji:return"<span md-inline='emoji' data-content='"+a.text+"' class='md-emoji' >​<span data-emoji='"+a.inner+"' class='md-emoji-span'></span><span class='md-meta'>:"+a.text+":</span>​</span>";case i.inline_math:return a.text=a.text.replace(/\u200B*/g,""),!/^\$+$/.exec(a.text)&&svgCache[a.text]?"<span class='md-inline-math' md-inline='inline_math' pattern='"+a.pattern+"'><span class='md-before md-meta'>"+a.pattern+"</span><span class='inline-math-svg math-jax-postprocess'>"+svgCache[a.text]+"</span><span class='md-math-after-sym'></span><span class='md-after md-meta'>"+a.pattern+"</span></span>":"<span class='md-inline-math' md-inline='inline_math' pattern='"+a.pattern+"'><span class='inline-math-svg math-jax-preprocess'>"+f.escape(a.text)+"</span></span>";case i.subscript:return"<sub md-inline='subscript'><span class='md-meta md-before'>~</span>"+a.inner+"<span class='md-meta md-after'>~</span></sub>";case i.superscript:return"<sup md-inline='superscript'><span class='md-meta md-before'>^</span>"+a.inner+"<span class='md-meta md-after'>^</span></sup>";case i.underline:return"<span md-inline='underline'><span class='md-meta md-before'>&lt;u&gt;</span><u>"+a.inner+"</u><span class='md-meta md-after'>&lt;/u&gt;</span></span>";case i.linebreak:return"<span md-inline='linebreak'>  </span>";case i.html_entity:return"<span md-inline='html_entity' data-content='"+a.text+"' class='md-entity'><span class='md-meta'>"+f.escape(a.text)+"</span></span>";default:return console.error("unknow type "+a.type),a.text}};b.applyUploadingStyle=e,b.decorateAsExport=l,b.decorate=n}),define("app/editor/Emoji",["jquery/jquery","exoskeleton-master/exoskeleton"],function(a,b,c){"use strict";var d=a("jquery/jquery"),e=a("exoskeleton-master/exoskeleton"),f=e.Model.extend({initialize:function(a){this.editor=a,this.$container=d("#emoji-auto-suggest"),setTimeout(function(){d.getScript("./app/editor/EmojiSearchMap.js")},1e3)},search:function(a,b){if(!a)return[];var c,d=new RegExp("(^"+a+")|(_"+a+")|(-"+a+")","i"),e=Object.keys(f.data).filter(function(b){return d.exec(b)&&b!==a});if(e.sort(),f.data[a]&&e.unshift(a),c=(window.EmojiSearchMap||{})[a])for(var g=0;g<c.length;g++)-1==e.indexOf(c[g])&&e.push(c[g]);return b.type="emoji",b.token=a,b.match=e,b.found=e.length,b.pageNo=0,b.pageCnt=Math.floor((e.length-1)/5+1),e},showAutoSuggest:function(a,b){if(b.token===a)return!1;var c=this.search(a,b),d="";if(!b.found)return this.$container.hide(),!1;for(var e=0;e<c.length&&40>e;e++)e%5==0&&(d+=(e>0?"</ul>":"")+"<ul data-page='"+e/5+"' style='display:none'>"),d+="<li data-content=':"+c[e]+":' ><span>"+f.data[c[e]]+"</span> <span class='emoji-meta'>:"+c[e]+":</span></li>";return d+="</ul>",this.$container.html(d),this.$container}});f.data={100:"💯",911:"🚨",1234:"🔢",smile:"😀",happy:"😆",joy:"😂",pleased:"☺️",smiley:"😃",haha:"😆",grinning:"😀",blush:"☺️",proud:"😊",relaxed:"☺️",wink:"😉",flirt:"😘",heart_eyes:"😍",love:"💘",crush:"😍",kissing_heart:"😘",kissing_closed_eyes:"😚",kissing:"😗",kissing_smiling_eyes:"😙",stuck_out_tongue_winking_eye:"😜",prank:"😝",silly:"😜",stuck_out_tongue_closed_eyes:"😝",stuck_out_tongue:"😛",flushed:"😳",grin:"😁",pensive:"😔",relieved:"😌",whew:"😌",unamused:"😒",meh:"😐",disappointed:"😞",sad:"🙍",persevere:"😣",struggling:"😣",cry:"😭",tear:"😿",tears:"😂",sob:"😭",bawling:"😭",sleepy:"😪",tired:"😩",disappointed_relieved:"😥",phew:"😥",sweat:"😓",nervous:"😟",cold_sweat:"😰",sweat_smile:"😅",hot:"😅",weary:"😩",tired_face:"😫",upset:"😫",whine:"😫",fearful:"😨",scared:"😨",shocked:"😱",oops:"😨",scream:"😱",horror:"🙀",angry:"💢",mad:"😠",annoyed:"😠",rage:"😡",triumph:"😤",smug:"😏",confounded:"😖",laughing:"😆",satisfied:"😆",yum:"😋",tongue:"👅",lick:"😋",mask:"😷",sick:"😷",ill:"😷",sunglasses:"😎",cool:"🆒",sleeping:"💤",zzz:"💤",dizzy_face:"😵",astonished:"😲",amazed:"😲",gasp:"😲",worried:"😟",frowning:"😦",anguished:"😧",stunned:"😧",smiling_imp:"😈",devil:"👿",evil:"👿",horns:"👿",imp:"👿",open_mouth:"😮",surprise:"😮",impressed:"😮",wow:"😮",grimacing:"😬",neutral_face:"😐",confused:"❓",hushed:"😯",silence:"😶",speechless:"😯",no_mouth:"😶",mute:"📴",innocent:"😇",angel:"👼",smirk:"😏",expressionless:"😑",man_with_gua_pi_mao:"👲",man_with_turban:"👳",cop:"👮",police:"👮",law:"👮",construction_worker:"👷",helmet:"👷",guardsman:"💂",baby:"👶",child:"👪",newborn:"👶",boy:"👱",girl:"👧",man:"👨",mustache:"👨",father:"👨",dad:"👨",woman:"👩",girls:"👩",older_man:"👴",older_woman:"👵",person_with_blond_hair:"👱",princess:"👸",blonde:"👸",crown:"👑",royal:"👑",smiley_cat:"😺",smile_cat:"😸",heart_eyes_cat:"😻",kissing_cat:"😽",smirk_cat:"😼",scream_cat:"🙀",crying_cat_face:"😿",joy_cat:"😹",pouting_cat:"😾",japanese_ogre:"👹",monster:"👹",japanese_goblin:"👺",see_no_evil:"🙈",monkey:"🐒",blind:"🙈",ignore:"🙈",hear_no_evil:"🙉",deaf:"🙉",speak_no_evil:"🙊",hush:"🙊",skull:"💀",dead:"💀",danger:"💀",poison:"💀",alien:"👽",ufo:"👽",hankey:"💩",poop:"💩",shit:"💩",crap:"💩",fire:"🔥",burn:"🔥",sparkles:"✨",shiny:"✨",star2:"🌟",dizzy:"💫",star:"⭐",boom:"💣",collision:"💥",explode:"💥",anger:"💢",sweat_drops:"💦",water:"💧",workout:"🏃",droplet:"💧",dash:"💨",wind:"💨",blow:"💨",fast:"💨",ear:"👂",hear:"👂",sound:"🔔",listen:"👂",eyes:"👀",look:"👀",see:"👀",watch:"⌚",nose:"👃",smell:"👃",taste:"👅",lips:"👄",kiss:"💋","+1":"👍",thumbsup:"👍",approve:"👍",ok:"🆗","-1":"👎",thumbsdown:"👎",disapprove:"👎",bury:"👎",ok_hand:"👌",facepunch:"👊",punch:"👊",attack:"👊",fist:"✊",power:"🔋",v:"✌️",victory:"✌️",peace:"✌️",wave:"👋",goodbye:"👋",hand:"✋",raised_hand:"✋",highfive:"✋",stop:"🙅",open_hands:"👐",point_up_2:"👆",point_down:"👇",point_right:"👉",point_left:"👈",raised_hands:"🙌",hooray:"🙌",pray:"🙏",please:"🙏",hope:"🙏",wish:"🙏",point_up:"☝️",clap:"👏",praise:"👏",applause:"👏",muscle:"💪",flex:"💪",bicep:"💪",strong:"💪",walking:"🚶",runner:"🏃",running:"👟",exercise:"🏃",marathon:"🎽",dancer:"💃",dress:"👗",couple:"👭",date:"📅",family:"👪",home:"👪",parents:"👪",two_men_holding_hands:"👬",two_women_holding_hands:"👭",couplekiss:"💏",couple_with_heart:"💑",dancers:"👯",bunny:"🐰",ok_woman:"🙆",no_good:"🙅",halt:"🙅",information_desk_person:"💁",raising_hand:"🙋",massage:"💆",spa:"💆",haircut:"💇",beauty:"💅",nail_care:"💅",manicure:"💅",bride_with_veil:"👰",marriage:"💒",wedding:"💒",person_with_pouting_face:"🙎",person_frowning:"🙍",bow:"🙇",respect:"🙇",thanks:"🙇",tophat:"🎩",hat:"🎩",classy:"🎩",king:"👑",queen:"👑",womans_hat:"👒",athletic_shoe:"👟",sneaker:"👟",sport:"👟",mans_shoe:"👞",shoe:"👠",sandal:"👡",high_heel:"👠",boot:"👢",shirt:"👔",tshirt:"👕",necktie:"👔",formal:"👔",womans_clothes:"👚",running_shirt_with_sash:"🎽",jeans:"👖",pants:"👖",kimono:"👘",bikini:"👙",beach:"🐚",briefcase:"💼",business:"💼",handbag:"👜",bag:"👝",pouch:"👝",purse:"👛",eyeglasses:"👓",glasses:"👓",ribbon:"🎀",closed_umbrella:"🌂",weather:"❄️",rain:"☔",lipstick:"💋",makeup:"💄",yellow_heart:"💛",blue_heart:"💙",purple_heart:"💜",green_heart:"💚",heart:"💘",broken_heart:"💔",heartpulse:"💗",heartbeat:"💓",two_hearts:"💕",sparkling_heart:"💖",revolving_hearts:"💞",cupid:"💘",love_letter:"💌",email:"✉️",envelope:"✉️",ring:"💍",engaged:"💍",gem:"💎",diamond:"💎",bust_in_silhouette:"👤",user:"👤",busts_in_silhouette:"👥",users:"👥",group:"👥",team:"👥",speech_balloon:"💬",comment:"💬",footprints:"👣",feet:"🐾",tracks:"👣",thought_balloon:"💭",thinking:"💭",dog:"🐩",pet:"🐹",wolf:"🐺",cat:"🐱",mouse:"🐭",hamster:"🐹",rabbit:"🐰",frog:"🐸",tiger:"🐯",koala:"🐨",bear:"🐻",pig:"🐷",pig_nose:"🐽",cow:"🐮",boar:"🐗",monkey_face:"🐵",horse:"🐴",sheep:"🐑",elephant:"🐘",panda_face:"🐼",penguin:"🐧",bird:"🐦",baby_chick:"🐤",hatched_chick:"🐥",hatching_chick:"🐣",chicken:"🍗",snake:"🐍",turtle:"🐢",
slow:"🐌",bug:"🐞",bee:"🐝",honeybee:"🐝",ant:"🐜",beetle:"🐞",snail:"🐌",octopus:"🐙",shell:"🐚",sea:"🌊",tropical_fish:"🐠",fish:"🐟",dolphin:"🐬",flipper:"🐬",whale:"🐳",whale2:"🐋",cow2:"🐄",ram:"🐏",rat:"🐀",water_buffalo:"🐃",tiger2:"🐅",rabbit2:"🐇",dragon:"🐉",racehorse:"🐎",speed:"🐎",goat:"🐐",rooster:"🐓",dog2:"🐕",pig2:"🐖",mouse2:"🐁",ox:"🐂",dragon_face:"🐲",blowfish:"🐡",crocodile:"🐊",camel:"🐫",dromedary_camel:"🐪",desert:"🐪",leopard:"🐆",cat2:"🐈",poodle:"🐩",paw_prints:"🐾",bouquet:"💐",flowers:"💐",cherry_blossom:"🌸",flower:"🌹",spring:"🌸",tulip:"🌷",four_leaf_clover:"🍀",luck:"🍀",rose:"🌹",sunflower:"🌻",hibiscus:"🌺",maple_leaf:"🍁",canada:"🍁",leaves:"🍃",leaf:"🍃",fallen_leaf:"🍂",autumn:"🍂",herb:"🌿",ear_of_rice:"🌾",mushroom:"🍄",cactus:"🌵",palm_tree:"🌴",evergreen_tree:"🌲",wood:"🌳",deciduous_tree:"🌳",chestnut:"🌰",seedling:"🌱",plant:"🌱",blossom:"🌼",globe_with_meridians:"🌐",world:"🌏",global:"🌐",international:"🌏",sun_with_face:"🌞",summer:"🍹",full_moon_with_face:"🌝",new_moon_with_face:"🌚",new_moon:"🌑",waxing_crescent_moon:"🌒",first_quarter_moon:"🌓",moon:"🌔",waxing_gibbous_moon:"🌔",full_moon:"🌕",waning_gibbous_moon:"🌖",last_quarter_moon:"🌗",waning_crescent_moon:"🌘",last_quarter_moon_with_face:"🌜",first_quarter_moon_with_face:"🌛",crescent_moon:"🌙",night:"🌙",earth_africa:"🌍",globe:"🌏",earth_americas:"🌎",earth_asia:"🌏",volcano:"🌋",milky_way:"🌌",stars:"🌠",sunny:"☀️",partly_sunny:"⛅",cloud:"☁️",zap:"⚡",lightning:"⚡",thunder:"⚡",umbrella:"☔",snowflake:"❄️",winter:"⛄",cold:"❄️",snowman:"⛄",christmas:"🎁",cyclone:"🌀",swirl:"🌀",foggy:"🌁",karl:"🌁",rainbow:"🌈",pride:"🌈",ocean:"🌊",bamboo:"🎍",gift_heart:"💝",chocolates:"💝",dolls:"🎎",school_satchel:"🎒",mortar_board:"🎓",education:"🎓",college:"🎓",university:"🎓",graduation:"🎓",flags:"🎏",fireworks:"🎆",festival:"🎆",celebration:"🎆",sparkler:"🎇",wind_chime:"🎐",rice_scene:"🎑",jack_o_lantern:"🎃",halloween:"👻",ghost:"👻",santa:"🎅",christmas_tree:"🎄",gift:"🎁",present:"🎁",birthday:"🎂",tanabata_tree:"🎋",tada:"🎉",party:"🎂",confetti_ball:"🎊",balloon:"🎈",crossed_flags:"🎌",crystal_ball:"🔮",fortune:"🔮",movie_camera:"🎥",film:"🎦",video:"🎥",camera:"📷",photo:"📷",video_camera:"📹",vhs:"📼",cd:"💿",dvd:"📀",minidisc:"💽",floppy_disk:"💾",save:"💾",computer:"💻",desktop:"💻",screen:"💻",iphone:"📱",smartphone:"📱",mobile:"📱",phone:"📞",telephone:"☎️",telephone_receiver:"📞",call:"📲",pager:"📟",fax:"📠",satellite:"📡",signal:"📡",tv:"📺",radio:"📻",podcast:"📻",loud_sound:"🔊",volume:"🔕",speaker:"🔈",bell:"🔔",notification:"🔔",no_bell:"🔕",off:"📴",loudspeaker:"📢",announcement:"📢",mega:"📣",hourglass_flowing_sand:"⏳",time:"⌚",hourglass:"⌛",alarm_clock:"⏰",morning:"⏰",unlock:"🔓",security:"🔐",lock:"🔑","private":"🔒",lock_with_ink_pen:"🔏",closed_lock_with_key:"🔐",key:"🔑",password:"🔑",mag_right:"🔎",bulb:"💡",idea:"💡",light:"💡",flashlight:"🔦",high_brightness:"🔆",low_brightness:"🔅",electric_plug:"🔌",battery:"🔋",mag:"🔍",search:"🔍",zoom:"🔍",bathtub:"🛁",bath:"🚿",shower:"🚿",toilet:"🚾",wc:"🚾",wrench:"🔧",tool:"🔨",nut_and_bolt:"🔩",hammer:"🔨",door:"🚪",smoking:"🚬",cigarette:"🚬",bomb:"💣",gun:"🔫",shoot:"🔫",weapon:"🔫",hocho:"🔪",knife:"🔪",cut:"✂️",chop:"🔪",pill:"💊",health:"💉",medicine:"💊",syringe:"💉",hospital:"🏥",needle:"💉",moneybag:"💰",dollar:"💸",cream:"💰",yen:"💴",money:"💵",pound:"💷",euro:"💶",credit_card:"💳",subscription:"💳",money_with_wings:"💸",calling:"📲",incoming:"📲","e-mail":"📧",inbox_tray:"📥",outbox_tray:"📤",letter:"✉️",envelope_with_arrow:"📩",incoming_envelope:"📨",postal_horn:"📯",mailbox:"📫",mailbox_closed:"📪",mailbox_with_mail:"📬",mailbox_with_no_mail:"📭",postbox:"📮","package":"📦",shipping:"📦",memo:"📝",pencil:"📝",document:"📜",note:"📝",page_facing_up:"📄",page_with_curl:"📃",bookmark_tabs:"📑",bar_chart:"📊",stats:"📊",metrics:"📉",chart_with_upwards_trend:"📈",graph:"📉",chart_with_downwards_trend:"📉",scroll:"📜",clipboard:"📋",calendar:"📆",schedule:"📆",card_index:"📇",file_folder:"📁",directory:"📁",open_file_folder:"📂",scissors:"✂️",pushpin:"📌",location:"📍",paperclip:"📎",black_nib:"✒️",pencil2:"✏️",straight_ruler:"📏",triangular_ruler:"📐",closed_book:"📕",green_book:"📗",blue_book:"📘",orange_book:"📙",notebook:"📓",notebook_with_decorative_cover:"📔",ledger:"📒",books:"📚",library:"📚",book:"📖",open_book:"📖",bookmark:"🔖",name_badge:"📛",microscope:"🔬",science:"🔬",laboratory:"🔬",investigate:"🔬",telescope:"🔭",newspaper:"📰",press:"📰",art:"🎨",design:"🎨",paint:"🎨",clapper:"🎬",microphone:"🎤",sing:"🎤",headphones:"🎧",music:"🎶",earphones:"🎧",musical_score:"🎼",musical_note:"🎵",notes:"🎶",musical_keyboard:"🎹",piano:"🎹",violin:"🎻",trumpet:"🎺",saxophone:"🎷",guitar:"🎸",rock:"🎸",space_invader:"👾",game:"👾",retro:"👾",video_game:"🎮",play:"🎮",controller:"🎮",console:"🎮",black_joker:"🃏",flower_playing_cards:"🎴",mahjong:"🀄",game_die:"🎲",dice:"🎲",gambling:"🎲",dart:"🎯",target:"🎯",football:"🏈",sports:"🎾",basketball:"🏀",soccer:"⚽",baseball:"⚾️",tennis:"🎾","8ball":"🎱",pool:"🎱",billiards:"🎱",rugby_football:"🏉",bowling:"🎳",golf:"⛳",mountain_bicyclist:"🚵",bicyclist:"🚴",checkered_flag:"🏁",milestone:"🏁",finish:"🏁",horse_racing:"🏇",trophy:"🏆",award:"🏆",contest:"🏆",winner:"🏆",ski:"🎿",snowboarder:"🏂",swimmer:"🏊",surfer:"🏄",fishing_pole_and_fish:"🎣",coffee:"☕",cafe:"☕",espresso:"☕",tea:"🍵",green:"♻️",breakfast:"🍳",sake:"🍶",baby_bottle:"🍼",milk:"🍼",beer:"🍺",drink:"🍸",beers:"🍻",drinks:"🍻",cocktail:"🍸",tropical_drink:"🍹",vacation:"🍹",wine_glass:"🍷",fork_and_knife:"🍴",cutlery:"🍴",pizza:"🍕",hamburger:"🍔",burger:"🍔",fries:"🍟",poultry_leg:"🍗",meat:"🍗",meat_on_bone:"🍖",spaghetti:"🍝",pasta:"🍝",curry:"🍛",fried_shrimp:"🍤",tempura:"🍤",bento:"🍱",sushi:"🍣",fish_cake:"🍥",rice_ball:"🍙",rice_cracker:"🍘",rice:"🍚",ramen:"🍜",noodle:"🍜",stew:"🍲",oden:"🍢",dango:"🍡",egg:"🍳",bread:"🍞",toast:"🍞",doughnut:"🍩",custard:"🍮",icecream:"🍦",ice_cream:"🍨",shaved_ice:"🍧",cake:"🍰",dessert:"🍰",cookie:"🍪",chocolate_bar:"🍫",candy:"🍬",sweet:"🍬",lollipop:"🍭",honey_pot:"🍯",apple:"🍎",green_apple:"🍏",fruit:"🍌",tangerine:"🍊",lemon:"🍋",cherries:"🍒",grapes:"🍇",watermelon:"🍉",strawberry:"🍓",peach:"🍑",melon:"🍈",banana:"🍌",pear:"🍐",pineapple:"🍍",sweet_potato:"🍠",eggplant:"🍆",aubergine:"🍆",tomato:"🍅",corn:"🌽",house:"🏠",house_with_garden:"🏡",school:"🏫",office:"🏢",post_office:"🏣",bank:"🏦",convenience_store:"🏪",love_hotel:"🏩",hotel:"🏨",church:"⛪",department_store:"🏬",european_post_office:"🏤",city_sunrise:"🌇",city_sunset:"🌆",japanese_castle:"🏯",european_castle:"🏰",tent:"⛺",camping:"⛺",factory:"🏭",tokyo_tower:"🗼",japan:"🇯🇵",mount_fuji:"🗻",sunrise_over_mountains:"🌄",sunrise:"🌅",night_with_stars:"🌃",statue_of_liberty:"🗽",bridge_at_night:"🌉",carousel_horse:"🎠",ferris_wheel:"🎡",fountain:"⛲",roller_coaster:"🎢",ship:"🚀",boat:"⛵",sailboat:"⛵",speedboat:"🚤",rowboat:"🚣",anchor:"⚓",rocket:"🚀",launch:"🚀",airplane:"✈️",flight:"✈️",seat:"💺",helicopter:"🚁",steam_locomotive:"🚂",train:"🚋",tram:"🚊",station:"🚉",mountain_railway:"🚞",train2:"🚆",bullettrain_side:"🚄",bullettrain_front:"🚅",light_rail:"🚈",metro:"🚇",monorail:"🚝",railway_car:"🚃",trolleybus:"🚎",bus:"🚌",oncoming_bus:"🚍",blue_car:"🚙",oncoming_automobile:"🚘",car:"🚗",red_car:"🚗",taxi:"🚕",oncoming_taxi:"🚖",articulated_lorry:"🚛",truck:"🚚",rotating_light:"🚨",emergency:"🆘",police_car:"🚓",oncoming_police_car:"🚔",fire_engine:"🚒",ambulance:"🚑",minibus:"🚐",bike:"🚲",bicycle:"🚲",aerial_tramway:"🚡",suspension_railway:"🚟",mountain_cableway:"🚠",tractor:"🚜",barber:"💈",busstop:"🚏",ticket:"🎫",vertical_traffic_light:"🚦",semaphore:"🚦",traffic_light:"🚥",warning:"⚠️",wip:"🚧",construction:"🚧",beginner:"🔰",fuelpump:"⛽",izakaya_lantern:"🏮",lantern:"🏮",slot_machine:"🎰",hotsprings:"♨️",moyai:"🗿",stone:"🗿",circus_tent:"🎪",performing_arts:"🎭",theater:"🎭",drama:"🎭",round_pushpin:"📍",triangular_flag_on_post:"🚩",jp:"🇯🇵",kr:"🇰🇷",korea:"🇰🇷",de:"🇩🇪",flag:"🇬🇧",germany:"🇩🇪",cn:"🇨🇳",china:"🇨🇳",us:"🇺🇸",united:"🇺🇸",america:"🇺🇸",fr:"🇫🇷",france:"🇫🇷",french:"🇫🇷",es:"🇪🇸",spain:"🇪🇸",it:"🇮🇹",italy:"🇮🇹",ru:"🇷🇺",russia:"🇷🇺",gb:"🇬🇧",uk:"🇬🇧",british:"🇬🇧",one:"1️⃣",two:"2️⃣",three:"3️⃣",four:"4️⃣",five:"5️⃣",six:"6️⃣",seven:"7️⃣",eight:"8️⃣",nine:"9️⃣",zero:"0️⃣",keycap_ten:"🔟",numbers:"🔢",hash:"#️⃣",number:"#️⃣",symbols:"🔣",arrow_up:"⬆️",arrow_down:"⬇️",arrow_left:"⬅️",arrow_right:"➡️",capital_abcd:"🔠",letters:"🔠",abcd:"🔡",abc:"🔤",alphabet:"🔤",arrow_upper_right:"↗️",arrow_upper_left:"↖️",arrow_lower_right:"↘️",arrow_lower_left:"↙️",left_right_arrow:"↔️",arrow_up_down:"↕️",arrows_counterclockwise:"🔄",sync:"🔄",arrow_backward:"◀️",arrow_forward:"▶️",arrow_up_small:"🔼",arrow_down_small:"🔽",leftwards_arrow_with_hook:"↩️","return":"↩️",arrow_right_hook:"↪️",information_source:"ℹ️",rewind:"⏪",fast_forward:"⏩",arrow_double_up:"⏫",arrow_double_down:"⏬",arrow_heading_down:"⤵️",arrow_heading_up:"⤴️",yes:"🆗",twisted_rightwards_arrows:"🔀",shuffle:"🔀",repeat:"🔁",loop:"➿",repeat_one:"🔂","new":"🆕",fresh:"🆕",up:"🆙",free:"🆓",ng:"🆖",signal_strength:"📶",wifi:"📶",cinema:"🎦",movie:"🎦",koko:"🈁",u6307:"🈯",u7a7a:"🈳",u6e80:"🈵",u5408:"🈴",u7981:"🈲",ideograph_advantage:"🉐",u5272:"🈹",u55b6:"🈺",u6709:"🈶",u7121:"🈚",restroom:"🚾",mens:"🚹",womens:"🚺",baby_symbol:"🚼",potable_water:"🚰",put_litter_in_its_place:"🚮",parking:"🅿️",wheelchair:"♿",accessibility:"♿",no_smoking:"🚭",u6708:"🈷️",u7533:"🈸",sa:"🈂️",m:"Ⓜ️",passport_control:"🛂",baggage_claim:"🛄",airport:"🛄",left_luggage:"🛅",customs:"🛃",accept:"🉑",secret:"㊙️",congratulations:"㊗️",cl:"🆑",sos:"🆘",help:"🆘",id:"🆔",no_entry_sign:"🚫",block:"🚫",forbidden:"🚫",underage:"🔞",no_mobile_phones:"📵",do_not_litter:"🚯","non-potable_water":"🚱",no_bicycles:"🚳",no_pedestrians:"🚷",children_crossing:"🚸",no_entry:"⛔",limit:"⛔",eight_spoked_asterisk:"✳️",sparkle:"❇️",negative_squared_cross_mark:"❎",white_check_mark:"✅",eight_pointed_black_star:"✴️",heart_decoration:"💟",vs:"🆚",vibration_mode:"📳",mobile_phone_off:"📴",a:"🅰️",b:"🅱️",ab:"🆎",o2:"🅾️",diamond_shape_with_a_dot_inside:"💠",recycle:"♻️",environment:"♻️",aries:"♈",taurus:"♉",gemini:"♊",cancer:"♋",leo:"♌",virgo:"♍",libra:"♎",scorpius:"♏",sagittarius:"♐",capricorn:"♑",aquarius:"♒",pisces:"♓",ophiuchus:"⛎",six_pointed_star:"🔯",atm:"🏧",chart:"💹",heavy_dollar_sign:"💲",currency_exchange:"💱",copyright:"©️",registered:"®️",tm:"™️",trademark:"™️",x:"❌",bangbang:"‼️",interrobang:"⁉️",exclamation:"❗",heavy_exclamation_mark:"❗",bang:"❗",question:"❓",grey_exclamation:"❕",grey_question:"❔",o:"⭕",top:"🔝",end:"🔚",back:"🔙",on:"🔛",soon:"🔜",arrows_clockwise:"🔃",clock12:"🕛",clock1230:"🕧",clock1:"🕐",clock130:"🕜",clock2:"🕑",clock230:"🕝",clock3:"🕒",clock330:"🕞",clock4:"🕓",clock430:"🕟",clock5:"🕔",clock530:"🕠",clock6:"🕕",clock7:"🕖",clock8:"🕗",clock9:"🕘",clock10:"🕙",clock11:"🕚",clock630:"🕡",clock730:"🕢",clock830:"🕣",clock930:"🕤",clock1030:"🕥",clock1130:"🕦",heavy_multiplication_x:"✖️",heavy_plus_sign:"➕",heavy_minus_sign:"➖",heavy_division_sign:"➗",spades:"♠️",hearts:"♥️",clubs:"♣️",diamonds:"♦️",white_flower:"💮",score:"💯",perfect:"💯",heavy_check_mark:"✔️",ballot_box_with_check:"☑️",radio_button:"🔘",link:"🔗",curly_loop:"➰",wavy_dash:"〰️",part_alternation_mark:"〽️",trident:"🔱",black_medium_square:"◼️",white_medium_square:"◻️",black_medium_small_square:"◾",white_medium_small_square:"◽",black_small_square:"▪️",white_small_square:"▫️",small_red_triangle:"🔺",black_square_button:"🔲",white_square_button:"🔳",black_circle:"⚫",white_circle:"⚪",red_circle:"🔴",large_blue_circle:"🔵",small_red_triangle_down:"🔻",white_large_square:"⬜",black_large_square:"⬛",large_orange_diamond:"🔶",large_blue_diamond:"🔷",small_orange_diamond:"🔸",small_blue_diamond:"🔹"},c.exports=f}),define("app/document/Node2Mark",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils"],function(a,b,c){"use strict";var d=(a("exoskeleton-master/exoskeleton"),a("app/document/Node")),e=d.Node,f=d.NodeMap,g=d.TYPE,h=a("app/document/StringUtils"),i="",j=/\uE027/gi,k=["-","+","*"];e.UL_DEFAULT_START=k,e.prototype.toMark=function(){var a=l.call(this);return a instanceof Array?a.join(File.useCRLF?"\r\n":"\n").replace(j,""):a};var l=function(){function a(a){if(a.get("children").length)return p(a.get("children"));var b=a.get("text")?a.get("text"):"";return b=b.replace(/(\u200B*):(\u200B*)/g,":").replace(/\u200B\$/,"$")}function b(a,b){d(a,b.get("ahead")||0)}function c(a,b,c){void 0===c&&(c=b.get("after")?1:0),d(a,void 0==b.get("tail")?c:b.get("tail"))}function d(a,b){for(var c=0;b>c;c++)a.push("")}function f(a){return e.isType(a.get("parent"),g.list_item)&&a.get("parent").get("tight")!==!1}var k,q,r,s=[];try{switch(this.get("type")){case g.meta_block:return s.push("---"),s.push((this.get("text")||i).replace(/^---/gm,"​---")),s.push("---"),c(s,this),s;case g.heading:return b(s,this),this.get("pattern")?s=s.concat(this.get("pattern").replace("{0}",a(this)).split(/\r*\n/)):!e.isType(this.get("parent"),g.list_item)&&File.option.headingStyle&&this.get("depth")<=2?(s.push(a(this)),s.push(1==this.get("depth")?"===":"---")):s.push("#".repeat(this.get("depth"))+" "+a(this)),c(s,this),s;case g.paragraph:b(s,this),q=a(this),s=s.concat(q);var t=this.get("tail");return void 0===t&&this.get("after")&&e.isType(this.get("parent"),g.list_item)&&(t=f(this)?0:void 0),e.isType(this.get("after"),g.paragraph)&&1>t&&this.unset("tail"),e.isType(this.get("after"),g.math_block)&&!this.get("tail")&&(t=0),void 0===t?c(s,this,t):d(s,t),s;case g.line:return q=(this.get("text")||i).replace(/\r*\n+/g,""),q=q.replace(/^( {4}|\t)/gm,"​$1"),s.push(q),s;case g.blockquote:return b(s,this),q=a(this),r=o(g.blockquote,0,this,this.get("pattern")),q.map(function(a,b){q[b]=a?r+a:r.replace(/\s+$/,"")}),s=s.concat(q),c(s,this),""!==s.last()&&e.isType(this.get("after"),g.blockquote)&&s.push(""),s;case g.list:b(s,this);var u=this.get("style"),v=this.isLoose(),w=this.get("children").length,x=this;if(w)for(var y=this.getFirstChild(),z=y,A=Number.isNaN(Number.parseInt(this.get("start")))?0:Number.parseInt(this.get("start"))-1,B=0;z;){z.set("tight",!v),q=l.call(z),k=this.get("pattern"),v&&k&&z.get("markindent")&&(k=n(u,k.trim(),z.get("markindent"))),z.get("prespace")&&(k=" ".repeat(z.get("prespace"))+k),r=o(u,B+A,z,k,(w+"").length);var C=r.length,D=u==e.ListType.ol?(B+A+"").length-1:0;z.get("subindent")?C=Math.min(r.replace(/\s+$/,"").length+4,z.get("subindent")+D):x.get("subindent")&&(C=Math.min(r.replace(/\s+$/,"").length+4,x.get("subindent")+D)),q.map(function(a,b){q[b]=(b?a?" ".repeat(C):"":r)+q[b],s.push(q[b].replace(j,"​"))}),B++,z=z.get("after")}return e.isType(this.get("after"),g.list)&&(!this.get("tail")||this.get("tail"))<2&&this.get("pattern")==this.get("after").get("pattern")&&this.get("style")==this.get("after").get("style")&&(this.unset("tail"),s.push(""),f(this)&&s.push("")),c(s,this,f(this)?0:void 0),s;case g.list_item:q=a(this),q instanceof Array?s=s.concat(q):s.push(q);var t=this.get("tail");for(void 0==t&&!this.get("tight")&&this.get("after")&&(t=1),t>0&&s.push("");s.length>2&&""===s.last()&&""===s[s.length-2];)s.pop();return s;case g.fences:b(s,this);var E=this.getText();q=E.split(/\r*\n/),this.get("lang")?(this.get("pattern")||"").trim()?k=this.get("pattern"):(this.unset("pattern"),k="```{0}"):k=this.get("pattern")||"```{0}";for(var F="​$1",G=k.match(/^\s+$/),B=0;B<q.length;B++)q[B]=(G?k:"")+q[B].replace(/^(`{3}|~{3})/gi,F);return!G&&s.push(k.replace(/\{0\}/,h.escape(this.get("lang")||""))),s=s.concat(q),!G&&s.push(k.replace(/\s*\{0\}/,"")),c(s,this),s;case g.math_block:return b(s,this),s.push("$$"),s=s.concat(this.get("text").replace(/(^\n)|(\n$)/g,"").split(/\r?\n/)),s.push("$$"),c(s,this,e.isType(this.get("after"),g.paragraph)&&e.isType(this.get("before"),g.paragraph)?0:1),s;case g.hr:return s.push(this.get("pattern")||"------"),c(s,this),s;case g.def_footnote:return b(s,this),s.push("[^"+this.get("ref")+"]: "+a(this)),c(s,this,!this.get("after")||e.isType(this.get("after"),e.TYPE.def_footnote)?0:1),s;case g.def_link:b(s,this);var H,I=this.safeGetStrAttr("title",!0).length;if(this.get("pattern")){var J=this.get("pattern").split(";");H=J[0]+this.get("ref")+J[1]+this.safeGetStrAttr("href",!0)+J[2],I&&(H+=(J[3]||"	")+'"'+this.get("title")+'"')}else H="["+this.get("ref")+"]: "+this.safeGetStrAttr("href",!0)+(I?'	"'+this.get("title")+'"':"");return s.push(H),c(s,this,!this.get("after")||e.isType(this.get("after"),e.TYPE.def_link)?0:1),s;case g.table:b(s,this);for(var K,L,M,N,O,P,Q=[],R=[],S=0,T=this.getFirstChild();T;){for(K=T.getFirstChild(),R[S]=[],L=0;K;)R[S][L]=K.toMark().trim(),K=K.get("after"),0===S&&(Q[L]=4),Q[L]=Math.max(R[S][L].length,Q[L]),Q[L]=Math.min(Q[L],40),L++;T=T.get("after"),S++}for(S=0;S<R.length;S++){for(M="| ",L=0;L<Q.length;L++)N=Math.max(Q[L]-R[S][L].length,0),O=this.get("align")[L],"right"==O?M+=" ".repeat(N)+R[S][L]:"center"==O?(P=~~(N/2),M+=" ".repeat(P)+R[S][L]+" ".repeat(N-P)):M+=R[S][L]+" ".repeat(N),M+=" | ";if(s.push(M.replace(/\s$/,"")),0===S){for(M="| ",L=0;L<Q.length;L++)O=this.get("align")[L],M+="right"==O?"-".repeat(Q[L]-1)+":":"center"==O?":"+"-".repeat(Q[L]-2)+":":"left"==O?":"+"-".repeat(Q[L]-1):"-".repeat(Q[L]),M+=" | ";s.push(M.replace(/\s$/,""))}}return c(s,this),s;case g.table_row:for(var z=this.getFirstChild(),M="| ";z;)M+=z.toMark()+" | ";return M.replace(/\s$/,"");case g.table_cell:return m(a(this));case g.toc:return b(s,this),s.push(this.get("pattern")||"[TOC]"),~(this.get("pattern")||"").indexOf("\n")&&this.get("after")?c(s,this,2):c(s,this),s;default:return a(this)}}catch(U){return console.error(U.stack),s}},m=function(a){var b="",c="",d=[],e=0,f=0;return a.replace(/(^|[^\\])`[^`]*\|[^`]*`/g,function(a){return d.push(a),e++,[b,e-1,c].join("")}).replace(/\|/g,"\\|").replace(/\\\\\|/g,"\\|").replace(/\uE07A[^\uE07B]+\uE07B/g,function(){return f++,d[f-1]})},n=function(a,b,c){return c=c||File.option.indentSize,a==g.blockquote?">"+" ".repeat(Math.min(c-1,4)):a===e.ListType.ol?"{0}."+" ".repeat(Math.min(c-2,4)||1):a===e.ListType.ul?(b||k[File.option.ulStyle])+" ".repeat(Math.min(c-1,4)):k[File.option.ulStyle]+" "},o=function(a,b,c,d){var f=File.option.indentSize;return b++,d=d||n(a),(!$.isNumeric(f)||2>f)&&(f=2),a==g.blockquote?d:a===e.ListType.ol?d.replace("{0}",b):a===e.ListType.ul?d:d+(c.get("checked")?"[x] ":"[ ] ")};e.markFromArr=function(a){var b=p(a);return b instanceof Array?b.join(File.useCRLF?"\r\n":"\n").replace(j,""):b};var p=function(a){function b(a){var b=l.call(a);b instanceof Array?c=c.concat(b):d+=b}var c=[],d="";if(a.length)if(a instanceof Array)a.map(function(a){b(a)});else{var e=a.sortedFirst();do b(e),e=e.get("after");while(e)}return c.length?c:d};f.prototype.toMark=function(){if(this.blocks.length>0){var a=this.blocks.sortedFirst();a=a.getLastBrother(!0);var b=[],c="";do{var d=l.call(a);d instanceof Array?b=b.concat(d):c+=d,a=a.get("after")}while(a);return b.length?b.join(File.useCRLF?"\r\n":"\n").replace(j,""):c}return""},e.getIndentPrefix=o}),define("app/document/Node2HTML",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/UndoManager","app/editor/Emoji"],function(a,b,c){"use strict";var d=(a("exoskeleton-master/exoskeleton"),a("app/document/Node")),e=d.Node,f=(d.NodeMap,d.TYPE),g=(d.NodeCollectionUtils,a("app/document/StringUtils")),h=a("app/document/MarkParser");e.prototype.toHTML=function(a,b){function c(a){try{return e.isType(a,f.fences,f.hr,f.def_link,f.def_footnote,f.table)?!1:e.isType(a,f.list)&&a.get("style")===e.ListType.task?!1:e.isType(a.get("parent"),f.list_item)&&a.get("parent").get("parent").get("style")===e.ListType.task}catch(b){}return!1}function i(b){var g,i=b.get("children");if(a){if(c(k)){for(var j=[],l=$.parseHTML(a),m=0;m<l.length;m++)j.push($(l[m]).attr("contenteditable","true")[0].outerHTML);a=j.join("")}return a}return i&&i.length>0?d.NodeCollectionUtils.toHTML(i):(g=b.safeGetStrAttr("text"),e.isType(b,f.paragraph)&&/^\u200b( {4}|\t)/g.exec(g)&&(g=g.replace(/^\u200b( {4}|\t)/g,"$1"),b.set("text",g)),h.parseInline(b.safeGetStrAttr("text"),{attr:!e.isType(b,f.heading)}))}function j(a){var d=c(a)?"contenteditable='true'":"",e=b?"mdlike='"+b+"' ":" ",f=" cid = '"+a.id+"' mdtype = '"+a.get("type")+"' "+d+e;return f}var k=this;switch(this.get("type")){case f.meta_block:var l=this.get("text")||"";return l.match(/^\n$/g)&&(l=l.replace(/^\n$/g,"\n\n")),"<pre "+j(this)+" class='md-meta-block md-end-block' >"+g.escape(l,!1,!0)+"\n</pre>";case f.paragraph:return"<p "+j(this)+">"+i(this)+"</p>";case f.line:return"<span class='md-line md-end-block' "+j(this)+">"+i(this)+"</span>";case f.raw_edit:return"<p class='rawedit' contenteditable ='true' "+j(this)+">"+this.safeGetStrAttr("text",!0)+"</p>";case f.heading:return"<h"+this.get("depth")+j(this)+"class='md-end-block md-heading' >"+i(this)+"</h"+this.get("depth")+">";case f.blockquote:return"<blockquote "+j(this)+" >"+i(this)+"</blockquote>";case f.list:var m=this.get("style"),n=((this.get("pattern")||e.UL_DEFAULT_START[File.option.ulStyle]||"*").match(/[*+-]/)||[])[0];if(n=" data-mark='"+n+"' ",m==e.ListType.task)return"<ul class='task-list' style='position:relative;'"+j(this)+n+">"+i(this)+"</ul>";if(m==e.ListType.ol){var o=""===this.get("start")?void 0:this.get("start")-0;return o=Number.isNaN(o)||1==o?"":"start='"+this.get("start")+"' ","<ol class='ol-list' "+o+j(this)+" >"+i(this)+"</ol>"}return"<ul class='ul-list' "+j(this)+n+" >"+i(this)+"</ul>";case f.list_item:return this.get("parent")&&this.get("parent").get("style")===e.ListType.task?"<li class='task-list-item task-list-"+(this.get("checked")?"done":"not-done")+" ' "+j(this)+"><input type='checkbox' "+(this.get("checked")?"checked":"")+"></input>"+i(this)+"</li>":"<li "+j(this)+" >"+i(this)+"</li>";case f.fences:return"<pre class='md-fences mock-cm md-end-block"+(File.option.showLineNumbersForFence?" md-fences-with-lineno":"")+"' lang='"+(this.get("lang")||"").replace(/'/g,"").toLowerCase()+"' contenteditable='false'"+j(this)+">"+(this.get("text")&&this.get("text").trim().length?g.escape(this.get("text")):"<br/>")+"</pre>";case f.hr:return"<div tabindex='-1' contenteditable='false' "+j(this)+" class='md-hr md-end-block' ><hr /></div>";case f.def_footnote:return"<div class='footnotes md-def-footnote md-end-block' contenteditable='false'"+j(this)+"><span class='md-def-name' contenteditable='true'>"+g.escape(this.get("ref")?this.get("ref"):"​")+"</span><span class='md-def-split md-def-f' contenteditable='false' ></span><span class='md-def-content' contenteditable='true'>"+i(this)+"</span></div>";case f.def_link:return"<div class='footnotes md-def-link md-end-block' contenteditable='false'"+j(this)+"><span class='md-def-name' contenteditable='true'>"+g.escape(this.get("ref")?this.get("ref"):"​")+"</span><span class='md-def-split md-def-f' contenteditable='false' ></span><span class='md-def-content md-def-url md-auto-disp' href='link' contenteditable='true'>"+g.escape(this.get("href"))+"</span><span class='md-def-split md-auto-hide' ></span><span class='md-def-title md-auto-disp md-auto-hide' contenteditable='true'>"+g.escape(this.get("title"))+"</span></div>";case f.table:for(var p=(this.get("align").length,"<table class='md-table' contenteditable='false'"+j(this)+">"),q=this.getFirstChild();q;)p+=q.get("before")?q.toHTML():"<thead>"+q.toHTML()+"</thead><tbody>",q=q.get("after"),q||(p+="</tbody>");return p+="</table>";case f.table_row:for(var r,p="<tr class='md-end-block' "+j(this)+">",q=this.getFirstChild(),s=this.get("parent").get("align"),t=0,u=this.get("before")?"td":"th";q;)r=s[t],r=r?" style='text-align:"+r+";' ":"",p+="<"+u+r+">"+q.toHTML()+"</"+u+">",q=q.get("after"),t++;return p+="</tr>";case f.table_cell:return"<span contenteditable='true' class='td-span' "+j(this)+">"+i(this)+"</span>";case f.math_block:return"<div contenteditable='false' class='mathjax-block md-end-block' id='mathjax-"+this.cid+"' "+j(this)+">$$\n"+g.escape(g.useOrDefault(this.get("text"),"<Empty \\space Math \\space Block>"))+"\n$$</div>";case f.toc:return"<div contenteditable='false' tabindex='-1' class='md-toc md-end-block' "+j(this)+"><div class='md-tooltip-hide md-toc-tooltip'> Table of Contents <button type='button' class='btn md-delete-toc'><span class='glyphicon glyphicon-trash'></span></button></div><p class='md-toc-content'></p></div>";default:return"<p "+j(this)+">unknow type: "+this.get("type")+"</p>"}}}),define("app/document/NodeOperation",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/editor/UndoManager","app/editor/Diagram","codemirror/lib/codemirror","app/editor/KeyMaster","rangy/rangy-core"],function(a,b,c){"use strict";function d(a){var b=a.get("parent"),c=b.clone(),d=a.get("after");for(d.set("before",null);d;)d.set("parent",c),d=d.get("after");return b.insert(c),{prev:b,next:c,oldCid:b.cid}}var e=(a("exoskeleton-master/exoskeleton"),a("app/document/Node")),f=e.Node,g=e.TYPE,h=(e.NodeCollectionUtils,a("app/document/StringUtils")),i=a("app/editor/UndoManager"),j=a("app/editor/Diagram"),k=a("rangy/rangy-core.js");f.normalizeNode=function(a){if(0==a.get("children").length){if(f.isType(a,g.paragraph)){var b=new f({type:g.line,text:a.get("text"),parent:a,"in":a.get("in")});return a.unset("text"),b}if(f.isType(a,g.blockquote)){var c=new f({type:g.paragraph,parent:a,"in":a.get("in")});return f.normalizeNode(c)}}};var l=function(a,b){try{var c,d,e=!b.isDeleted()&&b.getClosetParagraphLevel().get("parent");if(e=f.isType(e,g.list_item)&&e.get("parent"),c=f.isType(e,g.list)&&e.get("style"),!c)return;if(d=a.get("text"),d.match(/^(\s{2, }|\t)/))return;c==f.ListType.ol?d=d.replace(/^\s*\d+\.\s*/,""):c==f.ListType.task?d=d.replace(/^\s*[*+-]?[ \t\u00A0]+(\[(x|X)\]|\[ \]\s*)/,""):c==f.ListType.ul&&(d=d.replace(/^\s*[+*-]\s*/,"")),a.set("text",d)}catch(h){}},m=function(a,b,c){return function(d,e){var h,i=!1,j={prev:d,next:e};return d.get("type")==g.line&&(!c&&d.parseFrom(),f.isType(d,g.line)||(i=!0,j.oldCid=d.get("parent").cid,h=d.separateBlockFromLine(),j.prev=h[1],j.opt_prev=h[0])),e.get("type")==g.line&&(!a&&!b&&l(e,d),!c&&e.parseFrom(),f.isType(e,g.line)?a&&f.isType(j.prev,g.math_block,g.fences,g.meta_block)&&(j.prev.set("text",e.get("text")||""),i=!1,e.remove(),j.next=null):(i=!i,h=e.separateBlockFromLine(!0),j.next=h[1],j.opt_next=h[2],f.isType(j.opt_next,g.paragraph)&&f.isType(d,g.line)&&d.get("after")&&d.get("parent").giveChildrenTo(j.opt_next,d.get("after"),null,!0))),i&&(j.prev=f.isType(j.prev,g.line)?j.prev.get("parent"):j.prev,j.next=f.isType(j.next,g.line)?j.next.get("parent"):j.next),!a&&f.isType(j.prev,g.line)?!1:(!j.prev.canContainBlock(!0)&&f.isType(j.prev.get("parent"),g.list_item)&&(b=b||j.prev.get("before"),b||(j.noExit=!0),j.prev.get("parent").get("parent").get("children").toArray().forEach(function(a){a.unset("tail")})),j)}};f.genNormalSplitExitFunc=m,f.prototype.breakOn=function(a,b,c){function d(a){var b=a.get("parent");return f.isType(b,g.list_item)&&!a.get("before")&&!a.get("after")&&!b.get("before")&&!b.get("after")&&b.get("parent").get("attachTo")}function e(e){if(e=e.getClosetBlock(),1>=l&&f.isType(e,g.def_footnote,g.def_footnote)&&!a&&!c&&f.isEmptyBlock(e,null,!0)){var h=i.makeEmptyCommand(b.selection.buildUndo());return h.undo.push(i.buildReplaceUndo(e)),e.unset("ahead"),e.unset("tail"),e.set("type",g.paragraph),f.normalizeNode(e),h.redo.push(i.buildReplaceUndo(e)),h.redo.push({type:"cursor",id:e.getLastChild().cid,start:0}),{command:h,nextFocus:e.getLastChild().cid,oldCid:e.cid,newHtml:e.toHTML()}}if(0==k&&0==l&&!a&&!c&&e.closest(g.blockquote,g.list)&&e.get("parent")&&e.get("parent").canContainBlock(!0)&&!d(e)){var h=i.makeEmptyCommand();h.undo.push(b.selection.buildUndo());var j={},m=e.get("before")&&f.isEmptyBlock(e.get("before"));return j=e.upStream(m),h.undo=h.undo.concat(j.command.undo),h.redo=h.redo.concat(j.command.redo),j.nextFocus=j.nextFocus||e.id,h.redo.push({type:"cursor",id:j.nextFocus,start:0}),j.command=h,j}}function h(d,e){var h,j=i.makeEmptyCommand(),k={},n=e==l&&e>0,o=d.getClosetBlock();return j.undo.push(b.selection.buildUndo()),f.isType(o.get("parent"),g.list_item)&&!a?j.undo.push(b.undo.buildReplaceUndo(o.get("parent"))):j.undo.push(b.undo.buildReplaceUndo(o)),o.unset("ahead"),o.unset("tail"),f.isType(d,g.line)&&f.isEmptyBlock(d,null,!0)&&(c=!1),k=f.splitAt(d,e,b,m(c,a),!c&&!a),j.redo.push(b.undo.buildReplaceUndo(k.prev)),k.oldCid=k.oldCid||k.prev.cid,k.next&&i.addUndoForInsert(j,k.next),k.opt_prev&&i.addUndoForInsert(j,k.opt_prev),k.opt_next&&i.addUndoForInsert(j,k.opt_next),k.newHtml=h&&h.id==k.oldCid?h.toHTML():"",k.newHtml||[k.opt_prev,k.prev,k.next,k.opt_next].map(function(a){a&&(k.newHtml+=a.toHTML())}),f.isType(k.prev,g.meta_block)&&n&&k.prev.get("text").match(/\n$/)?k.nextFocus=k.next.getVeryFirst().id:n&&f.isType(k.prev&&k.prev.getLastChild()||k.prev,g.math_block,g.fences,g.meta_block)?k.nextFocus=k.prev.getVeryFirst(!0).id:n&&f.isType(k.prev,g.table)?k.nextFocus=k.prev.getLastChild().getVeryFirst().cid:k.nextFocus=k.next.getVeryFirst().cid,j.redo.push({type:"cursor",id:k.nextFocus,start:0}),k.command=j,k}function j(a){var c=a.get("parent");if(k==l&&c&&c==b.nodeMap.getFirst()&&f.isType(c,g.paragraph)&&!a.get("before")&&!a.get("after")&&"---"===a.get("text")){var d=b.stylize.insertMetaBlock(!0);return d.command.undo.push(i.buildReplaceUndo(c)),a.set("text",""),d.command.redo.push(i.buildReplaceUndo(c)),d.newHtml=d.node.toHTML()+c.toHTML(),d.nextFocus=d.node.id,d.oldCid=c.id,d}}var k,l;if(f.isType(this,g.def_footnote)){var n=b.getJQueryElem(window.getSelection().baseNode);k=n.closest(".md-def-name").length?b.selection.getOffset(n.closest(".md-def-name")):this.get("ref").length+b.selection.getOffset(n.closest(".md-def-content"))}else k=f.isType(this,g.meta_block)?this.getText(!1).length:b.selection.getOffset(b.findElemById(this.id));if(this.get("children").length)return this.get("children").toArray().map(function(a){b.findElemById(a.id).replaceWith(a.toMark())}),this.clearChildren(),this.set("text",b.findElemById(this.id).text()),h(this,this.get("text").length);if(l=this.getText(!1).length,f.isType(this,g.def_link,g.def_footnote)&&(l+=this.get("ref").length),!this.get("children").length){var o;if(o=e(this.getClosetBlock()))return o;if(o=j(this))return o;if(l>=k)return h(this,k)}},f.isEmptyBlock=function(a,b,c){var d=c?h.isNullOrBlank:h.isNullOrEmpty;if(f.isType(a,b||[]))return!1;if(a.get("children").length){if(f.isType(a,g.paragraph))return 1==a.get("children").length&&d(a.get("children").at(0).get("text"))}else{if(f.isType(a,g.def_link))return d(a.get("ref"))&&d(a.get("href"))&&d(a.get("title"));if(f.isType(a,g.def_footnote))return d(a.get("ref"))&&d(a.get("text"));if(!f.isType(a,g.table_cell,g.table_row,g.hr))return d(a.get("text"))}return!1};var n=function(a,b){return b&&f.isType(a,g.def_link,g.def_footnote)&&f.isEmptyBlock(a)||!b&&f.isType(a,g.meta_block)||f.isType(a,g.heading)&&f.isEmptyBlock(a)?(a.set("type",g.paragraph),a.set("text",""),a.clearChildren(),f.normalizeNode(a),a.id):void 0};f.smartSplit=function(a,b,c){var d,e,f,g=k.createRange();c?(f=$.parseHTML("<span />")[0],a[0].appendChild(f),a.prepend("<span />"),g.moveToBookmark({containerNode:a[0],start:b,end:b}),g.setEndAfter(f),f=g.extractContents(),e=f.querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']"),d=a[0].querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']")):(a[0].childElementCount<3&&(f=$.parseHTML("<span />")[0],a[0].insertBefore(f,a[0].firstChild),a.append("<span />")),g.moveToBookmark({containerNode:a[0],start:0,end:b}),f&&g.setStart(f,0),f=g.extractContents(),d=f.querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']"),
e=a[0].querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']"));for(var h=0;h<d.length;h++){var i=$(d[h]);i.find(":not(.md-meta)").text().length?i.children(".md-after").length||i.append(i.children(".md-before").clone().removeClass("md-before").addClass("md-after")):i.html("")}for(var h=0;h<e.length;h++){var i=$(e[h]);i.find(":not(.md-meta)").text().length?i.children(".md-before").length||i.prepend(i.children(".md-after").clone().removeClass("md-after").addClass("md-before")):i.html("")}for(var j=f.querySelectorAll("svg"),h=0;h<j.length;h++)j[h].parentElement.removeChild(j[h]);return[$(f).text(),a.textExcludeSVG()]},f.splitAt=function(a,b,c,e,h){var i,j,k,l=a.clone();if(e=e||m(!1,!0),h&&f.isType(a,g.line)&&f.isType(a.get("after"),g.line)&&b>=a.get("text").length)return l.remove(),d(a);if(f.isType(a,g.line)&&f.isType(a.get("before"),g.line)&&0==b)return l.remove(),d(a.get("before"));if(f.isType(a,g.paragraph,g.line,g.heading,g.list_item))k=f.smartSplit(c.findElemById(a.id),b),i=k[0],j=k[1],f.isType(a.get("parent"),g.list_item)&&a.get("parent").get("parent").get("children").toArray().forEach(function(a){a.unset("tail")});else if(f.isType(a,g.def_link,g.def_footnote)){var n=a.get("ref");if(b<=n.length)a.set("ref",n.substring(0,b)),l.set("ref",n.substring(b)),l.set("href",a.get("href")),l.set("title",a.get("title")),a.set("href",""),a.set("title",""),i="",j=a.get("text");else if(f.isType(a,g.def_link)){var p=a.get("href")||"",q=a.get("title")||"";b<=n.length+p.length?(a.set("title",""),l.set("ref",""),a.set("href",p.substring(0,b-n.length)),l.set("href",p.substring(b-n.length))):(l.set("ref",""),l.set("href",""),a.set("title",q.substring(0,b-n.length-p.length)),l.set("title",q.substring(b-n.length-p.length)))}else{var r=a.get("text")||"";l.set("ref",""),i=r.substring(0,b-n.length),j=r.substring(b-n.length)}}else i=a.getText().substring(0,b),j=a.getText().substring(b);return a.set("text",i),!f.isType(l,g.paragraph,g.def_link)&&l.set("text",j),o(a,l,void 0,e)},f.prototype.separateBlockFromLine=function(a){var b,c,d=this.get("before"),e=this.get("after"),h=this.get("parent"),i=h;return this.detach(),d&&(a?(i=new f({type:g.paragraph,trim:h.get("trim")}),b=h,b.insert(i,!1)):(b=new f({type:g.paragraph,trim:h.get("trim")}),i.insert(b,!0)),i.giveChildrenTo(b,null,d,!0)),e&&(c=new f({type:g.paragraph,trim:h.get("trim")}),i.giveChildrenTo(c,e,null,!0),i.insert(c,!1)),i.copyContentFrom(this),this.giveChildrenTo(i),this.remove(),b&&b.unset("tail"),i&&i.unset("ahead"),i&&i.unset("tail"),c&&c.unset("ahead"),[b,i,c]};var o=function(a,b,c,d){var e,f=a.isBlock(!0);if(c=c||a.get("parent"),a.set("parent",c),a.insert(b),a.unset("tail"),b.unset("ahead"),d&&f&&(f=d(a,b),"object"==typeof f&&(e=f,a=f.prev,b=f.next,f.noExit&&(f=!1))),f)return n(a,!0),b&&(n(b,!1),a.insert(b)),e=e||{prev:a,next:b,oldCid:a.cid};var g=a.get("parent").clone();return g.set("text",""),a.get("parent").giveChildrenTo(g,b,null,!0),o(a.get("parent"),g,void 0,d)};f.getTreePosition=function(a,b){function c(a){return a.get("parent")?1+c(a.get("parent")):0}function d(a,b){return a==b?[a,a,b]:a.get("parent")==b.get("parent")||!a.get("parent")&&!a.get("parent")?[a.get("parent"),a,b]:d(a.get("parent"),b.get("parent"))}if(a==b)return[a,a,b];var e=c(a)-c(b);if(e>0)for(;e>0;)a=a.get("parent"),e--;else if(0>e)for(;0>e;)b=b.get("parent"),e++;return d(a,b)},f.prototype.copyContentFrom=function(a){var b=this;f.property.map(function(c){b.set(c,a.get(c))})},f.prototype.clone=function(){var a=new f;return a.copyContentFrom(this),a.set("in",this.get("in")),a},f.reverseAttrFromElem=function(a,b,c){var d,e=b.attr("mdtype");switch(a.set("type",e),c&&(b.find("[data-emoji]").text(function(){return this.getAttribute("data-emoji")}),b.find(".md-meta, .md-content").remove()),a.set("text",b.text()),e){case a.TYPE.heading:a.set("depth",b[0].tagName.replace(/H/gi,""));break;case a.TYPE.list:a.set("style",b[0].tagName.toLowerCase()),b.hasClass("task-list")&&a.set("style","taskList");break;case a.TYPE.math_block:break;case a.TYPE.fences:a.set("lang",b.attr("lang")||b.find("input.mode").val()),a.set("text",b.find("textarea[id]").val()||b.text());break;case a.TYPE.list_item:a.set("checked","checked"==b.children("input").attr("checked"));break;case a.TYPE.def_link:a.set("ref",b.find(".md-def-name").text()),a.set("title",b.find(".md-def-title").text()),a.set("href",b.find(".md-def-content").text());break;case a.TYPE.def_footnote:a.set("text",b.find(".md-def-content").text()),a.set("ref",b.find(".md-def-name").text());break;case a.TYPE.table:d=[],b.find("tbody>tr:first").children().toArray().map(function(a){d[a.cellIndex]=a.style.textAlign,""==a.style.textAlign&&(d[a.cellIndex]=null)}),d.length||b.find("thead>tr:first").children().toArray().map(function(a){d[a.cellIndex]=a.style.textAlign,""==a.style.textAlign&&(d[a.cellIndex]=null)}),a.set("align",d);break;case a.TYPE.table_row:a.set("header",b.closest("thead").length>0)}},f.reverse=function(a,b,c){if(a.length&&a[0].hasAttribute("mdtype")){var d,e,g=new f({"in":b});return f.reverseAttrFromElem(g,a,c),g.get("type")==g.TYPE.table?(a.children().children("tr[mdtype]").toArray().map(function(a){e=f.reverse($(a),b,c),e.set("parent",g),e.set("before",d),d=e}),f.TableEdit.valify(g)):g.get("type")==g.TYPE.table_row?a.children().children("span[mdtype]").toArray().map(function(a){e=f.reverse($(a),b,c),e.set("parent",g),e.set("before",d),d=e}):a.children("[mdtype]").toArray().map(function(a){e=f.reverse($(a),b,c),e.set("parent",g),e.set("before",d),d=e}),g}},f.prototype.downStream=function(a){var b=new f({type:a,parent:this.get("parent"),before:this.get("before"),after:this.get("after"),"in":this.get("in"),attachTo:this.get("attachTo")});this.set("parent",b)},f.prototype.upStream=function(a,b){var c,d=this.get("parent"),e={};if(e.command=b||i.makeEmptyCommand(),d)if(!f.isType(d,g.list_item)||this.get("before")||this.get("after")){e.command.undo.push(i.buildReplaceUndo(d)),e.oldCid=d.id;var h=this.get("after"),j=this.get("before"),k=d.get("type")==g.list_item;if(this.set("parent",d.get("parent")),this.get("type")!==g.table&&(this.get("type")==g.list_item&&(this.set("type",g.paragraph),f.normalizeNode(this),e.nextFocus=this.getFirstChild().cid),d.get("type")==g.list_item)){this.set("type",d.get("type"));var l=new f({type:g.paragraph,"in":this.get("in")});this.giveChildrenTo(l),l.set("parent",this),f.normalizeNode(l)}if(e.newHtml=this.toHTML(),h)if(h.set("before",this.canContainBlock(!1)?this.getFirstChild():null),k){do h.set("parent",this),h=h.get("after");while(h);e.newHtml=this.toHTML()}else{c=d.clone();do h.set("parent",c),h=h.get("after");while(h);e.newHtml+=c.toHTML()}j?(e.command.redo.push(i.buildReplaceUndo(d)),i.addUndoForRemove(e.command,this),d.insert(this),i.addUndoForInsert(e.command,this),e.newHtml=d.toHTML()+e.newHtml):(i.addUndoForRemove(e.command,this),d.insert(this,!0),i.addUndoForInsert(e.command,this),i.addUndoForRemove(e.command,d),d.remove()),c&&(this.insert(c),i.addUndoForInsert(e.command,c))}else{var m=i.buildReplaceUndo(d);this.giveChildrenTo(d),this.remove(),e=d.upStream(),e.command.undo.unshift(m),e.nextFocus=e.nextFocus||d.id}return e},f.prototype.attr=function(a,b,c,d){function e(d,e){var f=c.undo.UndoManager.makeEmptyCommand();return f.undo.push({type:"attr",id:d.id,key:a,value:e||d.safeGetStrAttr(a)}),f.redo.push({type:"attr",key:a,id:d.id,value:b}),f}if(this.get(a)!=b)switch(d||(c.store(),c.undo.completeSnap(!0)),d||"align_idx"==a||c.undo.register(e(this)),b="string"==typeof b?h.escape(b):b,a){case"lang":var f=c.fences.getCm(this.id);if(f.options.mode==b)break;j.isDiagramType(f.options.mode)&&c.diagrams.cancelDiagram(this.id),f.setOption("mode",getCodeMirrorMode(b)),f.refresh(),this.set("lang",b),$("[cid='"+this.id+"']").attr("lang",b).find(".CodeMirror").attr("lang",(b||"").toLowerCase()),d&&$("[cid='"+this.id+"'] input.mode").val(b?b:"").focus(),j.isDiagramType(b)&&c.diagrams.updateDiagram(this.id);break;case"checked":var i=document.querySelector("[cid='"+this.id+"']>input");b?(i.setAttribute("checked","checked"),i.parentElement.classList.remove("task-list-not-done"),i.parentElement.classList.add("task-list-done")):(i.removeAttribute("checked"),i.parentElement.classList.remove("task-list-done"),i.parentElement.classList.add("task-list-not-done")),i.checked=b||!1,this.set("checked",b||!1);break;case"href-title":if(this.get("type")==g.image){var k=b.split(/\s/);if(c.findElemById(this.id).find("img").attr("src",k[0]),this.set("href",k[0]),this.set("title",k[1]),d){var l=$("[cid='"+this.id+"']");l.hasClass("onfocus")||(l.addClass("onfocus").focus(),c.EditHelper.showTooltipForImage(c,l),$("[cid='"+this.id+"'] input.t-bracket-input").val(b?b:"").focus())}}break;case"alt":if(this.get("type")==g.image&&(c.findElemById(this.id).find("img").attr("alt",b),this.set("alt",b),d)){var l=$("[cid='"+this.id+"']");l.hasClass("onfocus")||(l.addClass("onfocus").focus(),c.EditHelper.showTooltipForImage(c,l),$("[cid='"+this.id+"'] input.t-alt-input").val(b?b:"").focus())}break;case"align_idx":if(this.get("type")==g.table){var m=b[0],n=b[1],l=c.findElemById(this.id);!d&&c.undo.register(e(this,[m,this.get("align")[m]])),this.get("align")[m]=n,n=n?n:"",l.find(".md-table-edit>tr>th:nth-child("+(m+2)+") .btn").removeClass("active").blur(),l.find(".md-table-edit>tr>th:nth-child("+(m+2)+") .md-align-"+n).addClass("active").focus(),l.find("thead:not(.md-table-edit)>tr>th:nth-child("+(m+1)+")").css("text-align",n),l.find("tbody>tr>td:nth-child("+(m+1)+")").css("text-align",n),d&&c.tableEdit.showTableEdit(l)}}},f.prototype.unwrap=function(a){var b=[],c=this,d=this.getFirstChild();do{var f=d.get("after");d.set("parent",c.get("parent")),d.set("attachTo",c.get("attachTo")),d.get("before")||d.set("before",c.get("before")),d.get("after")||d.set("after",c.get("after")),b.push(d),d.get("pattern")&&d.set("pattern",d.get("pattern").replace(/^\s+/,"")),d=f}while(d);return this.remove(!0),a&&a.findElemById(this.cid).replaceWith(e.NodeCollectionUtils.toHTML(b)),b},f.prototype.wrap=function(a,b,c,d){for(var e,f=a,g=[],h={parent:a.get("parent"),before:a.get("before"),after:b?b.get("after"):a.get("after")};f&&f!=h.after;)c&&c.findElemById(f.id).remove(),e=f,f=f.get("after"),this.append(e);h.after&&(h.after.insert(this,!0),d||(g=c.findElemById(h.after.id),g.before(this.toHTML()))),!g.length&&h.before&&(h.before.insert(this,!1),d||(g=c.findElemById(h.before.id),g.after(this.toHTML()))),g.length||(h.parent?(this.set("parent",h.parent),!d&&c&&c.findElemById(h.parent.id).html(this.toHTML())):d||0!==$(c.sessionStr).children().length||(this.set("attachTo",this.get("in")),c&&$(c.sessionStr).html(this.toHTML())))}}),define("app/editor/Diagram",["codemirror/lib/codemirror","app/document/StringUtils","jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/editor/KeyMaster"],function(a,b,c){"use strict";var d,e=a("codemirror/lib/codemirror"),f=(a("app/document/StringUtils"),a("jquery/jquery")),g=a("exoskeleton-master/exoskeleton"),h=a("app/document/Node"),i=a("app/editor/KeyMaster"),j=(i.map,h.TYPE),k=h.Node,l={},m={},n=0,o=g.Model.extend({initialize:function(a){this.editor=a},cancelDiagram:function(a){var b=this.editor.fences.getCm(a);this.editor.findElemById(a).find(".md-diagram-panel").remove().end()[0].style.marginBottom="",l[a]&&clearTimeout(l[a]),l[a]=void 0,m[a]=void 0,e.clearMarks(b),b.getWrapperElement().offsetHeight||b.refresh()},refreshDiagram:function(a){var b=this;f(".md-fences").each(function(){(a||o.isDiagramType(this.getAttribute("lang"))&&!this.querySelector("svg"))&&(b.editor.fences.getCm(this.getAttribute("cid")),b.updateDiagram(this.getAttribute("cid"),!0))})},lazyload:function(){function b(){c.modeLoaded=!0,mermaidAPI.initialize({cloneCssStyles:!1,startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!1},sequenceDiagram:{useMaxWidth:!1,diagramMarginX:10,diagramMarginY:8,boxMargin:20},gantt:{leftPadding:0,rightPadding:0}}),mermaidAPI.parseError=function(a,b){throw b.message=a,d=b,new Error(b.message)},console.debug("diagram dependents are loaded"),f(e.sessionStr).on("click",".md-diagram-panel",function(a){this.previousSibling.classList.contains("CodeMirror-focused")||this.previousSibling.CodeMirror.focus()}).addClass("enable-diagrams"),c.refreshDiagram()}if(File.option.enableDiagram){var c=this,e=this.editor;window.debugMode?File.isNode?a.async("diagram/diagram.min.js",b):a.async(["diagram/mermaidAPI.js","diagram/raphael.js"],function(){a.async(["diagram/sequence-diagram.js","diagram/flowchart.js"],function(){b()})}):a.async(File.isMac||window.debugMode?"lib/diagram/diagram.min.js":"lib.asar/diagram/diagram.min.js",b)}},startPreview:function(a){var b=this.editor.getNode(a).get("lang"),c=this.editor.fences.getCm(a);if(o.isDiagramType(b)){var d=this.editor.findElemById(a),e=d.find(".md-diagram-panel");e.length||(e=f("#componenet .md-diagram-panel").clone().attr("mdtype",j.math_block),d.append(e),this.updateDiagram(a),c.setOption("lint",{getAnnotations:function(){return[]}})),d[0].style.marginBottom=d[0].classList.contains("md-focus")?e.height()+50+"px":""}},updateDiagram:function(a,b,c){function f(a){t.find(".md-diagram-panel-error")[0].innerHTML="",e.clearMarks(s),a&&(m[s.cid]=null)}function g(c,d){c.loc&&(m[a]=c,c.message="["+d+"]"+c.message,b?document.querySelector("[cid='"+a+"'] .md-diagram-panel-error").textContent=c.message:c.loc.first_line-1==(s.getCursor()||{}).line&&s.doc.lineCount()>1?f():q.diagrams.attachError(s,c))}function h(){try{p=Diagram.parse(s.getValue()||"title: Empty Diagram"),m[a]=null}catch(b){return void g(b,"Sequence")}f(!0),t.find(".md-diagram-panel-preview")[0].innerHTML="",p.drawSVG(t.find(".md-diagram-panel-preview")[0],{theme:"simple"})}function i(){try{f(!0),p=flowchart.parse(s.getValue()),t.find(".md-diagram-panel-preview")[0].innerHTML="",p.drawSVG(t.find(".md-diagram-panel-preview")[0],{y:0,"font-color":"currentColor","line-color":"currentColor","element-color":"currentColor",fill:"transparent"})}catch(a){return}}function j(){f(!0);var a=0,b=t.find(".md-diagram-panel-preview")[0],c=s.getValue().replace(/^(\s*(%%.*)*\n)+/,function(b){return a+=b.match(/\n/g).length,""}),e=(c.match(/\s*([^\s]+)/)||["",""])[1];r[0].setAttribute("mermaid-type",e);var h=function(a){if(b.innerHTML=a,a){var c=b.children[0];c.getAttribute("height")&&"100%"!=c.getAttribute("height")&&(c.style.height=c.getAttribute("viewBox").split(/\s/)[3]-0+40+"px")}};try{if(d=null,h(""),0==c.trim().length?h("<text>Empty Diagram</text>"):mermaidAPI.render("mermaidChart"+n++,c,h,b),d)throw d}catch(i){return i.loc?(i.loc.first_line+=a,i.loc.last_line+=a,i.message=i.message.replace(/^[^\n]*(\d)/,function(b,c){return"Parse error on line "+(c-0+a)})):i.loc={first_line:i.line+1,last_line:i.line+1},void g(i,"Mermaid")}f(!0)}function o(){if(k.isType(s.options.mode,"sequence"))h();else if(k.isType(s.options.mode,"flow"))i();else{if(!k.isType(s.options.mode,"mermaid"))return;j()}var b=t.closest("[cid]")[0];b.style.marginBottom=b.classList.contains("md-focus")?t.height()+40+"px":"",l[a]=null}var p,q=this.editor,r=this.editor.findElemById(a),s=this.editor.fences.getCm(a),t=r.find(".md-diagram-panel");return r[0].removeAttribute("mermaid-type"),t.length?(l[a]&&clearTimeout(l[a]),void(c?o():l[a]=setTimeout(o,200))):q.diagrams.startPreview(a)},attachError:function(a,b){if(b=b||m[a.cid],e.clearMarks(a),b){var c={from:e.Pos(b.loc.first_line-1,b.loc.first_column),to:e.Pos(b.loc.last_line-1,b.loc.last_column||a.doc.getLine(b.loc.last_line-1).length),message:b.message};document.querySelector("[cid='"+a.cid+"'] .md-diagram-panel-error").textContent=b.message,e.updateLinting(a,[c])}}});o.isDiagramType=function(a){return File.option.enableDiagram&&k.isType(a,"sequence","flow","mermaid")},c.exports=o}),define("codemirror/lib/codemirror",[],function(a,b,c){c.exports=function(){"use strict";function a(c,d,e,f){if(!(this instanceof a))return new a(c,d,e,f);this.options=d=d||{},ce(qf,d,!1),o(d);var g=d.value;"string"==typeof g&&(g=new Of(g,d.mode)),this.doc=g;var h=this.display=new b(c,g);h.wrapper.CodeMirror=this,k(this),i(this),d.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),d.autofocus&&!Ve&&nb(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,draggingText:!1,highlight:new Xd},Fe&&setTimeout(de(mb,this,!0),20),qb(this);var j=this;Ya(this,function(){j.curOp.forceUpdate=!0,qd(j,g),d.autofocus&&!Ve||ke()==h.input?setTimeout(de(Mb,j),20):Nb(j);for(var a in rf)rf.hasOwnProperty(a)&&rf[a](j,d[a],sf);for(var b=0;b<wf.length;++b)wf[b](j)}),j.editor=e,j.cid=f}function b(a,b){var c=this,d=c.input=ge("textarea",null,null,"position: absolute; padding: 0; width: 1px; height: 1em; outline: none");Le?d.style.width="1000px":d.setAttribute("wrap","off"),Ue&&(d.style.border="1px solid black"),d.setAttribute("autocorrect","off"),d.setAttribute("autocapitalize","off"),d.setAttribute("spellcheck","false"),c.inputDiv=ge("div",[d],null,"overflow: hidden; position: relative; width: 3px; height: 0px;"),c.scrollbarH=ge("div",[ge("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar"),c.scrollbarV=ge("div",[ge("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),c.scrollbarFiller=ge("div",null,"CodeMirror-scrollbar-filler"),c.gutterFiller=ge("div",null,"CodeMirror-gutter-filler"),c.lineDiv=ge("div",null,"CodeMirror-code"),c.selectionDiv=ge("div",null,null,"position: relative; z-index: 1"),c.cursorDiv=ge("div",null,"CodeMirror-cursors"),c.measure=ge("div",null,"CodeMirror-measure"),c.lineMeasure=ge("div",null,"CodeMirror-measure"),c.lineSpace=ge("div",[c.measure,c.lineMeasure,c.selectionDiv,c.cursorDiv,c.lineDiv],null,"position: relative; outline: none"),c.mover=ge("div",[ge("div",[c.lineSpace],"CodeMirror-lines")],null,"position: relative"),c.sizer=ge("div",[c.mover],"CodeMirror-sizer"),c.heightForcer=ge("div",null,null,"position: absolute; height: "+Zf+"px; width: 1px;"),c.gutters=ge("div",null,"CodeMirror-gutters"),c.lineGutter=null,c.scroller=ge("div",[c.sizer,c.heightForcer,c.gutters],"CodeMirror-scroll"),c.scroller.setAttribute("tabIndex","-1"),c.wrapper=ge("div",[c.inputDiv,c.scrollbarH,c.scrollbarV,c.scrollbarFiller,c.gutterFiller,c.scroller],"CodeMirror"),Ge&&(c.gutters.style.zIndex=-1,c.scroller.style.paddingRight=0),Ue&&(d.style.width="0px"),Le||(c.scroller.draggable=!0),Qe&&(c.inputDiv.style.height="1px",c.inputDiv.style.position="absolute"),Ge&&(c.scrollbarH.style.minHeight=c.scrollbarV.style.minWidth="18px"),a.appendChild?a.appendChild(c.wrapper):a(c.wrapper),c.viewFrom=c.viewTo=b.first,c.view=[],c.externalMeasured=null,c.viewOffset=0,c.lastSizeC=0,c.updateLineNumbers=null,c.lineNumWidth=c.lineNumInnerWidth=c.lineNumChars=null,c.prevInput="",c.alignWidgets=!1,c.pollingFast=!1,c.poll=new Xd,c.cachedCharWidth=c.cachedTextHeight=c.cachedPaddingH=null,c.inaccurateSelection=!1,c.maxLine=null,c.maxLineLength=0,c.maxLineChanged=!1,c.wheelDX=c.wheelDY=c.wheelStartX=c.wheelStartY=null,c.shift=!1}function c(b){b.doc.mode=a.getMode(b.options,b.doc.modeOption),d(b)}function d(a){a.doc.iter(function(a){a.stateAfter&&(a.stateAfter=null),a.styles&&(a.styles=null)}),a.doc.frontier=a.doc.first,sa(a,100),a.state.modeGen++,a.curOp&&cb(a)}function e(a){a.options.lineWrapping?(ne(a.display.wrapper,"CodeMirror-wrap"),a.display.sizer.style.minWidth=""):(me(a.display.wrapper,"CodeMirror-wrap"),n(a)),g(a),cb(a),Ja(a),setTimeout(function(){q(a)},100)}function f(a){var b=Ua(a.display),c=a.options.lineWrapping,d=c&&Math.max(5,a.display.scroller.clientWidth/Va(a.display)-3);return function(e){if(Rc(a.doc,e))return 0;var f=0;if(e.widgets)for(var g=0;g<e.widgets.length;g++)e.widgets[g].height&&(f+=e.widgets[g].height);return c?f+(Math.ceil(e.text.length/d)||1)*b:f+b}}function g(a){var b=a.doc,c=f(a);b.iter(function(a){var b=c(a);b!=a.height&&ud(a,b)})}function h(a){var b=Bf[a.options.keyMap],c=b.style;a.display.wrapper.className=a.display.wrapper.className.replace(/\s*cm-keymap-\S+/g,"")+(c?" cm-keymap-"+c:"")}function i(a){a.display.wrapper.className=a.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+a.options.theme.replace(/(^|\s)\s*/g," cm-s-"),Ja(a)}function j(a){k(a),cb(a),setTimeout(function(){s(a)},20)}function k(a){var b=a.display.gutters,c=a.options.gutters;he(b);for(var d=0;d<c.length;++d){var e=c[d],f=b.appendChild(ge("div",null,"CodeMirror-gutter "+e));"CodeMirror-linenumbers"==e&&(a.display.lineGutter=f,f.style.width=(a.display.lineNumWidth||1)+"px")}b.style.display=d?"":"none",l(a)}function l(a){var b=a.display.gutters.offsetWidth;a.display.sizer.style.marginLeft=b+"px",a.display.scrollbarH.style.left=a.options.fixedGutter?b+"px":0}function m(a){if(0==a.height)return 0;for(var b,c=a.text.length,d=a;b=Kc(d);){var e=b.find(0,!0);d=e.from.line,c+=e.from.ch-e.to.ch}for(d=a;b=Lc(d);){var e=b.find(0,!0);c-=d.text.length-e.from.ch,d=e.to.line,c+=d.text.length-e.to.ch}return c}function n(a){var b=a.display,c=a.doc;b.maxLine=rd(c,c.first),b.maxLineLength=m(b.maxLine),b.maxLineChanged=!0,c.iter(function(a){var c=m(a);c>b.maxLineLength&&(b.maxLineLength=c,b.maxLine=a)})}function o(a){var b=_d(a.gutters,"CodeMirror-linenumbers");-1==b&&a.lineNumbers?a.gutters=a.gutters.concat(["CodeMirror-linenumbers"]):b>-1&&!a.lineNumbers&&(a.gutters=a.gutters.slice(0),a.gutters.splice(b,1))}function p(a){var b=a.display.scroller;return{clientHeight:b.clientHeight,barHeight:a.display.scrollbarV.clientHeight,scrollWidth:b.scrollWidth,clientWidth:b.clientWidth,barWidth:a.display.scrollbarH.clientWidth,docHeight:Math.round(a.doc.height+xa(a.display))}}function q(a,b){b||(b=p(a));var c=a.display,d=b.docHeight+Zf,e=b.scrollWidth>b.clientWidth,f=d>b.clientHeight;if(f?(c.scrollbarV.style.display="block",c.scrollbarV.style.bottom=e?pe(c.measure)+"px":"0",c.scrollbarV.firstChild.style.height=Math.max(0,d-b.clientHeight+(b.barHeight||c.scrollbarV.clientHeight))+"px"):(c.scrollbarV.style.display="",c.scrollbarV.firstChild.style.height="0"),e?(c.scrollbarH.style.display="block",c.scrollbarH.style.right=f?pe(c.measure)+"px":"0",c.scrollbarH.firstChild.style.width=b.scrollWidth-b.clientWidth+(b.barWidth||c.scrollbarH.clientWidth)+"px"):(c.scrollbarH.style.display="",c.scrollbarH.firstChild.style.width="0"),e&&f?(c.scrollbarFiller.style.display="block",c.scrollbarFiller.style.height=c.scrollbarFiller.style.width=pe(c.measure)+"px"):c.scrollbarFiller.style.display="",e&&a.options.coverGutterNextToScrollbar&&a.options.fixedGutter?(c.gutterFiller.style.display="block",c.gutterFiller.style.height=pe(c.measure)+"px",c.gutterFiller.style.width=c.gutters.offsetWidth+"px"):c.gutterFiller.style.display="",Re&&0===pe(c.measure)){c.scrollbarV.style.minWidth=c.scrollbarH.style.minHeight=Se?"18px":"12px";var g=function(b){Pd(b)!=c.scrollbarV&&Pd(b)!=c.scrollbarH&&Za(a,tb)(b)};Vf(c.scrollbarV,"mousedown",g),Vf(c.scrollbarH,"mousedown",g)}}function r(a,b,c){var d=c&&null!=c.top?c.top:a.scroller.scrollTop;d=Math.floor(d-wa(a));var e=c&&null!=c.bottom?c.bottom:d+a.wrapper.clientHeight,f=wd(b,d),g=wd(b,e);if(c&&c.ensure){var h=c.ensure.from.line,i=c.ensure.to.line;if(f>h)return{from:h,to:wd(b,xd(rd(b,h))+a.wrapper.clientHeight)};if(Math.min(i,b.lastLine())>=g)return{from:wd(b,xd(rd(b,i))-a.wrapper.clientHeight),to:i}}return{from:f,to:g}}function s(a){var b=a.display,c=b.view;if(b.alignWidgets||b.gutters.firstChild&&a.options.fixedGutter){for(var d=v(b)-b.scroller.scrollLeft+a.doc.scrollLeft,e=b.gutters.offsetWidth,f=d+"px",g=0;g<c.length;g++)if(!c[g].hidden){a.options.fixedGutter&&c[g].gutter&&(c[g].gutter.style.left=f);var h=c[g].alignable;if(h)for(var i=0;i<h.length;i++)h[i].style.left=f}a.options.fixedGutter&&(b.gutters.style.left=d+e+"px")}}function t(a){if(!a.options.lineNumbers)return!1;var b=a.doc,c=u(a.options,b.first+b.size-1),d=a.display;if(c.length!=d.lineNumChars){var e=d.measure.appendChild(ge("div",[ge("div",c)],"CodeMirror-linenumber CodeMirror-gutter-elt")),f=e.firstChild.offsetWidth,g=e.offsetWidth-f;return d.lineGutter.style.width="",d.lineNumInnerWidth=Math.max(f,d.lineGutter.offsetWidth-g)+g+2,d.lineNumWidth=d.lineNumInnerWidth+g,d.lineNumChars=d.lineNumInnerWidth?c.length:-1,d.lineGutter.style.width=d.lineNumWidth+"px",l(a),!0}return!1}function u(a,b){return String(a.lineNumberFormatter(b+a.firstLineNumber))}function v(a){return a.scroller.getBoundingClientRect().left-a.sizer.getBoundingClientRect().left}function w(a,b,c){for(var d,e=a.display.viewFrom,f=a.display.viewTo,g=r(a.display,a.doc,b),h=!0;;h=!1){var i=a.display.scroller.clientWidth;if(!x(a,g,c))break;d=!0,a.display.maxLineChanged&&!a.options.lineWrapping&&y(a);var j=p(a);if(oa(a),z(a,j),q(a,j),Le&&a.options.lineWrapping&&A(a,j),h&&a.options.lineWrapping&&i!=a.display.scroller.clientWidth)c=!0;else if(c=!1,b&&null!=b.top&&(b={top:Math.min(j.docHeight-Zf-j.clientHeight,b.top)}),g=r(a.display,a.doc,b),g.from>=a.display.viewFrom&&g.to<=a.display.viewTo)break}return a.display.updateLineNumbers=null,d&&(Rd(a,"update",a),(a.display.viewFrom!=e||a.display.viewTo!=f)&&Rd(a,"viewportChange",a,a.display.viewFrom,a.display.viewTo)),d}function x(a,b,c){var d=a.display,e=a.doc;if(!d.wrapper.offsetWidth)return void eb(a);if(!(!c&&b.from>=d.viewFrom&&b.to<=d.viewTo&&0==ib(a))){t(a)&&eb(a);var f=D(a),g=e.first+e.size,h=Math.max(b.from-a.options.viewportMargin,e.first),i=Math.min(g,b.to+a.options.viewportMargin);d.viewFrom<h&&h-d.viewFrom<20&&(h=Math.max(e.first,d.viewFrom)),d.viewTo>i&&d.viewTo-i<20&&(i=Math.min(g,d.viewTo)),af&&(h=Pc(a.doc,h),i=Qc(a.doc,i));var j=h!=d.viewFrom||i!=d.viewTo||d.lastSizeC!=d.wrapper.clientHeight;hb(a,h,i),d.viewOffset=xd(rd(a.doc,d.viewFrom)),a.display.mover.style.top=d.viewOffset+"px";var k=ib(a);if(j||0!=k||c){var l=ke();return k>4&&(d.lineDiv.style.display="none"),E(a,d.updateLineNumbers,f),k>4&&(d.lineDiv.style.display=""),l&&ke()!=l&&l.offsetHeight&&l.focus(),he(d.cursorDiv),he(d.selectionDiv),j&&(d.lastSizeC=d.wrapper.clientHeight,sa(a,400)),B(a),!0}}}function y(a){var b=a.display,c=Ca(a,b.maxLine,b.maxLine.text.length).left;b.maxLineChanged=!1;var d=Math.max(0,c+3),e=Math.max(0,b.sizer.offsetLeft+d+Zf-b.scroller.clientWidth);b.sizer.style.minWidth=d+"px",e<a.doc.scrollLeft&&Cb(a,Math.min(b.scroller.scrollLeft,e),!0)}function z(a,b){a.display.sizer.style.minHeight=a.display.heightForcer.style.top=b.docHeight+"px",a.display.gutters.style.height=Math.max(b.docHeight,b.clientHeight-Zf)+"px"}function A(a,b){a.display.sizer.offsetWidth+a.display.gutters.offsetWidth<a.display.scroller.clientWidth-1&&(a.display.sizer.style.minHeight=a.display.heightForcer.style.top="0px",a.display.gutters.style.height=b.docHeight+"px")}function B(a){for(var b=a.display,c=b.lineDiv.offsetTop,d=0;d<b.view.length;d++){var e,f=b.view[d];if(!f.hidden){if(Ge){var g=f.node.offsetTop+f.node.offsetHeight;e=g-c,c=g}else{var h=f.node.getBoundingClientRect();e=h.bottom-h.top}var i=f.line.height-e;if(2>e&&(e=Ua(b)),(i>.001||-.001>i)&&(ud(f.line,e),C(f.line),f.rest))for(var j=0;j<f.rest.length;j++)C(f.rest[j])}}}function C(a){if(a.widgets)for(var b=0;b<a.widgets.length;++b)a.widgets[b].height=a.widgets[b].node.offsetHeight}function D(a){for(var b=a.display,c={},d={},e=b.gutters.firstChild,f=0;e;e=e.nextSibling,++f)c[a.options.gutters[f]]=e.offsetLeft,d[a.options.gutters[f]]=e.offsetWidth;return{fixedPos:v(b),gutterTotalWidth:b.gutters.offsetWidth,gutterLeft:c,gutterWidth:d,wrapperWidth:b.wrapper.clientWidth}}function E(a,b,c){function d(b){var c=b.nextSibling;return Le&&We&&a.display.currentWheelTarget==b?b.style.display="none":b.parentNode.removeChild(b),c}for(var e=a.display,f=a.options.lineNumbers,g=e.lineDiv,h=g.firstChild,i=e.view,j=e.viewFrom,k=0;k<i.length;k++){var l=i[k];if(l.hidden);else if(l.node){for(;h!=l.node;)h=d(h);var m=f&&null!=b&&j>=b&&l.lineNumber;l.changes&&(_d(l.changes,"gutter")>-1&&(m=!1),F(a,l,j,c)),m&&(he(l.lineNumber),l.lineNumber.appendChild(document.createTextNode(u(a.options,j)))),h=l.node.nextSibling}else{var n=N(a,l,j,c);g.insertBefore(n,h)}j+=l.size}for(;h;)h=d(h)}function F(a,b,c,d){for(var e=0;e<b.changes.length;e++){var f=b.changes[e];"text"==f?J(a,b):"gutter"==f?L(a,b,c,d):"class"==f?K(b):"widget"==f&&M(b,d)}b.changes=null}function G(a){return a.node==a.text&&(a.node=ge("div",null,null,"position: relative"),a.text.parentNode&&a.text.parentNode.replaceChild(a.node,a.text),a.node.appendChild(a.text),Ge&&(a.node.style.zIndex=2)),a.node}function H(a){var b=a.bgClass?a.bgClass+" "+(a.line.bgClass||""):a.line.bgClass;if(b&&(b+=" CodeMirror-linebackground"),a.background)b?a.background.className=b:(a.background.parentNode.removeChild(a.background),a.background=null);else if(b){var c=G(a);a.background=c.insertBefore(ge("div",null,b),c.firstChild)}}function I(a,b){var c=a.display.externalMeasured;return c&&c.line==b.line?(a.display.externalMeasured=null,b.measure=c.measure,c.built):ed(a,b)}function J(a,b){var c=b.text.className,d=I(a,b);b.text==b.node&&(b.node=d.pre),b.text.parentNode.replaceChild(d.pre,b.text),b.text=d.pre,d.bgClass!=b.bgClass||d.textClass!=b.textClass?(b.bgClass=d.bgClass,b.textClass=d.textClass,K(b)):c&&(b.text.className=c)}function K(a){H(a),a.line.wrapClass?G(a).className=a.line.wrapClass:a.node!=a.text&&(a.node.className="");var b=a.textClass?a.textClass+" "+(a.line.textClass||""):a.line.textClass;a.text.className=b||""}function L(a,b,c,d){b.gutter&&(b.node.removeChild(b.gutter),b.gutter=null);var e=b.line.gutterMarkers;if(a.options.lineNumbers||e){var f=0===c||c===a.lineCount()-1||(c+1)%10===0?" CodeMirror-linenumber-show":"",g=G(b),h=b.gutter=g.insertBefore(ge("div",null,"CodeMirror-gutter-wrapper","position: absolute; left: "+(a.options.fixedGutter?d.fixedPos:-d.gutterTotalWidth)+"px"),b.text);if(!a.options.lineNumbers||e&&e["CodeMirror-linenumbers"]||(b.lineNumber=h.appendChild(ge("div",u(a.options,c),"CodeMirror-linenumber CodeMirror-gutter-elt"+f,"left: "+d.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+a.display.lineNumInnerWidth+"px"))),e)for(var i=0;i<a.options.gutters.length;++i){var j=a.options.gutters[i],k=e.hasOwnProperty(j)&&e[j];k&&h.appendChild(ge("div",[k],"CodeMirror-gutter-elt","left: "+d.gutterLeft[j]+"px; width: "+d.gutterWidth[j]+"px"))}}}function M(a,b){a.alignable&&(a.alignable=null);for(var c,d=a.node.firstChild;d;d=c){var c=d.nextSibling;"CodeMirror-linewidget"==d.className&&a.node.removeChild(d)}O(a,b)}function N(a,b,c,d){var e=I(a,b);return b.text=b.node=e.pre,e.bgClass&&(b.bgClass=e.bgClass),e.textClass&&(b.textClass=e.textClass),K(b),L(a,b,c,d),O(b,d),b.node}function O(a,b){if(P(a.line,a,b,!0),a.rest)for(var c=0;c<a.rest.length;c++)P(a.rest[c],a,b,!1)}function P(a,b,c,d){if(a.widgets)for(var e=G(b),f=0,g=a.widgets;f<g.length;++f){var h=g[f],i=ge("div",[h.node],"CodeMirror-linewidget");h.handleMouseEvents||(i.ignoreEvents=!0),Q(h,i,b,c),d&&h.above?e.insertBefore(i,b.gutter||b.text):e.appendChild(i),Rd(h,"redraw")}}function Q(a,b,c,d){if(a.noHScroll){(c.alignable||(c.alignable=[])).push(b);var e=d.wrapperWidth;b.style.left=d.fixedPos+"px",a.coverGutter||(e-=d.gutterTotalWidth,b.style.paddingLeft=d.gutterTotalWidth+"px"),b.style.width=e+"px"}a.coverGutter&&(b.style.zIndex=5,b.style.position="relative",a.noHScroll||(b.style.marginLeft=-d.gutterTotalWidth+"px"))}function R(a){return bf(a.line,a.ch)}function S(a,b){return cf(a,b)<0?b:a}function T(a,b){return cf(a,b)<0?a:b}function U(a,b){this.ranges=a,this.primIndex=b}function V(a,b){this.anchor=a,this.head=b}function W(a,b){var c=a[b];a.sort(function(a,b){return cf(a.from(),b.from())}),b=_d(a,c);for(var d=1;d<a.length;d++){var e=a[d],f=a[d-1];if(cf(f.to(),e.from())>=0){var g=T(f.from(),e.from()),h=S(f.to(),e.to()),i=f.empty()?e.from()==e.head:f.from()==f.head;b>=d&&--b,a.splice(--d,2,new V(i?h:g,i?g:h))}}return new U(a,b)}function X(a,b){return new U([new V(a,b||a)],0)}function Y(a,b){return Math.max(a.first,Math.min(b,a.first+a.size-1))}function Z(a,b){if(b.line<a.first)return bf(a.first,0);var c=a.first+a.size-1;return b.line>c?bf(c,rd(a,c).text.length):$(b,rd(a,b.line).text.length)}function $(a,b){
var c=a.ch;return null==c||c>b?bf(a.line,b):0>c?bf(a.line,0):a}function _(a,b){return b>=a.first&&b<a.first+a.size}function aa(a,b){for(var c=[],d=0;d<b.length;d++)c[d]=Z(a,b[d]);return c}function ba(a,b,c,d){if(a.cm&&a.cm.display.shift||a.extend){var e=b.anchor;if(d){var f=cf(c,e)<0;f!=cf(d,e)<0?(e=c,c=d):f!=cf(c,d)<0&&(c=d)}return new V(e,c)}return new V(d||c,c)}function ca(a,b,c,d){ia(a,new U([ba(a,a.sel.primary(),b,c)],0),d)}function da(a,b,c){for(var d=[],e=0;e<a.sel.ranges.length;e++)d[e]=ba(a,a.sel.ranges[e],b[e],null);var f=W(d,a.sel.primIndex);ia(a,f,c)}function ea(a,b,c,d){var e=a.sel.ranges.slice(0);e[b]=c,ia(a,W(e,a.sel.primIndex),d)}function fa(a,b,c,d){ia(a,X(b,c),d)}function ga(a,b){var c={ranges:b.ranges,update:function(b){this.ranges=[];for(var c=0;c<b.length;c++)this.ranges[c]=new V(Z(a,b[c].anchor),Z(a,b[c].head))}};return Xf(a,"beforeSelectionChange",a,c),a.cm&&Xf(a.cm,"beforeSelectionChange",a.cm,c),c.ranges!=b.ranges?W(c.ranges,c.ranges.length-1):b}function ha(a,b,c){var d=a.history.done,e=$d(d);e&&e.ranges?(d[d.length-1]=b,ja(a,b,c)):ia(a,b,c)}function ia(a,b,c){ja(a,b,c),Fd(a,a.sel,a.cm?a.cm.curOp.id:NaN,c)}function ja(a,b,c){(Vd(a,"beforeSelectionChange")||a.cm&&Vd(a.cm,"beforeSelectionChange"))&&(b=ga(a,b));var d=cf(b.primary().head,a.sel.primary().head)<0?-1:1;ka(a,ma(a,b,d,!0)),c&&c.scroll===!1||!a.cm||fc(a.cm)}function ka(a,b){b.equals(a.sel)||(a.sel=b,a.cm&&(a.cm.curOp.updateInput=a.cm.curOp.selectionChanged=!0,Ud(a.cm)),Rd(a,"cursorActivity",a))}function la(a){ka(a,ma(a,a.sel,null,!1),_f)}function ma(a,b,c,d){for(var e,f=0;f<b.ranges.length;f++){var g=b.ranges[f],h=na(a,g.anchor,c,d),i=na(a,g.head,c,d);(e||h!=g.anchor||i!=g.head)&&(e||(e=b.ranges.slice(0,f)),e[f]=new V(h,i))}return e?W(e,b.primIndex):b}function na(a,b,c,d){var e=!1,f=b,g=c||1;a.cantEdit=!1;a:for(;;){var h=rd(a,f.line);if(h.markedSpans)for(var i=0;i<h.markedSpans.length;++i){var j=h.markedSpans[i],k=j.marker;if((null==j.from||(k.inclusiveLeft?j.from<=f.ch:j.from<f.ch))&&(null==j.to||(k.inclusiveRight?j.to>=f.ch:j.to>f.ch))){if(d&&(Xf(k,"beforeCursorEnter"),k.explicitlyCleared)){if(h.markedSpans){--i;continue}break}if(!k.atomic)continue;var l=k.find(0>g?-1:1);if(0==cf(l,f)&&(l.ch+=g,l.ch<0?l=l.line>a.first?Z(a,bf(l.line-1)):null:l.ch>h.text.length&&(l=l.line<a.first+a.size-1?bf(l.line+1,0):null),!l)){if(e)return d?(a.cantEdit=!0,bf(a.first,0)):na(a,b,c,!0);e=!0,l=b,g=-g}f=l;continue a}}return f}}function oa(a){for(var b=a.display,c=a.doc,d=document.createDocumentFragment(),e=document.createDocumentFragment(),f=0;f<c.sel.ranges.length;f++){var g=c.sel.ranges[f],h=g.empty();(h||a.options.showCursorWhenSelecting)&&pa(a,g,d),h||qa(a,g,e)}if(a.options.moveInputWithCursor){var i=Pa(a,c.sel.primary().head,"div"),j=b.wrapper.getBoundingClientRect(),k=b.lineDiv.getBoundingClientRect(),l=Math.max(0,Math.min(b.wrapper.clientHeight-10,i.top+k.top-j.top)),m=Math.max(0,Math.min(b.wrapper.clientWidth-10,i.left+k.left-j.left));b.inputDiv.style.top=l+"px",b.inputDiv.style.left=m+"px"}ie(b.cursorDiv,d),ie(b.selectionDiv,e)}function pa(a,b,c){var d=Pa(a,b.head,"div"),e=c.appendChild(ge("div"," ","CodeMirror-cursor"));if(e.style.left=d.left+"px",e.style.top=d.top+"px",e.style.height=Math.max(0,d.bottom-d.top)*a.options.cursorHeight+"px",d.other){var f=c.appendChild(ge("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));f.style.display="",f.style.left=d.other.left+"px",f.style.top=d.other.top+"px",f.style.height=.85*(d.other.bottom-d.other.top)+"px"}}function qa(a,b,c){function d(a,b,c,d){0>b&&(b=0),b=Math.round(b),d=Math.round(d),h.appendChild(ge("div",null,"CodeMirror-selected","position: absolute; left: "+a+"px; top: "+b+"px; width: "+(null==c?k-a:c)+"px; height: "+(d-b)+"px"))}function e(b,c,e){function f(c,d){return Oa(a,bf(b,c),"div",l,d)}var h,i,l=rd(g,b),m=l.text.length;return se(yd(l),c||0,null==e?m:e,function(a,b,g){var l,n,o,p=f(a,"left");if(a==b)l=p,n=o=p.left;else{if(l=f(b-1,"right"),"rtl"==g){var q=p;p=l,l=q}n=p.left,o=l.right}null==c&&0==a&&(n=j),l.top-p.top>3&&(d(n,p.top,null,p.bottom),n=j,p.bottom<l.top&&d(n,p.bottom,null,l.top)),null==e&&b==m&&(o=k),(!h||p.top<h.top||p.top==h.top&&p.left<h.left)&&(h=p),(!i||l.bottom>i.bottom||l.bottom==i.bottom&&l.right>i.right)&&(i=l),j+1>n&&(n=j),d(n,l.top,o-n,l.bottom)}),{start:h,end:i}}var f=a.display,g=a.doc,h=document.createDocumentFragment(),i=ya(a.display),j=i.left,k=f.lineSpace.offsetWidth-i.right,l=b.from(),m=b.to();if(l.line==m.line)e(l.line,l.ch,m.ch);else{var n=rd(g,l.line),o=rd(g,m.line),p=Nc(n)==Nc(o),q=e(l.line,l.ch,p?n.text.length+1:null).end,r=e(m.line,p?0:null,m.ch).start;p&&(q.top<r.top-2?(d(q.right,q.top,null,q.bottom),d(j,r.top,r.left,r.bottom)):d(q.right,q.top,r.left-q.right,q.bottom)),q.bottom<r.top&&d(j,q.bottom,null,r.top)}c.appendChild(h)}function ra(a){if(a.state.focused){var b=a.display;clearInterval(b.blinker);var c=!0;b.cursorDiv.style.visibility="",a.options.cursorBlinkRate>0&&(b.blinker=setInterval(function(){b.cursorDiv.style.visibility=(c=!c)?"":"hidden"},a.options.cursorBlinkRate))}}function sa(a,b){a.doc.mode.startState&&a.doc.frontier<a.display.viewTo&&a.state.highlight.set(b,de(ta,a))}function ta(a){var b=a.doc;if(b.frontier<b.first&&(b.frontier=b.first),!(b.frontier>=a.display.viewTo)){var c=+new Date+a.options.workTime,d=yf(b.mode,va(a,b.frontier));Ya(a,function(){b.iter(b.frontier,Math.min(b.first+b.size,a.display.viewTo+500),function(e){if(b.frontier>=a.display.viewFrom){var f=e.styles,g=ad(a,e,d,!0);e.styles=g.styles,g.classes?e.styleClasses=g.classes:e.styleClasses&&(e.styleClasses=null);for(var h=!f||f.length!=e.styles.length,i=0;!h&&i<f.length;++i)h=f[i]!=e.styles[i];h&&db(a,b.frontier,"text"),e.stateAfter=yf(b.mode,d)}else cd(a,e.text,d),e.stateAfter=b.frontier%5==0?yf(b.mode,d):null;return++b.frontier,+new Date>c?(sa(a,a.options.workDelay),!0):void 0})})}}function ua(a,b,c){for(var d,e,f=a.doc,g=c?-1:b-(a.doc.mode.innerMode?1e3:100),h=b;h>g;--h){if(h<=f.first)return f.first;var i=rd(f,h-1);if(i.stateAfter&&(!c||h<=f.frontier))return h;var j=cg(i.text,null,a.options.tabSize);(null==e||d>j)&&(e=h-1,d=j)}return e}function va(a,b,c){var d=a.doc,e=a.display;if(!d.mode.startState)return!0;var f=ua(a,b,c),g=f>d.first&&rd(d,f-1).stateAfter;return g=g?yf(d.mode,g):zf(d.mode),d.iter(f,b,function(c){cd(a,c.text,g);var h=f==b-1||f%5==0||f>=e.viewFrom&&f<e.viewTo;c.stateAfter=h?yf(d.mode,g):null,++f}),c&&(d.frontier=f),g}function wa(a){return a.lineSpace.offsetTop}function xa(a){return a.mover.offsetHeight-a.lineSpace.offsetHeight}function ya(a){if(a.cachedPaddingH)return a.cachedPaddingH;var b=ie(a.measure,ge("pre","x")),c=window.getComputedStyle?window.getComputedStyle(b):b.currentStyle,d={left:parseInt(c.paddingLeft),right:parseInt(c.paddingRight)};return isNaN(d.left)||isNaN(d.right)||(a.cachedPaddingH=d),d}function za(a,b,c){var d=a.options.lineWrapping,e=d&&a.display.scroller.clientWidth;if(!b.measure.heights||d&&b.measure.width!=e){var f=b.measure.heights=[];if(d){b.measure.width=e;for(var g=b.text.firstChild.getClientRects(),h=0;h<g.length-1;h++){var i=g[h],j=g[h+1];Math.abs(i.bottom-j.bottom)>2&&f.push((i.bottom+j.top)/2-c.top)}}f.push(c.bottom-c.top)}}function Aa(a,b,c){if(a.line==b)return{map:a.measure.map,cache:a.measure.cache};for(var d=0;d<a.rest.length;d++)if(a.rest[d]==b)return{map:a.measure.maps[d],cache:a.measure.caches[d]};for(var d=0;d<a.rest.length;d++)if(vd(a.rest[d])>c)return{map:a.measure.maps[d],cache:a.measure.caches[d],before:!0}}function Ba(a,b){b=Nc(b);var c=vd(b),d=a.display.externalMeasured=new ab(a.doc,b,c);d.lineN=c;var e=d.built=ed(a,d);return d.text=e.pre,ie(a.display.lineMeasure,e.pre),d}function Ca(a,b,c,d){return Fa(a,Ea(a,b),c,d)}function Da(a,b){if(b>=a.display.viewFrom&&b<a.display.viewTo)return a.display.view[fb(a,b)];var c=a.display.externalMeasured;return c&&b>=c.lineN&&b<c.lineN+c.size?c:void 0}function Ea(a,b){var c=vd(b),d=Da(a,c);d&&!d.text?d=null:d&&d.changes&&F(a,d,c,D(a)),d||(d=Ba(a,b));var e=Aa(d,b,c);return{line:b,view:d,rect:null,map:e.map,cache:e.cache,before:e.before,hasHeights:!1}}function Fa(a,b,c,d){b.before&&(c=-1);var e,f=c+(d||"");return b.cache.hasOwnProperty(f)?e=b.cache[f]:(b.rect||(b.rect=b.view.text.getBoundingClientRect()),b.hasHeights||(za(a,b.view,b.rect),b.hasHeights=!0),e=Ga(a,b,c,d),e.bogus||(b.cache[f]=e)),{left:e.left,right:e.right,top:e.top,bottom:e.bottom}}function Ga(a,b,c,d){for(var e,f,g,h,i=b.map,j=0;j<i.length;j+=3){var k=i[j],l=i[j+1];if(k>c?(f=0,g=1,h="left"):l>c?(f=c-k,g=f+1):(j==i.length-3||c==l&&i[j+3]>c)&&(g=l-k,f=g-1,c>=l&&(h="right")),null!=f){if(e=i[j+2],k==l&&d==(e.insertLeft?"left":"right")&&(h=d),"left"==d&&0==f)for(;j&&i[j-2]==i[j-3]&&i[j-1].insertLeft;)e=i[(j-=3)+2],h="left";if("right"==d&&f==l-k)for(;j<i.length-3&&i[j+3]==i[j+4]&&!i[j+5].insertLeft;)e=i[(j+=3)+2],h="right";break}}var m;if(3==e.nodeType){for(;f&&fe(b.line.text.charAt(k+f));)--f;for(;l>k+g&&fe(b.line.text.charAt(k+g));)++g;if(He&&0==f&&g==l-k)m=e.parentNode.getBoundingClientRect();else if(Ke&&a.options.lineWrapping){var n=fg(e,f,g).getClientRects();m=n.length?n["right"==d?n.length-1:0]:ef}else m=fg(e,f,g).getBoundingClientRect()}else{f>0&&(h=d="right");var n;m=a.options.lineWrapping&&(n=e.getClientRects()).length>1?n["right"==d?n.length-1:0]:e.getBoundingClientRect()}if(He&&!f&&(!m||!m.left&&!m.right)){var o=e.parentNode.getClientRects()[0];m=o?{left:o.left,right:o.left+Va(a.display),top:o.top,bottom:o.bottom}:ef}for(var p,q=(m.bottom+m.top)/2-b.rect.top,r=b.view.measure.heights,j=0;j<r.length-1&&!(q<r[j]);j++);p=j?r[j-1]:0,q=r[j];var s={left:("right"==h?m.right:m.left)-b.rect.left,right:("left"==h?m.left:m.right)-b.rect.left,top:p,bottom:q};return m.left||m.right||(s.bogus=!0),s}function Ha(a){if(a.measure&&(a.measure.cache={},a.measure.heights=null,a.rest))for(var b=0;b<a.rest.length;b++)a.measure.caches[b]={}}function Ia(a){a.display.externalMeasure=null,he(a.display.lineMeasure);for(var b=0;b<a.display.view.length;b++)Ha(a.display.view[b])}function Ja(a){Ia(a),a.display.cachedCharWidth=a.display.cachedTextHeight=a.display.cachedPaddingH=null,a.options.lineWrapping||(a.display.maxLineChanged=!0),a.display.lineNumChars=null}function Ka(){return window.pageXOffset||(document.documentElement||document.body).scrollLeft}function La(){return window.pageYOffset||(document.documentElement||document.body).scrollTop}function Ma(a,b,c,d){if(b.widgets)for(var e=0;e<b.widgets.length;++e)if(b.widgets[e].above){var f=Uc(b.widgets[e]);c.top+=f,c.bottom+=f}if("line"==d)return c;d||(d="local");var g=xd(b);if("local"==d?g+=wa(a.display):g-=a.display.viewOffset,"page"==d||"window"==d){var h=a.display.lineSpace.getBoundingClientRect();g+=h.top+("window"==d?0:La());var i=h.left+("window"==d?0:Ka());c.left+=i,c.right+=i}return c.top+=g,c.bottom+=g,c}function Na(a,b,c){if("div"==c)return b;var d=b.left,e=b.top;if("page"==c)d-=Ka(),e-=La();else if("local"==c||!c){var f=a.display.sizer.getBoundingClientRect();d+=f.left,e+=f.top}var g=a.display.lineSpace.getBoundingClientRect();return{left:d-g.left,top:e-g.top}}function Oa(a,b,c,d,e){return d||(d=rd(a.doc,b.line)),Ma(a,d,Ca(a,d,b.ch,e),c)}function Pa(a,b,c,d,e){function f(b,f){var g=Fa(a,e,b,f?"right":"left");return f?g.left=g.right:g.right=g.left,Ma(a,d,g,c)}function g(a,b){var c=h[b],d=c.level%2;return a==te(c)&&b&&c.level<h[b-1].level?(c=h[--b],a=ue(c)-(c.level%2?0:1),d=!0):a==ue(c)&&b<h.length-1&&c.level<h[b+1].level&&(c=h[++b],a=te(c)-c.level%2,d=!1),d&&a==c.to&&a>c.from?f(a-1):f(a,d)}d=d||rd(a.doc,b.line),e||(e=Ea(a,d));var h=yd(d),i=b.ch;if(!h)return f(i);var j=Ae(h,i),k=g(i,j);return null!=rg&&(k.other=g(i,rg)),k}function Qa(a,b){var c=0,b=Z(a.doc,b);a.options.lineWrapping||(c=Va(a.display)*b.ch);var d=rd(a.doc,b.line),e=xd(d)+wa(a.display);return{left:c,right:c,top:e,bottom:e+d.height}}function Ra(a,b,c,d){var e=bf(a,b);return e.xRel=d,c&&(e.outside=!0),e}function Sa(a,b,c){var d=a.doc;if(c+=a.display.viewOffset,0>c)return Ra(d.first,0,!0,-1);var e=wd(d,c),f=d.first+d.size-1;if(e>f)return Ra(d.first+d.size-1,rd(d,f).text.length,!0,1);0>b&&(b=0);for(var g=rd(d,e);;){var h=Ta(a,g,e,b,c),i=Lc(g),j=i&&i.find(0,!0);if(!i||!(h.ch>j.from.ch||h.ch==j.from.ch&&h.xRel>0))return h;e=vd(g=j.to.line)}}function Ta(a,b,c,d,e){function f(d){var e=Pa(a,bf(c,d),"line",b,j);return h=!0,g>e.bottom?e.left-i:g<e.top?e.left+i:(h=!1,e.left)}var g=e-xd(b),h=!1,i=2*a.display.wrapper.clientWidth,j=Ea(a,b),k=yd(b),l=b.text.length,m=ve(b),n=we(b),o=f(m),p=h,q=f(n),r=h;if(d>q)return Ra(c,n,r,1);for(;;){if(k?n==m||n==Ce(b,m,1):1>=n-m){for(var s=o>d||q-d>=d-o?m:n,t=d-(s==m?o:q);fe(b.text.charAt(s));)++s;var u=Ra(c,s,s==m?p:r,-1>t?-1:t>1?1:0);return u}var v=Math.ceil(l/2),w=m+v;if(k){w=m;for(var x=0;v>x;++x)w=Ce(b,w,1)}var y=f(w);y>d?(n=w,q=y,(r=h)&&(q+=1e3),l=v):(m=w,o=y,p=h,l-=v)}}function Ua(a){if(null!=a.cachedTextHeight)return a.cachedTextHeight;if(null==df){df=ge("pre");for(var b=0;49>b;++b)df.appendChild(document.createTextNode("x")),df.appendChild(ge("br"));df.appendChild(document.createTextNode("x"))}ie(a.measure,df);var c=df.offsetHeight/50;return c>3&&(a.cachedTextHeight=c),he(a.measure),c||1}function Va(a){if(null!=a.cachedCharWidth)return a.cachedCharWidth;var b=ge("span","xxxxxxxxxx"),c=ge("pre",[b]);ie(a.measure,c);var d=b.getBoundingClientRect(),e=(d.right-d.left)/10;return e>2&&(a.cachedCharWidth=e),e||10}function Wa(a){a.curOp={viewChanged:!1,startHeight:a.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivityHandlers:null,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,id:++ff},Yf++||(Rf=[])}function Xa(a){var b=a.curOp,c=a.doc,d=a.display;if(a.curOp=null,b.updateMaxLine&&n(a),b.viewChanged||b.forceUpdate||null!=b.scrollTop||b.scrollToPos&&(b.scrollToPos.from.line<d.viewFrom||b.scrollToPos.to.line>=d.viewTo)||d.maxLineChanged&&a.options.lineWrapping){var e=w(a,{top:b.scrollTop,ensure:b.scrollToPos},b.forceUpdate);a.display.scroller.offsetHeight&&(a.doc.scrollTop=a.display.scroller.scrollTop)}if(!e&&b.selectionChanged&&oa(a),e||b.startHeight==a.doc.height||q(a),null!=b.scrollTop&&d.scroller.scrollTop!=b.scrollTop){var f=Math.max(0,Math.min(d.scroller.scrollHeight-d.scroller.clientHeight,b.scrollTop));d.scroller.scrollTop=d.scrollbarV.scrollTop=c.scrollTop=f}if(null!=b.scrollLeft&&d.scroller.scrollLeft!=b.scrollLeft){var g=Math.max(0,Math.min(d.scroller.scrollWidth-d.scroller.clientWidth,b.scrollLeft));d.scroller.scrollLeft=d.scrollbarH.scrollLeft=c.scrollLeft=g,s(a)}if(b.scrollToPos){var h=bc(a,Z(a.doc,b.scrollToPos.from),Z(a.doc,b.scrollToPos.to),b.scrollToPos.margin);b.scrollToPos.isCursor&&a.state.focused&&ac(a,h)}b.selectionChanged&&ra(a),a.state.focused&&b.updateInput&&mb(a,b.typing);var i=b.maybeHiddenMarkers,j=b.maybeUnhiddenMarkers;if(i)for(var k=0;k<i.length;++k)i[k].lines.length||Xf(i[k],"hide");if(j)for(var k=0;k<j.length;++k)j[k].lines.length&&Xf(j[k],"unhide");var l;if(--Yf||(l=Rf,Rf=null),b.changeObjs&&Xf(a,"changes",a,b.changeObjs),l)for(var k=0;k<l.length;++k)l[k]();if(b.cursorActivityHandlers)for(var k=0;k<b.cursorActivityHandlers.length;k++)b.cursorActivityHandlers[k](a)}function Ya(a,b){if(a.curOp)return b();Wa(a);try{return b()}finally{Xa(a)}}function Za(a,b){return function(){if(a.curOp)return b.apply(a,arguments);Wa(a);try{return b.apply(a,arguments)}finally{Xa(a)}}}function $a(a){return function(){if(this.curOp)return a.apply(this,arguments);Wa(this);try{return a.apply(this,arguments)}finally{Xa(this)}}}function _a(a){return function(){var b=this.cm;if(!b||b.curOp)return a.apply(this,arguments);Wa(b);try{return a.apply(this,arguments)}finally{Xa(b)}}}function ab(a,b,c){this.line=b,this.rest=Oc(b),this.size=this.rest?vd($d(this.rest))-c+1:1,this.node=this.text=null,this.hidden=Rc(a,b)}function bb(a,b,c){for(var d,e=[],f=b;c>f;f=d){var g=new ab(a.doc,rd(a.doc,f),f);d=f+g.size,e.push(g)}return e}function cb(a,b,c,d){null==b&&(b=a.doc.first),null==c&&(c=a.doc.first+a.doc.size),d||(d=0);var e=a.display;if(d&&c<e.viewTo&&(null==e.updateLineNumbers||e.updateLineNumbers>b)&&(e.updateLineNumbers=b),a.curOp.viewChanged=!0,b>=e.viewTo)af&&Pc(a.doc,b)<e.viewTo&&eb(a);else if(c<=e.viewFrom)af&&Qc(a.doc,c+d)>e.viewFrom?eb(a):(e.viewFrom+=d,e.viewTo+=d);else if(b<=e.viewFrom&&c>=e.viewTo)eb(a);else if(b<=e.viewFrom){var f=gb(a,c,c+d,1);f?(e.view=e.view.slice(f.index),e.viewFrom=f.lineN,e.viewTo+=d):eb(a)}else if(c>=e.viewTo){var f=gb(a,b,b,-1);f?(e.view=e.view.slice(0,f.index),e.viewTo=f.lineN):eb(a)}else{var g=gb(a,b,b,-1),h=gb(a,c,c+d,1);g&&h?(e.view=e.view.slice(0,g.index).concat(bb(a,g.lineN,h.lineN)).concat(e.view.slice(h.index)),e.viewTo+=d):eb(a)}var i=e.externalMeasured;i&&(c<i.lineN?i.lineN+=d:b<i.lineN+i.size&&(e.externalMeasured=null))}function db(a,b,c){a.curOp.viewChanged=!0;var d=a.display,e=a.display.externalMeasured;if(e&&b>=e.lineN&&b<e.lineN+e.size&&(d.externalMeasured=null),!(b<d.viewFrom||b>=d.viewTo)){var f=d.view[fb(a,b)];if(null!=f.node){var g=f.changes||(f.changes=[]);-1==_d(g,c)&&g.push(c)}}}function eb(a){a.display.viewFrom=a.display.viewTo=a.doc.first,a.display.view=[],a.display.viewOffset=0}function fb(a,b){if(b>=a.display.viewTo)return null;if(b-=a.display.viewFrom,0>b)return null;for(var c=a.display.view,d=0;d<c.length;d++)if(b-=c[d].size,0>b)return d}function gb(a,b,c,d){var e,f=fb(a,b),g=a.display.view;if(!af)return{index:f,lineN:c};for(var h=0,i=a.display.viewFrom;f>h;h++)i+=g[h].size;if(i!=b){if(d>0){if(f==g.length-1)return null;e=i+g[f].size-b,f++}else e=i-b;b+=e,c+=e}for(;Pc(a.doc,c)!=c;){if(f==(0>d?0:g.length-1))return null;c+=d*g[f-(0>d?1:0)].size,f+=d}return{index:f,lineN:c}}function hb(a,b,c){var d=a.display,e=d.view;0==e.length||b>=d.viewTo||c<=d.viewFrom?(d.view=bb(a,b,c),d.viewFrom=b):(d.viewFrom>b?d.view=bb(a,b,d.viewFrom).concat(d.view):d.viewFrom<b&&(d.view=d.view.slice(fb(a,b))),d.viewFrom=b,d.viewTo<c?d.view=d.view.concat(bb(a,d.viewTo,c)):d.viewTo>c&&(d.view=d.view.slice(0,fb(a,c)))),d.viewTo=c}function ib(a){for(var b=a.display.view,c=0,d=0;d<b.length;d++){var e=b[d];e.hidden||e.node&&!e.changes||++c}return c}function jb(a){a.display.pollingFast||a.display.poll.set(a.options.pollInterval,function(){lb(a),a.state.focused&&jb(a)})}function kb(a){function b(){var d=lb(a);d||c?(a.display.pollingFast=!1,jb(a)):(c=!0,a.display.poll.set(60,b))}var c=!1;a.display.pollingFast=!0,a.display.poll.set(20,b)}function lb(a){var b=a.display.input,c=a.display.prevInput,d=a.doc;if(!a.state.focused||og(b)&&!c||pb(a)||a.options.disableInput)return!1;a.state.pasteIncoming&&a.state.fakedLastChar&&(b.value=b.value.substring(0,b.value.length-1),a.state.fakedLastChar=!1);var e=b.value;if(e==c&&!a.somethingSelected())return!1;if(Ke&&!He&&a.display.inputHasSelection===e)return mb(a),!1;var f=!a.curOp;f&&Wa(a),a.display.shift=!1;for(var g=0,h=Math.min(c.length,e.length);h>g&&c.charCodeAt(g)==e.charCodeAt(g);)++g;for(var i=e.slice(g),j=ng(i),k=a.state.pasteIncoming&&j.length>1&&d.sel.ranges.length==j.length,l=d.sel.ranges.length-1;l>=0;l--){var m=d.sel.ranges[l],n=m.from(),o=m.to();g<c.length?n=bf(n.line,n.ch-(c.length-g)):a.state.overwrite&&m.empty()&&!a.state.pasteIncoming&&(o=bf(o.line,Math.min(rd(d,o.line).text.length,o.ch+$d(j).length)));var p=a.curOp.updateInput,q={from:n,to:o,text:k?[j[l]]:j,origin:a.state.pasteIncoming?"paste":a.state.cutIncoming?"cut":"+input"};if(Vb(a.doc,q),Rd(a,"inputRead",a,q),i&&!a.state.pasteIncoming&&a.options.electricChars&&a.options.smartIndent&&m.head.ch<100&&(!l||d.sel.ranges[l-1].head.line!=m.head.line)){var r=a.getModeAt(m.head);if(r.electricChars){for(var s=0;s<r.electricChars.length;s++)if(i.indexOf(r.electricChars.charAt(s))>-1){hc(a,m.head.line,"smart");break}}else if(r.electricInput){var t=pf(q);r.electricInput.test(rd(d,t.line).text.slice(0,t.ch))&&hc(a,m.head.line,"smart")}}}return fc(a),a.curOp.updateInput=p,a.curOp.typing=!0,e.length>1e3||e.indexOf("\n")>-1?b.value=a.display.prevInput="":a.display.prevInput=e,f&&Xa(a),a.state.pasteIncoming=a.state.cutIncoming=!1,!0}function mb(a,b){var c,d,e=a.doc;if(a.somethingSelected()){a.display.prevInput="";var f=e.sel.primary();c=pg&&(f.to().line-f.from().line>100||(d=a.getSelection()).length>1e3);var g=c?"-":d||a.getSelection();a.display.input.value=g,a.state.focused&&eg(a.display.input),Ke&&!He&&(a.display.inputHasSelection=g)}else b||(a.display.prevInput=a.display.input.value="",Ke&&!He&&(a.display.inputHasSelection=null));a.display.inaccurateSelection=c}function nb(a){"nocursor"==a.options.readOnly||Ve&&ke()==a.display.input||a.display.input.focus()}function ob(a){a.state.focused||(nb(a),Mb(a))}function pb(a){return a.options.readOnly||a.doc.cantEdit}function qb(a){function b(){a.state.focused&&setTimeout(de(nb,a),0)}function c(){null==h&&(h=setTimeout(function(){h=null,g.cachedCharWidth=g.cachedTextHeight=g.cachedPaddingH=jg=null,a.setSize()},100))}function d(){je(document.body,g.wrapper)?setTimeout(d,5e3):Wf(window,"resize",c)}function e(b){Td(a,b)||Uf(b)}function f(b){if(a.somethingSelected())g.inaccurateSelection&&(g.prevInput="",g.inaccurateSelection=!1,g.input.value=a.getSelection(),eg(g.input));else{for(var c="",d=[],e=0;e<a.doc.sel.ranges.length;e++){var f=a.doc.sel.ranges[e].head.line,h={anchor:bf(f,0),head:bf(f+1,0)};d.push(h),c+=a.getRange(h.anchor,h.head)}"cut"==b.type?a.setSelections(d,null,_f):(g.prevInput="",g.input.value=c,eg(g.input))}"cut"==b.type&&(a.state.cutIncoming=!0)}var g=a.display;Vf(g.scroller,"mousedown",Za(a,tb)),Fe?Vf(g.scroller,"dblclick",Za(a,function(b){if(!Td(a,b)){var c=sb(a,b);if(c&&!yb(a,b)&&!rb(a.display,b)){Sf(b);var d=mc(a.doc,c);ca(a.doc,d.anchor,d.head)}}})):Vf(g.scroller,"dblclick",function(b){Td(a,b)||Sf(b)}),Vf(g.lineSpace,"selectstart",function(a){rb(g,a)||Sf(a)}),$e||Vf(g.scroller,"contextmenu",function(b){Ob(a,b)}),Vf(g.scroller,"scroll",function(){g.scroller.clientHeight&&(Bb(a,g.scroller.scrollTop),Cb(a,g.scroller.scrollLeft,!0),Xf(a,"scroll",a))}),Vf(g.scrollbarV,"scroll",function(){g.scroller.clientHeight&&Bb(a,g.scrollbarV.scrollTop)}),Vf(g.scrollbarH,"scroll",function(){g.scroller.clientHeight&&Cb(a,g.scrollbarH.scrollLeft)}),Vf(g.scroller,"mousewheel",function(b){Db(a,b)}),Vf(g.scroller,"DOMMouseScroll",function(b){Db(a,b)}),Vf(g.scrollbarH,"mousedown",b),Vf(g.scrollbarV,"mousedown",b),Vf(g.wrapper,"scroll",function(){g.wrapper.scrollTop=g.wrapper.scrollLeft=0});var h;Vf(window,"resize",c),setTimeout(d,5e3),Vf(g.input,"keyup",Za(a,Kb)),Vf(g.input,"input",function(){Ke&&!He&&a.display.inputHasSelection&&(a.display.inputHasSelection=null),kb(a)}),Vf(g.input,"keydown",Za(a,Ib)),Vf(g.input,"keypress",Za(a,Lb)),Vf(g.input,"focus",de(Mb,a)),Vf(g.input,"blur",de(Nb,a)),a.options.dragDrop&&(Vf(g.scroller,"dragstart",function(b){Ab(a,b)}),Vf(g.scroller,"dragenter",e),Vf(g.scroller,"dragover",e),Vf(g.scroller,"drop",Za(a,zb))),Vf(g.scroller,"paste",function(b){rb(g,b)||(a.state.pasteIncoming=!0,nb(a),kb(a))}),Vf(g.input,"paste",function(){if(Le&&!a.state.fakedLastChar&&!(new Date-a.state.lastMiddleDown<200)){var b=g.input.selectionStart,c=g.input.selectionEnd;g.input.value+="$",g.input.selectionStart=b,g.input.selectionEnd=c,a.state.fakedLastChar=!0}a.state.pasteIncoming=!0,kb(a)}),Vf(g.input,"cut",f),Vf(g.input,"copy",f),Qe&&Vf(g.sizer,"mouseup",function(){ke()==g.input&&g.input.blur(),nb(a)})}function rb(a,b){for(var c=Pd(b);c!=a.wrapper;c=c.parentNode)if(!c||c.ignoreEvents||c.parentNode==a.sizer&&c!=a.mover)return!0}function sb(a,b,c,d){var e=a.display;if(!c){var f=Pd(b);if(f==e.scrollbarH||f==e.scrollbarV||f==e.scrollbarFiller||f==e.gutterFiller)return null}var g,h,i=e.lineSpace.getBoundingClientRect();try{g=b.clientX-i.left,h=b.clientY-i.top}catch(b){return null}var j,k=Sa(a,g,h);if(d&&1==k.xRel&&(j=rd(a.doc,k.line).text).length==k.ch){var l=cg(j,j.length,a.options.tabSize)-j.length;k=bf(k.line,Math.round((g-ya(a.display).left)/Va(a.display))-l)}return k}function tb(a){if(!Td(this,a)){var b=this,c=b.display;if(c.shift=a.shiftKey,rb(c,a))return void(Le||(c.scroller.draggable=!1,setTimeout(function(){c.scroller.draggable=!0},100)));if(!yb(b,a)){var d=sb(b,a);switch(window.focus(),Qd(a)){case 1:d?ub(b,a,d):Pd(a)==c.scroller&&Sf(a);break;case 2:Le&&(b.state.lastMiddleDown=+new Date),d&&ca(b.doc,d),setTimeout(de(nb,b),20),Sf(a);break;case 3:$e&&Ob(b,a)}}}}function ub(a,b,c){setTimeout(de(ob,a),0);var d,e=+new Date;hf&&hf.time>e-400&&0==cf(hf.pos,c)?d="triple":gf&&gf.time>e-400&&0==cf(gf.pos,c)?(d="double",hf={time:e,pos:c}):(d="single",gf={time:e,pos:c});var f=a.doc.sel,g=We?b.metaKey:b.ctrlKey;a.options.dragDrop&&mg&&!g&&!pb(a)&&"single"==d&&f.contains(c)>-1&&f.somethingSelected()?vb(a,b,c):wb(a,b,c,d,g)}function vb(a,b,c){var d=a.display,e=Za(a,function(f){Le&&(d.scroller.draggable=!1),a.state.draggingText=!1,Wf(document,"mouseup",e),Wf(d.scroller,"drop",e),Math.abs(b.clientX-f.clientX)+Math.abs(b.clientY-f.clientY)<10&&(Sf(f),ca(a.doc,c),nb(a),Fe&&!He&&setTimeout(function(){document.body.focus(),nb(a)},20))});Le&&(d.scroller.draggable=!0),a.state.draggingText=e,d.scroller.dragDrop&&d.scroller.dragDrop(),Vf(document,"mouseup",e),Vf(d.scroller,"drop",e)}function wb(a,b,c,d,e){function f(b){if(0!=cf(p,b))if(p=b,"rect"==d){for(var e=[],f=a.options.tabSize,g=cg(rd(j,c.line).text,c.ch,f),h=cg(rd(j,b.line).text,b.ch,f),i=Math.min(g,h),n=Math.max(g,h),o=Math.min(c.line,b.line),q=Math.min(a.lastLine(),Math.max(c.line,b.line));q>=o;o++){var r=rd(j,o).text,s=Yd(r,i,f);i==n?e.push(new V(bf(o,s),bf(o,s))):r.length>s&&e.push(new V(bf(o,s),bf(o,Yd(r,n,f))))}e.length||e.push(new V(c,c)),ia(j,W(m.ranges.slice(0,l).concat(e),l),ag)}else{var t=k,u=t.anchor,v=b;if("single"!=d){if("double"==d)var w=mc(j,b);else var w=new V(bf(b.line,0),Z(j,bf(b.line+1,0)));cf(w.anchor,u)>0?(v=w.head,u=T(t.from(),w.anchor)):(v=w.anchor,u=S(t.to(),w.head))}var e=m.ranges.slice(0);e[l]=new V(Z(j,u),v),ia(j,W(e,l),ag)}}function g(b){var c=++s,e=sb(a,b,!0,"rect"==d);if(e)if(0!=cf(e,p)){ob(a),f(e);var h=r(i,j);(e.line>=h.to||e.line<h.from)&&setTimeout(Za(a,function(){s==c&&g(b)}),150)}else{var k=b.clientY<q.top?-20:b.clientY>q.bottom?20:0;k&&setTimeout(Za(a,function(){s==c&&(i.scroller.scrollTop+=k,g(b))}),50)}}function h(b){s=1/0,Sf(b),nb(a),Wf(document,"mousemove",t),Wf(document,"mouseup",u),j.history.lastSelOrigin=null}var i=a.display,j=a.doc;Sf(b);var k,l,m=j.sel;if(e?(l=j.sel.contains(c),k=l>-1?j.sel.ranges[l]:new V(c,c)):k=j.sel.primary(),b.altKey)d="rect",e||(k=new V(c,c)),c=sb(a,b,!0,!0),l=-1;else if("double"==d){var n=mc(j,c);k=a.display.shift||j.extend?ba(j,k,n.anchor,n.head):n}else if("triple"==d){var o=new V(bf(c.line,0),Z(j,bf(c.line+1,0)));k=a.display.shift||j.extend?ba(j,k,o.anchor,o.head):o}else k=ba(j,k,c);e?l>-1?ea(j,l,k,ag):(l=j.sel.ranges.length,ia(j,W(j.sel.ranges.concat([k]),l),{scroll:!1,origin:"*mouse"})):(l=0,ia(j,new U([k],0),ag));var p=c,q=i.wrapper.getBoundingClientRect(),s=0,t=Za(a,function(a){(Ke&&!Ie?a.buttons:Qd(a))?g(a):h(a)}),u=Za(a,h);Vf(document,"mousemove",t),Vf(document,"mouseup",u)}function xb(a,b,c,d,e){try{var f=b.clientX,g=b.clientY}catch(b){return!1}if(f>=Math.floor(a.display.gutters.getBoundingClientRect().right))return!1;d&&Sf(b);var h=a.display,i=h.lineDiv.getBoundingClientRect();if(g>i.bottom||!Vd(a,c))return Od(b);g-=i.top-h.viewOffset;for(var j=0;j<a.options.gutters.length;++j){var k=h.gutters.childNodes[j];if(k&&k.getBoundingClientRect().right>=f){var l=wd(a.doc,g),m=a.options.gutters[j];return e(a,c,a,l,m,b),Od(b)}}}function yb(a,b){return xb(a,b,"gutterClick",!0,Rd)}function zb(a){var b=this;if(!Td(b,a)&&!rb(b.display,a)){Sf(a),Fe&&(jf=+new Date);var c=sb(b,a,!0),d=a.dataTransfer.files;if(c&&!pb(b))if(d&&d.length&&window.FileReader&&window.File)for(var e=d.length,f=Array(e),g=0,h=function(a,d){var h=new FileReader;h.onload=Za(b,function(){if(f[d]=h.result,++g==e){c=Z(b.doc,c);var a={from:c,to:c,text:ng(f.join("\n")),origin:"paste"};Vb(b.doc,a),ha(b.doc,X(c,pf(a)))}}),h.readAsText(a)},i=0;e>i;++i)h(d[i],i);else{if(b.state.draggingText&&b.doc.sel.contains(c)>-1)return b.state.draggingText(a),void setTimeout(de(nb,b),20);try{var f=a.dataTransfer.getData("Text");if(f){var j=b.state.draggingText&&b.listSelections();if(ja(b.doc,X(c,c)),j)for(var i=0;i<j.length;++i)_b(b.doc,"",j[i].anchor,j[i].head,"drag");b.replaceSelection(f,"around","paste"),nb(b)}}catch(a){}}}}function Ab(a,b){if(Fe&&(!a.state.draggingText||+new Date-jf<100))return void Uf(b);if(!Td(a,b)&&!rb(a.display,b)&&(b.dataTransfer.setData("Text",a.getSelection()),b.dataTransfer.setDragImage&&!Pe)){var c=ge("img",null,null,"position: fixed; left: 0; top: 0;");c.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",Oe&&(c.width=c.height=1,a.display.wrapper.appendChild(c),c._top=c.offsetTop),b.dataTransfer.setDragImage(c,0,0),Oe&&c.parentNode.removeChild(c)}}function Bb(a,b){Math.abs(a.doc.scrollTop-b)<2||(a.doc.scrollTop=b,Ee||w(a,{top:b}),a.display.scroller.scrollTop!=b&&(a.display.scroller.scrollTop=b),a.display.scrollbarV.scrollTop!=b&&(a.display.scrollbarV.scrollTop=b),Ee&&w(a),sa(a,100))}function Cb(a,b,c){(c?b==a.doc.scrollLeft:Math.abs(a.doc.scrollLeft-b)<2)||(b=Math.min(b,a.display.scroller.scrollWidth-a.display.scroller.clientWidth),a.doc.scrollLeft=b,s(a),a.display.scroller.scrollLeft!=b&&(a.display.scroller.scrollLeft=b),a.display.scrollbarH.scrollLeft!=b&&(a.display.scrollbarH.scrollLeft=b))}function Db(a,b){var c=b.wheelDeltaX,d=b.wheelDeltaY;null==c&&b.detail&&b.axis==b.HORIZONTAL_AXIS&&(c=b.detail),null==d&&b.detail&&b.axis==b.VERTICAL_AXIS?d=b.detail:null==d&&(d=b.wheelDelta);var e=a.display,f=e.scroller;if(c&&f.scrollWidth>f.clientWidth||d&&f.scrollHeight>f.clientHeight){if(d&&We&&Le)a:for(var g=b.target,h=e.view;g!=f;g=g.parentNode)for(var i=0;i<h.length;i++)if(h[i].node==g){a.display.currentWheelTarget=g;break a}if(c&&!Ee&&!Oe&&null!=lf)return d&&Bb(a,Math.max(0,Math.min(f.scrollTop+d*lf,f.scrollHeight-f.clientHeight))),Cb(a,Math.max(0,Math.min(f.scrollLeft+c*lf,f.scrollWidth-f.clientWidth))),Sf(b),void(e.wheelStartX=null);if(d&&null!=lf){var j=d*lf,k=a.doc.scrollTop,l=k+e.wrapper.clientHeight;0>j?k=Math.max(0,k+j-50):l=Math.min(a.doc.height,l+j+50),w(a,{top:k,bottom:l})}20>kf&&(null==e.wheelStartX?(e.wheelStartX=f.scrollLeft,e.wheelStartY=f.scrollTop,e.wheelDX=c,e.wheelDY=d,setTimeout(function(){if(null!=e.wheelStartX){var a=f.scrollLeft-e.wheelStartX,b=f.scrollTop-e.wheelStartY,c=b&&e.wheelDY&&b/e.wheelDY||a&&e.wheelDX&&a/e.wheelDX;e.wheelStartX=e.wheelStartY=null,c&&(lf=(lf*kf+c)/(kf+1),++kf)}},200)):(e.wheelDX+=c,e.wheelDY+=d))}}function Eb(a,b,c){if("string"==typeof b&&(b=Af[b],!b))return!1;a.display.pollingFast&&lb(a)&&(a.display.pollingFast=!1);var d=a.display.shift,e=!1;try{pb(a)&&(a.state.suppressEdits=!0),c&&(a.display.shift=!1),e=b(a)!=$f}finally{a.display.shift=d,a.state.suppressEdits=!1}return e}function Fb(a){var b=a.state.keyMaps.slice(0);return a.options.extraKeys&&b.push(a.options.extraKeys),b.push(a.options.keyMap),b}function Gb(a,b){var c=oc(a.options.keyMap),d=c.auto;clearTimeout(mf),d&&!Df(b)&&(mf=setTimeout(function(){oc(a.options.keyMap)==c&&(a.options.keyMap=d.call?d.call(null,a):d,h(a))},50));var e=Ef(b,!0),f=!1;if(!e)return!1;var g=Fb(a),i=g.reduce(function(a,b){if(Bf[b]){var c=Bf[b][e];return a||"undo"==c||"redo"==c}return a},!1);return i?!0:(f=b.shiftKey?Cf("Shift-"+e,g,function(b){return Eb(a,b,!0)})||Cf(e,g,function(b){return("string"==typeof b?/^go[A-Z]/.test(b):b.motion)?Eb(a,b):void 0}):Cf(e,g,function(b){return Eb(a,b)}),f&&"throwEvent"!=f&&(Sf(b),ra(a),Rd(a,"keyHandled",a,e,b)),f)}function Hb(a,b,c){var d=Cf("'"+c+"'",Fb(a),function(b){return Eb(a,b,!0)});return d&&(Sf(b),ra(a),Rd(a,"keyHandled",a,"'"+c+"'",b)),d}function Ib(a){var b=this;if(ob(b),37==a.keyCode&&a.shiftKey&&lb(b),!Td(b,a)){Fe&&27==a.keyCode&&(a.returnValue=!1);var c=a.keyCode;b.display.shift=16==c||a.shiftKey;var d=Gb(b,a);Oe&&(of=d?c:null,!d&&88==c&&!pg&&(We?a.metaKey:a.ctrlKey)&&b.replaceSelection("",null,"cut")),18!=c||/\bCodeMirror-crosshair\b/.test(b.display.lineDiv.className)||Jb(b)}}function Jb(a){function b(a){18!=a.keyCode&&a.altKey||(me(c,"CodeMirror-crosshair"),Wf(document,"keyup",b),
Wf(document,"mouseover",b))}var c=a.display.lineDiv;ne(c,"CodeMirror-crosshair"),Vf(document,"keyup",b),Vf(document,"mouseover",b)}function Kb(a){Td(this,a)||16==a.keyCode&&(this.doc.sel.shift=!1)}function Lb(a){var b=this;if(!Td(b,a)){var c=a.keyCode,d=a.charCode;if(Oe&&c==of)return of=null,void Sf(a);if(!(Oe&&(!a.which||a.which<10)||Qe)||!Gb(b,a)){var e=String.fromCharCode(null==d?c:d);Hb(b,a,e)||(Ke&&!He&&(b.display.inputHasSelection=null),kb(b))}}}function Mb(a){"nocursor"!=a.options.readOnly&&(a.state.focused||(Xf(a,"focus",a),a.state.focused=!0,ne(a.display.wrapper,"CodeMirror-focused"),a.curOp||"​"==a.display.prevInput||(mb(a),Le&&setTimeout(de(mb,a,!0),0))),jb(a),ra(a))}function Nb(a){a.state.focused&&(Xf(a,"blur",a),a.state.focused=!1,me(a.display.wrapper,"CodeMirror-focused")),clearInterval(a.display.blinker),setTimeout(function(){a.state.focused||(a.display.shift=!1)},150)}function Ob(a,b){function c(){if(null!=e.input.selectionStart){var b=e.input.value="​"+(a.somethingSelected()?e.input.value:"");e.prevInput="​",e.input.selectionStart=1,e.input.selectionEnd=b.length}}function d(){if(e.inputDiv.style.position="relative",e.input.style.cssText=i,He&&(e.scrollbarV.scrollTop=e.scroller.scrollTop=g),jb(a),null!=e.input.selectionStart){(!Ke||He)&&c(),clearTimeout(nf);var b=0,d=function(){"​"==e.prevInput&&0==e.input.selectionStart?Za(a,Af.selectAll)(a):b++<10?nf=setTimeout(d,500):mb(a)};nf=setTimeout(d,200)}}if(!Td(a,b,"contextmenu")){var e=a.display;if(!rb(e,b)&&!Pb(a,b)){var f=sb(a,b),g=e.scroller.scrollTop;if(f&&!Oe){var h=a.options.resetSelectionOnContextMenu;h&&-1==a.doc.sel.contains(f)&&Za(a,ia)(a.doc,X(f),_f);var i=e.input.style.cssText;if(e.inputDiv.style.position="absolute",e.input.style.cssText="position: fixed; width: 30px; height: 30px; top: "+(b.clientY-5)+"px; left: "+(b.clientX-5)+"px; z-index: 1000; background: "+(Ke?"rgba(255, 255, 255, .05)":"transparent")+"; outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);",nb(a),mb(a),a.somethingSelected()||(e.input.value=e.prevInput=" "),Ke&&!He&&c(),$e){Uf(b);var j=function(){Wf(window,"mouseup",j),setTimeout(d,20)};Vf(window,"mouseup",j)}else setTimeout(d,50)}}}}function Pb(a,b){return Vd(a,"gutterContextMenu")?xb(a,b,"gutterContextMenu",!1,Xf):!1}function Qb(a,b){if(cf(a,b.from)<0)return a;if(cf(a,b.to)<=0)return pf(b);var c=a.line+b.text.length-(b.to.line-b.from.line)-1,d=a.ch;return a.line==b.to.line&&(d+=pf(b).ch-b.to.ch),bf(c,d)}function Rb(a,b){for(var c=[],d=0;d<a.sel.ranges.length;d++){var e=a.sel.ranges[d];c.push(new V(Qb(e.anchor,b),Qb(e.head,b)))}return W(c,a.sel.primIndex)}function Sb(a,b,c){return a.line==b.line?bf(c.line,a.ch-b.ch+c.ch):bf(c.line+(a.line-b.line),a.ch)}function Tb(a,b,c){for(var d=[],e=bf(a.first,0),f=e,g=0;g<b.length;g++){var h=b[g],i=Sb(h.from,e,f),j=Sb(pf(h),e,f);if(e=h.to,f=j,"around"==c){var k=a.sel.ranges[g],l=cf(k.head,k.anchor)<0;d[g]=new V(l?j:i,l?i:j)}else d[g]=new V(i,i)}return new U(d,a.sel.primIndex)}function Ub(a,b,c){var d={canceled:!1,from:b.from,to:b.to,text:b.text,origin:b.origin,cancel:function(){this.canceled=!0}};return c&&(d.update=function(b,c,d,e){b&&(this.from=Z(a,b)),c&&(this.to=Z(a,c)),d&&(this.text=d),void 0!==e&&(this.origin=e)}),Xf(a,"beforeChange",a,d),a.cm&&Xf(a.cm,"beforeChange",a.cm,d),d.canceled?null:{from:d.from,to:d.to,text:d.text,origin:d.origin}}function Vb(a,b,c){if(a.cm){if(!a.cm.curOp)return Za(a.cm,Vb)(a,b,c);if(a.cm.state.suppressEdits)return}if(!(Vd(a,"beforeChange")||a.cm&&Vd(a.cm,"beforeChange"))||(b=Ub(a,b,!0))){var d=_e&&!c&&Dc(a,b.from,b.to);if(d)for(var e=d.length-1;e>=0;--e)Wb(a,{from:d[e].from,to:d[e].to,text:e?[""]:b.text});else Wb(a,b)}}function Wb(a,b){if(1!=b.text.length||""!=b.text[0]||0!=cf(b.from,b.to)){var c=Rb(a,b);Dd(a,b,c,a.cm?a.cm.curOp.id:NaN),Zb(a,b,c,Ac(a,b));var d=[];pd(a,function(a,c){c||-1!=_d(d,a.history)||(Nd(a.history,b),d.push(a.history)),Zb(a,b,null,Ac(a,b))})}}function Xb(a,b,c){if(!a.cm||!a.cm.state.suppressEdits){for(var d,e=a.history,f=a.sel,g="undo"==b?e.done:e.undone,h="undo"==b?e.undone:e.done,i=0;i<g.length&&(d=g[i],c?!d.ranges||d.equals(a.sel):d.ranges);i++);if(i!=g.length){for(e.lastOrigin=e.lastSelOrigin=null;d=g.pop(),d.ranges;){if(Gd(d,h),c&&!d.equals(a.sel))return void ia(a,d,{clearRedo:!1});f=d}var j=[];Gd(f,h),h.push({changes:j,generation:e.generation}),e.generation=d.generation||++e.maxGeneration;for(var k=Vd(a,"beforeChange")||a.cm&&Vd(a.cm,"beforeChange"),i=d.changes.length-1;i>=0;--i){var l=d.changes[i];if(l.origin=b,k&&!Ub(a,l,!1))return void(g.length=0);j.push(Ad(a,l));var m=i?Rb(a,l,null):$d(g);Zb(a,l,m,Cc(a,l)),a.cm&&fc(a.cm);var n=[];pd(a,function(a,b){b||-1!=_d(n,a.history)||(Nd(a.history,l),n.push(a.history)),Zb(a,l,null,Cc(a,l))})}}}}function Yb(a,b){a.first+=b,a.sel=new U(ae(a.sel.ranges,function(a){return new V(bf(a.anchor.line+b,a.anchor.ch),bf(a.head.line+b,a.head.ch))}),a.sel.primIndex),a.cm&&cb(a.cm,a.first,a.first-b,b)}function Zb(a,b,c,d){if(a.cm&&!a.cm.curOp)return Za(a.cm,Zb)(a,b,c,d);if(b.to.line<a.first)return void Yb(a,b.text.length-1-(b.to.line-b.from.line));if(!(b.from.line>a.lastLine())){if(b.from.line<a.first){var e=b.text.length-1-(a.first-b.from.line);Yb(a,e),b={from:bf(a.first,0),to:bf(b.to.line+e,b.to.ch),text:[$d(b.text)],origin:b.origin}}var f=a.lastLine();b.to.line>f&&(b={from:b.from,to:bf(f,rd(a,f).text.length),text:[b.text[0]],origin:b.origin}),b.removed=sd(a,b.from,b.to),c||(c=Rb(a,b,null)),a.cm?$b(a.cm,b,d):md(a,b,d),ja(a,c,_f)}}function $b(a,b,c){var d=a.doc,e=a.display,g=b.from,h=b.to,i=!1,j=g.line;a.options.lineWrapping||(j=vd(Nc(rd(d,g.line))),d.iter(j,h.line+1,function(a){return a==e.maxLine?(i=!0,!0):void 0})),d.sel.contains(b.from,b.to)>-1&&Ud(a),md(d,b,c,f(a)),a.options.lineWrapping||(d.iter(j,g.line+b.text.length,function(a){var b=m(a);b>e.maxLineLength&&(e.maxLine=a,e.maxLineLength=b,e.maxLineChanged=!0,i=!1)}),i&&(a.curOp.updateMaxLine=!0)),d.frontier=Math.min(d.frontier,g.line-1),sa(a,400);var k=b.text.length-(h.line-g.line)-1;g.line!=h.line||1!=b.text.length||ld(a.doc,b)?cb(a,g.line,h.line+1,k):db(a,g.line,"text");var l=Vd(a,"changes"),n=Vd(a,"change");if(n||l){var o={from:g,to:h,text:b.text,removed:b.removed,origin:b.origin};n&&Rd(a,"change",a,o),l&&(a.curOp.changeObjs||(a.curOp.changeObjs=[])).push(o)}}function _b(a,b,c,d,e){if(d||(d=c),cf(d,c)<0){var f=d;d=c,c=f}"string"==typeof b&&(b=ng(b)),Vb(a,{from:c,to:d,text:b,origin:e})}function ac(a,b){var c=a.display,d=c.sizer.getBoundingClientRect(),e=null;if(b.top+d.top<0?e=!0:b.bottom+d.top>(window.innerHeight||document.documentElement.clientHeight)&&(e=!1),null!=e&&!Te){var f=ge("div","​",null,"position: absolute; top: "+(b.top-c.viewOffset-wa(a.display))+"px; height: "+(b.bottom-b.top+Zf)+"px; left: "+b.left+"px; width: 2px;");a.display.lineSpace.appendChild(f),f.scrollIntoView(e),a.display.lineSpace.removeChild(f)}}function bc(a,b,c,d){for(null==d&&(d=0);;){var e=!1,f=Pa(a,b),g=c&&c!=b?Pa(a,c):f,h=dc(a,Math.min(f.left,g.left),Math.min(f.top,g.top)-d,Math.max(f.left,g.left),Math.max(f.bottom,g.bottom)+d),i=a.doc.scrollTop,j=a.doc.scrollLeft;if(null!=h.scrollTop&&(Bb(a,h.scrollTop),Math.abs(a.doc.scrollTop-i)>1&&(e=!0)),null!=h.scrollLeft&&(Cb(a,h.scrollLeft),Math.abs(a.doc.scrollLeft-j)>1&&(e=!0)),!e)return f}}function cc(a,b,c,d,e){var f=dc(a,b,c,d,e);null!=f.scrollTop&&Bb(a,f.scrollTop),null!=f.scrollLeft&&Cb(a,f.scrollLeft)}function dc(a,b,c,d,e){var f=a.display,g=Ua(a.display);0>c&&(c=0);var h=a.curOp&&null!=a.curOp.scrollTop?a.curOp.scrollTop:f.scroller.scrollTop,i=f.scroller.clientHeight-Zf,j={},k=a.doc.height+xa(f),l=g>c,m=e>k-g;if(h>c)j.scrollTop=l?0:c;else if(e>h+i){var n=Math.min(c,(m?k:e)-i);n!=h&&(j.scrollTop=n)}var o=a.curOp&&null!=a.curOp.scrollLeft?a.curOp.scrollLeft:f.scroller.scrollLeft,p=f.scroller.clientWidth-Zf;b+=f.gutters.offsetWidth,d+=f.gutters.offsetWidth;var q=f.gutters.offsetWidth,r=q+10>b;return o+q>b||r?(r&&(b=0),j.scrollLeft=Math.max(0,b-10-q)):d>p+o-3&&(j.scrollLeft=d+10-p),j}function ec(a,b,c){(null!=b||null!=c)&&gc(a),null!=b&&(a.curOp.scrollLeft=(null==a.curOp.scrollLeft?a.doc.scrollLeft:a.curOp.scrollLeft)+b),null!=c&&(a.curOp.scrollTop=(null==a.curOp.scrollTop?a.doc.scrollTop:a.curOp.scrollTop)+c)}function fc(a){gc(a);var b=a.getCursor(),c=b,d=b;a.options.lineWrapping||(c=b.ch?bf(b.line,b.ch-1):b,d=bf(b.line,b.ch+1)),a.curOp.scrollToPos={from:c,to:d,margin:a.options.cursorScrollMargin,isCursor:!0}}function gc(a){var b=a.curOp.scrollToPos;if(b){a.curOp.scrollToPos=null;var c=Qa(a,b.from),d=Qa(a,b.to),e=dc(a,Math.min(c.left,d.left),Math.min(c.top,d.top)-b.margin,Math.max(c.right,d.right),Math.max(c.bottom,d.bottom)+b.margin);a.scrollTo(e.scrollLeft,e.scrollTop)}}function hc(a,b,c,d){var e,f=a.doc;null==c&&(c="add"),"smart"==c&&(a.doc.mode.indent?e=va(a,b):c="prev");var g=a.options.tabSize,h=rd(f,b),i=cg(h.text,null,g);h.stateAfter&&(h.stateAfter=null);var j,k=h.text.match(/^\s*/)[0];if(d||/\S/.test(h.text)){if("smart"==c&&(j=a.doc.mode.indent(e,h.text.slice(k.length),h.text),j==$f)){if(!d)return;c="prev"}}else j=0,c="not";var l="",m=0;if("prev"==c?b>f.first?(l=rd(f,b-1).text,j=cg(l,null,g),l=k?"":l.match(/^\s*/)[0]):j=0:"add"==c?j=i+a.options.indentUnit:"subtract"==c?j=i-a.options.indentUnit:"number"==typeof c&&(j=i+c),j=Math.max(0,j),l&&!k);else{if(l="",a.options.indentWithTabs)for(var n=Math.floor(j/g);n;--n)m+=g,l+="	";j>m&&(l+=Zd(j-m))}if(l!=k)_b(a.doc,l,bf(b,0),bf(b,k.length),"+input");else for(var n=0;n<f.sel.ranges.length;n++){var o=f.sel.ranges[n];if(o.head.line==b&&o.head.ch<k.length){var m=bf(b,k.length);ea(f,n,new V(m,m));break}}h.stateAfter=null}function ic(a,b,c,d){var e=b,f=b,g=a.doc;return"number"==typeof b?f=rd(g,Y(g,b)):e=vd(b),null==e?null:(d(f,e)&&db(a,e,c),f)}function jc(a,b){for(var c=a.doc.sel.ranges,d=[],e=0;e<c.length;e++){for(var f=b(c[e]);d.length&&cf(f.from,$d(d).to)<=0;){var g=d.pop();if(cf(g.from,f.from)<0){f.from=g.from;break}}d.push(f)}Ya(a,function(){for(var b=d.length-1;b>=0;b--)_b(a.doc,"",d[b].from,d[b].to,"+delete");fc(a)})}function kc(a,b,c,d,e){function f(){var b=h+c;return b<a.first||b>=a.first+a.size?l=!1:(h=b,k=rd(a,b))}function g(a){var b=(e?Ce:De)(k,i,c,!0);if(null==b){if(a||!f())return l=!1;i=e?(0>c?we:ve)(k):0>c?k.text.length:0}else i=b;return!0}var h=b.line,i=b.ch,j=c,k=rd(a,h),l=!0;if("char"==d)g();else if("column"==d)g(!0);else if("word"==d||"group"==d)for(var m=null,n="group"==d,o=!0;!(0>c)||g(!o);o=!1){var p=k.text.charAt(i)||"\n",q=hg(p)?"w":n&&"\n"==p?"n":!n||/\s/.test(p)?null:"p";if(!n||o||q||(q="s"),m&&m!=q){0>c&&(c=1,g());break}if(q&&(m=q),c>0&&!g(!o))break}var r=na(a,bf(h,i),j,!0);return l||(r.hitSide=!0),r}function lc(a,b,c,d){var e,f=a.doc,g=b.left;if("page"==d){var h=Math.min(a.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight);e=b.top+c*(h-(0>c?1.5:.5)*Ua(a.display))}else"line"==d&&(e=c>0?b.bottom+3:b.top-3);for(;;){var i=Sa(a,g,e);if(!i.outside)break;if(0>c?0>=e:e>=f.height){i.hitSide=!0;break}e+=5*c}return i}function mc(a,b){var c=rd(a,b.line).text,d=b.ch,e=b.ch;if(c){(b.xRel<0||e==c.length)&&d?--d:++e;for(var f=c.charAt(d),g=hg(f)?hg:/\s/.test(f)?function(a){return/\s/.test(a)}:function(a){return!/\s/.test(a)&&!hg(a)};d>0&&g(c.charAt(d-1));)--d;for(;e<c.length&&g(c.charAt(e));)++e}return new V(bf(b.line,d),bf(b.line,e))}function nc(b,c,d,e){a.defaults[b]=c,d&&(rf[b]=e?function(a,b,c){c!=sf&&d(a,b,c)}:d)}function oc(a){return"string"==typeof a?Bf[a]:a}function pc(a,b,c,d,e){if(d&&d.shared)return qc(a,b,c,d,e);if(a.cm&&!a.cm.curOp)return Za(a.cm,pc)(a,b,c,d,e);var f=new Gf(a,e),g=cf(b,c);if(d&&ce(d,f,!1),g>0||0==g&&f.clearWhenEmpty!==!1)return f;if(f.replacedWith&&(f.collapsed=!0,f.widgetNode=ge("span",[f.replacedWith],"CodeMirror-widget"),d.handleMouseEvents||(f.widgetNode.ignoreEvents=!0),d.insertLeft&&(f.widgetNode.insertLeft=!0)),f.collapsed){if(Mc(a,b.line,b,c,f)||b.line!=c.line&&Mc(a,c.line,b,c,f))throw new Error("Inserting collapsed marker partially overlapping an existing one");af=!0}f.addToHistory&&Dd(a,{from:b,to:c,origin:"markText"},a.sel,NaN);var h,i=b.line,j=a.cm;if(a.iter(i,c.line+1,function(a){j&&f.collapsed&&!j.options.lineWrapping&&Nc(a)==j.display.maxLine&&(h=!0),f.collapsed&&i!=b.line&&ud(a,0),xc(a,new uc(f,i==b.line?b.ch:null,i==c.line?c.ch:null)),++i}),f.collapsed&&a.iter(b.line,c.line+1,function(b){Rc(a,b)&&ud(b,0)}),f.clearOnEnter&&Vf(f,"beforeCursorEnter",function(){f.clear()}),f.readOnly&&(_e=!0,(a.history.done.length||a.history.undone.length)&&a.clearHistory()),f.collapsed&&(f.id=++Hf,f.atomic=!0),j){if(h&&(j.curOp.updateMaxLine=!0),f.collapsed)cb(j,b.line,c.line+1);else if(f.className||f.title||f.startStyle||f.endStyle)for(var k=b.line;k<=c.line;k++)db(j,k,"text");f.atomic&&la(j.doc),Rd(j,"markerAdded",j,f)}return f}function qc(a,b,c,d,e){d=ce(d),d.shared=!1;var f=[pc(a,b,c,d,e)],g=f[0],h=d.widgetNode;return pd(a,function(a){h&&(d.widgetNode=h.cloneNode(!0)),f.push(pc(a,Z(a,b),Z(a,c),d,e));for(var i=0;i<a.linked.length;++i)if(a.linked[i].isParent)return;g=$d(f)}),new If(f,g)}function rc(a){return a.findMarks(bf(a.first,0),a.clipPos(bf(a.lastLine())),function(a){return a.parent})}function sc(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=d.find(),f=a.clipPos(e.from),g=a.clipPos(e.to);if(cf(f,g)){var h=pc(a,f,g,d.primary,d.primary.type);d.markers.push(h),h.parent=d}}}function tc(a){for(var b=0;b<a.length;b++){var c=a[b],d=[c.primary.doc];pd(c.primary.doc,function(a){d.push(a)});for(var e=0;e<c.markers.length;e++){var f=c.markers[e];-1==_d(d,f.doc)&&(f.parent=null,c.markers.splice(e--,1))}}}function uc(a,b,c){this.marker=a,this.from=b,this.to=c}function vc(a,b){if(a)for(var c=0;c<a.length;++c){var d=a[c];if(d.marker==b)return d}}function wc(a,b){for(var c,d=0;d<a.length;++d)a[d]!=b&&(c||(c=[])).push(a[d]);return c}function xc(a,b){a.markedSpans=a.markedSpans?a.markedSpans.concat([b]):[b],b.marker.attachLine(a)}function yc(a,b,c){if(a)for(var d,e=0;e<a.length;++e){var f=a[e],g=f.marker,h=null==f.from||(g.inclusiveLeft?f.from<=b:f.from<b);if(h||f.from==b&&"bookmark"==g.type&&(!c||!f.marker.insertLeft)){var i=null==f.to||(g.inclusiveRight?f.to>=b:f.to>b);(d||(d=[])).push(new uc(g,f.from,i?null:f.to))}}return d}function zc(a,b,c){if(a)for(var d,e=0;e<a.length;++e){var f=a[e],g=f.marker,h=null==f.to||(g.inclusiveRight?f.to>=b:f.to>b);if(h||f.from==b&&"bookmark"==g.type&&(!c||f.marker.insertLeft)){var i=null==f.from||(g.inclusiveLeft?f.from<=b:f.from<b);(d||(d=[])).push(new uc(g,i?null:f.from-b,null==f.to?null:f.to-b))}}return d}function Ac(a,b){var c=_(a,b.from.line)&&rd(a,b.from.line).markedSpans,d=_(a,b.to.line)&&rd(a,b.to.line).markedSpans;if(!c&&!d)return null;var e=b.from.ch,f=b.to.ch,g=0==cf(b.from,b.to),h=yc(c,e,g),i=zc(d,f,g),j=1==b.text.length,k=$d(b.text).length+(j?e:0);if(h)for(var l=0;l<h.length;++l){var m=h[l];if(null==m.to){var n=vc(i,m.marker);n?j&&(m.to=null==n.to?null:n.to+k):m.to=e}}if(i)for(var l=0;l<i.length;++l){var m=i[l];if(null!=m.to&&(m.to+=k),null==m.from){var n=vc(h,m.marker);n||(m.from=k,j&&(h||(h=[])).push(m))}else m.from+=k,j&&(h||(h=[])).push(m)}h&&(h=Bc(h)),i&&i!=h&&(i=Bc(i));var o=[h];if(!j){var p,q=b.text.length-2;if(q>0&&h)for(var l=0;l<h.length;++l)null==h[l].to&&(p||(p=[])).push(new uc(h[l].marker,null,null));for(var l=0;q>l;++l)o.push(p);o.push(i)}return o}function Bc(a){for(var b=0;b<a.length;++b){var c=a[b];null!=c.from&&c.from==c.to&&c.marker.clearWhenEmpty!==!1&&a.splice(b--,1)}return a.length?a:null}function Cc(a,b){var c=Jd(a,b),d=Ac(a,b);if(!c)return d;if(!d)return c;for(var e=0;e<c.length;++e){var f=c[e],g=d[e];if(f&&g)a:for(var h=0;h<g.length;++h){for(var i=g[h],j=0;j<f.length;++j)if(f[j].marker==i.marker)continue a;f.push(i)}else g&&(c[e]=g)}return c}function Dc(a,b,c){var d=null;if(a.iter(b.line,c.line+1,function(a){if(a.markedSpans)for(var b=0;b<a.markedSpans.length;++b){var c=a.markedSpans[b].marker;!c.readOnly||d&&-1!=_d(d,c)||(d||(d=[])).push(c)}}),!d)return null;for(var e=[{from:b,to:c}],f=0;f<d.length;++f)for(var g=d[f],h=g.find(0),i=0;i<e.length;++i){var j=e[i];if(!(cf(j.to,h.from)<0||cf(j.from,h.to)>0)){var k=[i,1],l=cf(j.from,h.from),m=cf(j.to,h.to);(0>l||!g.inclusiveLeft&&!l)&&k.push({from:j.from,to:h.from}),(m>0||!g.inclusiveRight&&!m)&&k.push({from:h.to,to:j.to}),e.splice.apply(e,k),i+=k.length-1}}return e}function Ec(a){var b=a.markedSpans;if(b){for(var c=0;c<b.length;++c)b[c].marker.detachLine(a);a.markedSpans=null}}function Fc(a,b){if(b){for(var c=0;c<b.length;++c)b[c].marker.attachLine(a);a.markedSpans=b}}function Gc(a){return a.inclusiveLeft?-1:0}function Hc(a){return a.inclusiveRight?1:0}function Ic(a,b){var c=a.lines.length-b.lines.length;if(0!=c)return c;var d=a.find(),e=b.find(),f=cf(d.from,e.from)||Gc(a)-Gc(b);if(f)return-f;var g=cf(d.to,e.to)||Hc(a)-Hc(b);return g?g:b.id-a.id}function Jc(a,b){var c,d=af&&a.markedSpans;if(d)for(var e,f=0;f<d.length;++f)e=d[f],e.marker.collapsed&&null==(b?e.from:e.to)&&(!c||Ic(c,e.marker)<0)&&(c=e.marker);return c}function Kc(a){return Jc(a,!0)}function Lc(a){return Jc(a,!1)}function Mc(a,b,c,d,e){var f=rd(a,b),g=af&&f.markedSpans;if(g)for(var h=0;h<g.length;++h){var i=g[h];if(i.marker.collapsed){var j=i.marker.find(0),k=cf(j.from,c)||Gc(i.marker)-Gc(e),l=cf(j.to,d)||Hc(i.marker)-Hc(e);if(!(k>=0&&0>=l||0>=k&&l>=0)&&(0>=k&&(cf(j.to,c)||Hc(i.marker)-Gc(e))>0||k>=0&&(cf(j.from,d)||Gc(i.marker)-Hc(e))<0))return!0}}}function Nc(a){for(var b;b=Kc(a);)a=b.find(-1,!0).line;return a}function Oc(a){for(var b,c;b=Lc(a);)a=b.find(1,!0).line,(c||(c=[])).push(a);return c}function Pc(a,b){var c=rd(a,b),d=Nc(c);return c==d?b:vd(d)}function Qc(a,b){if(b>a.lastLine())return b;var c,d=rd(a,b);if(!Rc(a,d))return b;for(;c=Lc(d);)d=c.find(1,!0).line;return vd(d)+1}function Rc(a,b){var c=af&&b.markedSpans;if(c)for(var d,e=0;e<c.length;++e)if(d=c[e],d.marker.collapsed){if(null==d.from)return!0;if(!d.marker.widgetNode&&0==d.from&&d.marker.inclusiveLeft&&Sc(a,b,d))return!0}}function Sc(a,b,c){if(null==c.to){var d=c.marker.find(1,!0);return Sc(a,d.line,vc(d.line.markedSpans,c.marker))}if(c.marker.inclusiveRight&&c.to==b.text.length)return!0;for(var e,f=0;f<b.markedSpans.length;++f)if(e=b.markedSpans[f],e.marker.collapsed&&!e.marker.widgetNode&&e.from==c.to&&(null==e.to||e.to!=c.from)&&(e.marker.inclusiveLeft||c.marker.inclusiveRight)&&Sc(a,b,e))return!0}function Tc(a,b,c){xd(b)<(a.curOp&&a.curOp.scrollTop||a.doc.scrollTop)&&ec(a,null,c)}function Uc(a){return null!=a.height?a.height:(je(document.body,a.node)||ie(a.cm.display.measure,ge("div",[a.node],null,"position: relative")),a.height=a.node.offsetHeight)}function Vc(a,b,c,d){var e=new Jf(a,c,d);return e.noHScroll&&(a.display.alignWidgets=!0),ic(a,b,"widget",function(b){var c=b.widgets||(b.widgets=[]);if(null==e.insertAt?c.push(e):c.splice(Math.min(c.length-1,Math.max(0,e.insertAt)),0,e),e.line=b,!Rc(a.doc,b)){var d=xd(b)<a.doc.scrollTop;ud(b,b.height+Uc(e)),d&&ec(a,null,e.height),a.curOp.forceUpdate=!0}return!0}),e}function Wc(a,b,c,d){a.text=b,a.stateAfter&&(a.stateAfter=null),a.styles&&(a.styles=null),null!=a.order&&(a.order=null),Ec(a),Fc(a,c);var e=d?d(a):1;e!=a.height&&ud(a,e)}function Xc(a){a.parent=null,Ec(a)}function Yc(a,b){if(a)for(;;){var c=a.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!c)break;a=a.slice(0,c.index)+a.slice(c.index+c[0].length);var d=c[1]?"bgClass":"textClass";null==b[d]?b[d]=c[2]:new RegExp("(?:^|s)"+c[2]+"(?:$|s)").test(b[d])||(b[d]+=" "+c[2])}return a}function Zc(b,c){if(b.blankLine)return b.blankLine(c);if(b.innerMode){var d=a.innerMode(b,c);return d.mode.blankLine?d.mode.blankLine(d.state):void 0}}function $c(a,b,c){for(var d=0;10>d;d++){var e=a.token(b,c);if(b.pos>b.start)return e}if("gfm"==a.name)return b.pos=b.start+1,null;throw new Error("Mode "+a.name+" failed to advance stream.")}function _c(b,c,d,e,f,g,h){var i=d.flattenSpans;null==i&&(i=b.options.flattenSpans);var j,k=0,l=null,m=new Ff(c,b.options.tabSize);for(""==c&&Yc(Zc(d,e),g);!m.eol();){if(m.pos>b.options.maxHighlightLength?(i=!1,h&&cd(b,c,e,m.pos),m.pos=c.length,j=null):j=Yc($c(d,m,e),g),b.options.addModeClass){var n=a.innerMode(d,e).mode.name;n&&(j="m-"+(j?n+" "+j:n))}i&&l==j||(k<m.start&&f(m.start,l),k=m.start,l=j),m.start=m.pos}for(;k<m.pos;){var o=Math.min(m.pos,k+5e4);f(o,l),k=o}}function ad(a,b,c,d){var e=[a.state.modeGen],f={},g=vd(b);"object"==typeof c&&(c.lineBefore=a.getLine(g-1),c.lineAfter=a.getLine(g+1)),_c(a,b.text,a.doc.mode,c,function(a,b){e.push(a,b)},f,d);for(var h=0;h<a.state.overlays.length;++h){var i=a.state.overlays[h],j=1,k=0;_c(a,b.text,i.mode,"visiblespace"===i.mode.name?c.base:!0,function(a,b){for(var c=j;a>k;){var d=e[j];d>a&&e.splice(j,1,a,e[j+1],d),j+=2,k=Math.min(a,d)}if(b)if(i.opaque)e.splice(c,j-c,a,"cm-overlay "+b),j=c+2;else for(;j>c;c+=2){var f=e[c+1];e[c+1]=(f?f+" ":"")+"cm-overlay "+b}},f)}return{styles:e,classes:f.bgClass||f.textClass?f:null}}function bd(a,b){if(!b.styles||b.styles[0]!=a.state.modeGen){var c=ad(a,b,b.stateAfter=va(a,vd(b)));b.styles=c.styles,c.classes?b.styleClasses=c.classes:b.styleClasses&&(b.styleClasses=null)}return b.styles}function cd(a,b,c,d){var e=a.doc.mode,f=new Ff(b,a.options.tabSize);for(f.start=f.pos=d||0,""==b&&Zc(e,c);!f.eol()&&f.pos<=a.options.maxHighlightLength;)$c(e,f,c),f.start=f.pos}function dd(a,b){if(!a||/^\s*$/.test(a))return null;var c=b.addModeClass?Mf:Lf;return c[a]||(c[a]=a.replace(/\S+/g,"cm-$&"))}function ed(a,b){var c=ge("span",null,null,Le?"padding-right: .1px":null),d={pre:ge("pre",[c]),content:c,col:0,pos:0,cm:a};b.measure={};for(var e=0;e<=(b.rest?b.rest.length:0);e++){var f,g=e?b.rest[e-1]:b.line;d.pos=0,d.addToken=gd,(Ke||Le)&&a.getOption("lineWrapping")&&(d.addToken=hd(d.addToken)),re(a.display.measure)&&(f=yd(g))&&(d.addToken=id(d.addToken,f)),d.map=[],kd(g,d,bd(a,g)),g.styleClasses&&(g.styleClasses.bgClass&&(d.bgClass=oe(g.styleClasses.bgClass,d.bgClass||"")),g.styleClasses.textClass&&(d.textClass=oe(g.styleClasses.textClass,d.textClass||""))),0==d.map.length&&d.map.push(0,0,d.content.appendChild(qe(a.display.measure))),0==e?(b.measure.map=d.map,b.measure.cache={}):((b.measure.maps||(b.measure.maps=[])).push(d.map),(b.measure.caches||(b.measure.caches=[])).push({}))}return Xf(a,"renderLine",a,b.line,d.pre),d}function fd(a){var b=ge("span","•","cm-invalidchar");return b.title="\\u"+a.charCodeAt(0).toString(16),b}function gd(a,b,c,d,e,f){if(b){var g=a.cm.options.specialChars,h=!1;if(g.test(b))for(var i=document.createDocumentFragment(),j=0;;){g.lastIndex=j;var k=g.exec(b),l=k?k.index-j:b.length-j;if(l){var m=document.createTextNode(b.slice(j,j+l));He?i.appendChild(ge("span",[m])):i.appendChild(m),a.map.push(a.pos,a.pos+l,m),a.col+=l,a.pos+=l}if(!k)break;if(j+=l+1,"	"==k[0]){var n=a.cm.options.tabSize,o=n-a.col%n,m=i.appendChild(ge("span",Zd(o),"cm-tab"));a.col+=o}else{var m=a.cm.options.specialCharPlaceholder(k[0]);He?i.appendChild(ge("span",[m])):i.appendChild(m),a.col+=1}a.map.push(a.pos,a.pos+1,m),a.pos++}else{a.col+=b.length;var i=document.createTextNode(b);a.map.push(a.pos,a.pos+b.length,i),He&&(h=!0),a.pos+=b.length}if(c||d||e||h){var p=c||"";d&&(p+=d),e&&(p+=e);var q=ge("span",[i],p);return f&&(q.title=f),a.content.appendChild(q)}a.content.appendChild(i)}}function hd(a){function b(a){for(var b=" ",c=0;c<a.length-2;++c)b+=c%2?" ":" ";return b+=" "}return function(c,d,e,f,g,h){a(c,d.replace(/ {3,}/g,b),e,f,g,h)}}function id(a,b){return function(c,d,e,f,g,h){e=e?e+" cm-force-border":"cm-force-border";for(var i=c.pos,j=i+d.length;;){for(var k=0;k<b.length;k++){var l=b[k];if(l.to>i&&l.from<=i)break}if(l.to>=j)return a(c,d,e,f,g,h);a(c,d.slice(0,l.to-i),e,f,null,h),f=null,d=d.slice(l.to-i),i=l.to}}}function jd(a,b,c,d){var e=!d&&c.widgetNode;e&&(a.map.push(a.pos,a.pos+b,e),a.content.appendChild(e)),a.pos+=b}function kd(a,b,c){var d=a.markedSpans,e=a.text,f=0;if(d)for(var g,h,i,j,k,l,m=e.length,n=0,o=1,p="",q=0;;){if(q==n){h=i=j=k="",l=null,q=1/0;for(var r=[],s=0;s<d.length;++s){var t=d[s],u=t.marker;t.from<=n&&(null==t.to||t.to>n)?(null!=t.to&&q>t.to&&(q=t.to,i=""),u.className&&(h+=" "+u.className),u.startStyle&&t.from==n&&(j+=" "+u.startStyle),u.endStyle&&t.to==q&&(i+=" "+u.endStyle),u.title&&!k&&(k=u.title),u.collapsed&&(!l||Ic(l.marker,u)<0)&&(l=t)):t.from>n&&q>t.from&&(q=t.from),"bookmark"==u.type&&t.from==n&&u.widgetNode&&r.push(u)}if(l&&(l.from||0)==n&&(jd(b,(null==l.to?m+1:l.to)-n,l.marker,null==l.from),null==l.to))return;if(!l&&r.length)for(var s=0;s<r.length;++s)jd(b,0,r[s])}if(n>=m)break;for(var v=Math.min(m,q);;){if(p){var w=n+p.length;if(!l){var x=w>v?p.slice(0,v-n):p;b.addToken(b,x,g?g+h:h,j,n+x.length==q?i:"",k)}if(w>=v){p=p.slice(v-n),n=v;break}n=w,j=""}p=e.slice(f,f=c[o++]),g=dd(c[o++],b.cm.options)}}else for(var o=1;o<c.length;o+=2)b.addToken(b,e.slice(f,f=c[o]),dd(c[o+1],b.cm.options))}function ld(a,b){return 0==b.from.ch&&0==b.to.ch&&""==$d(b.text)&&(!a.cm||a.cm.options.wholeLineUpdateBefore)}function md(a,b,c,d){function e(a){return c?c[a]:null}function f(a,c,e){Wc(a,c,e,d),Rd(a,"change",a,b)}var g=b.from,h=b.to,i=b.text,j=rd(a,g.line),k=rd(a,h.line),l=$d(i),m=e(i.length-1),n=h.line-g.line;if(ld(a,b)){for(var o=0,p=[];o<i.length-1;++o)p.push(new Kf(i[o],e(o),d));f(k,k.text,m),n&&a.remove(g.line,n),p.length&&a.insert(g.line,p)}else if(j==k)if(1==i.length)f(j,j.text.slice(0,g.ch)+l+j.text.slice(h.ch),m);else{for(var p=[],o=1;o<i.length-1;++o)p.push(new Kf(i[o],e(o),d));p.push(new Kf(l+j.text.slice(h.ch),m,d)),f(j,j.text.slice(0,g.ch)+i[0],e(0)),a.insert(g.line+1,p)}else if(1==i.length)f(j,j.text.slice(0,g.ch)+i[0]+k.text.slice(h.ch),e(0)),a.remove(g.line+1,n);else{f(j,j.text.slice(0,g.ch)+i[0],e(0)),f(k,l+k.text.slice(h.ch),m);for(var o=1,p=[];o<i.length-1;++o)p.push(new Kf(i[o],e(o),d));n>1&&a.remove(g.line+1,n-1),a.insert(g.line+1,p)}Rd(a,"change",a,b)}function nd(a){this.lines=a,this.parent=null;for(var b=0,c=0;b<a.length;++b)a[b].parent=this,c+=a[b].height;this.height=c}function od(a){this.children=a;for(var b=0,c=0,d=0;d<a.length;++d){var e=a[d];b+=e.chunkSize(),c+=e.height,e.parent=this}this.size=b,this.height=c,this.parent=null}function pd(a,b,c){function d(a,e,f){if(a.linked)for(var g=0;g<a.linked.length;++g){var h=a.linked[g];if(h.doc!=e){var i=f&&h.sharedHist;(!c||i)&&(b(h.doc,i),d(h.doc,a,i))}}}d(a,null,!0)}function qd(a,b){if(b.cm)throw new Error("This document is already in use.");a.doc=b,b.cm=a,g(a),c(a),a.options.lineWrapping||n(a),a.options.mode=b.modeOption,cb(a)}function rd(a,b){if(b-=a.first,0>b||b>=a.size)throw new Error("There is no line "+(b+a.first)+" in the document.");for(var c=a;!c.lines;)for(var d=0;;++d){var e=c.children[d],f=e.chunkSize();if(f>b){c=e;break}b-=f}return c.lines[b]}function sd(a,b,c){var d=[],e=b.line;return a.iter(b.line,c.line+1,function(a){var f=a.text;e==c.line&&(f=f.slice(0,c.ch)),e==b.line&&(f=f.slice(b.ch)),d.push(f),++e}),d}function td(a,b,c){var d=[];return a.iter(b,c,function(a){d.push(a.text)}),d}function ud(a,b){var c=b-a.height;if(c)for(var d=a;d;d=d.parent)d.height+=c}function vd(a){if(null==a.parent)return null;for(var b=a.parent,c=_d(b.lines,a),d=b.parent;d;b=d,d=d.parent)for(var e=0;d.children[e]!=b;++e)c+=d.children[e].chunkSize();return c+b.first}function wd(a,b){var c=a.first;a:do{for(var d=0;d<a.children.length;++d){var e=a.children[d],f=e.height;if(f>b){a=e;continue a}b-=f,c+=e.chunkSize()}return c}while(!a.lines);for(var d=0;d<a.lines.length;++d){var g=a.lines[d],h=g.height;if(h>b)break;b-=h}return c+d}function xd(a){a=Nc(a);for(var b=0,c=a.parent,d=0;d<c.lines.length;++d){var e=c.lines[d];if(e==a)break;b+=e.height}for(var f=c.parent;f;c=f,f=c.parent)for(var d=0;d<f.children.length;++d){var g=f.children[d];if(g==c)break;b+=g.height}return b}function yd(a){var b=a.order;return null==b&&(b=a.order=sg(a.text)),b}function zd(a){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=a||1}function Ad(a,b){var c={from:R(b.from),to:pf(b),text:sd(a,b.from,b.to)};return Hd(a,c,b.from.line,b.to.line+1),pd(a,function(a){Hd(a,c,b.from.line,b.to.line+1)},!0),c}function Bd(a){for(;a.length;){var b=$d(a);if(!b.ranges)break;a.pop()}}function Cd(a,b){return b?(Bd(a.done),$d(a.done)):a.done.length&&!$d(a.done).ranges?$d(a.done):a.done.length>1&&!a.done[a.done.length-2].ranges?(a.done.pop(),$d(a.done)):void 0}function Dd(a,b,c,d){var e=a.history;e.undone.length=0;var f,g=+new Date,h=(b.text||[]).length>1;if(!h&&(e.lastOp==d||e.lastOrigin==b.origin&&b.origin&&("+"==b.origin.charAt(0)&&a.cm&&e.lastModTime>g-a.cm.options.historyEventDelay||"*"==b.origin.charAt(0)))&&(f=Cd(e,e.lastOp==d))){var i=$d(f.changes);0==cf(b.from,b.to)&&0==cf(b.from,i.to)?i.to=pf(b):f.changes.push(Ad(a,b))}else{"setValue"!=b.origin&&a.cm.cid&&a.cm.editor.fences.addToUndoManager(a.cm,!1,"undo");var j=$d(e.done);for(j&&j.ranges||Gd(a.sel,e.done),f={changes:[Ad(a,b)],generation:e.generation},e.done.push(f);e.done.length>e.undoDepth;)e.done.shift(),e.done[0].ranges||e.done.shift()}e.done.push(c),e.generation=++e.maxGeneration,e.lastModTime=e.lastSelTime=g,e.lastOp=d,e.lastOrigin=e.lastSelOrigin=b.origin,i||Xf(a,"historyAdded")}function Ed(a,b,c,d){var e=b.charAt(0);return"*"==e||"+"==e&&c.ranges.length==d.ranges.length&&c.somethingSelected()==d.somethingSelected()&&new Date-a.history.lastSelTime<=(a.cm?a.cm.options.historyEventDelay:500)}function Fd(a,b,c,d){var e=a.history,f=d&&d.origin;c==e.lastOp||f&&e.lastSelOrigin==f&&(e.lastModTime==e.lastSelTime&&e.lastOrigin==f||Ed(a,f,$d(e.done),b))?e.done[e.done.length-1]=b:Gd(b,e.done),e.lastSelTime=+new Date,e.lastSelOrigin=f,e.lastOp=c,d&&d.clearRedo!==!1&&Bd(e.undone)}function Gd(a,b){var c=$d(b);c&&c.ranges&&c.equals(a)||b.push(a)}function Hd(a,b,c,d){var e=b["spans_"+a.id],f=0;a.iter(Math.max(a.first,c),Math.min(a.first+a.size,d),function(c){c.markedSpans&&((e||(e=b["spans_"+a.id]={}))[f]=c.markedSpans),++f})}function Id(a){if(!a)return null;for(var b,c=0;c<a.length;++c)a[c].marker.explicitlyCleared?b||(b=a.slice(0,c)):b&&b.push(a[c]);return b?b.length?b:null:a}function Jd(a,b){var c=b["spans_"+a.id];if(!c)return null;for(var d=0,e=[];d<b.text.length;++d)e.push(Id(c[d]));return e}function Kd(a,b,c){for(var d=0,e=[];d<a.length;++d){var f=a[d];if(f.ranges)e.push(c?U.prototype.deepCopy.call(f):f);else{var g=f.changes,h=[];e.push({changes:h});for(var i=0;i<g.length;++i){var j,k=g[i];if(h.push({from:k.from,to:k.to,text:k.text}),b)for(var l in k)(j=l.match(/^spans_(\d+)$/))&&_d(b,Number(j[1]))>-1&&($d(h)[l]=k[l],delete k[l])}}}return e}function Ld(a,b,c,d){c<a.line?a.line+=d:b<a.line&&(a.line=b,a.ch=0)}function Md(a,b,c,d){for(var e=0;e<a.length;++e){var f=a[e],g=!0;if(f.ranges){f.copied||(f=a[e]=f.deepCopy(),f.copied=!0);for(var h=0;h<f.ranges.length;h++)Ld(f.ranges[h].anchor,b,c,d),Ld(f.ranges[h].head,b,c,d)}else{for(var h=0;h<f.changes.length;++h){var i=f.changes[h];if(c<i.from.line)i.from=bf(i.from.line+d,i.from.ch),i.to=bf(i.to.line+d,i.to.ch);else if(b<=i.to.line){g=!1;break}}g||(a.splice(0,e+1),e=0)}}}function Nd(a,b){var c=b.from.line,d=b.to.line,e=b.text.length-(d-c)-1;Md(a.done,c,d,e),Md(a.undone,c,d,e)}function Od(a){return null!=a.defaultPrevented?a.defaultPrevented:0==a.returnValue}function Pd(a){return a.target||a.srcElement}function Qd(a){var b=a.which;return null==b&&(1&a.button?b=1:2&a.button?b=3:4&a.button&&(b=2)),We&&a.ctrlKey&&1==b&&(b=3),b}function Rd(a,b){function c(a){return function(){a.apply(null,e)}}var d=a._handlers&&a._handlers[b];if(d){var e=Array.prototype.slice.call(arguments,2);Rf||(++Yf,Rf=[],setTimeout(Sd,0));for(var f=0;f<d.length;++f)Rf.push(c(d[f]))}}function Sd(){--Yf;var a=Rf;Rf=null;for(var b=0;b<a.length;++b)a[b]()}function Td(a,b,c){return Xf(a,c||b.type,a,b),Od(b)||b.codemirrorIgnore}function Ud(a){var b=a._handlers&&a._handlers.cursorActivity;if(b)for(var c=a.curOp.cursorActivityHandlers||(a.curOp.cursorActivityHandlers=[]),d=0;d<b.length;++d)-1==_d(c,b[d])&&c.push(b[d])}function Vd(a,b){var c=a._handlers&&a._handlers[b];return c&&c.length>0}function Wd(a){a.prototype.on=function(a,b){Vf(this,a,b)},a.prototype.off=function(a,b){Wf(this,a,b)}}function Xd(){
this.id=null}function Yd(a,b,c){for(var d=0,e=0;;){var f=a.indexOf("	",d);-1==f&&(f=a.length);var g=f-d;if(f==a.length||e+g>=b)return d+Math.min(g,b-e);if(e+=f-d,e+=c-e%c,d=f+1,e>=b)return d}}function Zd(a){for(;dg.length<=a;)dg.push($d(dg)+" ");return dg[a]}function $d(a){return a[a.length-1]}function _d(a,b){for(var c=0;c<a.length;++c)if(a[c]==b)return c;return-1}function ae(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=b(a[d],d);return c}function be(a,b){var c;if(Object.create)c=Object.create(a);else{var d=function(){};d.prototype=a,c=new d}return b&&ce(b,c),c}function ce(a,b,c){b||(b={});for(var d in a)!a.hasOwnProperty(d)||c===!1&&b.hasOwnProperty(d)||(b[d]=a[d]);return b}function de(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b)}}function ee(a){for(var b in a)if(a.hasOwnProperty(b)&&a[b])return!1;return!0}function fe(a){return a.charCodeAt(0)>=768&&ig.test(a)}function ge(a,b,c,d){var e=document.createElement(a);if(c&&(e.className=c),d&&(e.style.cssText=d),"string"==typeof b)e.appendChild(document.createTextNode(b));else if(b)for(var f=0;f<b.length;++f)e.appendChild(b[f]);return e}function he(a){for(var b=a.childNodes.length;b>0;--b)a.removeChild(a.firstChild);return a}function ie(a,b){return he(a).appendChild(b)}function je(a,b){if(a.contains)return a.contains(b);for(;b=b.parentNode;)if(b==a)return!0}function ke(){return document.activeElement}function le(a){return new RegExp("\\b"+a+"\\b\\s*")}function me(a,b){var c=le(b);c.test(a.className)&&(a.className=a.className.replace(c,""))}function ne(a,b){le(b).test(a.className)||(a.className+=" "+b)}function oe(a,b){for(var c=a.split(" "),d=0;d<c.length;d++)c[d]&&!le(c[d]).test(b)&&(b+=" "+c[d]);return b}function pe(a){if(null!=jg)return jg;var b=ge("div",null,null,"width: 50px; height: 50px; overflow-x: scroll");return ie(a,b),b.offsetWidth&&(jg=b.offsetHeight-b.clientHeight),jg||0}function qe(a){if(null==kg){var b=ge("span","​");ie(a,ge("span",[b,document.createTextNode("x")])),0!=a.firstChild.offsetHeight&&(kg=b.offsetWidth<=1&&b.offsetHeight>2&&!Ge)}return kg?ge("span","​"):ge("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px")}function re(a){if(null!=lg)return lg;var b=ie(a,document.createTextNode("AخA")),c=fg(b,0,1).getBoundingClientRect();if(c.left==c.right)return!1;var d=fg(b,1,2).getBoundingClientRect();return lg=d.right-c.right<3}function se(a,b,c,d){if(!a)return d(b,c,"ltr");for(var e=!1,f=0;f<a.length;++f){var g=a[f];(g.from<c&&g.to>b||b==c&&g.to==b)&&(d(Math.max(g.from,b),Math.min(g.to,c),1==g.level?"rtl":"ltr"),e=!0)}e||d(b,c,"ltr")}function te(a){return a.level%2?a.to:a.from}function ue(a){return a.level%2?a.from:a.to}function ve(a){var b=yd(a);return b?te(b[0]):0}function we(a){var b=yd(a);return b?ue($d(b)):a.text.length}function xe(a,b){var c=rd(a.doc,b),d=Nc(c);d!=c&&(b=vd(d));var e=yd(d),f=e?e[0].level%2?we(d):ve(d):0;return bf(b,f)}function ye(a,b){for(var c,d=rd(a.doc,b);c=Lc(d);)d=c.find(1,!0).line,b=null;var e=yd(d),f=e?e[0].level%2?ve(d):we(d):d.text.length;return bf(null==b?vd(d):b,f)}function ze(a,b,c){var d=a[0].level;return b==d?!0:c==d?!1:c>b}function Ae(a,b){rg=null;for(var c,d=0;d<a.length;++d){var e=a[d];if(e.from<b&&e.to>b)return d;if(e.from==b||e.to==b){if(null!=c)return ze(a,e.level,a[c].level)?(e.from!=e.to&&(rg=c),d):(e.from!=e.to&&(rg=d),c);c=d}}return c}function Be(a,b,c,d){if(!d)return b+c;do b+=c;while(b>0&&fe(a.text.charAt(b)));return b}function Ce(a,b,c,d){var e=yd(a);if(!e)return De(a,b,c,d);for(var f=Ae(e,b),g=e[f],h=Be(a,b,g.level%2?-c:c,d);;){if(h>g.from&&h<g.to)return h;if(h==g.from||h==g.to)return Ae(e,h)==f?h:(g=e[f+=c],c>0==g.level%2?g.to:g.from);if(g=e[f+=c],!g)return null;h=c>0==g.level%2?Be(a,g.to,-1,d):Be(a,g.from,1,d)}}function De(a,b,c,d){var e=b+c;if(d)for(;e>0&&fe(a.text.charAt(e));)e+=c;return 0>e||e>a.text.length?null:e}var Ee=/gecko\/\d/i.test(navigator.userAgent),Fe=/MSIE \d/.test(navigator.userAgent),Ge=Fe&&(null==document.documentMode||document.documentMode<8),He=Fe&&(null==document.documentMode||document.documentMode<9),Ie=Fe&&(null==document.documentMode||document.documentMode<10),Je=/Trident\/([7-9]|\d{2,})\./.test(navigator.userAgent),Ke=Fe||Je,Le=/WebKit\//.test(navigator.userAgent),Me=Le&&/Qt\/\d+\.\d+/.test(navigator.userAgent),Ne=/Chrome\//.test(navigator.userAgent),Oe=/Opera\//.test(navigator.userAgent),Pe=/Apple Computer/.test(navigator.vendor),Qe=/KHTML\//.test(navigator.userAgent),Re=/Mac OS X 1\d\D([7-9]|\d\d)\D/.test(navigator.userAgent),Se=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(navigator.userAgent),Te=/PhantomJS/.test(navigator.userAgent),Ue=/AppleWebKit/.test(navigator.userAgent)&&/Mobile\/\w+/.test(navigator.userAgent),Ve=Ue||/Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(navigator.userAgent),We=Ue||/Mac/.test(navigator.platform),Xe=/win/i.test(navigator.platform),Ye=Oe&&navigator.userAgent.match(/Version\/(\d*\.\d*)/);Ye&&(Ye=Number(Ye[1])),Ye&&Ye>=15&&(Oe=!1,Le=!0);var Ze=We&&(Me||Oe&&(null==Ye||12.11>Ye)),$e=Ee||Ke&&!He,_e=!1,af=!1,bf=a.Pos=function(a,b){return this instanceof bf?(this.line=a,void(this.ch=b)):new bf(a,b)},cf=a.cmpPos=function(a,b){return a.line-b.line||a.ch-b.ch};U.prototype={primary:function(){return this.ranges[this.primIndex]},equals:function(a){if(a==this)return!0;if(a.primIndex!=this.primIndex||a.ranges.length!=this.ranges.length)return!1;for(var b=0;b<this.ranges.length;b++){var c=this.ranges[b],d=a.ranges[b];if(0!=cf(c.anchor,d.anchor)||0!=cf(c.head,d.head))return!1}return!0},deepCopy:function(){for(var a=[],b=0;b<this.ranges.length;b++)a[b]=new V(R(this.ranges[b].anchor),R(this.ranges[b].head));return new U(a,this.primIndex)},somethingSelected:function(){for(var a=0;a<this.ranges.length;a++)if(!this.ranges[a].empty())return!0;return!1},contains:function(a,b){b||(b=a);for(var c=0;c<this.ranges.length;c++){var d=this.ranges[c];if(cf(b,d.from())>=0&&cf(a,d.to())<=0)return c}return-1}},V.prototype={from:function(){return T(this.anchor,this.head)},to:function(){return S(this.anchor,this.head)},empty:function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch}};var df,ef={left:0,right:0,top:0,bottom:0},ff=0;a.posFromMouse=sb;var gf,hf,jf=0,kf=0,lf=null;Ke?lf=-.53:Ee?lf=15:Ne?lf=-.7:Pe&&(lf=-1/3);var mf,nf,of=null,pf=a.changeEnd=function(a){return a.text?bf(a.from.line+a.text.length-1,$d(a.text).length+(1==a.text.length?a.from.ch:0)):a.to};a.prototype={constructor:a,focus:function(){window.focus(),nb(this),kb(this)},findWordAt:function(a){return mc(this.doc,a)},setOption:function(a,b){var c=this.options,d=c[a];(c[a]!=b||"mode"==a)&&(c[a]=b,rf.hasOwnProperty(a)&&Za(this,rf[a])(this,b,d))},getOption:function(a){return this.options[a]},getDoc:function(){return this.doc},addKeyMap:function(a,b){this.state.keyMaps[b?"push":"unshift"](a)},removeKeyMap:function(a){for(var b=this.state.keyMaps,c=0;c<b.length;++c)if(b[c]==a||"string"!=typeof b[c]&&b[c].name==a)return b.splice(c,1),!0},addOverlay:$a(function(b,c){var d=b.token?b:a.getMode(this.options,b);if(d.startState)throw new Error("Overlays may not be stateful.");this.state.overlays.push({mode:d,modeSpec:b,opaque:c&&c.opaque}),this.state.modeGen++,cb(this)}),removeOverlay:$a(function(a){for(var b=this.state.overlays,c=0;c<b.length;++c){var d=b[c].modeSpec;if(d==a||"string"==typeof a&&d.name==a)return b.splice(c,1),this.state.modeGen++,void cb(this)}}),indentLine:$a(function(a,b,c){"string"!=typeof b&&"number"!=typeof b&&(b=null==b?this.options.smartIndent?"smart":"prev":b?"add":"subtract"),_(this.doc,a)&&hc(this,a,b,c)}),indentSelection:$a(function(a){for(var b=this.doc.sel.ranges,c=-1,d=0;d<b.length;d++){var e=b[d];if(e.empty())e.head.line>c&&(hc(this,e.head.line,a,!0),c=e.head.line,d==this.doc.sel.primIndex&&fc(this));else{var f=Math.max(c,e.from().line),g=e.to();c=Math.min(this.lastLine(),g.line-(g.ch?0:1))+1;for(var h=f;c>h;++h)hc(this,h,a)}}}),getTokenAt:function(a,b){var c=this.doc;a=Z(c,a);var d=va(this,a.line,b),e=this.doc.mode,f=rd(c,a.line),g=new Ff(f.text,this.options.tabSize);for("object"==typeof d&&(d.lineBefore=this.getLine(a.line-1),d.lineAfter=this.getLine(a.line+1));g.pos<a.ch&&!g.eol();){g.start=g.pos;var h=$c(e,g,d)}return{start:g.start,end:g.pos,string:g.current(),type:h||null,state:d}},getTokenTypeAt:function(a){a=Z(this.doc,a);var b,c=bd(this,rd(this.doc,a.line)),d=0,e=(c.length-1)/2,f=a.ch;if(0==f)b=c[2];else for(;;){var g=d+e>>1;if((g?c[2*g-1]:0)>=f)e=g;else{if(!(c[2*g+1]<f)){b=c[2*g+2];break}d=g+1}}var h=b?b.indexOf("cm-overlay "):-1;return 0>h?b:0==h?null:b.slice(0,h-1)},getModeAt:function(b){var c=this.doc.mode;return c.innerMode?a.innerMode(c,this.getTokenAt(b).state).mode:c},getHelper:function(a,b){return this.getHelpers(a,b)[0]},getHelpers:function(a,b){var c=[];if(!xf.hasOwnProperty(b))return xf;var d=xf[b],e=this.getModeAt(a);if("string"==typeof e[b])d[e[b]]&&c.push(d[e[b]]);else if(e[b])for(var f=0;f<e[b].length;f++){var g=d[e[b][f]];g&&c.push(g)}else e.helperType&&d[e.helperType]?c.push(d[e.helperType]):d[e.name]&&c.push(d[e.name]);for(var f=0;f<d._global.length;f++){var h=d._global[f];h.pred(e,this)&&-1==_d(c,h.val)&&c.push(h.val)}return c},getStateAfter:function(a,b){var c=this.doc;return a=Y(c,null==a?c.first+c.size-1:a),va(this,a+1,b)},cursorCoords:function(a,b){var c,d=this.doc.sel.primary();return c=null==a?d.head:"object"==typeof a?Z(this.doc,a):a?d.from():d.to(),Pa(this,c,b||"page")},charCoords:function(a,b){return Oa(this,Z(this.doc,a),b||"page")},coordsChar:function(a,b){return a=Na(this,a,b||"page"),Sa(this,a.left,a.top)},lineAtHeight:function(a,b){return a=Na(this,{top:a,left:0},b||"page").top,wd(this.doc,a+this.display.viewOffset)},heightAtLine:function(a,b){var c=!1,d=this.doc.first+this.doc.size-1;a<this.doc.first?a=this.doc.first:a>d&&(a=d,c=!0);var e=rd(this.doc,a);return Ma(this,e,{top:0,left:0},b||"page").top+(c?this.doc.height-xd(e):0)},defaultTextHeight:function(){return Ua(this.display)},defaultCharWidth:function(){return Va(this.display)},setGutterMarker:$a(function(a,b,c){return ic(this,a,"gutter",function(a){var d=a.gutterMarkers||(a.gutterMarkers={});return d[b]=c,!c&&ee(d)&&(a.gutterMarkers=null),!0})}),clearGutter:$a(function(a){var b=this,c=b.doc,d=c.first;c.iter(function(c){c.gutterMarkers&&c.gutterMarkers[a]&&(c.gutterMarkers[a]=null,db(b,d,"gutter"),ee(c.gutterMarkers)&&(c.gutterMarkers=null)),++d})}),addLineClass:$a(function(a,b,c){return ic(this,a,"class",function(a){var d="text"==b?"textClass":"background"==b?"bgClass":"wrapClass";if(a[d]){if(new RegExp("(?:^|\\s)"+c+"(?:$|\\s)").test(a[d]))return!1;a[d]+=" "+c}else a[d]=c;return!0})}),removeLineClass:$a(function(a,b,c){return ic(this,a,"class",function(a){var d="text"==b?"textClass":"background"==b?"bgClass":"wrapClass",e=a[d];if(!e)return!1;if(null==c)a[d]=null;else{var f=e.match(new RegExp("(?:^|\\s+)"+c+"(?:$|\\s+)"));if(!f)return!1;var g=f.index+f[0].length;a[d]=e.slice(0,f.index)+(f.index&&g!=e.length?" ":"")+e.slice(g)||null}return!0})}),addLineWidget:$a(function(a,b,c){return Vc(this,a,b,c)}),removeLineWidget:function(a){a.clear()},lineInfo:function(a){if("number"==typeof a){if(!_(this.doc,a))return null;var b=a;if(a=rd(this.doc,a),!a)return null}else{var b=vd(a);if(null==b)return null}return{line:b,handle:a,text:a.text,gutterMarkers:a.gutterMarkers,textClass:a.textClass,bgClass:a.bgClass,wrapClass:a.wrapClass,widgets:a.widgets}},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(a,b,c,d,e){var f=this.display;a=Pa(this,Z(this.doc,a));var g=a.bottom,h=a.left;if(b.style.position="absolute",f.sizer.appendChild(b),"over"==d)g=a.top;else if("above"==d||"near"==d){var i=Math.max(f.wrapper.clientHeight,this.doc.height),j=Math.max(f.sizer.clientWidth,f.lineSpace.clientWidth);("above"==d||a.bottom+b.offsetHeight>i)&&a.top>b.offsetHeight?g=a.top-b.offsetHeight:a.bottom+b.offsetHeight<=i&&(g=a.bottom),h+b.offsetWidth>j&&(h=j-b.offsetWidth)}b.style.top=g+"px",b.style.left=b.style.right="","right"==e?(h=f.sizer.clientWidth-b.offsetWidth,b.style.right="0px"):("left"==e?h=0:"middle"==e&&(h=(f.sizer.clientWidth-b.offsetWidth)/2),b.style.left=h+"px"),c&&cc(this,h,g,h+b.offsetWidth,g+b.offsetHeight)},triggerOnKeyDown:$a(Ib),triggerOnKeyPress:$a(Lb),triggerOnKeyUp:$a(Kb),execCommand:function(a){return Af.hasOwnProperty(a)?Af[a](this):void 0},findPosH:function(a,b,c,d){var e=1;0>b&&(e=-1,b=-b);for(var f=0,g=Z(this.doc,a);b>f&&(g=kc(this.doc,g,e,c,d),!g.hitSide);++f);return g},moveH:$a(function(a,b){var c=this;c.extendSelectionsBy(function(d){return c.display.shift||c.doc.extend||d.empty()?kc(c.doc,d.head,a,b,c.options.rtlMoveVisually):0>a?d.from():d.to()},bg)}),deleteH:$a(function(a,b){var c=this.doc.sel,d=this.doc;c.somethingSelected()?d.replaceSelection("",null,"+delete"):jc(this,function(c){var e=kc(d,c.head,a,b,!1);return 0>a?{from:e,to:c.head}:{from:c.head,to:e}})}),findPosV:function(a,b,c,d){var e=1,f=d;0>b&&(e=-1,b=-b);for(var g=0,h=Z(this.doc,a);b>g;++g){var i=Pa(this,h,"div");if(null==f?f=i.left:i.left=f,h=lc(this,i,e,c),h.hitSide)break}return h},moveV:$a(function(a,b){var c=this,d=this.doc,e=[],f=!c.display.shift&&!d.extend&&d.sel.somethingSelected();if(d.extendSelectionsBy(function(g){if(f)return 0>a?g.from():g.to();var h=Pa(c,g.head,"div");null!=g.goalColumn&&(h.left=g.goalColumn),e.push(h.left);var i=lc(c,h,a,b);return"page"==b&&g==d.sel.primary()&&ec(c,null,Oa(c,i,"div").top-h.top),i},bg),e.length)for(var g=0;g<d.sel.ranges.length;g++)d.sel.ranges[g].goalColumn=e[g]}),toggleOverwrite:function(a){(null==a||a!=this.state.overwrite)&&((this.state.overwrite=!this.state.overwrite)?ne(this.display.cursorDiv,"CodeMirror-overwrite"):me(this.display.cursorDiv,"CodeMirror-overwrite"),Xf(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return ke()==this.display.input},scrollTo:$a(function(a,b){(null!=a||null!=b)&&gc(this),null!=a&&(this.curOp.scrollLeft=a),null!=b&&(this.curOp.scrollTop=b)}),getScrollInfo:function(){var a=this.display.scroller,b=Zf;return{left:a.scrollLeft,top:a.scrollTop,height:a.scrollHeight-b,width:a.scrollWidth-b,clientHeight:a.clientHeight-b,clientWidth:a.clientWidth-b}},scrollIntoView:$a(function(a,b){if(null==a?(a={from:this.doc.sel.primary().head,to:null},null==b&&(b=this.options.cursorScrollMargin)):"number"==typeof a?a={from:bf(a,0),to:null}:null==a.from&&(a={from:a,to:null}),a.to||(a.to=a.from),a.margin=b||0,null!=a.from.line)gc(this),this.curOp.scrollToPos=a;else{var c=dc(this,Math.min(a.from.left,a.to.left),Math.min(a.from.top,a.to.top)-a.margin,Math.max(a.from.right,a.to.right),Math.max(a.from.bottom,a.to.bottom)+a.margin);this.scrollTo(c.scrollLeft,c.scrollTop)}}),setSize:$a(function(a,b){function c(a){return"number"==typeof a||/^\d+$/.test(String(a))?a+"px":a}null!=a&&(this.display.wrapper.style.width=c(a)),null!=b&&(this.display.wrapper.style.height=c(b)),this.options.lineWrapping&&Ia(this),this.curOp.forceUpdate=!0,Xf(this,"refresh",this)}),operation:function(a){return Ya(this,a)},refresh:$a(function(){var a=this.display.cachedTextHeight;cb(this),this.curOp.forceUpdate=!0,Ja(this),this.scrollTo(this.doc.scrollLeft,this.doc.scrollTop),l(this),(null==a||Math.abs(a-Ua(this.display))>.5)&&g(this),Xf(this,"refresh",this)}),swapDoc:$a(function(a){var b=this.doc;return b.cm=null,qd(this,a),Ja(this),mb(this),this.scrollTo(a.scrollLeft,a.scrollTop),Rd(this,"swapDoc",this,b),b}),getInputField:function(){return this.display.input},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Wd(a);var qf=a.defaults={},rf=a.optionHandlers={},sf=a.Init={toString:function(){return"CodeMirror.Init"}};nc("value","",function(a,b){a.setValue(b)},!0),nc("mode",null,function(a,b){a.doc.modeOption=b,c(a)},!0),nc("indentUnit",2,c,!0),nc("indentWithTabs",!1),nc("smartIndent",!0),nc("tabSize",4,function(a){d(a),Ja(a),cb(a)},!0),nc("specialChars",/[\t\u0000-\u0019\u00ad\u200b\u2028\u2029\ufeff]/g,function(a,b){a.options.specialChars=new RegExp(b.source+(b.test("	")?"":"|	"),"g"),a.refresh()},!0),nc("specialCharPlaceholder",fd,function(a){a.refresh()},!0),nc("electricChars",!0),nc("rtlMoveVisually",!Xe),nc("wholeLineUpdateBefore",!0),nc("theme","default",function(a){i(a),j(a)},!0),nc("keyMap","default",h),nc("extraKeys",null),nc("lineWrapping",!1,e,!0),nc("gutters",[],function(a){o(a.options),j(a)},!0),nc("fixedGutter",!0,function(a,b){a.display.gutters.style.left=b?v(a.display)+"px":"0",a.refresh()},!0),nc("coverGutterNextToScrollbar",!1,q,!0),nc("lineNumbers",!1,function(a){o(a.options),j(a)},!0),nc("firstLineNumber",1,j,!0),nc("lineNumberFormatter",function(a){return a},j,!0),nc("showCursorWhenSelecting",!1,oa,!0),nc("resetSelectionOnContextMenu",!0),nc("readOnly",!1,function(a,b){"nocursor"==b?(Nb(a),a.display.input.blur(),a.display.disabled=!0):(a.display.disabled=!1,b||mb(a))}),nc("disableInput",!1,function(a,b){b||mb(a)},!0),nc("dragDrop",!0),nc("cursorBlinkRate",530),nc("cursorScrollMargin",0),nc("cursorHeight",1),nc("workTime",100),nc("workDelay",100),nc("flattenSpans",!0,d,!0),nc("addModeClass",!1,d,!0),nc("pollInterval",100),nc("undoDepth",100,function(a,b){a.doc.history.undoDepth=b}),nc("historyEventDelay",1250),nc("viewportMargin",10,function(a){a.refresh()},!0),nc("maxHighlightLength",1e4,d,!0),nc("moveInputWithCursor",!0,function(a,b){b||(a.display.inputDiv.style.top=a.display.inputDiv.style.left=0)}),nc("tabindex",null,function(a,b){a.display.input.tabIndex=b||""}),nc("autofocus",null);var tf=a.modes={},uf=a.mimeModes={};a.defineMode=function(b,c){if(a.defaults.mode||"null"==b||(a.defaults.mode=b),arguments.length>2){c.dependencies=[];for(var d=2;d<arguments.length;++d)c.dependencies.push(arguments[d])}tf[b]=c},a.defineMIME=function(a,b){uf[a]=b},a.resolveMode=function(b){if("string"==typeof b&&uf.hasOwnProperty(b))b=uf[b];else if(b&&"string"==typeof b.name&&uf.hasOwnProperty(b.name)){var c=uf[b.name];"string"==typeof c&&(c={name:c}),b=be(c,b),b.name=c.name}else if("string"==typeof b&&/^[\w\-]+\/[\w\-]+\+xml$/.test(b))return a.resolveMode("application/xml");return"string"==typeof b?{name:b}:b||{name:"null"}},a.getMode=function(b,c){var c=a.resolveMode(c),d=tf[c.name];if(!d)return a.getMode(b,"text/plain");var e=d(b,c);if(vf.hasOwnProperty(c.name)){var f=vf[c.name];for(var g in f)f.hasOwnProperty(g)&&(e.hasOwnProperty(g)&&(e["_"+g]=e[g]),e[g]=f[g])}if(e.name=c.name,c.helperType&&(e.helperType=c.helperType),c.modeProps)for(var g in c.modeProps)e[g]=c.modeProps[g];return e},a.defineMode("null",function(){return{token:function(a){a.skipToEnd()},startState:function(){return{}}}}),a.defineMIME("text/plain","null");var vf=a.modeExtensions={};a.extendMode=function(a,b){var c=vf.hasOwnProperty(a)?vf[a]:vf[a]={};ce(b,c)},a.defineExtension=function(b,c){a.prototype[b]=c},a.defineDocExtension=function(a,b){Of.prototype[a]=b},a.defineOption=nc;var wf=[];a.defineInitHook=function(a){wf.push(a)};var xf=a.helpers={};a.registerHelper=function(b,c,d){xf.hasOwnProperty(b)||(xf[b]=a[b]={_global:[]}),xf[b][c]=d},a.registerGlobalHelper=function(b,c,d,e){a.registerHelper(b,c,e),xf[b]._global.push({pred:d,val:e})};var yf=a.copyState=function(a,b){if(b===!0)return b;if(a.copyState)return a.copyState(b);var c={};for(var d in b){var e=b[d];e instanceof Array&&(e=e.concat([])),c[d]=e}return c},zf=a.startState=function(a,b,c){return a.startState?a.startState(b,c):!0};a.innerMode=function(a,b){for(;a.innerMode;){var c=a.innerMode(b);if(!c||!c.mode||c.mode==a)break;b=c.state,a=c.mode}return c&&!c.mode&&(c=void 0),c||{mode:a,state:b}};var Af=a.commands={selectAll:function(a){a.setSelection(bf(a.firstLine(),0),bf(a.lastLine()),_f)},singleSelection:function(a){a.setSelection(a.getCursor("anchor"),a.getCursor("head"),_f)},killLine:function(a){jc(a,function(b){if(b.empty()){var c=rd(a.doc,b.head.line).text.length;return b.head.ch==c&&b.head.line<a.lastLine()?{from:b.head,to:bf(b.head.line+1,0)}:{from:b.head,to:bf(b.head.line,c)}}return{from:b.from(),to:b.to()}})},deleteLine:function(a){jc(a,function(b){return{from:bf(b.from().line,0),to:Z(a.doc,bf(b.to().line+1,0))}})},delLineLeft:function(a){jc(a,function(a){return{from:bf(a.from().line,0),to:a.from()}})},undo:function(a){a.undo()},redo:function(a){a.redo()},undoSelection:function(a){a.undoSelection()},redoSelection:function(a){a.redoSelection()},goDocStart:function(a){a.extendSelection(bf(a.firstLine(),0))},goDocEnd:function(a){a.extendSelection(bf(a.lastLine()))},goLineStart:function(a){a.extendSelectionsBy(function(b){return xe(a,b.head.line)},bg)},goLineStartSmart:function(a){a.extendSelectionsBy(function(b){var c=xe(a,b.head.line),d=a.getLineHandle(c.line),e=yd(d);if(!e||0==e[0].level){var f=Math.max(0,d.text.search(/\S/)),g=b.head.line==c.line&&b.head.ch<=f&&b.head.ch;return bf(c.line,g?0:f)}return c},bg)},goLineEnd:function(a){a.extendSelectionsBy(function(b){return ye(a,b.head.line)},bg)},goLineRight:function(a){a.extendSelectionsBy(function(b){var c=a.charCoords(b.head,"div").top+5;return a.coordsChar({left:a.display.lineDiv.offsetWidth+100,top:c},"div")},bg)},goLineLeft:function(a){a.extendSelectionsBy(function(b){var c=a.charCoords(b.head,"div").top+5;return a.coordsChar({left:0,top:c},"div")},bg)},goLineUp:function(a){a.moveV(-1,"line")},goLineDown:function(a){a.moveV(1,"line")},goPageUp:function(a){a.moveV(-1,"page")},goPageDown:function(a){a.moveV(1,"page")},goCharLeft:function(a){a.moveH(-1,"char")},goCharRight:function(a){a.moveH(1,"char")},goColumnLeft:function(a){a.moveH(-1,"column")},goColumnRight:function(a){a.moveH(1,"column")},goWordLeft:function(a){a.moveH(-1,"word")},goGroupRight:function(a){a.moveH(1,"group")},goGroupLeft:function(a){a.moveH(-1,"group")},goWordRight:function(a){a.moveH(1,"word")},delCharBefore:function(a){a.deleteH(-1,"char")},delCharAfter:function(a){a.deleteH(1,"char")},delWordBefore:function(a){a.deleteH(-1,"word")},delWordAfter:function(a){a.deleteH(1,"word")},delGroupBefore:function(a){a.deleteH(-1,"group")},delGroupAfter:function(a){a.deleteH(1,"group")},indentAuto:function(a){a.indentSelection("smart")},indentMore:function(a){a.indentSelection("add")},indentLess:function(a){a.indentSelection("subtract")},insertTab:function(a){a.replaceSelection("	")},insertSoftTab:function(a){for(var b=[],c=a.listSelections(),d=a.options.tabSize,e=0;e<c.length;e++){var f=c[e].from(),g=cg(a.getLine(f.line),f.ch,d);b.push(new Array(d-g%d+1).join(" "))}a.replaceSelections(b)},defaultTab:function(a){a.somethingSelected()?a.indentSelection("add"):a.execCommand("insertTab")},transposeChars:function(a){Ya(a,function(){for(var b=a.listSelections(),c=0;c<b.length;c++){var d=b[c].head,e=rd(a.doc,d.line).text;d.ch>0&&d.ch<e.length-1&&a.replaceRange(e.charAt(d.ch)+e.charAt(d.ch-1),bf(d.line,d.ch-1),bf(d.line,d.ch+1))}})},newlineAndIndent:function(a){Ya(a,function(){for(var b=a.listSelections().length,c=0;b>c;c++){var d=a.listSelections()[c];a.replaceRange("\n",d.anchor,d.head,"+input"),a.indentLine(d.from().line+1,null,!0),fc(a)}})},toggleOverwrite:function(a){a.toggleOverwrite()}},Bf=a.keyMap={};Bf.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Bf.pcDefault={"Ctrl-A":"selectAll","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Bf.macDefault={"Cmd-A":"selectAll","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineStart","Cmd-Right":"goLineEnd","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delLineLeft","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection",fallthrough:["basic","emacsy"]},Bf.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars"},Bf["default"]=We?Bf.macDefault:Bf.pcDefault;var Cf=a.lookupKey=function(a,b,c){function d(b){b=oc(b);var e=b[a];if(e===!1)return"stop";if(null!=e&&c(e))return!0;if(b.nofallthrough)return"stop";var f=b.fallthrough;if(null==f)return!1;if("[object Array]"!=Object.prototype.toString.call(f))return d(f);for(var g=0;g<f.length;++g){var h=d(f[g]);if(h)return h}return!1}for(var e=0;e<b.length;++e){var f=d(b[e]);if(f)return"stop"!=f}},Df=a.isModifierKey=function(a){var b=qg[a.keyCode];return"Ctrl"==b||"Alt"==b||"Shift"==b||"Mod"==b},Ef=a.keyName=function(a,b){if(Oe&&34==a.keyCode&&a["char"])return!1;var c=qg[a.keyCode];return null==c||a.altGraphKey?!1:(a.altKey&&(c="Alt-"+c),(Ze?a.metaKey:a.ctrlKey)&&(c="Ctrl-"+c),(Ze?a.ctrlKey:a.metaKey)&&(c="Cmd-"+c),!b&&a.shiftKey&&(c="Shift-"+c),c)};a.fromTextArea=function(b,c,d,e){function f(){b.value=l.getValue()}if(c||(c={}),c.value=b.value,!c.tabindex&&b.tabindex&&(c.tabindex=b.tabindex),!c.placeholder&&b.placeholder&&(c.placeholder=b.placeholder),null==c.autofocus){var g=ke();c.autofocus=g==b||null!=b.getAttribute("autofocus")&&g==document.body}if(b.form&&(Vf(b.form,"submit",f),!c.leaveSubmitMethodAlone)){var h=b.form,i=h.submit;try{var j=h.submit=function(){f(),h.submit=i,h.submit(),h.submit=j}}catch(k){}}b.style.display="none";var l=a(function(a){b.parentNode.insertBefore(a,b.nextSibling)},c,d,e);return l.save=f,l.getTextArea=function(){return b},l.toTextArea=function(){f(),b.parentNode.removeChild(l.getWrapperElement()),b.style.display="",b.form&&(Wf(b.form,"submit",f),"function"==typeof b.form.submit&&(b.form.submit=i))},l};var Ff=a.StringStream=function(a,b,c,d){this.pos=this.start=0,this.string=a,this.tabSize=b||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0};Ff.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos==this.lineStart},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){return this.pos<this.string.length?this.string.charAt(this.pos++)||null:null},eat:function(a){var b=this.string.charAt(this.pos);if("string"==typeof a)var c=b==a;else var c=b&&(a.test?a.test(b):a(b));return c?(++this.pos,b):void 0},eatWhile:function(a){for(var b=this.pos;this.eat(a););return this.pos>b},eatSpace:function(){for(var a=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>a},skipToEnd:function(){this.pos=this.string.length},skipTo:function(a){var b=this.string.indexOf(a,this.pos);return b>-1?(this.pos=b,!0):void 0},backUp:function(a){this.pos-=a},column:function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=cg(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?cg(this.string,this.lineStart,this.tabSize):0)},indentation:function(){return cg(this.string,null,this.tabSize)-(this.lineStart?cg(this.string,this.lineStart,this.tabSize):0)},match:function(a,b,c){if("string"!=typeof a){var d=this.string.slice(this.pos).match(a);return d&&d.index>0?null:(d&&b!==!1&&(this.pos+=d[0].length),d)}var e=function(a){return c?a.toLowerCase():a},f=this.string.substr(this.pos,a.length);return e(f)==e(a)?(b!==!1&&(this.pos+=a.length),!0):void 0},current:function(){return this.string.slice(this.start,this.pos)},hideFirstChars:function(a,b){this.lineStart+=a;try{return b()}finally{this.lineStart-=a}}};var Gf=a.TextMarker=function(a,b){this.lines=[],this.type=b,this.doc=a};Wd(Gf),Gf.prototype.clear=function(){if(!this.explicitlyCleared){var a=this.doc.cm,b=a&&!a.curOp;if(b&&Wa(a),Vd(this,"clear")){var c=this.find();c&&Rd(this,"clear",c.from,c.to)}for(var d=null,e=null,f=0;f<this.lines.length;++f){var g=this.lines[f],h=vc(g.markedSpans,this);a&&!this.collapsed?db(a,vd(g),"text"):a&&(null!=h.to&&(e=vd(g)),null!=h.from&&(d=vd(g))),g.markedSpans=wc(g.markedSpans,h),null==h.from&&this.collapsed&&!Rc(this.doc,g)&&a&&ud(g,Ua(a.display))}if(a&&this.collapsed&&!a.options.lineWrapping)for(var f=0;f<this.lines.length;++f){var i=Nc(this.lines[f]),j=m(i);j>a.display.maxLineLength&&(a.display.maxLine=i,a.display.maxLineLength=j,a.display.maxLineChanged=!0)}null!=d&&a&&this.collapsed&&cb(a,d,e+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,a&&la(a.doc)),a&&Rd(a,"markerCleared",a,this),b&&Xa(a),this.parent&&this.parent.clear()}},Gf.prototype.find=function(a,b){null==a&&"bookmark"==this.type&&(a=1);for(var c,d,e=0;e<this.lines.length;++e){var f=this.lines[e],g=vc(f.markedSpans,this);if(null!=g.from&&(c=bf(b?f:vd(f),g.from),-1==a))return c;if(null!=g.to&&(d=bf(b?f:vd(f),g.to),1==a))return d}return c&&{from:c,to:d}},Gf.prototype.changed=function(){var a=this.find(-1,!0),b=this,c=this.doc.cm;a&&c&&Ya(c,function(){var d=a.line,e=vd(a.line),f=Da(c,e);if(f&&(Ha(f),c.curOp.selectionChanged=c.curOp.forceUpdate=!0),c.curOp.updateMaxLine=!0,!Rc(b.doc,d)&&null!=b.height){var g=b.height;b.height=null;var h=Uc(b)-g;h&&ud(d,d.height+h)}})},Gf.prototype.attachLine=function(a){if(!this.lines.length&&this.doc.cm){var b=this.doc.cm.curOp;b.maybeHiddenMarkers&&-1!=_d(b.maybeHiddenMarkers,this)||(b.maybeUnhiddenMarkers||(b.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(a)},Gf.prototype.detachLine=function(a){if(this.lines.splice(_d(this.lines,a),1),!this.lines.length&&this.doc.cm){var b=this.doc.cm.curOp;(b.maybeHiddenMarkers||(b.maybeHiddenMarkers=[])).push(this)}};var Hf=0,If=a.SharedTextMarker=function(a,b){this.markers=a,this.primary=b;for(var c=0;c<a.length;++c)a[c].parent=this};Wd(If),If.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var a=0;a<this.markers.length;++a)this.markers[a].clear();Rd(this,"clear")}},If.prototype.find=function(a,b){return this.primary.find(a,b)};var Jf=a.LineWidget=function(a,b,c){if(c)for(var d in c)c.hasOwnProperty(d)&&(this[d]=c[d]);this.cm=a,this.node=b};Wd(Jf),Jf.prototype.clear=function(){var a=this.cm,b=this.line.widgets,c=this.line,d=vd(c);if(null!=d&&b){for(var e=0;e<b.length;++e)b[e]==this&&b.splice(e--,1);b.length||(c.widgets=null);var f=Uc(this);Ya(a,function(){Tc(a,c,-f),db(a,d,"widget"),ud(c,Math.max(0,c.height-f))})}},Jf.prototype.changed=function(){var a=this.height,b=this.cm,c=this.line;this.height=null;var d=Uc(this)-a;d&&Ya(b,function(){b.curOp.forceUpdate=!0,Tc(b,c,d),ud(c,c.height+d)})};var Kf=a.Line=function(a,b,c){this.text=a,Fc(this,b),this.height=c?c(this):1};Wd(Kf),Kf.prototype.lineNo=function(){return vd(this)};var Lf={},Mf={};nd.prototype={chunkSize:function(){return this.lines.length},removeInner:function(a,b){for(var c=a,d=a+b;d>c;++c){var e=this.lines[c];this.height-=e.height,Xc(e),Rd(e,"delete")}this.lines.splice(a,b)},collapse:function(a){a.push.apply(a,this.lines)},insertInner:function(a,b,c){this.height+=c,this.lines=this.lines.slice(0,a).concat(b).concat(this.lines.slice(a));for(var d=0;d<b.length;++d)b[d].parent=this},iterN:function(a,b,c){for(var d=a+b;d>a;++a)if(c(this.lines[a]))return!0}},od.prototype={chunkSize:function(){return this.size},removeInner:function(a,b){this.size-=b;for(var c=0;c<this.children.length;++c){var d=this.children[c],e=d.chunkSize();if(e>a){var f=Math.min(b,e-a),g=d.height;if(d.removeInner(a,f),this.height-=g-d.height,e==f&&(this.children.splice(c--,1),d.parent=null),0==(b-=f))break;a=0}else a-=e}if(this.size-b<25&&(this.children.length>1||!(this.children[0]instanceof nd))){
var h=[];this.collapse(h),this.children=[new nd(h)],this.children[0].parent=this}},collapse:function(a){for(var b=0;b<this.children.length;++b)this.children[b].collapse(a)},insertInner:function(a,b,c){this.size+=b.length,this.height+=c;for(var d=0;d<this.children.length;++d){var e=this.children[d],f=e.chunkSize();if(f>=a){if(e.insertInner(a,b,c),e.lines&&e.lines.length>50){for(;e.lines.length>50;){var g=e.lines.splice(e.lines.length-25,25),h=new nd(g);e.height-=h.height,this.children.splice(d+1,0,h),h.parent=this}this.maybeSpill()}break}a-=f}},maybeSpill:function(){if(!(this.children.length<=10)){var a=this;do{var b=a.children.splice(a.children.length-5,5),c=new od(b);if(a.parent){a.size-=c.size,a.height-=c.height;var d=_d(a.parent.children,a);a.parent.children.splice(d+1,0,c)}else{var e=new od(a.children);e.parent=a,a.children=[e,c],a=e}c.parent=a.parent}while(a.children.length>10);a.parent.maybeSpill()}},iterN:function(a,b,c){for(var d=0;d<this.children.length;++d){var e=this.children[d],f=e.chunkSize();if(f>a){var g=Math.min(b,f-a);if(e.iterN(a,g,c))return!0;if(0==(b-=g))break;a=0}else a-=f}}};var Nf=0,Of=a.Doc=function(a,b,c){if(!(this instanceof Of))return new Of(a,b,c);null==c&&(c=0),od.call(this,[new nd([new Kf("",null)])]),this.first=c,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.frontier=c;var d=bf(c,0);this.sel=X(d),this.history=new zd(null),this.id=++Nf,this.modeOption=b,"string"==typeof a&&(a=ng(a)),md(this,{from:d,to:d,text:a}),ia(this,X(d),_f)};Of.prototype=be(od.prototype,{constructor:Of,iter:function(a,b,c){c?this.iterN(a-this.first,b-a,c):this.iterN(this.first,this.first+this.size,a)},insert:function(a,b){for(var c=0,d=0;d<b.length;++d)c+=b[d].height;this.insertInner(a-this.first,b,c)},remove:function(a,b){this.removeInner(a-this.first,b)},getValue:function(a){var b=td(this,this.first,this.first+this.size);return a===!1?b:b.join(a||"\n")},setValue:_a(function(a,b){var c=bf(this.first,0),d=this.first+this.size-1;Vb(this,{from:c,to:bf(d,rd(this,d).text.length),text:ng(a),origin:b||"setValue"},!0),ia(this,X(c))}),replaceRange:function(a,b,c,d){b=Z(this,b),c=c?Z(this,c):b,_b(this,a,b,c,d)},getRange:function(a,b,c){var d=sd(this,Z(this,a),Z(this,b));return c===!1?d:d.join(c||"\n")},getLine:function(a){var b=this.getLineHandle(a);return b&&b.text},getLineHandle:function(a){return _(this,a)?rd(this,a):void 0},getLineNumber:function(a){return vd(a)},getLineHandleVisualStart:function(a){return"number"==typeof a&&(a=rd(this,a)),Nc(a)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(a){return Z(this,a)},getCursor:function(a){var b,c=this.sel.primary();return b=null==a||"head"==a?c.head:"anchor"==a?c.anchor:"end"==a||"to"==a||a===!1?c.to():c.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:_a(function(a,b,c){fa(this,Z(this,"number"==typeof a?bf(a,b||0):a),null,c)}),setSelection:_a(function(a,b,c){fa(this,Z(this,a),Z(this,b||a),c)}),extendSelection:_a(function(a,b,c){ca(this,Z(this,a),b&&Z(this,b),c)}),extendSelections:_a(function(a,b){da(this,aa(this,a,b))}),extendSelectionsBy:_a(function(a,b){da(this,ae(this.sel.ranges,a),b)}),setSelections:_a(function(a,b,c){if(a.length){for(var d=0,e=[];d<a.length;d++)e[d]=new V(Z(this,a[d].anchor),Z(this,a[d].head));null==b&&(b=Math.min(a.length-1,this.sel.primIndex)),ia(this,W(e,b),c)}}),addSelection:_a(function(a,b,c){var d=this.sel.ranges.slice(0);d.push(new V(Z(this,a),Z(this,b||a))),ia(this,W(d,d.length-1),c)}),getSelection:function(a){for(var b,c=this.sel.ranges,d=0;d<c.length;d++){var e=sd(this,c[d].from(),c[d].to());b=b?b.concat(e):e}return a===!1?b:b.join(a||"\n")},getSelections:function(a){for(var b=[],c=this.sel.ranges,d=0;d<c.length;d++){var e=sd(this,c[d].from(),c[d].to());a!==!1&&(e=e.join(a||"\n")),b[d]=e}return b},replaceSelection:_a(function(a,b,c){for(var d=[],e=0;e<this.sel.ranges.length;e++)d[e]=a;this.replaceSelections(d,b,c||"+input")}),replaceSelections:function(a,b,c){for(var d=[],e=this.sel,f=0;f<e.ranges.length;f++){var g=e.ranges[f];d[f]={from:g.from(),to:g.to(),text:ng(a[f]),origin:c}}for(var h=b&&"end"!=b&&Tb(this,d,b),f=d.length-1;f>=0;f--)Vb(this,d[f]);h?ha(this,h):this.cm&&fc(this.cm)},undo:_a(function(){Xb(this,"undo")}),redo:_a(function(){Xb(this,"redo")}),undoSelection:_a(function(){Xb(this,"undo",!0)}),redoSelection:_a(function(){Xb(this,"redo",!0)}),setExtending:function(a){this.extend=a},getExtending:function(){return this.extend},historySize:function(){for(var a=this.history,b=0,c=0,d=0;d<a.done.length;d++)a.done[d].ranges||++b;for(var d=0;d<a.undone.length;d++)a.undone[d].ranges||++c;return{undo:b,redo:c}},clearHistory:function(){this.history=new zd(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(a){return a&&(this.history.lastOp=this.history.lastOrigin=null),this.history.generation},isClean:function(a){return this.history.generation==(a||this.cleanGeneration)},getHistory:function(){return{done:Kd(this.history.done),undone:Kd(this.history.undone)}},setHistory:function(a){var b=this.history=new zd(this.history.maxGeneration);b.done=Kd(a.done.slice(0),null,!0),b.undone=Kd(a.undone.slice(0),null,!0)},markText:function(a,b,c){return pc(this,Z(this,a),Z(this,b),c,"range")},setBookmark:function(a,b){var c={replacedWith:b&&(null==b.nodeType?b.widget:b),insertLeft:b&&b.insertLeft,clearWhenEmpty:!1,shared:b&&b.shared};return a=Z(this,a),pc(this,a,a,c,"bookmark")},findMarksAt:function(a){a=Z(this,a);var b=[],c=rd(this,a.line).markedSpans;if(c)for(var d=0;d<c.length;++d){var e=c[d];(null==e.from||e.from<=a.ch)&&(null==e.to||e.to>=a.ch)&&b.push(e.marker.parent||e.marker)}return b},findMarks:function(a,b,c){a=Z(this,a),b=Z(this,b);var d=[],e=a.line;return this.iter(a.line,b.line+1,function(f){var g=f.markedSpans;if(g)for(var h=0;h<g.length;h++){var i=g[h];e==a.line&&a.ch>i.to||null==i.from&&e!=a.line||e==b.line&&i.from>b.ch||c&&!c(i.marker)||d.push(i.marker.parent||i.marker)}++e}),d},getAllMarks:function(){var a=[];return this.iter(function(b){var c=b.markedSpans;if(c)for(var d=0;d<c.length;++d)null!=c[d].from&&a.push(c[d].marker)}),a},posFromIndex:function(a){var b,c=this.first;return this.iter(function(d){var e=d.text.length+1;return e>a?(b=a,!0):(a-=e,void++c)}),Z(this,bf(c,b))},indexFromPos:function(a){a=Z(this,a);var b=a.ch;return a.line<this.first||a.ch<0?0:(this.iter(this.first,a.line,function(a){b+=a.text.length+1}),b)},copy:function(a){var b=new Of(td(this,this.first,this.first+this.size),this.modeOption,this.first);return b.scrollTop=this.scrollTop,b.scrollLeft=this.scrollLeft,b.sel=this.sel,b.extend=!1,a&&(b.history.undoDepth=this.history.undoDepth,b.setHistory(this.getHistory())),b},linkedDoc:function(a){a||(a={});var b=this.first,c=this.first+this.size;null!=a.from&&a.from>b&&(b=a.from),null!=a.to&&a.to<c&&(c=a.to);var d=new Of(td(this,b,c),a.mode||this.modeOption,b);return a.sharedHist&&(d.history=this.history),(this.linked||(this.linked=[])).push({doc:d,sharedHist:a.sharedHist}),d.linked=[{doc:this,isParent:!0,sharedHist:a.sharedHist}],sc(d,rc(this)),d},unlinkDoc:function(b){if(b instanceof a&&(b=b.doc),this.linked)for(var c=0;c<this.linked.length;++c){var d=this.linked[c];if(d.doc==b){this.linked.splice(c,1),b.unlinkDoc(this),tc(rc(this));break}}if(b.history==this.history){var e=[b.id];pd(b,function(a){e.push(a.id)},!0),b.history=new zd(null),b.history.done=Kd(this.history.done,e),b.history.undone=Kd(this.history.undone,e)}},iterLinkedDocs:function(a){pd(this,a)},getMode:function(){return this.mode},getEditor:function(){return this.cm}}),Of.prototype.eachLine=Of.prototype.iter;var Pf="iter insert remove copy getEditor".split(" ");for(var Qf in Of.prototype)Of.prototype.hasOwnProperty(Qf)&&_d(Pf,Qf)<0&&(a.prototype[Qf]=function(a){return function(){return a.apply(this.doc,arguments)}}(Of.prototype[Qf]));Wd(Of);var Rf,Sf=a.e_preventDefault=function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},Tf=a.e_stopPropagation=function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},Uf=a.e_stop=function(a){Sf(a),Tf(a)},Vf=a.on=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,!1);else if(a.attachEvent)a.attachEvent("on"+b,c);else{var d=a._handlers||(a._handlers={}),e=d[b]||(d[b]=[]);e.push(c)}},Wf=a.off=function(a,b,c){if(a.removeEventListener)a.removeEventListener(b,c,!1);else if(a.detachEvent)a.detachEvent("on"+b,c);else{var d=a._handlers&&a._handlers[b];if(!d)return;for(var e=0;e<d.length;++e)if(d[e]==c){d.splice(e,1);break}}},Xf=a.signal=function(a,b){var c=a._handlers&&a._handlers[b];if(c)for(var d=Array.prototype.slice.call(arguments,2),e=0;e<c.length;++e)c[e].apply(null,d)},Yf=0,Zf=30,$f=a.Pass={toString:function(){return"CodeMirror.Pass"}},_f={scroll:!1},ag={origin:"*mouse"},bg={origin:"+move"};Xd.prototype.set=function(a,b){clearTimeout(this.id),this.id=setTimeout(b,a)};var cg=a.countColumn=function(a,b,c,d,e){null==b&&(b=a.search(/[^\s\u00a0]/),-1==b&&(b=a.length));for(var f=d||0,g=e||0;;){var h=a.indexOf("	",f);if(0>h||h>=b)return g+(b-f);g+=h-f,g+=c-g%c,f=h+1}},dg=[""],eg=function(a){a.select()};Ue?eg=function(a){a.selectionStart=0,a.selectionEnd=a.value.length}:Ke&&(eg=function(a){try{a.select()}catch(b){}}),[].indexOf&&(_d=function(a,b){return a.indexOf(b)}),[].map&&(ae=function(a,b){return a.map(b)});var fg,gg=/[\u00df\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,hg=a.isWordChar=function(a){return/\w/.test(a)||a>""&&(a.toUpperCase()!=a.toLowerCase()||gg.test(a))},ig=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;fg=document.createRange?function(a,b,c){var d=document.createRange();return d.setEnd(a,c),d.setStart(a,b),d}:function(a,b,c){var d=document.body.createTextRange();return d.moveToElementText(a.parentNode),d.collapse(!0),d.moveEnd("character",c),d.moveStart("character",b),d},Fe&&(ke=function(){try{return document.activeElement}catch(a){return document.body}});var jg,kg,lg,mg=function(){if(He)return!1;var a=ge("div");return"draggable"in a||"dragDrop"in a}(),ng=a.splitLines=3!="\n\nb".split(/\n/).length?function(a){for(var b=0,c=[],d=a.length;d>=b;){var e=a.indexOf("\n",b);-1==e&&(e=a.length);var f=a.slice(b,"\r"==a.charAt(e-1)?e-1:e),g=f.indexOf("\r");-1!=g?(c.push(f.slice(0,g)),b+=g+1):(c.push(f),b=e+1)}return c}:function(a){return a.split(/\r\n?|\n/)},og=window.getSelection?function(a){try{return a.selectionStart!=a.selectionEnd}catch(b){return!1}}:function(a){try{var b=a.ownerDocument.selection.createRange()}catch(c){}return b&&b.parentElement()==a?0!=b.compareEndPoints("StartToEnd",b):!1},pg=function(){var a=ge("div");return"oncopy"in a?!0:(a.setAttribute("oncopy","return;"),"function"==typeof a.oncopy)}(),qg={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",107:"=",109:"-",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"};a.keyNames=qg,function(){for(var a=0;10>a;a++)qg[a+48]=qg[a+96]=String(a);for(var a=65;90>=a;a++)qg[a]=String.fromCharCode(a);for(var a=1;12>=a;a++)qg[a+111]=qg[a+63235]="F"+a}();var rg,sg=function(){function a(a){return 247>=a?c.charAt(a):a>=1424&&1524>=a?"R":a>=1536&&1773>=a?d.charAt(a-1536):a>=1774&&2220>=a?"r":a>=8192&&8203>=a?"w":8204==a?"b":"L"}function b(a,b,c){this.level=a,this.from=b,this.to=c}var c="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",d="rrrrrrrrrrrr,rNNmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmrrrrrrrnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmNmmmm",e=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,f=/[stwN]/,g=/[LRr]/,h=/[Lb1n]/,i=/[1n]/,j="L";return function(c){if(!e.test(c))return!1;for(var d,k=c.length,l=[],m=0;k>m;++m)l.push(d=a(c.charCodeAt(m)));for(var m=0,n=j;k>m;++m){var d=l[m];"m"==d?l[m]=n:n=d}for(var m=0,o=j;k>m;++m){var d=l[m];"1"==d&&"r"==o?l[m]="n":g.test(d)&&(o=d,"r"==d&&(l[m]="R"))}for(var m=1,n=l[0];k-1>m;++m){var d=l[m];"+"==d&&"1"==n&&"1"==l[m+1]?l[m]="1":","!=d||n!=l[m+1]||"1"!=n&&"n"!=n||(l[m]=n),n=d}for(var m=0;k>m;++m){var d=l[m];if(","==d)l[m]="N";else if("%"==d){for(var p=m+1;k>p&&"%"==l[p];++p);for(var q=m&&"!"==l[m-1]||k>p&&"1"==l[p]?"1":"N",r=m;p>r;++r)l[r]=q;m=p-1}}for(var m=0,o=j;k>m;++m){var d=l[m];"L"==o&&"1"==d?l[m]="L":g.test(d)&&(o=d)}for(var m=0;k>m;++m)if(f.test(l[m])){for(var p=m+1;k>p&&f.test(l[p]);++p);for(var s="L"==(m?l[m-1]:j),t="L"==(k>p?l[p]:j),q=s||t?"L":"R",r=m;p>r;++r)l[r]=q;m=p-1}for(var u,v=[],m=0;k>m;)if(h.test(l[m])){var w=m;for(++m;k>m&&h.test(l[m]);++m);v.push(new b(0,w,m))}else{var x=m,y=v.length;for(++m;k>m&&"L"!=l[m];++m);for(var r=x;m>r;)if(i.test(l[r])){r>x&&v.splice(y,0,new b(1,x,r));var z=r;for(++r;m>r&&i.test(l[r]);++r);v.splice(y,0,new b(2,z,r)),x=r}else++r;m>x&&v.splice(y,0,new b(1,x,m))}return 1==v[0].level&&(u=c.match(/^\s+/))&&(v[0].from=u[0].length,v.unshift(new b(0,0,u[0].length))),1==$d(v).level&&(u=c.match(/\s+$/))&&($d(v).to-=u[0].length,v.push(new b(0,k-u[0].length,k))),v[0].level!=$d(v).level&&v.push(new b(v[0].level,k,k)),v}}();return a.version="4.0.4",a}()}),define("rangy/rangy-core.js",[],function(a,b,c){"use strict";var d=function(a){function b(a,b){var c=typeof a[b];return c==t||!(c!=s||!a[b])||"unknown"==c}function c(a,b){return!(typeof a[b]!=s||!a[b])}function d(a,b){return typeof a[b]!=u}function e(a){return function(b,c){for(var d=c.length;d--;)if(!a(b,c[d]))return!1;return!0}}function f(a){return a&&z(a,y)&&B(a,x)}function g(a){return c(a,"body")?a.body:a.getElementsByTagName("body")[0]}function h(a){c(window,"console")&&b(window.console,"log")&&window.console.log(a)}function i(a,b){b?window.alert(a):h(a)}function j(a){D.initialized=!0,D.supported=!1,i("Rangy is not supported on this page in your browser. Reason: "+a,D.config.alertOnFail)}function k(a){i("Rangy warning: "+a,D.config.alertOnWarn)}function l(a){return a.message||a.description||String(a)}function m(){if(!D.initialized){var a,c=!1,d=!1;b(document,"createRange")&&(a=document.createRange(),z(a,w)&&B(a,v)&&(c=!0));var e=g(document);if(!e||"body"!=e.nodeName.toLowerCase())return void j("No body element found");if(e&&b(e,"createTextRange")&&(a=e.createTextRange(),f(a)&&(d=!0)),!c&&!d)return void j("Neither Range nor TextRange are available");D.initialized=!0,D.features={implementsDomRange:c,implementsTextRange:d};var i,k;for(var m in C)(i=C[m])instanceof o&&i.init(i,D);for(var n=0,p=F.length;p>n;++n)try{F[n](D)}catch(q){k="Rangy init listener threw an exception. Continuing. Detail: "+l(q),h(k)}}}function n(a){a=a||window,m();for(var b=0,c=G.length;c>b;++b)G[b](a)}function o(a,b,c){this.name=a,this.dependencies=b,this.initialized=!1,this.supported=!1,this.initializer=c}function p(a,b,c,d){var e=new o(b,c,function(a){if(!a.initialized){a.initialized=!0;try{d(D,a),a.supported=!0}catch(c){var e="Module '"+b+"' failed to load: "+l(c);h(e)}}});C[b]=e}function q(){}function r(){}var s="object",t="function",u="undefined",v=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],w=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],x=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],y=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],z=e(b),A=e(c),B=e(d),C={},D={version:"1.3alpha.20140716",initialized:!1,supported:!0,util:{isHostMethod:b,isHostObject:c,isHostProperty:d,areHostMethods:z,areHostObjects:A,areHostProperties:B,isTextRange:f,getBody:g},features:{},modules:C,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};D.fail=j,D.warn=k,{}.hasOwnProperty?D.util.extend=function(a,b,c){var d,e;for(var f in b)b.hasOwnProperty(f)&&(d=a[f],e=b[f],c&&null!==d&&"object"==typeof d&&null!==e&&"object"==typeof e&&D.util.extend(d,e,!0),a[f]=e);return b.hasOwnProperty("toString")&&(a.toString=b.toString),a}:j("hasOwnProperty not supported"),function(){var a=document.createElement("div");a.appendChild(document.createElement("span"));var b,c=[].slice;try{1==c.call(a.childNodes,0)[0].nodeType&&(b=function(a){return c.call(a,0)})}catch(d){}b||(b=function(a){for(var b=[],c=0,d=a.length;d>c;++c)b[c]=a[c];return b}),D.util.toArray=b}();var E;b(document,"addEventListener")?E=function(a,b,c){a.addEventListener(b,c,!1)}:b(document,"attachEvent")?E=function(a,b,c){a.attachEvent("on"+b,c)}:j("Document does not have required addEventListener or attachEvent method"),D.util.addListener=E;var F=[];D.init=m,D.addInitListener=function(a){D.initialized?a(D):F.push(a)};var G=[];D.addCreateMissingNativeApiListener=function(a){G.push(a)},D.createMissingNativeApi=n,o.prototype={init:function(a){for(var b,c,d=this.dependencies||[],e=0,f=d.length;f>e;++e){if(c=d[e],b=C[c],!(b&&b instanceof o))throw new Error("required module '"+c+"' not found");if(b.init(),!b.supported)throw new Error("required module '"+c+"' not supported")}this.initializer(this)},fail:function(a){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+a)},warn:function(a){D.warn("Module "+this.name+": "+a)},deprecationNotice:function(a,b){D.warn("DEPRECATED: "+a+" in module "+this.name+"is deprecated. Please use "+b+" instead")},createError:function(a){return new Error("Error in Rangy "+this.name+" module: "+a)}},D.createModule=function(a){var b,c;2==arguments.length?(b=arguments[1],c=[]):(b=arguments[2],c=arguments[1]),p(!1,a,c,b)},D.createCoreModule=function(a,b,c){p(!0,a,b,c)},D.RangePrototype=q,D.rangePrototype=new q,D.selectionPrototype=new r;var H=!1,I=function(a){H||(H=!0,D.initialized||m())};return typeof window==u?void j("No window found"):typeof document==u?void j("No document found"):(b(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",I,!1),E(window,"load",I),D)}(this);d.createCoreModule("DomUtil",[],function(a,b){function c(a){var b;return typeof a.namespaceURI==D||null===(b=a.namespaceURI)||"http://www.w3.org/1999/xhtml"==b}function d(a){var b=a.parentNode;return 1==b.nodeType?b:null}function e(a){for(var b=0;a=a.previousSibling;)++b;return b}function f(a){switch(a.nodeType){case 7:case 10:return 0;case 3:case 8:return a.length;default:return a.childNodes.length}}function g(a,b){var c,d=[];for(c=a;c;c=c.parentNode)d.push(c);for(c=b;c;c=c.parentNode)if(H(d,c))return c;return null}function h(a,b,c){for(var d=c?b:b.parentNode;d;){if(d===a)return!0;d=d.parentNode}return!1}function i(a,b){return h(a,b,!0)}function j(a,b,c){for(var d,e=c?a:a.parentNode;e;){if(d=e.parentNode,d===b)return e;e=d}return null}function k(a){var b=a.nodeType;return 3==b||4==b||8==b}function l(a){if(!a)return!1;var b=a.nodeType;return 3==b||8==b}function m(a,b){var c=b.nextSibling,d=b.parentNode;return c?d.insertBefore(a,c):d.appendChild(a),a}function n(a,b,c){var d=a.cloneNode(!1);if(d.deleteData(0,b),a.deleteData(b,a.length-b),m(d,a),c)for(var f,g=0;f=c[g++];)f.node==a&&f.offset>b?(f.node=d,f.offset-=b):f.node==a.parentNode&&f.offset>e(a)&&++f.offset;return d}function o(a){if(9==a.nodeType)return a;if(typeof a.ownerDocument!=D)return a.ownerDocument;if(typeof a.document!=D)return a.document;if(a.parentNode)return o(a.parentNode);throw b.createError("getDocument: no document found for node")}function p(a){var c=o(a);if(typeof c.defaultView!=D)return c.defaultView;if(typeof c.parentWindow!=D)return c.parentWindow;throw b.createError("Cannot get a window object for node")}function q(a){if(typeof a.contentDocument!=D)return a.contentDocument;if(typeof a.contentWindow!=D)return a.contentWindow.document;throw b.createError("getIframeDocument: No Document object found for iframe element")}function r(a){if(typeof a.contentWindow!=D)return a.contentWindow;if(typeof a.contentDocument!=D)return a.contentDocument.defaultView;throw b.createError("getIframeWindow: No Window object found for iframe element")}function s(a){return a&&E.isHostMethod(a,"setTimeout")&&E.isHostObject(a,"document")}function t(a,b,c){var d;if(a?E.isHostProperty(a,"nodeType")?d=1==a.nodeType&&"iframe"==a.tagName.toLowerCase()?q(a):o(a):s(a)&&(d=a.document):d=document,!d)throw b.createError(c+"(): Parameter must be a Window object or DOM node");return d}function u(a){for(var b;b=a.parentNode;)a=b;return a}function v(a,c,d,f){var h,i,k,l,m;if(a==d)return c===f?0:f>c?-1:1;if(h=j(d,a,!0))return c<=e(h)?-1:1;if(h=j(a,d,!0))return e(h)<f?-1:1;if(i=g(a,d),!i)throw new Error("comparePoints error: nodes have no common ancestor");if(k=a===i?i:j(a,i,!0),l=d===i?i:j(d,i,!0),k===l)throw b.createError("comparePoints got to case 4 and childA and childB are the same!");for(m=i.firstChild;m;){if(m===k)return-1;if(m===l)return 1;m=m.nextSibling}}function w(a){var b;try{return b=a.parentNode,!1}catch(c){return!0}}function x(a){if(!a)return"[No node]";if(I&&w(a))return"[Broken node]";if(k(a))return'"'+a.data+'"';if(1==a.nodeType){var b=a.id?' id="'+a.id+'"':"";return"<"+a.nodeName+b+">[index:"+e(a)+",length:"+a.childNodes.length+"]["+(a.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return a.nodeName}function y(a){for(var b,c=o(a).createDocumentFragment();b=a.firstChild;)c.appendChild(b);return c}function z(a){this.root=a,this._next=a}function A(a){return new z(a)}function B(a,b){this.node=a,this.offset=b}function C(a){this.code=this[a],this.codeName=a,this.message="DOMException: "+this.codeName}var D="undefined",E=a.util;E.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method"),E.isHostMethod(document,"getElementsByTagName")||b.fail("document missing getElementsByTagName method");var F=document.createElement("div");E.areHostMethods(F,["insertBefore","appendChild","cloneNode"]||!E.areHostObjects(F,["previousSibling","nextSibling","childNodes","parentNode"]))||b.fail("Incomplete Element implementation"),E.isHostProperty(F,"innerHTML")||b.fail("Element is missing innerHTML property");var G=document.createTextNode("test");E.areHostMethods(G,["splitText","deleteData","insertData","appendData","cloneNode"]||!E.areHostObjects(F,["previousSibling","nextSibling","childNodes","parentNode"])||!E.areHostProperties(G,["data"]))||b.fail("Incomplete Text Node implementation");var H=function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1},I=!1;!function(){var b=document.createElement("b");b.innerHTML="1";var c=b.firstChild;b.innerHTML="<br>",I=w(c),a.features.crashyTextNodes=I}();var J;typeof window.getComputedStyle!=D?J=function(a,b){return p(a).getComputedStyle(a,null)[b]}:typeof document.documentElement.currentStyle!=D?J=function(a,b){return a.currentStyle[b]}:b.fail("No means of obtaining computed style properties found"),z.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a,b,c=this._current=this._next;if(this._current)if(a=c.firstChild)this._next=a;else{for(b=null;c!==this.root&&!(b=c.nextSibling);)c=c.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}},B.prototype={equals:function(a){return!!a&&this.node===a.node&&this.offset==a.offset},inspect:function(){return"[DomPosition("+x(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},C.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},C.prototype.toString=function(){return this.message},a.dom={arrayContains:H,isHtmlNamespace:c,parentElement:d,getNodeIndex:e,getNodeLength:f,getCommonAncestor:g,isAncestorOf:h,isOrIsAncestorOf:i,getClosestAncestorIn:j,isCharacterDataNode:k,isTextOrCommentNode:l,insertAfter:m,splitDataNode:n,getDocument:o,getWindow:p,getIframeWindow:r,getIframeDocument:q,getBody:E.getBody,isWindow:s,getContentDocument:t,getRootContainer:u,comparePoints:v,isBrokenNode:w,inspectNode:x,getComputedStyleProperty:J,fragmentFromNodeChildren:y,createIterator:A,DomPosition:B},a.DOMException=C}),d.createCoreModule("DomRange",["DomUtil"],function(a,b){function c(a,b){return 3!=a.nodeType&&(O(a,b.startContainer)||O(a,b.endContainer))}function d(a){return a.document||P(a.startContainer)}function e(a){return new K(a.parentNode,N(a))}function f(a){return new K(a.parentNode,N(a)+1)}function g(a,b,c){var d=11==a.nodeType?a.firstChild:a;return M(b)?c==b.length?I.insertAfter(a,b):b.parentNode.insertBefore(a,0==c?b:R(b,c)):c>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[c]),d}function h(a,b,c){if(z(a),z(b),d(b)!=d(a))throw new L("WRONG_DOCUMENT_ERR");var e=Q(a.startContainer,a.startOffset,b.endContainer,b.endOffset),f=Q(a.endContainer,a.endOffset,b.startContainer,b.startOffset);return c?0>=e&&f>=0:0>e&&f>0}function i(a){for(var b,c,e,f=d(a.range).createDocumentFragment();c=a.next();){if(b=a.isPartiallySelectedSubtree(),c=c.cloneNode(!b),b&&(e=a.getSubtreeIterator(),c.appendChild(i(e)),e.detach()),10==c.nodeType)throw new L("HIERARCHY_REQUEST_ERR");f.appendChild(c)}return f}function j(a,b,c){var d,e;c=c||{stop:!1};for(var f,g;f=a.next();)if(a.isPartiallySelectedSubtree()){if(b(f)===!1)return void(c.stop=!0);if(g=a.getSubtreeIterator(),j(g,b,c),g.detach(),c.stop)return}else for(d=I.createIterator(f);e=d.next();)if(b(e)===!1)return void(c.stop=!0)}function k(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),k(b),b.detach()):a.remove()}function l(a){for(var b,c,e=d(a.range).createDocumentFragment();b=a.next();){if(a.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),c=a.getSubtreeIterator(),b.appendChild(l(c)),c.detach()):a.remove(),10==b.nodeType)throw new L("HIERARCHY_REQUEST_ERR");e.appendChild(b)}return e}function m(a,b,c){var d,e=!(!b||!b.length),f=!!c;e&&(d=new RegExp("^("+b.join("|")+")$"));var g=[];return j(new o(a,!1),function(b){if((!e||d.test(b.nodeType))&&(!f||c(b))){var h=a.startContainer;if(b!=h||!M(h)||a.startOffset!=h.length){var i=a.endContainer;b==i&&M(i)&&0==a.endOffset||g.push(b)}}}),g}function n(a){var b="undefined"==typeof a.getName?"Range":a.getName();return"["+b+"("+I.inspectNode(a.startContainer)+":"+a.startOffset+", "+I.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function o(a,b){if(this.range=a,this.clonePartiallySelectedTextNodes=b,!a.collapsed){this.sc=a.startContainer,this.so=a.startOffset,this.ec=a.endContainer,this.eo=a.endOffset;var c=a.commonAncestorContainer;this.sc===this.ec&&M(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==c||M(this.sc)?S(this.sc,c,!0):this.sc.childNodes[this.so],this._last=this.ec!==c||M(this.ec)?S(this.ec,c,!0):this.ec.childNodes[this.eo-1])}}function p(a){return function(b,c){for(var d,e=c?b:b.parentNode;e;){if(d=e.nodeType,U(a,d))return e;e=e.parentNode}return null}}function q(a,b){if(ca(a,b))throw new L("INVALID_NODE_TYPE_ERR")}function r(a,b){if(!U(b,a.nodeType))throw new L("INVALID_NODE_TYPE_ERR")}function s(a,b){if(0>b||b>(M(a)?a.length:a.childNodes.length))throw new L("INDEX_SIZE_ERR")}function t(a,b){if(aa(a,!0)!==aa(b,!0))throw new L("WRONG_DOCUMENT_ERR")}function u(a){if(ba(a,!0))throw new L("NO_MODIFICATION_ALLOWED_ERR")}function v(a,b){if(!a)throw new L(b)}function w(a){return W&&I.isBrokenNode(a)||!U(Y,a.nodeType)&&!aa(a,!0)}function x(a,b){return b<=(M(a)?a.length:a.childNodes.length)}function y(a){return!!a.startContainer&&!!a.endContainer&&!w(a.startContainer)&&!w(a.endContainer)&&x(a.startContainer,a.startOffset)&&x(a.endContainer,a.endOffset)}function z(a){if(!y(a))throw new Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")")}function A(a,b){z(a);var c=a.startContainer,d=a.startOffset,e=a.endContainer,f=a.endOffset,g=c===e;M(e)&&f>0&&f<e.length&&R(e,f,b),M(c)&&d>0&&d<c.length&&(c=R(c,d,b),g?(f-=d,e=c):e==c.parentNode&&f>=N(c)&&f++,d=0),a.setStartAndEnd(c,d,e,f)}function B(a){a.START_TO_START=ia,a.START_TO_END=ja,a.END_TO_END=ka,a.END_TO_START=la,a.NODE_BEFORE=ma,a.NODE_AFTER=na,a.NODE_BEFORE_AND_AFTER=oa,a.NODE_INSIDE=pa}function C(a){B(a),B(a.prototype)}function D(a,b){return function(){z(this);var c,d,e=this.startContainer,g=this.startOffset,h=this.commonAncestorContainer,i=new o(this,!0);e!==h&&(c=S(e,h,!0),d=f(c),e=d.node,g=d.offset),j(i,u),i.reset();var k=a(i);return i.detach(),b(this,e,g,e,g),k}}function E(b,d){function g(a,b){return function(c){r(c,X),r(V(c),Y);var d=(a?e:f)(c);(b?h:i)(this,d.node,d.offset)}}function h(a,b,c){var e=a.endContainer,f=a.endOffset;(b!==a.startContainer||c!==a.startOffset)&&((V(b)!=V(e)||1==Q(b,c,e,f))&&(e=b,f=c),d(a,b,c,e,f))}function i(a,b,c){var e=a.startContainer,f=a.startOffset;(b!==a.endContainer||c!==a.endOffset)&&((V(b)!=V(e)||-1==Q(b,c,e,f))&&(e=b,f=c),d(a,e,f,b,c))}var j=function(){};j.prototype=a.rangePrototype,b.prototype=new j,J.extend(b.prototype,{setStart:function(a,b){q(a,!0),s(a,b),h(this,a,b)},setEnd:function(a,b){q(a,!0),s(a,b),i(this,a,b)},setStartAndEnd:function(){var a=arguments,b=a[0],c=a[1],e=b,f=c;switch(a.length){case 3:f=a[2];break;case 4:e=a[2],f=a[3]}d(this,b,c,e,f)},setBoundary:function(a,b,c){this["set"+(c?"Start":"End")](a,b)},setStartBefore:g(!0,!0),setStartAfter:g(!1,!0),setEndBefore:g(!0,!1),setEndAfter:g(!1,!1),collapse:function(a){
z(this),a?d(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):d(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){q(a,!0),d(this,a,0,a,T(a))},selectNode:function(a){q(a,!1),r(a,X);var b=e(a),c=f(a);d(this,b.node,b.offset,c.node,c.offset)},extractContents:D(l,d),deleteContents:D(k,d),canSurroundContents:function(){z(this),u(this.startContainer),u(this.endContainer);var a=new o(this,!0),b=a._first&&c(a._first,this)||a._last&&c(a._last,this);return a.detach(),!b},splitBoundaries:function(){A(this)},splitBoundariesPreservingPositions:function(a){A(this,a)},normalizeBoundaries:function(){z(this);var a=this.startContainer,b=this.startOffset,c=this.endContainer,e=this.endOffset,f=function(a){var b=a.nextSibling;b&&b.nodeType==a.nodeType&&(c=a,e=a.length,a.appendData(b.data),b.parentNode.removeChild(b))},g=function(d){var f=d.previousSibling;if(f&&f.nodeType==d.nodeType){a=d;var g=d.length;if(b=f.length,d.insertData(0,f.data),f.parentNode.removeChild(f),a==c)e+=b,c=a;else if(c==d.parentNode){var h=N(d);e==h?(c=d,e=g):e>h&&e--}}},h=!0;if(M(c))c.length==e&&f(c);else{if(e>0){var i=c.childNodes[e-1];i&&M(i)&&f(i)}h=!this.collapsed}if(h){if(M(a))0==b&&g(a);else if(b<a.childNodes.length){var j=a.childNodes[b];j&&M(j)&&g(j)}}else a=c,b=e;d(this,a,b,c,e)},collapseToPoint:function(a,b){q(a,!0),s(a,b),this.setStartAndEnd(a,b)}}),C(b)}function F(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset,a.commonAncestorContainer=a.collapsed?a.startContainer:I.getCommonAncestor(a.startContainer,a.endContainer)}function G(a,b,c,d,e){a.startContainer=b,a.startOffset=c,a.endContainer=d,a.endOffset=e,a.document=I.getDocument(b),F(a)}function H(a){this.startContainer=a,this.startOffset=0,this.endContainer=a,this.endOffset=0,this.document=a,F(this)}var I=a.dom,J=a.util,K=I.DomPosition,L=a.DOMException,M=I.isCharacterDataNode,N=I.getNodeIndex,O=I.isOrIsAncestorOf,P=I.getDocument,Q=I.comparePoints,R=I.splitDataNode,S=I.getClosestAncestorIn,T=I.getNodeLength,U=I.arrayContains,V=I.getRootContainer,W=a.features.crashyTextNodes;o.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;return a&&(this._next=a!==this._last?a.nextSibling:null,M(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so))),a},remove:function(){var a,b,c=this._current;!M(c)||c!==this.sc&&c!==this.ec?c.parentNode&&c.parentNode.removeChild(c):(a=c===this.sc?this.so:0,b=c===this.ec?this.eo:c.length,a!=b&&c.deleteData(a,b-a))},isPartiallySelectedSubtree:function(){var a=this._current;return c(a,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse(!1);else{a=new H(d(this.range));var b=this._current,c=b,e=0,f=b,g=T(b);O(b,this.sc)&&(c=this.sc,e=this.so),O(b,this.ec)&&(f=this.ec,g=this.eo),G(a,c,e,f,g)}return new o(a,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var X=[1,3,4,5,7,8,10],Y=[2,9,11],Z=[5,6,10,12],$=[1,3,4,5,7,8,10,11],_=[1,3,4,5,7,8],aa=p([9,11]),ba=p(Z),ca=p([6,10,12]),da=document.createElement("style"),ea=!1;try{da.innerHTML="<b>x</b>",ea=3==da.firstChild.nodeType}catch(fa){}a.features.htmlParsingConforms=ea;var ga=ea?function(a){var b=this.startContainer,c=P(b);if(!b)throw new L("INVALID_STATE_ERR");var d=null;return 1==b.nodeType?d=b:M(b)&&(d=I.parentElement(b)),d=null===d||"HTML"==d.nodeName&&I.isHtmlNamespace(P(d).documentElement)&&I.isHtmlNamespace(d)?c.createElement("body"):d.cloneNode(!1),d.innerHTML=a,I.fragmentFromNodeChildren(d)}:function(a){var b=d(this),c=b.createElement("body");return c.innerHTML=a,I.fragmentFromNodeChildren(c)},ha=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],ia=0,ja=1,ka=2,la=3,ma=0,na=1,oa=2,pa=3;J.extend(a.rangePrototype,{compareBoundaryPoints:function(a,b){z(this),t(this.startContainer,b.startContainer);var c,d,e,f,g=a==la||a==ia?"start":"end",h=a==ja||a==ia?"start":"end";return c=this[g+"Container"],d=this[g+"Offset"],e=b[h+"Container"],f=b[h+"Offset"],Q(c,d,e,f)},insertNode:function(a){if(z(this),r(a,$),u(this.startContainer),O(a,this.startContainer))throw new L("HIERARCHY_REQUEST_ERR");var b=g(a,this.startContainer,this.startOffset);this.setStartBefore(b)},cloneContents:function(){z(this);var a,b;if(this.collapsed)return d(this).createDocumentFragment();if(this.startContainer===this.endContainer&&M(this.startContainer))return a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=d(this).createDocumentFragment(),b.appendChild(a),b;var c=new o(this,!0);return a=i(c),c.detach(),a},canSurroundContents:function(){z(this),u(this.startContainer),u(this.endContainer);var a=new o(this,!0),b=a._first&&c(a._first,this)||a._last&&c(a._last,this);return a.detach(),!b},surroundContents:function(a){if(r(a,_),!this.canSurroundContents())throw new L("INVALID_STATE_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);g(a,this.startContainer,this.startOffset),a.appendChild(b),this.selectNode(a)},cloneRange:function(){z(this);for(var a,b=new H(d(this)),c=ha.length;c--;)a=ha[c],b[a]=this[a];return b},toString:function(){z(this);var a=this.startContainer;if(a===this.endContainer&&M(a))return 3==a.nodeType||4==a.nodeType?a.data.slice(this.startOffset,this.endOffset):"";var b=[],c=new o(this,!0);return j(c,function(a){(3==a.nodeType||4==a.nodeType)&&b.push(a.data)}),c.detach(),b.join("")},compareNode:function(a){z(this);var b=a.parentNode,c=N(a);if(!b)throw new L("NOT_FOUND_ERR");var d=this.comparePoint(b,c),e=this.comparePoint(b,c+1);return 0>d?e>0?oa:ma:e>0?na:pa},comparePoint:function(a,b){return z(this),v(a,"HIERARCHY_REQUEST_ERR"),t(a,this.startContainer),Q(a,b,this.startContainer,this.startOffset)<0?-1:Q(a,b,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:ga,toHtml:function(){z(this);var a=this.commonAncestorContainer.parentNode.cloneNode(!1);return a.appendChild(this.cloneContents()),a.innerHTML},intersectsNode:function(a,b){if(z(this),v(a,"NOT_FOUND_ERR"),P(a)!==d(this))return!1;var c=a.parentNode,e=N(a);v(c,"NOT_FOUND_ERR");var f=Q(c,e,this.endContainer,this.endOffset),g=Q(c,e+1,this.startContainer,this.startOffset);return b?0>=f&&g>=0:0>f&&g>0},isPointInRange:function(a,b){return z(this),v(a,"HIERARCHY_REQUEST_ERR"),t(a,this.startContainer),Q(a,b,this.startContainer,this.startOffset)>=0&&Q(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(a){return h(this,a,!1)},intersectsOrTouchesRange:function(a){return h(this,a,!0)},intersection:function(a){if(this.intersectsRange(a)){var b=Q(this.startContainer,this.startOffset,a.startContainer,a.startOffset),c=Q(this.endContainer,this.endOffset,a.endContainer,a.endOffset),d=this.cloneRange();return-1==b&&d.setStart(a.startContainer,a.startOffset),1==c&&d.setEnd(a.endContainer,a.endOffset),d}return null},union:function(a){if(this.intersectsOrTouchesRange(a)){var b=this.cloneRange();return-1==Q(a.startContainer,a.startOffset,this.startContainer,this.startOffset)&&b.setStart(a.startContainer,a.startOffset),1==Q(a.endContainer,a.endOffset,this.endContainer,this.endOffset)&&b.setEnd(a.endContainer,a.endOffset),b}throw new L("Ranges do not intersect")},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==pa},containsNodeContents:function(a){return this.comparePoint(a,0)>=0&&this.comparePoint(a,T(a))<=0},containsRange:function(a){var b=this.intersection(a);return null!==b&&a.equals(b)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);var c=b.getNodes([3]);if(c.length>0){b.setStart(c[0],0);var d=c.pop();return b.setEnd(d,d.length),this.containsRange(b)}return this.containsNodeContents(a)},getNodes:function(a,b){return z(this),m(this,a,b)},getDocument:function(){return d(this)},collapseBefore:function(a){this.setEndBefore(a),this.collapse(!1)},collapseAfter:function(a){this.setStartAfter(a),this.collapse(!0)},getBookmark:function(b){function c(a){var b=a.cloneContents();if(b.querySelector("text")){for(var c=b.querySelectorAll("svg"),d=0;d<c.length;d++)c[d].parentElement.removeChild(c[d]);return b.textContent.length}return a.toString().length}var e=d(this),f=a.createRange(e);b=b||I.getBody(e),f.selectNodeContents(b);var g=this.intersection(f),h=b.querySelectorAll("text").length,i=0,j=0;return g&&(f.setEnd(g.startContainer,g.startOffset),i=h?c(f):f.toString().length,j=i+(h?c(g):g.toString().length)),{start:i,end:j,containerNode:b}},moveToBookmark:function(a){var b=a.containerNode,c=0;this.setStart(b,0),this.collapse(!0);for(var d,e,f,g,h=[b],i=!1,j=!1;!j&&(d=h.pop());)if(3==d.nodeType)e=c+d.length,!i&&a.start>=c&&a.start<=e&&(this.setStart(d,a.start-c),i=!0),i&&a.end>=c&&a.end<=e&&(this.setEnd(d,a.end-c),j=!0),c=e;else if(!/^text$/i.exec(d.tagName||""))for(g=d.childNodes,f=g.length;f--;)h.push(g[f])},getName:function(){return"DomRange"},equals:function(a){return H.rangesEqual(this,a)},isValid:function(){return y(this)},inspect:function(){return n(this)},detach:function(){}}),E(H,G),J.extend(H,{rangeProperties:ha,RangeIterator:o,copyComparisonConstants:C,createPrototypeRange:E,inspect:n,getRangeDocument:d,rangesEqual:function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset}}),a.DomRange=H}),d.createCoreModule("WrappedRange",["DomRange"],function(a,b){var c,d,e=a.dom,f=a.util,g=e.DomPosition,h=a.DomRange,i=e.getBody,j=e.getContentDocument,k=e.isCharacterDataNode;if(a.features.implementsDomRange&&!function(){function d(a){for(var b,c=m.length;c--;)b=m[c],a[b]=a.nativeRange[b];a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset}function g(a,b,c,d,e){var f=a.startContainer!==b||a.startOffset!=c,g=a.endContainer!==d||a.endOffset!=e,h=!a.equals(a.nativeRange);(f||g||h)&&(a.setEnd(d,e),a.setStart(b,c))}var k,l,m=h.rangeProperties;c=function(a){if(!a)throw b.createError("WrappedRange: Range must be specified");this.nativeRange=a,d(this)},h.createPrototypeRange(c,g),k=c.prototype,k.selectNode=function(a){this.nativeRange.selectNode(a),d(this)},k.cloneContents=function(){return this.nativeRange.cloneContents()},k.surroundContents=function(a){this.nativeRange.surroundContents(a),d(this)},k.collapse=function(a){this.nativeRange.collapse(a),d(this)},k.cloneRange=function(){return new c(this.nativeRange.cloneRange())},k.refresh=function(){d(this)},k.toString=function(){return this.nativeRange.toString()};var n=document.createTextNode("test");i(document).appendChild(n);var o=document.createRange();o.setStart(n,0),o.setEnd(n,0);try{o.setStart(n,1),k.setStart=function(a,b){this.nativeRange.setStart(a,b),d(this)},k.setEnd=function(a,b){this.nativeRange.setEnd(a,b),d(this)},l=function(a){return function(b){this.nativeRange[a](b),d(this)}}}catch(p){k.setStart=function(a,b){try{this.nativeRange.setStart(a,b)}catch(c){this.nativeRange.setEnd(a,b),this.nativeRange.setStart(a,b)}d(this)},k.setEnd=function(a,b){try{this.nativeRange.setEnd(a,b)}catch(c){this.nativeRange.setStart(a,b),this.nativeRange.setEnd(a,b)}d(this)},l=function(a,b){return function(c){try{this.nativeRange[a](c)}catch(e){this.nativeRange[b](c),this.nativeRange[a](c)}d(this)}}}k.setStartBefore=l("setStartBefore","setEndBefore"),k.setStartAfter=l("setStartAfter","setEndAfter"),k.setEndBefore=l("setEndBefore","setStartBefore"),k.setEndAfter=l("setEndAfter","setStartAfter"),k.selectNodeContents=function(a){this.setStartAndEnd(a,0,e.getNodeLength(a))},o.selectNodeContents(n),o.setEnd(n,3);var q=document.createRange();q.selectNodeContents(n),q.setEnd(n,4),q.setStart(n,2),-1==o.compareBoundaryPoints(o.START_TO_END,q)&&1==o.compareBoundaryPoints(o.END_TO_START,q)?k.compareBoundaryPoints=function(a,b){return b=b.nativeRange||b,a==b.START_TO_END?a=b.END_TO_START:a==b.END_TO_START&&(a=b.START_TO_END),this.nativeRange.compareBoundaryPoints(a,b)}:k.compareBoundaryPoints=function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};var r=document.createElement("div");r.innerHTML="123";var s=r.firstChild,t=i(document);t.appendChild(r),o.setStart(s,1),o.setEnd(s,2),o.deleteContents(),"13"==s.data&&(k.deleteContents=function(){this.nativeRange.deleteContents(),d(this)},k.extractContents=function(){var a=this.nativeRange.extractContents();return d(this),a}),t.removeChild(r),t=null,f.isHostMethod(o,"createContextualFragment")&&(k.createContextualFragment=function(a){return this.nativeRange.createContextualFragment(a)}),i(document).removeChild(n),k.getName=function(){return"WrappedRange"},a.WrappedRange=c,a.createNativeRange=function(a){return a=j(a,b,"createNativeRange"),a.createRange()}}(),a.features.implementsTextRange){var l=function(a){var b=a.parentElement(),c=a.duplicate();c.collapse(!0);var d=c.parentElement();c=a.duplicate(),c.collapse(!1);var f=c.parentElement(),g=d==f?d:e.getCommonAncestor(d,f);return g==b?g:e.getCommonAncestor(b,g)},m=function(a){return 0==a.compareEndPoints("StartToEnd",a)},n=function(a,b,c,d,f){var h=a.duplicate();h.collapse(c);var i=h.parentElement();if(e.isOrIsAncestorOf(b,i)||(i=b),!i.canHaveHTML){var j=new g(i.parentNode,e.getNodeIndex(i));return{boundaryPosition:j,nodeInfo:{nodeIndex:j.offset,containerElement:j.node}}}var l=e.getDocument(i).createElement("span");l.parentNode&&l.parentNode.removeChild(l);for(var m,n,o,p,q,r=c?"StartToStart":"StartToEnd",s=f&&f.containerElement==i?f.nodeIndex:0,t=i.childNodes.length,u=t,v=u;;){if(v==t?i.appendChild(l):i.insertBefore(l,i.childNodes[v]),h.moveToElementText(l),m=h.compareEndPoints(r,a),0==m||s==u)break;if(-1==m){if(u==s+1)break;s=v}else u=u==s+1?s:v;v=Math.floor((s+u)/2),i.removeChild(l)}if(q=l.nextSibling,-1==m&&q&&k(q)){h.setEndPoint(c?"EndToStart":"EndToEnd",a);var w;if(/[\r\n]/.test(q.data)){var x=h.duplicate(),y=x.text.replace(/\r\n/g,"\r").length;for(w=x.moveStart("character",y);-1==(m=x.compareEndPoints("StartToEnd",x));)w++,x.moveStart("character",1)}else w=h.text.length;p=new g(q,w)}else n=(d||!c)&&l.previousSibling,o=(d||c)&&l.nextSibling,p=o&&k(o)?new g(o,0):n&&k(n)?new g(n,n.data.length):new g(i,e.getNodeIndex(l));return l.parentNode.removeChild(l),{boundaryPosition:p,nodeInfo:{nodeIndex:v,containerElement:i}}},o=function(a,b){var c,d,f,g,h=a.offset,j=e.getDocument(a.node),l=i(j).createTextRange(),m=k(a.node);return m?(c=a.node,d=c.parentNode):(g=a.node.childNodes,c=h<g.length?g[h]:null,d=a.node),f=j.createElement("span"),f.innerHTML="&#feff;",c?d.insertBefore(f,c):d.appendChild(f),l.moveToElementText(f),l.collapse(!b),d.removeChild(f),m&&l[b?"moveStart":"moveEnd"]("character",h),l};if(d=function(a){this.textRange=a,this.refresh()},d.prototype=new h(document),d.prototype.refresh=function(){var a,b,c,d=l(this.textRange);m(this.textRange)?b=a=n(this.textRange,d,!0,!0).boundaryPosition:(c=n(this.textRange,d,!0,!1),a=c.boundaryPosition,b=n(this.textRange,d,!1,!1,c.nodeInfo).boundaryPosition),this.setStart(a.node,a.offset),this.setEnd(b.node,b.offset)},d.prototype.getName=function(){return"WrappedTextRange"},h.copyComparisonConstants(d),d.rangeToTextRange=function(a){if(a.collapsed)return o(new g(a.startContainer,a.startOffset),!0);var b=o(new g(a.startContainer,a.startOffset),!0),c=o(new g(a.endContainer,a.endOffset),!1),d=i(h.getRangeDocument(a)).createTextRange();return d.setEndPoint("StartToStart",b),d.setEndPoint("EndToEnd",c),d},a.WrappedTextRange=d,!a.features.implementsDomRange||a.config.preferTextRange){var p=function(){return this}();"undefined"==typeof p.Range&&(p.Range=d),a.createNativeRange=function(a){return a=j(a,b,"createNativeRange"),i(a).createTextRange()},a.WrappedRange=d}}a.createRange=function(c){return c=j(c,b,"createRange"),new a.WrappedRange(a.createNativeRange(c))},a.createRangyRange=function(a){return a=j(a,b,"createRangyRange"),new h(a)},a.createIframeRange=function(c){return b.deprecationNotice("createIframeRange()","createRange(iframeEl)"),a.createRange(c)},a.createIframeRangyRange=function(c){return b.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),a.createRangyRange(c)},a.addCreateMissingNativeApiListener(function(b){var c=b.document;"undefined"==typeof c.createRange&&(c.createRange=function(){return a.createRange(c)}),c=b=null})}),d.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(a,b){function c(a){return"string"==typeof a?/^backward(s)?$/i.test(a):!!a}function d(a,c){if(a){if(C.isWindow(a))return a;if(a instanceof r)return a.win;var d=C.getContentDocument(a,b,c);return C.getWindow(d)}return window}function e(a){return d(a,"getWinSelection").getSelection()}function f(a){return d(a,"getDocSelection").document.selection}function g(a){var b=!1;return a.anchorNode&&(b=1==C.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)),b}function h(a,b,c){var d=c?"end":"start",e=c?"start":"end";a.anchorNode=b[d+"Container"],a.anchorOffset=b[d+"Offset"],a.focusNode=b[e+"Container"],a.focusOffset=b[e+"Offset"]}function i(a){var b=a.nativeSelection;a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset}function j(a){a.anchorNode=a.focusNode=null,a.anchorOffset=a.focusOffset=0,a.rangeCount=0,a.isCollapsed=!0,a._ranges.length=0}function k(b){var c;return b instanceof F?(c=a.createNativeRange(b.getDocument()),c.setEnd(b.endContainer,b.endOffset),c.setStart(b.startContainer,b.startOffset)):b instanceof G?c=b.nativeRange:J.implementsDomRange&&b instanceof C.getWindow(b.startContainer).Range&&(c=b),c}function l(a){if(!a.length||1!=a[0].nodeType)return!1;for(var b=1,c=a.length;c>b;++b)if(!C.isAncestorOf(a[0],a[b]))return!1;return!0}function m(a){var c=a.getNodes();if(!l(c))throw b.createError("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return c[0]}function n(a){return!!a&&"undefined"!=typeof a.text}function o(a,b){var c=new G(b);a._ranges=[c],h(a,c,!1),a.rangeCount=1,a.isCollapsed=c.collapsed}function p(b){if(b._ranges.length=0,"None"==b.docSelection.type)j(b);else{var c=b.docSelection.createRange();if(n(c))o(b,c);else{b.rangeCount=c.length;for(var d,e=L(c.item(0)),f=0;f<b.rangeCount;++f)d=a.createRange(e),d.selectNode(c.item(f)),b._ranges.push(d);b.isCollapsed=1==b.rangeCount&&b._ranges[0].collapsed,h(b,b._ranges[b.rangeCount-1],!1)}}}function q(a,c){for(var d=a.docSelection.createRange(),e=m(c),f=L(d.item(0)),g=M(f).createControlRange(),h=0,i=d.length;i>h;++h)g.add(d.item(h));try{g.add(e)}catch(j){throw b.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}g.select(),p(a)}function r(a,b,c){this.nativeSelection=a,this.docSelection=b,this._ranges=[],this.win=c,this.refresh()}function s(a){a.win=a.anchorNode=a.focusNode=a._ranges=null,a.rangeCount=a.anchorOffset=a.focusOffset=0,a.detached=!0}function t(a,b){for(var c,d,e=ba.length;e--;)if(c=ba[e],d=c.selection,"deleteAll"==b)s(d);else if(c.win==a)return"delete"==b?(ba.splice(e,1),!0):d;return"deleteAll"==b&&(ba.length=0),null}function u(a,c){for(var d,e=L(c[0].startContainer),f=M(e).createControlRange(),g=0,h=c.length;h>g;++g){d=m(c[g]);try{f.add(d)}catch(i){throw b.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}f.select(),p(a)}function v(a,b){if(a.win.document!=L(b))throw new H("WRONG_DOCUMENT_ERR")}function w(b){return function(c,d){var e;this.rangeCount?(e=this.getRangeAt(0),e["set"+(b?"Start":"End")](c,d)):(e=a.createRange(this.win.document),e.setStartAndEnd(c,d)),this.setSingleRange(e,this.isBackward())}}function x(a){var b=[],c=new I(a.anchorNode,a.anchorOffset),d=new I(a.focusNode,a.focusOffset),e="function"==typeof a.getName?a.getName():"Selection";if("undefined"!=typeof a.rangeCount)for(var f=0,g=a.rangeCount;g>f;++f)b[f]=F.inspect(a.getRangeAt(f));return"["+e+"(Ranges: "+b.join(", ")+")(anchor: "+c.inspect()+", focus: "+d.inspect()+"]"}a.config.checkSelectionRanges=!0;var y,z,A="boolean",B="number",C=a.dom,D=a.util,E=D.isHostMethod,F=a.DomRange,G=a.WrappedRange,H=a.DOMException,I=C.DomPosition,J=a.features,K="Control",L=C.getDocument,M=C.getBody,N=F.rangesEqual,O=E(window,"getSelection"),P=D.isHostObject(document,"selection");J.implementsWinGetSelection=O,J.implementsDocSelection=P;var Q=P&&(!O||a.config.preferTextRange);Q?(y=f,a.isSelectionValid=function(a){var b=d(a,"isSelectionValid").document,c=b.selection;return"None"!=c.type||L(c.createRange().parentElement())==b}):O?(y=e,a.isSelectionValid=function(){return!0}):b.fail("Neither document.selection or window.getSelection() detected."),a.getNativeSelection=y;var R=y(),S=a.createNativeRange(document),T=M(document),U=D.areHostProperties(R,["anchorNode","focusNode","anchorOffset","focusOffset"]);J.selectionHasAnchorAndFocus=U;var V=E(R,"extend");J.selectionHasExtend=V;var W=typeof R.rangeCount==B;J.selectionHasRangeCount=W;var X=!1,Y=!0,Z=V?function(b,c){var d=F.getRangeDocument(c),e=a.createRange(d);e.collapseToPoint(c.endContainer,c.endOffset),b.addRange(k(e)),b.extend(c.startContainer,c.startOffset)}:null;D.areHostMethods(R,["addRange","getRangeAt","removeAllRanges"])&&typeof R.rangeCount==B&&J.implementsDomRange&&!function(){var b=window.getSelection();if(b){for(var c=b.rangeCount,d=[],e=g(b),f=0;c>f;++f)d[f]=b.getRangeAt(f);for(f=0;c>f;++f)0==f&&e?Z?Z(b,d[f]):(a.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),b.addRange(d[f])):b.addRange(d[f])}}(),J.selectionSupportsMultipleRanges=X,J.collapsedNonEditableSelectionsSupported=Y;var $,_=!1;T&&E(T,"createControlRange")&&($=T.createControlRange(),D.areHostProperties($,["item","add"])&&(_=!0)),J.implementsControlRange=_,z=U?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var aa;E(R,"getRangeAt")?aa=function(a,b){try{return a.getRangeAt(b)}catch(c){return null}}:U&&(aa=function(b){var c=L(b.anchorNode),d=a.createRange(c);return d.setStartAndEnd(b.anchorNode,b.anchorOffset,b.focusNode,b.focusOffset),d.collapsed!==this.isCollapsed&&d.setStartAndEnd(b.focusNode,b.focusOffset,b.anchorNode,b.anchorOffset),d}),r.prototype=a.selectionPrototype;var ba=[],ca=function(a){if(a&&a instanceof r)return a.refresh(),a;a=d(a,"getNativeSelection");var b=t(a),c=y(a),e=P?f(a):null;return b?(b.nativeSelection=c,b.docSelection=e,b.refresh()):(b=new r(c,e,a),ba.push({win:a,selection:b})),b};a.getSelection=ca,a.getIframeSelection=function(c){return b.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),a.getSelection(C.getIframeWindow(c))};var da=r.prototype;if(!Q&&U&&D.areHostMethods(R,["removeAllRanges","addRange"])){da.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),j(this)};var ea=function(a,b){Z(a.nativeSelection,b),a.refresh()};W?da.addRange=function(b,d){if(_&&P&&this.docSelection.type==K)q(this,b);else if(c(d)&&V)ea(this,b);else{var e;if(X?e=this.rangeCount:(this.removeAllRanges(),e=0),this.nativeSelection.addRange(k(b).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==e+1){if(a.config.checkSelectionRanges){var f=aa(this.nativeSelection,this.rangeCount-1);f&&!N(f,b)&&(b=new G(f))}this._ranges[this.rangeCount-1]=b,h(this,b,ha(this.nativeSelection)),this.isCollapsed=z(this)}else this.refresh()}}:da.addRange=function(a,b){c(b)&&V?ea(this,a):(this.nativeSelection.addRange(k(a)),this.refresh())},da.setRanges=function(a){if(_&&a.length>1)u(this,a);else{this.removeAllRanges();for(var b=0,c=a.length;c>b;++b)this.addRange(a[b])}}}else{if(!(E(R,"empty")&&E(S,"select")&&_&&Q))return b.fail("No means of selecting a Range or TextRange was found"),!1;da.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var a;if(this.anchorNode)a=L(this.anchorNode);else if(this.docSelection.type==K){var b=this.docSelection.createRange();b.length&&(a=L(b.item(0)))}if(a){var c=M(a).createTextRange();c.select(),this.docSelection.empty()}}}catch(d){}j(this)},da.addRange=function(b){this.docSelection.type==K?q(this,b):(a.WrappedTextRange.rangeToTextRange(b).select(),this._ranges[0]=b,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,h(this,b,!1))},da.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?u(this,a):b&&this.addRange(a[0])}}da.getRangeAt=function(a){if(0>a||a>=this.rangeCount)throw new H("INDEX_SIZE_ERR");return this._ranges[a].cloneRange()};var fa;if(Q)fa=function(b){var c;a.isSelectionValid(b.win)?c=b.docSelection.createRange():(c=M(b.win.document).createTextRange(),c.collapse(!0)),b.docSelection.type==K?p(b):n(c)?o(b,c):j(b)};else if(E(R,"getRangeAt")&&typeof R.rangeCount==B)fa=function(b){if(_&&P&&b.docSelection.type==K)p(b);else if(b._ranges.length=b.rangeCount=b.nativeSelection.rangeCount,b.rangeCount){for(var c=0,d=b.rangeCount;d>c;++c)b._ranges[c]=new a.WrappedRange(b.nativeSelection.getRangeAt(c));h(b,b._ranges[b.rangeCount-1],ha(b.nativeSelection)),b.isCollapsed=z(b)}else j(b)};else{if(!U||typeof R.isCollapsed!=A||typeof S.collapsed!=A||!J.implementsDomRange)return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;fa=function(a){var b,c=a.nativeSelection;c.anchorNode?(b=aa(c,0),a._ranges=[b],a.rangeCount=1,i(a),a.isCollapsed=z(a)):j(a)}}da.refresh=function(a){var b=a?this._ranges.slice(0):null,c=this.anchorNode,d=this.anchorOffset;if(fa(this),a){var e=b.length;if(e!=this._ranges.length)return!0;if(this.anchorNode!=c||this.anchorOffset!=d)return!0;for(;e--;)if(!N(b[e],this._ranges[e]))return!0;return!1}};var ga=function(a,b){var c=a.getAllRanges();a.removeAllRanges();for(var d=0,e=c.length;e>d;++d)N(b,c[d])||a.addRange(c[d]);a.rangeCount||j(a)};_?da.removeRange=function(a){if(this.docSelection.type==K){for(var b,c=this.docSelection.createRange(),d=m(a),e=L(c.item(0)),f=M(e).createControlRange(),g=!1,h=0,i=c.length;i>h;++h)b=c.item(h),b!==d||g?f.add(c.item(h)):g=!0;f.select(),p(this)}else ga(this,a)}:da.removeRange=function(a){ga(this,a)};var ha;!Q&&U&&J.implementsDomRange?(ha=g,da.isBackward=function(){return ha(this)}):ha=da.isBackward=function(){return!1},da.isBackwards=da.isBackward,da.toString=function(){for(var a=[],b=0,c=this.rangeCount;c>b;++b)a[b]=""+this._ranges[b];return a.join("")},da.collapse=function(b,c){v(this,b);var d=a.createRange(b);d.collapseToPoint(b,c),this.setSingleRange(d),this.isCollapsed=!0},da.collapseToStart=function(){if(!this.rangeCount)throw new H("INVALID_STATE_ERR");var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)},da.collapseToEnd=function(){if(!this.rangeCount)throw new H("INVALID_STATE_ERR");var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)},da.selectAllChildren=function(b){v(this,b);var c=a.createRange(b);c.selectNodeContents(b),this.setSingleRange(c)},da.deleteFromDocument=function(){if(_&&P&&this.docSelection.type==K){for(var a,b=this.docSelection.createRange();b.length;)a=b.item(0),b.remove(a),a.parentNode.removeChild(a);this.refresh()}else if(this.rangeCount){var c=this.getAllRanges();if(c.length){this.removeAllRanges();for(var d=0,e=c.length;e>d;++d)c[d].deleteContents();this.addRange(c[e-1])}}},da.eachRange=function(a,b){for(var c=0,d=this._ranges.length;d>c;++c)if(a(this.getRangeAt(c)))return b},da.getAllRanges=function(){var a=[];return this.eachRange(function(b){a.push(b)}),a},da.setSingleRange=function(a,b){this.removeAllRanges(),this.addRange(a,b)},da.callMethodOnEachRange=function(a,b){var c=[];return this.eachRange(function(d){c.push(d[a].apply(d,b))}),c},da.setStart=w(!0),da.setEnd=w(!1),a.rangePrototype.select=function(a){ca(this.getDocument()).setSingleRange(this,a)},da.changeEachRange=function(a){var b=[],c=this.isBackward();this.eachRange(function(c){a(c),b.push(c)}),this.removeAllRanges(),c&&1==b.length?this.addRange(b[0],"backward"):this.setRanges(b)},da.containsNode=function(a,b){return this.eachRange(function(c){return c.containsNode(a,b)},!0)},da.getBookmark=function(a){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[a])}},da.moveToBookmark=function(b){for(var c,d,e=[],f=0;c=b.rangeBookmarks[f++];)d=a.createRange(this.win),d.moveToBookmark(c),e.push(d);b.backward?this.setSingleRange(e[0],"backward"):this.setRanges(e)},da.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")},da.getName=function(){return"WrappedSelection"},da.inspect=function(){return x(this)},da.detach=function(){t(this.win,"delete"),s(this)},r.detachAll=function(){t(null,"deleteAll")},r.inspect=x,r.isDirectionBackward=c,a.Selection=r,a.selectionPrototype=da,a.addCreateMissingNativeApiListener(function(a){"undefined"==typeof a.getSelection&&(a.getSelection=function(){return ca(a)}),a=null})}),c.exports=d}),define("app/editor/Fences",["codemirror/lib/codemirror","app/document/StringUtils","jquery/jquery","exoskeleton-master/exoskeleton","autoComplete","app/document/Node","app/editor/KeyMaster","app/editor/Diagram","app/editor/KeyMaster","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint"],function(a,b,c){"use strict";var d=a("codemirror/lib/codemirror"),e=a("app/document/StringUtils"),f=a("jquery/jquery"),g=a("exoskeleton-master/exoskeleton"),h=a("autoComplete.js"),i=a("app/document/Node"),j=a("app/editor/KeyMaster"),k=a("app/editor/Diagram"),l=j.map;Node=i.Node;var m=d.prototype.focus;d.prototype.focus=function(){d.signal(this,"focus",this),m.apply(this)};var n=(a("codemirror/addon/selection/mark-selection"),a("codemirror/addon/edit/closebrackets"),a("codemirror/addon/edit/closetag"),a("codemirror/addon/mode/overlay"),a("codemirror/addon/lint/lint.js"),["javascript","java","json","typescript","clojure","coffeescript","css","less","scss","gfm","markdown","xml","haskell","html","lua","lisp","commonlisp","pascal","perl","php","php+HTML","python","cython","ruby","shell","sh","sql","sql lite","mssql","mysql","CQL","mariadb","cassandra","plsql","tiddlywiki","wiki","vb","basic","visual basic","vbscript","velocity","verilog","xquery","yaml","go","groovy","nginx","octave","c","clike","c++","cpp","objective-c","csharp","c#","squirrel","ceylon","kotlin","tex","latex","swift","scala","R","D","diff","erlang","http","jade","rst","rust","jinja2","reStructuredText","asp","jsp","erb","ejs","embeddedjs","powershell","dockerfile","jsx","react","vue","nsis","mathematica","tiki wiki","properties","ini","livescript","assembly","gas","toml","matlab","ocaml","F#","fsharp","elm","pgp","asciiarmor","spreadsheet","elixir","cmake","cypher","dart","django","dtd","xml-dtd","dylan","handlebars","idl","web-idl","yacas","mbox","vhdl","julia","haxe","hxml","fortran","protobuf"]);!function(a){var b=a.commands.delLineLeft;a.commands.delLineLeft=function(c){try{return 0==c.getCursor().ch?a.commands.delCharBefore(c):b(c)}catch(d){}}}(d);var o=function(a,b){var c=[];return n.map(function(b){0==b.toLowerCase().indexOf(a.toLowerCase())&&c.push(b)}),c.sort(),c.length<4&&n.map(function(b){b.toLowerCase().indexOf(a.toLowerCase())>0&&c.push(b)}),b&&1==c.length&&c[0]==a?[]:c},p=function(a,b){var c=this,d=a.find("input.mode").change(function(){b.attr("lang",f(this).val(),c.editor,!1)}).keydown(function(a){var b=a.which||a.keyCode;"Enter"==l[b]&&f(this).trigger("change")}).focus(function(){File.isMac&&app.touchBar&&app.touchBar.setFencesOnSetLang(!0)});return h.enable(d[0],{hintsFetcher:function(a,b){b(o(a))}}),a};
window.getCodeMirrorMode=function(a,b){if(a=a?a.toLowerCase():"",a=a.replace(/^\s*\.*lang(uage)*-/g,"").replace(/[{}]/g,""))switch(a){case"javascript":case"text/javascript":case"js":return a="javascript";case"json":return a={name:"javascript",json:!0};case"text/typescript":case"typescript":return a={name:"javascript",typescript:!0};case"clojure":return a;case"coffee":case"coffeescript":return a;case"css":case"less":return a;case"scss":return a="text/x-scss";case"gfm":case"github flavored markdown":return a="gfm";case"markdown":return a;case"xml":return a;case"haskell":return a;case"htmlmixed":case"html":return a="htmlmixed";case"lua":return a;case"lisp":case"commonlisp":case"common lisp":return a="commonlisp";case"pascal":return a;case"perl":return a;case"php+html":return"application/x-httpd-php";case"php":return"text/x-php";case"cython":return a="text/x-cython";case"python":return a="text/x-python";case"ruby":return a;case"shell":case"sh":case"bash":return a="shell";case"sql":case"sql lite":return a="text/x-sql";case"mssql":return a="text/x-mssql";case"mysql":return a="text/x-mysql";case"mariadb":return a="text/x-mariadb";case"cassandra":case"cql":return a="text/x-cassandra";case"plsql":return a="text/x-plsql";case"stex":case"tex":case"latex":return"text/x-stex";case"tiddlywiki":case"wiki":return a="tiddlywiki";case"vb":case"visual basic":case"basic":return a="vb";case"vbscript":return a;case"velocity":return a;case"verilog":return a="text/x-verilog";case"xquery":return a;case"yaml":return a;case"go":return a;case"groovy":return a;case"nginx":return a;case"octave":case"matlab":return"text/x-octave";case"c":case"clike":return a="text/x-csrc";case"c++":case"cpp":case"cc":return a="text/x-c++src";case"obj-c":case"objc":case"objective c":case"objective-c":return a="text/x-objectivec";case"text/x-scala":case"scala":return a="text/x-scala";case"csharp":case"c#":return a="text/x-csharp";case"java":return a="text/x-java";case"squirrel":return a="text/x-squirrel";case"ceylon":return a="text/x-ceylon";case"kotlin":return a="text/x-kotlin";case"swift":return a="text/swift";case"r":case"rlang":case"r-lang":return a="text/x-rsrc";case"d":return a;case"diff":return a;case"erlang":return a;case"http":return a;case"jade":return a;case"rst":case"restructuredtext":return a="rst";case"rust":return a;case"jinja2":return a;case"aspx":case"asp":case"asp.net":return a="application/x-aspx";case"jsp":return a="application/x-jsp";case"erb":return a="application/x-erb";case"ejs":case"embeddedjs":case"embedded javaScript":return a="application/x-ejs";case"powershell":return"application/x-powershell";case"dockerfile":return"text/x-dockerfile";case"jsx":case"react":return"text/jsx";case"vue.js":case"vue":case"vue-template":return"script/x-vue";case"nsis":return"text/x-nsis";case"mathematica":return"text/x-mathematica";case"tiki":case"tiki wiki":case"tiki-wiki":case"tikiwiki":return"tiki";case"properties":case"ini":return"text/x-properties";case"livescript":return"text/x-livescript";case"asm":case"assembly":case"nasm":case"gas":return"assembly";case"toml":return"text/x-toml";case"sequence":return"sequence";case"flow":return"flow";case"mermaid":return"mermaid";case"ocaml":return"text/x-ocaml";case"f#":case"fsharp":return"text/x-fsharp";case"elm":return"text/x-elm";case"pgp":case"pgp-keys":case"pgp-key":case"pgp-signature":case"asciiarmor":case"ascii-armor":case"ascii armor":return"application/pgp";case"spreadsheet":case"excel":return"text/x-spreadsheet";case"elixir":return"elixir";case"cmake":return"text/x-cmake";case"cypher":case"cypher-query":return"application/x-cypher-query";case"dart":return"dart";case"django":return"text/x-django";case"dtd":case"xml-dtd":case"xml dtd":return"application/xml-dtd";case"dylan":return"text/x-dylan";case"handlebars":return"text/x-handlebars-template";case"idl":return"text/x-idl";case"webidl":case"web-idl":case"web idl":return"text/x-webidl";case"yacas":return"text/x-yacas";case"mbox":return"application/mbox";case"vhdl":return"text/x-vhdl";case"julia":return"julia";case"haxe":return"text/x-haxe";case"hxml":return"text/x-hxml";case"fortran":return"text/x-fortran";case"protobuf":return"text/x-protobuf"}return b?null:a};var q=g.Model.extend({initialize:function(a){var b=this;this.editor=a,this.queue={},this.cachedCharWidth,this.$container=f("#fences-auto-suggest"),this.editor.diagrams=new k(a),File.option.enableDiagram&&(n=n.concat(["sequence","flow","mermaid"])),f(document).on("losefocus",".md-fences",function(){var a=f(this),c=b.queue[a.attr("cid")];b.syncToNode(this.getAttribute("cid")),c.doc.setCursor(0,0),a.find(".md-tooltip-hide").hide(),a[0].style.marginBottom=""}).on("mousedown",".autoComplt-list li",function(a){return f("input.mode:focus").val(this.textContent),!1}),this.lazyload(),this.editor.diagrams.lazyload()},showAutoSuggest:function(a,b){if(b.token===a)return!1;var c=o(a,!0),d="";if(b.type="fences",b.token=a,b.match=c,b.found=c.length,b.pageNo=0,b.pageCnt=Math.floor((c.length-1)/5+1),!b.found)return this.$container.hide(),!1;for(var e=0;e<c.length&&40>e;e++)e%5==0&&(d+=(e>0?"</ul>":"")+"<ul data-page='"+e/5+"' style='display:none'>"),d+="<li data-content='"+c[e]+"' > "+c[e]+"</span></li>";return d+="</ul>",this.$container.html(d),this.$container},clickEventHandled:function(a,b){var c,d,e;this.queue[b]||(e=window.scrollY,this.getCm(b),e-=window.scrollY,window.scrollBy(0,e),c=document.elementFromPoint(a.clientX,a.clientY),c&&(a.stopPropagation(),d=document.createEvent("MouseEvents"),d.initMouseEvent("mousedown",!0,!0,c.ownerDocument.defaultView,1,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button),c.dispatchEvent(d)),this.editor.refocus(b))},getCm:function(a){if(this.queue[a]){if(f("[cid='"+a+"'] textarea").length)return this.queue[a];delete this.queue[a]}return this.queue[a]?void 0:this.addCodeBlock(a)},getValue:function(a){return this.queue[a]?this.queue[a].getValue():this.editor.findElemById(a).text()},addCodeBlock:function(a){function b(a){var b=(k.findElemById(a.cid),k.getNode(a.cid)),c=k.undo.UndoManager,d=c.makeEmptyCommand();b.get("before");l.beforeDeleteFences(a.cid),d.undo.push({type:"fences-pos",pos:a.getCursor(),id:a.cid}),c.append(d,k.UserOp.backToParagraph(k,b,!1)),k.undo.register(d)}function c(a,c){var e,f=c.which||c.keyCode,g=d.keyName(c),h=!c.metaKey&&!c.shiftKey&&!c.ctrlKey;if("Up"==d.keyNames[f]){if(0===(a.getCursor()||{}).line&&h)return k.selection.moveUpOrDown(!0,c),c.codemirrorIgnore;c.stopPropagation()}else if("Down"==d.keyNames[f]){if((a.getCursor()||{}).line>=a.lineCount()-1&&h)return k.selection.moveUpOrDown(!1,c),c.codemirrorIgnore;c.stopPropagation()}else if("Left"==d.keyNames[f]){if(e=a.doc.getCursor(),e&&!e.line&&!e.ch&&h)return k.selection.moveUpOrDown(!0,c),c.codemirrorIgnore;c.stopPropagation()}else if("Right"==d.keyNames[f]){if(e=a.doc.getCursor(),e&&e.line>=a.lineCount()-1&&e.ch>=a.doc.getLine(e.line).length&&h)return k.selection.moveUpOrDown(!1,c),c.codemirrorIgnore;c.stopPropagation()}else if("Backspace"==d.keyNames[f]){if(e=a.doc.getCursor(),e&&a.lineCount()<=1&&!e.line&&!e.ch&&!a.getSelection().length)return b(a),c.preventDefault(),c.codemirrorIgnore;c.stopPropagation()}(d.keyMap.macDefault[g]||d.keyMap.pcDefault[g])&&c.stopPropagation()}function e(b){k.undo.completeSnap(!0),b.getWrapperElement().offsetHeight||b.refresh();var c=f(b.display.input).closest(".md-fences");c.find(".md-tooltip-hide").show(),k.refocus(a.id),j(b),k.diagrams.startPreview(b.cid),File.isMac&&app.touchBar&&app.touchBar.setFencesOnSetLang(!1)}function g(a,b){if(3===b.which){if(!a.getSelection().length){var c,d=a.findWordAt(a.getCursor());a.setSelections([d])}a.state.focused&&(c=k.selection.buildUndo(),setTimeout(function(){k.undo.exeCommand(c),j(a)},100))}}function h(a,b){k.brush.updateWordCount(),k.diagrams.updateDiagram(a.cid),b.length&&b[0].origin&&k.syncChange([{type:"sync",id:a.cid,cmChanges:b}])}function i(a,b){b.ranges.length&&b.ranges[0].anchor.line!=(a.getCursor()||{}).line&&k.diagrams.attachError(a)}function j(a,b){File.isTypeWriterMode&&File.option.scrollWithCursor&&k.selection.typeWriterScroll(f(a.display.wrapper).find(".CodeMirror-activeline"))}var k=this.editor,l=this;if("string"==typeof a&&(a=this.editor.getNode(a)),!this.queue[a.id]&&a.get("type")==a.TYPE.fences){var m="<textarea id = 'for-fence-"+a.id+"' />",n=f("[cid = "+a.id+"]").removeClass("mock-cm");n.html(m),m=f("#for-fence-"+a.id)[0],m.value=a.safeGetStrAttr("text").replace(/\r?\n$/,"").replace(/\u200b```/gi,"```"),this.queue[a.id]=d.fromTextArea(m,{lineWrapping:!0,mode:getCodeMirrorMode(a.get("lang")),styleSelectedText:!0,maxHighlightLength:1/0,viewportMargin:1/0,styleActiveLine:!0,autoCloseBrackets:!File.option.noPairingMatch,autoCloseTags:!File.option.noPairingMatch,theme:" inner",lineNumbers:File.option.showLineNumbersForFence,dragDrop:!1},this.editor,a.id),a.get("history")&&this.queue[a.id].setHistory(a.get("history")),this.queue[a.id].off("keydown",c),this.queue[a.id].on("keydown",c),this.queue[a.id].off("focus",e),this.queue[a.id].on("focus",e),this.queue[a.id].off("mousedown",g),this.queue[a.id].on("mousedown",g),this.queue[a.id].off("changes",h),this.queue[a.id].on("changes",h),this.queue[a.id].off("cursorActivity",j),this.queue[a.id].on("cursorActivity",j),this.queue[a.id].off("beforeSelectionChange",i),this.queue[a.id].on("beforeSelectionChange",i),f("[cid = "+a.id+"] .CodeMirror").before("<div class= 'code-tooltip md-tooltip-hide' align='right'><input class='mode' type='text' value='"+(a.get("lang")?a.get("lang"):"")+"' placeholder='select a language'></div> ").find(".CodeMirror").attr("lang",(a.get("lang")||"").toLowerCase()),p.call(this,n,a)}return this.queue[a.id]},toggleFocusedComponent:function(){var a=document.activeElement,b=f(a).closest(".md-fences");if(b.length)if("INPUT"==a.tagName){var c=b.attr("cid"),d=this.getCm(c),e=d.getCursor();f("[cid = "+c+"] textarea").focus(),d.focus(),d.setCursor(e)}else b.find(".CodeMirror-focused").removeClass("CodeMirror-focused").end().find("input.mode").show().focus()},focus:function(a){this.editor.undo.completeSnap(!0);var b,c="string"==typeof a?a:a.id;this.editor;this.editor.findElemById(c).addClass("md-focus"),b=this.getCm(c),window.getSelection().removeAllRanges(),setTimeout(function(){f("[cid = "+c+"] textarea").focus()},50)},getFocused:function(){for(var a in this.queue)if(this.queue.hasOwnProperty(a)&&this.queue[a].hasFocus())return this.queue[a]},updateCodeNum:function(){for(var a in this.queue)this.editor.getNode(a)||delete this.queue[a]},syncToNode:function(a){var b,c;b="string"==typeof a?this.editor.getNode(a):a,b&&(c=this.getCm(b.id),c.save(),b.set("history",c.doc.getHistory()),this.editor.findElemById(b.id).children().length?b.set("text",this.queue[b.id].getValue()):b.set("text",""))},refreshEditor:function(a,b){var c=this,d=0;for(var e in this.queue)this.editor.getNode(e)&&this.editor.findElemById(e).find(".CodeMirror").length?(b&&this.queue[e].refresh(),d++):(delete this.queue[e],Node.isType(this.editor.getNode(e),Node.TYPE.fences)&&this.addCodeBlock(e));var g=f("[mdtype='fences']").toArray(),h=this.editor,i=30,j=0;g.length!=d&&g.map(function(b){h.getNode(b.getAttribute("cid")).get("lang")?(j++,c.addCodeBlock(b.getAttribute("cid"))):(a||i>j)&&(c.addCodeBlock(b.getAttribute("cid")),j++)})},lazyload:function(){var b=this;a.async(window.debugMode?"codemirror/mode.min.js":File.isMac?"lib/codemirror/mode.min.js":"lib.asar/codemirror/mode.min.js",function(){b.modeLoaded=!0,b.refreshEditor(),console.debug("codemirror mode is loaded")})},addToUndoManager:function(a){this.editor.undo.register({undo:[{type:"fences",cmd:"undo",id:a.cid}],redo:[{type:"fences",cmd:"redo",id:a.cid}]})},jumpCmEnd:function(a){var b=this.getCm(a),c=0,d=0;b&&(c=b.doc.lastLine(),d=b.doc.getLine(c).length,b.focus(),b.setCursor({line:c,ch:d}))},jumpCmBegin:function(a){var b=this.getCm(a);b.focus(),b.setCursor({line:0,ch:0})},beforeDeleteFences:function(a,b){var c,d;"string"==typeof a?(c=this.queue[a],d=this.editor.getNode(a)):(d=a,c=this.queue[d.id]),c&&(d.set("text",c.getValue()),d.set("history",c.doc.getHistory()),c.toTextArea(),c.doc.history=null,delete this.queue[d.id],b&&b.map(function(a){a&&(a.id==d.id&&a.json&&a.json.content&&a.json.content.type==d.TYPE.fences?(a.json.content.text=d.get("text"),a.json.content.history=d.get("history")):Array.isArray(a.json)&&a.json.map(function(a){a.id==d.id&&a.content.type==d.TYPE.fences&&(a.content.text=d.get("text"),a.content.history=d.get("history"))}))}))},deletionMonitor:function(a){var b=this;a.find("[mdtype='fences']").toArray().map(function(a){b.beforeDeleteFences(a.getAttribute("cid"))})},searchOn:function(a,b,c){function d(a){return{token:function(b){var d=!c.wholeWord||!b.pos||!/[a-z_\\u00C0-\\u024f]/.exec(b.string.substring(b.pos-1,b.pos));return!d||!b.match(f)||c.wholeWord&&/[a-z_\\u00C0-\\u024f]/.exec(b.string.substr(b.pos,b.pos+1))?(b.next(),b.pos=b.string.toLowerCase().indexOf(a,b.pos),!~b.pos&&b.skipToEnd(),null):"search-hit"}}}this.searchStatus=this.searchStatus||{},this.searchStatus.overlay=this.searchStatus.overlay||{};var f=new RegExp("^"+e.escapeRegExp(b),c.caseSensitive?"":"i");this.searchStatus.overlay[a.cid||"source"]=d(b),a.addOverlay(this.searchStatus.overlay[a.cid||"source"])},clearSearchOn:function(a){this.searchStatus&&a.removeOverlay(this.searchStatus.overlay[a.cid||"source"])},clearSearchAll:function(){if(this.editor.sourceView.inSourceMode)return this.searchStatus&&this.editor.sourceView.cm.removeOverlay(this.searchStatus.overlay.source),void(this.searchStatus=null);if(this.searchStatus&&this.searchStatus.overlay)for(var a in this.queue)this.queue.hasOwnProperty(a)&&this.searchStatus.overlay[a]&&this.queue[a].removeOverlay(this.searchStatus.overlay[a])}});c.exports=q,window.CodeMirror=d,window.Fences=q}),define("autoComplete",[],function(a,b,c){var d=a("jquery/jquery"),e=function(){var a=0,b={autoCompltListClass:"autoComplt-list",autoCompltHintClass:"autoComplt-hint",autoCompltHintSelectedClass:"autoComplt-hint-selected",maxHintNum:10,autoCompltDelay:100,listStatus:{attr:"data-listStatus",open:"open"},keyCode:{up:38,down:40,esc:27,enter:13,left:37,right:39},defaultStyles:{autoCompltList:{maxHeight:"none",border:"1px solid #aaa",padding:"0",margin:"0",zIndex:99,overflowX:"hidden",overflowY:"auto",display:"none",position:"absolute",backgroundColor:"#fff"},autoCompltHint:{height:"1.5em",padding:"2px 6px 2px 10px",margin:"6px 0",overflow:"hidden",listStyleType:"none",color:"#000",backgroundColor:"#fff",cursor:"default",fontSize:"1em"},autoCompltHintSelected:{color:"#fff",backgroundColor:"#3399ff"}},adjStyleAttrs:{autoCompltList:["border","maxHeight","backgroundColor"],autoCompltHint:["height","padding","margin","color","backgroundColor","fontSize"],autoCompltHintSelected:["color","backgroundColor"]}},c=function(a){return a=a||window.event,a.target=a.target||a.srcElement,a},e=function(a,b,c){a.addEventListener?a.addEventListener(b,c):a.attachEvent&&a.attachEvent("on"+b,c)},f=function(a,b,c){a.removeEventListener?a.removeEventListener(b,c):a.detachEvent&&a.detachEvent("on"+b,c)},g=function(a,b){var c=null;if(window.getComputedStyle)c=window.getComputedStyle(a)[b]||null;else if(a.currentStyle){c=a.currentStyle&&a.currentStyle[b];var d,e,f=a.style;null==c&&f&&f[b]&&(c=f[b]),d=f.left,e=a.runtimeStyle&&a.runtimeStyle.left,e&&(a.runtimeStyle.left=a.currentStyle.left),f.left="fontSize"===b?"1em":c,c=f.pixelLeft+"px",f.left=d,e&&(a.runtimeStyle.left=e)}return c},h={buildElem:function(a){var b=document.createElement("DIV");return b.innerHTML=a,b.firstChild.cloneNode(!0)},buildHint:function(a,c){if("string"==typeof a&&a){var a=this.buildElem('<li class="'+b.autoCompltHintClass+'">'+a+"</li>");return a.style.height=a.style.lineHeight=c.autoCompltHint.height,a.style.padding=c.autoCompltHint.padding,a.style.margin=c.autoCompltHint.margin,a.style.overflow=c.autoCompltHint.overflow,a.style.listStyleType=c.autoCompltHint.listStyleType,a.style.color=c.autoCompltHint.color,a.style.backgroundColor=c.autoCompltHint.backgroundColor,a.style.cursor=c.autoCompltHint.cursor,a.style.fontSize=c.autoCompltHint.fontSize,a}return null},buildList:function(a){var c=this.buildElem('<ul class="'+b.autoCompltListClass+'"></ul>');return c.style.maxHeight=a.autoCompltList.maxHeight,c.style.border=a.autoCompltList.border,c.style.padding=a.autoCompltList.padding,c.style.margin=a.autoCompltList.margin,c.style.zIndex=a.autoCompltList.zIndex,c.style.overflowX=a.autoCompltList.overflowX,c.style.overflowY=a.autoCompltList.overflowY,c.style.display=a.autoCompltList.display,c.style.position=a.autoCompltList.position,c.style.backgroundColor=a.autoCompltList.backgroundColor,c}},i=function(a){this.uiElem=null,this.assocInput=a,this.mouseOnList=!1,this.pauseMouseoverSelection=!1,this.pauseMouseoutDeselection=!1,this.maxHintNum=b.maxHintNum,this.styles=JSON.parse(JSON.stringify(b.defaultStyles))};i.prototype.genList=function(){if(!this.uiElem){var a=this;this.uiElem=h.buildList(this.styles),e(this.uiElem,"mouseover",function(b){b=c(b),a.isHint(b.target)&&(a.select(b.target),a.autoScroll())}),e(this.uiElem,"mouseout",function(b){b=c(b),a.deselect()}),e(this.uiElem,"mousedown",function(b){a.mouseOnList=!0,"INPUT"!==a.assocInput.tagName&&a.getSelected()&&b.preventDefault()}),e(this.uiElem,"mouseup",function(b){b=c(b),a.isHint(b.target)&&(a.select(b.target),k(a.assocInput,a.getSelected().innerHTML),a.assocInput.autoComplt.close(),d(a.assocInput).trigger("change"))}),document.body.appendChild(this.uiElem)}},i.prototype.isHint=function(a){if(a&&"object"==typeof a&&1===a.nodeType){var c=" "+a.className+" ";return c.indexOf(" "+b.autoCompltHintClass+" ")>=0}return!1},i.prototype.putHints=function(a){var b=0;if(a instanceof Array){var c,d,e=[];for(d=Math.min(a.length,this.maxHintNum),c=0;d>c;c++)e.push(h.buildHint(a[c],this.styles)),e[e.length-1]||e.pop();if(e.length>0){var f=document.createDocumentFragment();for(c=0,b=e.length;b>c;c++)f.appendChild(e[c]);this.clearHints(),this.genList(),this.uiElem.appendChild(f)}}return b},i.prototype.clearHints=function(){this.uiElem&&(this.uiElem.innerHTML="")},i.prototype.isOpen=function(){return this.uiElem?this.uiElem.getAttribute(b.listStatus.attr)==b.listStatus.open:!1},i.prototype.open=function(){var a;if(this.uiElem&&(a=this.uiElem.querySelectorAll("."+b.autoCompltHintClass))&&a.length){var c,d;for(d=this.assocInput.getBoundingClientRect(),this.uiElem.style.top=(document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop)+d.bottom+"px",this.uiElem.style.left=d.left+"px",d=d.right-d.left-parseFloat(g(this.uiElem,"borderLeftWidth"))-parseFloat(g(this.uiElem,"borderRightWidth")),this.uiElem.style.width=d+"px",c=0,d=0;c<a.length;c++)d+=parseFloat(g(a[c],"height"))+parseFloat(g(a[c],"paddingTop"))+parseFloat(g(a[c],"paddingBottom")),a[c+1]&&(d+=Math.max(parseFloat(g(a[c],"marginBottom")),parseFloat(g(a[c+1],"marginTop"))));d+=parseFloat(g(a[0],"marginTop"))+parseFloat(g(a[a.length-1],"marginBottom")),this.uiElem.style.height=d+1+"px",this.uiElem.setAttribute(b.listStatus.attr,b.listStatus.open),this.uiElem.style.display="block"}},i.prototype.close=function(){this.uiElem&&!a&&(this.mouseOnList=!1,this.uiElem.parentNode.removeChild(this.uiElem),this.uiElem=null,d(this.assocInput).trigger("change"))},i.prototype.autoScroll=function(){var a=this.getSelected();if(a){var b,c=0,d=0,e=a.clientHeight,f=parseFloat(g(a,"marginTop")),h=parseFloat(g(a,"marginBottom"));for(b=a.previousSibling,d=e+(b?Math.max(f,h):f);b;)c+=e,b=b.previousSibling,c+=b?Math.max(f,h):f;(this.uiElem.clientHeight+this.uiElem.scrollTop-c<d||c-this.uiElem.scrollTop<d)&&(this.uiElem.scrollTop=c)}},i.prototype.select=function(a){if(this.uiElem){var c=null;if(this.isHint(a))c=a;else if("number"==typeof a&&(a>=0||-1===a)){var d=this.uiElem.querySelectorAll("."+b.autoCompltHintClass);d.length>0&&(c=+a,c=-1===c||c>d.length-1?d.length-1:c,c=d[c])}null!==c&&(this.deselect(),c.className+=" "+b.autoCompltHintSelectedClass,c.style.color=this.styles.autoCompltHintSelected.color,c.style.backgroundColor=this.styles.autoCompltHintSelected.backgroundColor)}},i.prototype.deselect=function(){if(this.uiElem){var a=this.getSelected();a&&(a.className=b.autoCompltHintClass,a.style.color=this.styles.autoCompltHint.color,a.style.backgroundColor=this.styles.autoCompltHint.backgroundColor)}},i.prototype.getSelected=function(){return this.uiElem?this.uiElem.querySelector("."+b.autoCompltHintSelectedClass)||null:null};var j=function(a){return"INPUT"==a.tagName?a.value:a.innerText},k=function(a,b){"INPUT"==a.tagName?a.value=b:a.innerText=b},l={enable:function(a,c){if(a&&1===a.nodeType&&!a.autoComplt){a.autoComplt={};var g=b.autoCompltDelay,h=!0,l="",m=null,n=new i(a),o=function(){if(j(this).length>0&&h&&"function"==typeof m&&l!==j(this)){var b={};b.call=function(){m.call(b.that,b.compltTarget,b.openHint)},b.that=a,b.compltTarget=l=j(this),b.openHint=function(c){if(b.compltTarget===l)if(n.putHints(c)){var e=d(a).offset();e.top+=a.offsetHeight+5,n.open(),d(n.uiElem).css("min-width",100),d(n.uiElem).offset(e)}else b.that.autoComplt.close()},setTimeout(b.call,g)}},p=function(){if(h){var a=n.getSelected();a?k(this,a.innerHTML):k(this,l)}},q=function(b){n.mouseOnList&&"INPUT"==a.tagName&&(a.focus(),n.mouseOnList=!1),a.autoComplt.close()},r=function(c){if(h)if("keydown"==c.type){if(c.keyCode===b.keyCode.enter)return c.preventDefault();if(n.isOpen()&&(c.keyCode===b.keyCode.up||c.keyCode===b.keyCode.down)){var e=n.getSelected();c.keyCode===b.keyCode.up?(c.preventDefault(),e?e.previousSibling?n.select(e.previousSibling):n.deselect():n.select(-1)):c.keyCode===b.keyCode.down&&(c.preventDefault(),e?e.nextSibling?n.select(e.nextSibling):n.deselect():n.select(0)),n.autoScroll(),p.call(a)}}else if("keyup"==c.type){var f=!1;switch(c.keyCode){case b.keyCode.up:case b.keyCode.down:c.preventDefault();break;case b.keyCode.left:case b.keyCode.right:break;case b.keyCode.esc:n.isOpen()&&(a.value=l,a.autoComplt.close());break;case b.keyCode.enter:n.isOpen()&&(p.call(a),a.autoComplt.close(),d(a).trigger("change"));break;default:f=!0}f&&o.call(a)}};return a.autoComplt.setHintsFetcher=function(a){return"function"==typeof a?(m=a,!0):!1},a.autoComplt.config=function(a){if(a instanceof Object){var b,c={};return b=Math.floor(a.delay),b>0&&(g=c.delay=b),b=Math.floor(a.maxHintNum),b>0&&(n.maxHintNum=c.maxHintNum=b),c}return!1},a.autoComplt.setStyles=function(a,c){var d,e,f=!1;switch(a){case b.autoCompltListClass:d=n.styles.autoCompltList,e=b.adjStyleAttrs.autoCompltList;break;case b.autoCompltHintClass:d=n.styles.autoCompltHint,e=b.adjStyleAttrs.autoCompltHint;break;case b.autoCompltHintSelectedClass:d=n.styles.autoCompltHintSelected,e=b.adjStyleAttrs.autoCompltHintSelected}if(c instanceof Object&&d&&e)for(var g=0;g<e.length;g++)("string"==typeof c[e[g]]||"number"==typeof c[e[g]])&&(f||(f={}),f[e[g]]=d[e[g]]=c[e[g]]);return f},a.autoComplt.close=function(){l="",n.close()},a.autoComplt.enable=function(){h=!0},a.autoComplt.disable=function(){this.close(),h=!1},a.autoComplt.destroy=function(){f(a,"blur",q),f(a,"keyup",r),f(a,"keydown",r),this.close(),delete a.autoComplt},e(a,"blur",q),e(a,"keyup",r),e(a,"keydown",r),c instanceof Object&&(a.autoComplt.config(c),a.autoComplt.setHintsFetcher(c.hintsFetcher)),a}return null}};return l}();c.exports=e}),define("codemirror/addon/selection/mark-selection.js",[],function(a,b,c){"use strict";var d=a("codemirror/lib/codemirror");!function(a){function b(a){a.operation(function(){g(a)})}function c(a){a.state.markedSelection.length&&a.operation(function(){e(a)})}function d(a,b,c,d){if(0!=j(b,c))for(var e=a.state.markedSelection,f=a.state.markedSelectionStyle,g=b.line;;){var k=g==b.line?b:i(g,0),l=g+h,m=l>=c.line,n=m?c:i(l,0),o=a.markText(k,n,{className:f});if(null==d?e.push(o):e.splice(d++,0,o),m)break;g=l}}function e(a){for(var b=a.state.markedSelection,c=0;c<b.length;++c)b[c].clear();b.length=0}function f(a){e(a);for(var b=a.listSelections(),c=0;c<b.length;c++)d(a,b[c].from(),b[c].to())}function g(a){if(!a.somethingSelected())return e(a);if(a.listSelections().length>1)return f(a);var b=a.getCursor("start"),c=a.getCursor("end"),g=a.state.markedSelection;if(!g.length)return d(a,b,c);var i=g[0].find(),k=g[g.length-1].find();if(!i||!k||c.line-b.line<h||j(b,k.to)>=0||j(c,i.from)<=0)return f(a);for(;j(b,i.from)>0;)g.shift().clear(),i=g[0].find();for(j(b,i.from)<0&&(i.to.line-b.line<h?(g.shift().clear(),d(a,b,i.to,0)):d(a,b,i.from,0));j(c,k.to)<0;)g.pop().clear(),k=g[g.length-1].find();j(c,k.to)>0&&(c.line-k.from.line<h?(g.pop().clear(),d(a,k.from,c)):d(a,k.to,c))}a.defineOption("styleSelectedText",!1,function(d,g,h){var i=h&&h!=a.Init;g&&!i?(d.state.markedSelection=[],d.state.markedSelectionStyle="string"==typeof g?g:"CodeMirror-selectedtext",f(d),d.on("cursorActivity",b),d.on("change",c)):!g&&i&&(d.off("cursorActivity",b),d.off("change",c),e(d),d.state.markedSelection=d.state.markedSelectionStyle=null)});var h=8,i=a.Pos,j=a.cmpPos}(d)}),define("codemirror/addon/edit/closebrackets",["codemirror/lib/codemirror"],function(a,b,c){var d=a("codemirror/lib/codemirror");!function(){function a(a,b){var c=a.getRange(d.Pos(b.line,b.ch-1),d.Pos(b.line,b.ch+1));return 2==c.length?c:null}function b(b){for(var c={name:"autoCloseBrackets",Backspace:function(c){if(c.somethingSelected())return d.Pass;var e=c.getCursor(),f=a(c,e);return f&&b.indexOf(f)%2==0?void c.replaceRange("",d.Pos(e.line,e.ch-1),d.Pos(e.line,e.ch+1)):d.Pass}},e="",f=0;f<b.length;f+=2)(function(a,b){function f(c){var d=c.getSelection();c.replaceSelection(a+d+b)}function h(a){var c=a.getCursor(),e=a.getRange(c,d.Pos(c.line,c.ch+1));return e!=b||a.somethingSelected()?d.Pass:void a.execCommand("goCharRight")}a!=b&&(e+=b),c["'"+a+"'"]=function(c){if("'"==a&&"comment"==c.getTokenAt(c.getCursor()).type)return d.Pass;if(c.somethingSelected())return f(c);if(a!=b||h(c)==d.Pass){var i=c.getCursor(),j=d.Pos(i.line,i.ch+1),k=c.getLine(i.line),l=k.charAt(i.ch),m=i.ch>0?k.charAt(i.ch-1):"";if(a==b&&d.isWordChar(m))return d.Pass;if(!(k.length==i.ch||e.indexOf(l)>=0||g.test(l)))return d.Pass;c.replaceSelection(a+b,{head:j,anchor:j}),c.execCommand("goCharRight")}},a!=b&&(c["'"+b+"'"]=h)})(b.charAt(f),b.charAt(f+1));return c}function c(b){return function(c){var e=c.getCursor(),f=a(c,e);return f&&b.indexOf(f)%2==0?void c.operation(function(){var a=d.Pos(e.line+1,0);c.replaceSelection("\n\n",{anchor:a,head:a},"+input"),c.execCommand("goLineDown"),c.indentLine(e.line+1,"prev",!0),c.indentLine(e.line+2,"prev",!0),c.indentLine(e.line+1,"add",!0)}):d.Pass}}var e="()[]{}''\"\"",f="[]{}",g=/\s/;d.defineOption("autoCloseBrackets",!1,function(a,g,h){if(h!=d.Init&&h&&a.removeKeyMap("autoCloseBrackets"),g){var i=e,j=f;"string"==typeof g?i=g:"object"==typeof g&&(null!=g.pairs&&(i=g.pairs),null!=g.explode&&(j=g.explode));var k=b(i);j&&(k.Enter=c(j)),a.addKeyMap(k)}})}()}),define("codemirror/addon/edit/closetag",["codemirror/lib/codemirror"],function(a,b,c){var d=a("codemirror/lib/codemirror");!function(){function a(a){var b=a.getCursor(),g=a.getTokenAt(b),h=d.innerMode(a.getMode(),g.state),i=h.state;if("xml"!=h.mode.name||!i.tagName)return d.Pass;var j=a.getOption("autoCloseTags"),k="html"==h.mode.configuration,l="object"==typeof j&&j.dontCloseTags||k&&e,m="object"==typeof j&&j.indentTags||k&&f,n=i.tagName;g.end>b.ch&&(n=n.slice(0,n.length-g.end+b.ch));var o=n.toLowerCase();if(!n||"string"==g.type&&(g.end!=b.ch||!/[\"\']/.test(g.string.charAt(g.string.length-1))||1==g.string.length)||"tag"==g.type&&"closeTag"==i.type||g.string.indexOf("/")==g.string.length-1||l&&c(l,o)>-1||d.scanForClosingTag&&d.scanForClosingTag(a,b,n,Math.min(a.lastLine()+1,b.line+50)))return d.Pass;var p=m&&c(m,o)>-1,q=p?d.Pos(b.line+1,0):d.Pos(b.line,b.ch+1);a.replaceSelection(">"+(p?"\n\n":"")+"</"+n+">",{head:q,anchor:q}),a.execCommand("goCharRight"),p&&(a.indentLine(b.line+1,null,!0),a.indentLine(b.line+2,null))}function b(a){var b=a.getCursor(),c=a.getTokenAt(b),e=d.innerMode(a.getMode(),c.state),f=e.state;if("string"==c.type||"<"!=c.string.charAt(0)||c.start!=b.ch-1||"xml"!=e.mode.name)return d.Pass;var g=f.context&&f.context.tagName;g&&a.replaceSelection("/"+g+">","end")}function c(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0,d=a.length;d>c;++c)if(a[c]==b)return c;return-1}d.defineOption("autoCloseTags",!1,function(c,e,f){if(f!=d.Init&&f&&c.removeKeyMap("autoCloseTags"),e){var g={name:"autoCloseTags"};("object"!=typeof e||e.whenClosing)&&(g["'/'"]=function(a){return b(a)}),("object"!=typeof e||e.whenOpening)&&(g["'>'"]=function(b){return a(b)}),c.addKeyMap(g)}});var e=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],f=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"]}()}),define("codemirror/addon/mode/overlay",[],function(a,b,c){"use strict";var d=a("codemirror/lib/codemirror");d.overlayMode=d.overlayParser=function(a,b,c){return{startState:function(){return{base:d.startState(a),overlay:d.startState(b),basePos:0,baseCur:null,overlayPos:0,overlayCur:null}},copyState:function(c){return{base:d.copyState(a,c.base),overlay:d.copyState(b,c.overlay),basePos:c.basePos,baseCur:null,overlayPos:c.overlayPos,overlayCur:null}},token:function(d,e){return d.start==e.basePos&&(e.base.lineBefore=e.lineBefore,e.base.lineAfter=e.lineAfter,e.baseCur=a.token(d,e.base),e.basePos=d.pos),d.start==e.overlayPos&&(d.pos=d.start,e.overlayCur=b.token(d,e.overlay),e.overlayPos=d.pos),d.pos=Math.min(e.basePos,e.overlayPos),d.eol()&&(e.basePos=e.overlayPos=0),null==e.overlayCur?e.baseCur:null!=e.baseCur&&c?e.baseCur+" "+e.overlayCur:e.overlayCur},indent:a.indent&&function(b,c){return a.indent(b.base,c)},electricChars:a.electricChars,innerMode:function(b){return{state:b.base,mode:a}},blankLine:function(c){return a.blankLine?a.blankLine(c.base):b.blankLine?b.blankLine(c.overlay):void 0}}}}),define("codemirror/addon/lint/lint",[],function(a,b,c){"use strict";function d(a,b){function c(a){return d.parentNode?(d.style.top=Math.max(0,a.clientY-d.offsetHeight-5)+"px",void(d.style.left=a.clientX+5+"px")):u.off(document,"mousemove",c)}var d=document.createElement("div");return d.className="CodeMirror-lint-tooltip",d.appendChild(b.cloneNode(!0)),document.body.appendChild(d),u.on(document,"mousemove",c),c(a),null!=d.style.opacity&&(d.style.opacity=1),d}function e(a){a.parentNode&&a.parentNode.removeChild(a)}function f(a){a.parentNode&&(null==a.style.opacity&&e(a),a.style.opacity=0,setTimeout(function(){e(a)},600))}function g(a,b,c){function e(){u.off(c,"mouseout",e),g&&(f(g),g=null)}var g=d(a,b),h=setInterval(function(){if(g)for(var a=c;;a=a.parentNode){if(a==document.body)return;if(!a){e();break}}return g?void 0:clearInterval(h)},400);u.on(c,"mouseout",e)}function h(a,b,c){this.marked=[],this.options=b,this.timeout=null,this.hasGutter=c,this.onMouseOver=function(b){s(a,b)}}function i(a,b){if(b instanceof Function)return{getAnnotations:b};if(b&&b!==!0||(b={}),b.getAnnotations||(b.getAnnotations=a.getHelper(u.Pos(0,0),"lint")),!b.getAnnotations)throw new Error("Required option 'getAnnotations' missing (lint addon)");return b}function j(a){var b=a.state.lint;if(b){b.hasGutter&&a.clearGutter(v);for(var c=0;c<b.marked.length;++c)b.marked[c].clear();b.marked.length=0}}function k(a,b,c,d){var e=document.createElement("div"),f=e;return e.className="CodeMirror-lint-marker-"+b,c&&(f=e.appendChild(document.createElement("div")),f.className="CodeMirror-lint-marker-multiple"),0!=d&&u.on(f,"mouseover",function(b){g(b,a,f)}),e}function l(a,b){return"error"==a?a:b}function m(a){for(var b=[],c=0;c<a.length;++c){var d=a[c],e=d.from.line;(b[e]||(b[e]=[])).push(d)}return b}function n(a){var b=a.severity;w.test(b)||(b="error");var c=document.createElement("div");return c.className="CodeMirror-lint-message-"+b,c.appendChild(document.createTextNode(a.message)),
c}function o(a){var b=a.state.lint,c=b.options;c.async?c.getAnnotations(a,p,c):p(a,c.getAnnotations(a.getValue(),c))}function p(a,b){for(var c=a.state.lint,d=c.options,e=m(b),f=0;f<e.length;++f){var g=e[f];if(g){for(var h=null,i=c.hasGutter&&document.createDocumentFragment(),j=0;j<g.length;++j){var o=g[j],p=o.severity;w.test(p)||(p="error"),h=l(h,p),d.formatAnnotation&&(o=d.formatAnnotation(o)),c.hasGutter&&i.appendChild(n(o)),o.to&&c.marked.push(a.markText(o.from,o.to,{className:"CodeMirror-lint-mark-"+p,__annotation:o}))}c.hasGutter&&a.setGutterMarker(f,v,k(i,h,g.length>1,c.options.tooltips))}}d.onUpdateLinting&&d.onUpdateLinting(b,e,a)}function q(a){var b=a.state.lint;clearTimeout(b.timeout),b.timeout=setTimeout(function(){o(a)},b.options.delay||500)}function r(a,b){var c=b.target||b.srcElement;g(b,n(a),c)}function s(a,b){if(/\bCodeMirror-lint-mark-/.test((b.target||b.srcElement).className))for(var c=0;c<x.length;c+=2)for(var d=a.findMarksAt(a.coordsChar({left:b.clientX+x[c],top:b.clientY+x[c+1]})),e=0;e<d.length;++e){var f=d[e],g=f.__annotation;if(g)return r(g,b)}}function t(a,b,c){if(c&&c!=u.Init&&(j(a),a.off("change",q),u.off(a.getWrapperElement(),"mouseover",a.state.lint.onMouseOver),delete a.state.lint),b){for(var d=a.getOption("gutters"),e=!1,f=0;f<d.length;++f)d[f]==v&&(e=!0);var g=a.state.lint=new h(a,i(a,b),e);a.on("change",q),0!=g.options.tooltips&&u.on(a.getWrapperElement(),"mouseover",g.onMouseOver),o(a)}}var u=a("codemirror/lib/codemirror"),v="CodeMirror-lint-markers",w=/^(?:error|warning)$/,x=[0,0,0,5,0,-5,5,0,-5,0];u.clearMarks=j,u.updateLinting=p,u.defineOption("lintWith",!1,t),u.defineOption("lint",!1,t)}),define("app/editor/MathBlock",["codemirror/lib/codemirror","jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","app/editor/UndoManager","app/editor/KeyMaster"],function(a,b,c){"use strict";function d(){MathJax.Hub.config.TeX.equationNumbers?MathJax.Hub.config.TeX.equationNumbers.autoNumber="all":MathJax.Hub.config.TeX.equationNumbers={autoNumber:"all",useLabelIds:!0}}function e(){var a=[],b=[];MathJax.Hub.Register.MessageHook("Begin Attach MathJax",function(c){v()&&(a=Object.keys(h.labels).clone(),b=Object.keys(h.eqlabels).clone())}),MathJax.Hub.Register.MessageHook("End Attach MathJax",function(c){var d=[],e=[],f=j(c[1]),g=(f.closest(".md-inline-math"),f.closest("[mdtype='math_block']"));if(v()&&g.length){var i=File.editor.findNodeByElem(g);for(var k in h.labels)-1==a.indexOf(k)&&d.push(k);for(var l in h.eqlabels)-1==b.indexOf(l)&&e.push(l);i.set("mathLabel",d),i.set("mathEqLabel",e)}})}function f(){return r?!0:(File.option.autoNumberingForMath&&d(),e(),void(r=!0))}function g(a){(a.get("mathLabel")||[]).map(function(a){delete h.labels[a]}),(a.get("mathEqLabel")||[]).map(function(a){delete h.eqlabels[a]})}var h,i=a("codemirror/lib/codemirror"),j=a("jquery/jquery"),k=a("exoskeleton-master/exoskeleton"),l=a("app/document/Node"),m=l.Node,n=(a("codemirror/addon/display/placeholder"),a("codemirror/mode/stex/stex"),a("app/editor/UndoManager"),a("app/document/StringUtils")),o=a("app/editor/KeyMaster"),p=l.TYPE,q=o.map,r=!1,s=k.Model.extend({initialize:function(a){this.editor=a,this.queue={},this.preview,this.bindEvent()},bindEvent:function(){var a=this,b=this.editor;j(this.editor.sessionStr).on("click","[cid].mathjax-block",function(b){return 1==b.which?(a.startEditing(j(this)),!1):void 0}).on("click mousedown",".jax-trigger-delete-button",function(b){a.remove(j(this).closest("[cid]"))}).on("click",".jax-trigger-finish-button",function(c){a.stopEditing(a.currentCm.cid,!0),b.refocus(null)}).on("losefocus",".md-mathjax-panel",function(b){a.stopEditing(this.getAttribute("cid"))}).on("keydown",".mathjax-block",function(b){var c=event.keyCode||event.which;return"Enter"===q[c]?(a.startEditing(j(this)),b.stopPropagation(),b.preventDefault()):void 0})},renderAll:function(){f(),w.Init();for(var a=document.querySelectorAll(".mathjax-block"),b=0;b<a.length;b++){var c=a[b],d=c.querySelector("script");if(!d||!d.MathJax){if(File.option.autoNumberingForMath)return void this.forceRefresh();var e=this.editor.getNode(c.getAttribute("cid"));MathJax.Hub.Queue(["BeforeRender",w,e],["Typeset",MathJax.Hub,c.getAttribute("id")],["AfterRender",w,e])}}},getTex:function(a){return this.editor.findElemById(a).find("script").text()},getCidAndElem:function(a){var b=a,c=a;return"string"==typeof a?c=this.editor.findElemById(b):b=c.attr("cid"),[b,c]},syncToNode:function(a){var b="string"==typeof a?this.editor.getNode(a):a;return(this.currentCm||{}).cid===b.cid&&(b.set("history",this.currentCm.doc.getHistory()),b.set("text",this.currentCm.getValue())),b},remove:function(a){var b,c=this.getCidAndElem(a),d=c[0],e=c[1],f=editor.getNode(d),g=editor.undo.UndoManager,h=g.makeEmptyCommand(),i=(f.get("before"),this.currentCm);this.editor.undo.completeSnap(!0),this.beforeDeleteFences(f),i&&i.cid===f.cid?h.undo.push({type:"fences-pos",pos:i.getCursor(),id:i.cid}):h.undo.push(this.editor.selection.buildUndo()),h.undo.push(g.buildReplaceUndo(f)),f.set("type",f.TYPE.paragraph),f.set("text",""),m.normalizeNode(f),h.redo.push(g.buildReplaceUndo(f)),b=j(j.parseHTML(f.toHTML())[0]),e.replaceWith(b),editor.selection.jumpIntoElemEnd(b),h.redo.push(editor.selection.buildUndo()),editor.undo.register(h),this.currentCm=void 0,this.renderAll()},deletionMonitor:function(a){var b=this;a.find(".md-mathjax-panel[cid]").toArray().map(function(a){b.currentCm.cid===a.getAttribute("cid")&&this.beforeDeleteFences(a.getAttribute("cid"))})},beforeDeleteFences:function(a,b){var c=this.syncToNode(a);this.currentCm=void 0;var d=this.editor.findElemById(a);d=d&&d.find("script")[0],d&&d.MathJax&&File.option.autoNumberingForMath?t.call(this):v()&&g(c),b&&b.map(function(a){a&&(a.id==c.id&&a.json&&a.json.content&&a.json.content.type==c.TYPE.math_block?(a.json.content.text=c.get("text"),a.json.content.history=c.get("history")):Array.isArray(a.json)&&a.json.map(function(a){a.id==c.id&&a.content.type==c.TYPE.math_block&&(a.content.text=c.get("text"),a.content.history=c.get("history"))}))})},stopEditing:function(a,b){if(a=a||(this.currentCm||{}).cid){var c=this.getCidAndElem(a),d=c[0],e=c[1],f=e[0].querySelectorAll(".mathjax-candidate"),g="hidden"===f[0].style.visibility?f[1]:f[0],i=this.syncToNode(d),k=this;if(g.className="mathjax-block",g.setAttribute("cid",d),g.setAttribute("mdtype","math_block"),g.setAttribute("id","math-jax"+d),e.replaceWith(j(g)),b){var l=i.getVeryFirstBrotherIncludeTopBlock(!1);l?(this.editor.selection.jumpIntoElemBegin(this.editor.findElemById(l.id)),this.editor.refocus()):window.getSelection().removeAllRanges()}this.currentCm=void 0,File.option.autoNumberingForMath&&w.isDirty?(w.Init(),this.forceRefresh()):(g.querySelector("script").MathJax=void 0,MathJax.Hub.Queue(["BeforeRender",w,i],["Typeset",MathJax.Hub,g.getAttribute("id")],["AfterRender",w,i]),MathJax.Hub.Queue(function(){void 0!==k.startNumber&&(h.startNumber=Math.max(k.startNumber,h.startNumber),h.number=h.startNumber,k.startNumber=void 0,w.Init())}))}},startEditing:function(a,b,c){function d(){if(File.option.autoNumberingForMath){var a=this.editor.findElemById(n.id).find("script")[0];w.startNumber=this.startNumber=void 0,a&&a.MathJax&&void 0!==a.MathJax.startNumber&&(this.startNumber=v().startNumber,w.startNumber=a.MathJax.startNumber,a.MathJax=void 0),void 0==w.startNumber&&File.option.autoNumberingForMath&&(w.startNumber=(v()||{}).startNumber||0)}}function e(a){var b=i(o[0].querySelector(".md-mathjax-input"),{styleSelectedText:!0,styleActiveLine:!0,lineWrapping:!0,mode:"stex",placeholder:"Input Math Tex here",theme:" inner",autoCloseBrackets:!File.option.noPairingMatch,autoCloseTags:!File.option.noPairingMatch,value:n.get("text").trim(),lineNumbers:File.option.showLineNumbersForFence,dragDrop:!1},a,l);return n.get("history")&&b.setHistory(n.get("history")),b.doc.on("change",function(c){w.getTextFunc&&w.Update(),a.syncChange([{type:"sync",id:n.id,tex:b.getValue()}])}),b.on("blur",function(a){try{n.set("history",a.doc.getHistory()),n.set("text",a.getValue())}catch(b){console.warn(b.stack)}}),b.on("focus",function(b){a.undo.completeSnap(!0),a.refocus(n.id)}),b.on("keydown",function(b,c){var d=c.which||c.keyCode,e=i.keyName(c);!c.metaKey&&!c.shiftKey&&!c.ctrlKey;if("Up"==i.keyNames[d])return a.selection.moveUpOrDown(!0,c),c.codemirrorIgnore;if("Down"==i.keyNames[d])return a.selection.moveUpOrDown(!1,c),c.codemirrorIgnore;if("Backspace"==i.keyNames[d]){if(!b.getValue().length)return a.mathBlock.remove(b.cid),c.preventDefault(),c.codemirrorIgnore}else if("Enter"==i.keyNames[d]&&(c.ctrlKey||c.metaKey))return setTimeout(function(){a.UserOp.insertParagraph()},20),c.stopPropagation(),c.codemirrorIgnore;(i.keyMap.macDefault[e]||i.keyMap.pcDefault[e])&&c.stopPropagation()}),a.refocus(n.id),b.focus(),b}function f(a,b,c,d){var e=a.querySelector(".CodeMirror").CodeMirror,f=a.querySelector(".md-mathjax-preview");f.textContent="$$\n"+e.getValue()+"\n$$",w.Init(f,a.querySelector(".md-mathjax-buffer"),function(){var a=b.doc.getValue().trim();return"$$\n"+(a||"<Empty \\space Math \\space Block>")+"\n$$"},c),w.startNumber=d,MathJax.Hub.Queue(["BeforeRender",w,c,!1],["Typeset",MathJax.Hub,f]),w.Update()}function g(a){a.focus(),"<Empty \\space Math \\space Block>"==a.getValue()?a.execCommand("selectAll"):a.execCommand("goDocEnd")}if(c){var h=this;return this.forceRefresh(),void MathJax.Hub.Queue(function(){h.startEditing(a,b)})}var k=this.getCidAndElem(a),l=k[0],m=k[1],n=(this.editor,this.editor.getNode(l));if(l)if(this.currentCm&&this.currentCm.cid===l)this.currentCm.focus();else{this.currentCm&&(this.stopEditing(this.currentCm.cid),window.getSelection().removeAllRanges(),this.editor.refocus(null)),d.call(this);var o=j("#componenet>.md-mathjax-panel").clone(!0).attr("cid",l).attr("mdtype",p.math_block);o.children(".code-tooltip-p").removeClass("code-tooltip-p").addClass("code-tooltip"),m.replaceWith(o),this.currentCm=e(this.editor),f(o[0],this.currentCm,n,w.startNumber),g(this.currentCm)}return this.currentCm},copyAsTex:function(a){var b=j(a||document.activeElement).closest("[cid]").find("script")[0].textContent.trim();console.debug(b),this.editor.UserOp.setClipboard(null,null,b,!0)},copyAsMathML:function(a){var b=MathJax.Hub.getAllJax(j(a||document.activeElement).closest("[cid]")[0])[0],c=this.editor;u(b,function(a){console.debug(a),c.UserOp.setClipboard("<pre class='md-fences' lang='xml'>"+n.escape(a)+"</pre>",null,a,!0)})},copyAsImage:function(a){var b=(a&&a.querySelector||document.activeElement).querySelector("svg"),c=this.editor,d=c.EditHelper.SVG2HtmlImg(b);c.UserOp.setClipboard(d,null,d,!0)},forceRefresh:function(){File.editor.sourceView.inSourceMode||(console.debug("refresh all mathjax"),this.currentCm&&(this.stopEditing(this.currentCm.cid),window.getSelection().removeAllRanges(),this.editor.refocus(null)),f(),window.svgCache={},this.editor.brush.clearAndPause(),t.call(this),File.option.enableInlineMath?MathJax.Hub.Queue(["Typeset",MathJax.Hub,document.querySelector("#write")]):j(".mathjax-block").each(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub,this])}),this.editor.mathInline.renderAll(!0),MathJax.Hub.Queue(function(){this.editor.brush.resume()}))}}),t=function(){this.currentCm&&(self.stopEditing(self.currentCm.cid),window.getSelection().removeAllRanges(),this.editor.refocus(null));for(var a=document.querySelectorAll("script"),b=0;b<a.length;b++)a[b].MathJax&&(a[b].MathJax=void 0);v()&&(h.labels=h.eqlabels=h.IDs=h.eqIDs={},h.refs=[],this.startNumber=h.number=h.startNumber=0,w.Init())},u=function(a,b){var c;try{c=a.root.toMathML("")}catch(d){if(!d.restart)throw d;return MathJax.Callback.After([u,a,b],d.restart)}MathJax.Callback(b)(c)},v=function(){return h=MathJax.Extension["TeX/AMSmath"]},w={delay:0,preview:null,buffer:null,timeout:null,mjRunning:!1,oldText:null,maxIgnored:3,curIgnored:0,startNumber:void 0,originalEnd:void 0,isDirty:!1,Init:function(a,b,c,d){this.preview=a,this.buffer=b,this.getTextFunc=c,this.node=d,this.originalEnd=void 0,this.isDirty=!1,this.startNumber=void 0},SwapBuffers:function(){var a=this.preview,b=this.buffer;this.buffer=a,this.preview=b,a.style.visibility="hidden",a.style.position="absolute",b.style.position="",b.style.visibility=""},Update:function(){this.callback()},CreatePreview:function(){if(this.curIgnored=0,w.timeout=null,!this.mjRunning){var a=this.getTextFunc();a!==this.oldtext&&(this.buffer.textContent=this.oldtext=a,this.mjRunning=!0,MathJax.Hub.Queue(["BeforeRender",this,this.node,!1],["Typeset",MathJax.Hub,this.buffer],["AfterRender",this,this.node],["PreviewDone",this,this.node]))}},PreviewDone:function(){this.mjRunning=!1,this.SwapBuffers()},BeforeRender:function(a,b){v()&&(b?(a.unset("mathLabel"),a.unset("mathEqLabel")):g(a),void 0!==this.startNumber&&(h.startNumber=h.number=this.startNumber))},AfterRender:function(a){File.option.autoNumberingForMath&&v()&&(this.isDirty||(void 0===this.originalEnd?this.originalEnd=h.startNumber:this.isDirty=this.originalEnd!==h.startNumber))}};w.callback=MathJax.Callback(["CreatePreview",w]),w.callback.autoReset=!0,s.Preview=w,c.exports=s}),define("codemirror/addon/display/placeholder",["codemirror/lib/codemirror"],function(a,b,c){"use strict";var d=a("codemirror/lib/codemirror");!function(){function a(a){a.state.placeholder&&(a.state.placeholder.parentNode.removeChild(a.state.placeholder),a.state.placeholder=null)}function b(b){a(b);var c=b.state.placeholder=document.createElement("pre");c.style.cssText="height: 0; overflow: visible",c.className="CodeMirror-placeholder",c.appendChild(document.createTextNode(b.getOption("placeholder"))),b.display.lineSpace.insertBefore(c,b.display.lineSpace.firstChild)}function c(a){f(a)&&b(a)}function e(c){var d=c.getWrapperElement(),e=f(c);d.className=d.className.replace(" CodeMirror-empty","")+(e?" CodeMirror-empty":""),e?b(c):a(c)}function f(a){return 1===a.lineCount()&&""===a.getLine(0)}d.defineOption("placeholder","",function(b,f,g){var h=g&&g!=d.Init;if(f&&!h)b.on("blur",c),b.on("change",e),e(b);else if(!f&&h){b.off("blur",c),b.off("change",e),a(b);var i=b.getWrapperElement();i.className=i.className.replace(" CodeMirror-empty","")}f&&!b.hasFocus()&&c(b)})}()}),define("codemirror/mode/stex/stex",[],function(a,b,c){var d=a("codemirror/lib/codemirror");d.defineMode("stex",function(){function a(a,b){a.cmdState.push(b)}function b(a){return a.cmdState.length>0?a.cmdState[a.cmdState.length-1]:null}function c(a){var b=a.cmdState.pop();b&&b.closeBracket()}function d(a){for(var b=a.cmdState,c=b.length-1;c>=0;c--){var d=b[c];if("DEFAULT"!=d.name)return d}return{styleIdentifier:function(){return null}}}function e(a,b,c){return function(){this.name=a,this.bracketNo=0,this.style=b,this.styles=c,this.argument=null,this.styleIdentifier=function(){return this.styles[this.bracketNo-1]||null},this.openBracket=function(){return this.bracketNo++,"bracket"},this.closeBracket=function(){}}}function f(a,b){a.f=b}function g(c,e){var g;if(c.match(/^\\[a-zA-Z@]+/)){var l=c.current().slice(1);return g=k[l]||k.DEFAULT,g=new g,a(e,g),f(e,j),g.style}if(c.match(/^\\[$&%#{}_]/))return"tag";if(c.match(/^\\[,;!\/\\]/))return"tag";if(c.match("\\["))return f(e,function(a,b){return i(a,b,"\\]")}),"keyword";if(c.match("$$"))return f(e,function(a,b){return i(a,b,"$$")}),"keyword";if(c.match("$"))return f(e,function(a,b){return i(a,b,"$")}),"keyword";var m=c.next();return"%"==m?(c.eol()||f(e,h),"comment"):"}"==m||"]"==m?(g=b(e))?(g.closeBracket(m),f(e,j),"bracket"):"error":"{"==m||"["==m?(g=k.DEFAULT,g=new g,a(e,g),"bracket"):/\d/.test(m)?(c.eatWhile(/[\w.%]/),"atom"):(c.eatWhile(/[\w\-_]/),g=d(e),"begin"==g.name&&(g.argument=c.current()),g.styleIdentifier())}function h(a,b){return a.skipToEnd(),f(b,g),"comment"}function i(a,b,c){if(a.eatSpace())return null;if(a.match(c))return f(b,g),"keyword";if(a.match(/^\\[a-zA-Z@]+/))return"tag";if(a.match(/^[a-zA-Z]+/))return"variable-2";if(a.match(/^\\[$&%#{}_]/))return"tag";if(a.match(/^\\[,;!\/]/))return"tag";if(a.match(/^[\^_&]/))return"tag";if(a.match(/^[+\-<>|=,\/@!*:;'"`~#?]/))return null;if(a.match(/^(\d+\.\d*|\d*\.\d+|\d+)/))return"number";var d=a.next();return"{"==d||"}"==d||"["==d||"]"==d||"("==d||")"==d?"bracket":"%"==d?(a.eol()||a.skipToEnd(),"comment"):"error"}function j(a,d){var e,h=a.peek();return"{"==h||"["==h?(e=b(d),e.openBracket(h),a.eat(h),f(d,g),"bracket"):/[ \t\r]/.test(h)?(a.eat(h),null):(f(d,g),c(d),g(a,d))}var k={};return k.importmodule=e("importmodule","tag",["string","builtin"]),k.documentclass=e("documentclass","tag",["","atom"]),k.usepackage=e("usepackage","tag",["atom"]),k.begin=e("begin","tag",["atom"]),k.end=e("end","tag",["atom"]),k.DEFAULT=function(){this.name="DEFAULT",this.style="tag",this.styleIdentifier=this.openBracket=this.closeBracket=function(){}},{startState:function(){return{cmdState:[],f:g}},copyState:function(a){return{cmdState:a.cmdState.slice(),f:a.f}},token:function(a,b){return b.f(a,b)}}}),d.defineMIME("text/x-stex","stex"),d.defineMIME("text/x-latex","stex")}),define("app/editor/MathInline",["jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/editor/UndoManager","app/editor/KeyMaster","app/editor/EditHelper","rangy/rangy-core","rangy/rangy-classapplier"],function(a,b,c){"use strict";var d=a("jquery/jquery"),e=a("exoskeleton-master/exoskeleton"),f=a("app/document/Node"),g=(f.Node,a("app/editor/UndoManager"),a("app/editor/KeyMaster")),h=a("app/editor/EditHelper"),i=(g.map,a("app/document/StringUtils")),j=a("rangy/rangy-core.js");a("rangy/rangy-classapplier"),/Apple Computer/.test(navigator.vendor);window.svgCache={};var k=function(a){var b=d(a),c=b.textExcludeSVG().replace(/\u200B*/g,"");if(!/^\$+$/.exec(c))return MathJax.Hub.Queue(["Typeset",MathJax.Hub,a],function(){if(a.querySelector(".noError")&&a.querySelector("script").classList.add("math-jax-error"),!a.classList.contains("math-jax-postprocess")){var d=b.parent().attr("pattern")||"$",e=b.removeClass("math-jax-preprocess").addClass("math-jax-postprocess").before("<span class='md-before md-meta'>"+d+"</span>").after("<span class='md-math-after-sym'></span><span class='md-after md-meta'>"+d+"</span>")[0].innerHTML;/^\$/.exec(c)||(c=d+c+d),svgCache[c]=h.processExportedSVG(e)}}),!0},l=function(a,b,c,d){if(b.length){!d&&MathJax.Hub.Queue(function(){a.brush.pause()}),MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"]);for(var e=0;e<b.length;e++)k(b[e]);c&&MathJax.Hub.Queue(function(){a.undo.exeCommand(c)}),!d&&MathJax.Hub.Queue(function(){a.brush.resume()})}},m=function(){var a=this.editor;d(this.editor.sessionStr).on("cursorChange",function(b){var c,e=b.cursor||a.selection.getRangy();return e?(c=d(e.commonAncestorContainer).closest(".md-inline-math.md-expand"),void(c.length?o(a,c):p(a))):p(a)}).on("mousedown",".md-inline-math svg",function(b){p(a),d(".md-expand").removeClass("md-expand");var c=d(this).closest(".md-inline-math"),e=c.addClass("md-expand").find("script");a.selection.selectAllElem(e),o(a,c)})},n=null,o=function(a,b){var c=d("#math-inline-preview"),e=d("#math-inline-preview-content"),f=b.clone().find("svg").remove().end().text();n=function(){var b=MathJax.Hub.getAllJax(e[0])[0],f=d(".md-inline-math.md-expand"),g=f.attr("pattern"),i=f.find("script"),j=(i.text()||f.find(".math-jax-preprocess").text()).replace(/\u200B*/g,""),k=n;if(b)return i.height()?void(svgCache[j]||MathJax.Hub.Queue(["Text",b,j.replace("$$"==g?/(^\$\$)|(\$\$$)/g:/(^\$)|(\$$)/g,"")],function(){h.fixPopoverPosition(i,c)})):d(a.sessionStr).off("inline-math-changed",k)},(c.hasClass("md-math-inline-prep-preview")||"none"===c[0].style.display)&&/^\$/.exec(f)&&(c.removeClass("md-math-inline-prep-preview"),MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"]),e.text(f),MathJax.Hub.Queue(["Typeset",MathJax.Hub,e[0]],function(){c.show(),h.fixPopoverPosition(b.find("script"),c),d(a.sessionStr).on("inline-math-changed",n)}))},p=function(a){var b=d("#math-inline-preview");"none"!==b[0].style.display&&b.hide(),n&&(d(a.sessionStr).off("inline-math-changed",n),n=null)},q=function(){var a=this.editor.selection.getRangy();return d(a.commonAncestorContainer).closest(".md-inline-math")},r=function(a,b){var c;try{c=a.root.toMathML("")}catch(d){if(!d.restart)throw d;return MathJax.Callback.After([r,a,b],d.restart)}MathJax.Callback(b)(c)},s=e.Model.extend({initialize:function(a){this.editor=a,this.queue={},m.call(this),this.mathPrepApplier=j.createClassApplier("md-math-prep")},brushSpan:function(a){l.call(this,this.editor,[a],null,!0)},brush:function(a,b,c){var d=a.querySelectorAll(".math-jax-preprocess");return l.call(this,this.editor,d,b&&a.getAttribute("cid")===b.startId?b:null),d.length},showAutoSuggest:function(a){if(File.option.enableInlineMath){d(".md-math-prep").removeClass("md-math-prep"),this.mathPrepApplier.applyToRange(a);var b=d("#math-inline-preview").show().addClass("md-math-inline-prep-preview").css("width","auto");b.find("#math-inline-preview-content").text("<Empty Inline Math>"),h.fixPopoverPosition(d(".md-math-prep"),b)}},renderAll:function(a){a&&d(".math-jax-postprocess").parent().toArray().forEach(function(a){var b=a.getAttribute("pattern")||"$";a.innerHTML="<span class='inline-math-svg math-jax-preprocess'>"+b+i.escape(a.querySelector("script").textContent)+b+"</span></span>"});var b=document.querySelectorAll(".math-jax-preprocess");l.call(this,this.editor,b)},tryCloseInlinePreview:function(){p(this.editor)},copyAsTex:function(){var a=q.call(this),b=a.attr("pattern"),c=a.text().replace("$$"==b?/(^\$\$)|(\$\$$)/g:/(^\$)|(\$$)/g,"");console.debug(c),this.editor.UserOp.setClipboard(null,null,c,!0)},copyAsMathML:function(){var a=d("#math-inline-preview-content")[0],b=MathJax.Hub.getAllJax(a)[0],c=this.editor;r(b,function(a){console.debug(a),c.UserOp.setClipboard("<pre class='md-fences' lang='xml'>"+i.escape(a)+"</pre>",null,a,!0)})},copyAsImage:function(){var a=document.querySelector("#math-inline-preview-content svg"),b=this.editor,c=b.EditHelper.SVG2HtmlImg(a);b.UserOp.setClipboard(c,null,c,!0)}});c.exports=s}),define("rangy/rangy-classapplier",[],function(a,b,c){"use strict";var d=a("rangy/rangy-core");!function(a){a.createModule("ClassApplier",["WrappedSelection"],function(a,b){function c(a,b){for(var c in a)if(a.hasOwnProperty(c)&&b(c,a[c])===!1)return!1;return!0}function d(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function e(a,b){return a.className&&new RegExp("(?:^|\\s)"+b+"(?:\\s|$)").test(a.className)}function f(a,b){a.className?e(a,b)||(a.className+=" "+b):a.className=b}function g(a){return a&&a.split(/\s+/).sort().join(" ")}function h(a){return g(a.className)}function i(a,b){return h(a)==h(b)}function j(a,b,c,d,e){var f=a.node,g=a.offset,h=f,i=g;f==d&&g>e&&++i,f!=b||g!=c&&g!=c+1||(h=d,i+=e-c),f==b&&g>c+1&&--i,a.node=h,a.offset=i}function k(a,b,c){a.node==b&&a.offset>c&&--a.offset}function l(a,b,c,d){-1==c&&(c=b.childNodes.length);for(var e,f=a.parentNode,g=H.getNodeIndex(a),h=0;e=d[h++];)j(e,f,g,b,c);b.childNodes.length==c?b.appendChild(a):b.insertBefore(a,b.childNodes[c])}function m(a,b){for(var c,d=a.parentNode,e=H.getNodeIndex(a),f=0;c=b[f++];)k(c,d,e);a.parentNode.removeChild(a)}function n(a,b,c,d,e){for(var f,g=[];f=a.firstChild;)l(f,b,c++,e),g.push(f);return d&&m(a,e),g}function o(a,b){return n(a,a.parentNode,H.getNodeIndex(a),!0,b)}function p(a,b){var c=a.cloneRange();c.selectNodeContents(b);var d=c.intersection(a),e=d?d.toString():"";return""!=e}function q(a){for(var b,c=a.getNodes([3]),d=0;(b=c[d])&&!p(a,b);)++d;for(var e=c.length-1;(b=c[e])&&!p(a,b);)--e;return c.slice(d,e+1)}function r(a,b){if(a.attributes.length!=b.attributes.length)return!1;for(var c,d,e,f=0,g=a.attributes.length;g>f;++f)if(c=a.attributes[f],e=c.name,"class"!=e){if(d=b.attributes.getNamedItem(e),null===c!=(null===d))return!1;if(c.specified!=d.specified)return!1;if(c.specified&&c.nodeValue!==d.nodeValue)return!1}return!0}function s(a,b){for(var c,d=0,e=a.attributes.length;e>d;++d)if(c=a.attributes[d].name,(!b||!J(b,c))&&a.attributes[d].specified&&"class"!=c)return!0;return!1}function t(a,b){return c(b,function(b,c){if("object"==typeof c){if(!t(a[b],c))return!1}else if(a[b]!==c)return!1})}function u(a){var b;return a&&1==a.nodeType&&((b=a.parentNode)&&9==b.nodeType&&"on"==b.designMode||O(a)&&!O(a.parentNode))}function v(a){return(O(a)||1!=a.nodeType&&O(a.parentNode))&&!u(a)}function w(a){return a&&1==a.nodeType&&!P.test(N(a,"display"))}function x(a){if(0==a.data.length)return!0;if(Q.test(a.data))return!1;var b=N(a.parentNode,"whiteSpace");switch(b){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(a.data))return!1}return w(a.previousSibling)||w(a.nextSibling)}function y(a){var b,c,d=[];for(b=0;c=a[b++];)d.push(new I(c.startContainer,c.startOffset),new I(c.endContainer,c.endOffset));return d}function z(a,b){for(var c,d,e,f=0,g=a.length;g>f;++f)c=a[f],d=b[2*f],e=b[2*f+1],c.setStartAndEnd(d.node,d.offset,e.node,e.offset)}function A(a,b){return H.isCharacterDataNode(a)?0==b?!!a.previousSibling:b==a.length?!!a.nextSibling:!0:b>0&&b<a.childNodes.length}function B(a,c,d,e){var f,g,h=0==d;if(H.isAncestorOf(c,a))return a;if(H.isCharacterDataNode(c)){var i=H.getNodeIndex(c);if(0==d)d=i;else{if(d!=c.length)throw b.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+d+" in "+c.data);d=i+1}c=c.parentNode}if(A(c,d)){f=c.cloneNode(!1),g=c.parentNode,f.id&&f.removeAttribute("id");for(var j,k=0;j=c.childNodes[d];)l(j,f,k++,e);return l(f,g,H.getNodeIndex(c)+1,e),c==a?f:B(a,g,H.getNodeIndex(f),e)}if(a!=c){f=c.parentNode;var m=H.getNodeIndex(c);return h||m++,B(a,f,m,e)}return a}function C(a,b){return a.namespaceURI==b.namespaceURI&&a.tagName.toLowerCase()==b.tagName.toLowerCase()&&i(a,b)&&r(a,b)&&"inline"==N(a,"display")&&"inline"==N(b,"display")}function D(a){var b=a?"nextSibling":"previousSibling";return function(c,d){var e=c.parentNode,f=c[b];if(f){if(f&&3==f.nodeType)return f}else if(d&&(f=e[b],f&&1==f.nodeType&&C(e,f))){var g=f[a?"firstChild":"lastChild"];if(g&&3==g.nodeType)return g}return null}}function E(a){this.isElementMerge=1==a.nodeType,this.textNodes=[];var b=this.isElementMerge?a.lastChild:a;b&&(this.textNodes[0]=b)}function F(a,b,e){var f,g,h,i,j=this;j.cssClass=j.className=a;var k=null,l={};if("object"==typeof b&&null!==b){for(e=b.tagNames,k=b.elementProperties,l=b.elementAttributes,g=0;i=T[g++];)b.hasOwnProperty(i)&&(j[i]=b[i]);f=b.normalize}else f=b;j.normalize="undefined"==typeof f?!0:f,j.attrExceptions=[];var m=document.createElement(j.elementTagName);j.elementProperties=j.copyPropertiesToElement(k,m,!0),c(l,function(a){j.attrExceptions.push(a)}),j.elementAttributes=l,j.elementSortedClassName=j.elementProperties.hasOwnProperty("className")?j.elementProperties.className:a,j.applyToAnyTagName=!1;var n=typeof e;if("string"==n)"*"==e?j.applyToAnyTagName=!0:j.tagNames=d(e.toLowerCase()).split(/\s*,\s*/);else if("object"==n&&"number"==typeof e.length)for(j.tagNames=[],g=0,h=e.length;h>g;++g)"*"==e[g]?j.applyToAnyTagName=!0:j.tagNames.push(e[g].toLowerCase());else j.tagNames=[j.elementTagName]}function G(a,b,c){return new F(a,b,c)}var H=a.dom,I=H.DomPosition,J=H.arrayContains,K=H.isHtmlNamespace,L="span",M=function(){function a(a,b,c){return b&&c?" ":""}return function(b,c){b.className&&(b.className=b.className.replace(new RegExp("(^|\\s)"+c+"(\\s|$)"),a))}}(),N=H.getComputedStyleProperty,O=function(){var a=document.createElement("div");return"boolean"==typeof a.isContentEditable?function(a){return a&&1==a.nodeType&&a.isContentEditable}:function(a){return a&&1==a.nodeType&&"false"!=a.contentEditable?"true"==a.contentEditable||O(a.parentNode):!1}}(),P=/^inline(-block|-table)?$/i,Q=/[^\r\n\t\f \u200B]/,R=D(!1),S=D(!0);E.prototype={doMerge:function(a){var b=this.textNodes,c=b[0];if(b.length>1){for(var d,e,f,g,h=H.getNodeIndex(c),i=[],j=0,k=0,l=b.length;l>k;++k){if(d=b[k],e=d.parentNode,k>0&&(e.removeChild(d),e.hasChildNodes()||e.parentNode.removeChild(e),a))for(f=0;g=a[f++];)g.node==d&&(g.node=c,g.offset+=j),g.node==e&&g.offset>h&&(--g.offset,g.offset==h+1&&l-1>k&&(g.node=c,g.offset=j));i[k]=d.data,j+=d.data.length}c.data=i.join("")}return c.data},getLength:function(){for(var a=this.textNodes.length,b=0;a--;)b+=this.textNodes[a].length;return b},toString:function(){for(var a=[],b=0,c=this.textNodes.length;c>b;++b)a[b]="'"+this.textNodes[b].data+"'";return"[Merge("+a.join(",")+")]"}};var T=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],U={};F.prototype={elementTagName:L,elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(a,b,c){var d,e,h,i,j,k,l={};for(var m in a)if(a.hasOwnProperty(m))if(i=a[m],j=b[m],"className"==m)f(b,i),f(b,this.className),b[m]=g(b[m]),c&&(l[m]=b[m]);else if("style"==m){e=j,c&&(l[m]=h={});for(d in a[m])e[d]=i[d],c&&(h[d]=e[d]);this.attrExceptions.push(m)}else b[m]=i,c&&(l[m]=b[m],k=U.hasOwnProperty(m)?U[m]:m,this.attrExceptions.push(k));return c?l:""},copyAttributesToElement:function(a,b){for(var c in a)a.hasOwnProperty(c)&&b.setAttribute(c,a[c])},hasClass:function(a){return 1==a.nodeType&&J(this.tagNames,a.tagName.toLowerCase())&&e(a,this.className)},getSelfOrAncestorWithClass:function(a){for(;a;){if(this.hasClass(a))return a;a=a.parentNode}return null},isModifiable:function(a){return!this.applyToEditableOnly||v(a)},isIgnorableWhiteSpaceNode:function(a){return this.ignoreWhiteSpace&&a&&3==a.nodeType&&x(a)},postApply:function(a,b,c,d){for(var e,f,g,h=a[0],i=a[a.length-1],j=[],k=h,l=i,m=0,n=i.length,o=0,p=a.length;p>o;++o)f=a[o],g=R(f,!d),g?(e||(e=new E(g),j.push(e)),e.textNodes.push(f),f===h&&(k=e.textNodes[0],m=k.length),f===i&&(l=e.textNodes[0],n=e.getLength())):e=null;var q=S(i,!d);if(q&&(e||(e=new E(i),j.push(e)),e.textNodes.push(q)),j.length){for(o=0,p=j.length;p>o;++o)j[o].doMerge(c);b.setStartAndEnd(k,m,l,n)}},createContainer:function(a){var b=a.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,b,!1),this.copyAttributesToElement(this.elementAttributes,b),f(b,this.className),this.onElementCreate&&this.onElementCreate(b,this),b},applyToTextNode:function(a,b){var c=a.parentNode;if(1==c.childNodes.length&&this.useExistingElements&&K(c)&&J(this.tagNames,c.tagName.toLowerCase())&&t(c,this.elementProperties))f(c,this.className);else{var d=this.createContainer(H.getDocument(a));a.parentNode.insertBefore(d,a),d.appendChild(a)}},isRemovable:function(a){return K(a)&&a.tagName.toLowerCase()==this.elementTagName&&h(a)==this.elementSortedClassName&&t(a,this.elementProperties)&&!s(a,this.attrExceptions)&&this.isModifiable(a)},isEmptyContainer:function(a){var b=a.childNodes.length;return 1==a.nodeType&&this.isRemovable(a)&&(0==b||1==b&&this.isEmptyContainer(a.firstChild))},removeEmptyContainers:function(a){for(var b,c=this,d=a.getNodes([1],function(a){return c.isEmptyContainer(a)}),e=[a],f=y(e),g=0;b=d[g++];)m(b,f);z(e,f)},undoToTextNode:function(a,b,c,d){if(!b.containsNode(c)){var e=b.cloneRange();e.selectNode(c),e.isPointInRange(b.endContainer,b.endOffset)&&(B(c,b.endContainer,b.endOffset,d),b.setEndAfter(c)),e.isPointInRange(b.startContainer,b.startOffset)&&(c=B(c,b.startContainer,b.startOffset,d))}this.isRemovable(c)?o(c,d):M(c,this.className)},applyToRange:function(a,b){b=b||[];var c=y(b||[]);a.splitBoundariesPreservingPositions(c),this.removeEmptyElements&&this.removeEmptyContainers(a);var d=q(a);if(d.length){for(var e,f=0;e=d[f++];)this.isIgnorableWhiteSpaceNode(e)||this.getSelfOrAncestorWithClass(e)||!this.isModifiable(e)||this.applyToTextNode(e,c);e=d[d.length-1],a.setStartAndEnd(d[0],0,e,e.length),this.normalize&&this.postApply(d,a,c,!1),z(b,c)}},applyToRanges:function(a){for(var b=a.length;b--;)this.applyToRange(a[b],a);return a},applyToSelection:function(b){var c=a.getSelection(b);c.setRanges(this.applyToRanges(c.getAllRanges()));
},undoToRange:function(a,b){b=b||[];var c=y(b);a.splitBoundariesPreservingPositions(c),this.removeEmptyElements&&this.removeEmptyContainers(a,c);var d,e,f=q(a),g=f[f.length-1];if(f.length){for(var h=0,i=f.length;i>h;++h)d=f[h],e=this.getSelfOrAncestorWithClass(d),e&&this.isModifiable(d)&&this.undoToTextNode(d,a,e,c),a.setStartAndEnd(f[0],0,g,g.length);this.normalize&&this.postApply(f,a,c,!0),z(b,c)}},undoToRanges:function(a){for(var b=a.length;b--;)this.undoToRange(a[b],a);return a},undoToSelection:function(b){var c=a.getSelection(b),d=a.getSelection(b).getAllRanges();this.undoToRanges(d),c.setRanges(d)},isAppliedToRange:function(a){if(a.collapsed||""==a.toString())return!!this.getSelfOrAncestorWithClass(a.commonAncestorContainer);var b=a.getNodes([3]);if(b.length)for(var c,d=0;c=b[d++];)if(!this.isIgnorableWhiteSpaceNode(c)&&p(a,c)&&this.isModifiable(c)&&!this.getSelfOrAncestorWithClass(c))return!1;return!0},isAppliedToRanges:function(a){var b=a.length;if(0==b)return!1;for(;b--;)if(!this.isAppliedToRange(a[b]))return!1;return!0},isAppliedToSelection:function(b){var c=a.getSelection(b);return this.isAppliedToRanges(c.getAllRanges())},toggleRange:function(a){this.isAppliedToRange(a)?this.undoToRange(a):this.applyToRange(a)},toggleSelection:function(a){this.isAppliedToSelection(a)?this.undoToSelection(a):this.applyToSelection(a)},getElementsWithClassIntersectingRange:function(a){var b=[],c=this;return a.getNodes([3],function(a){var d=c.getSelfOrAncestorWithClass(a);d&&!J(b,d)&&b.push(d)}),b},detach:function(){}},F.util={hasClass:e,addClass:f,removeClass:M,hasSameClasses:i,replaceWithOwnChildren:o,elementsHaveSameNonClassAttributes:r,elementHasNonClassAttributes:s,splitNodeAt:B,isEditableElement:O,isEditingHost:u,isEditable:v},a.CssClassApplier=a.ClassApplier=F,a.createCssClassApplier=a.createClassApplier=G})}(d)}),define("app/editor/Brush",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/MarkParser","app/document/Node","app/editor/Inline","app/editor/EditHelper","app/editor/UndoManager","app/editor/Emoji","app/editor/Stylize","rangy/rangy-core","app/editor/UndoManager","app/editor/EditHelper"],function(a,b,c){"use strict";function d(a){var b=a.parent().closest("[md-inline]");return b.length?d(b):a.closest("[md-inline]")}var e=a("exoskeleton-master/exoskeleton"),f=a("app/document/StringUtils"),g=a("app/document/MarkParser"),h=a("app/document/Node"),i=h.Node,j=h.TYPE,k=a("app/editor/Stylize"),l=a("app/editor/UndoManager"),m=l.SnapFlag,n=a("app/editor/EditHelper"),o=a("rangy/rangy-core.js"),p=function(a){this.editor=a,this.queue=[],this.interval=150,this.inline=new g.InlineLexer,this.articleArea=document.querySelector(this.editor.sessionStr),u.call(this)},q=null,r=null,s={},t=function(a,b){if(!a&&!b)return void a.brush.hideAutoComplete();try{a.brush.pause(),r?a.focusCid=r.id||r.startId:a.refocus(void 0,void 0,!0),a.undo.completeSnap(!0);var c=q,d=o.createRange(),e=l.makeEmptyCommand(r||a.selection.buildUndo()),f=a.getNode(a.focusCid);if(e.undo.push(l.buildReplaceUndo(f)),d.moveToBookmark(c),a.selection.deRange(d),d.deleteContents(),d.insertNode(document.createTextNode(b)),c.start=c.start+=b.length,c.end=c.start,a.store(a.focusCid,!0),d.moveToBookmark(c),e.redo.push(l.buildReplaceUndo(f)),a.selection.setRange(d),e.redo.push(a.selection.buildUndo()),a.undo.register(e),"fences"==s.type){var g=f.breakOn(!1,a),h=a.findElemById(g.oldCid);h.replaceWith(g.newHtml),a.selection.jumpIntoElemBegin(a.findElemById(g.nextFocus)),a.undo.register(g.command)}else a.brush.addToQueue(a.focusCid,!0)}catch(i){console.error(i.stack)}a.brush.hideAutoComplete(),a.brush.resume(!0)},u=function(){var a=this.editor;$(document).click(function(b){document.activeElement!==a.brush.articleArea&&a.brush.hideAutoComplete()}),$(".auto-suggest-container").on("mousedown","li[data-content]",function(b){r=a.selection.buildUndo()}).on("click","li[data-content]",function(b){t(a,this.getAttribute("data-content"))})},v=function(a){if(!a||!a.length)return!1;var b=window.getSelection().getRangeAt(0),c=b.getClientRects()[0],d="none"==a[0].style.display,e=c.left-15;return d&&(e=e+200>window.innerWidth?window.innerWidth-200:e,a.css({top:c.bottom+(File.isNode?0:$("content").scrollTop()),left:e}).show()),a.find("[data-page]").hide().filter("[data-page="+s.pageNo+"]").show(),!0};p.prototype={addToQueue:function(a,b){b=b||!1,f.isNullOrEmpty(a)||this.queue.push({cid:a,inlineOnly:b})},run:function(){var a=this;this.timerID||(this.timerID=window.setInterval(function(){a.brushQueue()},this.interval))},clearAndPause:function(){this.queue=[],this.pause()},pause:function(){clearInterval(this.timerID),this.timerID=null},resume:function(a){a&&this.brushQueue(),this.run()},restart:function(){this.queue=[],this.run()},updateWordCount:function(){if(File.isMac)app.document.updateWordCount(n.getWordCount(this.articleArea.innerText));else if(File.isNodeHtml){var a=n.getWordCount(this.articleArea.innerText);$("#footer-word-count").text(a+" Words"),$("#footer-word-count-td").text(a),document.body.classList.contains("pin-outline")&&document.querySelector("#info-panel-tab-file.active")&&File.FileInfoPanel.updateContentAnalyze(a)}},brushNode:function(a){var b=this.editor.selection.buildUndo();y.call(this,a,{},b,!1)&&this.editor.undo.exeCommand(b)},brushQueue:function(){var a=this,b={},c=a.queue.length;if(!this.editor.isIME){if(a.queue.length>0&&!File.isLocked){var d=a.editor.selection.buildUndo(),e=!1;a.queue.map(function(c){b[c.cid]||(e=y.call(a,c.cid,b,d,c.inlineOnly)||e,b[c.cid]=1)}),a.queue=[],e&&d&&a.editor.undo.exeCommand(d),this.expand(!0)}c&&(this.updateWordCount(),this.triggerAutoComplete())}},applyAutocompleteByKey:function(){r=null,t(this.editor,$(".auto-suggest-container:visible .active").attr("data-content"))},triggerAutoComplete:function(a){function b(){if(r&&r.collapsed){var a=$(r.endContainer).closest(".md-lang"),b=a.text(),c=a.prev().text().length;if(b)return q={start:c,end:c+b.length,containerNode:a.closest("[mdtype]")[0]},b}}function c(){var a,b=/\w+$/,c=/^\w+/,e=h+i;f=b.exec(h)||[""],d=c.exec(i)||[""],a=f[0]+d[0];try{if(c.exec(a))return{context:e,start:void 0===f.index?h.length:f.index,length:a.length}}catch(g){}}var d,e,f=null,g=this.editor.selection.getTextAround(),h=g[0],i=g[1],j=g[2],k=this.editor.getJQueryElem((this.editor.selection.getRangy()||{}).commonAncestorContainer),l=k.closest(".md-inline-math").length,n=a&&File.option.enableInlineMath,o=a||File.option.autoToggleEmojiAutoComplete||s.found&&"emoji"==s.type,p=!1,r=this.editor.selection.getRangy();if(j&&r&&r.collapsed&&(h||i)){if(e=b.call(this))return void v(this.editor.fences.showAutoSuggest(e,s));if(o&&(f=z.exec(h)))return d=/^(\w*:*)(\s|$)/.exec(i||""),void(d&&(v(this.editor.emoji.showAutoSuggest(f[1]+d[1],s)),j.start-=f[1].length+1,j.end+=d[1].length,q=j));if(p&&(e=c()))return v(this.editor.word.showAutoSuggest(e.context,e.start,e.length,s)),j.start-=f[0].length,j.end+=d[0].length,void(q=j);if(n&&(e=/\$?\$$/.exec(h))&&0==$(".md-expand.md-inline-math").length){var t,u=(/^\$+/.exec(i)||"").length;if(u<=e[0].length)return t="$".repeat(e[0].length-u),t.length&&(this.editor.undo.snap(editor.focusCid,m.REPLACE),r.insertNode(document.createTextNode(t)),r.collapse(!0)),this.editor.lastCursor=this.editor.selection.buildUndo(),j.start-=e[0].length,j.end+=e[0].length,r.moveToBookmark(j),this.editor.mathInline.showAutoSuggest(r),this.editor.restoreLastCursor(null,!0),void(q=null)}}else{if(!l)return this.hideAutoComplete();k.trigger("inline-math-changed")}this.hideAutoComplete()},changeAutoCompleteSelection:function(a,b){var c,d=$(".auto-suggest-container:visible"),e=d.find(".active");if(d.length&&s.pageCnt){if(b&&b.preventDefault(),!e.length)return void(e=d.find("ul:first>li:first").addClass("active"));e.length&&(e=e.removeClass("active")[a?"prev":"next"]().addClass("active")),e.length||(s.pageNo+=a?-1:1,s.pageNo<0?s.pageNo=s.pageCnt-1:s.pageNo>=s.pageCnt&&(s.pageNo=0),c=d.find("[data-page]").hide().filter("[data-page="+s.pageNo+"]").show(),a?c.find("li:last").addClass("active"):c.find("li:first").addClass("active"))}},hideAutoComplete:function(){s={},q=null,$(".auto-suggest-container").hide()},expand:function(){function a(b,c){if(!b.prevAll(":not(.md-meta, .md-content)").text().length){var d=b.parent();return d.hasClass("[mdtype]")||d[0].contains(c)?b:a(d,c)}return b}function b(a,c){if(!a.nextAll(":not(.md-meta, .md-content)").text().length){var d=a.parent();return d.hasClass("[mdtype]")||d[0].contains(c)?a:b(d,c)}return a}function c(a,b){if(a.commonAncestorContainer.nodeType===document.TEXT_NODE){if(b>0&&a.endOffset+b<=a.commonAncestorContainer.length)return a.setEnd(a.commonAncestorContainer,a.endOffset+b),a;if(0>b&&a.startOffset+b>=0)return a.setStart(a.commonAncestorContainer,a.startOffset+b),a}var c=$(a.startContainer).closest("[cid]")[0],d=a.getBookmark(c);return b>0?d.end+=b:d.start+=b,a.moveToBookmark(d),a}function e(c){try{var d,e=c.commonAncestorContainer;if(0==c.startOffset){var f=editor.getJQueryElem(c.startContainer);f.closest(".md-expand").length||f[0].hasAttribute("cid")||f[0].querySelector("[cid]")||(d=f.closest("[cid]")[0],f=a(f,e.contains&&e.contains(d)?d:e),c.setStartBefore(f[0]))}if(c.endOffset==(c.endContainer.nodeType===document.TEXT_NODE?c.endContainer.length:c.endContainer.childNodes.length)){var g=editor.getJQueryElem(c.endContainer);g.closest(".md-expand").length||g[0].hasAttribute("cid")||g[0].querySelector("[cid]")||(d=g.closest("[cid]")[0],g=b(g,e.contains&&e.contains(d)?d:e),c.setEndAfter(g[0]))}}catch(h){console.warn(h)}return c}if(!this.editor.isIME){var f,g=this.editor.selection,h=g.getRangy(),k=g.rangy,l=h?h.cloneRange():null;if(h&&!File.isLocked){if(this.editor.selection.deRange(h),f=this.editor.getJQueryElem(h.commonAncestorContainer),this.editor.stylize.putBookmark(l,this.editor.stylize.buildBookmark(f)),i.isType(document.activeElement.tagName,"INPUT","TEXTAREA")||document.activeElement.hasAttribute("tabindex"))return $(".md-expand").removeClass("md-expand"),$(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark);if(h.collapsed){var m,n=d(f),o=f.closest("[mdtype]"),p=(o.attr("contenteditable"),[]),q=n.visibleText().length;if(!o.length||i.isType(o.attr("mdtype"),j.fences,j.math_block))return $(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark);window.getSelection().baseOffset===q&&q<n.text().length?(m=n.addClass("md-expand"),l=k.createRange(),l.collapseToPoint(n[0],n[0].childNodes.length),this.editor.selection.setRange(l)):(c(h,-1),m=o[0]!=$(h.startContainer).closest("[mdtype]")[0]?n:d(this.editor.getJQueryElem(h.startContainer)),h.startContainer===h.endContainer&&(h.toString().length&&h.collapse(!1),c(h,1)))}else m=d(this.editor.getJQueryElem(h.startContainer));if(p=d(this.editor.getJQueryElem(h.endContainer)),!p.length&&(p=m),m.length&&p.length){l=e(l,m,p)||l;var r=l&&!l.collapsed;$(".md-expand").removeClass("md-expand"),m.length?x.call(this,m):x.call(this,p),m.length&&p.length&&m.next().is(p)&&!p.hasClass("md-img-loaded")&&x.call(this,p,!0)}else $(".md-expand").removeClass("md-expand");r&&this.editor.selection.setRange(l,!0);var s=window.getSelection().anchorNode;s&&(3===s.nodeType||s.hasAttribute&&s.hasAttribute("contenteditable"))&&this.editor.selection.deRange(this.editor.selection.getRangy(),!0),$(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark)}else f=this.editor.getMarkElem(),$(".md-expand").removeClass("md-expand"),f.length&&i.isType(f.attr("mdtype"),i.TYPE.hr,i.TYPE.toc)&&(this.editor.stylize.putBookmark(null,this.editor.stylize.buildBookmark(f)),$(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark))}},isAutoCompleteShown:function(){return $(".auto-suggest-container:visible").length},focusContainer:function(a){w.call(this,a)}};var w=function(a){var b=a.closest("tr.md-end-block, li[cid]")[0],c=a[0];if(b&&c){for(;b!==c&&b.contains(c);){if(c.previousSibling&&c.previousSibling.hasAttribute&&c.previousSibling.hasAttribute("cid"))return!1;c=c.parentElement}b.classList.add("md-focus-container")}},x=function(a,b){b||($(".md-expand").removeClass("md-expand").closest("[cid]").removeClass("md-focus"),$(".md-focus-container").removeClass("md-focus-container")),a.length&&w(a.addClass("md-expand").trigger("expand").closest("[cid]").addClass("md-focus"))},y=function(a,b,c,d){function f(a){for(var b=0;b<a.attributes.length;b++)i.isType(a.attributes[b].name,"cid","contenteditable","style","id","for","onerror","onload")&&a.removeAttributeNode(a.attributes[b]);a.classList.remove("md-img-loaded"),a.classList.remove("md-img-error")}function h(a){for(var b=a.querySelectorAll("*"),c=0;c<b.length;c++)f(b[c]);f(a)}function l(a,b,c,d,e,f){var g,i=c.innerHtml,j=a.clone(),f=c.cursorDiff,k=$($.parseHTML("<div>"+i+"</div>")[0]);return j.find(".md-inline-math.md-expand").text(function(){return this.textContent}),j.find(".md-expand").removeClass("md-expand"),h(j[0]),h(k[0]),j.html().replace(/\s*class=\"\"/gi,"")!=k.html().replace(/\s*class=\"\"/gi,"")?(a.html(i),c.mdlike?a.attr("mdlike")!=c.mdlike&&a.attr("mdlike",c.mdlike):a.removeAttr("mdlike"),e.mathInline.brush(a[0],d,!0),g=!0):j.find(".math-jax-preprocess").length&&e.mathInline.brush(a[0],d,!0),m(d,f,c.command,b,e)||g}function m(a,b,c,d,f){return b.length&&f.focusCid===d.cid?(a&&(c&&c.undo.unshift(e.utils.clone(a)),a.start=p(b,a.start),a.end=p(b,a.end),c&&c.redo.push(e.utils.clone(a))),f.undo.register(c),!0):!1}function n(a,b,c,d,f){var g=c.cursorDiff||[];return c.replaceCid?f.findElemById(c.replaceCid).replaceWith(c.html):a.closest("p").replaceWith(c.html),c.toRemove&&c.toRemove.forEach(function(a){f.findElemById(a).remove()}),f.focusCid&&f.focusCid!==b.cid||(f.focusCid=c.focus,f.focusCid&&w(f.findElemById(f.focusCid)),d&&(c.command.undo.unshift(e.utils.clone(d)),g.length&&(d.start=p(g,d.start),d.end=p(g,d.end)),d.startId=c.focus,d.endId=c.focus,d.start-=c.offset,d.end-=c.offset,c.command.redo.push(e.utils.clone(d))),f.undo.register(c.command)),!0}function o(a,b,c,d,e){return c.blockChanged?n(a,b,c,d,e):l(a,b,c,d,e)}function p(a,b){var c=b;for(var d in a)void 0!==d&&b>=d&&(c+=a[d]);return c}try{var q,r,s=a,t=a;if("string"==typeof a?s=this.editor.getNode(a):t=s.id,!s)return;if(i.isType(s,j.meta_block))return;if(k.CONST.NoInline.indexOf(s.get("type"))>-1)return;if(s.get("children").length)return s.get("children").toArray().map(function(a){b&&(b[a.id]=1),y.call(this,a,b,c,d)},this),!0;if(q=this.editor.findElemById(t).addClass("md-expand"),s.get("type")==j.def_footnote){var u=[];return r=this.inline.output(q.children(".md-def-content").text(),null,null,null,null,u),q.children(".md-def-content").html(r),m(c,u,null,s,this.editor),!0}var v=File.option.enableInlineMath?q.textExcludeSVG():q.text();return r=g.quickParse(v,this,s,d||!i.isType(s,j.line)),o(q,s,r,c,this.editor)}catch(x){console.debug(x.stack)}},z=/:(\w+)$/;c.exports=p}),define("app/editor/Stylize",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core"],function(a,b,c){"use strict";var d=a("exoskeleton-master/exoskeleton"),e=a("app/document/StringUtils"),f=a("app/document/Node"),g=a("app/editor/UndoManager"),h=g.SnapFlag,i=f.Node,j=f.TYPE,k=f.NodeCollectionUtils,l=a("rangy/rangy-core.js"),m=function(){return File.isMac?app.clipboard.paste():File.isNode?reqnode("electron").remote.clipboard.readText():""},n=function(a,b,c,d){function e(a){var d=a.find('[md-inline="'+b+'"]').children(".md-meta");c&&(c.end-=d.text().length),d.remove()}var f=l.createRange();if(a[0].hasAttribute("mdtype")&&(a.wrapInner("<span></span>"),a=$(a[0].firstChild)),c?(c.containerNode=a[0],f.moveToBookmark(c)):f.selectNode(a[0]),f.commonAncestorContainer.nodeType==document.ELEMENT_NODE&&f.commonAncestorContainer.getAttribute("md-inline")==b)e($(f.commonAncestorContainer));else{for(var g=document.createElement("SPAN"),h=f.extractContents(),i=0;i<h.childNodes.length;i++)g.appendChild(h.childNodes[i].cloneNode(!0));e($(g)),f.insertNode(g),f.selectNode(g)}p.call(this,f,b,a[0],d?c:null)},o=function(a,b){return b.collapsed&&a[2]===a[1]&&i.isType(a[1],j.line)?[a[0],a[1].getLastBrother(!0),a[1].getLastBrother(!1)]:a},p=function(a,b,c,d){console.debug("surroundStyle"+b);var f,g,h,k,l,n,o=s.SyntaxMap[b];if(d){var p,q=this.editor.getJQueryElem(a.startContainer),r=this.editor.getJQueryElem(a.endContainer);if(q.closest("md-before").length||q.closest("md-content").length?(a.setStartBefore(q.closest("[md-inline]")[0]),p=!0):q.closest("md-meta").length&&(a.setStartAfter(q.closest("[md-inline]")[0]),p=!0),r.closest("md-after").length||q.closest("md-content").length?(a.setEndAfter(q.closest("[md-inline]")[0]),p=!0):r.closest("md-meta").length&&(a.setEndBefore(q.closest("[md-inline]")[0]),p=!0),f=a.toString(),a.collapsed||0===f.trim())return;g=p?g||a.getBookmark(c||a.commonAncestorContainer):d instanceof Object?d:{start:d,end:d}}else f=a.toString();h=/^\s+/g.exec(f),k=/\s+$/g.exec(f),h=h?h[0].length:0,k=k?k[0].length:0,(h||k)&&(g=g||a.getBookmark(c||a.commonAncestorContainer),g.start+=h,g.end-=k,a.moveToBookmark(g)),l=o[1],n=m(),i.isType(b,j.link)&&(e.isURL(f)?l="]("+f+")":e.isURL(n)&&(l="]("+n+")")),i.isType(b,j.image)&&(e.isImg(f)?l="]("+f+")":e.isImg(n)&&(l="]("+n+")")),a.insertNodeAtEnd(document.createTextNode(l)),a.insertNode(document.createTextNode(o[0])),d&&(i.isType(b,j.link)?a.moveToBookmark({containerNode:c,start:g.start+1,end:1+g.end}):a.moveToBookmark({containerNode:c,start:g.start+o[0].length,end:g.end+o[0].length}),editor.selection.setRange(a))},q=function(a,b){function c(a){var e=a.get("children");return e.length?e.toArray().map(c):d.stylize.canContainInline(a.get("type"))&&(d.stylize.putStyleInBlock(d.findElemById(a.id),b,void 0,void 0,!0),d.store(a),d.brush.addToQueue(a.id)),a}var d=this.editor,e=d.selection.getDetailPos(a.startContainer,a.startOffset),f=d.selection.getDetailPos(a.endContainer,a.endOffset),h=d.getMarkElem(e[0]),j=d.getMarkElem(f[0]),k=d.findNodeByElem(h),l=d.findNodeByElem(j),m=i.getTreePosition(k,l),n=m[1],o=m[2],p=g.makeEmptyCommand(d.selection.buildUndo()),q=a.cloneRange(),r=a.cloneRange(),s=n;for(p.undo.push(g.buildReplaceUndo(n)),r.setEndAfter(h[0]),this.canContainInline(k)&&(this.putStyleInBlock(h,b,r.getBookmark(h[0]),void 0,!0),d.store(k,!0)),d.UserOp.decorateOneSide(k,n,"after",c),p.redo.push(g.buildReplaceUndo(n)),d.brush.addToQueue(h.attr("cid")),s=n.get("after");s&&s!==o;)p.undo.push(g.buildReplaceUndo(s)),c(s),p.redo.push(g.buildReplaceUndo(s)),s=s.get("after");l&&l!=n&&(q.setStartBefore(j[0]),p.undo.push(g.buildReplaceUndo(o)),this.canContainInline(l)&&(this.putStyleInBlock(j,b,q.getBookmark(j[0]),void 0,!0),d.store(l,!0)),d.UserOp.decorateOneSide(l,o,"before",c),p.redo.push(g.buildReplaceUndo(o)),d.brush.addToQueue(j.attr("cid"))),p.redo.push(d.selection.buildUndo()),d.undo.register(p),$(".md-expand").removeClass("md-expand")},r=d.Model.extend({initialize:function(a){this.editor=a,this.CONST=s,this.putBookmark(null,{block:[]})},removeStyle:function(a,b,c){a.children(".md-meta").remove()},canContainInline:function(a){return a.jquery&&(a=a.attr("mdtype")),i.isType(a,j.line,j.def_footnote,j.heading,j.table_cell)},putStyle:function(a,b){this.editor.selection.deRange(a);var c=this.editor.getMarkElem(a.commonAncestorContainer),d=s.InsertInline.indexOf(b)>-1;if(d&&(c=this.editor.getMarkElem(a.startContainer)),c.length&&0===c.find("[mdtype]").length&&this.canContainInline(c)){var e=g.makeEmptyCommand(this.editor.selection.buildUndo()),f=this.editor.store(c.attr("cid"));e.undo.push(g.buildReplaceUndo(f)),this.putStyleForRange(c,b,a,!0),this.editor.store(c.attr("cid")),e.redo.push(g.buildReplaceUndo(f)),e.redo.push(this.editor.selection.buildUndo()),this.editor.undo.register(e),this.editor.brush.addToQueue(f.id,!0)}else if(!d)return q.call(this,a,b)},putStyleInBlock:function(a,b,c,d,e){if(!e||0!=a.text().length){a[0].hasAttribute("mdtype")&&a.addClass("md-expand");try{n.call(this,a,b,c,d)}catch(f){console.error(f)}}},putStyleForRange:function(a,b,c,d){var e=c.getBookmark(a[0]);a[0].hasAttribute("mdtype")&&c.commonAncestorContainer.nodeType!=document.TEXT_NODE&&a.addClass("md-expand"),n.call(this,a,b,e,d)},addStyle:function(a,b){console.debug("addStyle "+b);var c,d=s.SyntaxMap[b],f=document.createElement("SPAN");f.className="md-meta md-expand",f.setAttribute("md-inline",b),"link"==b&&(c=m(),e.isURL(c)&&(d[1]="]("+c+")")),f.appendChild(document.createTextNode(d[0]+d[1])),a.insertNode(f),a.moveToBookmark({containerNode:f,start:d[0].length,end:d[0].length}),this.editor.selection.rangy.getSelection().setSingleRange(a)},detach:function(a,b){var c;return a.collapsed&&(c=$.parseHTML("<div>"+a.toHtml()+"</div>")[0],c.querySelector('[md-inline="'+b+'"]'))?!0:$(a.commonAncestorContainer).closest('[md-inline="'+b+'"]').length},canToggleStyle:function(a,b,c){var d=function(a){for(var b=0;b<a.CONST.NoInline.length;b++)if(a.hasStyle(a.CONST.NoInline[b]))return!0}(this);return this.hasStyle(a)?!0:d||/(md-meta|md-content)(\s+|$)/g.exec(b[0].className)&&!c||/md-blockmeta/g.exec(b[0].className)?!1:!d},clearStyle:function(){if(window.getSelection().rangeCount&&"INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&!File.isLocked){this.editor.brush.pause(!0),this.editor.undo.completeSnap(!0);var a=this.editor.selection.getRangy();if(a){for(var b,c=g.makeEmptyCommand(editor.selection.buildUndo()),d=editor.selection.getDetailPos(a.startContainer,a.startOffset),e=editor.selection.getDetailPos(a.endContainer,a.endOffset),f=editor.getMarkElem(d[0]),h=editor.getMarkElem(e[0]),j=editor.findNodeByElem(f),k=editor.findNodeByElem(h),l=i.getTreePosition(j,k),m=l[1],n=l[2],o=m;o&&o!=n.get("after");)b=o,o=o.get("after"),c.undo.push(g.buildReplaceUndo(b)),this.editor.findElemById(b.id).find(".md-meta, .md-content").remove(),this.editor.store(b.id),this.editor.brush.addToQueue(b.id),c.redo.push(g.buildReplaceUndo(b));this.editor.undo.register(c)}this.editor.brush.resume(),this.editor.brush.expand()}},toggleStyle:function(a){function b(a,b){return!b||a.collapsed&&/^[\(\)\[\]\^&_\-+*#@!~`\\\/\{\}'":;<>,.?%\s]+$/.exec(b)}if(!File.isLocked&&window.getSelection().rangeCount&&"INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&!File.isLocked){var c,d=this.editor.selection.getRangy(),e=this.hasStyle(a),f=this.editor.getJQueryElem(d.commonAncestorContainer),g=this.editor.getMarkElem(d.commonAncestorContainer),k=g.attr("cid"),l=i.isType(a,j.link,j.image)&&a;if(this.editor.undo.completeSnap(!0),k&&this.editor.undo.snap(k,h.REPLACE),!e){var m=this.editor.getJQueryElem(d.startContainer);"link"==a&&(e=m.closest('[md-inline="reflink"], [md-inline="autolink"]').length),"image"==a&&(e=m.closest('[md-inline="refimg"], .md-url').length)}this.editor.brush.pause();do{if(!this.canToggleStyle(a,f,d.collapsed)){console.debug("cannot toggle style");break}if(e){var n,o=f.closest('[md-inline="'+a+'"]');o.length||"link"!=a||(o=f.closest('[md-inline="reflink"], [md-inline="autolink"]')),"image"==a&&(o.length?n=/!\[([^\]]*)\]/.exec(o.text())[1]:n||(o=f.closest('[md-inline="refimg"]'),o.length?n=/!\[((?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*)\]/.exec(o.text())[1]:(o=f.closest(".md-url").closest("[md-inline]"),o.length&&(n="!"+o.text())))),a==j.comment&&(n=o.text().replace(/(^<\!--)|(-->)$/g,"")),n?(o.text(n),this.editor.selection.selectAllElem(o)):o.children(".md-meta, .md-content").remove()}else{if(!d.collapsed){this.putStyle(d,a);break}c=d.getBookmark(g[0]).start;var q=g.text(),r=q.substring(c-1,c+1),s="**"==r&&$(d.startContainer).closest("[md-inline='plain']").length;a==j.em&&s?(d.moveToBookmark({containerNode:g[0],start:c-1,end:c+1}),d.extractContents()):b(d,r)?this.addStyle(d,a):(g.addClass("md-expand"),!s&&this.editor.selection.selectWord(l),d=this.editor.selection.getRangy(),d.collapsed?this.addStyle(d,a):p.call(this,d,a,g[0],c))}if(this.editor.brush.addToQueue(g.attr("cid")),a==j.inline_math&&!e){var t=this.editor;setTimeout(function(){t.brush.triggerAutoComplete(!0)},100)}}while(!1);this.editor.brush.resume(!0)}},putBookmark:function(a,b){return this.editor.styleBookmark={cursor:a,style:b}},isAtFootnoteDefSpan:function(){var a=this.editor.selection.getRangy();return a&&this.editor.getJQueryElem(a.startContainer).closest(".md-def-name").length},buildBookmark:function(a){if(File.ignoreStyleChange)return File.editor.styleBookmark.style;var b,c={inline:[],block:[]},d=this.editor.selection.getRangy(),a=a||this.editor.getJQueryElem(d&&d.commonAncestorContainer||document.activeElement)||$(),e=a.closest("[md-inline]"),f=a;if(0==a.length){if(a=this.editor.getMarkElem(),!a.length||!i.isType(a.attr("mdtype"),i.TYPE.hr,i.TYPE.toc))return c;f=a}for(;e.length;)b=e.attr("md-inline"),this.CONST.LinkList.indexOf(b)>-1&&(b="link"),c.inline.push(b),f=e,e=e.parent().closest("[md-inline]");for(e=f.closest("[mdtype]");e.length;)b=e.attr("mdtype"),b===j.heading?c.block.push("header"+e[0].tagName.substring(1)):b===j.list?c.block.push(this.editor.findNodeByElem(e).get("style")):c.block.push(b),e=e.parent().closest("[mdtype]");return c},hasStyle:function(a){var b=this.editor.styleBookmark.style;return b?(b.inline||[]).indexOf(a)>-1||(b.block||[]).indexOf(a)>-1:void 0},changeStyleFromMenu:function(a){if(!File.isLocked){var b=s.NameMapToStyle[a.toLowerCase()];i.isType(b,"header1","header2","header3","header4","header5","header6",j.paragraph)?this.changeBlock(b):i.isType(b,j.def_footnote,j.def_link,j.hr,j.fences,j.math_block,j.toc)?this.insertBlock(b):i.isType(b,j.table)?File.editor.tableEdit.insertTable():i.isType(b,j.meta_block)?this.insertMetaBlock():i.isType(b,j.blockquote)&&this.toggleIndent(j.blockquote)}},changeBlock:function(a,b){function c(a,c){var d,h,i=b.getClosetParagraphLevel();return e(a,c,!0),d=b.separateBlockFromLine(!1),h=(d[0]?d[0].toHTML():"")+d[1].toHTML()+(d[2]?d[2].toHTML():""),d[0]&&g.addUndoForInsert(f,d[0]),d[2]&&g.addUndoForInsert(f,d[2]),m.findElemById(i.id).replaceWith(h),d[1]}function e(a,c,d){return b.set("type",j.heading),b.set("depth",a),b.set("pattern",c),d||(m.findElemById(b.id).replaceWith(b.toHTML()),f.redo.push(g.buildReplaceUndo(b))),b}b=b||this.editor.getNode(null,!0);var f,h,k,l=s.getMenuBlockType(b),m=this.editor,n=b.cid;if(!i.isType(b,j.table,j.table_row,j.table_cell,j.blockquote,j.list)&&!File.isLocked&&(m.lastCursor=m.selection.buildUndo(),l!=a&&l)){if(m.undo.completeSnap(!0),i.isType(l,j.fences)&&(m.fences.syncToNode(b.cid),m.fences.beforeDeleteFences(b)),f=g.makeEmptyCommand(m.lastCursor),f.undo.push(g.buildReplaceUndo(b.getClosetParagraphLevel())),i.isType(l,j.def_link)&&b.set("text",b.get("href")+(b.get("tittle")?' "'+b.get("tittle")+'"':"")),0==a.indexOf("header")?(k=a.substr(6)-0,h=b.get("pattern"),h&&/-|=/.exec(h)?h=2>=k?h.replace(/-|=/g,1==k?"=":"-"):void 0:h&&(h=h.replace(/#+/g,"#".repeat(k))),b=i.isType(b,j.line)?c(k,h):e(k,h)):(b.set("type",a),b.set("pattern",void 0)),i.isType(l,j.meta_block,j.fences)&&i.isType(b,j.paragraph)){b.set("type",j.raw_edit);var o=m.simpleParse(b);m.findElemById(o[2]).replaceWith(o[1]),o&&g.append(f,o[0])}else i.normalizeNode(b),f.redo.push(g.buildReplaceUndo(b)),m.findElemById(b.id).replaceWith(b.toHTML());var p=d.utils.clone(f.undo[0]);p.startId===n&&(p.startId=b.cid),p.endId===n&&(p.endId=b.cid),p.id===n&&(p.id=b.cid),m.undo.exeCommand(p),f.redo.push(p),m.undo.register(f),i.isType(l,j.def_link,j.def_footnote)&&i.isType(a,j.def_link,j.def_footnote)&&m.refresh(),m.refocus()}},insertMetaBlock:function(a,b){if(!File.isLocked){b=b||"";var c=this.editor.nodeMap.getFirst();if(!i.isType(c,j.meta_block)){this.editor.undo.completeSnap(!0),this.editor.lastCursor=this.editor.selection.buildUndo();var d=g.makeEmptyCommand(this.editor.lastCursor||this.editor.selection.buildUndo()),e=new i({type:j.meta_block,"in":this.editor.nodeMap,attachTo:this.editor.nodeMap,after:c,text:b});return g.addUndoForInsert(d,e),a?{command:d,node:e}:(this.editor.findElemById(c.cid).before(e.toHTML()),this.editor.selection.restoreSelection(this.editor.findElemById(e.cid),0),d.redo.push(this.editor.selection.buildUndo()),this.editor.undo.register(d),$(this.editor.sessionStr).trigger("cursorChange"),this.editor.selection.scrollAdjust(),this.editor.refocus(e.cid),e)}}},insertBlock:function(a,b){function c(a,b){a.set("in",b),a.get("children").toArray().map(function(a){c(a,b)})}if(!File.isLocked){var d,e=(this.editor.selection.getRangy(),this.editor.getNode(null,!0)),f=s.getMenuBlockType(e),h=this.editor,k=this.editor.findElemById(e.getClosetParagraphLevel().id);if(this.editor.lastCursor=this.editor.selection.buildUndo(),f==a||!f||!i.isType(e,j.paragraph,j.heading,j.line))return void(b&&b.remove());this.editor.undo.completeSnap(!0),d=g.makeEmptyCommand(this.editor.lastCursor),d.undo.push(g.buildReplaceUndo(e.getClosetParagraphLevel()));var l,m=i.splitAt(e,this.editor.lastCursor.start,h,i.genNormalSplitExitFunc(!1,!0)),n=m.prev,o=b||new i({type:a,text:""}),p=m.next,q="",r=a==j.hr?(p||opt_next||n.get("after")).id:o.id;n.insert(o,!1),g.addUndoForInsert(d,o),d.redo.push(h.undo.buildReplaceUndo(m.prev)),b&&c(b,e.get("in")),p&&i.isEmptyBlock(p)&&a!=j.hr?(p.remove(),p=null):p&&g.addUndoForInsert(d,p),m.opt_next&&g.addUndoForInsert(d,m.opt_next),m.opt_prev&&g.addUndoForInsert(d,m.opt_prev),i.isEmptyBlock(n)&&(g.addUndoForRemove(d,n),n.remove(),n=null),[m.opt_prev,n,o,p,m.opt_next].map(function(a){a&&(q+=a.toHTML())}),k.replaceWith(q),this.editor.refresh(),l=this.editor.findElemById(r),a==j.fences?this.editor.fences.getCm(o.id):a==j.math_block&&this.editor.mathBlock.startEditing(o.id),this.editor.selection.jumpIntoElemBegin(l),this.editor.lastCursor=this.editor.selection.buildUndo(),d.redo.push(this.editor.lastCursor),this.editor.undo.register(d),this.editor.refocus(),$(this.editor.sessionStr).trigger("cursorChange"),this.editor.selection.scrollAdjust()}},toggleIndent:function(a,b){function c(a,b,c){return b=b||a,c&&c.get("type")==j.blockquote?q.collapsed||!a.get("before")&&!b.get("after"):!1}function d(b,d,e){b=b.getClosetBlock(),d=d&&d.getClosetBlock();var f=b.get("parent");if(c(b,d,f))g.addUndoForUnwrap(e,f),f.unwrap(n);else{var h=new i({type:a,"in":b.get("in")});h.wrap(b,d,n),g.addUndoForWrap(e,h),n.refresh()}}function e(a,b){b=(b||a).getClosetParagraphLevel(),a=a.getClosetParagraphLevel();var c=a.get("parent");if(q.collapsed){if(!a.get("before")&&!b.get("after")&&c&&i.isType(c.get("parent"),j.list))return c.get("parent")}else if(c&&i.isType(c.getClosetBlock(),j.list))return c.getClosetBlock()}function f(a,b,c){if(b=b||a,a.get("parent")==b.get("parent")&&i.isType(a,j.line)){var d,e=a.get("parent"),f=[];if(c.undo.push(g.buildReplaceUndo(e)),f.push(e),b.get("after")&&(d=new i({type:j.paragraph}),e.giveChildrenTo(d,b.get("after"),null,!0),f.push(d),e.insert(d),c.redo.push(g.buildReplaceUndo(e)),g.addUndoForInsert(c,d)),a.get("before")&&(d=new i({type:j.paragraph}),e.giveChildrenTo(d,null,a.get("before"),!0),f.unshift(d),e.insert(d,!0),c.redo.push(g.buildReplaceUndo(e)),g.addUndoForInsert(c,d)),a!=b){for(var h,l=f.indexOf(e)+1,m=[],o=a.get("after");o!=b.get("after");)d=new i({type:j.paragraph}),h=o,o=o.get("after"),h.detach(),h.set("parent",d),m.push(d),f.splice(l,0,d),l++;e.insertArray(m,!1,!0),g.addUndoForInsertArray(c,m)}f.length>1&&n.findElemById(e.cid).replaceWith(k.toHTML(f))}}function h(a,c,d,h){var k=e(a,c);if(b)if("none"==h){if(!k)return;h=k.get("style")}else if(k&&h==k.get("style"))return;if(k)k.get("style")===h?(k.get("children").map(function(a){g.addUndoForUnwrap(d,a),a.unwrap()}),g.addUndoForUnwrap(d,k),k.unwrap(n)):(d.undo.push(g.buildReplaceUndo(k)),k.set("style",h),n.findElemById(k.id).replaceWith(k.toHTML()),d.redo.push(g.buildReplaceUndo(k)));else{c=c||a,f(a,c,d),a=a.getClosetParagraphLevel(),c=c.getClosetParagraphLevel();for(var l,m=a,o=[],p=c.get("after");m&&m!=p;){var q=new i({type:j.list_item,"in":a.get("in")});l=m,m=m.get("after"),q.wrap(l,l,n,!0),o.push(q),g.addUndoForWrap(d,q)}k=new i({type:j.list,style:h,"in":a.get("in")}),k.wrap(o[0],o.last(),n),
g.addUndoForWrap(d,k),n.refresh()}}var l,m,n=this.editor,p=g.makeEmptyCommand(n.selection.buildUndo()),q=this.editor.selection.getRangy();if(!(i.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&!this.editor.fences.getFocused()||File.isLocked)){if(this.editor.undo.completeSnap(!0),this.editor.store(),this.editor.lastCursor=this.editor.selection.buildUndo(),q){var r=n.selection.getDetailPos(q.startContainer,q.startOffset),s=n.selection.getDetailPos(q.endContainer,q.endOffset),t=n.getMarkElem(r[0]),u=n.getMarkElem(s[0]),v=n.findNodeByElem(t),w=n.findNodeByElem(u),x=i.getTreePosition(v,w),y=o(x,q);l=y[1],m=y[1]===y[2]?null:y[2]}else l=this.editor.findNodeByElem(this.editor.getMarkElem());l&&(this.editor.brush.pause(!0),a==j.blockquote?(l=l.getClosetParagraphLevel(),m=m&&m.getClosetParagraphLevel(),d(l,m,p)):h(l,m,p,a),p.redo.push(this.editor.lastCursor),this.editor.undo.exeCommand(this.editor.lastCursor),this.editor.undo.register(p),this.editor.brush.resume(),this.editor.refocus(),this.editor.selection.scrollAdjust())}},changeHeadingLevel:function(a,b){var c=null;if(a.get("type")==j.line)b&&(c="header6");else if(a.get("type")==j.heading){var d=a.get("depth")-0;d-=b?1:-1,7==d?c="paragraph":d>0&&(c="header"+(d+""))}c&&this.changeBlock(c)}}),s={SyntaxMap:{strong:["**","**"],em:["*","*"],code:["`","`"],del:["~~","~~"],underline:["<u>","</u>"],footnote:["[^"," ]"],link:["[","]()"],image:["![","]()"],highlight:["==","=="],superscript:["^","^"],subscript:["~","~"],inline_math:["$","$"],comment:["<!--","-->"]},NormalBlockMap:{line:"Paragraph",paragraph:"Paragraph",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",header6:"Header 6",def_link:"Link Reference",def_footnote:"Footnote"},InsertInline:["link","image","footnote","inline_math"],LinkList:["autolink","reflink","link"],NoInline:["hr","fences","def_link","code","meta_block","math_block","toc","comment","tag","atag","imgtag"],Selectable:["hr","math_block","toc"],InsertBlock:["table","fences","hr"],StyleToNameMap:{paragraph:"Paragraph",header1:"Heading 1",header2:"Heading 2",header3:"Heading 3",header4:"Heading 4",header5:"Heading 5",header6:"Heading 6",def_link:"Link Reference",def_footnote:"Footnote",table:"Table",fences:"Code Fences",blockquote:"Quote",toc:"Table of Contents",hr:"Horizontal Line",meta_block:"YAML Front Matter",ol:"Ordered List",ul:"Unordered List",tasklist:"Task List",strong:"Strong",em:"Emphasis",code:"Code",del:"Strike",highlight:"Highlight",inline_math:"Inline Math",math_block:"Math Block",superscript:"Superscript",subscript:"subscript",image:"Image",footnote:"Superscript",autolink:"Hyperlink",reflink:"Hyperlink",link:"Hyperlink",url:"Hyperlink",underline:"Underline",comment:"Comment"}};s.NameMapToStyle={};for(var t in s.StyleToNameMap)s.NameMapToStyle[s.StyleToNameMap[t].toLowerCase()]=t;s.InsertQuery='[md-inline="'+s.InsertInline.join('"],[md-inline="')+'"]',s.getMenuBlockType=function(a){var b=a.get("type");switch(b){case j.line:return j.paragraph;case j.heading:return"header"+a.get("depth");case j.list:return a.get("style")}return b},r.CONST=s,c.exports=r}),define("app/editor/Selection",["app/document/StringUtils","jquery/jquery","rangy/rangy-core","codemirror/lib/codemirror","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster"],function(a,b,c){"use strict";function d(a){return!1}function e(a){g("content").on(a?"scroll":"DOMMouseScroll mousewheel",d),setTimeout(function(){g("content").off(a?"scroll":"DOMMouseScroll mousewheel",d)},500)}function f(a){g("content").off(a?"scroll":"DOMMouseScroll mousewheel",d)}var g=(a("app/document/StringUtils"),a("jquery/jquery")),h=a("rangy/rangy-core.js"),i=a("codemirror/lib/codemirror"),j=a("app/document/Node"),k=j.Node,l=a("app/editor/KeyMaster"),m=l.map,n=k.TYPE,o=function(a){this.rangy=h,h.init(),this.savedSel={},this.editor=a,g(document).on("selectionchange",function(b){a.selection.selectWordTime&&new Date-a.selection.selectWordTime>200&&(a.selection.selectWordTime=null)}),this.updateMetrics()},p=!1,q=g.fn.scrollTop;g.fn.oldScrollTop=q,g.fn.scrollTop=function(a){return void 0!==a&&p?void 0:q.apply(this,arguments)},g(document.body).on("hidden.bs.modal",".modal",function(a){File.editor.restoreLastCursor()}).on(".show.bs.modal",".modal",function(){var a=File.editor.selection.buildUndo();a&&(File.editor.lastCursor=a)}),e(),h.rangePrototype.insertNodeAtEnd=function(a){var b=this.cloneRange();b.collapse(!1),b.insertNode(a),b.detach(),this.setEndAfter(a)};var r,s;g("window").on("resize",function(){r=document.querySelector("content").clientHeight}),o.prototype={preventScrollOnce:e,enableScroll:f,updateMetrics:function(){r=document.querySelector("content").clientHeight,s=g("content").offset().top,this.editor.defaultTextHeight=parseInt(g(".md-line").css("line-height"))},jumpIntoElemBegin:function(a,b){var c=this,d=(this.editor,a.find(".CodeMirror")[0]),e=a.children("[mdtype]");if(!a.length)return window.getSelection().removeAllRanges(),!1;if(d)return d.CodeMirror.focus(),d.CodeMirror.execCommand("goDocStart");if(a.attr("mdtype")==j.TYPE.fences)return this.editor.fences.focus(a.attr("cid"));if(k.isType(a.attr("mdtype"),k.TYPE.image,k.TYPE.hr,k.TYPE.math_block))return this.selectNode(null,a);if(a.hasClass("footnotes"))return this.jumpIntoElemBegin(a.find(".md-def-name"));if(e.length)return this.jumpIntoElemBegin(g(e[0]),b);var f=h.createRange();return f.setStart(a[0],0),f.setEnd(a[0],0),this.deRange(f),b&&setTimeout(function(){c.setRange(f),c.editor.refocus()},20),c.setRange(f),!window.getSelection().anchorNode&&a.length&&(!function i(a){3==a.nodeType?(f.setStart(a,0),f.setEnd(a,0)):a.childNodes.length?i(a.childNodes[0]):(f.setStart(a,0),f.setEnd(a,0))}(a[0]),window.getSelection().addRange(f)),window.getSelection().anchorOffset},jumpIntoElemEnd:function(a,b){var c=a.find(".CodeMirror")[0];if(c)c.CodeMirror.execCommand("goDocEnd");else{if(a.attr("mdtype")==j.TYPE.fences)return this.editor.fences.jumpCmEnd(a.attr("cid"));if(k.isType(a.attr("mdtype"),k.TYPE.image,k.TYPE.hr,k.TYPE.math_block))return this.selectNode(null,a);if(a.children("[mdtype]").length)return this.jumpIntoElemEnd(g(a.children("[mdtype]")[0]),b);a.addClass("md-expand"),this.restoreSelection(a[0],a.text().length),a.removeClass("md-expand")}},jumpInto:function(a,b){return""==a.text()?this.jumpIntoElemBegin(a):void this.restoreSelection(a[0],b)},setRange:function(a){g(a.startContainer).closest(".math-jax-postprocess, .md-meta, .md-content").parent().addClass("md-expand"),g(a.endContainer).closest(".math-jax-postprocess, .md-meta, .md-content").parent().addClass("md-expand"),File.isTypeWriterMode&&File.option.scrollWithCursor&&this.typeWriterScroll(a.nativeRange||a),this.rangy.getSelection().setSingleRange(a)},getOffset:function(a,b){var b=b||this.getRangy();if(b)try{return b.getBookmark(a[0]).start}catch(c){}return 0},restoreEdge:function(a,b,c,d){function e(a){if(3==a.nodeType){var g=i+a.textContent.length;if(c){if(b>=i&&g>=b)throw d.setEnd(a,b-i),j}else if(f){if(b>=i&&g>b)throw d.setStart(a,b-i),j}else if(b>=i&&g>=b)throw d.setStart(a,b-i),j;i=g}else{a.childNodes.length||a.nodeType!==a.ELEMENT_NODE||a.appendChild(document.createTextNode(""));for(var h=0,k=a.childNodes.length;k>h;++h)e(a.childNodes[h])}}a.jquery&&(a=a.length?a[0]:null);var f,i=0,j={};if(!c){var k=g(a).closest("[mdtype='line'], [mdtype='heading']");f=k.length&&b<k.text().length}d=d||h.createRange();try{a&&e(a)}catch(l){if(l==j)return d;throw l}return d},saveSelection:function(a,b){if(a){a.jquery&&(a=a[0]);var b=b||this.getRangy();return b?(this.savedSel=b.getBookmark(a),this.savedSel):void 0}},restoreSelection:function(a,b){if(!a)return window.getSelection().removeAllRanges();a.jquery&&(a=a[0]);var c="false"===a.getAttribute("contenteditable");if(void 0===b||null===b||""===b?b=this.savedSel:"number"==typeof b&&(b={start:b,end:b}),"fences"===a.getAttribute("mdtype")){var d=this.editor.fences.getCm(a.getAttribute("cid"));return d.focus(),void d.setCursor(b.start)}var e=h.createRange();if(e.moveToBookmark({start:b.start,end:b.end,containerNode:a}),"BODY"==document.activeElement.tagName||document.activeElement.hasAttribute("tabindex")){var f=g("content").scrollTop();this.editor.writingArea.focus(),g("content").scrollTop(f)}e.collapsed&&this.deRange(e),c&&a.setAttribute("contenteditable","true"),this.setRange(e),c&&a.setAttribute("contenteditable","false")},getVeryFirstElem:function(a){return a.children("[cid]").length>0?this.getVeryFirstElem(a.children("[cid]").first()):a},getVeryLastElem:function(a){return a.children("[cid]").length>0?this.getVeryLastElem(a.children("[cid]").last()):a},getSelection:function(){return this.rangy.getSelection()},prepNode:function(a,b,c,d){var e,f=this.editor,g=this.getRangy(),i=this.editor.undo.UndoManager,l=i.SnapFlag;try{if(g&&!c&&!g.collapsed){if(f.undo.completeSnap(!0),e=f.UserOp.surroundPair(f,a,g))return b&&b.preventDefault(),!c&&f.undo.register(e),e;e=f.UserOp.backspaceHandler(f,null,"delSelection",!0,!0)}g=this.getRangy();var m,o,p=this.rangy.getSelection(),q=p.anchorOffset==h.dom.getNodeLength(p.anchorNode),r=f.getJQueryElem(window.getSelection().anchorNode),s=f.getMarkElem(window.getSelection().anchorNode),t=f.findNodeByElem(s),u=g.getBookmark(s[0]);if(e||c||(f.undo.snap(t.cid,l.ADD,void 0,d),f.brush.addToQueue(t.cid)),r.hasClass("md-def-url")&&a.match(/\s/g).length)return q&&this.jumpIntoElemBegin(s.find(".md-def-title")),b&&b.preventDefault();if(!c&&e&&f.undo.snap(s.attr("cid"),a.length||l.ADD,f.docMenu.getAttrByElem(r)),s.removeClass("unholdable").find(".md-math-after-sym").text(""),t.get("type")==n.paragraph?(0===t.get("children").length&&k.normalizeNode(t),0===s.children("[mdtype]").length&&(s.replaceWith(t.toHTML()),this.jumpIntoElemEnd(this.editor.findElemById(t.cid)))):t.get("type")==n.meta_block||t.get("type")==n.fences||(t.isBlock()&&t.canNotDirectEdit()?(window.getSelection().removeAllRanges(),b&&b.preventDefault()):r.hasClass("md-image")&&(1!=g.startOffset||r.prev().length||(r.before("​"),g.setStartBefore(r.parent()),p.setSingleRange(g)))),t.get("children").length){console.debug("wrong cursor");var v=window.getSelection().anchorNode.childNodes,w=window.getSelection().anchorOffset,x=w>0?v[w-1]:null,y=w<v.length?v[w]:null,z=f.findNodeByElem(x?f.getMarkElem(x):[]),A=f.findNodeByElem(y?f.getMarkElem(y):[]);if(a=a.replace("​",""),k.isType(A,j.TYPE.table)){f.undo.completeSnap(!0),e=e||i.makeEmptyCommand();var B=new k({type:j.TYPE.paragraph,text:a,"in":A.get("in")});A.insert(B,!0),i.addUndoForInsert(e,B),f.findElemById(A.id).before(B.toHTML()),f.selection.restoreSelection(f.findElemById(B.id)[0],a.length),m=B}else if(k.isType(z,j.TYPE.table)){f.undo.completeSnap(!0),e=e||i.makeEmptyCommand();var B=new k({type:j.TYPE.paragraph,text:a,"in":z.get("in")});z.insert(B),i.addUndoForInsert(e,B),f.findElemById(z.id).after(B.toHTML()),f.selection.restoreSelection(f.findElemById(B.id)[0],a.length),m=B}else A?(A=A.getVeryFirst(),f.undo.snap(A.cid,l.ADD),A.set("text",a+A.safeGetStrAttr("text",!0)),f.findElemById(A.id).replaceWith(A.toHTML()),A&&f.selection.jumpInto(f.findElemById(A.id),1),e=null):z&&(z=z.getVeryFirst(!0),f.undo.snap(z.cid,l.ADD),z.set("text",z.safeGetStrAttr("text",!0)+a),f.findElemById(z.id).replaceWith(z.toHTML()),f.selection.jumpIntoElemEnd(f.findElemById(z.id)),e=null);e&&e.redo.push(this.buildUndo()),!c&&f.refocus(m.id),b&&b.preventDefault()}else g.collapsed&&!File.isMac&&(o=f.UserOp.hanldePair(f,a,t,u,e,g))?("object"==typeof o&&(e=o),b&&b.preventDefault()):e&&(f.UserOp.insertInlineText(f,t,a,u.start,e,!0),i.append(e,f.undo.completeSnap(!0,!0)),b&&b.preventDefault());return!c&&e&&this.editor.undo.register(e),e}catch(C){}},getPosBookmark:function(){var a=editor.getMarkElem();if(a.length){var b=this.editor.fences.queue[a.attr("cid")];return b?{isCm:b,cid:b.cid,start:b.indexFromPos(b.getCursor())}:{isCm:!1,cid:a.attr("cid"),start:this.getRangy().getBookmark(a[0]).start}}},getRangy:function(a){var b=this.rangy.getSelection(),c=b.rangeCount?b.getRangeAt(0):null;return c&&a&&this.deRange(c),c},buildUndo:function(a){var b={};b.type="cursor";try{a=a||this.getRangy();var c=this.editor.getMarkElem(a?a.commonAncestorContainer:void 0);if(c.children(".CodeMirror").length){var d=c.children(".CodeMirror")[0].CodeMirror;b.id=d.cid,b.pos=d.getCursor(),b.selections=d.listSelections()}else if(c.attr("mdtype")&&c.children("[tabindex]").andSelf("[tabindex]").length)b.id=c.attr("cid"),b.focus=c.attr("mdtype");else{if(!a)return null;var e=this.editor.getMarkElem(this.getDetailPos(a.startContainer,a.startOffset)[0]),f=this.editor.getMarkElem(this.getDetailPos(a.endContainer,a.endOffset)[0]),g=a.getBookmark(e[0]);if(e===f){if(b.id=e.attr("cid"),!b.id)return null;b.start=g.start,b.end=g.end}else{if(b.startId=e.attr("cid"),b.endId=f.attr("cid"),!b.startId||!b.endId)return null;b.start=g.start,b.end=a.getBookmark(f[0]).end}}}catch(h){return console.log(h.stack),null}return b},selectNode:function(a,b){b=b||editor.findElemById(a.id),b.length&&void 0!==b.attr("tabindex")&&(window.getSelection().removeAllRanges(),b.addClass("onfocus"),b.focus())},extendToLineEdge:function(a){var b=this.editor.getMarkElem()[0],c=this.getRangy();if("TEXTAREA"!=event.target.tagName&&"INPUT"!=event.target.tagName&&c&&b){var d=c.getBookmark(b),e=h.createRange();a?d.end=b.textContent.length:d.start=0,e.moveToBookmark(d),this.setRange(e)}},extendCharFromCollapse:function(a,b){var c,d=!1,e=!b;if(a.commonAncestorContainer.nodeType==document.TEXT_NODE&&(b&&a.startOffset>0&&(a.setStart(a.startContainer,a.startOffset-1),a.startOffset>0&&(c=a.toString().charCodeAt(0),c>=56320&&57343>=c&&(a.setStart(a.startContainer,a.startOffset-1),c=a.toString().charCodeAt(0),c>=55296&&56319>=c||a.setStart(a.startContainer,a.startOffset+1))),d=!0),e&&a.endOffset<a.commonAncestorContainer.textContent.length&&(a.setEnd(a.endContainer,a.endOffset+1),c=a.toString().charCodeAt(a.toString().length),c>=55296&&56319>=c&&a.endOffset<a.commonAncestorContainer.textContent.length&&a.setEnd(a.endContainer,a.endOffset+1),d=!0)),!d){var f=this.editor.getMarkElem(a.startContainer)[0],g=a.getBookmark(f);if(b&&0===g.start||e&&g.end>=f.textContent.length)return!1;b?g.start--:g.end++,a.moveToBookmark(g)}return a},moveLeftOrRight:function(a,b){function c(b){return g(a?b.startContainer:b.endContainer).closest(".md-inline-math").addClass("md-expand").length}function d(){return e.classList.contains("md-def-link")&&0==i.getJQueryElem(f.startContainer).closest(".md-def-title").length}var e=this.editor.getMarkElem()[0],f=this.getRangy(),i=this.editor;if("TEXTAREA"!=b.target.tagName&&"INPUT"!=b.target.tagName&&f&&e){var j;if(!(j=g(b.target).closest("[mdtype='table_cell']")).length||j.closest("th").length&&!j.closest("th").prev().length){var k=f.getBookmark(e),l=h.createRange();if(b&&!b.metaKey){if(a&&0===k.start)return this.moveUpOrDown(!0,b,!0);if(!a&&k.end>=e.textContent.length&&!d())return this.moveUpOrDown(!1,b,!0)}if(File.isNodeHtml&&!a&&b&&b.ctrlKey&&!b.shiftKey){var m=e.textContent.substring(k.end)||"";if(/^\w+$/.exec(m))return k.start=k.end=e.textContent.length,l.moveToBookmark(k),this.setRange(l),b.preventDefault(),!0}return a?(k.end=k.start,k.start--):(k.start=k.end,k.end++),l.moveToBookmark(k),/\u200b|\007F/g.exec(l.toString())?(l.collapse(a),this.setRange(l),!0):!c(l)||b.ctrlKey||b.metaKey||b.altKey?void 0:(l.collapse(a),this.setRange(l),b&&b.preventDefault(),!0)}}},addUnholdable:function(a,b,c,d){var e=function(a,b,c){var d=n.paragraph;a.get("type")==n.list_item&&(d=n.list_item);var e=new k({type:d});return a.insert(e,b),k.normalizeNode(e),e};this.editor.undo.completeSnap(!0);var f=e(a,c),h=this.editor.findElemById(a.id),i=c?a:void 0,j=c?void 0:a;return c?h.before(f.toHTML()):h.after(f.toHTML()),b=b||this.editor.undo.UndoManager.makeEmptyCommand(),g(".unholdable").removeClass("unholdable"),this.editor.findElemById(f.id).addClass(d?"":"unholdable"),this.editor.undo.UndoManager.addUndoForInsert(b,f,j,i),f},moveUpOrDown:function(a,b,c){function d(a,b){return k.isType(a,k.TYPE.hr,k.TYPE.toc)&&(!b||b[0].hasAttribute("tabindex"))}function e(a,b){var c,d=a.closest("td"),e=d.prevAll().length+1;if(!d.length){if(b)return[];d=a.closest("th"),e=d.prevAll().length+1}return"TD"==d[0].tagName?(c=d.closest("tr")[b?"prev":"next"]().find("td:nth-child("+e+")>.td-span"),b&&!c.length&&(c=d.closest("tbody").prev().find("tr:last > th:nth-child("+e+") > .td-span")),c):b?[]:d.closest("thead").next().find("tr:first > td:nth-child("+e+")>.td-span")}function f(a,b){return b?k.isType(a,n.fences,n.table,n.math_block,n.hr,n.toc):k.isType(a,n.fences,n.table,n.math_block,n.hr,n.toc,n.def_footnote,n.def_link)}function h(a,b){if(k.isType(a,n.fences,n.table,n.hr,n.def_link,n.def_footnote))return a;var c=b?"before":"after";return a.get("parent")?a.get("parent").get(c)?a:a.get(c)?a:h(a.get("parent")):a}function i(a,b,c){var d=a.getVeryFirstBrotherIncludeTopBlock(b),e=v.editor.undo.UndoManager.makeEmptyCommand();return(!w&&!d&&!a.get(b?"before":"after")||f(a)&&f(d,!0))&&(b&&k.isType(a,a.TYPE.meta_block)||(d=v.addUnholdable(h(a),e,b))),e.undo.push(v.buildUndo()),c&&c(),b?v.jumpIntoElemEnd(v.editor.findElemById(d.id),!0):v.jumpIntoElemBegin(v.editor.findElemById(d.id),!0),e}function l(a,b,c){a.hasClass("unholdable")&&b&&(a.text().length||a.children(".md-line").length>1?a.removeClass("unholdable"):(v.editor.undo.UndoManager.addUndoForRemove(c,b),c.redo.push(v.buildUndo()),b.remove(),a.remove(),v.editor.undo.register(c)))}function o(a,c){B=i(a.getClosetBlock(),c),b&&b.preventDefault(),v.editor.undo.UndoManager.isEmptyCommand(B)||(B.redo.push(v.buildUndo()),v.editor.undo.register(B)),v.scrollAdjust()}function p(a){a&&(a.codemirrorIgnore=!0,a.preventDefault(),a.stopPropagation())}function q(a,c,d){var e=d||v.editor.fences.getCm(a.id),f=(e.doc.getCursor(),!d&&document.activeElement===y[0].querySelector("input.mode")),h=c&&0==e.doc.getCursor().line,j=!c&&e.doc.getCursor().line==e.lineCount()-1;(d||!g(".autoComplt-list").is(":visible"))&&(c&&f?v.editor.fences.jumpCmEnd(y.attr("cid")):!j||d||f?(h||j||!c&&f)&&(B=i(a,c,function(){e.getInputField().blur()}),p(b),c&&!v.editor.undo.UndoManager.isEmptyCommand(B)&&(B.redo.push(v.buildUndo()),v.editor.undo.register(B))):(e.getInputField().blur(),p(b),setTimeout(function(){y.find("input.mode").focus()},10)),b.stopPropagation())}function r(a){var b=a[0];return b.childElementCount>0&&function(){for(var a=0;a<b.childElementCount;a++)if(b.children[0].getAttribute("md-inline")!==n.image)return!1;return!0}()}function s(e,f,h){var i=v.editor.findElemById(e.id);if(l(f.closest(".unholdable"),A.getClosetParagraphLevel(),h),k.isType(e,n.fences)){var j=v.editor.fences.getCm(e.id);j.focus(),j.execCommand(a?"goDocEnd":"goDocStart"),v.editor.refocus()}else if(k.isType(e,n.table,n.table_row,n.table_cell))v.jumpIntoElemBegin(i),p(b);else if(k.isType(e,n.math_block)){var j=v.editor.mathBlock.startEditing(i,!0);j.focus(),j.execCommand(a?"goDocEnd":"goDocStart"),v.editor.refocus()}else if(d(e))p(b),window.getSelection().removeAllRanges(),editor.findElemById(e.id).focus(),editor.refocus();else if(r(i))p(b),i.find("img:first").trigger("click");else if(k.isType(e,n.line,n.paragraph,n.heading,n.def_link,n.def_footnote)&&!e.get("text"))v.jumpIntoElemBegin(i),b&&b.preventDefault();else if(k.isType(e,n.meta_block)&&a)v.jumpIntoElemEnd(i),b&&b.preventDefault();else if(i.length){var m,o=i[0].getBoundingClientRect();c?a?v.jumpIntoElemEnd(i):v.jumpIntoElemBegin(i):(m=a?document.caretRangeFromPoint(o.right-1,o.bottom-parseInt(i.css("paddingBottom"))-1):document.caretRangeFromPoint(o.left+1,o.top+parseInt(i.css("paddingTop"))+1),m.commonAncestorContainer.parentElement.querySelector("[cid]")?a?v.jumpIntoElemEnd(i):v.jumpIntoElemBegin(i):v.setRange(m)),File.isFocusMode&&(g(".md-focus").removeClass("md-focus"),i.addClass("md-focus")),p(b)}}var u,v=this,w=b&&k.isType(m[b.keyCode||b.which],"Right","Left"),x=function(a,b,c){if(c=c||this.getRangy(),c.collapsed){if(u=t(c.nativeRange),!u||!a.length)return 0==a.text().length;var d=a[0].getBoundingClientRect();return b?d.bottom-u.bottom<parseInt(a.css("paddingBottom"))+10:u.top-d.top<parseInt(a.css("paddingTop"))+10}};try{var y=this.editor.getMarkElem(),z=y.attr("mdtype"),A=this.editor.findNodeByElem(y),B=v.editor.undo.UndoManager.makeEmptyCommand();if(!A)return;if(d(A,y)||y.hasClass("rawedit"))o(A,a);else if(z==j.TYPE.fences)q(A,a);else if(z==j.TYPE.math_block&&this.editor.mathBlock.currentCm)q(A,a,this.editor.mathBlock.currentCm);else if(y.closest(".td-span").length){var C=e(y.closest(".td-span"),a);if(C.length)b&&b.preventDefault(),a?this.jumpIntoElemEnd(C):this.jumpIntoElemBegin(C);else{if(w)return p(b),!1;o(A,a)}}else if(y.closest(".md-meta-block").length&&!a)!y.text().substring(window.getSelection.focusOffset).match(/\S+\n+/)&&o(A,a);else{var D=A.getClosetBlock(!0).getVeryFirstBrotherIncludeTopBlock(a);if(B.undo.push(this.editor.lastCursor),x.call(this,y,!a))D?s(D,y,B):!a&&y.text().trim().length&&o(A,a);else if(File.isTypeWriterMode&&File.option.scrollWithCursor&&u&&u.left){var E=u.left,F=a?u.top-9:u.bottom+9,G=document.caretRangeFromPoint(E,F);this.editor.writingArea.contains(G.startContainer)&&t(G).top!=u.top&&(this.setRange(G),p(b))}}}catch(H){console.log(H.message)}},click:function(a,b,c){window.getSelection().removeAllRanges();var d=document.createEvent("MouseEvent"),e=document.elementFromPoint(a,b);c="click",d.initMouseEvent(c,!0,!0,window,null,a,b,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(d)},jumpDefComponent:function(a){var b=this.editor.getMarkElem(),c=h.createRange();a?(c.selectNodeContents(b.children(".md-def-name")[0]),this.deRange(c,!0)):(c.selectNodeContents(b.children(".md-def-content")[0]),this.deRange(c,!0)),this.editor.refocus()},jumpSelection:function(){return this.scrollAdjust(null,20)},jumpTop:function(a){var b=this.editor;if(b.sourceView.inSourceMode)b.sourceView.cm.execCommand("goDocStart");else{var c=this.getRangy();a&&c?(c.setStart(b.writingArea,0),this.deRange(c,!0)):this.jumpIntoElemBegin(this.editor.findElemById(this.editor.nodeMap.getFirst().cid)),File.isTypeWriterMode||g("content").animate({scrollTop:0},"100","swing",function(){b.docMenu.highlightVisibleHeader()})}},jumpBottom:function(a){var b=this.editor;if(b.sourceView.inSourceMode)b.sourceView.cm.execCommand("goDocEnd");else{var c=this.getRangy();if(a&&c){c.setEnd(b.writingArea,b.writingArea.childNodes.length),c=this.deRange(c,!0);try{c.endContainer.parentElement.classList.contains("md-def-title")&&""==c.endContainer.parentElement.textContent&&(c.setEndAfter(c.endContainer.parentElement.previousSibling.previousSibling),c=this.deRange(c,!0))}catch(d){}}else this.jumpIntoElemEnd(this.editor.findElemById(this.editor.nodeMap.getLast().getVeryFirst(!0).cid));File.isTypeWriterMode||g("content").animate({scrollTop:document.querySelector(this.editor.sessionStr).scrollHeight-window.innerHeight},"100","swing",function(){b.docMenu.highlightVisibleHeader()})}},lockScroll:function(){p=!0},unlockScroll:function(){p=!1},typeWriterScroll:function(a,b,c){function d(a){return 0==a.top&&0==a.bottom?!1:(a=a.top-r/2+e.defaultTextHeight/2,Math.abs(a)>2&&(c?g("content").animate({scrollTop:g("content").scrollTop()+a},120,"swing",c):g("content").scrollTop(g("content").scrollTop()+a)),!0)}p=!1;var e=this.editor;if(File.isTypeWriterMode){var f;if(b)return f=a.jquery&&a.length&&a[0].getBoundingClientRect(),void(f&&(f=document.caretRangeFromPoint((f.left+f.right)/2,f.bottom-10),this.typeWriterScroll(f)));if(!a||a.getBoundingClientRect)return void((f=a||window.getSelection().rangeCount&&window.getSelection().getRangeAt(0))&&d(f.startContainer.nodeType==document.TEXT_NODE&&f.startContainer.parentElement.hasAttribute("cid")?f.startContainer.parentElement.getBoundingClientRect():t(f)));a.jquery&&a.length&&d(a[0].getBoundingClientRect())}},scrollAdjust:function(a,b,c){function d(a){g("content").scrollTop(a),l.docMenu.highlightVisibleHeader(),e()}if(this.editor.sourceView&&this.editor.sourceView.inSourceMode)return void this.editor.sourceView.scrollAdjust();if(File.isTypeWriterMode)return this.typeWriterScroll(a);try{var f,h,i,j=window.innerHeight,k=g("content").scrollTop(),l=this.editor,m=a&&a.jquery&&a.closest("[mdtype='heading']").toArray();if(a&&a.jquery){if(!a.length)return;f=a.offset().top+k}else if(a&&void 0!==a.startContainer)f=(a.nativeRange||a).getClientRects()[0].top+k;else{if(g(".CodeMirror-selected").length)return this.scrollAdjust(g(".CodeMirror-selectedtext"));h=window.getSelection().getRangeAt(0),h?(i=h.getClientRects()[0],i||(i=h.endContainer.nodeType===document.TEXT_NODE?h.endContainer.parentElement.getClientRects()[0]:h.endContainer.getClientRects()[0]),f=i.top+k):f=g(document.activeElement).offset().top}var n=(File.isNodeHtml?g("#top-titlebar").height():0)+(g("#md-searchpanel:visible").height()||0);void 0!=b?g("content").animate({scrollTop:f-b-n},"500","swing",function(){l.docMenu.highlightVisibleHeader(m)}):f>j+k-(c?70:200)+n?d(f-j+(c?70:200)):k-30>f?d(f-30-n):l.docMenu.highlightVisibleHeader()}catch(o){}},selectAllElem:function(a){if(this.editor.sourceView.inSourceMode)return void this.editor.sourceView.cm.execCommand("selectAll");if(g("body").hasClass("typora-sourceview-on"))return this.editor.sourceView.cm.execCommand("selectAll");g(".md-math-after-sym").text("​");var b=h.createRange();a.children().length?(b.setStart(a.children()[0]),b.setEndAfter(a.children()[a.children().length-1])):b.selectNode(a[0]),this.deRange(b,!0)},selectAll:function(a){if(this.editor.sourceView.inSourceMode)return void this.editor.sourceView.cm.execCommand("selectAll");if(g(".md-math-after-sym").text("​"),document.activeElement&&k.isType(document.activeElement.tagName,"INPUT"))return void document.activeElement.select();var b=this.editor.getMarkElem(),c=h.createRange();if(b.hasClass("rawedit"))a||(c.selectNode(b[0]),this.setRange(c));else if(b.hasClass("md-fences")){var d=b.attr("cid");a||this.editor.fences.getCm(d).execCommand("selectAll")}else{if(a&&"INPUT"==a.target.tagName)return!0;b.closest('[mdtype="table"]').length?(this.selectAllElem(b.closest("[mdtype='table_cell']")),a&&a.preventDefault()):b.closest(".md-meta-block").length?(this.selectAllElem(b.closest("[mdtype='meta_block']")),a&&a.preventDefault()):(g(this.editor.sessionStr).addClass("md-expand"),g(".footnotes, .md-fences, .task-list, .hr, .mathjax-block").attr("contenteditable",!0),c.setStart(g(this.editor.sessionStr).children()[0]),g(this.editor.sessionStr).children()[0].classList.contains("md-hr")&&c.setStart(g(this.editor.sessionStr).children()[1]),c.setEndAfter(g(this.editor.sessionStr).children().last()[0]),g(this.editor.sessionStr).removeClass("md-expand"),this.deRange(c,!0),a&&a.preventDefault(),setTimeout(function(){g(".footnotes, .md-fences, .task-list, .hr, .mathjax-block").attr("contenteditable",!1)},10))}this.editor.lastCursor=this.buildUndo()},getEndNode:function(a){return this.getDetailPos(a.endContainer,a.endOffset)[0]},getDetailPos:function(a,b,c){function d(a){1===a.nodeType&&0===a.childNodes.length&&a.appendChild(document.createTextNode(""))}function e(a){if(d(a),a.childNodes.length)return a.childNodes.length;if(3===a.nodeType)return a.textContent.length;if(void 0!==a.length)return a.length;throw f}var f={};if(1==a.nodeType){var g=a.childNodes;if(a.classList.contains("md-image")&&2===b&&(b=1),d(a),!g||!g.length)return[a,b];try{var h=g[b]&&g[b].getAttribute&&"checkbox"===g[b].getAttribute("type");return c?(h&&b++,b==g.length?this.getDetailPos(g[b-1],e(g[b-1])):this.getDetailPos(g[b],0,!0)):0==b?(h&&b++,this.getDetailPos(g[b],0)):this.getDetailPos(g[b-1],e(g[b-1]))}catch(i){return[a,b]}}return[a,b]},deRange:function(a,b){var c=a.cloneRange();try{var d=this.getDetailPos(a.startContainer,a.startOffset,!0),e=this.getDetailPos(a.endContainer,a.endOffset,!1);return b&&d[0].parentElement&&"HR"==d[0].parentElement.tagName&&(d[0]=d[0].parentElement.parentElement),a.setStart.apply(a,d),a.setEnd.apply(a,e),b&&this.setRange(a),a}catch(f){}return c},selectLine:function(){if(this.editor.sourceView.inSourceMode){var a=this.editor.sourceView.cm,b=a.getCursor();return void a.setSelection(i.Pos(b.line,0),i.Pos(b.line,a.getLine(b.line).length))}if(document.activeElement&&k.isType(document.activeElement.tagName,"INPUT"))return void document.activeElement.select();if(window.getSelection().rangeCount){var c=window.getSelection(),d=this.editor.getMarkElem(c.commonAncestorContainer),e=h.createRange();if(d.length)if(d.closest("tr[mdtype='table_row']").length){var f=d.closest("tr[mdtype='table_row']");e.selectNode(f[0]),f.closest('[mdtype="table"]').attr("contenteditable",!0),this.setRange(e),f.closest('[mdtype="table"]').attr("contenteditable",!1)}else{var g=d.hasClass("md-expand");d.addClass("md-expand"),window.getSelection().modify("move","backward","sentence"),window.getSelection().modify("extend","forward","sentence"),e=this.getRangy();var j=this.editor.getMarkElem(e.startContainer);j.length&&j[0]!==this.editor.getMarkElem(e.endContainer)[0]&&(e.setEndAfter(j[0]),this.deRange(e,!0)),g&&d.removeClass("md-expand")}}},selectWord:function(a,b){if(this.editor.sourceView.inSourceMode){var c=this.editor.sourceView.cm,d=c.findWordAt(c.getCursor());return void c.extendSelection(d.anchor,d.head)}if(this.selectWordTime=new Date,a){var e,f,h,i,j,k,l=this.getRangy();if(l){if(e=g(l.commonAncestorContainer),f=e.closest("[md-inline='url'], [md-inline='image'], [md-inline='refimg']"),f.length)return this.selectAllElem(f);if(f=e.closest("[md-inline='plain']"),j=l.getBookmark(f[0]),f.length)for(h="image"==a?/(([\w-_]+:\/\/)|(www\.)|\w*\/)?[\w-.\/?%&=:@]+(\.jpe?g|png|gif|webm|svg)/gi:/(([\w-_]+:\/\/)|(www\.)|\w*\/)[\w-.\/?%&=:@]*/gi,i=f.text();k=h.exec(i);)if(h.lastIndex-k[0].length<=j.start&&h.lastIndex>=j.end)return j.start=h.lastIndex-k[0].length,j.end=h.lastIndex,l.moveToBookmark(j),window.getSelection().removeAllRanges(),void this.rangy.getSelection().setSingleRange(l)}if("image"===a)return}var m="false"!=g(".md-focus").attr("contenteditable");if(File.isNodeHtml){m&&(editor.writingArea.setAttribute("contenteditable","false"),g(".md-focus").attr("contenteditable","true")),window.getSelection().modify("move","forward","word"),window.getSelection().modify("extend","backward","word");var l=this.getRangy(),n=/[\(\)\[\]\^&_\-+*#@!~`\\\/\{\}'":;<>,.?% ]+$/g.exec(l.toString());if(n&&l.toString()!=n[0]){var j=l.getBookmark(l.commonAncestorContainer.children?l.commonAncestorContainer:l.commonAncestorContainer.parentElement);j.end-=n[0].length,l.moveToBookmark(j),this.rangy.getSelection().setSingleRange(l)}}else{var o=window.getSelection().toString();if(b){var l=this.getRangy();return void(/\S\s$/.exec(o)&&l.endContainer.nodeType==document.TEXT_NODE&&(l.setEnd(l.endContainer,Math.max(l.endOffset-1,0)),l.select()))}m&&(editor.writingArea.setAttribute("contenteditable","false"),g(".md-focus").attr("contenteditable","true")),window.getSelection().modify("move","forward","word"),window.getSelection().modify("extend","backward","word")}m&&(editor.writingArea.setAttribute("contenteditable","true"),g(".md-focus").attr("contenteditable",""),editor.writingArea.focus())},selectPhrase:function(){function a(b){return b?b.nodeType===b.ELEMENT_NODE?b.hasAttribute("md-inline")&&b.getAttribute("md-inline")!==n.plain?b:b.hasAttribute("mdtype")?b:b.classList.contains("md-def-name")||b.classList.contains("md-def-content")||b.classList.contains("md-def-title")?b:a(b.parentElement):b.nodeType===b.TEXT_NODE?a(b.parentElement):null:null}function b(a,b,c){var d=a.getAttribute("md-inline");d==n.image&&(c=!1,a=a.children[0]),c?b.selectNodeContents(a):b.selectNode(a)}function c(){return/md-def-(name|url|title)|/gi.exec(document.activeElement.className)}if(this.editor.sourceView.inSourceMode){var d=this.editor.sourceView.cm,e=d.findWordAt(d.getCursor());return void d.extendSelection(e.anchor,e.head)}if(document.activeElement&&k.isType(document.activeElement.tagName,"INPUT"))return void document.activeElement.select();var f,h=this.getRangy(!0),i=!1;if(h){if(this.editor.styleBookmark.style){
var j=this.editor.styleBookmark.style.block;if(j.indexOf(n.def_footnote)>-1||j.indexOf(n.def_link)>-1?c()&&(i=!0,f=g(h.startContainer).closest(".md-def-name, .md-def-url, .md-def-title")[0]):j.indexOf(n.table)>-1&&(i=!0,f=g(h.startContainer).closest("[mdtype='table_cell']")[0]),f=f||a(h.startContainer))return b(f,h,i),this.setRange(h)}return this.selectWord()}},isCrossBlock:function(a){return a=a||this.getRangy(),a?a.collapsed?!1:this.editor.getJQueryElem(a.commonAncestorContainer).find("[mdtype]").length:a},getTextAround:function(){var a,b,c=this.getRangy();if(c&&c.collapsed){var d=g(c.startContainer).closest("[md-inline='plain'], .md-lang")[0],e=c.getBookmark(d);if(d)return c.setStartBefore(d),a=c.toString(),c.collapse(!1),c.setEndAfter(d),b=c.toString(),c.setStart(d,0),[a,b,e]}return[]},getCharCountInSelection:function(){var a=window.getSelection().toString();return a.length},getWordCountInSelection:function(){var a=window.getSelection().toString();return this.editor.EditHelper.getWordCount(a)}};var t=function(a){var b,c=a.getClientRects(),d=c.length&&c[c.length-1];return!d&&a.collapsed?(b=a.startContainer.nodeType==document.TEXT_NODE?a.startContainer.parentElement:a.startContainer,b.getBoundingClientRect()):d},u=function(a,b,c){function d(a){if(3==a.nodeType){var h=e+a.textContent.length;if(!g&&b>=e&&h>=b&&(f.setStart(a,b-e),g=!0),g&&c>=e&&h>=c)throw f.setEnd(a,c-e),i;e=h}else for(var j=0,k=a.childNodes.length;k>j;++j)d(a.childNodes[j])}if(!a)return window.getSelection().removeAllRanges();var e=0,f=h.createRange(),g=!1,i={};f.collapseToPoint(a,0);try{d(a)}catch(j){if(j==i)return f;throw j}};c.exports=o,c.exports.buildRange=u,c.exports.rangy=h}),define("app/editor/TableEdit",["jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/editor/UndoManager","app/editor/polyfill","app/editor/KeyMaster"],function(a,b,c){"use strict";function d(){e("#typora-table-row-tracker, #typora-table-col-tracker").hide().find(".typora-table-data-area").html("")}var e=a("jquery/jquery"),f=a("exoskeleton-master/exoskeleton"),g=a("app/document/Node"),h=g.TYPE,i=g.Node,j=a("app/editor/UndoManager"),k=(a("app/editor/polyfill"),a("app/editor/KeyMaster").map),l=99,m=20,n=f.Model.extend({initialize:function(a){function b(b){var c,d,f=/md-align-\S+/g.exec(this.className)[0].substring(9),g=e(this).closest("th").prevAll().length-1,h=e(this).closest('[mdtype="table"]'),i=a.findNodeByElem(h);c=i.get("align")[g],d=c==f?null:f,i.attr("align_idx",[g,d],a),b.stopPropagation()}function c(b){function c(){var a=e(this).closest("td"),b=a.prevAll().length+1,c=a.closest("tr").prevAll().length+1;c=1===c?2:c,g.find("a.md-active").removeClass("md-active"),g.find("tr:nth-child(-n+"+c+")>td:nth-child(-n+"+b+")>a").addClass("md-active"),g.find("#md-grid-width").val(b),g.find("#md-grid-height").val(c),g.find("#md-resize-grid").hide()}function d(){e(this).val().trim().length||e(this).val(2);var a=g.find("#md-grid-width").val(),b=g.find("#md-grid-height").val();g.find("a.md-active").removeClass("md-active"),g.find("tr:nth-child(-n+"+b+")>td:nth-child(-n+"+a+")>a").addClass("md-active")}function f(b){var c,d=g.find("#md-grid-width").val(),e=g.find("#md-grid-height").val(),f=j.getFirstChild(),h=j.get("align").length,k=0,l=a.undo.UndoManager.makeEmptyCommand();for(l.undo.push(a.undo.buildReplaceUndo(j));f||e>k;)e>k?(f?n.resizeRow(f,d,j):f=n.newEmptyRowAfter(c,d,j),c=f,f=c.get("after")):f&&(c=f,f=f.get("after"),c["delete"]()),k++;h>d?j.set("align",j.get("align").slice(0,d)):j.set("align",j.get("align").concat([].repeat(null,d-h))),i.replaceWith(j.toHTML()),B.showTableEdit(j),window.getSelection().removeAllRanges(),l.redo.push(a.undo.buildReplaceUndo(j)),a.undo.register(l)}var g,h='<div class="popover bottom md-table-resize-popover" style="display:block; bottom:auto; top:20px; margin-left:-10px;" contenteditable="false">					<div class="arrow" style="left:20px;"></div>					<div class="md-grid-board-wrap md-reset code-tooltip-content">						<table role="grid" class="md-grid-board md-reset">							<tbody>								<tr class="md-reset" row="1">									<td class="md-reset" col="1"><a href="#"></a></td>									<td class="md-reset" col="2"><a href="#"></a></td>									<td class="md-reset" col="3"><a href="#"></a></td>									<td class="md-reset" col="4"><a href="#"></a></td>									<td class="md-reset" col="5"><a href="#"></a></td>									<td class="md-reset" col="6"><a href="#"></a></td>								</tr>								<tr class="md-reset" row="2">									<td class="md-reset" col="1"><a href="#"></a></td>									<td class="md-reset" col="2"><a href="#"></a></td>									<td class="md-reset" col="3"><a href="#"></a></td>									<td class="md-reset" col="4"><a href="#"></a></td>									<td class="md-reset" col="5"><a href="#"></a></td>									<td class="md-reset" col="6"><a href="#"></a></td>								</tr>								<tr class="md-reset" row="3">									<td class="md-reset" col="1"><a href="#"></a></td>									<td class="md-reset" col="2"><a href="#"></a></td>									<td class="md-reset" col="3"><a href="#"></a></td>									<td class="md-reset" col="4"><a href="#"></a></td>									<td class="md-reset" col="5"><a href="#"></a></td>									<td class="md-reset" col="6"><a href="#"></a></td>								</tr>								<tr class="md-reset" row="4">									<td class="md-reset" col="1"><a href="#"></a></td>									<td class="md-reset" col="2"><a href="#"></a></td>									<td class="md-reset" col="3"><a href="#"></a></td>									<td class="md-reset" col="4"><a href="#"></a></td>									<td class="md-reset" col="5"><a href="#"></a></td>									<td class="md-reset" col="6"><a href="#"></a></td>								</tr>								<tr class="md-reset" row="5">									<td class="md-reset" col="1"><a href="#"></a></td>									<td class="md-reset" col="2"><a href="#"></a></td>									<td class="md-reset" col="3"><a href="#"></a></td>									<td class="md-reset" col="4"><a href="#"></a></td>									<td class="md-reset" col="5"><a href="#"></a></td>									<td class="md-reset" col="6"><a href="#"></a></td>								</tr>								<tr class="md-reset" row="6">									<td class="md-reset" col="1"><a href="#"></a></td>									<td class="md-reset" col="2"><a href="#"></a></td>									<td class="md-reset" col="3"><a href="#"></a></td>									<td class="md-reset" col="4"><a href="#"></a></td>									<td class="md-reset" col="5"><a href="#"></a></td>									<td class="md-reset" col="6"><a href="#"></a></td>								</tr>								<tr class="md-reset" row="7">									<td class="md-reset" col="1"><a href="#"></a></td>									<td class="md-reset" col="2"><a href="#"></a></td>									<td class="md-reset" col="3"><a href="#"></a></td>									<td class="md-reset" col="4"><a href="#"></a></td>									<td class="md-reset" col="5"><a href="#"></a></td>									<td class="md-reset" col="6"><a href="#"></a></td>								</tr>								<tr class="md-reset" row="8">									<td class="md-reset" col="1"><a href="#"></a></td>									<td class="md-reset" col="2"><a href="#"></a></td>									<td class="md-reset" col="3"><a href="#"></a></td>									<td class="md-reset" col="4"><a href="#"></a></td>									<td class="md-reset" col="5"><a href="#"></a></td>									<td class="md-reset" col="6"><a href="#"></a></td>								</tr>								<tr class="md-reset" row="9">									<td class="md-reset" col="1"><a href="#"></a></td>									<td class="md-reset" col="2"><a href="#"></a></td>									<td class="md-reset" col="3"><a href="#"></a></td>									<td class="md-reset" col="4"><a href="#"></a></td>									<td class="md-reset" col="5"><a href="#"></a></td>									<td class="md-reset" col="6"><a href="#"></a></td>								</tr>								<tr class="md-reset" row="10">									<td class="md-reset" col="1"><a href="#"></a></td>									<td class="md-reset" col="2"><a href="#"></a></td>									<td class="md-reset" col="3"><a href="#"></a></td>									<td class="md-reset" col="4"><a href="#"></a></td>									<td class="md-reset" col="5"><a href="#"></a></td>									<td class="md-reset" col="6"><a href="#"></a></td>								</tr>							</tbody>						</table>						<div class="popover-title">							<input id="md-grid-width" type="text"  max="20" size="2" min="1" value="0" /> x <input id="md-grid-height" maxlength="2" size="2" min="1" value="0"/><button id="md-resize-grid" class="btn btn-primary btn-xs">OK</button>						</div>					</div>				</div>',i=b.closest("table"),j=a.findNodeByElem(i),o=j.get("align").length,p=i.children("tbody").children("tr").length+1;e(".md-table-resize-popover").remove(),b.append(h),g=b.find(".md-table-resize-popover"),g.find("tr:nth-child(-n+"+p+")>td:nth-child(-n+"+o+")").addClass("md-grid-ext"),g.find("#md-grid-width, #md-grid-height").off("keydown keypress").on("keypress",function(a){return/\d/.exec(String.fromCharCode(a.which))?void 0:!1}).on("keydown",function(a){var b=a.keyCode||a.which;return"Up"===k[b]?(this.value=this.value-0+1,this.value=Math.min("md-grid-height"==this.getAttribute("id")?l:m,this.value),!1):"Down"===k[b]?(this.value=this.value-1,this.value=Math.max(2,this.value),!1):void 0}),g.find("#md-grid-width").val(o).off("blur focus").blur(d).focus(function(){g.find("#md-resize-grid").show()}).blur(function(){this.value>m?this.value=m:this.value<2&&(this.value=2)}).on("keydown",function(a){var b=a.keyCode||a.which;return"Tab"!==k[b]||a.ctrlKey?void("Enter"===k[b]&&g.find("#md-grid-height").focus()):(g.find("#md-grid-height").focus(),!1)}),g.find("#md-grid-height").val(p).off("blur focus").blur(d).focus(function(){g.find("#md-resize-grid").show()}).blur(function(){this.value>l?this.value=l:this.value<2&&(this.value=2)}).on("keydown",function(a){var b=a.keyCode||a.which;return"Tab"!==k[b]||a.ctrlKey?void("Enter"===k[b]&&g.find("#md-resize-grid").click()):(g.find("#md-grid-width").focus(),!1)}),g.find(".md-grid-board a").off("mouseenter mouseleave click").hover(c).click(function(a){a.stopPropagation(),a.preventDefault(),g.find("#md-resize-grid").click()}),g.find("#md-resize-grid").off("click").click(f)}function f(){var a=D.height();return D.closest("thead").length?"<table class='md-table' style='margin:0 ; padding:0; margin-left:0; height:"+a+"px;'><thead>"+D[0].outerHTML+"</thead></table>":"<table class='md-table' style='margin:0 ; padding:0; margin-left:0; height:"+a+"px;'><tbody>"+D[0].outerHTML+"</tbody></table>"}function g(a){var b=E[0].offsetWidth,c=C.height();return"<table class='md-table' style='margin:0 ; padding:0; height:"+c+"px; width:"+b+"px;'><thead><tr>"+a[0].outerHTML+"</tr></thead><tbody>"+a.toArray().map(function(a,b){return b?"<tr style='width:"+a.offsetWidth+"px; height:"+a.offsetHeight+"px;'>"+a.outerHTML+"</tr>":""}).join("")+"</tbody></table>"}function h(a){if(!File.isLocked){G=!0,window.getSelection().removeAllRanges(),u();var b=D.children();e("#typora-table-row-tracker .typora-table-data-area").html(f()).find("td, th").each(function(a){this.style.width=b[a].offsetWidth+"px"}),M=a.offsetX,N=a.offsetY,J=I=D.closest("thead").length?0:D.prevAll().length+1,L=[];var c=C.offset().top;return D.closest("table").find("[mdtype='table_row']").each(function(){L.push(this.offsetTop+c)}),L.push(L.last()+C.find("tbody tr:last-child")[0].offsetHeight),!1}}function j(a){if(!File.isLocked){H=!0,window.getSelection().removeAllRanges(),J=I=K;var b=v(J),c=e(b[0]).offset();e("#typora-table-col-tracker .typora-table-data-area").offset(c).html(g(b)),u(!0),M=a.offsetX,N=a.offsetY,L=[];var d=C.offset().left;C.find("thead:last-of-type th").each(function(){L.push(this.offsetLeft+d)}),L.push(L.last()+C.find("thead [mdtype='table_row'] th:last-child")[0].offsetWidth)}}function o(a){G?q(a):H&&p(a)}function p(a){if(H){e("#typora-table-col-tracker").css("left",a.clientX-M);var b;b=L.findIndex(function(b,c){return L[c]>a.clientX-M}),b>0&&(b-=1),-1==b&&(b=L.length-1),I!=b&&(I=b,s(I))}}function q(a){if(G){e("#typora-table-row-tracker").css("top",a.clientY-N-F+document.querySelector("content").scrollTop);var b;b=L.findIndex(function(b,c){return L[c]>a.clientY-N}),b>0&&(b-=1),-1==b&&(b=L.length-1),I!=b&&(I=b,r(I))}}function r(a){var b;if(a>=L.length-1)b=C.find("tbody tr:last-child").offset(),b.top+=C.find("tbody tr:last-child")[0].offsetHeight;else{var c=e(C.find("tr[mdtype]")[a]);if(c[0]==D[0]||!c.length)return void t();b=c.offset()}e("#typora-table-row-insert-marker").width(C[0].offsetWidth).show().offset(b)}function s(a){var b;if(a>=L.length-1)b=C.offset(),b.left+=C[0].offsetWidth;else{if(J==a||J+1==a)return void t();b=v(a).offset()}C.find(".md-table-edit").remove(),e("#typora-table-col-insert-marker").height(C[0].offsetHeight).show().offset(b)}function t(){e(".typora-table-insert-marker").hide()}function u(a){e("#write").addClass("no-selection"),File.preventScroll=!0,a?(v(K).addClass("typora-on-moving"),e("#typora-table-row-tracker").hide()):(D.addClass("typora-on-moving"),e("#typora-table-col-tracker").hide())}function v(a){return C.find("[mdtype='table_row']>*:nth-child("+(a+1)+")")}function w(a){File.preventScroll=!1,e("#write").removeClass("no-selection"),e("content").removeClass("prevent-scroll"),e(".typora-on-moving").removeClass("typora-on-moving"),t()}function x(a){G?z(a):H&&A(a)}function y(){G=!1,H=!1,C=null,D=null,E=null,J=null,I=null}function z(a){return G?(G=!1,w(),d(),B.moveTableRow(J,I,C),y(),!1):void 0}function A(a){return H?(H=!1,w(),d(),B.moveTableCol(J,I,C),y(),!1):void 0}var B=this;this.editor=a,this.TableEdit=n,e(a.sessionStr).on("click",".md-align-gp button",b).on("click",".md-delete-table",function(){a.tableEdit.deleteTable(e(this).closest("table"))}).on("click",".md-resize-table",function(a){e(this).next(".md-table-resize-popover").length?e(".md-table-resize-popover").remove():c(e(this).parent()),a.stopPropagation()}).on("click",".md-table-edit",function(a){e(a.target).closest(".md-table-resize-popover").length||e(".md-table-resize-popover").remove(),a.stopPropagation()}).on("refocus",".md-table",function(){console.debug("focuse on table"),e(document.activeElement).closest("[md-inline='image']").length||B.showTableEdit(e(this))}).on("mouseup",".md-table-edit",function(a){a.stopPropagation()}),function(){var b=e("#table-insert-dialog");b.find("#table-insert-col, #table-insert-row").off("keydown keypress keyup change").on("keypress",function(a){return/\d/.exec(String.fromCharCode(a.which))?void 0:!1}).on("keydown",function(a){var b=a.keyCode||a.which;return"Up"===k[b]?(this.value=this.value-0+1,this.value=Math.min("table-insert-row"==this.getAttribute("id")?l:m,this.value),!1):"Down"===k[b]?(this.value=this.value-1,this.value=Math.max(2,this.value),!1):void 0}).on("keyup",function(){e(this).trigger("change")}).on("change",function(){File.isMac&&app.touchBar&&app.touchBar.updateInsertTableTouchBar()}),b.find("#table-insert-col").blur(function(){0===e(this).val().trim().length&&e(this).val(2),this.value>m?this.value=m:this.value<1&&(this.value=1)}).on("keydown",function(a){var c=a.keyCode||a.which;return"Tab"===k[c]&&!event.ctrlKey||"Enter"===k[c]?(b.find("#table-insert-row").focus(),!1):void 0}),b.find("#table-insert-row").blur(function(){0===e(this).val().trim().length&&e(this).val(2),this.value>l?this.value=l:this.value<2&&(this.value=2)}).on("keydown",function(a){var c=a.keyCode||a.which;return"Tab"!==k[c]||event.ctrlKey?void("Enter"===k[c]&&b.find(".btn-primary").trigger("click")):(b.find("#table-insert-col").focus(),!1)}),b.find(".btn-primary").click(function(){b.modal("hide"),a.restoreLastCursor(),e(File.editor.sessionStr).trigger("cursorChange");var c=new i({type:i.TYPE.table,"in":a.nodeMap});n.valify(c,b.find("#table-insert-col").val(),b.find("#table-insert-row").val()),a.stylize.insertBlock(i.TYPE.table,c)})}(),function(){e(a.sessionStr).on("keydown",".md-table",function(a){var b=a.keyCode||a.which;return"Tab"!==k[b]||event.ctrlKey?"Enter"===k[b]?(a.metaKey||a.ctrlKey||a.shiftKey?B.addRow(!1):B.moveToBeblowCell(!0),!1):File.isMac&&i.isType(k[b],"Left","Right","Up","Down")&&a.metaKey&&a.ctrlKey?("Up"==k[b]?B.moveRowUpOrDown(!0):"Down"==k[b]?B.moveRowUpOrDown(!1):"Left"==k[b]?B.moveColLeftOrRight(!0):"Right"==k[b]&&B.moveColLeftOrRight(!1),!1):File.isNode&&i.isType(k[b],"Left","Right","Up","Down")&&a.shiftKey&&a.ctrlKey?("Up"==k[b]?B.moveRowUpOrDown(!0):"Down"==k[b]?B.moveRowUpOrDown(!1):"Left"==k[b]?B.moveColLeftOrRight(!0):"Right"==k[b]&&B.moveColLeftOrRight(!1),!1):!a.metaKey&&!a.ctrlKey||"Left"!==k[b]&&"Right"!==k[b]?void 0:(B.moveToNextCell(!1,"Left"===k[b],!0),!1):(B.moveToNextCell(!0,a.shiftKey),!1)})}();var C,D,E,F,G,H,I,J,K,L,M,N;setTimeout(function(){F=e("content").offset().top},200),function(){var b=e("#typora-table-row-tracker"),c=e("#typora-table-col-tracker");e(a.sessionStr).on("mouseenter click","th, td",function(a){if(E=e(this),0!=E.children("[mdtype]").length){D=E.closest("tr"),C=D.closest("table"),K=E.prevAll().length;var d=D.offset(),f=E.offset();b.show().offset(d).find(".typora-table-drag-area").height(D[0].offsetHeight+1),f.top=C.offset().top,c.show().offset(f).find(".typora-table-drag-area").width(E[0].offsetWidth+1)}}),e(document).on("mousedown","#typora-table-row-tracker",h).on("mousedown","#typora-table-col-tracker",j).on("mousemove",o).on("mouseup",x)}()},moveTableRow:function(a,b,c){if(this.editor.undo.completeSnap(!0),a!=b&&a+1!=b){c=c||this.editor.getMarkElem().closest(".md-table");var d=this.editor,e=d.selection.buildUndo(),f=j.makeEmptyCommand(e),g=d.findNodeByElem(c),h=g.getNthChild(a);f.undo.push(j.buildReplaceUndo(g)),b--,b>a&&b--,h.detach(),b>=0?g.getNthChild(b).insert(h):g.getFirstChild().insert(h,!0),f.redo.push(j.buildReplaceUndo(g)),c.replaceWith(g.toHTML()),e&&(d.undo.exeCommand(e),f.redo.push(d.selection.buildUndo())),d.undo.register(f),this.showTableEdit(g),console.debug("end move table row")}},moveTableCol:function(a,b,c){this.editor.undo.completeSnap(!0),c=c||this.editor.getMarkElem().closest(".md-table");var d=this.editor,e=d.selection.buildUndo(),f=j.makeEmptyCommand(e),g=d.findNodeByElem(c),h=g.getFirstChild(),i=h;if(a==b||a+1==b)return void this.showTableEdit(g);for(f.undo.push(j.buildReplaceUndo(g)),b--,b>a&&b--;i;){var k=i.getNthChild(a);k.detach(),b>=0?i.getNthChild(b).insert(k):i.getFirstChild().insert(k,!0),i=i.get("after")}f.redo.push(j.buildReplaceUndo(g)),c.replaceWith(g.toHTML()),e&&(d.undo.exeCommand(e),f.redo.push(d.selection.buildUndo())),d.undo.register(f),this.showTableEdit(g),console.debug("end move table col")},moveRowUpOrDown:function(a){var b=this.editor.selection.getRangy();if(b&&!File.isLocked){var c=e(b.commonAncestorContainer).closest("[mdtype='table_row']").closest("tr");if(0!=c.length){var d=c.closest("thead").length?0:c.prevAll().length+1;a&&0==d||!a&&d&&0==c.nextAll().length||this.moveTableRow(d,a?d-1:d+2,c.closest("table"))}}},moveColLeftOrRight:function(a){var b=this.editor.selection.getRangy();if(b&&!File.isLocked){var c=e(b.commonAncestorContainer).closest("[mdtype='table_cell']").closest("td, th");if(0!=c.length){var d=c.prevAll().length;a&&0==d||!a&&0==c.nextAll().length||this.moveTableCol(d,a?d-1:d+2,c.closest("table"))}}},insertTable:function(){File.isLocked||(this.editor.lastCursor=this.editor.selection.buildUndo(),e("#table-insert-dialog").modal({keyboard:!0}),File.isMac&&app.touchBar&&app.touchBar.showInsertTableTouchBar(),setTimeout(function(){e("#table-insert-col").focus()},500))},resizeTableEdit:function(a,b,c){for(var d=d||this.editor,b=b||a.closest(".md-table"),e=(d.findNodeByElem(b),b.offset()),f=b.width(),g=[],h=b.find("thead:nth-child(2)>tr>th"),i=(f-b.parent().width(),b.find("thead:first>tr:first>th:first").outerWidth(!0),0);i<h.length;i++)g.push(h[i].offsetWidth),f-=g[i];h=a.find("th");for(var i=0;i<h.length;i++)0!==i&&i!=h.length-1?(h[i].width=g[i-1],c&&c(h[i],i)):f-=h[i].offsetWidth;e.top-=a.height(),e.left+=f/2,a.offset(e)},showTableEdit:function(a){function b(a){var b,c=a.get("align"),d=[],e='<div class="btn-group btn-group-xs md-align-gp"><button type="button" class="btn btn-default md-align-left"><span class="glyphicon glyphicon-align-left"></span></button><button type="button" class="btn btn-default md-align-center"><span class="glyphicon glyphicon-align-justify"></span></button><button type="button" class="btn btn-default md-align-right"><span class="glyphicon glyphicon-align-right"></span></button></div>';for(d.push("<thead class='md-table-edit md-tooltip-remove' contenteditable='false' ><tr>"),d.push('<th class="md-th-button btn-group-xs .md-resize-table-th"><button type="button" class="btn btn-default md-resize-table"><span class="glyphicon glyphicon-th"></span></button></th>'),b=0;b<c.length;b++)d.push("<th>"),d.push(e),d.push("</th>");return d.push('<th class="md-th-button btn-group-xs"><button type="button" class="btn btn-default md-delete-table"><span class="glyphicon glyphicon-trash"></span></button></th>'),d.push("</tr></thead>"),d.join("")}function c(a,b){("left"===a||"right"===a||"center"===a)&&b.find(".md-align-"+a).addClass("active")}var d,f,g,h=a,i=a;a.jquery?h=editor.findNodeByElem(a):i=editor.findElemById(h.id),i.children(".md-table-edit").length||(e(".md-table-edit").remove(),f=b(h),d=h.get("align"),i.children("thead").before(f),g=i.children(".md-table-edit"),this.resizeTableEdit(g,i,function(a,b){c(d[b-1],e(a))}))},moveToNextCell:function(a,b,c){try{var d,e=this.editor.getMarkElem(window.getSelection().anchorNode).closest("[mdtype='table_cell']").parent(),f=(b?e.prev():e.next()).children("[mdtype='table_cell']");if(c){var g=this.editor.selection.getRangy(),h=g.getBookmark(e[0]);if(b&&h.end>0)return this.editor.selection.jumpIntoElemBegin(e),this.editor.refocus();if(!b&&h.start<e.text().length)return this.editor.selection.jumpIntoElemEnd(e),this.editor.refocus()}!f.length&&e.length&&(d=e.parent(),f=(b?d.prev().children(":last"):d.next().children(":first")).children("[mdtype='table_cell']"),f.length||(b&&"TD"===e[0].tagName?f=d.closest("table").find("thead:not(.md-table-edit)>tr>th:last>[mdtype='table_cell']"):b||"TH"!==e[0].tagName||(f=d.closest("table").find("tbody>tr:first>td:first>[mdtype='table_cell']")))),f.focus(),f.length&&(a?this.editor.selection.selectAllElem(f):b?this.editor.selection.jumpIntoElemEnd(f):this.editor.selection.jumpIntoElemBegin(f)),this.editor.refocus()}catch(i){}},moveToBeblowCell:function(a,b,c){try{var d=this.editor.getMarkElem(window.getSelection().anchorNode).closest("[mdtype='table_cell']"),e=this.editor.findNodeByElem(d),f=n.getNextCellInColumn(e,b),g=f&&this.editor.findElemById(f.cid);f?g.length&&(a?this.editor.selection.selectAllElem(g):b?this.editor.selection.jumpIntoElemEnd(g):this.editor.selection.jumpIntoElemBegin(g)):this.editor.selection.moveUpOrDown()}catch(h){}},getSibling:function(a,b){return n.getSibling(a,b)},unfocusAll:function(){e(".md-table-edit").remove(),e(".typora-table-tracker").hide()},deleteRow:function(){n.deleteRow(this.editor)},addRow:function(a){n.addRow(this.editor,a)},deleteCol:function(){n.deleteCol(this.editor)},addCol:function(a){n.addCol(this.editor,a)},copyTable:function(a){a=a||this.editor.getMarkElem(window.getSelection().anchorNode).closest("table");var b=a[0].outerHTML;this.editor.UserOp.setClipboard(b,b,a.text())},deleteTable:function(a,b){d(),editor.undo.completeSnap(!0),a=a||editor.getMarkElem(window.getSelection().anchorNode).closest("table");var c=this.editor.getNode(a.attr("cid")),e=editor.undo.UndoManager.makeEmptyCommand(this.editor.selection.buildUndo()),f=c.get("after"),g=c.get("before");return f||g?(j.addUndoForRemove(e,c),c.remove(),a.remove()):(e.undo.push(j.buildReplaceUndo(c)),c.set("type",h.paragraph),c.set("text",""),c.clearChildren(),i.normalizeNode(c),a.replaceWith(c.toHTML()),e.redo.push(j.buildReplaceUndo(c))),editor.focusCid=null,f?this.editor.selection.jumpIntoElemBegin(this.editor.findElemById(f.id)):this.editor.selection.jumpIntoElemEnd(this.editor.findElemById((g||c).id)),e.redo.push(this.editor.selection.buildUndo()),!b&&this.editor.undo.register(e),e},isTableEmpty:function(a){function b(a){for(var b=0,c=a.get("children").length;c>b;b++)if(a.get("children").at(b).get("text"))return!1;return!0}for(var c=0,d=a.get("children").length;d>c;c++)if(!b(a.get("children").at(c)))return!1;return!0}});n.deleteRow=function(a){e(".md-tooltip-hide").hide();var b,c,d,f,g,h=a.getMarkElem(window.getSelection().anchorNode).closest("td"),i=a.getMarkElem(window.getSelection().anchorNode).closest("tr[mdtype='table_row']"),j=i.prevAll().length;if(i.siblings().length){for(c=a.findNodeByElem(i).get("parent"),a.undo.completeSnap(!0),b=a.undo.UndoManager.makeEmptyCommand(),b.undo.push(a.selection.buildUndo()),b.undo.push(a.undo.UndoManager.buildReplaceUndo(c)),f=c.getNthChild(1),d=j;d;)f=f.get("after"),d--;f.remove(),b.redo.push(a.undo.UndoManager.buildReplaceUndo(c)),a.findElemById(c.id).replaceWith(c.toHTML()),j?j--:j++,g=document.createRange();try{g.setStart(a.findElemById(c.id).find("tbody>tr:nth-child("+(j+1)+")>td:nth-child("+(h.prevAll().length+1)+")>span")[0],0),window.getSelection().removeAllRanges(),window.getSelection().addRange(g),b.redo.push(a.selection.buildUndo())}catch(k){}a.undo.register(b),a.tableEdit.showTableEdit(c)}},n.addRow=function(a,b){e(".md-tooltip-hide").hide();var c,d,f,g=a.getMarkElem(window.getSelection().anchorNode).closest("tr[mdtype='table_row']"),h=(a.getMarkElem(window.getSelection().anchorNode).closest("td, th").prevAll().length,"TBODY"==g.parent()[0].tagName),i=h?g.prevAll().length+1:0;(!b||h)&&(d=a.findNodeByElem(g).get("parent"),a.undo.completeSnap(!0),c=a.undo.UndoManager.makeEmptyCommand(),c.undo.push(a.selection.buildUndo()),c.undo.push(a.undo.UndoManager.buildReplaceUndo(d)),f=d.getNthChild(i),f=n.newEmptyRowAfter(b?f.get("before"):f,f.get("children").length,d),h?g[b?"before":"after"](f.toHTML()):a.findElemById(d.id).replaceWith(d.toHTML()),a.selection.jumpIntoElemBegin(a.findElemById(f.getFirstChild().id)),c.redo.push(a.undo.UndoManager.buildReplaceUndo(d)),c.redo.push(a.selection.buildUndo()),a.undo.register(c),a.tableEdit.showTableEdit(d))},n.addCol=function(a,b){e(".md-tooltip-hide").hide();var c,d,f=a.getMarkElem(window.getSelection().anchorNode).closest("td, th"),g=f.find("[cid]").attr("cid"),h=f.prevAll().length;d=a.findNodeByElem(f.children("[cid]")).get("parent").get("parent"),a.undo.completeSnap(!0),c=a.undo.UndoManager.makeEmptyCommand(),c.undo.push(a.selection.buildUndo()),c.undo.push(a.undo.UndoManager.buildReplaceUndo(d)),d.get("children").toArray().map(function(a){a.getNthChild(h).insert(new i({type:i.TYPE.table_cell,text:""}),b)}),d.get("align").splice(b?h:h+1,0,null),a.findElemById(d.id).replaceWith(d.toHTML()),f=a.findElemById(g).closest("th, td"),a.selection.jumpIntoElemBegin(b?f.prev():f.next()),c.redo.push(a.undo.UndoManager.buildReplaceUndo(d)),a.undo.register(c),a.tableEdit.showTableEdit(d)},n.deleteCol=function(a){e(".md-tooltip-hide").hide();var b,c,d=a.getMarkElem(window.getSelection().anchorNode).closest("td, th"),f=d.prevAll().length,g=d.nextAll().length,h=d.closest("tr"),i="TBODY"==h.parent()[0].tagName,j=i?h.prevAll().length+1:0;if(f||g){c=a.findNodeByElem(d.children("[cid]")).get("parent").get("parent"),a.undo.completeSnap(!0),b=a.undo.UndoManager.makeEmptyCommand(),b.undo.push(a.selection.buildUndo()),b.undo.push(a.undo.UndoManager.buildReplaceUndo(c)),c.get("children").toArray().map(function(a){a.getNthChild(f).remove()}),c.get("align").splice(f,1),a.findElemById(c.id).replaceWith(c.toHTML());var k=document.createRange();try{j?k.setStart(a.findElemById(c.id).find("tbody>tr:nth-child("+j+")>td:nth-child("+(f+1)+")>span")[0],0):k.setStart(a.findElemById(c.id).find("thead>tr[mdtype]>th:nth-child("+(f+1)+")>span")[0],0),window.getSelection().removeAllRanges(),window.getSelection().addRange(k),b.redo.push(a.selection.buildUndo())}catch(l){}b.redo.push(a.undo.UndoManager.buildReplaceUndo(c)),a.undo.register(b),a.tableEdit.showTableEdit(c)}},n.getSibling=function(a,b){if(i.isType(a,i.TYPE.table_cell)){var b=b||"after",c=a.get(b),d=a.get("parent"),e=d.get(b);return!c&&e&&(c="after"==b?e.getFirstChild():e.getLastChild()),c}},n.getColumnIndex=function(a,b){return b=b||0,b++,(a?n.getColumnIndex(a.get("before"),b):b)-2},n.getCellAt=function(a,b){if(i.isType(a,i.TYPE.table_row)){for(var c=a.getFirstChild();b>0;)b--,c=c.get("after");return c}},n.getNextCellInColumn=function(a,b,c){if(i.isType(a,i.TYPE.table_cell)){var c=c||n.getColumnIndex(a),b=b||"after",d=a.get("parent"),e=d.get(b);return e?n.getCellAt(e,c):void 0}},n.resizeRow=function(a,b){for(var c,d=a.getFirstChild(),e=0;d||b>e;)b>e?(d||(d=new i({type:i.TYPE.table_cell,"in":c.get("in"),parent:a,before:c})),c=d,d=c.get("after")):d&&(c=d,d=c.get("after"),c["delete"]()),e++},n.newEmptyRowAfter=function(a,b,c){var d=new i({type:i.TYPE.table_row,"in":c.get("in"),parent:c,before:a,after:a?a.get("after"):null});new i({type:i.TYPE.table_cell,"in":c.get("in"),parent:d});return n.resizeRow(d,b),d},n.valify=function(a,b,c,d){var e;if(c=c||2,void 0===b&&(b=a.get("children").at(0),b=b?b.get("children").length:1),d&&1==a.get("children").length&&1==b)d(a,a.get("children").at(0).get("children").at(0).get("text"));else{a.get("children").map(function(a){for(var c=a.get("children").length;b>c;c++)c===a.get("children").length&&(e=a.getLastChild()),e=new i({type:i.TYPE.table_cell,parent:a,"in":a.get("in"),before:e,text:""})});for(var f=a.get("children").length;c>f;f++)n.newEmptyRowAfter(a.get("children").at(f-1),b,a);a.get("align")||a.set("align",new Array(b-0))}},i.TableEdit=n,c.exports=n}),define("app/editor/ImageEdit",["jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/editor/UserOp","app/editor/UndoManager","rangy/rangy-core","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/KeyMaster","app/editor/ConvertUtils","app/editor/Stylize","app/window/FileHelper","app/editor/Inline","app/editor/Selection","codemirror/lib/codemirror","app/editor/UndoManager","app/editor/EditHelper"],function(a,b,c){"use strict";function d(a){return/^\s*(file|data):/.exec(a)?!0:!1}var e=a("jquery/jquery"),f=a("exoskeleton-master/exoskeleton"),g=a("app/document/Node"),h=g.Node,i=g.TYPE,j=a("app/editor/UserOp"),k=a("app/editor/Inline"),l=a("app/editor/Selection"),m=l.rangy,n=a("app/editor/UndoManager"),o=a("app/editor/EditHelper"),p=a("app/document/StringUtils"),k=a("app/editor/Inline"),q=a("app/window/FileHelper"),r=window.reqnode?reqnode("electron").remote:null,s=null,t={},u=null,v="typora-copy-images-to",w="http://support.typora.io/Images/";window.imgLastModified=Math.floor((new Date-0)/1e3),window.uploadImageQueue=new Set,window.moveImageQueue=new Set;var x=f.Model.extend({initialize:function(a){this.editor=a,e(a.sessionStr).on("mousemove",".md-image>.md-meta",function(){event.offsetX-event.target.offsetLeft<20&&event.offsetY<30?this.classList.add("md-show-hint"):this.classList.remove("md-show-hint")}).on("mouseleave",".md-image>.md-meta",function(){this.classList.remove("md-show-hint")}).on("click","img",function(b){var c=e(b.target).closest(".md-image").addClass("md-expand"),d=m.createRange();d.moveToBookmark({containerNode:c.children(".md-meta")[0],start:2,end:2+(b.target.getAttribute("alt")||"").length}),a.selection.setRange(d)})},getLocalRootUrlForInsert:function(){return this.editor.docMenu.getLocalRootUrl()||File.option.useRelativePathForImg&&q.getCurrentFileFolderPath()||""},getRealSrc:function(a){function b(a,b){return"file://"+a.replace(/^file:\/\//,"").replace(/\/$/,"")+"/"+b.replace(/^\//gi,"")}if(!a)return a;if(/^data:/.exec(a))return a;try{var c=/^(file|ftp|https?):(\/\/|\\\\)/gi.exec(a);if(c)return a;if(File.isNode){var d=reqnode("path"),e=this.editor.docMenu.getLocalRootUrl();return File.isWin||!/^\//.exec(a)||e?"file://"+d.resolve(this.editor.docMenu.getLocalRootUrl()||q.getCurrentFileFolderPath()||"",a.replace(/^\s*(\\\\|\/)/,"")):"file://"+a}return/^(\/)|(\/\/)|(\\\\)|([a-z]+\:\\\\)/gi.exec(a)?b(this.editor.docMenu.getLocalRootUrl()||"",a||""):b(q.getCurrentFileFolderPath()||"",a||"");
}catch(f){}return a},updateImgRef:function(a){var b=this.editor.brush.inline;e("[data-ref='"+p.escape(a)+"']").each(function(){var a=(this.querySelector(".md-content")||{}).textContent;void 0!==a&&e(this).replaceWith(b.output(a))})},willUpdateImgRef:function(a){a&&(u&&clearTimeout(u),t[a]=!0,s=s||new Date,new Date-s>200?setTimeout(function(){Object.keys(t).map(this.updateImgRef,this)}.bind(this),10):u=setTimeout(function(){Object.keys(t).map(this.updateImgRef,this)}.bind(this),300))},refreshLocalImg:function(){var a=Math.floor((new Date-0)/1e3);e(".md-image img").each(function(){var b=File.editor.imgEdit.getRealSrc(this.parentElement.getAttribute("data-src")),c=b+"?lastModify="+imgLastModified;/^file:\/\//i.exec(b)&&(failImgCache.remove(c),loadedImgCache.remove(c),this.setAttribute("src",b+"?lastModify="+a),this.setAttribute("onload",k.onLoadEvaluate),this.setAttribute("onerror",k.onErrorEvaluate))}),imgLastModified=a},updateLocalRootUrl:function(){var a=this.editor.docMenu.getLocalRootUrl()||"";if(this.editor.localRootUrl!=a)for(var b=document.querySelectorAll("[md-inline='image']"),c=0;c<b.length;c++){var d=b[c],f=d.querySelector("img");if(d.getAttribute("data-src")!=f.getAttribute("src")){var h=e.parseHTML(k.decorate({type:g.TYPE.image,markdown:d.textContent,alt:f.getAttribute("alt"),href:d.getAttribute("data-src")}))[0];d.parentElement.replaceChild(h,d)}}},selectComponent:function(a){var b=this.editor.selection.getRangy(),c=e(b.startContainer).closest("[md-inline='image']"),d=c.text(),f=b.getBookmark(c[0]),g=d.indexOf("]"),h=n.makeEmptyCommand(this.editor.selection.buildUndo());a?(f.start=g+2,f.end=d.length-1):(f.start=2,f.end=g),b.moveToBookmark(f),this.editor.selection.setRange(b),h.redo.push(this.editor.selection.buildUndo()),this.editor.undo.register(h)},buildImageMapToUpload:function(){y={};for(var a,b,c=document.querySelectorAll(".md-image.md-img-loaded"),e=c.length,f=0;e>f;f++)a=c[f],b=a.querySelector("img").getAttribute("src"),d(b)&&(b=b.replace(/\?[^.]*$/,""),y[b]=y[b]||[],y[b].push(a));return Object.keys(y)},replaceImageMap:function(a,b){var c=JSON.parse(a),d=n.makeEmptyCommand(this.editor.selection.buildUndo()),f=this.editor,g=new Set;if(Object.keys(c).forEach(function(a){if(y[a]){var b=c[a];y[a].forEach(function(a){a.querySelector("img").src=b,a.hasAttribute("data-src")&&a.setAttribute("data-src",b);var c,j,k=f.findNodeByElem(e(a).closest("[cid]")),l=a.getAttribute("md-inline");if(!g.has(k)&&h.isType(l,i.image,i.imgtag)&&(g.add(k),d.undo.push(n.buildReplaceUndo(k))),c=a.querySelector(".md-content").textContent,l==i.image)j=c.replace(/(\(<?)((?:\([^)]*\)|[^()])*?)(>?[ \t]*((['"])(.*?)\4[ \t]*)?\))/,"$1"+b+"$3"),a.querySelector(".md-content").textContent=j;else if(l==i.imgtag)j=c.replace(/(src=(["'])).+?(\2)/i,"$1"+b+"$3"),a.querySelector(".md-content").textContent=j;else if(l==i.refimg){var m=/^!\[((?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*)\]\s*\[([^\]]*)\]/.exec(c),o=(m[2]||m[1]).replace(/\s+/g," "),p=f.nodeMap.link_list.getNodeByRef(o);if(g.has(p))return;g.add(p),d.undo.push(n.buildReplaceUndo(p)),p.set("href",b),f.findElemById(p.cid).replaceWith(p.toHTML())}})}}),g.forEach(function(a){a.get("type")!==i.def_link&&f.store(a,!0),d.redo.push(n.buildReplaceUndo(a))}),d.redo.push(f.selection.buildUndo()),f.undo.register(d),b){var j=Object.keys(c).length;o.showNotification("Successfully uploaded "+j+" images. <span class='btn-default btn-xs btn undo-btn' style='right: 40px;position: absolute;'>Undo</span>")}},insertImagesFromLocalFile:function(){if(!File.isLocked){var a=reqnode("electron").remote,b=a.getCurrentWindow(),c=(a.app,a.dialog),d=this.editor;c.showOpenDialog(b,{filters:[{name:"Images",extensions:["png","jpg","jpng","bmp","svg","tiff","webp","gif"]}],properties:["openFile","multiSelections"],buttonLabel:"Select"},function(a){a&&0!=a.length&&d.imgEdit.doInsertFromURLs(a)})}},doInsertFromURL:function(a){function b(){return File.isWin?a.match(/\\([^\\]+)\./g).last().replace(/\[|\]|\//g,""):a.match(/\/([^\/]+)\./g).last().replace(/\[|\]/g,"")}function c(){var a=window.getSelection(),b="";return!File.editor.sourceView.inSourceMode&&a.startOffset>0&&(b=" "),b}function d(a){a.removeClass("md-on-uploading").removeClass("md-on-moving"),a.find(".md-image-uploading-mask-wrapper").remove(),a.removeAttr("data-origin-path")}function f(a,b){return this.editor.brush.pause(),window.uploadImageQueue.add(b),t(a,b,!1),this.editor.brush.resume(),new Promise(function(a,c){app.ipic.upload(b,a,c)})}function g(a,b,c){return this.editor.brush.pause(),window.moveImageQueue.add(c),t(a,c,!0),this.editor.brush.resume(),File.isMac?h.call(this,a,b,c):i.call(this,a,b,c)}function h(a,b,c){return new Promise(function(a,d){app.ipic.copyImage(c,b,a,d)})}function i(a,b,c){return new Promise(function(a,d){var f,g=reqnode("fs-extra"),h=q.getFileNameFromPath(c);b=(b+"/").replace(/[\/\\]{2}$/,"/"),f=b+h,new Promise(function(a,c){g.stat(b,function(d){if(!d)return a();if("ENOENT"!=d.code)return c(!1);var f=e("#image-create-folder-confirm").find("#image-create-folder-target").text(b).end().modal({backdrop:"static",keyboard:!1});File.isLocked=!0,f.off("mousedown",".image-create-folder-dialog-yes, .image-create-folder-dialog-no, .image-create-folder-dialog-help, .close").one("mousedown",".image-create-folder-dialog-yes",function(){f.modal("hide"),File.isLocked=!1,File.freshMenu(),a()}).one("mousedown",".image-create-folder-dialog-no",function(){f.modal("hide"),File.isLocked=!1,File.freshMenu(),c(!1)}).one("mousedown",".close",function(){f.modal("hide"),File.isLocked=!1,File.freshMenu(),c(!1)}).on("mousedown",".image-create-folder-dialog-help",function(){r.shell.openExternal(w)})})}).then(function(){g.ensureDir(b,function(b){return b?d(b):void g.access(f,g.R_OK,function(b){b||(f=f.replace(/(\.[^.]+$)/,"-"+((new Date).getTime()+"").substring(3)+"$1")),g.copy(c,f,function(b){return b?d(b):void a(f)})})})},function(){d()})})}function l(a){var d,f=b(),g=c(),h=z.selection.getRangy();h&&(d=e(h.startContainer).closest("[md-inline='image']")).length?(m.call(this,d,a),this.selectComponent(!0)):(a=this.resolveImagePath(a),j.pasteHandler(this.editor,g+"!["+f.substring(1,f.length-1)+"]("+a+")",!0))}function m(a,b){b=this.resolveImagePath(b);var c=this.editor,d=a.find(".md-content").text(),f=d.replace(/(\(<?)((?:\([^)]*\)|[^()])*?)(>?[ \t]*((['"])(.*?)\5[ \t]*)?\))/,"$1"+b+"$3"),g=c.selection.buildUndo(),h=n.makeEmptyCommand(g),i=e.extend({},g),j=f.length-d.length,k=c.findNodeByElem(a.closest("[cid]"));return c.undo.completeSnap(!0),i.start+=j,i.end+=j,h.undo.push(n.buildReplaceUndo(k)),a.find(".md-content").text(f),c.store(k,!0),c.brush.addToQueue(a.closest("[cid]").attr("cid")),c.brush.resume(),h.redo.push(n.buildReplaceUndo(k)),h.redo.push(i),c.undo.register(h),i}function o(a){var d=this.editor,f=d.getMarkElem();if(!f.length||!d.stylize.canContainInline(f))return!1;j.backspaceHandler(d,null,"delSelection");var g,h=b(),i=c(),k=d.getNode(f.attr("cid")),l=i+"!["+h.substring(1,h.length-1)+"]("+a+")",o=d.selection.getRangy();if(!o)return null;if((g=e(o.startContainer).closest("[md-inline='image']")).length)return m.call(this,g,a),this.selectComponent(!0),g;var p=o.getBookmark(f[0]).start,q=({id:k.cid,type:"cursor",start:p+l.length},d.selection.prepNode("​",null,!0)||n.makeEmptyCommand());return q.undo.push(d.selection.buildUndo()),j.insertInlineText(d,k,l,q),d.brush.brushNode(k.cid),o.moveToBookmark({containerNode:d.findElemById(k.cid)[0],start:p,end:p}),g=e(o.startContainer).closest(".md-image"),g.find("img").attr("src","file://"+a),d.undo.register(q),g}function s(a){var b=e("[data-origin-path="+JSON.stringify(a)+"]");return d(b),uploadImageQueue["delete"](a),moveImageQueue["delete"](a),b}var t=k.applyUploadingStyle;if(a&&/\.(png|jpg|jpeg|svg|gif|bmp|webp|tiff)$/gi.exec(a)){var u,v,x=a,y=this,z=this.editor,A=this.getTagetImageStorageFolder();if(!/^[^:]+:\/\//.exec(a)&&A)if(this.editor.undo.completeSnap(!0),File.isMac&&"ipic"==A){if(app.ipic.validateBeforeUpload()&&(u=o.call(this,x),u&&u.length))return v=this.editor.getNode(u.closest("[cid]").attr("cid")),void f.call(this,u,x).then(function(a){u=s(x),m.call(y,u,a)},function(a){u=s(x),m.call(y,u,x),a&&setTimeout(function(){e("#md-notification").html("<p style='padding-right: 100px;'>Failed to upload image. Error Message: <code>"+p.escape(a)+"</code><span class='btn-default btn-xs btn ok-btn' style='right: 40px;position: absolute;bottom: 8px;'>Close</span></p>").show()},500)})}else if(A&&(x=q.normalizePath(x),0!=x.indexOf(A)||x.substring(A.length+1).match(/[\\\/]/g)))return u=o.call(this,x),void(u&&u.length&&(v=this.editor.getNode(u.closest("[cid]").attr("cid")),g.call(this,u,A,x).then(function(a){u=s(x),m.call(y,u,a)},function(a){u=s(x),m.call(y,u,x),console.error(a),a&&setTimeout(function(){e("#md-notification").html("<p style='padding-right: 100px;'>Failed to Copy Image to Target Folder. <code>"+p.escape(a)+"</code><span class='btn-default btn-xs btn ok-btn' style='right: 40px;position: absolute;bottom: 8px;'>Close</span></p>").show()},500)})));l.call(this,a)}},doInsertFromURLs:function(a){var b=this.editor;a.forEach(function(a,c){c>0&&b.UserOp.insertParagraph(!1,b),b.imgEdit.doInsertFromURL(a)})},resolveImagePath:function(a){if(/^[^:]+:\/\//.exec(a))return a;var b=this.getLocalRootUrlForInsert(),c=q.getCurrentFileFolderPath();if(b&&b.length){var d=p.getRelativePath(b,a);b==c&&(d=d.replace(/^\s*(\\\\|\/)/,"")),a=("."!=d[0]&&this.editor.docMenu.getLocalRootUrl()?"/":"")+d}else{if(!File.option.useRelativePathForImg||!c||0!==a.indexOf(c))return a;a=a.substring(c.length).replace(/^\//,"")}return File.isWin&&(a=a.replace(/\\+/g,"/")),a},getTagetImageStorageFolder:function(){var a=this.editor.docMenu.getValueInMeta(v);if(a&&!File.editor.sourceView.inSourceMode){if(File.option.allowImageUpload&&"ipic"==a.toLowerCase())return"ipic";if(File.option.allowImageMove&&q.getCurrentFileFolderPath()){var b=q.getCurrentFileFolderPath();if(b)return/[\\\/]$/.exec(b[b.length-1])||(b+="/"),q.normalizePath(b+a)}}return null},toggleCopyToFolder:function(){var a=reqnode("electron").remote,b=a.getCurrentWindow(),c=a.dialog,d=this,e=this.getTagetImageStorageFolder(),f=q.getCurrentFileFolderPath();if(File.refreshImageCopyStatus(!0),!File.isLocked&&!File.editor.sourceView.inSourceMode)if(e)this.doRemoveImageCopyToFolder(!1);else{if(!f)return void c.showMessageBox(b,{title:"Document must be saved first.",message:"Typora will copy newly inserted image to folder by selected relative path, so please save the file first.",buttons:["OK"]});if(!File.option.allowImageMove)return void c.showMessageBox(b,{title:"One More Step",message:"To use this feature, please enable the option `Allow copy images to given folder` on Preferences Panel first.",buttons:["Learn More...","Close"]},function(b){0==b&&a.shell.openExternal(w)});c.showOpenDialog(b,{defaultPath:q.getCurrentFileFolderPath(),title:"Select Container Folder",properties:["openDirectory","createDirectory"],buttonLabel:"Select"},function(a){a&&0!=a.length&&d.doSetImageCopyToFolder(a[0])})}},toggleUseImageRootPath:function(){var a=reqnode("electron").remote,b=a.getCurrentWindow(),c=a.dialog,d=this.editor.docMenu.getLocalRootUrl(),e=this.editor;d?this.editor.docMenu.removeProperty("typora-root-url"):c.showOpenDialog(b,{defaultPath:q.getCurrentFileFolderPath(),title:"Select Container Folder",properties:["openDirectory","createDirectory"],buttonLabel:"Select"},function(a){a&&0!=a.length&&e.imgEdit.doSetImageRootPath(a[0])})},doSetImageCopyToFolder:function(a,b){a=b&&File.isMac?"ipic":p.getRelativePath(q.getCurrentFileFolderPath(),a,!0),this.editor.docMenu.writeProperty(v,a)},doSetImageRootPath:function(a){this.editor.docMenu.writeProperty("typora-root-url",p.getRelativePath(q.getCurrentFileFolderPath(),a,!0)),this.refreshLocalImg()},doRemoveImageCopyToFolder:function(a){return this.editor.docMenu.removeProperty(v,a)}}),y={};c.exports=x}),define("app/editor/UserOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/UndoManager","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/KeyMaster","app/editor/ConvertUtils","app/editor/TableEdit","app/editor/Stylize","app/editor/Emoji","app/editor/EditHelper","app/window/FileHelper"],function(a,b,c){"use strict";function d(a){var b=e(a,null,!0);return"string"==typeof b?b:y.convertToPlain(b)}function e(a,b,c){b||(M.reset(!0),b=M);var d,e,f=$($.parseHTML("<div>"+a+"</div>")[0]),g=[],h=f.children("[mdtype]");return h.length?(h.each(function(){e=t.reverse($(this),b,c),e.set("before",d),d=e,g.push(e)}),g):c?(f.find("[data-emoji]").text(function(){return this.getAttribute("data-emoji")}),f.find(".md-meta, .md-content").remove(),f.text()):f.textExcludeSVG()}function f(a,b,c){var d=e(a,b);if(t.isType(d[0],u.line)){var f=new t({type:u.paragraph,"in":d[0].get("in")});return d.map(function(a){f.append(a)}),[f]}return d}function g(a){var b=f(a);return"string"==typeof b?b:t.markFromArr(b)}function h(a,b){var c,d;if(a=a.getClosetParagraphLevel(),t.isType(a.get("before"),u.list))return a;if(c=S(a,function(a){return t.isType(a.get("parent"),u.list_item)}),!c&&b)for(d=b;d;){if(d==a||d.contains(a))return d;d=d.get("after")}return c}function i(a,b){return a=a.getClosetParagraphLevel(),S(a,function(a){return t.isType(a.get("parent"),u.list_item)})}function j(a){return S(a,function(a){return t.isType(a.get("parent"),u.blockquote)})}function k(a,b){return a?a.get("after")?b(a.get("after").getVeryFirst()):k(a.get("parent"),b):null}function l(a,b){for(b=b||1;b>0&&a;)a.unset("tail"),a=a.getLastChild(),b--}function m(){if(!ga){var a="\\{\\(\\[\"'";File.option.autoPairExtendSymbol&&(a+="*`~_",File.option.enableInlineMath&&(a+="$"),File.option.enableSuperscript&&(a+="^"),File.option.enableHighlight&&(a+="=")),ga=new RegExp("^["+a+"]$")}return ga}function n(){if(!ha){var a="\\{\\(\\[\"'";File.option.autoPairExtendSymbol&&(a+="*`~_",File.option.enableInlineMath&&(a+="$"),File.option.enableSuperscript&&(a+="^")),ha=new RegExp("["+a+"]")}return ha}function o(){if(!ia){var a="*`_";File.option.enableInlineMath&&(a+="$"),ia=new RegExp("^["+a+"]$")}return ia}var p=(a("exoskeleton-master/exoskeleton"),a("app/document/StringUtils")),q=a("app/document/Node"),r=a("app/editor/UndoManager"),s=r.SnapFlag,t=q.Node,u=q.TYPE,v=q.NodeCollectionUtils,w=(a("rangy/rangy-core.js"),a("app/document/MarkParser")),x=a("app/editor/TableEdit"),y=a("app/editor/ConvertUtils"),z=a("app/editor/Stylize"),A=a("app/editor/Emoji"),B=(a("app/editor/EditHelper"),a("app/window/FileHelper")),C=window.reqnode?reqnode("electron").remote:null,D="skipCommand",E="",F=function(a,b,c,d,e,f){console.debug("insertInlineText"),b=b||function(){return i=a.getMarkElem(),a.getNode(i.attr("cid"))}();var g=a.getJQueryElem(window.getSelection().anchorNode),h=null,i=a.findElemById(b.id);if(t.noChangeLine(b)&&(c=c.trim().split(/[\n\r]+/gi)[0]),"\n"==c&&i.text().length<=d&&(c="\n​"),e&&e.undo.push(r.buildReplaceUndo(b,void 0)),g.hasClass("md-def-name"))i=g.closest("[cid]"),h=a.docMenu.getAttrByElem(g),a.selection.getRangy().insertNode(document.createTextNode(p.escape(c))),b.set("ref",g.text());else if(g.hasClass("md-def-url"))i=g.closest("[cid]"),h=a.docMenu.getAttrByElem(g),c=c.replace(/\s/gi,""),a.selection.getRangy().insertNode(document.createTextNode(p.escape(c))),b.set("href",g.text());else if(g.hasClass("md-def-title"))i=g.closest("[cid]"),h=a.docMenu.getAttrByElem(g),a.selection.getRangy().insertNode(document.createTextNode(p.escape(c))),b.set("title",g.text());else{var j,k="",l=d;g.hasClass("md-meta-block")&&0==g.text().length&&"\n​"==c?j="\n\n":(g.hasClass("md-meta-block")&&k.length==d&&"\n"==k[d-1]?d--:g.closest(".md-def-content").length?(l-=b.get("ref").length,k=g.closest(".md-def-content").textExcludeSVG()):(k=i.textExcludeSVG(),t.isType(b,u.meta_block)&&(k=k.replace(/\n$/,""))),j=void 0!==l?k.substring(0,l)+c+k.substring(l):k.text()+c),b.set("text",j.replace("​","")),i.html($(b.toHTML()).html())}e&&(a.store(b,!0),e.redo.push(r.buildReplaceUndo(b,void 0)));var m={id:b.id,type:"cursor",start:d+c.length};f&&(a.undo.exeCommand(m),a.brush.addToQueue(b.id)),e&&e.redo.push(m),a.brush.addToQueue(b.id),i=a.findElemById(b.id),f&&i.addClass("md-focus")},G=function(a,b,c,d,e){if(File.isMac)setTimeout(function(){d&&app.clipboard.clearContents(),a&&app.clipboard.copyForType(a,"text/html"),app.clipboard.copyForType(b,"text/markhtml"),c&&app.clipboard.copyForType(c,"text/plain")},20);else if(File.isNode&&e){if("cut_before"===File._CopyContentFlag||a){if(!a)return setTimeout(C.getCurrentWindow().webContents.copy,30),void(File._CopyContentFlag="cut_after");ba(File.editor,null,"delSelection"),File._CopyContentFlag=!1}else if("cut_after"===File._CopyContentFlag)File._CopyContentFlag=!1,a=(K(C.clipboard.readHTML())||[])[0],ba(File.editor,null,"delSelection");else{if(!File._CopyContentFlag||a)return File._CopyContentFlag=!0,void(!a&&setTimeout(C.getCurrentWindow().webContents.copy,30));File._CopyContentFlag===!0&&(a=(K(C.clipboard.readHTML())||[])[0]),File._CopyContentFlag=!1}c&&e.clipboardData.setData("text/plain",c),a&&e.clipboardData.setData("text/html",a),e.clipboardData.setData("text/markhtml",b),e.preventDefault()}else File.isNode&&(C.clipboard.writeHTML(a),C.clipboard.writeText(c))},H=function(a,b){b=b||File.editor;var c,d,e,f,g=$($.parseHTML("<div>"+a+"</div>"));return g.find(".md-fences").toArray().map(function(a){c=a.getAttribute("cid"),d=$(a),d.attr("lang",b.findNodeByElem(d).get("lang")),d.text(b.fences.getValue(c))}),g.find(".md-emoji").toArray().map(function(a){d=$(a),d.text(":"+d.attr("data-content")+":")}),g.find("[mdtype='math_block']").toArray().map(function(a){c=a.getAttribute("cid"),d=$(a),d.text(b.mathBlock.getTex(c))}),g.find(".md-math-after-sym").remove(),e=g.children("li[cid]"),e.length&&(f=$(document.querySelector("[cid='"+e[0].getAttribute("cid")+"']").parentElement).clone(),f.empty().append(e).wrap("div"),g=f.parent()),g},I=function(a,b){a=a||File.editor;var c=document.activeElement,d=a.selection.getRangy();if(a.sourceView.inSourceMode)G(null,null,File.editor.sourceView.cm.getSelection(),!0,b);else if("HR"==c.getAttribute("mdtype"))G(null,null,"---",!0,b);else if(c.getAttribute("mdtype")!==u.math_block||d&&!d.collapsed){if("INPUT"==c.tagName||"TEXTAREA"==c.tagName||0==c.childElementCount)G(null,null,c.value||c.innerText,!0,b);else if(window.getSelection().rangeCount){var e=H(d.toHtml(),a),f="";f=e.html(),G(null,f,g(f),!0,b)}}else G(null,null,"$$\n"+a.mathBlock.getTex(c.getAttribute("cid"))+"\n$$",!0,b);File._CopyContentFlag=!1},J=function(a,b){a=a||File.editor;var c=document.activeElement,d=a.selection.getRangy();if(a.sourceView.inSourceMode)G(null,null,File.editor.sourceView.cm.getSelection(),!0,b);else if("HR"==c.getAttribute("mdtype"))G(null,null,"<hr/>",!0,b);else if(c.getAttribute("mdtype")!==u.math_block||d&&!d.collapsed){if("INPUT"==c.tagName||"TEXTAREA"==c.tagName||0==c.childElementCount)G(null,null,c.value||c.innerText,!0,b);else if(window.getSelection().rangeCount){var e=H(d.toHtml(),a),g="";g=e.html();var h=f(g),i=a["export"].exportCollection(h,null,!0,!0,!0);G(null,"<pre mdtype='fences' lang='HTML'>"+p.escape(i)+"</pre>",i,!0,b)}}else G(null,null,"$$\n"+a.mathBlock.getTex(c.getAttribute("cid"))+"\n$$",!0,b)},K=function(a){var b=$.parseHTML(a),c="<!DOCTYPE html>",d="<!DOCTYPE html>",e=File.option.showLineNumbersForFence?"  ":"";if(!b)return["",""];b.map(function(a){var b=$(a),f=b.find(".md-emoji").andSelf(".md-emoji");f.text(function(a){return $(f[a]).children("[data-emoji]").attr("data-emoji")}),b.find(".md-meta, .md-content").remove(),b.find(".md-fences").andSelf(".md-fences").html(function(){var a=this.querySelectorAll("pre");if(a.length){for(var b=[],c=0;c<a.length;c++)b.push(e+a[c].innerHTML);return b.join("\n")}return this.innerHTML+"<br/><br/>"}),b.find(".md-line, h1, h2, h3, h4, h5, h6, .md-def-link, .md-def-footnoote").css("width",""),c+=a.outerHTML,a.getAttribute&&a.getAttribute("mdtype")==u.toc||(b.find(".md-toc").remove(),b.find(".mathjax-block").andSelf(".mathjax-block").html(function(){try{return File.editor.findElemById(this.getAttribute("cid")).find("script").text()}catch(a){return""}}).css("font-size","1rem"),b.find(".md-line").oldReplaceWith(function(){return this.innerHTML+(this.nextSibling?"\n":"")}),b.find("li p").oldReplaceWith(function(){return this.innerHTML+(this.nextSibling?"\n":"")}),b.find("ul, ol, .md-def-link, .md-def-footnoote, blockquote, .md-fences, .mathjax-block").after("<br/>"),b.find(".md-def-name").before("[").after("]   "),d+=a.outerHTML,t.isType(a.tagName,"UL","OL")&&(d+="<br/>"))});return[c,d]},L=function(a,b){if("copyAsMarkdown"===File._CopyContentFlag)return I(a,b);if("copyAsHTMLSource"===File._CopyContentFlag)return J(a,b);var c=document.activeElement,e=a.selection.getRangy(),f=$(e.commonAncestorContainer);if(a.sourceView.inSourceMode&&G(null,null,File.editor.sourceView.cm.getSelection(),!0,b),"hr"==c.getAttribute("mdtype"))G(c.outerHTML,null,"---",!0,b);else if("toc"==c.getAttribute("mdtype"))G(c.outerHTML,"<div mdtype='toc'><div>","[toc]",!0,b);else if("IMG"==c.tagName)G(c.outerHTML,null,c.getAttribute("src"),!0,b);else if(c.getAttribute("mdtype")!==u.math_block||e&&!e.collapsed){if("INPUT"==c.tagName||"TEXTAREA"==c.tagName)return b||console.error("in copyHandler : shouldn't be here"),!0;if(window.getSelection().rangeCount){f.find(".md-emoji").text(function(){return A.data[this.getAttribute("data-content")]}),f.find(".math-jax-postprocess").text(function(){return this.querySelector("script").textContent.replace(/\u200B*/g,"")}).parent().addClass("md-expand");var h=H(e.toHtml(),a),i=h.html(),j=File.option.copyMarkdownByDefault?g(i):d(i).replace(/\u200B/gi,"");f.find(".md-emoji").html(function(){var a=this.getAttribute("data-content");return"​<span data-emoji='"+A.data[a]+"' class='md-emoji-span'></span><span class='md-meta'>:"+a+":</span>​"}),f.find(".math-jax-postprocess").html(function(){var a=$(this).textExcludeSVG().replace(/\u200B*/g,"");return svgCache["$"+a+"$"]||svgCache["$$"+a+"$$"]||a}).parent().removeClass("md-expand"),G(null,i,j,!1,b)}}else{var k=a.mathBlock.getTex(c.getAttribute("cid"));G(c.querySelector(".MathJax_Display").outerHTML,"<div mdtype='"+u.math_block+"'>"+k+"</div>",k,!0,b)}},M=new q.NodeMap,N=function(a,b,c){function d(a,b){return a.get("attr")&&a.get("attr").trim().length?a.get("attr"):void 0}function e(a){return t.isType(a,t.TYPE.line,t.TYPE.heading,t.TYPE.raw_edit,t.TYPE.fences,t.TYPE.table_cell)?a.get("text"):(!t.isType(a,u.def_footnote)||d(a,"ref")&&d(a,"text"))&&(!t.isType(a,u.def_link)||d(a,"ref")&&d(a,"href"))?a.get("children").reduce(function(a,b){return a+e(b)}," "):d(blocks[0],"ref")||d(blocks[0],"href")||d(blocks[0],"text")||d(blocks[0],"title")||""}function g(b,c,d,f){function g(a,b,c,d){a.set("text",a.safeGetStrAttr("text").substr(0,b)+e(c).split(/\r|\n|\r\n/)[0])}function h(a){for(var b=a.getFirstChild().getFirstChild(),c=[];b;)c.push(b),b=i.getSibling(b),c.last().detach();return a.remove(),c}var i=a.tableEdit.TableEdit,j=b.get("parent").get("parent"),k=b,l=k;f.undo.push(r.buildReplaceUndo(j));var m=[];d.forEach(function(a){a.get("type")==u.table?m=m.concat(h(a)):m.push(a)});for(var n=0;n<m.length;n++)g(k,0===n?c:0,m[n]),l=k,k=t.isType(m[n],u.table_cell)?i.getSibling(k):i.getNextCellInColumn(k);a.findElemById(j.id).replaceWith(j.toHTML()),f.redo.push(r.buildReplaceUndo(j)),a.selection.jumpIntoElemEnd(a.findElemById(l.id)),f.redo.push(a.selection.buildUndo())}function h(a){for(var b=[],c=-2,d=0;d<a.length;d++){var e=a[d];t.isType(e,u.table_cell)?(c!==d-1?(e.set("type",u.paragraph),b.push(e)):(b.last().set("text",b.last().get("text")+"  "+e.get("text")),e.remove()),c=d):b.push(e)}return b}function i(b,c,d,e,f){d.undo.push(a.selection.buildUndo());var h=f(e,a.nodeMap,a,E);if("string"==typeof h)return k(b,c,h,d);if(0!=h.length){if(t.isType(b,u.table_cell))g(b,c,h,d);else if(t.isType(b,u.table_row,u.table));else{var i=b.getClosetBlock();t.isType(i.get("parent"),u.list_item)?d.undo.push(a.undo.buildReplaceUndo(i.get("parent"))):d.undo.push(a.undo.buildReplaceUndo(i));var j=b===a.nodeMap.getFirst()&&0===c,m=[];h.map(function(a,b){t.isType(a,u.meta_block)&&!(0==b&&j)&&m.push(a)}),m.map(function(a){h.remove(a)});var n=t.splitAt(b,c,a,t.genNormalSplitExitFunc(!1,!1,!0));l(n.prev,n.next,h,d,n.opt_prev,n.opt_next)}a.undo.register(d)}}function j(a,b,c){var d=a.canContainBlock()?a.getLastChild():a,e=b.canContainBlock()?b.getFirstChild():b,f=-1;if(!e.canContainBlock()){var g=e.getVeryFirst(),h=d.getVeryFirst(!0);f=h.get("text").length,h.set("text",h.get("text")+g.get("text")),0==f&&t.isType(d,u.paragraph)&&1==d.get("children").length&&!t.isType(g,u.line)&&(t.property.map(function(a){d.set(a,g.get(a))}),d.set("text",h.get("text")),h.remove()),g.remove(),e.isDeleted()||(0==e.get("children").length?e.remove():t.isType(e,u.paragraph)&&t.isType(d,u.paragraph)&&(d.getLastChild().insertTillEnd(e.getFirstChild()),e.remove())),e.isDeleted()||0!=e.get("children").length||e.remove()}return e.isDeleted()||(d.insert(e),t.isEmptyBlock(d)&&d.remove()),b.isDeleted()||(0==b.get("children").length?b.remove():t.isType(b,u.list_item)?(a.getLastChild().insertTillEnd(b.getFirstChild()),b.remove()):t.isType(b,u.paragraph)&&t.isType(a,u.paragraph)&&(a.getLastChild().insertTillEnd(b.getFirstChild()),b.remove())),c&&c.redo.push(r.buildReplaceUndo(a)),f}function k(b,c,d,e){console.debug("pasteText");var f=d.split(/\r?\n/g);if(f.length>1&&!f[0].trim().length&&f[1].trim().length&&(f=f.slice(1)),t.noChangeLine(b)&&(f=[f[0]]),f.length<=1||z.CONST.NoInline.indexOf(b.get("type"))>-1)F(a,b,f.join("\n"),c,e,!0),a.undo.register(e);else{e.undo.push(a.selection.buildUndo()),e.undo.push(r.buildReplaceUndo(b.getClosetParagraphLevel()));var g=t.splitAt(b,c,a,t.genNormalSplitExitFunc(!1,!1,!0)),h=t.parseFrom(f.join("\n"),g.prev.get("in"),{noTop:!g.prev.get("attachTo")||c,skips:{old_code:!1}},!0);l(g.prev,g.next,h[1],e,g.opt_prev,g.opt_next),a.undo.register(e)}}function l(b,c,d,e,f,g){function i(a){for(var b=1;b<a.length;b++)if(a[b].get("type")!=a[b-1].get("type"))return!1;return!0}function k(a){if(t.isType(a,u.list_item))l(a);else{e.redo.push(r.buildReplaceUndo(a)),1==d.length&&t.isType(d[0],u.blockquote)&&t.isType(a.get("parent"),u.blockquote)?(a.insert(d[0]),d=d[0].unwrap(),o=d.slice(0),o.unshift(a)):(a.insertArray(d,!1,!0),o=[a].concat(d));var b,h=a.get("after");t.isType(h,u.table)||(a.canContainBlock()||!h||h.canContainBlock()||(j(a,h,e),h.isDeleted()&&(d.remove(h),o.remove(h))),b=o.last().getVeryFirst(!0,!0),c.isDeleted()||c.canContainBlock()||b.canContainBlock()||(m=b.getVeryFirst(!0),p=j(b,c,e))),d.length&&r.addUndoForInsertArray(e,d),t.isEmptyBlock(a)&&!h.isDeleted()&&(r.addUndoForRemove(e,a),a.remove(),o.remove(a)),f&&o.unshift(f),!c.isDeleted()&&o.push(c),0>p&&(m=o.last()),g&&o.push(g)}}function l(a){var b=a.get("after"),h=a.get("parent");if(e.undo.push(r.buildReplaceUndo(a)),t.isType(d[0],u.list)?(n=a.id,a.insert(d[0]),o=d[0].unwrap().clone(),j(a,o.shift(),e),o.length&&r.addUndoForInsertArray(e,o),o.unshift(a),d.shift(),c.isDeleted()||(p=j(o.last().getVeryFirst(!0,!0),c,e))):i(d)&&t.isType(d[0],u.list_item)?(a.insertArray(d,!1,!0),j(a,d.shift(),e),o=d.clone(),o.length&&r.addUndoForInsertArray(e,o),o.unshift(a),c.isDeleted()||(p=j(o.last().getVeryFirst(!0,!0),c,e))):(b=new t({type:u.list_item}),a.insert(b),d.map(function(a){b.append(a)}),j(a,b,e),o=[a],d=[]),!c.isDeleted()&&o.push(c),d.length){var k;n=h.cid,h.insertArray(d,!1,!0),o=[h],o=o.concat(d),b&&(n=h.cid,e.undo.push(r.buildReplaceUndo(h)),h.unset("ahead"),h.unset("tail"),k=h.clone(),k.unset("start"),h.giveChildrenTo(k,b,null,!0),d.last().insert(k),o.push(k)),g=null,f=null}else m=o.last()}console.debug("pasteBlocks");var m,n=b.id,o=d.slice(0),p=-1;d=h(d),m=d.last().getVeryFirst(!0),(t.isEmptyBlock(c)||t.isType(c,u.list_item)&&1==c.get("children").length&&t.isEmptyBlock(c.getFirstChild()))&&c.remove(),t.isType(b,u.blockquote,u.list)||(k(b),c.isDeleted()||r.addUndoForInsert(e,c),f&&r.addUndoForInsert(e,f),g&&r.addUndoForInsert(e,g),a.findElemById(n).replaceWith(q.NodeCollectionUtils.toHTML(o)),p>=0?a.selection.jumpInto(a.findElemById(m.cid),p):m==c?a.selection.jumpIntoElemBegin(a.findElemById(c.cid)):a.selection.jumpIntoElemEnd(a.findElemById(m.getVeryFirst(!0).cid)),e.redo.push(a.selection.buildUndo()),setTimeout(function(){a.refresh()},100))}E="",console.time("pasteHandler"),File._PasteContentFlag=!1;var m="string"!=typeof b||c?null:b,n="string"==typeof b&&c?b:null,o="object"==typeof b?b:null;if("INPUT"==document.activeElement.tagName)return!0;if("TEXTAREA"==document.activeElement.tagName){if(console.debug("pasteHandler: focused in input element"),!o&&n){var p=$(document.activeElement).closest(".CodeMirror");p&&(p=p[0].CodeMirror,p.replaceSelection(n))}return!0}if(t.isType(B,u.hr))return!1;if("BODY"==document.activeElement.tagName)return!1;a.undo.completeSnap(!0);var s,v,n,w,x=a.selection.prepNode("​",null,!0)||r.makeEmptyCommand(),A=a.getMarkElem(),B=a.findNodeByElem(A),C=File.isNode?reqnode("electron").remote.app:window.app;if(o){if(o.preventDefault(),n=o.clipboardData.getData("text/plain"),n&&(n=n.replace(/(\r?\n)$/,"")),m=o.clipboardData.getData("text/html"),w=o.clipboardData.getData("text/markhtml"),File.isMac&&!m&&!w){var D=C.clipboard.getHTML()||["",""];m=D[0],E=D[1]}}else n||File.isMac&&(n=C.clipboard.paste());if(File.isMac&&!m&&!w&&!c){var G=C.ipic.getImageInClipboard();if(G&&G.length)return O(a,G),a.selection.scrollAdjust(),console.timeEnd("pasteHandler"),!1}if(File.isNode&&!m&&!w&&!c&&a.imgEdit.getTagetImageStorageFolder()){var H=reqnode("electron").clipboard.readImage();if(!H.isEmpty()){var I=C.getPath("temp").replace(/[\/\\]$/,"")+(File.isWin?"\\\\":"/")+Number(new Date)+".png";try{reqnode("fs").writeFileSync(I,H.toPNG())}catch(J){return!1}return O(a,[I]),a.selection.scrollAdjust(),console.timeEnd("pasteHandler"),!1}}x.undo.push(a.selection.buildUndo()),x=r.append(x,ba(a,o,"delSelection",!0)),B=a.findNodeByElem(a.getMarkElem()),s=a.selection.getRangy(),v=s.getBookmark(a.findElemById(B.id)[0]).start,c=c||s.startContainer&&$(a.getJQueryElem(s.startContainer)).closest(".md-def-url, .md-def-name, .md-def-title, pre, code").length,w&&!c?i(B,v,x,w,f):m&&!c?i(B,v,x,m,y.parseHTML):k(B,v,n,x),a.selection.scrollAdjust(),console.timeEnd("pasteHandler")},O=function(a,b){if(window.app){if(app.document.isLocked())return}else if(File.isLocked)return!1;a.sourceView.inSourceMode||b.forEach(function(b,c){c&&ea(!1,a),P(a,b)})},P=function(a,b){if(b){var c=/\.(png|jpe?g|svg|gif|bmp|webp|tiff)$/gi.exec(b);if(c)a.imgEdit.doInsertFromURL(b);else{var d=B.getFileNameFromPath(b),b=p.getRelativePath(B.getCurrentFileFolderPath(),b),e="["+d.replace(/(^|[^\\])]/,"$1\\]")+"]("+b.replace(/(^|[^\\])\)/,"$1\\)")+")";N(a,e,!0)}}};t.wrapListItem=function(a){var b=a.get("children");if(!b.length){new t({type:u.paragraph,"in":a.get("in"),parent:a,text:a.get("text")});a.set("text","")}};var Q=function(a,b,c){if(t.isType(b,u.line)&&!b.get("before")&&(b=b.get("parent")),t.isType(b.get("parent"),u.blockquote)&&(c||!b.get("before"))){var d=r.makeEmptyCommand(a.selection.buildUndo()),e=b.upStream();return r.append(d,e.command),a.findElemById(e.oldCid).replaceWith(e.newHtml),a.undo.exeCommand(d.undo[0]),d.redo.push(a.selection.buildUndo()),d}if(t.isType(b.get("parent"),u.list_item)&&(c||!b.get("parent").get("before")&&!b.get("before"))){var d=r.makeEmptyCommand(a.selection.buildUndo()),f=b.get("parent"),g=f.get("parent");d.undo.push(r.buildReplaceUndo(g)),g.unset("start"),f.set("parent",null),f.set("after",null),g.insert(f,!0);var h=f.unwrap();return r.addUndoForInsertArray(d,h),a.findElemById(g.id).before(q.NodeCollectionUtils.toHTML(h)),g.get("children").length?(a.findElemById(g.id).replaceWith(g.toHTML()),d.redo.push(r.buildReplaceUndo(g))):(r.addUndoForRemove(d,g),g.remove(),a.findElemById(g.id).remove()),a.selection.jumpIntoElemBegin(a.findElemById(h[0].id)),
d.redo.push(a.selection.buildUndo()),d}},R=function(a,b,c,d){var e,f=a;if(a==b)return null;for(e=a.get(c);e;)d(e,f),f=e,e=f.get(c);return R(a.get("parent"),b,c,d),f},S=function(a,b){if(b(a))return a;var c=a.get("parent");return c?S(c,b):null},T=function(a,b){return t.isType(a,u.list)&&t.isType(a.get("before"),u.list)&&a.get("style")==a.get("before").get("style")?(a.get("before").appendTillEnd(a.getFirstChild()),a.remove(),b&&b.remove.push(a.cid),!0):void 0},U=function(a){var b=a.selection.getRangy();if(!b||File.isLocked)return!0;if(t.isType(document.activeElement.tagName,"TEXTAREA","INPUT")){var c=$(document.activeElement).closest(".CodeMirror")[0];return c&&c.CodeMirror.execCommand("indentMore"),!0}var d=a.getMarkElem(b.startContainer),e=h(a.findNodeByElem(d)),f=a.getMarkElem(b.endContainer),g=h(a.findNodeByElem(f),e);a.undo.completeSnap(!0),a.brush.pause(),e&&!g&&(g=e.closest(u.list).getLastChild().getFirstChild());var i=!1;if(e&&g){var j=a.selection.buildUndo(),k=r.makeEmptyCommand(j);return i=V(a,e,g,k,b),i&&(k.redo.push(j),i.remove.forEach(function(b){a.findElemById(b).remove()}),i.replace.forEach(function(b){b.isDeleted()||a.findElemById(b.cid).replaceWith(b.toHTML())}),a.undo.exeCommand(j),a.undo.register(k)),a.refresh(),a.brush.resume(),i||e!==g}return a.brush.resume(),!1},V=function(a,b,c,d,e,f){function g(a){var b,c,e,g=a.get("before");if(t.isType(g,u.list))return e=a.get("after"),d.undo.push(r.buildReplaceUndo(g)),r.addUndoForRemove(d,a),g.getLastChild().getLastChild().set("tail",g.get("tail")||g.getLastChild().get("tail")||g.getLastChild().getLastChild().get("tail")),l(g,2),g.getLastChild().append(a),l(a),t.isType(e,u.list)&&e.get("style")==g.get("style")&&(r.addUndoForRemove(d,e),T(e,f)),d.redo.push(r.buildReplaceUndo(g)),f.remove.push(a.cid),f.replace.push(g),!0;if(b=a.get("parent"),c=b.get("before"),!g&&c){var h=c.getLastChild();return d.undo.push(r.buildReplaceUndo(c)),t.isType(h,u.list)?(h.getLastChild().set("tail",c.get("tail")||h.get("tail")),c.set("tail",a.get("tail"))):(c.getLastChild().set("tail",c.get("tail")),l(c),h=b.get("parent").clone(),h.unset("start"),l(h),c.append(h),c.set("tail",a.get("tail")),l(a)),i(h,c,a),!0}}function i(a,b,c){var e,g=c.get("parent");return r.addUndoForRemove(d,g),e=c.get("after"),a.append(g),e&&(e.set("before",null),b.set("tail",g.get("tail")),l(g),b.appendTillEnd(e),l(b.getLastChild(),2),T(e,f)),l(g,2),d.redo.push(r.buildReplaceUndo(b)),f.remove.push(g.cid),f.replace.push(b),!0}function j(a){var b,c=a.get("before");return c?(d.undo.push(r.buildReplaceUndo(c)),b=c.getLastChild(),t.isType(b,u.list)?b.getLastChild().set("tail",c.get("tail")||b.get("tail")):(b=c.get("parent").clone(),b.unset("start"),c.getLastChild().set("tail",c.get("tail")),c.append(b),l(b)),r.addUndoForRemove(d,a),b.append(a),c.set("tail",a.get("tail")),l(a,2),d.redo.push(r.buildReplaceUndo(c)),f.remove.push(a.cid),f.replace.push(c),!0):!1}f=f||{replace:[],remove:[]};var m,n,o,p=b.get("parent"),q=b.get("before");if(q)o=g(b);else{if(!p.get("before")){if(n=p.get("parent"),m=n.get("before"),!t.isType(m,u.list)||m.get("style")!=n.get("style"))return!1;d.undo.push(r.buildReplaceUndo(m)),r.addUndoForRemove(d,n),m.getLastChild().set("tail",Math.min(m.get("tail"),1)),m.set("tail",n.get("tail")),T(n,f),d.redo.push(r.buildReplaceUndo(m)),f.remove.push(n.cid),f.replace.push(m)}e.containsNode(document.querySelector("[cid='"+p.getLastChild().cid+"']"),!0)?(o=j(p),b=p):o=g(b)}return!o||b==c||b.contains(c)||c.contains(b)||(b=k(b,h),b&&V(a,b,c,d,e,f)),o&&f},W=function(a){function b(){a.undo.completeSnap(!0),a.brush.pause(),e=a.selection.buildUndo(),f=r.makeEmptyCommand(e)}var c=a.selection.getRangy();if(!c||File.isLocked)return!0;if(t.isType(document.activeElement.tagName,"TEXTAREA","INPUT")){var d=$(c.startContainer).closest(".CodeMirror")[0];return d&&d.CodeMirror.execCommand("indentLess"),!0}c=a.selection.deRange(c);var e,f,g=a.getMarkElem(c.startContainer),h=i(a.findNodeByElem(g)),k=a.getMarkElem(c.endContainer),l=i(a.findNodeByElem(k));h&&!l&&(l=h.closest(u.list).getLastChild().getFirstChild());var m=!1;if(h&&l&&(b(),m=Z(a,h,l,f,c)),m||(h=j(a.findNodeByElem(g).getClosetParagraphLevel()),l=j(a.findNodeByElem(k).getClosetParagraphLevel()),t.isType(h,u.paragraph,u.def_footnote,u.def_link,u.heading)&&l&&(b(),m=X(a,h,l,f,c))),m){for(var n=0;n<m.length;n++){Object.keys(m[n])[0];a.findElemById(m[n].oldCid).replaceWith(m[n].html)}a.undo.exeCommand(e),f.redo.push(e),a.mathBlock.renderAll(),a.undo.register(f)}return a.brush.resume(),m&&h!=l},X=function(a,b,c,d,e,f){function g(){var a,c,e=b.get("parent"),g={},h=[];g.oldCid=e.cid,d.undo.push(r.buildReplaceUndo(e)),b.get("before")?(c=[b],h.push(e),b.get("after")&&(a=e.clone(),c.push(a),a.appendTillEnd(b.get("after")),e.insert(a)),e.insert(b),e.set("tail",e.getLastChild().get("tail")),l(e.getLastChild()),h.push(b),a&&h.push(a),d.redo.push(r.buildReplaceUndo(e)),r.addUndoForInsertArray(d,c)):(r.addUndoForRemove(d,b),e.insert(b,!0),r.addUndoForInsert(d,b),h.push(b),e.get("children").length?(d.redo.push(r.buildReplaceUndo(e)),h.push(e)):(r.addUndoForRemove(d,e),e.remove())),g.html=v.toHTML(h),f.push(g)}for(f=f||[],g();b&&b!=c&&!b.contains(c)&&!c.contains(b);)b&&(b=k(b,j)),g();return f},Y=function(a,b){for(var c=[],d=a;d!=b;)c.push(d),d=d.get("after");return b&&c.push(b),c},Z=function(a,b,c,d,e,f){function g(){m=b.getLastBrother(),d.undo.push(r.buildReplaceUndo(p)),q.oldCid=p.get("parent").cid,p.get("after")&&(n=Y(p.get("after")),r.addUndoForRemoveArray(d,n),j=p.get("parent").clone(),j.unset("start"),p.get("parent").set("tail",p.getLastChild().get("tail")),l(p,2),j.appendTillEnd(p.get("after")),p.append(j),T(j)?j=null:n.push(j),r.addUndoForInsertArray(d,n)),l(b.get("before")),n=Y(b),p.get("parent").insertTillEnd(b),d.redo.push(r.buildReplaceUndo(p)),r.addUndoForInsertArray(d,n),b=m,n.unshift(p.get("parent")),q.html=v.toHTML(n),f.push(q)}function h(){var a,b;p.get("after")&&(a=p.get("parent").clone(),a.unset("start"),p.getLastChild().set("tail",p.get("tail")),l(p),l(p.get("after")),a.appendTillEnd(p.get("after")),p.append(a)),a=p.get("parent"),b=a.get("parent"),a.get("after")&&(l(a),p.set("tail",b.get("tail")||p.get("tail")),a.getLastChild().appendTillEnd(a.get("after"))),b.insert(p),0==a.get("children").length&&a.remove(),b.set("tail",b.getLastChild().get("tail")),l(b.getLastChild()),q.oldCid=b.cid,q.html=v.toHTML(Y(b,p)),f.push(q)}f=f||[];var j,m,n,o=b.get("before"),p=b.get("parent"),q={};if(o)g();else{var s=p.get("parent").get("parent");if(s=s&&s.get("parent"),!t.isType(s,u.list)||!p.get("parent").get("before"))return!1;if(d.undo.push(r.buildReplaceUndo(s)),m=p.getLastChild(),!e.containsNode(document.querySelector("[cid='"+p.getLastChild().cid+"']"),!0)&&t.isType(c.get("before"),u.list)){var w=c.get("before");w.getLastChild().getLastChild().set("tail",w.get("tail"),w.getLastChild().get("tail")),l(w,2),w.set("tail",c.getLastBrother().get("tail")),l(c.getLastBrother()),w.getLastChild().appendTillEnd(c)}h(),b=m,d.redo.push(r.buildReplaceUndo(s))}return m=k(b,i),f&&m&&e.containsNode(document.querySelector("[cid='"+m.cid+"']"),!0)&&Z(a,m,c,d,e,f),f},_=function(a,b,c,d){var e=r.makeEmptyCommand(a.selection.buildUndo());return e.undo.push(r.buildReplaceUndo(b)),b.set("type",u.paragraph),b.clearChildren(),c?b.set("text",""):b.set("text",b.get("text").replace(/\u200B|(\r?\n)/g,"")),t.normalizeNode(b),e.redo.push(r.buildReplaceUndo(b)),a.findElemById(b.id).replaceWith(b.toHTML()),a.selection.jumpIntoElemBegin(a.findElemById(b.id)),e.redo.push(a.selection.buildUndo()),!d&&$(a.sessionStr).trigger("cursorChange"),e},aa=function(a,b,c,d){if(b&&b.length){c&&c.preventDefault(),!d&&a.undo.completeSnap(!0);var e=a.findNodeByElem(b),f=r.makeEmptyCommand(a.selection.buildUndo());return e?(e.set("text",""),f=r.append(f,_(a,e))):(e=a.findNodeByElem(b.closest("[mdtype]")),f.undo.push(r.buildReplaceUndo(e)),a.selection.moveLeftOrRight(!0),b.remove(),a.store(e.id),f.redo.push(r.buildReplaceUndo(e)),f.redo.push(a.selection.buildUndo())),!d&&a.undo.register(f),f}},ba=function(a,b,c,d,e){function f(a,b,c,d,e){var f,g=3!==c.commonAncestorContainer.nodeType,h=a.getNode(d.attr("cid"));if(e||(a.undo.snap(h.cid,N?s.DELETE_ACCROSS_BLOCK:s.DELETE),a.brush.pause(!0)),J=r.makeEmptyCommand(a.selection.buildUndo(R)),J.undo.push(r.buildReplaceUndo(h)),f=c.extractContents(),a.store(h.cid),J.redo.push(r.buildReplaceUndo(h)),J.redo.push(a.selection.buildUndo()),f.querySelector("img"),c.collapse(!1),g){var i=d.attr("cid");g=a.selection.saveSelection(d,c),a.store(i,!0),d.replaceWith(a.nodeMap.allNodes.get(i).toHTML()),a.selection.restoreSelection(a.findElemById(i),g),a.focusCid=null,a.refocus()}return a.brush.addToQueue(d.attr("cid")),!e&&a.brush.resume(!0),b&&(b.preventDefault(),$("#write").trigger("input")),J}function g(a,b,c){var d,e=a;if(a==b)return null;for(d=a.get(c);d;)$("[cid='"+d.id+"']").remove(),d.remove(),d=a.get(c);return g(a.get("parent"),b,c),e}function h(a,b,c,d,e){var f,h,i,j=b.cloneRange(),k=a.findElemById(c.id);return j.setEndAfter(k[0]),a.selection.deRange(j),h=a.findNodeByElem(a.getMarkElem(j.startContainer)),!e&&$(j.startContainer).closest("table").length?(r.append(d,w(a,j,!0)),h=a.findNodeByElem($(j.startContainer).closest("table")),c.contains(h)&&(g(h,c,"after"),0===h.getText().length)?(r.append(d,_(a,h)),"abortAndSkipCursor"):"abort"):(d.undo.push(r.buildReplaceUndo(c)),f=$(j.extractContents()),t.isType.apply(null,[c].concat(z.CONST.Selectable))&&r.append(d,_(a,c,!0,!0)),a.store(h,!0),i=g(h,c,"after"),f.text().length||f.find("img").length||i?(d.redo.push(r.buildReplaceUndo(c)),h):!1)}function i(a,b,c,d,e){var f,h,i,j=b.cloneRange(),k=a.findElemById(c.id);return j.setStartBefore(k[0]),a.selection.deRange(j),!e&&$(j.endContainer).closest("table").length?(r.append(d,w(a,j,!0)),h=a.findNodeByElem($(j.endContainer).closest("table")),c.contains(h)&&(g(h,c,"before"),0===h.getText().length&&r.append(d,_(a,h))),"abort"):(d.undo.push(r.buildReplaceUndo(c)),h=a.findNodeByElem(a.getMarkElem(a.selection.getEndNode(j))),f=$(j.extractContents()),a.store(h,!0),i=g(h,c,"before"),f.text().length||f.find("img").length||i?(d.redo.push(r.buildReplaceUndo(c)),h):!1)}function j(a,b,c){var d=a.selection.getDetailPos(b.startContainer,b.startOffset),e=a.selection.getDetailPos(b.endContainer,b.endOffset),f=a.getMarkElem(d[0]),g=a.getMarkElem(e[0]),j=a.findNodeByElem(f),l=a.findNodeByElem(g),m=t.getTreePosition(j,l),n=m[1],o=m[2],p=r.makeEmptyCommand(a.selection.buildUndo()),q=b.cloneRange();if(f[0]==g[0])return p;if(q.collapse(!0),q=a.selection.buildUndo(q),b.setStart(d[0],d[1]),b.setEnd(e[0],e[1]),$(b.commonAncestorContainer).closest('[mdtype="table"]').length)return r.append(p,w(a,b));for(var s=h(a,b,n,p),u=i(a,b,o,p),x=n.get("after"),y=[];x&&x!=o;)y.push(x),x=x.get("after");return r.addUndoForRemoveArray(p,y,n,o),y.map(function(b){a.findElemById(b.id).remove(),b.remove()}),"abort"==s||"abort"==u||"abortAndSkipCursor"==s?(console.debug("abort, before/after is table"),"abortAndSkipCursor"!=s&&(b.collapse(!0),p.redo.push(q),a.undo.exeCommand(q)),u===!1&&0==l.getText().length&&(r.addUndoForRemove(p,l),a.findElemById(l.id).remove(),l.remove())):s||u||y.length||c?k(a,s||j,u||l,n,o,p,s):(console.log("less indent"),p=v(a,l,o,j,n)),a.refresh(),p}function k(a,b,c,d,e,f,g){function h(a,b){return a==b||a.get("before")||a.get("after")?a:h(a.get("parent"),b)}console.debug("spliceStartAndEnd");var i,j,k,l,m=t.isEmptyBlock(d);if(!m||d==e||t.isEmptyBlock(e)&&!g)if(m&&d==e&&e.isBlock())e.set("type",u.paragraph),e.clearChildren(),a.findElemById(e.id).replaceWith(e.toHTML()),a.selection.jumpIntoElemBegin(a.findElemById(e.id)),f.redo.push(a.selection.buildUndo());else{if(console.assert(b!=c,"Error on spliceStartAndEnd"),b!=c){if(i=c.safeGetStrAttr("text"),l=h(c,e),r.addUndoForRemove(f,l),a.findElemById(l.id).remove(),l.remove(),j=$(b.toHTML()).textExcludeSVG().length,f.undo.push(r.buildReplaceUndo(d)),t.isType(b,u.def_link))if(b.safeGetStrAttr("title").length)b.set("title",b.get("title")+i);else{var n=/["']([^"]*)["']\s*$/g.exec(i);i=i.replace(/"([^"])*"\s*$/,""),n&&b.set("title",n[1]),b.set("href",b.get("href")+i)}else b.set("text",b.safeGetStrAttr("text")+i);if(l!=e&&e!==c&&e.get("before")==d&&t.isType(d,u.list_item)){var o=e.getFirstChild();o.set("before",d.getLastChild()),e.giveChildrenTo(d,o),r.addUndoForRemove(f,e),a.findElemById(e.id).remove(),e.remove()}f.redo.push(r.buildReplaceUndo(d)),a.findElemById(d.id).replaceWith(d.toHTML()),k=a.findElemById(b.id)}k=a.findElemById(b.id),a.selection.restoreSelection(k,j),f.redo.push(a.selection.buildUndo())}else a.findElemById(d.id).remove(),r.addUndoForRemove(f,d),d.remove(),l=h(c,e),a.findElemById(l.id).replaceWith(l.toHTML()),a.selection.jumpIntoElemBegin(a.findElemById(l.id))}function l(a,b){var c,d=r.makeEmptyCommand(a.selection.buildUndo()),e=b.get("before"),f=e.get("children").at(e.get("children").length-1).getLastBrother();return d.undo.push(r.buildReplaceUndo(e.get("parent"))),a.findElemById(b.id).remove(),f.insert(b),c=b.unwrap(),d.redo.push(r.buildReplaceUndo(e.get("parent"))),a.findElemById(f.id).after(q.NodeCollectionUtils.toHTML(c)),a.selection.jumpIntoElemBegin(a.findElemById(c[0].id)),d.redo.push(a.selection.buildUndo()),d}function m(a,b){function c(b){var c=r.makeEmptyCommand(a.selection.buildUndo());return r.addUndoForRemove(c,b),a.findElemById(b.id).remove(),b.remove(),c.redo.push(a.selection.buildUndo()),c}t.isType(b,u.line)&&!b.get("before")&&(b=b.get("parent"));var d=b.get("before");return t.isType(d,u.hr)?c(d):d&&!t.isEmptyBlock(b)&&t.isEmptyBlock(d)?c(d):!d&&t.isType(b.get("parent"),u.list_item)&&(d=b.get("parent").get("before"),d&&1==d.get("children").length&&t.isEmptyBlock(d.get("children").at(0)))?c(d):void 0}function n(a,d){if(t.isType(d,u.table_cell)){var e=d.get("parent").get("parent");if(b&&!c&&!d.get("before")&&!d.get("parent").get("before")&&a.tableEdit.isTableEmpty(e))return a.tableEdit.deleteTable(a.findElemById(e.cid),!0);var f=x.getSibling(d,"before");return f&&(J=r.makeEmptyCommand(a.selection.buildUndo()),a.selection.jumpIntoElemEnd(a.findElemById(f.id)),J.redo.push(a.selection.buildUndo())),J}}function o(a,b){return t.isType(b,u.line)&&!b.get("before")&&(b=b.get("parent")),t.isType(b.get("parent"),u.list_item)&&b.get("parent").get("before")&&!b.get("before")?l(a,b.get("parent")):void 0}function p(a,b){return t.isType(b,t.backToParagraphBeforeDelete)?(a.stylize.changeBlock(u.paragraph,b),D):void 0}function v(a,b,c,d,e){for(var f=[n,m,Q,o,p],g=null,h=0;h<f.length;h++)if(g=f[h](a,b))return g;if(c=t.isType(b,u.line)&&!b.get("before")?c||b.get("parent"):c||b,e=e||c.get("before"),d=d||e&&e.getVeryFirst(!0),!g&&d&&(g=r.makeEmptyCommand(a.selection.buildUndo()),k(a,d,b,e,c,g)),!g&&!d&&t.isType(b,u.paragraph)&&t.isEmptyBlock(b)&&b.get("after")){console.debug("delete empty node and promise after node"),g=r.makeEmptyCommand(a.selection.buildUndo());var i=b.get("after").cid;r.addUndoForRemove(g,b),b.remove(),a.findElemById(b.cid).remove(),a.selection.jumpIntoElemBegin(a.findElemById(i)),g.redo.push(a.selection.buildUndo())}return g}function w(a,b,c){console.debug("backspaceOnTableHandler");var d,e=a.selection.getDetailPos(b.startContainer,b.startOffset),f=a.selection.getDetailPos(b.endContainer,b.endOffset),g=r.makeEmptyCommand(),j=a.getMarkElem(e[0]),k=a.getMarkElem(f[0]),l=j.closest('[mdtype="table"]'),m=a.findNodeByElem(l),n=a.findNodeByElem(j),o=a.findNodeByElem(k);if(c||(d=b.cloneRange(),d.collapse(!0),d=a.selection.buildUndo(d)),b.setStart(e[0],e[1]),b.setEnd(f[0],f[1]),n==o)return g;var p,q,s=h(a,b,n,g,!0),t=i(a,b,o,g,!0);for(g.undo.push(r.buildReplaceUndo(m)),p=a.tableEdit.getSibling(n,"after");p&&p!=o;)p.set("text",""),q=!0,p=a.tableEdit.getSibling(p,"after");return s||t||q?(a.findElemById(m.id).replaceWith(m.toHTML()),g.redo.push(r.buildReplaceUndo(m))):g.undo.pop(),c||(g.redo.push(d),a.undo.exeCommand(d)),g}function y(){var d=b&&(File.isNodeHtml?b.ctrlKey:b.altKey),e=!1;return"delSelection"==c?a.selection.getRangy():(d||(e=a.selection.extendCharFromCollapse(M,!c)),e||(P=!0,c?(window.getSelection().modify("extend","forward",d?"word":"character"),M=a.selection.getRangy()):(window.getSelection().modify("extend","backward",d?"word":"character"),M=a.selection.getRangy())),!c&&/^\u200b|\007F$/g.exec(M.toString())?(a.selection.extendCharFromCollapse(M,!0),A(M)||M):M)}function A(b){return a.selection.deRange(b),H=a.getMarkElem(b.commonAncestorContainer),I=a.nodeMap.allNodes.get(H.attr("cid")),K=b.getBookmark(H[0]),H.length&&!I.get("children").length&&0==K.start&&!c}function B(b){return a.selection.deRange(b),H=a.getMarkElem(b.commonAncestorContainer),I=a.nodeMap.allNodes.get(H.attr("cid")),K=b.getBookmark(H[0]),"Delete"==c&&t.isType(H.attr("mdtype"),u.line,u.heading)&&!I.get("children").length&&0==K.start&&0==H.text().length}function C(){function b(b,c){var d=r.makeEmptyCommand(a.selection.buildUndo());return a.findElemById(b.cid).remove(),r.addUndoForRemove(d,b),b.remove(),a.selection.jumpIntoElemBegin(a.findElemById(c)),d.redo.push(a.selection.buildUndo()),d}if(a.undo.completeSnap(!0),t.isType(I,u.line)){var c=I.get("parent");if(I.get("after"))return b(I,I.get("after").cid);if(c.get("after"))return I.get("before")?b(I,c.get("after").getVeryFirst().cid):b(c,c.get("after").getVeryFirst().cid)}else if(I.get("after"))return b(I,I.get("after").getVeryFirst().cid);return null}function E(){var c=null;if(t.isType(I.getClosetParagraphLevel().get("before"),t.TYPE.hr,t.TYPE.toc)&&(c=I.get("before")),a.undo.completeSnap(!0),b&&b.preventDefault(),$(".md-tooltip-remove").remove(),H.prev("[cid]").addClass("md-expand"),J=v(a,I),J===D);else if(!d)return c&&(a.selection.selectNode(c),J.redo.push(a.selection.buildUndo())),a.undo.register(J),a.refresh(),c||a.findElemById(I.cid).trigger("refocus"),a.refocus(),J}function F(b){if(a.selection.selectWordTime&&File.isMac)if(c){if("Delete"==c&&b.endContainer.nodeType===document.TEXT_NODE){var d=b.endContainer.textContent,e=d.charAt(b.endOffset);/\s/.exec(e)&&(b.endOffset++,R=b.cloneRange())}}else if(b.startOffset>0&&b.startContainer.nodeType===document.TEXT_NODE){var d=b.startContainer.textContent,e=d.charAt(b.startOffset-1);/\s/.exec(e)&&(b.startOffset--,R=b.cloneRange())}}function G(){return!(M.commonAncestorContainer.nodeType!=document.TEXT_NODE||0==c&&M.startOffset<=1||"Delete"==c&&M.endOffset>=M.commonAncestorContainer.textContent.length-1)}var H,I,J,K,L=a.selection.getRangy(),M=L&&a.selection.deRange(L.cloneRange()),N=M&&!M.collapsed,O=document.activeElement,P=!1,R=L;if(t.isType(O.getAttribute("mdtype"),t.TYPE.hr,t.TYPE.toc)){var S=$(O).closest("[mdtype]");return aa(a,S,b,d)}if(O.getAttribute("mdtype")==u.math_block)return b&&b.preventDefault(),a.mathBlock.remove(O.getAttribute("cid")),J;if(c&&"Backspace"!=c?c===!0&&(c="Delete"):c=!1,M){if(M.collapsed){if(c){if("Delete"==c&&B(M)&&(J=C()))return d||(a.undo.register(J),a.refocus()),J}else if(A(M))return E();if(M=y(),M===!0)return E();!c&&ja(a,M)&&(e=!1)}else F(M);if(e&&G())return null;if(a.selection.selectWordTime=null,a.selection.deRange(M),H=a.getMarkElem(M.commonAncestorContainer),I=a.nodeMap.allNodes.get(H.attr("cid")),P&&(window.getSelection().removeAllRanges(),window.getSelection().addRange(L.nativeRange)),H.length&&!I.get("children").length){if(H.get("type")!==u.fences)return f(a,b,M,H,d);!d&&a.undo.completeSnap(!0),J=aa(a,H,b,d)}else console.debug("handle block change"),!d&&a.undo.completeSnap(!0),b&&b.preventDefault(),$(".md-tooltip-remove").remove(),J=j(a,M,c),d||(a.undo.register(J),a.refocus());return J}},ca={"[mdtype='hr']":ba,"tr[mdtype='table_row']":x.deleteRow,".md-toc":aa},da=function(a){var b,c=a.getMarkElem();if(c&&c.length){for(b in ca)if(c.closest(b).length)return void ca[b](a,c.closest(b));!function(b){var c=b.hasClass("md-expand");b.addClass("md-expand"),window.getSelection().modify("move","backward","sentence"),window.getSelection().modify("extend","forward","sentence"),c&&b.removeClass("md-expand"),ba(a,null,"delSelection")}(c)}},ea=function(a,b){if(!File.isLocked){b=b||File.editor;var c=b.getMarkElem(),d=b.findNodeByElem(c).getClosetBlock(),e=new t({type:u.paragraph}),f=r.makeEmptyCommand(b.selection.buildUndo());d.insert(e,a);var g=e.append(new t({type:u.line,text:""}));r.addUndoForInsert(f,e),a?b.findElemById(d.cid).before(e.toHTML()):b.findElemById(d.cid).after(e.toHTML()),b.selection.jumpIntoElemBegin(b.findElemById(g.cid)),f.redo.push(b.selection.buildUndo()),b.undo.register(f),b.refocus()}},fa={"(":")","[":"]","{":"}",'"':'"',"'":"'","~":"~","^":"^","=":"=","*":"*","`":"`",$:"$",_:"_"},ga=null,ha=null,ia=null,ja=function(a,b){var c=b.toString();if(!File.option.noPairingMatch&&n().exec(c)){var d=$(b.commonAncestorContainer).closest("[cid]"),e=d.text(),f=b.getBookmark(d[0]);if(fa[c]==e.substring(f.end,f.end+1))return f.end++,b.moveToBookmark(f),b}},ka=function(a,b,c){if(!File.option.noPairingMatch){var d,e,f,g,h=$(c.commonAncestorContainer).closest("[cid]"),i=$(c.commonAncestorContainer).closest(".md-def-content:not(.md-def-url)");return(h.length&&!h.find("[cid], .md-def-name").length||i.length)&&m().exec(b)?(e=a.findNodeByElem(h),h=i.length?i:h,d=c.getBookmark(h[0]),g=r.makeEmptyCommand(a.selection.buildUndo()),a.store(e,!0),g.undo.push(r.buildReplaceUndo(e)),f=e.get("text"),e.set("text",f.substring(0,d.start)+b+f.substring(d.start,d.end)+fa[b]+f.substring(d.end)),g.redo.push(r.buildReplaceUndo(e)),c=a.selection.rangy.createRange(),c.moveToBookmark(d),a.selection.deRange(c),c.insertNodeAtEnd(document.createTextNode(fa[b])),c.insertNode(document.createTextNode(b)),d.start++,d.end++,c.moveToBookmark(d),c.select(),g.redo.push(a.selection.buildUndo()),g):void 0}},la=function(a,b,c,d,e,f){function g(){var b=a.selection.rangy.createRange();d.end++,d.start++,b.moveToBookmark(d),b.select(),e&&e.redo.push(a.selection.buildUndo())}function h(a,b){for(var c,d,e=a.length,f=0;e>f;f++){var g=a[f];("'"==g||'"'==g)&&(c?c==g?(c=null,d=null):d=d?null:g:c=g)}return b==c||b==d}function i(a,b){if("`"==b&&/``$/.exec(a))return!0;a.replace(/\\[*`_$]/g,""),"_"==b&&(a=a.replace(/([a-z])_([a-z])/gi,""));for(var c=a.length,d=!1,e=0;c>e;e++){var f=a[e];f==b&&(d=!d)}return d}function j(){console.log("insertTwo");var d=a.selection.getRangy(),f=document.createTextNode(b+fa[b]);return a.undo.completeSnap(!0),a.undo.snap(c.cid,s.ADD),e=e||r.makeEmptyCommand(a.selection.buildUndo()),d.insertNode(f),f.parentElement.normalize(),g(),e}if(!File.option.noPairingMatch){var k,l,m,n;if(/^[\]\)\}'"]$/.exec(b)){if(k=a.findElemById(c.cid).textExcludeSVG(),b===k.substring(d.start,d.start+1))return g(),console.log("move next"),e||!0;if("'"==b||'"'==b){if(""==k)return j();if(n=k.substring(0,d.start),l=n.slice(-1),b!=l&&"\\"!=l&&!/\w/.exec(k.substring(Math.max(0,d.start-1),d.start+1))&&!h(n,b))return j();console.log("insert ending quote")}}else if(/^[\[\(\{]$/.exec(b)){if(k=a.findElemById(c.cid).textExcludeSVG(),m=k.substring(d.start,d.start+1),!/[^\[\]{}()"'\s`“”‘’«»‹›>$]/.exec(m))return j()}else if(File.option.autoPairExtendSymbol&&o().exec(b)){if(f&&f.commonAncestorContainer&&f.commonAncestorContainer.parentElement&&("CODE"==f.commonAncestorContainer.parentElement.tagName&&"`"!=b||"SCRIPT"==f.commonAncestorContainer.parentElement.tagName&&"$"!=b))return;k=a.findElemById(c.cid).textExcludeSVG(),m=k.substring(d.start,d.start+1);var p=k.substring(d.start+1,d.start+2),q=/[*_]/.exec(b);if(m==b){if(!q)return g()||!0;if(q&&p)return g()||!0;if($(a.selection.getRangy().commonAncestorContainer).closest(".md-after").length)return g()||!0;if(n=k.substring(0,d.start),/[*_]$/.exec(n))return j()}if(n=n||k.substring(0,d.start),!i(n,b))return j()}return!1}},ma=function(a,b){if(File.isLocked)return!1;var c,d,e,f=a.getNode(b),g=a.selection.buildUndo();if(!t.isType(f,u.heading,u.def_footnote,u.def_link)||g.startId&&g.startId!=g.endId)return!1;if(c=f.toMark().trim(),c.match(/\n/))return!1;var h=r.makeEmptyCommand(a.lastCursor),i=new t({type:u.line,text:c});if(!h.undo.length||!h.undo[0].id&&h.undo[0].startId!=h.undo[0].endId)return!1;if(h.undo.push(r.buildReplaceUndo(f)),t.isType(f,u.heading)&&(d=f.get("pattern")&&f.get("pattern").replace("{0}","").length||f.get("depth")+1),t.isType(f,u.def_link,u.def_footnote)){var j,k=a.selection.getRangy(),l=a.getJQueryElem(k.startContainer);j=l.closest(".md-def-content"),d=t.isType(f,u.def_link)?1:2,j.length&&(d+=3),j=l.closest(".md-def-title"),j.length&&l.text().length&&(d+=5)}return f.unset("text"),f.set("type",u.paragraph),f.append(i),h.redo.push(r.buildReplaceUndo(f)),g=a.selection.buildUndo(),g.start+=d,g.end+=d,g.id=i.cid,g.startId=g.endId=void 0,h.redo.push(g),e=f.toHTML(w.renderHtmlWithBlockMeta(i,a.brush)),a.findElemById(f.cid).replaceWith(e),a.undo.exeCommand(g,[]),a.undo.stashUndo(h),i.cid},na=function(a){var b=a.clone();return b.find(".md-meta, .md-content").remove(),b.text().replace(/\u00A0/g," ")};b.getDisplayText=na,b.getMarkdownSourceFrom=g,b.copyAsMarkdown=I,b.copyAsHTMLSource=J,b.copyHandler=L,b.insertInlineText=F,b.pasteHandler=N,b.backspaceHandler=ba,b.deleteSelectable=aa,b.deleteLineProcessor=ca,b.deleteLine=da,b.decorateOneSide=R,b.setClipboard=G,b.moreIndent=U,b.lessIndent=W,b.insertParagraph=ea,b.backToParagraph=_,b.processClipboardHTML=K,b.hanldePair=la,b.surroundPair=ka,b.simpleExpand=ma,b.insertURLs=O}),define("app/editor/ConvertUtils",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/TableEdit","app/editor/UndoManager","app/editor/polyfill","app/editor/KeyMaster","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/Emoji"],function(a,b,c){"use strict";var d=(a("exoskeleton-master/exoskeleton"),a("app/document/StringUtils")),e=a("app/document/Node"),f=e.Node,g=e.TYPE,d=(e.NodeCollectionUtils,a("app/document/StringUtils")),h=a("app/editor/TableEdit"),i=a("app/document/MarkParser"),j=a("jquery/jquery"),k=["CONTENT","HEADER","FOOTER","ARTICLE","SECTION","DIV","P","BLOCKQUOTE","PRE","UL","OL","TABLE","HR","H1","H2","H3","H4","H5","H6","DL","DT","DD","TBODY","THEAD","TFOOT","ASID","LI","HTML","BODY","IFRAME","STYLE","SCRIPT"],l=["INPUT","BUTTON","SELECT","SCRIPT","CANVAS","META","PROGRESS","VIDEO","HEAD","EMBED","STYLE","TEMPLATE"],m=function(a,b,c,e){function m(a){try{var b=/(\S.*\|.*)\n *([-:]+ *\|[-| :]*)\n((?:.*\|.*(?:\n|$))*)/,c=/\|(.+)\n *\|( *[-:]+[-| :]*)\n((?: *\|.*(?:\n|$))*)/;return(a.match(/\n\s*(\!?\[|#{1,5}|>|```)/g)||"").length>3||a.match(c)||a.match(b)?a:null}catch(d){}return null}function n(a,b){var c,f,g;return a.find("img").each(function(){c=j(this),c.text("!["+(c.attr("alt")||c.attr("title")||"img").replace(/\r|\n/gi,"")+"]("+d.getAbsoluteURL(e,c.attr("src"))+")")}),a.find("strong, b").each(function(){c=j(this),c.text("**"+c.text().replace(/([^\\])\*/,"$1\\*")+"**")}),a.find("em, i").each(function(){c=j(this),c.text("*"+c.text().replace(/([^\\])\*/,"$1\\*")+"*")}),a.find("code, pre, tt").each(function(){c=j(this),c.text("`"+c.text()+"`")}),a.find("del, strike").each(function(){c=j(this),c.text("~~"+c.text()+"~~")}),a.find("br").each(function(){c=j(this),c.replaceWith("\n")}),a.find("a:not(:empty)").each(function(){c=j(this),f=d.getAbsoluteURL(e,c.attr("href")),g=c.text(),0==g.length?c.replaceWith(""):c.replaceWith("["+g.replace(/([^\\])]([^(]|$)/,"$1\\]$2").replace(/\r|\n/gi,"")+"]("+f+")")}),File.option.highlight&&a.find("mark").each(function(){c=j(this),c.text("=="+c.text().replace(/([^\\])\=/,"\\=")+"==")}),b?a[0].innerText.split(/(\r|\n)+/):a.text().replace(/\r|\n/gi,"")}function o(a,b,c,d){var e,h=b,i=[];if(b&&b!==c){for(;h&&h!==c;)f.isType(h,g.paragraph)&&f.isEmptyBlock(h)?(e=h,h=h.get("after"),e.remove(),d&&d.splice(d.indexOf(e),1)):h=h.get("after");for(b=h.get("before")||h,h=c;h&&h!==b;)f.isType(h,g.paragraph)&&f.isEmptyBlock(h)?(e=h,h=h.get("before"),e.remove(),d&&d.splice(d.indexOf(e),1)):h=h.get("before")}for(h=b;h;){var j=null;if(f.isType(h,g.blockquote,g.list_item))o(h,h.getFirstChild(),h.getLastChild());else if(f.isType(h,g.fences)&&f.isType(h.get("before"),g.fences))i.push(h),h.head=h.get("before").head||h.get("before"),h.head.set("text",h.head.get("text")+"\n"+h.get("text"));else if(f.isType(h,g.list)&&0===h.get("children").length)h.set("type",g.paragraph);else if(f.isType(h,g.paragraph)&&(j=/^(`+)([\s\S]*?[^`])\1(?!`)\s*$/g.exec(h.get("text")))){h.set("type",g.fences),h.set("text",j[2]);continue}h=h.get("after")}i.map(function(a){d&&d.splice(d.indexOf(a),1),a.remove()})}function p(a,c,d){a["in"]=b,a.parent=c,a.before=d.last(),a&&a.text&&(a.text=a.text.replace(/\u200b/g,"").replace(/\u00a0/g," "));var e=new f(a);return d.push(e),e}function q(a,b,c){var d=[];if(b)for(var e=0;e<a[0].childNodes.length;e++)v(j(a[0].childNodes[e]),c,d);else f.isType(c,g.blockquote,g.list_item)?s(a,c,d):c.set("text",n(a))}function r(a,b,c){for(var e,f,h=[],j=null,k=0;k<a.length;k++)e=a[k],(h=i.reDefLink.exec(e))?(j=null,p({type:g.def_link,ref:h[1],href:h[3],title:h[7]},b,c)):(h=i.reDefFootnote.exec(e))?(j=null,p({type:g.def_footnote,ref:h[1],text:(h[2]||"").trim()},b,c)):(null==j&&(j=p({type:g.paragraph},b,c),f=[]),p({type:g.line,text:d.escapeHead(e)},j,f))}function s(a,b,c){if(a.find("br").length){for(var d=n(a,!0),e=[],f=0;f<d.length;f++)d[f].trim().length&&e.push(d[f]);r(e,b,c)}else{if(3==a[0].nodeType&&!a.text().trim().length)return;r([n(a)],b,c)}}function t(a,b){for(var c,d=[],e=0;e<a.length;e++)"DT"==a[e].tagName&&(c=p({type:g.list_item},b,d),c.itemList=[],p({type:g.paragraph,text:n(j(a[e]))},c,c.itemList)),"DD"==a[e].tagName&&c&&p({type:g.paragraph,text:n(j(a[e]))},c,c.itemList)}function u(a){if(-1==k.indexOf(a[0].tagName))return!1;var b=!1;return a.children().each(function(){b=b||this.tagName&&(k.indexOf(this.tagName)>-1||"BLOCK"==this.style.display)}),b}function v(a,b,c){var d,e,i=u(a),k=a[0].tagName;if(!(a.data("skip")||l.indexOf(k)>-1||a[0].nodeType===document.COMMENT_NODE)){if("BLOCKQUOTE"===k)d=p({type:g.blockquote},b,c),q(a,i,d);else if("LI"===k&&f.isType(b,g.list))d=p({type:g.list_item},b,c),q(a,i,d);else if("UL"===k||"OL"===k)d=p({type:g.list,style:k.toLowerCase()},b,c),q(a,i,d);else if("DL"===k)d=p({type:g.list,style:"ul"},b,c),t(a.children(),d);else if("TABLE"===k)e=a.children().children("tr").add(a.children("tr")),e.length&&(d=p({type:g.table},b,c),c=[],d.cols=1,e.toArray().map(function(a){v(j(a),d,c)}),d.set("align",new Array(d.cols-0)),h.valify(d,d.cols,2,function(a,d){var e=d.split(/(\r|\n)+/);a.set("type",g.paragraph),a.set("text",e[0]);for(var f=1;f<e.length;f++)e[f].trim().length&&p({type:g.paragraph,text:e[f]},b,c)}));else if("THEAD"===k||"TBODY"===k||"TFOOTER"===k){for(var o=[a],r=$elem.next();r.length&&f.isType(r[0].tagName,"THEAD","TBODY","TFOOTER");)o.push(r),r.data("skip",!0);a.wrap("<table></table>"),v(a.parent(),b,c)}else if("TR"===k&&f.isType(b,g.table)){var w;e=a.children("th"),w=e.length,e=e.add(a.children("td")),b.cols=e.length>b.cols?e.length:b.cols,d=p({type:g.table_row,isHeader:w},b,c),c=[],e.toArray().map(function(a){v(j(a),d,c)})}else if("TD"!==k&&"TH"!==k||!f.isType(b,g.table_row))if("HR"===k)p({type:g.hr},b,c);else if(/H[1-6]/g.exec(k))p({type:g.heading,text:n(a),depth:a[0].tagName[1]},b,c);else if("CODE"===k||"PRE"===k&&0==a.find("pre").length||"FIGURE"==k&&a.hasClass("highlight"))a.find("div").each(function(){j(this).before("<br/>")}),p({type:g.fences,text:a[0].innerText.replace(/^\s*\n+/,"")},b,c);else if(i)a.children().each(function(){v(j(this),b,c)});else{var x=m(a[0].innerText||"");if(x)return x;s(a,b,c)}else d=p({type:g.table_cell,text:n(a)},b,c);return null}}var w=j(j.parseHTML("<div>"+a+"</div>")[0]),x=[];w.find("head, meta, script, css, .gutter, style, title").remove();var y=v(w,null,x);if(y)return y;if(x.length&&(o(null,x[0],x.last(),x),1===x.length&&f.isType(x[0],g.paragraph))){var z=w.text().replace(/(^\n+)|(\n+$)|\u200b/g,"").replace(/\u00a0/g," ");return x[0]["delete"](),f.parseFrom(z,b,{noTop:!0,skips:{old_code:!0}},!0)[1]}return x},n=function(a){function b(a,b){for(var d=(a instanceof Array?a[0]:a.first()).getLastBrother(!0),e=[],f=0;f<a.length;f++)e=e.concat(c(d,b)),
d=d.get("after");return e}function c(a,d){function e(a){return d?[a]:[a,""]}var h,i=[],j=a.get("type");switch(j){case g.fences:i=a.get("text").replace(/\u200B/g,"").split("\n");for(var k=0;k<i.length;k++)i[k]="    "+i[k];return d||i.push(""),i;case g.list:var l=a.get("style"),m=a.get("children").length;if(m)for(var n=a.getFirstChild(),o=n,k=0;o;){var p=c(o,!0),q=f.getIndentPrefix(l,k,o,void 0,(m+"").length);p.map(function(a,b){p[b]=(b?" ".repeat(q.length):q)+p[b],i.push(p[b])}),k++,o=o.get("after")}return d||i.push(""),i;case g.table:for(var r,s,t,u,v,w,x=[],y=[],z=0,A=a.getFirstChild();A;){for(r=A.getFirstChild(),y[z]=[],s=0;r;)y[z][s]=r.toMark().trim(),r=r.get("after"),0===z&&(x[s]=4),x[s]=Math.max(y[z][s].length,x[s]),x[s]=Math.min(x[s],40),s++;A=A.get("after"),z++}for(z=0;z<y.length;z++){for(t="  ",s=0;s<x.length;s++)u=Math.max(x[s]-y[z][s].length,0),v=a.get("align")[s],"right"==v?t+=" ".repeat(u)+y[z][s]:"center"==v?(w=~~(u/2),t+=" ".repeat(w)+y[z][s]+" ".repeat(u-w)):t+=y[z][s]+" ".repeat(u),t+="	";i.push(t.replace(/\s$/,""))}return d||i.push(""),i;case g.hr:return e("---");case g.def_link:return h="["+a.get("ref")+"]: "+a.safeGetStrAttr("href")+(a.safeGetStrAttr("title").length?'	"'+a.get("title")+'"':""),f.isType(a.get("after"),g.def_link)?[h]:e(h);case g.def_footnote:return h="["+a.get("ref")+"]: "+a.get("text"),f.isType(a.get("after"),g.def_footnote)?[h]:e(h);default:return a.get("children")&&a.get("children").length>0?b(a.get("children"),d):e(a.get("text"))}}return b(a).join("\n")};b.convertToPlain=n,b.parseHTML=m}),define("app/editor/DocMenu",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/UndoManager","app/editor/Emoji","app/editor/Selection","rangy/rangy-core","codemirror/lib/codemirror","app/editor/KeyMaster","app/window/FileHelper","app/editor/UndoManager"],function(a,b,c){"use strict";function d(a,b){for(var c=a.querySelectorAll(".outline-item-wrapper"),d=0;d<c.length;d++)c[d].querySelector(".outline-item-wrapper")?b&&c[d].classList.contains("outline-h1")&&c[d].classList.add("outline-item-open"):c[d].classList.add("outline-item-signle")}function e(){return g||(g=new n.InlineLexer(null,u)),g}function f(a,b){var c=new RegExp("^s*"+a+"s*:s*(.*)$","mig"),d=c.exec(b);return d}var g,h=a("app/document/StringUtils"),i=a("exoskeleton-master/exoskeleton"),j=a("app/document/Node"),k=j.Node,l=j.TYPE,m=a("jquery/jquery"),n=a("app/document/MarkParser"),o=a("app/editor/Selection"),p=(o.rangy,a("app/window/FileHelper")),q=a("app/editor/UndoManager"),r=window.reqnode?reqnode("electron").remote:null,s=r?r.app:window.app,t=i.Collection.extend({model:k,getNodeByRef:function(a){for(var b in this.models)if(this.models.hasOwnProperty(b)){var c=this.models[b];if(h.escape(c.get("ref")).toLowerCase()==h.escape(a).toLowerCase())return c}},getFootHTMLByRef:function(a,b){var c=this.getNodeByRef(a);return c?(b&&File.editor.store(c.cid,!0),"<div class='code-tooltip md-tooltip-remove md-hover-tip md-f-tooltip' contenteditable='false'><div class='md-arrow' /><div class='code-tooltip-content'>"+editor.brush.inline.output(c.get("text"))+"</div></div>"):null},getHrefByRef:function(a,b){var c=this.getNodeByRef(a);return c&&b&&File.editor.store(c.cid,!0),c?h.escape(c.get("href")):void 0}}),u=function(a){switch(a.type){case l.strong:return"<strong>"+a.inner+"</strong>";case l.em:return"<em>"+a.inner+"</em>";case l.code:return"<code>"+h.escape(a.text)+"</code>";case l.plain:return a.text;case l.tag:case l.imgtag:return h.escape(a.text);case l.del:return"<del>"+a.inner+"</del>";case l.footnote:return"";case l.escape:return a.text;default:return a.inner||a.text||""}},v=i.Model.extend({initialize:function(a){this.nodeMap=a,this.refresh(),this.delay=200,this.refreshTimeout=null},remove:function(a){var b=this.headers.indexOf(a);b>-1&&this.headers.splice(b,1)},refresh:function(a){function b(){var a=this.nodeMap.getFirst();for(this.headers=[];a;)k.isType(a,k.TYPE.heading)&&this.headers.push(a),a=a.get("after");this.updateHTML(),this.refreshTimeout=null}this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout(b.bind(this),a?0:this.delay)},updateHTML:function(){var a=function(a){return"<span class='md-toc-item md-toc-h"+a.get("depth")+"' data-ref='"+a.cid+"'><a class='md-toc-inner'>"+g.output(a.get("text"))+"</a></span>"},b="",c=0,d=document.querySelectorAll(".md-toc-content");if(d.length>0)for(this.headers.map(function(c){b+=a(c)}),c=0;c<d.length;c++)d[c].innerHTML!=b&&(d[c].innerHTML=b);this.updateOutlineHtml()},updateOutlineHtml:function(){function a(a,b){var c=m(m.parseHTML("<div>"+a+"<div>")[0]),d=m(m.parseHTML("<div>"+b+"<div>")[0]);return c.find(".outline-item-open, .outline-active").removeClass("outline-item-open").removeClass("outline-active"),d.find(".outline-item-open, .outline-active").removeClass("outline-item-open").removeClass("outline-active"),c.html()==d.html()}if(document.body.classList.contains("pin-outline")){var b=document.querySelector("#outline-content"),c=b.scrollTop,e=x(this),f=!document.body.classList.contains(".no-collapse-outline"),g=[];if(a(b.innerHTML,e))return;f&&m(b).find(".outline-item-open>.outline-item>.outline-label").map(function(){g.push(this.getAttribute("data-ref"))}),b.innerHTML=x(this),b.scrollTop=c,f&&(d(b),m(b.querySelector(".outline-active")).parents(".outline-item-wrapper:not(.outline-item-signle)").addClass("outline-item-open"),g.forEach(function(a){var c=b.querySelector("[data-ref='"+a+"']");c&&(c=c.parentElement.parentElement,c.classList.contains("outline-item-signle")||c.classList.add("outline-item-open"))})),File.editor.docMenu.highlightVisibleHeader()}}}),w=null,x=function(a){function b(a){f+="<li class='outline-item-wrapper outline-h"+a.get("depth")+"'><div class='outline-item'><span class='outline-expander'></span><span class='outline-label' data-ref='"+a.cid+"'>"+h.output(a.get("text"))+"</span></div><ul class='outline-children'>",g.push(a.get("depth"))}function c(){f+="</ul></li>",g.pop()}function d(a){for(var d=0;d<a.length;d++){b(a[d]);var e=a[d+1]?a[d+1].get("depth"):1;if(e<=a[d].get("depth"))for(;g.last()&&g.last()>=e;)c()}}var f="",g=[],h=e();try{d(a.headers)}catch(i){window.debugMode&&console.warn(i.stack),f=""}return f},y=i.Model.extend({initialize:function(a){function b(){m(document).on("mousedown",".md-toc-inner",function(b){if(1===b.which){var c=this.parentElement.getAttribute("data-ref"),d=a.findElemById(c);return a.store(),a.undo.completeSnap(!0),a.selection.jumpIntoElemEnd(d),a.selection.scrollAdjust(d,10),!1}}).on("mousedown",".md-delete-toc",function(b){1===b.which&&a.UserOp.deleteSelectable(a,m(this).closest(".md-toc"))}).on("click","#md-notification .close-btn",function(a){m("#md-notification").hide()})}function c(){function a(){b=!1,setTimeout(function(){b||m(".md-f-tooltip").remove()},500)}var b,c,d=f.editor;setTimeout(function(){f.need_def_foot_msg=m("#need_def_foot").html(),m(document).on("mouseenter mousemove",".md-footnote",function(){if(!b||c!==d.focusCid){if(window.getSelection().anchorNode&&this.contains(window.getSelection().anchorNode.parentElement))return;b=!0,c=d.focusCid,f.showTooltipForSup(m(this))}}).on("mouseleave",".md-footnote",a).on("mouseenter",".md-f-tooltip",function(){b=!0}).on("mouseleave",".md-f-tooltip",a)},300)}function d(){m(document).on("click",".outline-expander",function(a){this.parentElement.parentElement.classList.toggle("outline-item-open")}).on("click",".outline-label",function(b){var c=this.getAttribute("data-ref"),d=a.findElemById(c);a.undo.completeSnap(!0),a.selection.scrollAdjust(d,10),File.isFocusMode&&a.updateFocusMode(!1),f.autoHideOutline()}).on("mousewheel","#sidebar-content",function(a){w&&clearTimeout(w)}).on("mousewheel","content",function(a){if(document.querySelector(".dropdown-menu.open")&&!File.editor.sourceView.inSourceMode){var b=document.querySelectorAll(f.headerStr);b.length>100?(w&&clearTimeout(w),w=setTimeout(f.highlightVisibleHeader.bind(f),30)):(f.highlightVisibleHeader(b),w&&clearTimeout(w),w=setTimeout(f.highlightVisibleHeader.bind(f),100))}}).on("click","#close-outline-btn, #close-sidebar-btn",function(){f.hideOutline()}).on("click","#pin-outline-btn",function(){document.body.classList.add("pin-outline"),f.pinOutline=!0}).on("click","#unpin-outline-btn",function(){document.body.classList.remove("pin-outline"),s&&s.setting.put("show_outline","false"),m(".sidebar-mac-tab").removeClass("show-mac-tab"),f.pinOutline=!1})}var f=this;this.pinOutline=document.body.classList.contains("pin-outline"),e(),this.headerStr=a.sessionStr+">h1, "+a.sessionStr+">h2, "+a.sessionStr+">h3, "+a.sessionStr+">h4, "+a.sessionStr+">h5, "+a.sessionStr+">h6",this.expandedOutlineItem=[],a.nodeMap.foot_list=new t,a.nodeMap.link_list=new t,a.nodeMap.toc=new v(a.nodeMap),this.editor=a,c(),b(),d()},highlightVisibleHeader:function(a,b){function c(a){var b=m("content").scrollTop(),c=a.offsetTop;return b>c?-1:c>b+window.innerHeight?1:0}function d(a){for(a--;h[a]&&0==c(h[a]);)a--;return a+1}function e(a){if(g.pinOutline&&a.length){var b,c,d=m("#outline-content:visible")[0];d&&(File.isNodeHtml||(d=d.parentElement),b=a.offset().top-m(d).offset().top,0>b?c=b-200+d.scrollTop:b>d.offsetHeight-20&&(c=b+200-d.offsetHeight+d.scrollTop),void 0!==c&&(d.scrollTop=c))}}if(document.querySelector("#outline-dropmenu").classList.contains("open")){var f,g=this,h=(this.editor,a||document.querySelectorAll(this.headerStr)),i=0,j=h.length-1,k=void 0===b?null:b;if(h.length){for(i=1===c(h[h.length-1])?0:h.length-1;j-i>1&&null==k;){var l=Math.floor((i+j)/2),n=c(h[l]);1==n?j=l:-1==n?i=l:k=d(l)}null==k&&(k=i),k<h.length&&(f=m("#outline-content .outline-label").removeClass("outline-active").filter("[data-ref='"+h[k].getAttribute("cid")+"']").addClass("outline-active"),e(f))}w=null}},getAttrByElem:function(a){return a.hasClass("md-def-name")?"ref":a.hasClass("md-def-content")?a.hasClass("md-def-url")?"href":"text":a.hasClass("md-def-title")?"title":void 0},addEmptyDef:function(a,b){function c(c){var e=d.findNodeByElem(c),f=d.undo.UndoManager.makeEmptyCommand();e.insert(new k({type:b,ref:a,url:"",text:""})),d.undo.UndoManager.addUndoForInsert(f,e.get("after")),c.after(e.get("after").toHTML()),d.selection.jumpIntoElemBegin(c.next().find(".md-def-content")),f.redo.push(d.selection.buildUndo()),d.undo.register(f),d.refocus()}var d=this.editor,e=m(d.sessionStr).find(b==k.TYPE.def_link?".md-def-link":".md-def-footnote").last();c(!e.length||e.nextAll(":not(.footnotes)").length?m(d.sessionStr).children().last():e)},showTooltipForSup:function(a){var b,c,d=this.editor;if(a.length){var e=a.find(".md-text").text();b=d.nodeMap.foot_list.getFootHTMLByRef(e,!0),m(".md-tooltip-remove").remove(),b?(c=m(m.parseHTML(b)[0]),m("body").append(c)):File.isLocked||(b="<div class='code-tooltip md-tooltip-remove md-hover-tip md-f-tooltip' contenteditable='false'><div class='md-arrow' /><div class='code-tooltip-content'><span class='fa text-warning fa-exclamation-triangle' title='warning' aria-hidden='true' /> "+this.need_def_foot_msg.format(e,e).trim()+" </div></div>",c=m(m.parseHTML(b)[0]),m("body").append(c),c.find(".code-tooltip-content a").unbind("click").click(function(){d.docMenu.addEmptyDef(e,j.TYPE.def_footnote)})),this.editor.EditHelper.fixPopoverPosition(a,c)}},getLocalRootUrl:function(a){var b=this.getMetaNode();if(a=a||"img",b){var c=/^\s*typora-root-url\s*:\s*(.*)$/im,d=(c.exec(b.get("text"))||[])[1];if(d){var e=p.getCurrentFileFolderPath();return e?File.isMac?s.path.resolvePathRelateTo(d,e):reqnode("path").resolve(e,d):d}}return null},buildMetaMap:function(){function a(a){return a.replace(/(^\s*['"]*)(['"]*\s*$)/,"")}var b,c,d,e=this.getMetaNode(),f=/^\s*([^:]+)\s*:\s*(.*)$/,g=/^\s#/,h={};return e&&(b=(e.get("text")||"").split(/\r|\n|\r\n/g),b.forEach(function(a){a.match(g)||((d=f.exec(a))?(c=d[1],h[c]=d[2].replace(/^\s*[|>]\s*/,"")):c&&(h[c]+="\n"+a.trim()))}),Object.keys(h).forEach(function(b){h[b].match(/^\s*-/)?h[b]=h[b].split(/(^|\n+)\s*-/g).filter(function(a){return a.match(/\S/)}).map(function(b){return a(b)}):(d=h[b].match(/^\s*\[(.*)\]\s*$/))?h[b]=d[1].split(/\s*,\s*/).map(a):h[b]=a(h[b])})),h},getMetaNode:function(){this.editor.undo&&this.editor.undo.completeSnap(!0);var a=this.editor.nodeMap.getFirst();return k.isType(a,l.meta_block)?a:null},getValueInMeta:function(a,b){if(b=b||this.getMetaNode()){var c=new RegExp("^s*"+a+"s*:s*(.*)$","mi"),d=(c.exec(b.get("text"))||[])[1];return d?d.trim():d}return null},showOutline:function(a){var b=x(this.editor.nodeMap.toc),c=document.querySelector("#outline-content");c.innerHTML=b,a?this.pinOutline=a:m(".dropdown-menu.open, .dropdown-menu.show").removeClass("open").removeClass("show"),document.querySelector("#outline-dropmenu").classList.add("open"),d(c,!0),this.expandedOutlineItem&&this.expandedOutlineItem.forEach(function(a){try{c.querySelector("[data-ref='"+a+"']").parentElement.parentElement.classList.add("outline-item-open")}catch(b){}}),this.pinOutline&&(s&&s.setting.put("show_outline","true"),document.body.classList.add("pin-outline")),this.editor.library["switch"]("outline")},hideOutline:function(a){this.expandedOutlineItem=[],document.querySelector("#outline-dropmenu").classList.remove("open");for(var b=document.querySelectorAll(".outline-item-open:not(.outline-h1)>.outline-item>.outline-label"),c=0;c<b.length;c++)this.expandedOutlineItem.push(b[c].getAttribute("data-ref"));a?File.outlineStatus_=document.body.classList.contains("pin-outline"):s&&s.setting.put("show_outline","false"),this.pinOutline=!1,document.body.classList.remove("pin-outline"),m(".sidebar-mac-tab").removeClass("show-mac-tab")},autoHideOutline:function(){!this.pinOutline&&document.querySelector("#outline-dropmenu").classList.contains("open")&&this.hideOutline()},restoreOutlineState:function(){void 0!==File.outlineStatus_?(File.outlineStatus_&&this.showOutline(!0),File.outlineStatus_=void 0):s&&"true"===s.setting.get("show_outline")&&m(window).width()>550&&this.showOutline(!0)},toggleOutline:function(a){document.querySelector("#outline-dropmenu").classList.contains("open")?"files"==m("[name='sidepanel-segmented-input']:checked").val()?this.editor.library["switch"]("outline",!0):this.hideOutline():this.showOutline(a)},getHeaderMatrix:function(a){var b=[];return this.editor.nodeMap.toc.headers.map(function(c){var d=g.output(c.get("text"));a&&(d=m.parseHTML("<div>"+d+"<div>")[0].textContent),b.push([c.get("depth")-0,d,c.cid])}),b},writeProperty:function(a,b){this.editor.undo.completeSnap(!0);var c=this.editor.docMenu.getMetaNode(),d=this.editor.selection.buildUndo()||{},e=q.makeEmptyCommand(d),g=a+": "+b,h=c&&d&&(d.id||d.startId)==c.id,i=m.extend({},d),j=0;if(c){e.undo.push(q.buildReplaceUndo(c));var k=c.get("text"),l=f(a,k);if(l){i.start>l.index+l[0].length?j=g.length-l[0].length:i.start>l.index&&(j=i.start-l.index+g.length),i.end=i.start=i.start-j;var n=new RegExp("^s*"+a+"s*:s*(.*)$","mi");c.set("text",k.replace(n,g))}else c.set("text",k?k.replace(/\n?$/,"\n"+g):g);e.redo.push(q.buildReplaceUndo(c)),this.editor.findElemById(c.cid).replaceWith(c.toHTML()),h&&this.editor.undo.exeCommand(i)}else{var o=this.editor.stylize.insertMetaBlock(!0,g);c=o.node,q.append(e,o.command),this.editor.findElemById(c.get("after").cid).before(c.toHTML())}e.redo.push(i),this.editor.undo.register(e)},removeProperty:function(a,b){this.editor.undo.completeSnap(!0);var c=this.editor.docMenu.getMetaNode(),d=this.editor.selection.buildUndo(),e=q.makeEmptyCommand(d),g=(d.id||d.startId)==c.id,h=new RegExp("^s*"+a+"s*:s*(.*)$","mi"),i=m.extend({},d),j=0;if(c){if(e.undo.push(q.buildReplaceUndo(c)),g){var k=f(a,c.get("text"));k&&(i.start>k.index+k[0].length?j=k[0].length:i.start>k.index&&(j=i.start-k.index),i.end=i.start=i.start-j)}c.set("text",c.get("text").replace(h,"")),e.redo.push(q.buildReplaceUndo(c)),this.editor.findElemById(c.cid).replaceWith(c.toHTML()),e.redo.push(i),g&&this.editor.undo.exeCommand(i),!b&&this.editor.undo.register(e)}return e}});c.exports=y}),define("app/editor/SearchPanel",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","rangy/rangy-core","app/editor/KeyMaster","codemirror/lib/codemirror","app/document/Node","rangy/rangy-classapplier"],function(a,b,c){"use strict";function d(a){return!a.match(/^([a-z]|\s)?$/gi)}function e(a,b){return new RegExp(i.escapeRegExp(a)+(b.wholeWord?"(?![A-Za-z_\\u00C0-\\u024f])":""),b.caseSensitive?"g":"gi")}function f(a){q&&clearTimeout(q),$("#md-searchpanel.searchpanel-replace-mode").addClass("searchpanel-msg-mode").find("#searchpanel-msg-content").text(a),q=setTimeout(function(){$("#md-searchpanel").removeClass("searchpanel-msg-mode")},5e3)}function g(a,b){return"Replaced "+a+" occurrence(s)"}var h=a("exoskeleton-master/exoskeleton"),i=a("app/document/StringUtils"),j=a("rangy/rangy-core.js"),k=a("app/editor/KeyMaster"),l=(a("codemirror/lib/codemirror"),a("app/document/Node")),m=window.Node,n=l.Node,o=l.TYPE,p=(a("rangy/rangy-classapplier"),/[A-Za-z_\\u00C0-\\u024f]/i),q=null,r=h.Model.extend({initialize:function(a){this.editor=a,this.bindEvents(),this.curSel=null,this.searchTimer,this.applier=j.createClassApplier("md-search-hit"),this.selectApplier=j.createClassApplier("md-search-select")},bindEvents:function(){var a,b=this,c=!1,d=k.map;!File.isMac&&!File.isNode&&k("command+f, ctrl+f",function(a){b.showPanel(),a.preventDefault()}),!File.isMac&&!File.isNode&&k("command+h, ctrl+h",function(a){b.showPanel(!0),a.preventDefault()}),$("#md-searchpanel").on("blur",function(){b.closePanel()}).on("click",".close-btn .glyphicon-remove",function(){b.closePanel()}).on("keydown","#search-panel-input, #search-panel-replace-input",function(){var a=event.keyCode||event.which;return(c=229==a)?void 0:"Esc"==d[a]?(b.closePanel(),!1):"E"==d[a]&&(event.metaKey||event.ctrlKey)?(b.replaceSelection(),!1):void 0}).on("keydown","#search-panel-input",function(){var a=event.keyCode||event.which;return"Enter"==d[a]?(b.highlightNext(),!1):"Tab"==d[a]?$("#md-searchpanel.searchpanel-replace-mode").length?($("#search-panel-replace-input").focus(),!1):(this.value+="	",!1):void 0}).on("keyup","#search-panel-input",function(){var e=event.keyCode||event.which;c=c&&!(String.fromCharCode(e).match(/\s|[0-9]/g)||"Enter"==d[e]),c||a==$(this).val()||(a=$(this).val(),b.doSearch(a))}).on("keydown","#search-panel-replace-input",function(){var a=event.keyCode||event.which;if(c=229==a,c||"Enter"!=d[a]){if("Tab"==d[a]&&!event.shiftKey)return!1}else b.replaceSelection()}).on("mousedown","#search-panel-prev",function(){b.highlightNext(!0)}).on("mousedown","#search-panel-next",function(){b.highlightNext()}).on("click","#md-search-type-label",function(){$("#md-searchpanel").addClass("searchpanel-replace-mode"),$("#search-panel-replace-input").focus(),document.body.classList.add("on-replace-panel-open")}).on("click","#md-replace-type-label",function(){$("#md-searchpanel").removeClass("searchpanel-replace-mode").removeClass("searchpanel-msg-mode"),$("#search-panel-input").focus(),document.body.classList.remove("on-replace-panel-open"),$("content").removeClass("on-replace-panel-open")}).on("click","#search-panel-replace-btn",function(){b.replaceSelection(),$("#md-searchpanel").removeClass("searchpanel-msg-mode")}).on("click","#search-panel-replaceall-btn",function(){$("#md-searchpanel").removeClass("searchpanel-msg-mode"),b.replaceAll()}).on("click","#searchpanel-msg-close-btn",function(){$("#md-searchpanel").removeClass("searchpanel-msg-mode")}).on("click","#searchpanel-msg-undo-btn",function(){b.editor.undo.undo(),$("#md-searchpanel").removeClass("searchpanel-msg-mode"),!b.editor.sourceView.inSourceMode&&b.doSearch($("#search-panel-input").val())}).on("mousedown","#searchpanel-case-option-btn",function(a){return this.classList.toggle("active"),File.isMac&&app.touchBar&&app.touchBar.updateFindReplaceMode(),b.doSearch(),!1}).on("mousedown","#searchpanel-word-option-btn",function(){return this.classList.toggle("active"),File.isMac&&app.touchBar&&app.touchBar.updateFindReplaceMode(),b.doSearch(),!1})},replaceAll:function(){function a(a,b){var c=a.get(b);c&&a.set(b,c.replace(e(d,q),function(a,b,c){return q.wholeWord&&b>0&&p.exec(c.substr(b-1,1))?a:i}))}function b(b){var c=this.editor.getNode(b.cid);o.undo.push(n.buildReplaceUndo(c)),a(c,"text"),a(c,"title"),a(c,"ref"),o.redo.push(n.buildReplaceUndo(c)),this.editor.findElemById(c.cid).replaceWith(c.toHTML())}if(this.searchStatus&&this.searchStatus.hits.length){var c,d=this.searchStatus.searchText,i=$("#search-panel-replace-input").val(),j=this.searchStatus.hits;if(f.call(this,g(this.searchStatus.hits.length,this.searchStatus.searchText)),this.editor.sourceView.inSourceMode){var k="",l=0,m=j.length;for(c=0,d=this.editor.sourceView.cm.getValue();m>l;l++)k=k+d.substring(c,j[l].start-0)+i,c=j[l].end-0;return k+=d.substring(c),this.editor.sourceView.cm.setValue(k),void this.clearSearch()}var n=this.editor.undo.UndoManager,o=n.makeEmptyCommand(h.utils.extend(this.searchStatus.curSelection,{type:"cursor"})),q=this.searchStatus,r=null;this.clearSearch();for(var l=0;l<j.length;l++)c=j[l],r!=c.cid&&(r=c.cid,b.call(this,c));this.editor.undo.register(o)}},replaceSelection:function(){function a(a){for(var b=a.curPos+1;b<a.hits.length;b++){var c=a.hits[b];c.cid==a.curSelection.cid&&(c.start+=d,c.end+=d)}}if(this.editor.sourceView.inSourceMode&&!this.searchStatus.curSelection&&this.highlightNext(),this.searchStatus.curSelection&&this.searchStatus.hits.length&&$("#md-searchpanel.searchpanel-replace-mode").length){var b,c,d,e=$("#search-panel-replace-input").val(),f=e.length-this.searchStatus.searchText.length,g=this.searchStatus.curPos,h=this.editor.undo.UndoManager,i=h.makeEmptyCommand(),j=this.searchStatus.curSelection,k=j.isCm;d=f,this.searchStatus.lastRange?(b=this.editor.nodeMap.allNodes.get(j.cid),i.undo.push({type:"cursor",id:b.cid,start:j.start,end:j.end}),this.selectApplier.undoToRange(this.searchStatus.lastRange),this.applier.undoToRange(this.searchStatus.lastRange),d=e.length-(this.searchStatus.curSelection.end-this.searchStatus.curSelection.start),this.searchStatus.lastRange.deleteContents(),this.searchStatus.lastRange.insertNode(document.createTextNode(e)),this.searchStatus.lastRange=null,i.undo.push(h.buildReplaceUndo(b)),this.editor.store(b.cid),i.redo.push(h.buildReplaceUndo(b))):k&&k.doc.replaceSelection(e,"start","+findReplace"),a(this.searchStatus,f),this.highlightNext(),this.searchStatus.hits.splice(g,1),this.searchStatus.curPos--,this.searchStatus.curPos<0&&(this.searchStatus.curPos=this.searchStatus.hits.length-1),this.searchStatus.hits.length||this.clearSearch(),c=this.searchStatus.curSelection||this.searchStatus.initRange,this.editor.sourceView.inSourceMode||(c&&i.redo.push({type:"cursor",id:c.cid,start:c.start,end:c.end}),this.editor.undo.register(i))}},showPanel:function(a){$("#md-searchpanel").is(":visible")||(editor.lastCursor=editor.selection.buildUndo(),this.editor.undo.completeSnap(!0),this.clearSearch(),this.searchStatus.initPos=editor.selection.getPosBookmark(),$("#md-searchpanel").show().find("#search-panel-input").focus()[0].select(),$("#search-panel-input").val()&&this.doSearch($("#search-panel-input").val()),document.body.classList.add("on-search-panel-open")),a?($("#md-searchpanel").addClass("searchpanel-replace-mode"),document.body.classList.add("on-replace-panel-open")):($("#md-searchpanel").removeClass("searchpanel-replace-mode"),document.body.classList.remove("on-replace-panel-open")),File.isMac&&app.touchBar&&(app.touchBar.showFindReplaceTouchBar(),app.touchBar.updateFindReplaceMode())},closePanel:function(){var a=$(".md-search-select"),b=this.editor.getMarkElem().length;return document.body.classList.remove("on-replace-panel-open"),document.body.classList.remove("on-search-panel-open"),$("#md-searchpanel").removeClass("searchpanel-msg-mode").hide(),this.editor.sourceView.inSourceMode?(this.searchStatus&&this.searchStatus.hits.length&&(this.editor.fences.clearSearchAll(),this.editor.sourceView.cm.focus()),void this.resetSearchStatus()):(a.length?(this.editor.selection.selectAllElem(a),this.editor.lastCursor=this.editor.selection.buildUndo()):this.searchStatus&&this.searchStatus.curCmCursor&&(this.searchStatus.curCmCursor.doc.cm.focus(),this.editor.lastCursor=this.editor.selection.buildUndo(),b=!0),this.clearSearch(),$(".md-search-hit").removeClass("md-search-hit"),!b&&this.editor.restoreLastCursor(),void this.editor.refocus())},doSearch:function(a){function b(a){var b=a.containerNode||document.querySelector("[cid='"+a.cid+"']");return q?q.compareDocumentPosition(b)==m.DOCUMENT_POSITION_PRECEDING?!0:q==b?a.start<l.start:!1:!1}function c(a,c){for(var d=e(c,k),f=a.getValue(),g=null,i=!1,j=null;g=d.exec(f);)i=!0,j={isCm:a,cid:a.cid,start:d.lastIndex-c.length,end:d.lastIndex},k.wholeWord&&j.start>0&&p.exec(f.substr(j.start-1,1))||(k.hits.push(j),b(j)&&k.curPos++);i&&h.fences.searchOn(a,c,k)}function f(a,c,d){for(var f,g,i,l=e(c,k),m=h.findElemById(a.cid)[0],n=m.textContent;f=l.exec(n);)i={cid:a.cid,containerNode:m,start:l.lastIndex-c.length,end:l.lastIndex},k.wholeWord&&i.start>0&&p.exec(n.substr(i.start-1,1))||(g=g||j.createRange(),g.moveToBookmark(i),r.applyToRange(g),k.hits.push(i),b(i)&&k.curPos++)}function g(a,b,d){a.get("children").length?a.get("children").toArray().map(function(a){g(a,b)}):h.fences.queue[a.cid]?c(h.fences.queue[a.cid],b):n.isType(a,o.math_block)?(h.mathBlock.currentCm||{}).cid===a.cid&&(h.fences.clearSearchOn(h.mathBlock.currentCm),c(h.mathBlock.currentCm,b)):f(a,b,d)}this.clearSearch();var h=this.editor,i=this,k=this.searchStatus,l=k&&k.initPos,q=l&&document.querySelector("[cid='"+l.cid+"']");if(k.searchText=void 0===a?$("#search-panel-input").val():a,k.caseSensitive=$("#searchpanel-case-option-btn.active").length,k.wholeWord=$("#searchpanel-word-option-btn.active").length,d(k.searchText)){var i=this,r=this.applier;if(this.editor.sourceView.inSourceMode)return void c(this.editor.sourceView.cm,k.searchText);this.searchTimer=setTimeout(function(){for(var a=h.nodeMap.getFirst();a;)g(a,k.searchText,r),a=a.get("after");i.highlightNext()},50)}},highlightNext:function(a){function b(){e.curSelection&&((d=e.curSelection.isCm)?d.execCommand(a?"goDocStart":"goDocEnd"):e.lastRange&&this.selectApplier.undoToRange(this.searchStatus.lastRange))}function c(a){b.call(this),e.curSelection=e.hits[e.curPos],$(".md-focus").removeClass("md-focus"),(d=e.curSelection.isCm)?(e.lastRange=null,d.doc.setSelection(d.posFromIndex(e.curSelection.start),d.posFromIndex(e.curSelection.end)),File.isTypeWriterMode?f.selection.typeWriterScroll($(".CodeMirror-selectedtext")):f.selection.scrollAdjust($(".CodeMirror-selectedtext"),null,window.innerHeight-200),$(".CodeMirror-selectedtext").closest("[cid]").addClass("md-focus")):(e.lastRange=e.lastRange||j.createRange(),e.lastRange.moveToBookmark({containerNode:document.querySelector("[cid='"+e.curSelection.cid+"']"),start:e.curSelection.start,end:e.curSelection.end}),this.selectApplier.applyToRange(e.lastRange),File.isTypeWriterMode?f.selection.typeWriterScroll(e.lastRange.nativeRange):f.selection.scrollAdjust(e.lastRange,null,window.innerHeight-200),document.querySelector("[cid='"+e.curSelection.cid+"']").classList.add("md-focus"))}if(!$("#md-searchpanel").is(":visible"))return this.showPanel();$("#md-searchpanel").removeClass("searchpanel-msg-mode");var d,e=this.searchStatus,f=this.editor;e&&e.hits.length&&(e.curSelection&&(e.curPos+=a?-1:1),e.curPos>=e.hits.length?e.curPos=0:e.curPos<0&&(e.curPos=e.hits.length-1),c.call(this,e.curPos))},clearSearch:function(a){if(this.editor.sourceView.inSourceMode)return this.editor.fences.clearSearchAll(),void this.resetSearchStatus(this.searchStatus&&(this.searchStatus.curSelection||this.searchStatus.initPos));if(this.searchStatus){try{this.searchStatus.lastRange&&this.selectApplier.undoToRange(this.searchStatus.lastRange)}catch(b){console.dir(b)}for(var c,d=j.createRange(),e=0;e<this.searchStatus.hits.length;e++){var f=this.searchStatus.hits[e];f.isCm||(d.moveToBookmark({containerNode:document.querySelector("[cid='"+f.cid+"']"),start:f.start,end:f.end}),this.applier.undoToRange(d))}(c=this.searchStatus.curSelection&&this.searchStatus.curSelection.isCm)&&(c.doc.setSelection(c.posFromIndex(this.searchStatus.curSelection.start)),$(c.display.input).blur())}this.editor.fences.clearSearchAll(),clearTimeout(this.searchTimer);var g=this.searchStatus&&(this.searchStatus.curSelection||this.searchStatus.initPos);this.resetSearchStatus(g)},resetSearchStatus:function(a){this.searchStatus={hits:[],curPos:0,searchText:null,lastRange:null,initPos:a,curSelection:null}}});c.exports=r}),define("app/editor/Word",["jquery/jquery","exoskeleton-master/exoskeleton"],function(a,b,c){"use strict";var d=a("jquery/jquery"),e=a("exoskeleton-master/exoskeleton"),f=e.Model.extend({initialize:function(a){this.editor=a,this.$container=d("#word-auto-suggest")},search:function(a,b,c,d){var e=a.substring(b,b+c);if(!e)return[];var f=[];return File.isMac?(f=app.word.getSpellSuggestionInContext(a,b,c),d.type="word",d.token=e,d.match=f,d.found=f.length,d.pageNo=0,d.pageCnt=Math.floor((f.length-1)/5+1)):d.found=!1,f},showAutoSuggest:function(a,b,c,e){if(e.token===a.substring(b,b+c))return!1;var f=this.search(a,b,c,e),g="";if(!e.found)return this.$container.hide(),!1;for(var h=0;h<f.length&&40>h;h++)h%5==0&&(g+=(h>0?"</ul>":"")+"<ul data-page='"+h/5+"' style='display:none'>"),g+=d("<li/>").attr("data-content",f[h]).text(f[h])[0].outerHTML;return g+="</ul>",this.$container.html(g),this.$container}});c.exports=f}),define("app/document/Export",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/document/StringUtils","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/UndoManager","app/editor/Emoji","app/document/Node2Native","app/editor/Diagram","codemirror/lib/codemirror","app/editor/KeyMaster","app/document/MarkParser","app/editor/polyfill"],function(a,b,c){"use strict";function d(){g&&(g.close(),g.destroy(),g=null),$("#md-notification").fadeOut()}function e(a){return a.map(function(a){return"<div class='footnote-line'>"+a.join("")+"</div>"}).join("\n")}var f,g,h=a("exoskeleton-master/exoskeleton"),i=a("app/document/Node"),j=i.Node,k=i.TYPE,l=(i.NodeCollectionUtils,a("app/document/StringUtils")),m=a("app/document/MarkParser"),n=a("app/editor/Inline"),o=(a("app/document/Node2Native"),a("app/editor/EditHelper")),p=(a("app/editor/polyfill"),1e4),q=function(){for(var a=document.querySelectorAll("#write a"),b=/^\s*#(.+)$/,c={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"'":"\\'","\\":"\\\\"},d=function(a){return a.replace(/["\\\b\t\n\f\r]/g,function(a){return c[a]}).replace(/\u200b/g,"")},e=0;e<a.length;e++){var f,g=a[e],h=g.getAttribute("name"),i=g.getAttribute("href");if(h){var j=document.createElement("a"),k=document.createTextNode(" ");j.appendChild(k),j.setAttribute("class","md-print-anchor"),j.setAttribute("href","uaf://"+d(h)),g.parentNode.insertBefore(j,g)}i&&(f=b.exec(i))&&(i=f[1],g.setAttribute("href","uat://"+d(i)))}};window.releaseCaptureWin_=d;var r=h.Model.extend({initialize:function(b){this.editor=b,window.debugMode&&a.async("FileSaver.min",function(a){f=a})},exportToNative:function(a,b){return b=File.isMac?function(a){app.controller.exportWithPandocCallback(a)}:b||function(){},this.editor.nodeMap.exportToNative(a,b)},exportToImage:function(){function a(a){return/png$/i.exec(t)?a.toPNG():a.toJPEG(100)}function b(a,b){reqnode("fs").writeFile(a,b,function(b){b?m.showErrorBox("Save to Image Failed",b.message):j.shell.showItemInFolder(a)})}function c(){if(t&&s.length){var c=null,e=0;try{if(s.length>1){var f=document.createElement("canvas"),g=f.getContext("2d");f.width=640,f.height=i,s.forEach(function(a){var b=new Image(640,a.getSize().height);b.src=a.toDataURL(),g.drawImage(b,0,e),e+=b.height}),c=a(j.nativeImage.createFromDataURL(f.toDataURL())),b(t,c),d()}else c=a(s[0]),b(t,c),
d()}catch(h){console.error(h),d()}}}function e(){File.editor.store(!0),d();var a=o.exportToHTML(!0,!1,!1,!0),b=j.app.setting.config;return g=new n({skipTaskbar:!0,show:!1,webPreferences:{webSecurity:!1,allowDisplayingInsecureContent:!0,allowRunningInsecureContent:!0,nodeIntegration:!1,directWrite:b.directWrite,defaultFontFamily:b.defaultFontFamily,zoomFactor:r},webgl:!1,useContentSize:!0,width:640,height:960,enableLargerThanScreen:!0,offscreen:!0,alwaysOnTop:!0,minimizable:!1,closable:!1}),g.loadURL("data:text/html;charset=UTF-8,  "+encodeURIComponent(a)),g}function f(){$("#md-notification").html("<p> Exporting into image file... </p>").show()}function h(a){var b=i-a;b>p&&(b=p),g.setContentSize(640,b),g.webContents.once("did-navigate-in-page",function(e,f){return setTimeout(function(){g.webContents.capturePage(function(e){return e.isEmpty()?d():(q>1&&(e=e.resize({width:640,quality:"best"})),s.push(e),void(i>a+b?(a+=b,h(a)):c()))})},400),!1}),g.webContents.executeJavaScript("document.body.scrollTop = {d}; window.location.hash = {d};".replace(/{d}/g,a))}var i,j=reqnode("electron").remote,k=j.getCurrentWindow(),l=j.app,m=j.dialog,n=j.BrowserWindow,o=this,q=j.screen.getPrimaryDisplay().scaleFactor||1,r=l.setting.get("zoomFactor")||1,s=[],t=null;try{e().webContents.once("did-finish-load",function(){setTimeout(function(){g.webContents.once("did-navigate-in-page",function(a,b){var c=b.match(/[\d\.]+$/)[0]-0;return a.preventDefault(),isNaN(c)?d():(g.setContentSize(640,c),i=c,i>4*p?(d(),m.showErrorBox("Save to Image Failed","Generated Image too Large"),!1):(h(0),!1))}),g.webContents.executeJavaScript("window.location.hash = document.body.clientHeight;")},400)})}catch(u){d()}m.showSaveDialog(k,{properties:["saveFile"],title:"Export to...",defaultPath:l.getPath("userDesktop")+"/"+File.getSuggestedFileName(!0)+".png",filters:[{name:"PNG",extensions:["png"]},{name:"JPEG",extensions:["jpg","jpng"]}]},function(a){return a?(t=a,f(),void c()):d()})},exportAndSaveHTML:function(a){var b=new Blob([this.exportToHTML(a)],{type:"text/html;charset=utf-8"});f(b,"export.html")},exportCollection:function(a,b,c,d,f,g,h){function i(a){if("string"==typeof a)return g.output(a,n.decorateAsExport);var e=a.get("children");if(j.isType(a,k.paragraph)){var h=[];return e.sortedForEach(function(a){h.push(g.output(a.get("text"),n.decorateAsExport))}),h.join("\n")}return e&&e.length>0?v.exportCollection(e,b,c,d,f,g):g.output(a.get("text"),n.decorateAsExport)}function p(a){function b(a){return i(a.get("parent").get("loose")===!1?a.getFirstChild():a)}function e(){if(d)return"<div>[TOC]</div>";if(!f){var a=$(document.querySelector(".md-toc-content")).clone();a.find("[data-ref]").each(function(){this.querySelector("a").setAttribute("href",(c&&File.isMac?"at://":"#header-")+this.getAttribute("data-ref")),c&&File.isNode&&File.option.printPDFByPhantom&&this.querySelector("a").setAttribute("href","")}),f="<div class='md-toc' mdtype='toc'>"+a[0].outerHTML+"</div>"}return f}var f=null;switch(a.get("type")){case k.paragraph:return"<p>"+i(a)+"</p>";case k.heading:var g="";return c&&1==a.get("depth")&&!a.get("parent")&&a.get("before")&&(g=" data-breakpage"),"<h"+a.get("depth")+g+">"+(d||h?"":"<a name='header-"+a.cid+"' class='md-header-anchor "+(c?"md-print-anchor' href='af://"+a.cid+"'> ":"'>")+"</a>")+i(a)+"</h"+a.get("depth")+">";case k.blockquote:return"<blockquote>"+i(a)+"</blockquote>";case k.list:var m=a.get("style"),n=function(){for(var b=a.get("children").toArray(),c=!1,d=0;d<b.length;d++){var e=b[d].getFirstChild();if(!j.isType(e,k.paragraph)||e.get("after"))return!0}return c}();if(a.set("loose",n),m==j.ListType.task)return"<ul "+(d?"":"class='task-list'")+">"+u+i(a)+"</ul>";var q="";return m==j.ListType.ol&&(q=""===a.get("start")?void 0:a.get("start")-0,q=Number.isNaN(q)||1==q?"":" start='"+a.get("start")+"' "),"<"+m+q+">"+i(a)+"</"+m+">";case k.list_item:var r=a.get("parent").get("style")===j.ListType.task;return r?"<li "+(d?"":"class='task-list-item task-list-"+(a.get("checked")?"done":"not-done")+"'")+" ><input type='checkbox' disabled='disabled' "+(a.get("checked")?"checked":"")+"></input>"+i(a)+"</li>":"<li>"+u+b(a)+"</li>";case k.fences:if(d){var t=l.escapeInQuote(a.get("lang")||"");return t?"<pre><code class='language-"+t+"' lang='"+t+"'>"+u+l.escape(a.get("text"))+u+"</code></pre>":"<pre><code>"+u+l.escape(a.get("text"))+u+"</code></pre>"}if(a.get("lang")){var v=s.findElemById(a.id).clone();return File.option.enableDiagram&&j.isType(a.get("lang").toLowerCase(),"flow","sequence","mermaid")?o.processExportedSVG(v.find(".md-diagram-panel").html(v.find(".md-diagram-panel-preview").html())[0].outerHTML):(v.removeAttr("cid").removeAttr("contenteditable").removeAttr("mdtype").find("input, textarea, .code-tooltip, .CodeMirror-cursors, .CodeMirror-hscrollbar, .CodeMirror-vscrollbar").remove(),v[0].outerHTML)}return"<pre class='md-fences mock-cm' style='display:block;position:relative'>"+l.escape(a.get("text"))+"</pre>";case k.math_block:var w=s.findElemById(a.id),x=w.width(),y=w.find(".MathJax_SVG").width();return y-10>x&&(w=w.clone().find(".MathJax_SVG").css("zoom",x/y)),c&&File.isNode&&File.option.printPDFByPhantom&&(w=w.clone().css("zoom",1/.9*1.25+"")),w[0]?o.processExportedSVG(w[0].outerHTML):"<p class='math-block'>$$"+l.escape(a.get("text"))+"$$</p>";case k.hr:return"<hr />";case k.def_footnote:return"";case k.def_link:return"";case k.table:for(var z=(a.get("align").length,"<table>"+u),A=a.getFirstChild();A;)z+=A.get("before")?p(A):"<thead>"+u+p(A)+"</thead>"+u+"<tbody>",A=A.get("after"),A||(z+="</tbody>"+u);return z+="</table>";case k.table_row:for(var B,z="<tr>",A=a.getFirstChild(),C=a.get("parent").get("align"),D=0,E=a.get("before")?"td":"th";A;)B=C[D],B=B?" style='text-align:"+B+";' ":"",z+="<"+E+B+">"+p(A)+"</"+E+">",A=A.get("after"),D++;return z+="</tr>";case k.table_cell:return i(a);case k.meta_block:return"";case k.toc:return e();default:return"<p>"+i(a)+"</p>"}}function q(a,c){if(!b[c]){var d=g.output(a.get("text"),n.decorateAsExport,null,null,{footnote:1});b[c]=["<span class='md-fn-count'>"+c+"</span> "+d]}var e=b[c].length-1,f=c+(e?"-"+e:"");return b[c].push("<a name='dfref-footnote-"+f+"' href='#ref-footnote-"+f+"' title='back to document' class='reversefootnote' >↩</a>"),f}var r=this.editor.nodeMap,s=this.editor,g=g||new m.InlineLexer({nodeMap:r,count:1,footnoteList:[],appendFootnote:q,noStyle:d,forPrint:c,skipOp:{atag:!0,underline:!0,comment:!0,imgtag:!0}},n.decorateAsExport),t="",u=d?"\n":"",v=this;if(b=b||[],"string"==typeof a)return i(a);if(a.length){var w=a instanceof Array,x=w?a[0]:a.sortedFirst();do t+=p(x)+u,x=x.get("after");while(x&&(!w||a.indexOf(x)>-1))}return t+(f?e(b):"")},exportToHTML:function(a,b,c,d){function f(c,f){if(f=l.escape(f)||"",n.length){window.app&&app.setting.get("split_pages");c+="<div class='footnotes-area' "+(a?"data-breakpage":"")+" ><hr/>"+e(n)+"</div>"}var g=a?"<script> window.setBreakPage = function(b){var node = document.querySelectorAll('[data-breakpage]'); for(var i=0;i<node.length;i++){node[i].style.pageBreakBefore = b ? 'always':'' }}; setBreakPage("+(window.app&&app.setting.get("split_pages")?"true":"false")+");</script>":"",h=File.isMac?"is-mac":"is-node",i=d?"24px":document.body.parentElement.style.fontSize||"";if(i&&(i=" style='font-size:"+i+" !important'"),a&&File.isMac&&(g+="<script>("+q.toString()+")();</script>"),b)return"<!doctype html>\n<html>\n<head>\n<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>\n<title>"+f+"</title></head>\n<body>"+c+"</body>\n</html>";var k=j(),m=["typora-export"];return d&&(m.push("for-image"),k+="::-webkit-scrollbar {display: none;}"),console.log("csslinks == "+s),"<!doctype html>\n<html"+i+(a&&!File.option.printPDFByPhantom&&" class='blink-to-pdf' "||"")+">\n<head>\n<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>\n<title>"+f+"</title>"+s+"<style type='text/css'>html {overflow-x: initial !important;}"+k+"\n</style>\n</head>\n<body class='"+m.join(" ")+"' >\n<div  id='write' "+(a?"style='top:auto'":"")+" class = '"+h+"'>"+c+"</div>\n"+g+"</body>\n</html>"}function g(a){if(!a)return"";var b,c,d=/^\s*@include-when-export\s+url\(([^\)]+)\)/gim,e="";try{c=a.match(d),c&&c.map(function(a){b=/^\s*@include-when-export\s+url\(([^\)]+)\)/gim.exec(a),e+="<link href='"+b[1]+"' rel='stylesheet' type='text/css' />"})}catch(f){}return e}function h(a){return File.isMac?app.path.readText(a):File.isNode?reqnode("fs").readFileSync(a,"utf-8"):void 0}function i(a,b){function c(a){var c=(a.match(d)||[""])[0];return a=decodeURI(c.length?a.substring(1,a.length-1):a),a=File.isMac?app.path.resolvePathRelateTo(a,b):reqnode("path").resolve(b,a),a.match(/\.css$/)?(console.debug("fetch CSS from @import: "+a),e.push(i(h(a),a)),a=""):a=(File.isMac?"file://":"file:///")+a,c+encodeURI(a)+c}var d=/^["']/,e=[];return b=(b||"").replace(/[\/\\][^\/\\]*$/,""),a=(a||"").replace(/(^|;|\n)[\s]*@import([^;\n]+)(;|$|\n)/,function(a,b){var d=(/['"]([^"']+)['"]/.exec(a)||[])[0];return d?a.replace(d,c(d)):a}).replace(/url\([^:)]+\)/gi,function(a){return a=a.substring(4,a.length-1),"url("+c(a)+")"}),a=e.join("\n")+a}function j(){function b(a){for(var c in a.cssRules){var d=a.cssRules[c];if(d.styleSheet){if(d.href.match(/mermaid/i)&&!p)continue;b(d.styleSheet)}else f.push((d.cssText||"").replace(/content: ([^;]{1});/g,"content: '$1';"))}}var c,d,e,f=[];if(s="",a){if(document.querySelectorAll("link[css-include]").forEach(function(a){s+="<link rel='stylesheet' href='"+l.escapeInQuote(a.href)+"' type='text/css' />"}),File.colorBrightness<.5&&File.isNode){var j=reqnode("electron").remote.app.getPath("userData");s+=["github.css","base.user.css","github.user.css"].map(function(a){return"<link rel='stylesheet' href='file:///"+l.escapeInQuote(j+"/themes/"+a)+"' type='text/css' />"}).join("\n")}else s+=["theme_css","base_user_css","theme_user_css"].map(function(a){return"<link rel='stylesheet' href='file://"+(File.isWin?"/":"")+l.escapeInQuote($("#"+a).attr("href"))+"' type='text/css' />"}).join("\n");return""}if(File.isMac)e=["theme_css","base_user_css","theme_user_css"].map(function(a){var b=h($("#"+a).attr("href"));return s+=g(b),i(b,$("#"+a).attr("href"))}).join("\n");else if(File.colorBrightness<.5&&File.isNode){var j=reqnode("electron").remote.app.getPath("userData");e=["github.css","base.user.css","github.user.css"].map(function(a){try{var b=j+"/themes/"+a,c=h(b,"utf-8");return s+=g(c),i(c,b)}catch(d){}return""}).join("\n")}d=["(base\\.css)"],e||d.push("(theme)"),r&&d.push("(codemirror)"),p&&d.push("(mermaid)"),d=new RegExp(d.join("|"),"i");for(var k=0;k<document.styleSheets.length;k++)if(c=document.styleSheets[k],d.exec(c.href)&&(b(c),/themes/.exec(c.href)))try{var m=decodeURI(c.href.replace(File.isWin?/^[\w_-]+:[\/]+/:/^[\w_-]+:\/\//,""));s+=g(h(m,"utf-8"))}catch(n){}return e&&f.push(e),f.join("\n")}var k=this.editor.nodeMap,m=this.editor,n=[],o=File.editor.docMenu.getValueInMeta("title")||File.getFileName(),p=File.option.enableDiagram&&$(".md-fences[lang='mermaid']").length,r=Object.keys(File.editor.fences.queue).length,s="";return File.option.showLineNumbersForFence&&m.fences.refreshEditor(!0),f(this.exportCollection(k.blocks,n,a,b,void 0,void 0,d),o)}});c.exports=r}),define("app/document/Node2Native",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/editor/Diagram","codemirror/lib/codemirror","app/editor/KeyMaster","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/UndoManager","app/editor/Emoji"],function(a,b,c){"use strict";function d(){k=Object.create(null),!j&&File.option.enableInlineMath&&(j=document.querySelector("#inline-math-export-jax"),MathJax.Hub.Typeset(j),j=MathJax.Hub.getAllJax(j)[0]),$(".md-inline-math, [mdtype='math_block']").each(function(){try{var a,b=this.querySelector("script").textContent.trim().replace(/\u200b/g,"");this.classList.contains("md-inline-math")?(j.Text(b),a=j.root.toMathML("")):a=MathJax.Hub.getAllJax(this)[0].root.toMathML(""),k[b]=a}catch(c){}})}function e(a,b){var c=document.querySelector("[cid='"+a+"'] svg"),d=v.svg2DataURL(c,$(c).closest("[lang='mermaid']").length),e=c.getBoundingClientRect(),g=new Image;g.onerror=function(a){b("")},g.onload=function(){var a=document.createElement("canvas"),c=a.getContext("2d"),d=File.canvasratio,h=g.width,i=e.bottom-e.top;a.width=g.width,a.height=e.bottom-e.top,d>1.1&&(a.width=h*d,a.height=i*d,c.scale(d,d)),c.drawImage(g,0,0),a.style.width=h+"px",a.style.height=i+"px",setTimeout(function(){f(a.toDataURL("image/png"),b)},100)},g.src=d}function f(a,b){var c;if(File.isNode){var d=a.replace(/^data:image\/png;base64,/,""),e=reqnode("electron").remote.app;c=e.getPath("temp").replace(/[\/\\]$/,"")+(File.isWin?"\\\\":"/")+Number(new Date)+".png",reqnode("fs").writeFile(c,d,"base64",function(a){a?console.error(a.stack):(b(c),B.push(c))})}else{if(!File.isMac)return"";c=window.app.path.savePNG(a),b(c),B.push(c)}}function g(a,b){function c(c){return c||0==m.size?(a=d.join(""),b(a),!0):void 0}var d=a.split(/(\uE040\d+)\uE041/g);d.length;d.forEach(function(a,b){if(a.charAt(0)==x){var f=a.substring(1)-0,g=l[f].cid;e(g,function(a){d[b]=JSON.stringify(a),m["delete"](g),c()})}else c()})}function h(){if(File.isNode)for(;B.length;)reqnode("fs").unlink(B.pop());else File.isMac&&(app.path.removeTempFiles(JSON.stringify(B)),B=[])}function i(a){if(z={target:a,nodeMap:this,skipOp:N},A=[],l=[],m=new Set,void 0===File.canvasratio){File.canvasratio=1;var b=document.createElement("canvas"),c=b.getContext("2d"),d=window.devicePixelRatio||1,e=c.webkitBackingStorePixelRatio||c.mozBackingStorePixelRatio||c.msBackingStorePixelRatio||c.oBackingStorePixelRatio||c.backingStorePixelRatio||1;File.canvasratio=d/e}}var j,k,l,m,n,o=(a("exoskeleton-master/exoskeleton"),a("app/document/Node")),p=o.Node,q=o.NodeMap,r=o.TYPE,s=a("app/document/StringUtils"),t=a("app/editor/Diagram"),u=a("app/document/MarkParser"),v=a("app/editor/EditHelper"),w={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},x="",y="",z={},A=[],B=[],C=function(a){return a.replace(/["\\\b\t\n\f\r]/g,function(a){return w[a]}).replace(/\u200b/g,"")},D={left:"AlignLeft",right:"AlignRight",center:"AlignCenter"},E=function(a,b,c,d){b=void 0===b?",":b,d=d||z;for(var e,f=[],g=c||a.getFirstChild();g;)e=I(g,d),e&&f.push(e),g=g.get("after");return f.join(b)},F=function(a,b){function c(a){return'Str "'+"\\t".repeat(a.get("depth")-1)+'", Link ("", [], []) ['+G(a)+'] ("#header-'+a.cid+'","")'}function d(a){return'Str "'+" ".repeat(a.get("depth")-1)+'", Link ("", [], []) ['+G(a)+'] ("#header-'+a.cid+'","")'}var e=[];try{return e=a.toc.headers.map(b?d:c),'Div ("toc", [], []) [Para ['+e.join(",LineBreak,")+"]]"}catch(f){return console.warn(f.stack),""}},G=function(a,b){return b=b||a.get("text"),n.output(b,null,a).replace(/, $/,"")||'Str ""'},H=function(a){try{var b=new DOMParser,c=b.parseFromString(a,"text/html");return c.querySelectorAll("mtable").forEach(function(a){a.hasAttribute("columnalign")&&!a.getAttribute("columnalign")&&a.removeAttribute("columnalign")}),c.body.innerHTML}catch(d){}return a},I=function(a,b){var c;p.isType(b.target,"epub","rst","opml","textile");switch(a.get("type")){case r.meta_block:return"";case r.heading:var d=p.isType(b.target,"textile","opml")?"":"header-"+a.cid;return"Header "+a.get("depth")+' ("'+d+'", [], []) ['+G(a)+"]";case r.line:return G(a);case r.paragraph:return c=E(a,",Space,"),"Para ["+c+"]";case r.blockquote:return c=E(a),"BlockQuote ["+c+"]";case r.list:var e=a.get("style");return c=E(a),e==p.ListType.ol?"OrderedList (1,Decimal,Period) ["+c+"]":"BulletList ["+c+"]";case r.list_item:return c=E(a),"["+c+"]";case r.fences:if(t.isDiagramType(a.get("lang"))&&p.isType(b.target,"epub","docx","odt")){l.push(a),m.add(a.cid);var f=document.querySelector("[cid='"+a.cid+"'] svg").getBoundingClientRect();return'Div ("",[],[("style","text-align:center")]) [Para [Image ("'+a.get("lang")+'",[],[("width", "'+(f.right-f.left)+'")]) [Str ""] ('+(x+(l.length-1)+y)+',"fig:")]] '}return'CodeBlock ("",["'+C(a.get("lang")||"")+'"],[]) "'+C(a.get("text"))+'"';case r.math_block:if(c=a.get("text").trim().replace(/\u200b/g,""),"epub"==b.target){var g=k[c];if(g)return'RawBlock (Format "html") '+JSON.stringify(H(g))+" "}else if("latex"==b.target&&c.match(/^\\(begin|newcommand|renewcommand|newenvironment|renewenvironment|def|let){/))return'RawBlock (Format "latex") '+JSON.stringify(c);return'Plain [Math DisplayMath "'+C(c)+'"]';case r.hr:return"HorizontalRule";case r.def_footnote:case r.def_link:return"";case r.toc:return"latex"==b.target?'RawBlock (Format "latex") "\\\\tableofcontents"':"wiki"==b.target?'RawBlock (Format "mediawiki") "__TOC__", RawBlock (Format "mediawiki") ""':"rst"==b.target?'RawBlock (Format "rst") ".. contents::", RawBlock (Format "rst") "\n"':"opml"==b.target?"":"textile"==b.target?'RawBlock (Format "textile") "{toc}", RawBlock (Format "textile") "\n"':F(a.get("in"),"epub"==b.target);case r.table:var h=a.get("align").map(function(a){return D[a]||"AlignDefault"}),i=h.map(function(){return"0.0"}),j=a.getFirstChild();return"Table [] ["+h.join(",")+"] ["+i.join(",")+"] ["+E(j)+"] ["+E(a,",",j.get("after"))+"]";case r.table_row:return"["+E(a)+"]";case r.table_cell:return"[Plain ["+G(a)+"]]";default:return""}},J=[];J[r.strong]="Strong",J[r.em]="Emph",J[r.del]="Strikeout",J[r.subscript]="Subscript",J[r.superscript]="Superscript";var K,L={html:'RawInline (Format "html") "<u>", $0, RawInline (Format "html") "</u>", ',docx:'RawInline (Format "openxml") "<w:r><w:rPr><w:u w:val=\\"single\\" /></w:rPr><w:t>$0</w:t></w:r>", ',rtf:'RawInline (Format "rtf") "{\\\\ul ", $0, RawInline (Format "rtf") " }", ',latex:'RawInline (Format "latex") "\\\\underline{", $0, RawInline (Format "latex") "}", '},M={html:'RawInline (Format "html") "<mark>", $0, RawInline (Format "html") "</mark>", ',docx:'RawInline (Format "openxml") "<w:r><w:rPr><w:shd w:val=\\"clear\\" w:fill=\\"ffff00\\" /></w:rPr><w:t>$0</w:t></w:r>", ',rtf:'RawInline (Format "rtf") "{{\\\\colortbl;\\\\red255\\\\green255\\\\blue0;} \\\\cb1 ", $0, RawInline (Format "rtf") "}", ',latex:'RawInline (Format "latex") "\\\\hl{", $0, RawInline (Format "latex") "}", '},N={atag:!0,imgtag:!0,comment:!0},O=function(a,b){var c=function(a){if(p.isType(a.type,r.plain,r.escape,r.emoji))return a.inner||a.text;if(b)return a.text||"";throw Error("caught styles")};K||(K=new u.InlineLexer({skipOp:N},c));try{return K.output(a.text,c,null,!0)}catch(d){return!1}},P=function(a,b){var c,d,e,f,g,h,i=/^(\S*)(\s*)/,j=function(a){for(var b,c="";a.length&&(b=i.exec(a));)a=a.substring(b[0].length),b[1]&&(c+='Str "'+C(b[1])+'", '),b[2]&&(c+="Space, ");return c};a.inner&&(a.inner=a.inner.replace(/, $/,""));var l=/^file:[\\\/]{0,2}/i;switch(a.type){case r.strong:case r.em:case r.del:case r.subscript:case r.superscript:return J[a.type]+" ["+a.inner+"], ";case r.plain:case r.escape:return j(a.text);case r.code:return'Code ("", [], []) "'+C(a.text.trim())+'", ';case r.autolink:case r.url:return'Link ("", [], []) [Str "'+C(a.text)+'"] ("'+C(a.href)+'", ""), ';case r.tag:case r.atag:case r.imgtag:case r.comment:return'RawInline (Format "html") "'+C(a.text)+'", ';case r.link:if("#"==(a.href||"").trim()[0]){var e=a.href.substr(1),m=$("h1, h2, h3, h4, h5, h6").filter(function(){return $(this).text().toLowerCase().trim()==e.toLowerCase().trim()});m.length&&(a.href="#header-"+m.attr("cid"))}return'Link ("", [], []) ['+a.inner+'] ("'+C(a.href)+'", "'+C(a.title||"")+'"), ';case r.image:return'Image ("",[],[]) [Str "'+C(a.title||"")+'"] ("'+C(File.editor.imgEdit.getRealSrc(a.href).replace(l,""))+'","fig:"), ';case r.refimg:f="Image";case r.reflink:return c=b.nodeMap.link_list.getNodeByRef(a.ref||a.text),d=c?C(c.get("href").replace(l,"")):"",e=C(c&&c.get("title")||""),f=f||"Link","Image"==f&&(a.inner='Str "'+C(e||"")+'"'),f+' ("", [], []) ['+a.inner+'] ("'+d+'", "'+e+'"), ';case r.footnote:var n=b.nodeMap.foot_list.getNodeByRef(a.text);return n?"Note [Para ["+G(n)+"]], ":j(a.text);case r.attr:return j(a.text);case r.emoji:return'Str "'+C(a.inner)+'", ';case r.inline_math:if("epub"==b.target){var o=k[a.text.replace(/(^\s*\$+)|(\$+\s*$)|\u200b/g,"").trim()];if(o)return'RawInline (Format "html") '+JSON.stringify(o)+", "}return'Math InlineMath "'+C(a.text.replace(/(^\s*\$+)|(\$+\s*$)|\u200b/g,""))+'", ';case r.linebreak:return"LineBreak, ";case r.highlight:if("latex"==b.target)A.push("\\usepackage{color}"),A.push("\\usepackage{soulutf8}");else if("docx"==b.target)return h=O(a,!0),M[b.target].replace("$0",C(s.escape(h)));g=M;case r.underline:return g=g||L,"docx"==b.target?(h=O(a,!0),g[b.target].replace("$0",C(s.escape(h)))):(g[b.target]||g.html).replace("$0",a.inner);default:return""}},Q=function(a){function b(a,b){return b instanceof Array?c(a,b):'("'+C(a)+'", MetaInlines [ '+(n.output(b).replace(/, $/,"")||'Str ""')+"])"}function c(a,b){return'("'+C(a)+'", MetaList ['+b.map(function(a){return'MetaInlines [RawInline (Format "tex") "'+C(a)+'"]'}).join(", ")+"])"}var d=[];a["header-includes"]&&a["header-includes"]instanceof Array?a["header-includes"]=a["header-includes"].concat(A):A.length&&(a["header-includes"]=A);for(var e in a)d.push(b(e,a[e]));return d.join(", ")};q.prototype.exportToNative=function(a,b){File.editor["export"].cleanUpTempFiles=h,i.call(this,a),"epub"==a&&d(),n&&n.options.nodeMap===this||(n=new u.InlineLexer(z,P));var c=E(null,"\n ,",this.getFirst(),z),e="Pandoc (Meta {unMeta = fromList ["+Q(File.editor.docMenu.buildMetaMap())+"]})\n ["+c+"]";return p.isType(a,"epub","docx")?g(e,b):b(e),e}}),define("app/editor/SourceView",["codemirror/lib/codemirror","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/UndoManager","app/editor/Emoji"],function(a,b,c){"use strict";function d(a,b){var c="number"==typeof a?a:a.get("tail");return void 0===c?void 0===b?a.get("after")?1:0:b:c}function e(a){return o.isType(a,p.table_row,p.line)?0:d(a)}function f(a){function b(a){return a.get("children").toArray().reduce(function(a,b){return a+f(b)},0)}function c(a){return o.isType(a.get("parent"),p.list_item)&&a.get("parent").get("tight")!==!1}switch(a.get("type")){case p.meta_block:return 2+a.get("text").match(/(\n|$)/g).length+d(a);case p.heading:return(a.get("ahead")||0)+((a.get("pattern")||(!o.isType(a.get("parent"),p.list_item)&&File.option.headingStyle&&a.get("depth")<=2?"===":"#")).match(/[-=]/)?2:1)+d(a);case p.paragraph:var e=a.get("tail");return void 0===e&&a.get("after")&&o.isType(a.get("parent"),p.list_item)&&(e=c(a)?0:1),o.isType(a.get("after"),p.paragraph)&&1>e&&(a.unset("tail"),e=1),void 0!==e||!o.isType(a.get("after"),p.math_block)&&a.get("after")||(e=0),(a.get("ahead")||0)+(a.get("children").length||1)+d(void 0===e?a:e,e);case p.line:return 1;case p.blockquote:return(a.get("ahead")||0)+b(a)+d(a);case p.list:var g=a.get("ahead")||0;return a.isLoose(!0),g+=b(a),o.isType(a.get("after"),p.list)&&(!a.get("tail")||a.get("tail"))<2&&a.get("pattern")==a.get("after").get("pattern")&&a.get("style")==a.get("after").get("style")&&(a.unset("tail"),g++,c(a)&&g++),g+=d(a,c(a)?0:1);case p.list_item:var e=a.get("tail");return void 0==e&&!a.get("tight")&&a.get("after")&&(e=1),b(a)+(e||0);case p.fences:var h=/`|~/.exec(a.get("pattern")||"```");return(a.get("ahead")||0)+(h?3:1)+(a.get("text").match(/\n/g)||[]).length+d(a);case p.math_block:return(a.get("ahead")||0)+3+(a.get("text").match(/\n/g)||[]).length+d(a,o.isType(a.get("before"),p.paragraph)&&o.isType(a.get("after"),p.paragraph)?0:1);case p.hr:return d(a)+1;case p.toc:return(a.get("ahead")||0)+1+d(a);case p.def_footnote:case p.def_link:return(a.get("ahead")||0)+1+d(a,!a.get("after")||o.isType(a.get("after"),o.TYPE.def_link)?0:1);case p.table:return(a.get("ahead")||0)+a.get("children").length+1+d(a);case p.table_row:return a.get("before")?1:2;case p.table_cell:return 0;default:return 1}}function g(a,b){return b=b||0,a?a.get("before")?g(a.get("before"),b+f(a.get("before"))):a.get("parent")?g(a.get("parent"),b+(a.get("parent").get("ahead")||0)):b:b}function h(){var a=s.lineText.substring(0,s.ch);s.inRef=a.match(v)&&!a.match(w),s.textBefore=a}function i(){var a=s.textBefore;s.cellsBefore=n.splitTableCell(a.replace(/^\s*\|/,""),!0)||[a],s.cellsOffset=s.cellsBefore.last().length,s.cellsBefore=s.cellsBefore.length}var j=a("codemirror/lib/codemirror"),k=(a("codemirror/addon/selection/active-line"),a("codemirror/addon/edit/visiblespace"),a("jquery/jquery")),l=(a("exoskeleton-master/exoskeleton"),a("app/document/Node")),m=a("app/document/StringUtils"),n=a("app/document/MarkParser"),o=l.Node,p=l.TYPE,q=k("#typora-source"),r=(k("#toggle-sourceview-btn"),!1),s=null,t=function(a){this.editor=a,this.cm=null,this.inSourceMode=!1,this.renderedHTML=""};t.prototype.prep=function(){if(!this.cm){var a=document.querySelector("#typora-source-input"),b=this;this.cm=j.fromTextArea(a,{lineWrapping:!0,mode:"gfm",theme:"typora-default",styleSelectedText:!0,maxHighlightLength:1/0,styleActiveLine:!0,visibleSpace:!0,viewportMargin:100,autoCloseBrackets:!0,autoCloseTags:!0,resetSelectionOnContextMenu:!1,extraKeys:{Enter:"newlineAndIndentContinueMarkdownList"},lineNumbers:!0,dragDrop:!1},this.editor),q.css("z-index","2");var c=null,d=(this.cm,this.editor);File.isMac?c=app.menu.getItem("Edit").submenu():File.isNode&&(c=reqnode("electron").remote.Menu.getApplicationMenu().getItem("Edit").submenu),this.cm.on("changes",function(a,e){if(b.inSourceMode&&(document.querySelector(".on-search-panel-open")&&"+findReplace"!==e[0].origin&&"setValue"!==e[0].origin&&b.editor.searchPanel.closePanel(),"begin"!==e[0].origin&&"sync"!==e[0].origin)){r=!0;var f=File.editor.sourceView.cm.doc.historySize();c&&(c.getItem("Undo").setEnabled(!File.isLocked&&f.undo>0),c.getItem("Redo").setEnabled(!File.isLocked&&f.redo>0)),"fromDisk"!==e[0].origin&&File.updateChangeCount(File.ChangeType.NSChangeDone),d.syncChange([{type:"sync",srcChanges:e}]),File.needsUpdateSnap()}}),this.cm.on("contextmenu",function(a,c){if(b.inSourceMode){var d=a.getCursor("from"),e=a.getCursor("to");setTimeout(function(){a.setSelection(d,e,{scroll:!1})},180)}}),this.cm.on("cursorActivity",function(a,c){if(b.inSourceMode&&(File.isFocusMode&&d.updateFocusMode(!0),File.isTypeWriterMode)){var e=a.cursorCoords(!0,"window"),f=e.top-(u+e.bottom-e.top)/2;Math.abs(f)>2&&a.scrollTo(null,a.getScrollInfo().top+f)}}),this.cm.display.scroller.addEventListener("wheel",function(a){Math.abs(a.deltaY)<4||File.isFocusMode&&File.isTypeWriterMode&&d.updateFocusMode(!1)})}},t.prototype.show=function(){File.sync();var a=this.editor.getMarkdown();try{s=B.call(this)}catch(b){s=null,console.warn(b.stack)}this.editor.cleanTooltip(),this.editor.searchPanel.closePanel(),this.inSourceMode=!0,k("body").addClass("typora-sourceview-on"),this.renderedHTML="",this.prep(),this.cm.setValue(a,"begin"),r=!1,q.show(),C.call(this),this.cm.refresh(),this.cm.focus(),this.cm.getDoc().clearHistory(),this.cm.options.readOnly=File.isLocked,this.enableTypeWriterMode(File.isTypeWriterMode),this.scrollAdjust()};var u;t.prototype.enableTypeWriterMode=function(a){if(a){var b=this.cm.defaultTextHeight();u=document.querySelector("content").clientHeight,this.cm.display.lineSpace.parentNode.style.paddingTop=(u-b)/2+"px",this.cm.display.lineSpace.parentNode.style.paddingBottom=(u-b)/2+"px"}else this.cm.display.lineSpace.parentNode.style.paddingTop="",this.cm.display.lineSpace.parentNode.style.paddingBottom=""},t.prototype.setValue=function(a,b,c){this.cm&&(this.cm.setValue(a,c||"begin"),b&&(r=!0))},t.prototype.onSave=function(){if(this.cm.doc.history.lastModTime=0,r){var a=this.cm.getScrollInfo().top;File.reloadContent(this.cm.getValue(),!1,!0,!1,!0),this.cm.scrollTo(0,a)}},t.prototype.hide=function(){var a=this.editor;k("body").removeClass("typora-sourceview-on"),this.inSourceMode=!1,s=this.cm.getCursor(),s.lineText=this.cm.getLine(s.line),h(),r&&(File.isMac&&!app.document.isDocumentEdited()&&this.renderedHTML?(k(File.editor.sessionStr).html(this.renderedHTML),setTimeout(function(){File.editor.refresh()},500)):File.reloadContent(this.cm.getValue().replace(/\r/gi,""),!1,!0,!1,!0)),q.hide(),z.call(this),a.selection.scrollAdjust()},t.prototype.scrollAdjust=function(){if(!File.isTypeWriterMode){var a=this.cm.charCoords(this.cm.getCursor(),"local").top,b=this.cm.getScrollerElement().offsetHeight/2;this.cm.scrollTo(null,a-b-5)}};var v=/\[/,w=/\]/,x=function(a,b,c){function d(a,b,c){return void 0===c&&(c=b?s.lineText.indexOf(a):s.lineText.lastIndexOf(a),c=0>c?0:c),Math.max(0,s.ch-c)}var e=null;switch(b.get("type")){case p.line:case p.heading:a.undo.exeCommand({type:"cursor",id:b.cid,start:d(b.get("text"))});break;case p.hr:case p.toc:b.get("after")?a.selection.jumpIntoElemBegin(a.findElemById(b.get("after").getVeryFirst().cid)):a.selection.selectNode(b);break;case p.math_block:e=a.mathBlock.startEditing(b.cid,!0),c--;break;case p.fences:(b.get("pattern")||"```").match(/`/)&&c--,e=a.fences.getCm(b.cid);break;case p.def_link:case p.def_footnote:if(s.inRef)a.undo.exeCommand({type:"cursor",id:b.cid,start:d(b.get("ref"),!0)});else{var f=new RegExp("(]:\\s*)"+m.escapeRegExp(b.get("href")||b.get("text"))).exec(s.lineText),g=f?f.index+f[1].length:0;a.undo.exeCommand({type:"cursor",id:b.cid,start:b.get("ref").length+d(void 0,void 0,g)})}break;case p.meta_block:for(var h=b.get("text").split(/\n/),g=s.ch,j=0;c-1>j;j++)g+=(h[j]||"").length+1;a.undo.exeCommand({type:"cursor",id:b.cid,start:g});break;case p.table_row:i(),a.undo.exeCommand({type:"cursor",id:b.getNthChild(Math.max(0,s.cellsBefore-1)).cid,start:s.cellsOffset});break;default:a.selection.jumpIntoElemEnd(a.findElemById(b.getVeryFirst(!0).cid))}e&&(e.focus(),c>=e.lineCount()?e.execCommand("goDocEnd"):e.setCursor({line:c,ch:d(e.getLine(c))}))},y=function(a,b,c){var d=0;for(c+(b.get("ahead")||0)>s.line&&a.selection.jumpIntoElemBegin(a.findElemById(b.getVeryFirst().cid)),d=f(b);b.get("after")&&c+d<=s.line;)c+=d,b=b.get("after"),d=f(b);b.get("children").length&&!o.isType(b,p.table_row)?y(a,b.getFirstChild(),c+(b.get("ahead")||0)):c+d-e(b)>s.line?x(a,b,s.line-c-(b.get("ahead")||0)):a.selection.jumpIntoElemEnd(a.findElemById(b.getVeryFirst(!0).cid))},z=function(){var a=this.editor;try{y(a,a.nodeMap.getFirst(),0)}catch(b){console.error(b.stack)}a.refocus()},A=function(a){return a.get("after")?!1:a.get("parent")?A(a.get("parent")):!0},B=function(){if(this.editor.focusCid){var a=this.editor.findElemById(this.editor.focusCid),b=this.editor.getNode(this.editor.focusCid),c=0,d="",e="",f=this.editor.selection.getRangy();if(b){if(c=A(b)?-1:g(b)+(b.get("ahead")||0),o.isType(b,p.fences)){var h=!/`|~/.exec(b.get("pattern")||"```");return!h&&c++,s=document.activeElement.classList.contains("mode")?{line:-1,before:b.get("pattern")||"```"}:this.editor.fences.getCm(b.cid).doc.getCursor(),s.before=(h?b.get("pattern"):"")+this.editor.fences.getCm(b.cid).getLine(s.line).substring(0,s.ch),s.line=s.line+c,s.ch=void 0,s}if(o.isType(b,p.math_block))return this.editor.mathBlock.currentCm?(s=this.editor.mathBlock.currentCm.doc.getCursor(),s.line=s.line+c+1,s):{line:c,ch:-1};if(o.isType(b,p.toc))return{line:c,before:"]"};if(o.isType(b,p.hr))return{line:c,before:this.get("pattern")||"------"};if(o.isType(b,p.def_link,p.def_footnote)){var i,j=this.editor.getJQueryElem(f.startContainer);if(i=j.closest(".md-def-content"),i.length)return f.setStartBefore(i[0]),d="]: "+f.toString(),{line:c,before:d};if(i=j.closest(".md-def-title"),i.length&&j.text().length)return f.setStartBefore(i[0]),d='"'+f.toString(),{line:c,before:d}}if(o.isType(b,p.table,p.table_row))return{line:c,ch:-1};if(f.setStartBefore(a[0]),d=f.toString().replace(/(\u200B*):(\u200B*)/g,":").replace(/\200B\$/,"$"),o.isType(b,p.table_cell)){for(e="",b=b.get("before");b;)e="\\|[^|]*"+e,b=b.get("before");return d=e+"\\|\\s*"+m.escapeRegExp(d),
{line:c,beforeRegExp:d}}return o.isType(b,p.meta_block)&&(d=d.replace(/^---/gm,"​---").replace(/\n$/g,""),c=(d.match(/\n/g)||[]).length+1,d=d.substring(d.lastIndexOf("\\n"))),{line:c,before:d}}}},C=function(){if(s)try{var a=s.ch;if(s.line<0&&(s.line=this.cm.doc.lineCount()-1),void 0===a){var b=this.cm.doc.getLine(s.line);if(s.before)a=b.indexOf(s.before)+s.before.length;else if(s.beforeRegExp){var c=new RegExp(s.beforeRegExp,"g");c.exec(b),a=c.lastIndex}}this.cm.doc.setCursor({line:s.line,ch:0>a?0:a}),0>a&&this.cm.execCommand("goLineEnd")}catch(d){console.error(d.stack)}};c.exports=t}),define("codemirror/addon/selection/active-line.js",[],function(a,b,c){"use strict";function d(a){for(var b=0;b<a.state.activeLines.length;b++)a.removeLineClass(a.state.activeLines[b],"wrap",i),a.removeLineClass(a.state.activeLines[b],"background",j)}function e(a,b){if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!=b[c])return!1;return!0}function f(a,b){for(var c=[],f=0;f<b.length;f++){var g=b[f];if(g.empty()){var h=a.getLineHandleVisualStart(g.head.line);c[c.length-1]!=h&&c.push(h)}}e(a.state.activeLines,c)||a.operation(function(){d(a);for(var b=0;b<c.length;b++)a.addLineClass(c[b],"wrap",i),a.addLineClass(c[b],"background",j);a.state.activeLines=c})}function g(a,b){f(a,b.ranges)}var h=a("codemirror/lib/codemirror"),i="CodeMirror-activeline",j="CodeMirror-activeline-background";h.defineOption("styleActiveLine",!1,function(a,b,c){var e=c&&c!=h.Init;b&&!e?(a.state.activeLines=[],f(a,a.listSelections()),a.on("beforeSelectionChange",g)):!b&&e&&(a.off("beforeSelectionChange",g),d(a),delete a.state.activeLines)})}),define("codemirror/addon/edit/visiblespace.js",[],function(a,b,c){"use strict";var d=a("codemirror/lib/codemirror");d.defineOption("visibleSpace",!1,function(a,b,c){c==d.Init&&(c=!1),c&&!b?a.removeOverlay("visiblespace"):!c&&b&&a.addOverlay({token:function(a,b){if(b.atBlockStart&&a.pos<b.atBlockStart)return a.eat(" ")?"startspace startspace-"+(a.pos-1):a.eat("	")?"starttab startspace-"+(a.pos-1):(a.pos++,null);var c=/(^[ \t]+)|(\s+$)/.exec(a.string),d=a.string.length,e=c&&c[1]?c[1].length:-1;c&&c[2]?d-c[2].length:d;return e>0&&e>a.pos?(a.pos++,"startspace-"+(a.pos-1)+("	"==a.string.charAt(a.pos-1)?" starttab":" startspace")):(a.pos=d,null)},name:"visiblespace"})})}),define("app/editor/QuickOpenPanel",["jquery/jquery","app/document/StringUtils","app/editor/KeyMaster"],function(a,b,c){"use strict";function d(a){if(v.length){H=-1==H?0:(H+a)%v.length,l(".typora-quick-open-item.active").removeClass("active"),l(".typora-quick-open-item[data-index='"+H+"']").addClass("active");var b=H*A,c=s.scrollTop();(c>b||b>c+A*B-10)&&s.scrollTop(Math.min(b,(v.length-B)*A))}}function e(a){function b(a,b,c){var d=/[^\\\/]+$/.exec(a),e=d[0],g=a.substring(0,d.index);z.length&&(e=m.escape(e).replace(new RegExp("(("+z.join(")|(")+"))","gi"),"<b>$1</b>")),b.append(q.find(".typora-quick-open-item-title").html(e).end().find(".typora-quick-open-item-path").text(f(g)).end().clone().attr("data-original",a).attr("data-index",c+"").addClass(H==c?"active":""))}function c(a,b){b.append(r.clone().find(".typora-quick-open-info").text(a?"Gathering more results":"Searching").end())}function d(a){if(!(0>a)){var d=l("<div>").css("position","absolute").css("top",a*e*40+"px").css("width","100%"),f=v.length;k=Math.min(f+F,a*e+e);for(var g=a*e;k>g;g++)g==f?c(f,d):b(v[g],d,g);t.append(d)}}var e=20,g=s.scrollTop(),h=Math.floor(g/40),i=Math.floor(h/e);i!=C&&(C=i,d(C-1),d(C),d(C+1))}function f(a){return a=a.replace(E,"~"),a.length>60?a.substring(0,30)+"..."+a.substring(a.length-30,a.length):a}function g(){C=-1,t.html("").height(A*(v.length+F)),e()}function h(a){z=a.split(/\s+/).filter(m.isNotNullOrEmpty).map(function(a){return a.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace("*",".*")});var b=[],c=z.map(function(a){return new RegExp("(.)?"+a+"(.)?","i")}),d=[];z.length?(w.forEach(function(a){for(var d,e=0,f=0;f<c.length;f++){if(d=i(a.n,c[f]),!d)return;e+=d}a.s=e,b.push(a)}),b.sort(function(a,b){var c=b.s-a.s;return c?c:b.d-a.d}),b=x.filter(function(a){for(var b=0;b<c.length;b++)if(!i(a.n,c[b]))return!1;return!0}).concat(b)):b=w.clone().concat(x),b.forEach(function(a){-1==d.indexOf(a.p)&&d.push(a.p)}),this.initResult(d)}function i(a,b){a=m.removeDiacritics(a);var c=b.exec(a);return c?(c[1]=c[1]||"",c[3]=c[3]||"",4-c[1].length-(/\w/.test(c[1])?1:0)-(/\w/.test(c[3])?1:0)):0}function j(a){D=(v[H]||{}).p,G&&(this.setSearchState(1),File.isMac&&app.quickOpen.query(a)),h.call(this,a),File.isMac&&app.quickOpen.reindexFolderIfNeeded()}var k,l=a("jquery/jquery"),m=a("app/document/StringUtils"),n=a("app/editor/KeyMaster"),o=n.map,p=function(a){this.editor=a},q=l(l("#typora-quick-open-item-templ").html()),r=l(l("#typora-quick-loading-item-templ").html()),s=l(".typora-quick-open-list"),t=l(".typora-quick-open-list-inner"),u=l("#typora-quick-open-input input"),v=[],w=[],x=[],y="",z=[],A=40,B=5,C=-1,D=null,E=window.app&&new RegExp("^"+m.escapeRegExp(app.path.home)),F=0,G=!0,H=-1;p.prototype.init=function(){var a=this;u.on("input",function(){var b=l(this).val();b!=y&&(v=[],y=b.replace(/[()'"%\\\/.?]/," "),j.call(a,y))}).on("keydown",function(b){var c=b.keyCode||b.which;if("Esc"==o[c]||"o"==o[c]&&b.shiftKey&&b.metaKey)return a.close(),!1;if("Tab"==o[c])return!1;if("Up"==o[c])return d(-1),!1;if("Down"==o[c])return d(1),!1;if("Enter"==o[c]&&File.isMac&&l(".typora-quick-open-item.active").length)return app.path.openURL(v[H],void 0,!0),!1;if(File.isMac&&b.ctrlKey&&!b.metaKey&&!b.shiftKey){if("P"==String.fromCharCode(c))return d(-1),!1;if("N"==String.fromCharCode(c))return d(1),!1}b.stopPropagation()}).on("blur",function(){setTimeout(a.close,200)}),s.on("mousedown",".typora-quick-open-item",function(){File.isMac&&app.path.openURL(this.getAttribute("data-original"),void 0,!0)}).on("scroll",e),File.isMac&&app.quickOpen.cacheRecentFiles()},p.prototype.show=function(){var a=l("#typora-quick-open:not(:visible)").show();a.length&&(l("content").css("overflowY","hidden"),u[0].select(),H=-1,j.call(this,""))},p.prototype.close=function(){l("#typora-quick-open:visible").hide().length&&(l("content").css("overflowY",""),File.isMac&&app.quickOpen.stopQuery()),H=-1},p.prototype.updateResult=function(a){a=a.filter(function(a){return-1==v.indexOf(a)}),a.length&&(v=v.concat(a),File.isMac&&v.remove(app.document.currentFilePath()),g.call(this))},p.prototype.initResult=function(a){H=D?v.indexOf(D):a.length?0:-1,v=a,File.isMac&&v.remove(app.document.currentFilePath()),g.call(this)},p.prototype.initFileCache=function(a,b,c,d,e){w=a.map(function(a,d){return{n:b[d],p:a,d:c[d]}}),x=e.map(function(a){return{n:(/[^\\\/]+$/.exec(a)||[])[0]||"",p:a}}),G=d>a.length},p.prototype.setRecentFiles=function(a){x=a.map(function(a){return{n:(/[^\\\/]+$/.exec(a)||[])[0]||"",p:a}})},p.prototype.setSearchState=function(a){F!==a&&(a&&k==v.length?(l(".typora-quick-open-item:last").after(r.clone().find(".typora-quick-open-info").text(k?"Gathering more results":"Searching").end()),k++):a||(l(".typora-quick-open-info-item").remove().length&&t.height(t.height()-40),k==v.length+1&&k--),F=a)},c.exports=p}),define("app/window/Library",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/window/FileHelper","app/editor/EditHelper","app/window/FileInfoPanel","app/window/FileHelper","app/editor/KeyMaster"],function(a,b,c){"use strict";function d(a){return a==this.root?a.path==z?"fa fa-history":"fa fa-folder-o":a.isDirectory?"fa fa-folder":"fa fa-file-text-o"}var e,f,g,h=a("app/document/StringUtils"),i=a("exoskeleton-master/exoskeleton"),j=a("app/document/Node"),k=(j.Node,j.TYPE,a("app/window/FileHelper")),l=a("app/window/FileInfoPanel"),h=a("app/document/StringUtils"),m=a("app/editor/KeyMaster"),n=m.map,o=a("jquery/jquery"),p=window.reqnode?reqnode("electron").remote:null,q=p?p.app:window.app,r=p&&p.getCurrentWindow();window.onWindowFocus=function(a){console.debug("onWindowFocus");try{!a&&File.isNode&&File.getCurrentDocByNode().setActiveWindow(r),File.restoreEditStateFromData(File.getDocumentSnap(),e||!0),File.isMac?File.bindMenu():File.freshMenu(!0),File.editor.imgEdit.refreshLocalImg(),File.isNode&&(File.filePath&&!reqnode("fs-plus").isFileSync(File.filePath)&&l.onPresentationMoved(),File.editor.library.root&&File.editor.library.root.path&&(console.debug("check root change"),reqnode("fs-plus").isDirectorySync(File.editor.library.root.path)||File.editor.library.onRootChanged()))}catch(b){console.error(b)}},window.onWindowBlur=function(){try{e=File.editor.sourceView&&File.editor.sourceView.inSourceMode?!0:File.editor.selection.buildUndo()||!0,File.isMac?window.File.isLocked=!0:document.body.classList.remove("mouse-entered"),File.backupDocumentSnap()}catch(a){console.error(a)}};var s,t=JSON.parse('{"path":"\\/Users\\/abner\\/Sites\\/typewiki","fetched":true,"content":[{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/CNAME","fetched":false,"content":[],"isDirectory":false,"name":"CNAME","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/README.md","fetched":false,"content":[],"isDirectory":false,"name":"README.md","subdir":[]}],"isDirectory":true,"name":"typewiki","subdir":[{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_drafts","fetched":false,"content":[],"isDirectory":true,"name":"_drafts","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_layouts","fetched":true,"content":[],"isDirectory":true,"name":"_layouts","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts","fetched":true,"content":[{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-01-01-Markdown Reference.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-01-01-Markdown Reference.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-05-02-Install and Use Pandoc.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-05-02-Install and Use Pandoc.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-06-06-Auto Numbering.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-06-06-Auto Numbering.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-06-22-Code Block Styles.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-06-22-Code Block Styles.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-06-22-Custom Font.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-06-22-Custom Font.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-06-24-Backgound.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-06-24-Backgound.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-06-25-Add Custom CSS.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-06-25-Add Custom CSS.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-06-25-Sublime.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-06-25-Sublime.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-06-25-TOC levels.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-06-25-TOC levels.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-06-26-Code Fences Language Support.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-06-26-Code Fences Language Support.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-06-26-Use Typora From Shell or cmd.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-06-26-Use Typora From Shell or cmd.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-07-17-Change Styles in Focus Mode.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-07-17-Change Styles in Focus Mode.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-07-24-Use MacType on Windows.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-07-24-Use MacType on Windows.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-08-14-Custom Key Binding.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-08-14-Custom Key Binding.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-08-15-Add Search Service.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-08-15-Add Search Service.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-08-15-Draw Diagrams With Markdown.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-08-15-Draw Diagrams With Markdown.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-09-26-About Themes.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-09-26-About Themes.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-09-26-Typora on Linux.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-09-26-Typora on Linux.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-10-19-Resize Image.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-10-19-Resize Image.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-10-26-Auto Save.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-10-26-Auto Save.md","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_posts\\/2016-11-11-Images.md","fetched":false,"content":[],"isDirectory":false,"name":"2016-11-11-Images.md","subdir":[]}],"isDirectory":true,"name":"_posts","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site","fetched":true,"content":[{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/CNAME","fetched":false,"content":[],"isDirectory":false,"name":"CNAME","subdir":[]}],"isDirectory":true,"name":"_site","subdir":[{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/About-Themes","fetched":false,"content":[],"isDirectory":true,"name":"About-Themes","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Add-Custom-CSS","fetched":false,"content":[],"isDirectory":true,"name":"Add-Custom-CSS","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Add-Search-Service","fetched":false,"content":[],"isDirectory":true,"name":"Add-Search-Service","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/assets","fetched":false,"content":[],"isDirectory":true,"name":"assets","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Auto-Numbering","fetched":false,"content":[],"isDirectory":true,"name":"Auto-Numbering","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Auto-Save","fetched":false,"content":[],"isDirectory":true,"name":"Auto-Save","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Backgound","fetched":false,"content":[],"isDirectory":true,"name":"Backgound","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Change-Styles-in-Focus-Mode","fetched":false,"content":[],"isDirectory":true,"name":"Change-Styles-in-Focus-Mode","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Code-Block-Styles","fetched":false,"content":[],"isDirectory":true,"name":"Code-Block-Styles","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Code-Fences-Language-Support","fetched":false,"content":[],"isDirectory":true,"name":"Code-Fences-Language-Support","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Custom-Font","fetched":false,"content":[],"isDirectory":true,"name":"Custom-Font","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Custom-Key-Binding","fetched":false,"content":[],"isDirectory":true,"name":"Custom-Key-Binding","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Draw-Diagrams-With-Markdown","fetched":false,"content":[],"isDirectory":true,"name":"Draw-Diagrams-With-Markdown","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Images","fetched":false,"content":[],"isDirectory":true,"name":"Images","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Install-and-Use-Pandoc","fetched":false,"content":[],"isDirectory":true,"name":"Install-and-Use-Pandoc","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Markdown-Reference","fetched":false,"content":[],"isDirectory":true,"name":"Markdown-Reference","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/media","fetched":false,"content":[],"isDirectory":true,"name":"media","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Resize-Image","fetched":false,"content":[],"isDirectory":true,"name":"Resize-Image","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/style","fetched":false,"content":[],"isDirectory":true,"name":"style","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Sublime","fetched":false,"content":[],"isDirectory":true,"name":"Sublime","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/TOC-levels","fetched":false,"content":[],"isDirectory":true,"name":"TOC-levels","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Typora-on-Linux","fetched":false,"content":[],"isDirectory":true,"name":"Typora-on-Linux","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Use-MacType-on-Windows","fetched":false,"content":[],"isDirectory":true,"name":"Use-MacType-on-Windows","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/_site\\/Use-Typora-From-Shell-or-cmd","fetched":false,"content":[],"isDirectory":true,"name":"Use-Typora-From-Shell-or-cmd","subdir":[]}]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/assets","fetched":true,"content":[],"isDirectory":true,"name":"assets","subdir":[{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/assets\\/css","fetched":false,"content":[],"isDirectory":true,"name":"css","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/assets\\/img","fetched":false,"content":[],"isDirectory":true,"name":"img","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/assets\\/js","fetched":false,"content":[],"isDirectory":true,"name":"js","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/assets\\/less","fetched":false,"content":[],"isDirectory":true,"name":"less","subdir":[]}]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media","fetched":true,"content":[],"isDirectory":true,"name":"media","subdir":[{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/about-image","fetched":false,"content":[],"isDirectory":true,"name":"about-image","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/about-themes","fetched":false,"content":[],"isDirectory":true,"name":"about-themes","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/add-custom-css","fetched":false,"content":[],"isDirectory":true,"name":"add-custom-css","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/add-search-service","fetched":false,"content":[],"isDirectory":true,"name":"add-search-service","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/auto-numbering","fetched":false,"content":[],"isDirectory":true,"name":"auto-numbering","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/auto-save","fetched":false,"content":[],"isDirectory":true,"name":"auto-save","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/background","fetched":false,"content":[],"isDirectory":true,"name":"background","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/code-block-style","fetched":false,"content":[],"isDirectory":true,"name":"code-block-style","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/custom-font","fetched":false,"content":[],"isDirectory":true,"name":"custom-font","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/custom-key-binding","fetched":false,"content":[],"isDirectory":true,"name":"custom-key-binding","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/diagrams","fetched":false,"content":[],"isDirectory":true,"name":"diagrams","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/pandoc","fetched":false,"content":[],"isDirectory":true,"name":"pandoc","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/thumbnails","fetched":false,"content":[],"isDirectory":true,"name":"thumbnails","subdir":[]},{"path":"\\/Users\\/abner\\/Sites\\/typewiki\\/media\\/typora-linux","fetched":false,"content":[],"isDirectory":true,"name":"typora-linux","subdir":[]}]}]}'),u=o(".sidebar-content"),v=!1,w=o(".sidebar-mac-tab"),x=!1,y=function(){u.on("wheel",function(a){var b=u.scrollTop(),c=a.originalEvent.deltaY,d=w[0].offsetHeight;d?c>0&&(u.removeClass("show-mac-tab"),v=!1):0>c&&!v&&(b>0?(v=!0,s&&clearTimeout(s),s=setTimeout(function(){v=!1,s=null},1e3)):-20>c&&!v&&(u.addClass("show-mac-tab"),s&&clearTimeout(s),v=!1))})},z="_recent",A=function(a){File.option.autoSave,k.tryLeaveDocument(function(b){if(!b&&a&&a.toLowerCase()!=(File.filePath||"").toLowerCase()){var c,d=p.getCurrentWindow();q.getDocumentController();File.contentSnapRestoredTime=-1,File.buildDocumentSnap(),c=q.getDocumentController().switchDocument(d.id,a),c.snap?(l.setFileTitle(a,c.snap.fileEncode),File.onSwitchDocumentTarget(c.snap)):File.onSwitchDocumentTarget()}})},B=i.Model.extend({initialize:function(a){this.editor=a,this.root,this.$template=o(document.querySelector("#file-library-node-template").textContent),this.fsWatcher},openFile:function(a){a&&(File.isMac?q.controller.switchDocumentTarget(a):(o(".megamenu-menu-header").trigger("click"),A(a)))},openFileInNewWindow:function(a){a&&(File.isMac?q.app.openInTypora(a,!0):p.app.openFile(a))},findElemFromPath:function(a){return o(".file-library-node[data-path='"+JSON.stringify(a).replace(/(^")|("$)/g,"")+"']")},findNodeFromPath:function(a,b){function c(a,d){if(a.path==d)return a;b.push(a);for(var e=0;e<a.subdir.length;e++){var f=a.subdir[e];if(f.path==d)return f;if(0==d.indexOf(f.path+(File.isWin?"\\":"/")))return c(f,d)}return a.content.find(function(a){return a.path==d})}if(a){File.isWin;return b=b||[],c(this.root,a)}},fetchFileTree:function(a,b){function c(a,b,d){var e=reqnode("fs-plus"),h=reqnode("path");return a.fetched=!0,a.subdir=[],a.content=[],a.isDirectory=void 0===a.isDirectory?!0:a.isDirectory,a.name=h.basename(a.path),b.forEach(function(b){/\/\.[^.\/]+$/.exec(b)||/\/node_modules\/?$/.exec(b)||(e.isDirectorySync(b)?a.subdir.push(c({path:b,isDirectory:!0,fetched:!d},d?[]:e.listSync(b,f),!0)):a.content.push({path:b,isDirectory:!1,name:h.basename(b)}))}),a.isDirectory&&!File.isWin&&g.addFolderWatchByUnix(a),a}if(File.isMac){var d=q.library.listDocsUnder(a.path);if(!d)return null;var e=JSON.parse(d);return a.fetched=!0,a.subdir=e.subdir,a.subdir.forEach(function(a){a.fetched=!0}),a.content=e.content,a.isDirectory=e.isDirectory,a.name=e.name,a}var f=["","md","markdown","mmd","text","txt","mdown"],g=this;if(File.isNode){var h=reqnode("fs-plus");return b?(h.list(a.path,f,function(d,e){a=d?null:c(a,e,!1),b(a)}),null):c(a,h.listSync(a.path,f),!1)}return null},addFolderWatchByWin:function(a){function b(){g=[],e=null,File.filePath&&d.markOpenedFile(File.filePath)}function c(){e&&clearTimeout(e),e=setTimeout(b,100)}if(a){var d=this;this.fsWatcher&&(this.fsWatcher.close(),this.fsWatcher.removeAllListeners());var e,g=[];this.fsWatcher=reqnode("fs").watch(a,{persistent:!1,recursive:!0}),this.fsWatcher.on("change",function(b,e){if(!f){var i=reqnode("path").join(a,e);console.log(b+"  "+i),reqnode("fs").stat(i,function(a,e){var f,j,k=[];if(a){if("ENOENT"==a.code&&(f=d.findNodeFromPath(i,k))){var j=k.last();j.subdir.remove(f),j.content.remove(f),j.subdir.length+j.content.length==0?d.findElemFromPath(j.path).replaceWith(d.renderNode(j)):d.findElemFromPath(i).remove()}}else if("rename"==b){var l=h.pathByDeleteLastComponent(i);j=d.findNodeFromPath(l),j&&j.fetched&&-1==g.indexOf(j)&&(j=d.fetchFileTree(j),d.findElemFromPath(l).replaceWith(d.renderNode(j)),g.push(j),console.debug("fetch and render "+j.path))}c()})}})}},addFolderWatchByUnix:function(a){var b=this,c=reqnode("pathwatcher");c.watch(a.path,function(d){if(!f){if("change"==d){var e={};a.subdir.forEach(function(a){e[a.path]=a}),a.content.forEach(function(a){e[a.path]=a});for(var g=b.fetchFileTree(a,!1),h=0;h<g.subdir.length;h++){var i=e[g.subdir[h].path];i&&(g.subdir[h]=i)}for(var h=0;h<g.content.length;h++){var i=e[g.content[h].path];i&&(g.content[h]=i)}var j=b.findElemFromPath(a.path);j.length&&j.replaceWith(b.renderNode(a)),b.markOpenedFile(k.getCurrentFilePath())}"rename"==d&&a==b.root&&c.closeAllWatchers()}})},expandNode:function(a,b){var c=this.findNodeFromPath(b);c.isOpen=!0,a.children(".file-node-children").children().length?a.removeClass("file-node-collapsed").addClass("file-node-expanded"):(c.fetched?c.subdir.length>0&&!c.subdir[0].fetched&&this.fetchFileTree(c):this.fetchFileTree(c),a.replaceWith(this.renderNode(c))),o(".file-library-node.active").length||this.markOpenedFile(k.getCurrentFilePath())},bindEvents:function(){function a(a,c){var d=b.findNodeFromPath(c);d.isOpen=!1,a.addClass("file-node-collapsed").removeClass("file-node-expanded")}var b=this;o("#file-library-tree").on("click",".file-node-content",function(c){var d=o(this).parent(),e=d.attr("data-path"),f=d.attr("data-is-directory");if(d.hasClass("file-node-on-edit"))return!1;if("false"==f)c.ctrlKey||c.metaKey?b.openFileInNewWindow(e):b.openFile(e);else if("true"==d.attr("data-has-sub")){var g=d.hasClass("file-node-expanded");g?a(d,e):b.expandNode(d,e)}}),File.isNodeHtml||y.call(this),o("[name='sidepanel-segmented-input']").on("change",function(){b["switch"](this.value,!0)}),File.isNodeHtml&&(this.bindContext(),this.bindRenameInput())},bindRenameInput:function(){o("#file-library").on("mousedown click mouseup",".file-tree-rename-input",function(a){a.stopPropagation()}).on("keydown",".file-tree-rename-input",function(a){return"Enter"==n[a.keyCode||a.which]?(o(this).trigger("blurx"),!1):void 0})},refocusToWriter:function(){o("#write").focus();try{g&&this.editor.undo.exeCommand(g)}catch(a){}},bindContext:function(){function a(a){if(b=this,this==document.querySelector("#file-library")){if(a.target!=this||!File.editor.library.root)return!1;b=c.findElemFromPath(File.editor.library.root.path)[0],o("#file-menu").children("li").hide().end().find('[data-action="new_file"],[data-action="new_folder"]').show()}else o("#file-menu li").show();File.sync(),g=c.editor.selection.buildUndo(),o("#write").blur(),o(".context-menu").removeClass("show").find(".active").removeClass("active");var d=o(b).closest(".file-library-node").focus(),e=o("#file-menu").addClass("show");d.attr("data-path")==(File.editor.library.root||{}).path?e.find("[for-file]").hide():"true"==d.attr("data-is-directory")?e.find("[for-file]:not([for-folder])").hide():e.find("[for-folder]:not([for-file])").hide();var f=e.height()+48,h=a.clientX>window.innerWidth-220?window.innerWidth-220:a.clientX,i=a.clientY>window.innerHeight-f?window.innerHeight-f:a.clientY-o("#top-titlebar").height()+8;return e.css({top:i+"px",left:h+"px"}),d.one("blur",function(){document.activeElement&&document.activeElement.classList.contains("file-node-content")||o(".context-menu").removeClass("show")}),!1}var b,c=this;o("#file-menu").on("mousedown","[data-key]",function(){var a=this.getAttribute("data-action");if(a){switch(o(".context-menu").removeClass("show").find(".active").removeClass("active"),a){case"open":c.openFileCommand(b);break;case"open_in_new_window":c.openFileInNewWindowCommand(b);break;case"new_file":return c.newFileCommand(b),!1;case"new_folder":return c.newFolderCommand(b),!1;case"delete":c.deleteFileCommand(b);break;case"rename":return c.renameFileCommand(b),!1;case"copy_path":c.copyFullPathCommand(b);break;case"reveal":c.revealFileInFinderCommand(b);break;default:return}c.refocusToWriter()}}),o("#file-library").on("contextmenu",".file-node-content",a).on("contextmenu",a)},init:function(){File.isMac&&!q.document.currentFilePath()&&q.controller.mountFolder()&&this.show(),this.bindEvents()},"switch":function(a,b){"files"==a?(o("#outline-dropmenu").removeClass("active-tab-outline").addClass("active-tab-files"),!x&&this.render()):o("#outline-dropmenu").addClass("active-tab-outline").removeClass("active-tab-files"),File.isNode||o("files"==a?"#sidepanel-segmented-input-files":"#sidepanel-segmented-input-outline").prop("checked",!0)},calcMountFolder:function(){function a(a){var b=reqnode("path"),c=reqnode("fs"),d=a;if(!a)return null;for(;d&&/^\w*\/+\w/.exec(d);){var e=c.readdirSync(d);if(e.indexOf(".git")>-1||e.indexOf(".svn")>-1||e.indexOf(".hg")>-1||e.indexOf("package.json")>-1)return d;if(/((dropbox\/apps\/[^\/]+)|pages|articles?|blogs?|content)\/?$/i.exec(d))return d;if(/(_?posts?|_?drafts?)\/?$/i.exec(d))return d;if(/(node_modules)\/[^\/]+\/?$/i.exec(d))return d;var f=d;if(d=b.join(d,"../"),d==f)break}return a.replace(/[\/\\]$/,"")||null}if(File.isMac)return q.controller.mountFolder();if(File.isNode){if(!File.mountFolder){try{File.mountFolder=k.getCurrentFileFolderPath(),File.mountFolder=a(File.mountFolder)}catch(b){}File.mountFolder&&File.isWin&&this.addFolderWatchByWin(File.mountFolder)}return File.mountFolder}},fetchRecentFile:function(){File.isMac&&(this.root=JSON.parse(q.library.listRecent()),this.root.path=z,this.root.isOpen=!0,this.root.name="Recent Files")},show:function(){document.querySelector("#outline-dropmenu").classList.add("open"),document.body.classList.add("pin-outline"),this["switch"]("files"),this.render(),this.editor.docMenu.pinOutline=!0},render:function(){function a(){o("#file-library-tree").html("").append(this.renderNode(this.root)),this.markOpenedFile(k.getCurrentFilePath())}x=!0,this.root||(this.root={path:this.calcMountFolder(),isOpen:!0},this.root.path?this.fetchFileTree(this.root,File.isNode?function(b){this.root=b,b&&a.call(this)}.bind(this):void 0):(this.root=null,File.isMac?this.fetchRecentFile():File.isNode||(this.root=t,this.root.isOpen=!0))),this.root?File.isNode||a.call(this):o("#file-library-tree").html("")},markOpenedFile:function(a){a&&(o(".file-library-node.active").removeClass("active"),this.findElemFromPath(a).addClass("active"))},renderNode:function(a){if(!a)return o();var b=this.$template.clone();if(a==this.root?(a.isOpen=!0,b.find(".file-node-open-state").remove()):a.isDirectory&&a.subdir&&(a.subdir.length||a.content.length)&&b.attr("data-has-sub","true").addClass(a.isOpen?"file-node-expanded":"file-node-collapsed"),b.find(".file-node-title").text(a.name),b.attr("data-path",a.path).attr("data-is-directory",a.isDirectory),b.find(".file-node-icon").addClass(d.call(this,a)),a==this.root&&b.addClass("file-node-root"),a.isDirectory&&a.isOpen&&a.subdir){var c=b.find(".file-node-children");a.subdir.forEach(function(a){c.append(this.renderNode(a))},this),a.content.forEach(function(a){c.append(this.renderNode(a))},this)}return b},end:function(){x=!1,this.root=null,File.mountFolder=null,this.fsWatcher?(this.fsWatcher.close(),this.fsWatcher.removeAllListeners(),this.fsWatcher=null):File.isLinux&&reqnode("pathwatcher").closeAllWatchers()},onRootChanged:function(){this.end(),o("#file-library:visible").length&&this.render()},onFileChanges:function(a){function b(a){var b=m.findElemFromPath(a.path);b.length&&b.replaceWith(this.renderNode(a))}function c(a,c){a.isDirectory?c.subdir.remove(a):c.content.remove(a),c.subdir.length+c.content.length==0?(a.isOpen=!1,b.call(this,c)):m.findElemFromPath(a.path).remove()}function d(a,b,c){if(b.fetched&&!l.has(b)){var d;if(b.content.length+b.subdir.length==0&&l.add(b),c){if(b.subdir.findIndex(function(b){return b.path==a})>-1)return;d=this.fetchFileTree({path:a}),d&&b.subdir.push(d)}else{if(b.content.findIndex(function(b){return b.path==a})>-1)return;d={path:a,isDirectory:!1,name:a.split("/").last()},b.content.push(d)}j.add(b)}}function e(a,b){return a.path.localeCompare(b.path)}var f,g=JSON.parse(a),i=[],j=new Set,l=new Set,m=this;if(this.root){if(g.forEach(function(a){
if(f=this.findNodeFromPath(a.path,i),this.root)if("removed"==a.type)a.path==this.root.path?this.root=null:f&&i.length&&c.call(this,f,i.last());else if("created"==a.type&&!f&&f!=this.root){var b=h.pathByDeleteLastComponent(a.path),e=this.findNodeFromPath(b);e&&d.call(this,a.path,e,a.isDir)}},this),!this.root)return void this.onRootChanged();l.forEach(function(a){a=this.fetchFileTree(a),a&&b.call(this,a)},this),j.forEach(function(a){a.subdir.sort(e),a.content.sort(e),b.call(this,a)},this),this.markOpenedFile(k.getCurrentFilePath())}},openFileCommand:function(a){var b=this.editor.getJQueryElem(a).closest(".file-library-node").attr("data-path");this.openFile(b)},openFileInNewWindowCommand:function(a){var b=this.editor.getJQueryElem(a).closest(".file-library-node").attr("data-path");this.openFileInNewWindow(b)},copyFullPathCommand:function(a){var b=this.editor.getJQueryElem(a).closest(".file-library-node").attr("data-path");this.editor.UserOp.setClipboard("<span>"+b+"</span>",null,b,!0)},revealFileInFinderCommand:function(a){var b=this.editor.getJQueryElem(a).closest(".file-library-node").attr("data-path");File.isMac?q.path.showInFinder(b):p.shell.showItemInFolder(b)},renameFileCommand:function(a,b){function c(a){a.value=a.value.replace(/[\/\\]/g,""),p.dialog.showMessageBox(p.getCurrentWindow(),{buttons:["Yes","Cancel"],title:"Confirm Rename",message:'Rename to "'+a.value+'" ?'},function(b){0==b?d(a):(f.removeClass("file-node-on-edit"),r.refocusToWriter())})}function d(a){var b=a.value.replace(/[\/\\]/g,""),c=h.pathByDeleteLastComponent(g)+(File.isWin?"\\":"/")+b;o(a).closest(".file-node-on-edit").removeClass("file-node-on-edit");var d=File.filePath&&(reqnode("fs-plus").isCaseInsensitive?0==File.filePath.toLowerCase().indexOf(g.toLowerCase()):0==File.filePath.indexOf(g));console.debug("containsCurDoc "+d+", "+File.filePath+"  "+g),d&&l.watchFileChange(null),reqnode("fs").rename(g,c,function(a){if(f.removeClass("file-node-on-edit"),r.refocusToWriter(),a)p.dialog.showErrorBox("Error on Rename",'Failed to rename from "'+m+'" to "'+b+'"\n'+a),console.warn(a),d&&l.watchFileChange(File.filePath);else{if(console.debug("renamed"),!File.filePath)return;d&&(c+=File.filePath.substring(g.length),q.getDocumentController().getDocumentFromWindowId(p.getCurrentWindow().id).rename(c),l.setFileTitle(c),File.resumeFileChangeTimestamp=new Date,r.markOpenedFile(k.getCurrentFilePath()))}})}function e(a){var f=n.value;return f?("blurx"==a.type&&o(n).off("blur"),void(f!=m&&(b||"blurx"==a.type?d(n):c(n)))):(n.focus(),o(n).off("blur blurx").one("blur blurx",e),!1)}o(".file-node-on-edit").removeClass("file-node-on-edit");var f=this.editor.getJQueryElem(a).closest(".file-library-node").addClass("file-node-on-edit"),g=f.attr("data-path"),i="true"==f.attr("data-is-directory"),j=f.children(".file-node-content").children(".file-tree-rename-div"),m=j.prev().text(),n=j.children("input").val(m)[0],r=this;o(n).off("blur blurx").one("blur blurx",e).off("focus").on("focus",function(){if(n.select(),!i){var a=m.lastIndexOf(".");a>0&&n.setSelectionRange(0,a)}}),o(n).focus()},newFileCommand:function(a,b){function c(a,b){var c=0;return b?(a.subdir.forEach(function(a){var b=/^untitled folder( (\d+))?$/i.exec(a.name);b&&(c=Math.max(c,(b[2]||0)-0+1))}),"untitled folder"+(c?" "+c:"")):(a.content.forEach(function(a){var b=/^untitled( (\d+))?\./i.exec(a.name);b&&(c=Math.max(c,(b[2]||0)-0+1))}),"untitled"+(c?" "+c:"")+".md")}var d=this.editor.getJQueryElem(a).closest(".file-library-node"),e=d.attr("data-path"),g="true"==d.attr("data-is-directory");if(e){g||(e=h.pathByDeleteLastComponent(e));var i=this.findNodeFromPath(e);if(i)if(g&&this.expandNode(d,e),File.isMac)b?q.library.newFolderUnder(e):q.library.newFileUnder(e);else if(File.isNode){var j=reqnode("fs"),k=c(i,b);try{var l=this.findElemFromPath(e),m={fetched:!0,subdir:[],content:[],isDirectory:!!b,name:k,path:e+(File.isWin?"\\":"/")+k};b?(j.mkdirSync(e+"/"+k),f=!0,i.subdir.push(m)):(j.openSync(e+"/"+k,"wx"),f=!0,i.content.push(m)),l.replaceWith(this.renderNode(i)),this.renameFileCommand(this.findElemFromPath(m.path)[0]),setTimeout(function(){f=!1},200)}catch(n){}}}},newFolderCommand:function(a){this.newFileCommand(a,!0)},deleteFileCommand:function(a){var b=this.editor.getJQueryElem(a).closest(".file-library-node").hide().attr("data-path");File.isMac?q.library.trashItem(b):File.isNode&&p.shell.moveItemToTrash(b)}});c.exports=B}),define("app/window/ClientCommand",["app/document/File","exoskeleton-master/exoskeleton","jquery/jquery","app/editor/UndoManager","app/document/StringUtils","app/document/Node","app/editor/polyfill","app/window/FileHelper","app/editor/EditHelper","app/window/FileInfoPanel","app/editor/KeyMaster","app/window/FileHelper","app/window/PDFBridge","app/window/PandocBridge"],function(a,b,c){"use strict";var d=a("app/document/File");if(d.isNodeHtml){if(d.isNode)var e=reqnode("electron").remote,f=e.app,g=e.getCurrentWindow(),h=e.BrowserWindow;var i={},j=a("app/window/FileHelper"),k=a("app/window/PDFBridge"),l=a("app/editor/EditHelper"),m=a("app/window/PandocBridge");i.newFile=function(){$(".megamenu-menu-header").trigger("click"),f.openFile()},i.close=function(){$(".megamenu-menu-header").trigger("click"),g.close()},i.quit=function(){f.getAllWindows().map(function(a){a.close()})},i.openFileWithPath=function(a){var b=f.getDocumentController().getDocument(a);b?(b.activeWindow||b.windows.keys().next().value).focus():d.fileHasModified||d.filePath?f.openFile(a):n(a)};var n=function(a){f.getDocumentController().getDocument(a)||(f.getDocumentController().getDocumentFromWindowId(g.id).rename(a),d.reloadContent(d.getContent(),!0),d.updateChangeCount(d.ChangeType.NSChangeCleared))};i.open=function(){var a=e.dialog;a.showOpenDialog(g,{properties:["openFile"],filters:[{name:"Markdown",extensions:["md","markdown","text","txt","mmd","mdown"]}]},function(a){a&&a.length&&(i.openFileWithPath(a[0]),$(".megamenu-menu-header").trigger("click"))})},i["import"]=function(){$(".megamenu-menu-header").trigger("click"),m.prepImport()},i.validatePandocInstall=function(){return m.validatePandocInstall()},i.doImport=function(a){m["import"](a)},i.openFileLocation=function(){d.filePath&&e.shell.showItemInFolder(d.filePath)},i.save=function(){d.saveUseNode(!1)},i.saveAs=function(){d.saveUseNode(!1,!0)};var o=function(){p.webContents.print()};window.releasePrintWin_=function(){p&&(p.destroy(),p=null)},i.print=function(){q().webContents.on("did-finish-load",function(){setTimeout(o,300)}),document.body.classList.contains("megamenu-opened")&&$(".megamenu-menu-header").trigger("click")},i.exportHTML=function(){d.editor.store(!0),j.showExportDialog("html",d.editor["export"].exportToHTML(),null,null,!0),$(".megamenu-menu-header").trigger("click")},i.exportHTMLPlain=function(){d.editor.store(!0),j.showExportDialog("html",d.editor["export"].exportToHTML(!1,!0),null,null,!0),$(".megamenu-menu-header").trigger("click")},i.exportImage=function(){d.editor["export"].exportToImage(),$(".megamenu-menu-header").trigger("click")},i.exportDocx=function(){m["export"]("docx")},i.exportOdt=function(){m["export"]("odt")},i.exportRTF=function(){m["export"]("rtf")},i.exportEpub=function(){m["export"]("epub")},i.exportLaTeX=function(){m["export"]("latex")},i.exportWiki=function(){m["export"]("wiki")},i.exportRST=function(){m["export"]("rst")},i.exportOPML=function(){m["export"]("opml")},i.exportTextile=function(){m["export"]("textile")};var p,q=function(){var a=d.editor["export"].exportToHTML(!0),b=e.app.setting.config;return p&&(p.destroy(),p=null),p=new h({skipTaskbar:!0,title:"Print PDF Preview",show:!1,webPreferences:{webSecurity:!1,allowDisplayingInsecureContent:!0,allowRunningInsecureContent:!0,nodeIntegration:!1,directWrite:b.directWrite,defaultFontFamily:b.defaultFontFamily,zoomFactor:f.setting.get("zoomFactor")}}),$(".megamenu-menu-header").trigger("click"),p.loadURL("data:text/html;charset=UTF-8,  "+encodeURIComponent(a)),p},r=null;i.exportPDF=function(){function a(a){a&&alert("Failed to export to PDF file",a),p&&p.destroy(),p=null,r=null,a||$("#md-notification").hide()}if(d.colorBrightness<.5){var b=e.dialog,c=b.showMessageBox(g,{type:"warning",title:"Dark Theme not support",message:'Sorry, current version of Typora won\'t print background color on exported PDF, So dark theme is not yet supported for PDF exproting. \nPlease choose a light theme or click "Print with default theme"',buttons:["Cancel","Print with default theme"],cancelId:0});if(1!==c)return}d.sync(),r=k.startPDFJob(q()),setTimeout(function(){r&&$("#md-notification").html(["<p>Exporting to PDF",'<div class="typora-search-spinner" style="margin-right:16px;top:8px">','<div class="rect1"></div>','<div class="rect2"></div>','<div class="rect3"></div>','<div class="rect4"></div>','<div class="rect5"></div>',"</div></p>"].join("\n")).show()},2e3),j.showExportDialog("pdf",function(b){b?r.then(function(c){d.fs.writeFile(b,c,function(c){c?a(c):($("#md-notification .typora-pdf-warning").length||l.showNotification("Export to PDF successfully."),e.shell.showItemInFolder(b))})},a):a()},void 0,void 0,!0)},i.selectAll=function(){d.editor.sourceView.inSourceMode||!$(document.activeElement).closest("#write").length?d.isNode&&g.webContents.selectAll():(d.editor.selection.selectAll(),d.editor.brush.expand())},i.undo=function(){d.isLocked||(editor.undo.completeSnap(!0),d.editor.undo.undo(),d.freshMenu())},i.redo=function(){d.isLocked||(editor.undo.completeSnap(!0),d.editor.undo.redo(),d.freshMenu())},i.toggleOutline=function(){document.querySelectorAll(".pin-outline .active-tab-outline").length?(document.body.classList.remove("pin-outline"),f.setting.put("show_outline","false")):(d.editor.docMenu.showOutline(!0),document.querySelectorAll(".active-tab-outline").length||$("#info-panel-tab-outline").trigger("click")),i.refreshViewMenu()},i.toggleFileInfo=function(){document.querySelectorAll(".pin-outline .active-tab-files").length?(document.body.classList.remove("pin-outline"),f.setting.put("show_outline","false")):(d.editor.docMenu.showOutline(!0),document.querySelectorAll(".active-tab-files").length||$("#info-panel-tab-file").trigger("click")),i.refreshViewMenu()},i.pinWindow=function(){g.setAlwaysOnTop(!0),document.body.classList.add("always-on-top"),i.refreshViewMenu()},i.execForAll=function(a){var b=a.toString(),c=arguments;b=b.replace(/\$(\d+)/gi,function(a,b){return b-0<c.length?c[b]:a}),console.log(b),reqnode("electron").ipcRenderer.send("execForAll",b)},i.unpinWindow=function(){g.setAlwaysOnTop(!1),document.body.classList.remove("always-on-top"),i.refreshViewMenu()},i.refreshViewMenu=function(){var a=e.Menu.getApplicationMenu().items[4].submenu,b=a.getItem("Show Outline Panel"),c=a.getItem("Show File Info Panel"),g=a.getItem("Show Status Bar"),h=(a.getItem("Source Code Mode"),a.getItem("Focus Mode")),i=a.getItem("Typewriter Mode"),j=a.getItem("Always On Top"),k=a.getItem("Actual Size");b.checked=!1,c.checked=!1,g.checked=!1,j.checked=!1,document.body.classList.contains("pin-outline")&&(document.querySelectorAll(".active-tab-files").length?c.checked=!0:b.checked=!0),document.body.classList.contains("show-footer")&&(g.checked=!0),document.body.classList.contains("always-on-top")&&(j.checked=!0),d.editor.sourceView.inSourceMode?(b.checked=!1,c.checked=!1,b.enabled=!1,c.enabled=!1):(b.enabled=!0,c.enabled=!0),k.checked=!f.setting.get("customZoom"),h.checked=d.isFocusMode,i.checked=d.isTypeWriterMode};var s=function(a){"string"==typeof a&&(d._CopyContentFlag=a),g.webContents.copy()},t=function(a){"string"==typeof a&&(d._PasteContentFlag=a),g.webContents.paste()};i.cut=function(){g.webContents.cut()},i.copy=function(){s()},i.copyAsMarkdown=function(){s("copyAsMarkdown")},i.copyAsHTMLSource=function(){s("copyAsHTMLSource")},i.paste=function(){t("pasteAsPlain")},i.pasteAsPlain=function(){t("copyAsHTMLSource")},i.setTheme=function(a,b){console.log("set theme: "+a);var c=e.Menu.getApplicationMenu().getItem("Theme").submenu;c.items.map(function(a){a.checked=a.label==b}),f.setting.put("theme",a),i.execForAll("function(){            File.setTheme();        }")},i.resetZoom=function(){f.setting.put("customZoom",!1),f.setting.put("zoomFactor",1),d.resetZoom()},i.zoomIn=function(){f.setting.put("customZoom",!0);var a=reqnode("electron").webFrame,b=a.getZoomLevel()+1;a.setZoomLevel(b),f.setting.put("zoomLevel",b),f.setting.put("zoomFactor",a.getZoomFactor())},i.zoomOut=function(){f.setting.put("customZoom",!0);var a=reqnode("electron").webFrame,b=a.getZoomLevel()-1;a.setZoomLevel(b),f.setting.put("zoomLevel",b),f.setting.put("zoomFactor",a.getZoomFactor())},c.exports=i,window.ClientCommand=i}}),define("app/window/PDFBridge",["app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/window/FileHelper"],function(a,b,c){"use strict";function d(a,b,c,d){function e(a){d(a)}function f(a){console.error("failed to add book to exported PDF\n"+a.stack||a.details),$("#md-notification").html("<p class='typora-pdf-warning'>[Warning] failed to attach bookmark for PDF file.<span class='btn close-btn btn-xs'><span class='glyphicon glyphicon-remove'></span></span></p>").show(),c(b)}return a?void d(a):a?void d(a):(PDFJS.disableWorker=!0,void PDFJS.getDocument(b).then(h,e).then(function(a){console.debug("got anchor map");try{var d=new FileReader;d.onloadend=function(){c(new Buffer(new Uint8Array(d.result)))},d.onerror=d.onabort=f,d.readAsArrayBuffer(i(a,b))}catch(e){f(e)}},f))}function e(){return new Promise(function(a,b){var c=File.editor["export"].exportToHTML(!0),e=reqnode("html-pdf");e.create(c,{type:"pdf",format:"A4",border:{top:"2cm",bottom:"2cm"},phantomArgs:["--ignore-ssl-errors=true","--local-to-remote-url-access=true","--web-security=false"]}).toBuffer(function(c,e){d(c,e,a,b)})})}function f(a){return new Promise(function(b,c){a.webContents.once("did-finish-load",function(){setTimeout(function(){a.webContents.printToPDF({printBackground:!1,marginsType:0},function(a,e){d(a,e,b,c)})},200)})})}if(File.isNode){var g=reqnode("electron").remote;g.app,g.getCurrentWindow(),g.BrowserWindow,g.dialog,a("app/document/StringUtils"),a("app/editor/EditHelper"),a("app/window/FileHelper");a.async(window.debugMode?["pdf/pdf-designer.min.js","pdf/pdf.js"]:["lib.asar/pdf/pdf-designer.min.js","lib.asar/pdf/pdf.min.js"]);var h=function(a){return new Promise(function(b,c){function d(a){c(a)}var e=a.numPages,f={},g=0,h=0;console.debug("total PDF page number "+e),0==e&&c("Genrated PDF only have 0 page");for(var i=0;e>i;i++)a.getPage(i+1).then(function(a){a.getAnnotations().then(function(c){h||(h=a.getViewport(1).height),g++,c.forEach(function(b){if(b.subtype="Link"){var c;(c=/^af:\/\/(.+)$/.exec(b.url||""))&&(f[c[1]]=[a.pageIndex+1,h-b.rect[3]])}}),g>=e&&b(f)},d)},d)})},i=function(a,b){function c(b,d,g,h){for(var i=7,j=null,k=g;h>k;k++){var l,m=f[k],n=m[0];if(7==i&&(i=n),d>=n)return k;n>i?k=c(j,i,k,h)-1:(l=a[m[2]],j=b?b.AddChild(m[1],l[0],l[1],"",!1,!1,null):e.OutLine.AddRoot(m[1],l[0],l[1],"",!1,!1,null))}return h}var d=new TPDFAnalyst,e=new TPDFOutLineMaker,f=File.editor.docMenu.getHeaderMatrix(!0);return d.LoadFromStream(b),e.View.PageMode=TPDFPageMode.pmUseOutlines,c(null,0,0,f.length),e.Save(d)};b.startPDFJob=f,b.startPDFJobFromWebket=e}}),define("app/window/PandocBridge",["app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/window/FileHelper","app/window/FileInfoPanel","app/window/FileHelper","app/editor/KeyMaster"],function(a,b,c){"use strict";if(File.isNode){var d,e=reqnode("child_process").spawn,f=reqnode("electron").remote,g=f.app,h=f.getCurrentWindow(),i=(f.BrowserWindow,f.dialog),j=a("app/document/StringUtils"),k=a("app/editor/EditHelper"),l=a("app/window/FileHelper"),m=a("app/window/FileInfoPanel"),n="pandoc",o=null,p=function(a,b,c,d){q(),o=e(n,a,d);var f=[],g=[];return o.on("close",function(a){var d=Buffer.concat(f),e=Buffer.concat(g).toString();console.debug("close spawn"),b(c,d,e,a),o=null}),o.stdout.on("data",function(a){f.push(a)}),o.stderr.on("data",function(a){g.push(a)}),o},q=function(){o&&o.kill&&(o.removeAllListeners("close"),o.kill()),o=null},r=function(a){var b=g.setting.isPandocValid();if(a&&void 0!==b)return b;if(b)return!0;var c,b=!0,d=reqnode("child_process").spawnSync(n,["--version"]);if(d.error?b=!1:(d=d.stdout.toString("utf8").split(/\r|\n|\r\n/)[0],c=d.match(/[\d.]+/)[0],b=g.setting.compareVersion(c,"1.16")>=0),!b&&!a){var e=k.getDialog("Pandoc Required","Import or some export features requires <a href='http://pandoc.org/' target='_blank'>Pandoc</a> (≥ v1.16) to be installed.",!0,null,"Follow Instructions to Install/Update Pandoc").modal({backdrop:!1});e.find(".btn-primary").one("click",function(){var a=f.app;a.openFile(__dirname+"/Docs/Install and Use Pandoc.md"),e.modal("hide")})}return g.setting.setPandocValid(b),b},s={prepImport:function(){function a(a){c.webContents.executeJavaScript('window.getSelection().removeAllRanges();ClientCommand.doImport("'+j.escapeInQuote(a)+'")')}if(r()){var b=File.changeCounter.isDiscardableUntitled(),c=b?f.getCurrentWindow():g.openFile("",!0),d=b;c.webContents.once("did-finish-load",function(){d=!0}),i.showOpenDialog(h,{title:"Import File",properties:["openFile"],filters:[{name:"All Supported Formats",extensions:["docx","latex","tex","ltx","rst","rest","org","wiki","dokuwiki","textile","opml","epub"]},{name:"MS Word",extensions:["docx"]},{name:"TeX/LaTeX",extensions:["latex","tex","ltx"]},{name:"reStructuredText",extensions:["rst","rest"]},{name:"org-mode",extensions:["org"]},{name:"Wiki",extensions:["wiki","dokuwiki"]},{name:"Epub",extensions:["epub"]},{name:"Textile",extensions:["textile"]},{name:"OPML",extensions:["opml"]}]},function(e){if(e&&e.length){var f=e[0];if(b)return void a(f);c.show(),d?a(f):c.webContents.once("did-finish-load",function(){a(f)})}else c.close()})}},"import":function(a){File.lock(),File.blockUI=!0,d=$("#import-process-dialog"),o=p([a,"--wrap=none","--atx-headers","-t","markdown"],u,a),m.setFileTitle(null,null,l.getFileNameFromPath(a).replace(/\..+$/,"")),setTimeout(function(){o&&(d.modal({backdrop:"static",keyboard:!1}),d.find(".btn").one("click",function(){q(),h.close()}))},200)},"export":function(a){if(r()){$(".megamenu-menu-header").trigger("click"),File.sync();var b=[a];"latex"==a?b=["tex","latex"]:"wiki"==a?b=["wiki","txt"]:"rst"==a?b=["rst","text","rest","reStructuredText"]:"opml"==a?b=["opml","xml"]:"textile"==a&&(b=["textile"]);var c=(l.getCurrentFileFolderPath()||g.getPath("documents"))+"/"+File.getSuggestedFileName(!0)+(b?"."+b[0]:"");i.showSaveDialog(h,{title:"Export to...",defaultPath:c,filters:[{name:a,extensions:b},{name:"All Files",extensions:[]}]},function(b){if(b){File.blockUI=!0;var c=["-f","native","-s","-o",b,"-t",a];"wiki"==a&&(c.pop(),c.push("mediawiki"));var e=new Date;File.editor["export"].exportToNative(a,function(a){o=p(c,t,b,{stdio:"pipe"}),o.stdin.end(a,"utf8"),d=$("#export-process-dialog");var f=Math.max(500-new Date+e,0);setTimeout(function(){o&&(d.modal({backdrop:"static",keyboard:!1}),d.find(".btn").one("click",function(){File.blockUI=!1,q(),d.modal("hide")}))},f)})}})}}},t=function(a,b,c,e){function g(b){k.getDialog("Export Failed","Failed to export file to <em>"+j.escape(a)+"</em><br />"+j.escape(b.substring(0,500)),!0,"error-dialog").modal({backdrop:"static"}),console.error(b)}d.modal("hide"),File.blockUI=!1,0!==e?g(c):f.shell.showItemInFolder(a),File.editor["export"].cleanUpTempFiles()},u=function(a,b,c,e){d.modal("hide"),File.unlock(),File.blockUI=!1,b&&0!=b.length?(console.debug("import success"),File.reloadContent(b.toString(),!0)):(console.debug("import failed"),k.getDialog("Import Failed","Failed to import file from <em>"+j.escape(a)+"</em><br />"+j.escape(c),!0,"error-dialog").modal({backdrop:"static"})),File.updateChangeCount(File.ChangeType.NSChangeDone),q()};s.slientQuit=q,s.validatePandocInstall=r,c.exports=s}}),define("app/window/ContextMenu",["app/editor/KeyMaster","app/document/Node","exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/editor/Stylize","app/editor/UndoManager","rangy/rangy-core","app/editor/UserOp","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/ConvertUtils","app/window/FileHelper"],function(a,b,c){"use strict";function d(){$(".context-menu").removeClass("show")}function e(a){var b=w.getCurrentWindow();d(),b.inspectElement(a.clientX,a.clientY)}function f(){var a=w.app.setting.config||{},b=a.searchService||[["Search with Google","https://google.com/search?q=%s"]];b.forEach(function(a,c){var d=$($.parseHTML('<li data-group="search" data-key>\n<a role="menuitem">'+u.escape(a[0])+"</a></li>")[0]);0===c?($("#search-service-placeholder").after('<li class="divider" data-group="search"></li>').replaceWith(d),d.attr("data-key","search-default"),b.length>2&&d.after('<li data-key="search-with" data-group="search" class="has-extra-menu">\n<a role="menuitem"><span>Search With...</span><i class="fa fa-caret-right"></i></a></li>')):1===c&&2==b.length?$("[data-key='search-default']").after(d):$("#search-menu").append(d),d.click(function(){g(a[1])})})}function g(a){d(),w.shell.openExternal(a.replace(/%s/,encodeURIComponent(n)))}function h(a,b){var c=$("[data-group='"+a+"']");b?c.show():c.hide()}function i(){try{var a=File.editor.getJQueryElem(window.getSelection().anchorNode).closest("a");h("hyperlink",a.attr("href")||a.attr("data-ref"))}catch(b){h("hyperlink",!1)}}function j(){n="";try{n=window.getSelection().toString(),h("search",n.trim().length>0)}catch(a){h("search")}}function k(){if(x&&!File.option.noSpellCheck&&!/\s/gi.exec(n.trim())&&n.trim().length>0&&x.isMisspelled(n.trim())){h("spell-check",!0),$("[data-key='correct']").remove();var a=x.getCorrectionsForMisspelling(n.trim());0==a.length?$("#divider-before-learn").hide():$("#divider-before-learn").show().before(a.reduce(function(a,b){return a+='<li data-group="spell-check" data-key="correct"><a role="menuitem">'+b+"</a></li>"},""))}else h("spell-check",!1)}function l(){File.editor.lastCursor&&File.editor.undo.exeCommand(File.editor.lastCursor)}var m,n="",o=a("app/editor/KeyMaster"),p=a("app/document/Node"),q=p.Node,r=p.TYPE,s=a("app/editor/Stylize"),t=a("app/editor/UserOp"),u=a("app/document/StringUtils"),o=a("app/editor/KeyMaster"),v=o.map,w=window.reqnode?reqnode("electron").remote:null,x=function(){try{return window.reqnode&&reqnode("spellchecker")}catch(a){console.error(a.stack)}}(),y=function(a){File.isMac||(this.sessionStr=a,$(document).ready(z.bind(this)))},z=function(){$("content").on("scroll",d),$(window).on("resize",d),$(this.sessionStr).on("contextmenu",J.bind(this)),D.call(this),I.call(this),C.call(this),E.call(this),A.call(this),G.call(this),F.call(this),window.reqnode&&H.call(this),window.reqnode&&f.call(this)},A=function(){},B=function(){var a=File.editor.styleBookmark.style,b=a.block[0],c=document.querySelector("#context-menu"),d=File.editor.stylize.CONST.NoInline.indexOf(a.block[0])>-1,e=!1,f=!1,g=!1,i=function(){try{return File.editor.getMarkElem(window.getSelection().getRangeAt(0).startContainer).attr("mdtype")==p.TYPE.meta_block}catch(a){}return!1}();h("inline-style",!d),$("[data-style]").removeClass("active"),a.inline.map(function(a){var b=document.querySelector("[data-style='"+a+"']");b&&b.classList.add("active"),q.isType(a,r.inline_math)&&(g=!0)}),a.block.map(function(a){q.isType(a,r.blockquote,r.list_item)&&(e=!0),q.isType(a,r.table)&&(f=!0),q.isType(a,r.math_block)&&(g=!0)}),$("[data-key='block-style']>span").text(s.CONST.StyleToNameMap[b]),$("#block-style-menu [data-block]").removeClass("state-on").filter("[data-block='"+b+"']").addClass("state-on"),a.block.length>0&&File.editor.stylize.CONST.NormalBlockMap[b]?($("[data-block-auto-disable]").removeClass("disabled"),$("[data-block-auto-hide]").removeClass("hide")):($("[data-block-auto-disable]").addClass("disabled"),$("[data-block-auto-hide]").addClass("hide")),(b==r.def_footnote||b==r.def_link)&&($("#insert-menu [data-block-auto-disable]").addClass("disabled"),$("#insert-menu [data-block-auto-hide]").addClass("hide")),File.editor.docMenu.getMetaNode()||i?($('[data-insert="meta_block"]').parent().addClass("hide"),$('[data-group="block-wrap"]').addClass("hide")):(b==r.meta_block&&$('[data-insert-p="before"]').parent().addClass("disabled"),$('[data-insert="meta_block"]').removeClass("hide"),$('[data-group="block-wrap"]').removeClass("hide")),e?c.querySelector('[data-group="block-tab"]').classList.remove("hide"):c.querySelector('[data-group="block-tab"]').classList.add("hide"),f?(c.querySelector('[data-key="table"]').classList.remove("hide"),c.querySelector('[data-key="block-style"]').classList.add("hide")):(c.querySelector('[data-key="table"]').classList.add("hide"),c.querySelector('[data-key="block-style"]').classList.remove("hide")),g?c.querySelector('[data-key="math"]').classList.remove("hide"):c.querySelector('[data-key="math"]').classList.add("hide")},C=function(){document.querySelector("#context-menu");$("[data-style]").click(function(){d(),l(),File.editor.refocus(),File.editor.stylize.toggleStyle(this.getAttribute("data-style"))})},D=function(){$("body").on("mouseenter",".context-menu [data-key]",function(){var a=$(this);a.closest(".context-menu").find(".active").removeClass("active"),a.addClass("active")}).on("mouseleave",".context-menu",function(a){$(this).find(".active:not(.has-extra-menu)").removeClass("active")}),$("#context-menu").on("mouseenter","[data-key]",function(){var a=$(this);if("block-style"==a.attr("data-key")?(K("#block-style-menu",a),a.addClass("active")):(document.querySelector("#block-style-menu").classList.remove("show"),document.querySelector("[data-key='block-style']").classList.remove("active")),"insert"==a.attr("data-key")?(K("#insert-menu",a),a.addClass("active")):(document.querySelector("#insert-menu").classList.remove("show"),document.querySelector("[data-key='insert']").classList.remove("active")),"copy-as"==a.attr("data-key")?(K("#edit-menu",a),a.addClass("active")):(document.querySelector("[data-key='copy-as']").classList.remove("active"),document.querySelector("#edit-menu").classList.remove("show")),"search-with"==a.attr("data-key")?(K("#search-menu",a),a.addClass("active")):(document.querySelector("#search-menu").classList.remove("show"),$("[data-key='search-with']").removeClass("active")),"table"==a.attr("data-key")){var b=editor.getMarkElem();b.closest("thead").length?$("[data-key='insert_row_before'], [data-key='delete_table_row']").hide():($("[data-key='insert_row_before']").show(),b.closest("tbody").children().length>=2?$("[data-key='delete_table_row']").show():$("[data-key='delete_table_row']").hide()),b.closest("tr").children().length>=2?$("[data-key='delete_table_col']").show():$("[data-key='delete_table_col']").hide(),K("#table-menu",a),a.addClass("active")}else document.querySelector("#table-menu").classList.remove("show"),document.querySelector("[data-key='table']").classList.remove("active");"math"==a.attr("data-key")?(K("#math-menu",a),a.addClass("active")):(document.querySelector("#math-menu").classList.remove("show"),document.querySelector("[data-key='math']").classList.remove("active"))})},E=function(){$("#context-menu").on("click","[data-indent]",function(){var a=this.getAttribute("data-indent");d(),l(),File.editor.refocus(),File.editor.stylize.toggleIndent(a)}).on("click","[data-tab]",function(){d(),l(),File.editor.refocus();var a="left"==this.getAttribute("data-tab");a?t.lessIndent(File.editor):t.moreIndent(File.editor)}),$("#block-style-menu").on("click","[data-block]",function(){var a=this.getAttribute("data-block");d(),l(),File.editor.refocus(),File.editor.stylize.changeBlock(a)}),$("#insert-menu").on("click","[data-insert]",function(){var a=this.getAttribute("data-insert");d(),l(),File.editor.refocus(),a===r.table?File.editor.tableEdit.insertTable():a===r.meta_block?File.editor.stylize.insertMetaBlock():File.editor.stylize.insertBlock(a)}).on("click","[data-insert-p]",function(){var a="before"==this.getAttribute("data-insert-p");d(),l(),File.editor.refocus(),File.editor.UserOp.insertParagraph(a)})},F=function(){$("#math-menu").on("click",'[data-key="copy_as_mathml"]',function(){d(),l(),File.editor.styleBookmark.style.block.indexOf(r.math_block)>-1?File.editor.mathBlock.copyAsMathML(m):File.editor.mathInline.copyAsMathML()}).on("click",'[data-key="copy_as_math_tex"]',function(){d(),l(),File.editor.styleBookmark.style.block.indexOf(r.math_block)>-1?File.editor.mathBlock.copyAsTex(m):File.editor.mathInline.copyAsTex()}).on("click",'[data-key="copy_as_math_image"]',function(){d(),l(),File.editor.styleBookmark.style.block.indexOf(r.math_block)>-1?File.editor.mathBlock.copyAsImage(m):File.editor.mathInline.copyAsImage()}),File.isWin||$("#math-menu [menu-for-win]").hide()},G=function(){$("#table-menu").on("click",'[data-key="insert_row_before"]',function(){d(),l(),File.editor.tableEdit.addRow(!0)}).on("click",'[data-key="insert_row_after"]',function(){d(),l(),File.editor.tableEdit.addRow(!1)}).on("click",'[data-key="delete_table_row"]',function(){d(),l(),File.editor.tableEdit.deleteRow(!1)}).on("click",'[data-key="insert_col_before"]',function(){d(),l(),File.editor.tableEdit.addCol(!0)}).on("click",'[data-key="insert_col_after"]',function(){d(),l(),File.editor.tableEdit.addCol(!1)}).on("click",'[data-key="delete_table_col"]',function(){d(),l(),File.editor.tableEdit.deleteCol()}).on("click",'[data-key="delete_table"]',function(){d(),l(),File.editor.tableEdit.deleteTable()}).on("click",'[data-key="copy_table"]',function(){d(),l(),File.editor.tableEdit.copyTable()})},H=function(){x&&!File.option.noSpellCheck&&(reqnode("electron").webFrame.setSpellCheckProvider("en-US",File.option.autoCorrectMisspell,{spellCheck:function(a){return!x.isMisspelled(a)}}),$("#context-menu").on("click","[data-key='learn']",function(){d(),l(),x.add(n),w.clipboard.writeText(n),ClientCommand.paste()}).on("click","[data-key='correct']",function(a){d(),l(),w.clipboard.writeText($(a.target).text()),ClientCommand.paste(),File.editor.refocus()}))},I=function(){if($("[data-key='jumpto']").click(function(){d(),l(),File.editor.tryOpenLink(File.editor.getJQueryElem(window.getSelection().anchorNode).closest("a"))}),$(".context-menu").mousedown(function(a){return $(a.target).closest("a").length?void 0:!1}),$("[data-key='dev-tool']").click(e),File.isNode){var a=w.app;a.setting.get("debug",!1)?$("[data-group='dev-tool']").show():$("[data-group='dev-tool']").hide()}$("[data-key='cut']").click(function(a){d(),l(),ClientCommand.cut()}),$("[data-key='copy']").click(function(a){d(),l(),ClientCommand.copy()}),$("[data-key='copy_as_markdown']").click(function(a){d(),l(),ClientCommand.copyAsMarkdown()}),$("[data-key='paste_as_plain']").click(function(a){d(),l(),ClientCommand.pasteAsPlain()}),$("[data-key='paste']").click(function(){d(),l(),ClientCommand.paste()})},J=function(a){File.editor.brush.expand(),$(File.editor.sessionStr).trigger("cursorChange"),File.editor.lastCursor=File.editor.selection.buildUndo(),$(a.target).closest(".mathjax-block").length&&(m=a.target,File.editor.stylize.putBookmark(null,File.editor.stylize.buildBookmark($(a.target).closest(".mathjax-block"))),File.ignoreStyleChange=!0,setTimeout(function(){File.ignoreStyleChange=!1},400)),$(".context-menu").removeClass("show").find(".active").removeClass("active"),i(),j(),B(),window.reqnode&&k();var b=$("#context-menu").addClass("show"),c=b.height()+48,d=a.clientX>window.innerWidth-220?window.innerWidth-220:a.clientX,e=a.clientY>window.innerHeight-c?window.innerHeight-c:a.clientY-$("#top-titlebar").height()+8;return b.css({top:e+"px",left:d+"px"}),!1},K=function(a,b){var c=$(a).addClass("show"),d=c.height()+48,e=b.offset(),f=e.left,g=f+200,h=e.top-30,i=g+160>window.innerWidth?f-184:g,j=h+d>window.innerHeight?window.innerHeight-d:h;return c.css({top:j+"px",left:i+"px"}),!1},L=function(a,b){var c,d,e=$(a);if("Enter"==b){
if(!e.hasClass("has-extra-menu"))return e.trigger("click").find("a").trigger("click"),!0;b="OpenSubmenu"}if("Up"==b||"Down"==b)return e=e.closest("li"),c="Up"==b?e.prev():e.next(),0==c.length?!0:!c.height()||c.hasClass("divider")?L(c[0],b):(e=e.closest(".context-menu").find(".active"),c.hasClass("has-btn-submenu")?(d=e.prevAll("a").length/(e.closest(".has-btn-submenu").find("a").length||1)*c.find("a").length,c=$(c.find("[data-key]")[Math.floor(d)]),c.trigger("mouseenter"),!0):(e.removeClass("active"),c.addClass("active"),!0));if(("Left"==b||"Right"==b)&&"A"==e[0].tagName)return c="Left"==b?e.prev():e.next(),e.removeClass("active"),c.addClass("active"),!0;if("Left"==b||"Esc"==b){if(e=e.closest(".context-menu"),e.hasClass("ext-context-menu"))return e.find(".active").removeClass("active"),e.removeClass("show"),!0;if("Left"==b)return!0}return"Right"==b||"OpenSubmenu"==b?(e.hasClass("has-extra-menu")&&(e.trigger("mouseenter"),$(".ext-context-menu:visible [data-key]:visible").first().trigger("mouseenter")),!0):void 0};y.prototype.handleKeyEvent=function(a){var b,c=v[a.keyCode||a.which],d=$(".context-menu:visible");return d.length?"Esc"==c?($(".context-menu").removeClass("show"),!0):d.find(".active").length?(b=$(".ext-context-menu .active")[0])?L(b,c):L($(".context-menu .active")[0],c):"Up"==c?(d.find("li[data-key]:visible").last().addClass("active"),!0):"Down"==c?(d.find("li[data-key]:visible").first().addClass("active"),!0):void 0:!1},c.exports=y}),define("app/window/MegaMenu",["list.js-master/dist/list","list.js-master/dist/list.fuzzysearch.min","app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/window/FileHelper","app/editor/KeyMaster","app/window/ClientCommand","app/document/File","app/editor/UndoManager","app/editor/polyfill","app/window/FileHelper","app/window/FileInfoPanel","app/window/PDFBridge","app/window/PandocBridge","app/window/PandocBridge"],function(a,b,c){"use strict";var d=a("list.js-master/dist/list"),e=a("list.js-master/dist/list.fuzzysearch.min.js"),f=a("app/document/StringUtils"),g=a("app/editor/EditHelper"),h=a("app/window/FileHelper"),i=a("app/editor/KeyMaster"),j=i.map,k=a("app/window/ClientCommand"),l=a("app/window/PandocBridge"),m=window.reqnode?reqnode("electron").remote:null,n=function(a){File.isNodeHtml&&(this.sessionStr=a,$(document).ready(q.bind(this)))},o=null,p=function(){$("#recent-document-table");if(File.isNode){var a=(m.getCurrentWindow(),m.app),b=a.setting.getRecentDocuments();if(b.map(function(a){a["recent-file-dir"]=a.path.substr(0,a.path.length-a.name.length),a["recent-file-name"]=f.escape(a.name),a["recent-file-path"]=f.escape(a.path)}),b=b.filter(function(a){return a["recent-file-name"].trim().length>0}).sort(function(a,b){return-a.date+b.date}),o)o.clear(),o.add(b);else{var c={item:"recent-file-item-pattern",listClass:"list-js-list",valueNames:["name"],plugins:[e()]};o=new d("recent-file-panel",c,b)}}},q=function(){function a(){var a=this.getAttribute("id").substr(2);$(".megamenu-section").addClass("hide"),$("#megamenu-section-"+a).removeClass("hide"),$("#megamenu-menu-list a").removeClass("active"),$(this).addClass("active")}if($(document).on("keydown",function(a){"Esc"===j[a.keyCode||a.which]&&$("body").removeClass("megamenu-opened")}),$("#w-menu-btn").click(function(){return $(".dropdown-menu").removeClass("open").removeClass("show"),$("body").addClass("megamenu-opened"),$(".megamenu-menu-header").focus(),$("#m-open").trigger("click"),!1}),$(".megamenu-menu-header").click(function(){return $("body").removeClass("megamenu-opened"),!1}).mouseleave(function(){$(this).blur()}),$("#m-open").on("active",function(){a.call(this),p()}).on("click",function(){$(this).trigger("active");var a=!$("#megamenu-section-open").removeClass("hide").is(":visible");a&&$("#m-open-local").trigger("click")}),$("#m-export, #m-about").click(a),$("#m-theme").click(function(){t(),a.call(this)}),$("#m-preference").click(function(){File.megaMenu.prepPreferencePanel(),a.call(this)}),File.isNode){var b=(m.getCurrentWindow(),m.app);$("#m-close").click(k.close),$("#m-new").click(k.newFile),$("#recent-file-panel").on("click",".recent-file-item",function(){var a=this.querySelector(".recent-file-path").innerHTML,c=f.unescape(a);File.fs.existsSync(c)?(k.openFileWithPath(c),$(".megamenu-menu-header").trigger("click")):(g.getDialog("Error","File does not exist at <em>"+a+"</em>",!0,"error-dialog").modal({backdrop:"static"}),b.setting.removeRecentDocument(c),o&&o.remove("path",c))}),$("#megamenu-clear-recet-documents").click(function(){b.setting.clearRecentDocuments(),o.clear()}),$("#m-open-local").click(k.open),$("#m-import-local").click(k["import"]),$("#m-save").click(k.save),$("#m-save-as").click(k.saveAs),$("#export-as-pdf").click(k.exportPDF),$("#export-as-html").click(k.exportHTML),$("#export-as-html-plain").click(k.exportHTMLPlain),$("#export-as-image").click(k.exportImage),$("#export-as-docx").click(k.exportDocx),$("#export-as-odt").click(k.exportOdt),$("#export-as-rtf").click(k.exportRTF),$("#export-as-epub").click(k.exportEpub),$("#export-as-latex").click(k.exportLaTeX),$("#export-as-wiki").click(k.exportWiki),$("#export-as-rst").click(k.exportRST),$("#export-as-opml").click(k.exportOPML),$("#export-as-textile").click(k.exportTextile),$("#m-print").click(k.print),w(),r()}},r=function(){$("#about-page-version-label").text("version "+m.app.getVersion()+"(beta)"),m.app.setting.get("framelessWindow")||$("#about-content-about-section").appendTo("#about-dialog .modal-body"),$("#typora-help-md-table tr").click(function(){"Support Documentation"==this.textContent.trim()?m.shell.openExternal("http://support.typora.io"):m.app.openFile(__dirname+"/Docs/"+this.textContent.trim()+".md")})},s=!1,t=function(){var a=m.app,b=a.setting.getAllThemes(),c="";s||(b.map(function(b){c+='<div class="theme-preview-div" data-theme="$theme$" ><iframe class="theme-preview-content" src="html/preview.html?$src$""></iframe><div style="position:absolute; top:0;left:0;bottom:0;right:0;background:white;opacity:0;padding:0;margin:0;"></div><i class="fa fa-check-circle"></i></div>'.replace("$src$",encodeURI("folder="+a.getPath("userData").replace(/\\/g,"\\\\")+"/themes&&css="+b)).replace("$theme$",b)}),$("#theme-preview-grid").html(c).on("click",".theme-preview-div",function(){console.log(this),$("#theme-preview-grid").find(".active").removeClass("active");var a=$(this).addClass("active").attr("data-theme");k.setTheme(a,a.replace(/\.css$/,"").replace(/(?:^|_|-)(\w)/g,function(a,b,c){return b.toUpperCase()}))}),s=!0),$("#theme-preview-grid [data-theme='"+a.setting.getCurrentTheme()+"']").addClass("active")},u=function(){var a=(m.getCurrentWindow(),m.app);if(l.validatePandocInstall(!0)&&$(".hide-when-pandoc-installed").hide(),$(".open-pandoc-guide").on("click",function(){a.openFile(__dirname+"/Docs/Install and Use Pandoc.md")}),a.setting.get("framelessWindow")||$("#preference-content").appendTo("#preference-dialog .modal-body"),$("input[name='windowStyleType'][value='framelessWindow']").prop("checked",a.setting.get("framelessWindow")),$("input[name='windowStyleType'][value='nativeWindow']").prop("checked",!a.setting.get("framelessWindow")),$("#show-status-bar-btn").prop("checked",a.setting.get("showStatusBar")!==!1),$("#custom-font-size-input").val(a.setting.get("customFontSize")||14),a.setting.get("useCustomFontSize")?$("#use-custom-font-size-btn").prop("checked",!0):$("#use-auto-font-size-btn").prop("checked",!0),$("#collapsible-outline-btn").prop("checked",a.setting.get("can_collapse_outline_panel")),File.option.autoToggleEmojiAutoComplete?$("#trigger-emoji-autocomplete-on").prop("checked",!0):$("#trigger-emoji-autocomplete-off").prop("checked",!0),$("input[name='copy_markdown_by_default']").prop("checked",File.option.copyMarkdownByDefault),["enable_subscript","enable_superscript","show_line_numbers_for_fence","auto_numbering_for_math","enable_highlight","use_relative_path_for_img","allow_image_move"].map(function(b){$("input[name='"+b+"']").prop("checked",a.setting.get(b))}),$("input[name='enable_diagram']").prop("checked",File.option.enableDiagram),$("input[name='enable_inline_math']").prop("checked",File.option.enableInlineMath),$("#preference-auto-save").prop("checked",a.setting.get("enableAutoSave")),$("input[name='enable_spell_check']").prop("checked",!a.setting.get("no_spell_check")),$("input[name='auto_correct_misspell']").prop("checked",!a.setting.get("auto_correct_misspell")).prop("disabled",a.setting.get("no_spell_check")),$("input[name='scroll_with_cursor']").prop("checked",!a.setting.get("no_pairing_match")),$("#preference_auto_pair").prop("checked",!a.setting.get("no_pairing_match")),a.setting.get("no_pairing_match")?($("#preference_auto_pair_markdown").prop("checked",!1),$("#preference_auto_pair_markdown").prop("disabled",!0)):($("#preference_auto_pair_markdown").prop("checked",a.setting.get("match_pari_markdown")),$("#preference_auto_pair_markdown").prop("disabled",!1)),$("#preference_expand_block").prop("checked",a.setting.get("auto_expand_block")),$("#preference-indent-size-btn").val((a.setting.get("indentSize")||2)+""),File.isWin)try{var b=reqnode("winsparkle-node");$("#preference-enable-auto-update").prop("checked",b.getAutomaticCheckForUpdates())}catch(c){console.error(c)}else $("#preference-enable-auto-update").parent().hide();$("#preference-trigger-debug-btn").prop("checked",a.setting.get("debug",!1)),$("#preference-send-anony-info-btn").prop("checked",a.setting.get("send_usage_info",!0)),$("#preference-heading-style").val(File.option.headingStyle),$("#preference-ul-style").val(File.option.ulStyle),$("#trigger-line-ending-crlf").prop("checked",File.option.preferCRLF),$("#trigger-line-ending-lf").prop("checked",!File.option.preferCRLF),v()},v=function(a){a=a||File.option.indentSize;var b=["> Quote\n- List item\n  1. sub-bullet",">  Quote\n-  List item\n   1. sub-bullet",">   Quote\n-   List item\n    1.  sub-bullet",">    Quote\n-    List item\n     1.   sub-bullet"];$("#preference-indent-size-pre").text(b[a-2])},w=function(){var a=(m.getCurrentWindow(),m.app),b=reqnode("fs-extra");reqnode("electron").ipcRenderer;$(document).on("change","input[name='windowStyleType']",function(){a.setting.put("framelessWindow","framelessWindow"==$("input[name='windowStyleType']:checked").val())}).on("change","#show-status-bar-btn",function(){var b=$("#show-status-bar-btn:checked").length>0;a.setting.put("showStatusBar",b),k.execForAll('function() {                document.body.classList.toggle("show-footer");            }')}).on("change","input[name='fontSize']",function(){var b=$("#use-custom-font-size-btn").prop("checked");a.setting.put("useCustomFontSize",b),k.execForAll('function() {                var app = reqnode("electron").remote.app,                    useCustomFontSize = app.setting.get("useCustomFontSize");                if (useCustomFontSize) {                    document.body.parentElement.style.fontSize = (app.setting.get("customFontSize") || 14) + "px";                } else {                    document.body.parentElement.style.fontSize = "";                }            }')}).on("keypress","#custom-font-size-input",function(a){return/\d/.exec(String.fromCharCode(a.which))?void 0:!1}).on("blur","#custom-font-size-input",function(b){var c=/\d+/.exec(this.value)[0];a.setting.put("customFontSize",c),k.execForAll('function() {                var app = reqnode("electron").remote.app;                document.body.parentElement.style.fontSize = app.setting.get("customFontSize") + "px";            }')}).on("change","#collapsible-outline-btn",function(){var b=$("#collapsible-outline-btn:checked").length>0;a.setting.put("can_collapse_outline_panel",b),k.execForAll("function() {                File.setCanCollapsePinnedOutline("+(b?!0:!1)+");            }")}).on("change","[name='enable_inline_math'], [name='enable_subscript'],[name='enable_superscript'],[name='enable_highlight'],[name='enable_diagram'],[name='copy_markdown_by_default'], [name='show_line_numbers_for_fence'], [name='auto_correct_misspell'], [name='auto_numbering_for_math'], [name='use_relative_path_for_img'], [name='allow_image_move']",function(){var b=this.getAttribute("name"),c=$(this).prop("checked");a.setting.put(b,c),k.execForAll("function(){File.option."+f.camelize(b)+" = "+c+";}")}).on("change","#preference-indent-size-btn",function(){var b=this.value-0;a.setting.put("indentSize",b),v(b),k.execForAll('function() {                File.option.indentSize = "$1";            }',b)}).on("click","#open-theme-folder-btn",function(){m.shell.openItem(m.app.getPath("userData")+"/themes")}).on("change","#preference-trigger-debug-btn",function(){var b=$("#preference-trigger-debug-btn:checked").length>0;a.setting.put("debug",b),b?k.execForAll("function() {$(\"[data-group='dev-tool']\").show();}"):k.execForAll("function() {$(\"[data-group='dev-tool']\").hide();}")}).on("change","#preference-send-anony-info-btn",function(){a.setting.put("send_usage_info",$("#preference-send-anony-info-btn:checked").length>0)}).on("change","[name='enable_spell_check']",function(){var b=!$(this).prop("checked");a.setting.put("no_spell_check",b),$("[name='auto_correct_misspell']").prop("disabled",!b),k.execForAll("function(){File.option.noSpellCheck = "+b+";}")}).on("change","#preference_auto_pair",function(){var b=!$(this).prop("checked");a.setting.put("no_pairing_match",b),k.execForAll("function(){File.option.noPairingMatch = "+b+";}"),b&&$("#preference_auto_pair_markdown").prop("checked",!1),$("#preference_auto_pair_markdown").prop("disabled",b)}).on("change","#preference_auto_pair_markdown",function(){var b=$(this).prop("checked");a.setting.put("match_pari_markdown",b),k.execForAll("function(){File.option.autoPairExtendSymbol = "+b+";}")}).on("change","[name='defaultLineEnding']",function(){var b=$("#trigger-line-ending-crlf").prop("checked");a.setting.put("line_ending_crlf",b),k.execForAll("function(){File.option.preferCRLF = "+b+";}")}).on("change","#preference_expand_block",function(){var b=$(this).prop("checked");a.setting.put("auto_expand_block",b),k.execForAll("function(){File.option.expandSimpleBlock = "+b+";}")}).on("change","#preference-heading-style",function(){var b=$(this).val()-0;a.setting.put("heading_style",b),k.execForAll("function(){File.option.headingStyle = "+b+";}")}).on("change","#preference-ul-style",function(){var b=$(this).val()-0;a.setting.put("ul_style",b),k.execForAll("function(){File.option.ulStyle = "+b+";}")}).on("change","[name='autocompleteTrigger']",function(){var b=$("#trigger-emoji-autocomplete-on").prop("checked");a.setting.put("trigger_emoji_autocomplete",b),k.execForAll("function(){File.option.autoToggleEmojiAutoComplete = "+b+";}")}).on("click","#preference-open-draft-folder",function(){m.shell.openItem(h.getUnsavedDraftsPath())}).on("change","#preference-auto-save",function(){var b=$(this).prop("checked");a.setting.put("enableAutoSave",b),k.execForAll("function(){File.option.enableAutoSave = "+b+";}")}).on("click","#open-conf-folder-btn",function(){m.shell.showItemInFolder(a.getPath("userData")+"/conf/conf.user.json")}).on("click","#reset-conf-folder-btn",function(){$(".modal:not(.block-modal)").modal("hide");var c=function(){},d=g.getDialog("Confrim","Revert advanced setting file to default one ?").modal({backdrop:!1});d.find(".btn-primary").one("click",function(){b.copy(__dirname+"/conf.default.json",a.getPath("userData")+"/conf/conf.default.json",{clobber:!0},c),b.copy(__dirname+"/conf.default.json",a.getPath("userData")+"/conf/conf.user.json",{clobber:!0},c),d.modal("hide")})}).on("change","[name='scroll_with_cursor']",function(){var b=!$(this).prop("checked");a.setting.put("no_pairing_match",b),k.execForAll("function(){File.option.scrollWithCursor = !"+b+";}")}),function(){try{var b=File.isWin&&reqnode("winsparkle-node");$(document).on("click","#preference-trigger-check-update",function(){File.isWin&&(b.setAppcastUrl("https://www.typora.io/windows/dev_update.xml"),b.checkUpdateWithUI())}).on("change","#preference-enable-auto-update",function(){$("#preference-enable-auto-update:checked").length?(b.setAutomaticCheckForUpdates(!0),a.setting.put("enableAutoUpdate",!0)):(b.setAutomaticCheckForUpdates(!1),a.setting.put("enableAutoUpdate",!1))})}catch(c){console.error(c)}}()};n.prototype.prepPreferencePanel=u,c.exports=n}),define("list.js-master/dist/list",[],function(a,b,c){"use strict";!function(){function a(b,c,d){var e=a.resolve(b);if(null==e){d=d||b,c=c||"root";var f=new Error('Failed to require "'+d+'" from "'+c+'"');throw f.path=d,f.parent=c,f.require=!0,f}var g=a.modules[e];if(!g._resolving&&!g.exports){var h={};h.exports={},h.client=h.component=!0,g._resolving=!0,g.call(this,h.exports,a.relative(e),h),delete g._resolving,g.exports=h.exports}return g.exports}a.modules={},a.aliases={},a.resolve=function(b){"/"===b.charAt(0)&&(b=b.slice(1));for(var c=[b,b+".js",b+".json",b+"/index.js",b+"/index.json"],d=0;d<c.length;d++){var b=c[d];if(a.modules.hasOwnProperty(b))return b;if(a.aliases.hasOwnProperty(b))return a.aliases[b]}},a.normalize=function(a,b){var c=[];if("."!=b.charAt(0))return b;a=a.split("/"),b=b.split("/");for(var d=0;d<b.length;++d)".."==b[d]?a.pop():"."!=b[d]&&""!=b[d]&&c.push(b[d]);return a.concat(c).join("/")},a.register=function(b,c){a.modules[b]=c},a.alias=function(b,c){if(!a.modules.hasOwnProperty(b))throw new Error('Failed to alias "'+b+'", it does not exist');a.aliases[c]=b},a.relative=function(b){function c(a,b){for(var c=a.length;c--;)if(a[c]===b)return c;return-1}function d(c){var e=d.resolve(c);return a(e,b,c)}var e=a.normalize(b,"..");return d.resolve=function(d){var f=d.charAt(0);if("/"==f)return d.slice(1);if("."==f)return a.normalize(e,d);var g=b.split("/"),h=c(g,"deps")+1;return h||(h=0),d=g.slice(0,h+1).join("/")+"/deps/"+d},d.exists=function(b){return a.modules.hasOwnProperty(d.resolve(b))},d},a.register("component-classes/index.js",function(a,b,c){function d(a){if(!a)throw new Error("A DOM element reference is required");this.el=a,this.list=a.classList}var e=b("indexof"),f=/\s+/,g=Object.prototype.toString;c.exports=function(a){return new d(a)},d.prototype.add=function(a){if(this.list)return this.list.add(a),this;var b=this.array(),c=e(b,a);return~c||b.push(a),this.el.className=b.join(" "),this},d.prototype.remove=function(a){if("[object RegExp]"==g.call(a))return this.removeMatching(a);if(this.list)return this.list.remove(a),this;var b=this.array(),c=e(b,a);return~c&&b.splice(c,1),this.el.className=b.join(" "),this},d.prototype.removeMatching=function(a){for(var b=this.array(),c=0;c<b.length;c++)a.test(b[c])&&this.remove(b[c]);return this},d.prototype.toggle=function(a,b){return this.list?("undefined"!=typeof b?b!==this.list.toggle(a,b)&&this.list.toggle(a):this.list.toggle(a),this):("undefined"!=typeof b?b?this.add(a):this.remove(a):this.has(a)?this.remove(a):this.add(a),this)},d.prototype.array=function(){var a=this.el.className.replace(/^\s+|\s+$/g,""),b=a.split(f);return""===b[0]&&b.shift(),b},d.prototype.has=d.prototype.contains=function(a){return this.list?this.list.contains(a):!!~e(this.array(),a)}}),a.register("segmentio-extend/index.js",function(a,b,c){c.exports=function(a){for(var b,c=Array.prototype.slice.call(arguments,1),d=0;b=c[d];d++)if(b)for(var e in b)a[e]=b[e];return a}}),a.register("component-indexof/index.js",function(a,b,c){c.exports=function(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0;c<a.length;++c)if(a[c]===b)return c;return-1}}),a.register("component-event/index.js",function(a,b,c){var d=window.addEventListener?"addEventListener":"attachEvent",e=window.removeEventListener?"removeEventListener":"detachEvent",f="addEventListener"!==d?"on":"";a.bind=function(a,b,c,e){return a[d](f+b,c,e||!1),c},a.unbind=function(a,b,c,d){return a[e](f+b,c,d||!1),c}}),a.register("timoxley-to-array/index.js",function(a,b,c){function d(a){return"[object Array]"===Object.prototype.toString.call(a)}c.exports=function(a){if("undefined"==typeof a)return[];if(null===a)return[null];if(a===window)return[window];if("string"==typeof a)return[a];if(d(a))return a;if("number"!=typeof a.length)return[a];if("function"==typeof a&&a instanceof Function)return[a];for(var b=[],c=0;c<a.length;c++)(Object.prototype.hasOwnProperty.call(a,c)||c in a)&&b.push(a[c]);return b.length?b:[]}}),a.register("javve-events/index.js",function(a,b,c){var d=b("event"),e=b("to-array");a.bind=function(a,b,c,f){a=e(a);for(var g=0;g<a.length;g++)d.bind(a[g],b,c,f)},a.unbind=function(a,b,c,f){a=e(a);for(var g=0;g<a.length;g++)d.unbind(a[g],b,c,f)}}),a.register("javve-get-by-class/index.js",function(a,b,c){c.exports=function(){return document.getElementsByClassName?function(a,b,c){return c?a.getElementsByClassName(b)[0]:a.getElementsByClassName(b)}:document.querySelector?function(a,b,c){return b="."+b,c?a.querySelector(b):a.querySelectorAll(b)}:function(a,b,c){var d=[],e="*";null==a&&(a=document);for(var f=a.getElementsByTagName(e),g=f.length,h=new RegExp("(^|\\s)"+b+"(\\s|$)"),i=0,j=0;g>i;i++)if(h.test(f[i].className)){if(c)return f[i];d[j]=f[i],j++}return d}}()}),a.register("javve-get-attribute/index.js",function(a,b,c){c.exports=function(a,b){var c=a.getAttribute&&a.getAttribute(b)||null;if(!c)for(var d=a.attributes,e=d.length,f=0;e>f;f++)void 0!==b[f]&&b[f].nodeName===b&&(c=b[f].nodeValue);return c}}),a.register("javve-natural-sort/index.js",function(a,b,c){c.exports=function(a,b,c){var d,e,f=/(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?$|^0x[0-9a-f]+$|[0-9]+)/gi,g=/(^[ ]*|[ ]*$)/g,h=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,i=/^0x[0-9a-f]+$/i,j=/^0/,c=c||{},k=function(a){return c.insensitive&&(""+a).toLowerCase()||""+a},l=k(a).replace(g,"")||"",m=k(b).replace(g,"")||"",n=l.replace(f,"\x00$1\x00").replace(/\0$/,"").replace(/^\0/,"").split("\x00"),o=m.replace(f,"\x00$1\x00").replace(/\0$/,"").replace(/^\0/,"").split("\x00"),p=parseInt(l.match(i))||1!=n.length&&l.match(h)&&Date.parse(l),q=parseInt(m.match(i))||p&&m.match(h)&&Date.parse(m)||null,r=c.desc?-1:1;if(q){if(q>p)return-1*r;if(p>q)return 1*r}for(var s=0,t=Math.max(n.length,o.length);t>s;s++){if(d=!(n[s]||"").match(j)&&parseFloat(n[s])||n[s]||0,e=!(o[s]||"").match(j)&&parseFloat(o[s])||o[s]||0,isNaN(d)!==isNaN(e))return isNaN(d)?1:-1;if(typeof d!=typeof e&&(d+="",e+=""),e>d)return-1*r;if(d>e)return 1*r}return 0}}),a.register("javve-to-string/index.js",function(a,b,c){c.exports=function(a){return a=void 0===a?"":a,a=null===a?"":a,a=a.toString()}}),a.register("component-type/index.js",function(a,b,c){var d=Object.prototype.toString;c.exports=function(a){switch(d.call(a)){case"[object Date]":return"date";case"[object RegExp]":return"regexp";case"[object Arguments]":return"arguments";case"[object Array]":return"array";case"[object Error]":return"error"}return null===a?"null":void 0===a?"undefined":a!==a?"nan":a&&1===a.nodeType?"element":typeof a.valueOf()}}),a.register("list.js/index.js",function(a,b,c){!function(a,d){var e=a.document,f=b("get-by-class"),g=b("extend"),h=b("indexof"),i=function(a,c,j){var k,l=this,m=b("./src/item")(l),n=b("./src/add-async")(l),o=b("./src/parse")(l);k={start:function(){l.listClass="list",l.searchClass="search",l.sortClass="sort",l.page=200,l.i=1,l.items=[],l.visibleItems=[],l.matchingItems=[],l.searched=!1,l.filtered=!1,l.handlers={updated:[]},l.plugins={},l.helpers={getByClass:f,extend:g,indexOf:h},g(l,c),l.listContainer="string"==typeof a?e.getElementById(a):a,l.listContainer&&(l.list=f(l.listContainer,l.listClass,!0),l.templater=b("./src/templater")(l),l.search=b("./src/search")(l),l.filter=b("./src/filter")(l),l.sort=b("./src/sort")(l),this.items(),l.update(),this.plugins())},items:function(){o(l.list),j!==d&&l.add(j)},plugins:function(){for(var a=0;a<l.plugins.length;a++){var b=l.plugins[a];l[b.name]=b,b.init(l,i)}}},this.add=function(a,b){if(b)return void n(a,b);var c=[],e=!1;a[0]===d&&(a=[a]);for(var f=0,g=a.length;g>f;f++){var h=null;a[f]instanceof m?(h=a[f],h.reload()):(e=l.items.length>l.page?!0:!1,h=new m(a[f],d,e)),l.items.push(h),c.push(h)}return l.update(),c},this.show=function(a,b){return this.i=a,this.page=b,l.update(),l},this.remove=function(a,b,c){for(var d=0,e=0,f=l.items.length;f>e;e++)l.items[e].values()[a]==b&&(l.templater.remove(l.items[e],c),l.items.splice(e,1),f--,e--,d++);return l.update(),d},this.get=function(a,b){for(var c=[],d=0,e=l.items.length;e>d;d++){var f=l.items[d];f.values()[a]==b&&c.push(f)}return c},this.size=function(){return l.items.length},this.clear=function(){return l.templater.clear(),l.items=[],l},this.on=function(a,b){return l.handlers[a].push(b),l},this.off=function(a,b){var c=l.handlers[a],d=h(c,b);return d>-1&&c.splice(d,1),l},this.trigger=function(a){for(var b=l.handlers[a].length;b--;)l.handlers[a][b](l);return l},this.reset={filter:function(){for(var a=l.items,b=a.length;b--;)a[b].filtered=!1;return l},search:function(){for(var a=l.items,b=a.length;b--;)a[b].found=!1;return l}},this.update=function(){var a=l.items,b=a.length;l.visibleItems=[],l.matchingItems=[],l.templater.clear();for(var c=0;b>c;c++)a[c].matching()&&l.matchingItems.length+1>=l.i&&l.visibleItems.length<l.page?(a[c].show(),l.visibleItems.push(a[c]),l.matchingItems.push(a[c])):a[c].matching()?(l.matchingItems.push(a[c]),a[c].hide()):a[c].hide();return l.trigger("updated"),l},k.start()};c.exports=i}(window)}),a.register("list.js/src/search.js",function(a,b,c){var d=b("events"),e=b("get-by-class"),f=b("to-string");c.exports=function(a){var b,c,g,h,i={resetList:function(){a.i=1,a.templater.clear(),h=void 0},setOptions:function(a){2==a.length&&a[1]instanceof Array?c=a[1]:2==a.length&&"function"==typeof a[1]?h=a[1]:3==a.length&&(c=a[1],h=a[2])},setColumns:function(){c=void 0===c?i.toArray(a.items[0].values()):c},setSearchString:function(a){a=f(a).toLowerCase(),a=a.replace(/[-[\]{}()*+?.,\\^$|#]/g,"\\$&"),g=a},toArray:function(a){var b=[];for(var c in a)b.push(c);return b}},j={list:function(){for(var b=0,c=a.items.length;c>b;b++)j.item(a.items[b])},item:function(a){a.found=!1;for(var b=0,d=c.length;d>b;b++)if(j.values(a.values(),c[b]))return void(a.found=!0)},values:function(a,c){return a.hasOwnProperty(c)&&(b=f(a[c]).toLowerCase(),""!==g&&b.search(g)>-1)?!0:!1},reset:function(){a.reset.search(),a.searched=!1}},k=function(b){return a.trigger("searchStart"),i.resetList(),i.setSearchString(b),i.setOptions(arguments),i.setColumns(),""===g?j.reset():(a.searched=!0,h?h(g,c):j.list()),a.update(),a.trigger("searchComplete"),a.visibleItems};return a.handlers.searchStart=a.handlers.searchStart||[],a.handlers.searchComplete=a.handlers.searchComplete||[],d.bind(e(a.listContainer,a.searchClass),"keyup",function(b){var c=b.target||b.srcElement,d=""===c.value&&!a.searched;d||k(c.value)}),d.bind(e(a.listContainer,a.searchClass),"input",function(a){var b=a.target||a.srcElement;""===b.value&&k("")}),a.helpers.toString=f,k}}),a.register("list.js/src/sort.js",function(a,b,c){var d=b("natural-sort"),e=b("classes"),f=b("events"),g=b("get-by-class"),h=b("get-attribute");c.exports=function(a){a.sortFunction=a.sortFunction||function(a,b,c){return c.desc="desc"==c.order?!0:!1,d(a.values()[c.valueName],b.values()[c.valueName],c)};var b={els:void 0,clear:function(){for(var a=0,c=b.els.length;c>a;a++)e(b.els[a]).remove("asc"),e(b.els[a]).remove("desc")},getOrder:function(a){var b=h(a,"data-order");return"asc"==b||"desc"==b?b:e(a).has("desc")?"asc":e(a).has("asc")?"desc":"asc"},getInSensitive:function(a,b){var c=h(a,"data-insensitive");"true"===c?b.insensitive=!0:b.insensitive=!1},setOrder:function(a){for(var c=0,d=b.els.length;d>c;c++){var f=b.els[c];if(h(f,"data-sort")===a.valueName){var g=h(f,"data-order");"asc"==g||"desc"==g?g==a.order&&e(f).add(a.order):e(f).add(a.order)}}}},c=function(){a.trigger("sortStart"),options={};var c=arguments[0].currentTarget||arguments[0].srcElement||void 0;c?(options.valueName=h(c,"data-sort"),b.getInSensitive(c,options),options.order=b.getOrder(c)):(options=arguments[1]||options,options.valueName=arguments[0],options.order=options.order||"asc",options.insensitive="undefined"==typeof options.insensitive?!0:options.insensitive),b.clear(),b.setOrder(options),options.sortFunction=options.sortFunction||a.sortFunction,a.items.sort(function(a,b){return options.sortFunction(a,b,options)}),a.update(),a.trigger("sortComplete")};return a.handlers.sortStart=a.handlers.sortStart||[],a.handlers.sortComplete=a.handlers.sortComplete||[],b.els=g(a.listContainer,a.sortClass),f.bind(b.els,"click",c),a.on("searchStart",b.clear),a.on("filterStart",b.clear),a.helpers.classes=e,a.helpers.naturalSort=d,a.helpers.events=f,a.helpers.getAttribute=h,c}}),a.register("list.js/src/item.js",function(a,b,c){c.exports=function(a){return function(b,c,d){var e=this;this._values={},this.found=!1,this.filtered=!1;var f=function(b,c,d){if(void 0===c)d?e.values(b,d):e.values(b);else{e.elm=c;var f=a.templater.get(e,b);e.values(f)}};this.values=function(b,c){if(void 0===b)return e._values;for(var d in b)e._values[d]=b[d];c!==!0&&a.templater.set(e,e.values())},this.show=function(){a.templater.show(e)},this.hide=function(){a.templater.hide(e)},this.matching=function(){return a.filtered&&a.searched&&e.found&&e.filtered||a.filtered&&!a.searched&&e.filtered||!a.filtered&&a.searched&&e.found||!a.filtered&&!a.searched},this.visible=function(){return e.elm.parentNode==a.list?!0:!1},f(b,c,d)}}}),a.register("list.js/src/templater.js",function(a,b,c){var d=b("get-by-class"),e=function(a){function b(b){if(void 0===b){for(var c=a.list.childNodes,d=0,e=c.length;e>d;d++)if(void 0===c[d].data)return c[d];return null}if(-1!==b.indexOf("<")){var f=document.createElement("div");return f.innerHTML=b,f.firstChild}return document.getElementById(a.item)}var c=b(a.item),e=this;this.get=function(a,b){e.create(a);for(var c={},f=0,g=b.length;g>f;f++){var h=d(a.elm,b[f],!0);c[b[f]]=h?h.innerHTML:""}return c},this.set=function(a,b){if(!e.create(a))for(var c in b)if(b.hasOwnProperty(c)){var f=d(a.elm,c,!0);f&&("IMG"===f.tagName&&""!==b[c]?f.src=b[c]:f.innerHTML=b[c])}},this.create=function(a){if(void 0!==a.elm)return!1;var b=c.cloneNode(!0);return b.removeAttribute("id"),a.elm=b,e.set(a,a.values()),!0},this.remove=function(b){a.list.removeChild(b.elm)},this.show=function(b){e.create(b),a.list.appendChild(b.elm)},this.hide=function(b){void 0!==b.elm&&b.elm.parentNode===a.list&&a.list.removeChild(b.elm)},this.clear=function(){if(a.list.hasChildNodes())for(;a.list.childNodes.length>=1;)a.list.removeChild(a.list.firstChild)}};c.exports=function(a){return new e(a)}}),a.register("list.js/src/filter.js",function(a,b,c){c.exports=function(a){return a.handlers.filterStart=a.handlers.filterStart||[],a.handlers.filterComplete=a.handlers.filterComplete||[],function(b){if(a.trigger("filterStart"),a.i=1,a.reset.filter(),void 0===b)a.filtered=!1;else{a.filtered=!0;for(var c=a.items,d=0,e=c.length;e>d;d++){var f=c[d];b(f)?f.filtered=!0:f.filtered=!1}}return a.update(),a.trigger("filterComplete"),a.visibleItems}}}),a.register("list.js/src/add-async.js",function(a,b,c){c.exports=function(a){return function(b,c,d){var e=b.splice(0,100);d=d||[],d=d.concat(a.add(e)),b.length>0?setTimeout(function(){addAsync(b,c,d)},10):(a.update(),c(d))}}}),a.register("list.js/src/parse.js",function(a,b,c){c.exports=function(a){var c=b("./item")(a),d=function(a){for(var b=a.childNodes,c=[],d=0,e=b.length;e>d;d++)void 0===b[d].data&&c.push(b[d]);return c},e=function(b,d){for(var e=0,f=b.length;f>e;e++)a.items.push(new c(d,b[e]))},f=function(b,c){var d=b.splice(0,100);e(d,c),b.length>0?setTimeout(function(){init.items.indexAsync(b,c)},10):a.update()};return function(){var b=d(a.list),c=a.valueNames;a.indexAsync?f(b,c):e(b,c)}}}),a.alias("component-classes/index.js","list.js/deps/classes/index.js"),a.alias("component-classes/index.js","classes/index.js"),a.alias("component-indexof/index.js","component-classes/deps/indexof/index.js"),a.alias("segmentio-extend/index.js","list.js/deps/extend/index.js"),
a.alias("segmentio-extend/index.js","extend/index.js"),a.alias("component-indexof/index.js","list.js/deps/indexof/index.js"),a.alias("component-indexof/index.js","indexof/index.js"),a.alias("javve-events/index.js","list.js/deps/events/index.js"),a.alias("javve-events/index.js","events/index.js"),a.alias("component-event/index.js","javve-events/deps/event/index.js"),a.alias("timoxley-to-array/index.js","javve-events/deps/to-array/index.js"),a.alias("javve-get-by-class/index.js","list.js/deps/get-by-class/index.js"),a.alias("javve-get-by-class/index.js","get-by-class/index.js"),a.alias("javve-get-attribute/index.js","list.js/deps/get-attribute/index.js"),a.alias("javve-get-attribute/index.js","get-attribute/index.js"),a.alias("javve-natural-sort/index.js","list.js/deps/natural-sort/index.js"),a.alias("javve-natural-sort/index.js","natural-sort/index.js"),a.alias("javve-to-string/index.js","list.js/deps/to-string/index.js"),a.alias("javve-to-string/index.js","list.js/deps/to-string/index.js"),a.alias("javve-to-string/index.js","to-string/index.js"),a.alias("javve-to-string/index.js","javve-to-string/index.js"),a.alias("component-type/index.js","list.js/deps/type/index.js"),a.alias("component-type/index.js","type/index.js"),"object"==typeof b?c.exports=a("list.js"):"function"==typeof define&&define.amd?define(function(){return a("list.js")}):this.List=a("list.js")}()}),define("list.js-master/dist/list.fuzzysearch.min.js",[],function(a,b,c){"use strict";!function(){function a(b,c,d){var e=a.resolve(b);if(null==e){d=d||b,c=c||"root";var f=new Error('Failed to require "'+d+'" from "'+c+'"');throw f.path=d,f.parent=c,f.require=!0,f}var g=a.modules[e];if(!g._resolving&&!g.exports){var h={};h.exports={},h.client=h.component=!0,g._resolving=!0,g.call(this,h.exports,a.relative(e),h),delete g._resolving,g.exports=h.exports}return g.exports}a.modules={},a.aliases={},a.resolve=function(b){"/"===b.charAt(0)&&(b=b.slice(1));for(var c=[b,b+".js",b+".json",b+"/index.js",b+"/index.json"],d=0;d<c.length;d++){var b=c[d];if(a.modules.hasOwnProperty(b))return b;if(a.aliases.hasOwnProperty(b))return a.aliases[b]}},a.normalize=function(a,b){var c=[];if("."!=b.charAt(0))return b;a=a.split("/"),b=b.split("/");for(var d=0;d<b.length;++d)".."==b[d]?a.pop():"."!=b[d]&&""!=b[d]&&c.push(b[d]);return a.concat(c).join("/")},a.register=function(b,c){a.modules[b]=c},a.alias=function(b,c){if(!a.modules.hasOwnProperty(b))throw new Error('Failed to alias "'+b+'", it does not exist');a.aliases[c]=b},a.relative=function(b){function c(a,b){for(var c=a.length;c--;)if(a[c]===b)return c;return-1}function d(c){var e=d.resolve(c);return a(e,b,c)}var e=a.normalize(b,"..");return d.resolve=function(d){var f=d.charAt(0);if("/"==f)return d.slice(1);if("."==f)return a.normalize(e,d);var g=b.split("/"),h=c(g,"deps")+1;return h||(h=0),d=g.slice(0,h+1).join("/")+"/deps/"+d},d.exists=function(b){return a.modules.hasOwnProperty(d.resolve(b))},d},a.register("component-indexof/index.js",function(a,b,c){c.exports=function(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0;c<a.length;++c)if(a[c]===b)return c;return-1}}),a.register("component-classes/index.js",function(a,b,c){function d(a){if(!a)throw new Error("A DOM element reference is required");this.el=a,this.list=a.classList}var e=b("indexof"),f=/\s+/,g=Object.prototype.toString;c.exports=function(a){return new d(a)},d.prototype.add=function(a){if(this.list)return this.list.add(a),this;var b=this.array(),c=e(b,a);return~c||b.push(a),this.el.className=b.join(" "),this},d.prototype.remove=function(a){if("[object RegExp]"==g.call(a))return this.removeMatching(a);if(this.list)return this.list.remove(a),this;var b=this.array(),c=e(b,a);return~c&&b.splice(c,1),this.el.className=b.join(" "),this},d.prototype.removeMatching=function(a){for(var b=this.array(),c=0;c<b.length;c++)a.test(b[c])&&this.remove(b[c]);return this},d.prototype.toggle=function(a){return this.list?(this.list.toggle(a),this):(this.has(a)?this.remove(a):this.add(a),this)},d.prototype.array=function(){var a=this.el.className.replace(/^\s+|\s+$/g,""),b=a.split(f);return""===b[0]&&b.shift(),b},d.prototype.has=d.prototype.contains=function(a){return this.list?this.list.contains(a):!!~e(this.array(),a)}}),a.register("segmentio-extend/index.js",function(a,b,c){c.exports=function(a){for(var b,c=Array.prototype.slice.call(arguments,1),d=0;b=c[d];d++)if(b)for(var e in b)a[e]=b[e];return a}}),a.register("component-event/index.js",function(a){var b=void 0!==window.addEventListener?"addEventListener":"attachEvent",c=void 0!==window.removeEventListener?"removeEventListener":"detachEvent",d="addEventListener"!==b?"on":"";a.bind=function(a,c,e,f){return a[b](d+c,e,f||!1),e},a.unbind=function(a,b,e,f){return a[c](d+b,e,f||!1),e}}),a.register("component-type/index.js",function(a,b,c){var d=Object.prototype.toString;c.exports=function(a){switch(d.call(a)){case"[object Function]":return"function";case"[object Date]":return"date";case"[object RegExp]":return"regexp";case"[object Arguments]":return"arguments";case"[object Array]":return"array";case"[object String]":return"string"}return null===a?"null":void 0===a?"undefined":a&&1===a.nodeType?"element":a===Object(a)?"object":typeof a}}),a.register("timoxley-is-collection/index.js",function(a,b,c){function d(a){return"object"==typeof a&&/^\[object (NodeList)\]$/.test(Object.prototype.toString.call(a))&&a.hasOwnProperty("length")&&(0==a.length||"object"==typeof a[0]&&a[0].nodeType>0)}var e=b("type");c.exports=function(a){var b=e(a);if("array"===b)return 1;switch(b){case"arguments":return 2;case"object":if(d(a))return 2;try{if("length"in a&&!a.tagName&&(!a.scrollTo||!a.document)&&!a.apply)return 2}catch(c){}default:return 0}}}),a.register("javve-events/index.js",function(a,b){var c=b("event"),d=b("is-collection");a.bind=function(a,b,e,f){if(d(a)){if(a&&void 0!==a[0])for(var g=0;g<a.length;g++)c.bind(a[g],b,e,f)}else c.bind(a,b,e,f)},a.unbind=function(a,b,e,f){if(d(a)){if(a&&void 0!==a[0])for(var g=0;g<a.length;g++)c.unbind(a[g],b,e,f)}else c.unbind(a,b,e,f)}}),a.register("javve-get-by-class/index.js",function(a,b,c){c.exports=function(){return document.getElementsByClassName?function(a,b,c){return c?a.getElementsByClassName(b)[0]:a.getElementsByClassName(b)}:document.querySelector?function(a,b,c){return c?a.querySelector(b):a.querySelectorAll(b)}:function(a,b,c){var d=[],e="*";null==a&&(a=document);for(var f=a.getElementsByTagName(e),g=f.length,h=new RegExp("(^|\\s)"+b+"(\\s|$)"),i=0,j=0;g>i;i++)if(h.test(f[i].className)){if(c)return f[i];d[j]=f[i],j++}return d}}()}),a.register("javve-to-string/index.js",function(a,b,c){c.exports=function(a){return a=void 0===a?"":a,a=null===a?"":a,a=a.toString()}}),a.register("list.fuzzysearch.js/index.js",function(a,b,c){var d=(b("classes"),b("events")),e=b("extend"),f=b("to-string"),g=b("get-by-class");c.exports=function(a){a=a||{},e(a,{location:0,distance:100,threshold:.4,multiSearch:!0,searchClass:"fuzzy-search"});var c,h=b("./src/fuzzy"),i={search:function(b,d){for(var e=a.multiSearch?b.replace(/ +$/,"").split(/ +/):[b],f=0,g=c.items.length;g>f;f++)i.item(c.items[f],d,e)},item:function(a,b,c){for(var d=!0,e=0;e<c.length;e++){for(var f=!1,g=0,h=b.length;h>g;g++)i.values(a.values(),b[g],c[e])&&(f=!0);f||(d=!1)}a.found=d},values:function(b,c,d){if(b.hasOwnProperty(c)){var e=f(b[c]).toLowerCase();if(h(e,d,a))return!0}return!1}};return{init:function(b){c=b,d.bind(g(c.listContainer,a.searchClass),"keyup",function(a){var b=a.target||a.srcElement;c.search(b.value,i.search)})},search:function(a,b){c.search(a,b,i.search)},name:a.name||"fuzzySearch"}}}),a.register("list.fuzzysearch.js/src/fuzzy.js",function(a,b,c){c.exports=function(a,b,c){function d(a,c){var d=a/b.length,e=Math.abs(h-c);return f?d+e/f:e?1:d}var e=c.location||0,f=c.distance||100,g=c.threshold||.4;if(b===a)return!0;if(b.length>32)return!1;var h=e,i=function(){var a,c={};for(a=0;a<b.length;a++)c[b.charAt(a)]=0;for(a=0;a<b.length;a++)c[b.charAt(a)]|=1<<b.length-a-1;return c}(),j=g,k=a.indexOf(b,h);-1!=k&&(j=Math.min(d(0,k),j),k=a.lastIndexOf(b,h+b.length),-1!=k&&(j=Math.min(d(0,k),j)));var l=1<<b.length-1;k=-1;for(var m,n,o,p=b.length+a.length,q=0;q<b.length;q++){for(m=0,n=p;n>m;)d(q,h+n)<=j?m=n:p=n,n=Math.floor((p-m)/2+m);p=n;var r=Math.max(1,h-n+1),s=Math.min(h+n,a.length)+b.length,t=Array(s+2);t[s+1]=(1<<q)-1;for(var u=s;u>=r;u--){var v=i[a.charAt(u-1)];if(t[u]=0===q?(t[u+1]<<1|1)&v:(t[u+1]<<1|1)&v|((o[u+1]|o[u])<<1|1)|o[u+1],t[u]&l){var w=d(q,u-1);if(j>=w){if(j=w,k=u-1,!(k>h))break;r=Math.max(1,2*h-k)}}}if(d(q+1,h)>j)break;o=t}return 0>k?!1:!0}}),a.alias("component-classes/index.js","list.fuzzysearch.js/deps/classes/index.js"),a.alias("component-classes/index.js","classes/index.js"),a.alias("component-indexof/index.js","component-classes/deps/indexof/index.js"),a.alias("segmentio-extend/index.js","list.fuzzysearch.js/deps/extend/index.js"),a.alias("segmentio-extend/index.js","extend/index.js"),a.alias("javve-events/index.js","list.fuzzysearch.js/deps/events/index.js"),a.alias("javve-events/index.js","events/index.js"),a.alias("component-event/index.js","javve-events/deps/event/index.js"),a.alias("timoxley-is-collection/index.js","javve-events/deps/is-collection/index.js"),a.alias("component-type/index.js","timoxley-is-collection/deps/type/index.js"),a.alias("javve-get-by-class/index.js","list.fuzzysearch.js/deps/get-by-class/index.js"),a.alias("javve-get-by-class/index.js","get-by-class/index.js"),a.alias("javve-to-string/index.js","list.fuzzysearch.js/deps/to-string/index.js"),a.alias("javve-to-string/index.js","list.fuzzysearch.js/deps/to-string/index.js"),a.alias("javve-to-string/index.js","to-string/index.js"),a.alias("javve-to-string/index.js","javve-to-string/index.js"),a.alias("list.fuzzysearch.js/index.js","list.fuzzysearch.js/index.js"),"object"==typeof b?c.exports=a("list.fuzzysearch.js"):"function"==typeof define&&define.amd?define(function(){return a("list.fuzzysearch.js")}):this.ListFuzzySearch=a("list.fuzzysearch.js")}()});